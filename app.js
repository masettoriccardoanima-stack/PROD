// @ts-nocheck
/* ===== BOOTSTRAP CONVENZIONI (una sola volta, in alto) ================== */
(function bootstrap(){
  const g = window;

  // LocalStorage helpers (idempotenti)
  g.lsGet = g.lsGet || function(k, d){ try{ const r = localStorage.getItem(k); return r ? JSON.parse(r) : d; } catch { return d; } };
  g.lsSet = g.lsSet || function(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); g.__anima_dirty = true; } catch {} };

  window.faseLabel = window.faseLabel || function(commessa, idx){
  try{
    const i = Number(idx|0);
    const f = commessa && Array.isArray(commessa.fasi) ? commessa.fasi[i] : null;
    return (f && f.lav) ? f.lav : `Fase ${i+1}`;
  }catch{ return `Fase ${Number(idx|0)+1}`; }
};

// ---- Helper globali fase / extra gas (per Dashboard, Report, Registrazioni) ----
if (typeof window !== 'undefined') {
  // Riconoscimento note "Cambio Bombola Gas"
  window.isGasNote = window.isGasNote || function isGasNoteGlobal(t){
    return /cambio\s*bombola\s*gas/i.test(String(t || ''));
  };

  // Nome fase coerente con Timbratura/Report per una riga di oreRows
  if (typeof window.faseLabelFromRow !== 'function') {
    window.faseLabelFromRow = function faseLabelFromRowGlobal(row){
      try{
        if (!row || typeof row !== 'object') return 'Intera commessa';

        // 1) Nome salvato al momento della timbratura (se non è "Fase N")
        const storedRaw = row.faseLabelAtReg != null
          ? String(row.faseLabelAtReg).trim()
          : '';
        const isGeneric = /^fase\s+\d+$/i.test(storedRaw);
        if (storedRaw && !isGeneric) {
          return storedRaw;
        }

        const idxRaw = row.faseIdx;

        // 2) Nessuna fase impostata → Intera commessa o Extra gas
        if (idxRaw === '' || idxRaw == null) {
          if (typeof window.isGasNote === 'function' && window.isGasNote(row.note)) {
            return 'EXTRA: Cambio Bombola Gas';
          }
          return 'Intera commessa';
        }

        const idx = Number(idxRaw);
        if (!Number.isFinite(idx) || idx < 0) {
          return `Fase ${(Number(idxRaw)||0)+1}`;
        }

        // 3) Cerco la commessa collegata
        const commId = row.commessaId != null ? String(row.commessaId) : '';
        let commessa = null;
        try{
          const allC = (typeof window.lsGet === 'function'
            ? window.lsGet('commesseRows', [])
            : JSON.parse(localStorage.getItem('commesseRows') || '[]')) || [];
          commessa = (Array.isArray(allC) ? allC : []).find(x => String(x.id) === commId) || null;
        }catch(_){}

        // 4) Fasi per-riga articolo (se ho rigaIdx)
        if (commessa) {
          try{
            const righe = Array.isArray(commessa.righeArticolo) ? commessa.righeArticolo
                         : (Array.isArray(commessa.righe) ? commessa.righe : []);
            const rIdxRaw = row.rigaIdx;
            const rIdx = (rIdxRaw === '' || rIdxRaw == null) ? null : Number(rIdxRaw);
            if (Number.isFinite(rIdx) && rIdx >= 0 && righe[rIdx] &&
                Array.isArray(righe[rIdx].fasi)) {
              const f = righe[rIdx].fasi[idx];
              if (f) {
                const lbl = (f.lav || f.label || f.nome || f.reparto || f.repartoNome || '').trim();
                if (lbl) return lbl;
              }
            }
          }catch(_){}

          // 5) Fasi globali commessa
          try{
            const gFasi = Array.isArray(commessa.fasi) ? commessa.fasi : [];
            const f = gFasi[idx];
            if (f) {
              const lbl = (f.lav || f.label || f.nome || f.reparto || f.repartoNome || '').trim();
              if (lbl) return lbl;
            }
          }catch(_){}
        }

        // 6) Fasi standard da appSettings (fasiStandard)
        try{
          const app = (typeof window.lsGet === 'function'
            ? window.lsGet('appSettings', {})
            : JSON.parse(localStorage.getItem('appSettings') || '{}')) || {};
          const fas = Array.isArray(app.fasiStandard) ? app.fasiStandard : [];
          const entry = fas[idx];
          if (entry) {
            const lbl = (typeof entry === 'string')
              ? entry
              : (entry.label || entry.nome || entry.lav || entry.reparto || entry.repartoNome || '').trim();
            if (lbl) return lbl;
          }
        }catch(_){}

        // 7) Fallback legacy → window.faseLabel
        if (typeof window.faseLabel === 'function' && commessa) {
          const v = window.faseLabel(commessa, idx);
          if (v) return v;
        }

        // 8) Ultima spiaggia
        return `Fase ${idx+1}`;
      }catch(_){
        return 'Intera commessa';
      }
    };
  }
}

// === ID progressivi generici (DDT, FATT, OF, ecc.) ===
// Usage: const idObj = await window.nextIdFor({ prefix:'DDT', storageKey:'ddtRows', seriesKey:'DDT', width:3 });
window.nextIdFor = window.nextIdFor || async function nextIdFor({
  prefix,                 // es. 'DDT', 'FATT', 'OF'
  storageKey,             // es. 'ddtRows', 'fattureRows', 'ordiniFornitoriRows'
  seriesKey = prefix,     // chiave nei counters/appSettings (di solito = prefix)
  width = 3               // OF-YYYY-NNN → 3; se vuoi 4, metti 4
} = {}) {
  const y   = new Date().getFullYear();
  const pad = n => String(n).padStart(width, '0');

  // 1) LS
  const lsGet = window.lsGet || ((k,d)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;} });
  const lsArr = lsGet(storageKey, []) || [];

  // 2) Server (best effort)
  let svArr = [];
  try { if (window.api?.kv?.get) svArr = await window.api.kv.get(storageKey) || []; } catch {}

  // 3) stato in RAM (se esiste una vista con rows nello scope globale)
  const stArr = Array.isArray(window.__rowsMap?.[storageKey]) ? window.__rowsMap[storageKey] : [];

  // 4) scansiona tutti
  const all = [...lsArr, ...svArr, ...stArr];
  let maxN = 0;
  for (const r of all) {
    const m = String(r?.id || '').match(new RegExp(`^${prefix}-(\\d{4})-(\\d{${width}})$`));
    if (m && Number(m[1])===y) {
      const n = Number(m[2]); if (n>maxN) maxN=n;
    }
  }

  // 5) Impostazioni → “ULTIMO numero emesso”
  try {
    const cfg   = lsGet('appSettings', {}) || {};
    const byYr  = cfg?.numerazioni?.[seriesKey]?.[String(y)]?.ultimo;
    const flat  = cfg?.numerazioni?.[seriesKey]?.ultimo ?? cfg?.numeratori?.[seriesKey]?.ultimo;
    const legacy= cfg?.[`${seriesKey}_last`] ?? cfg?.[`ultimo${seriesKey}`];
    const ultimo= Number(byYr ?? flat ?? legacy ?? 0) || 0;
    if (ultimo > maxN) maxN = ultimo;
  } catch {}

  // 6) Counters (sincronizza e incrementa)
  try {
    const counters = JSON.parse(localStorage.getItem('counters') || '{}') || {};
    const cur = counters[seriesKey] || { year: y, num: maxN };
    if (cur.year !== y) { cur.year = y; cur.num = maxN; }
    if (cur.num < maxN) cur.num = maxN;
    cur.num += 1;
    counters[seriesKey] = cur;
    localStorage.setItem('counters', JSON.stringify(counters));
    return { id: `${prefix}-${y}-${pad(cur.num)}`, year: y, num: cur.num };
  } catch {
    const n = maxN + 1;
    return { id: `${prefix}-${y}-${pad(n)}`, year: y, num: n };
  }
};

// ============== PDF UTILS (lazy, no build) ==============
window.loadPdfLib = window.loadPdfLib || async function(){
  if (window.__pdfjs) return window.__pdfjs;
  const ver = '4.10.38';
  const lib = await import(`https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.min.mjs`);
  lib.GlobalWorkerOptions.workerSrc =
    `https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.mjs`;
  window.__pdfjs = lib;
  return lib;
};

window.extractPdfText = window.extractPdfText || async function(file){
  const pdfjs = await window.loadPdfLib();
  const data = await file.arrayBuffer();
  const doc = await pdfjs.getDocument({ data }).promise;
  let out = '';
  for (let p = 1; p <= doc.numPages; p++){
    const page = await doc.getPage(p);
    const tc = await page.getTextContent();
    out += tc.items.map(i => i.str).join('\n') + '\n';
  }
  return out;
};

// parse dd/mm/yy, dd-mm-yy, dd.mm.yy → ISO yyyy-mm-dd (assume 20xx se yy<70)
window.parseITDate = window.parseITDate || function(s){
  const m = String(s||'').match(/(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{2,4})/);
  if (!m) return '';
  let [_, d, M, y] = m; d=+d; M=+M; y=+y; if (y<100) y+=2000;
  const iso = `${y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  return isNaN(Date.parse(iso)) ? '' : iso;
};

window.parseITNumber = window.parseITNumber || function(s){
  if (s==null) return 0;
  const t = String(s).trim().replace(/\./g, '').replace(',', '.');
  const n = parseFloat(t);
  return isFinite(n) ? n : 0;
};

// ============== ORDER PARSER (testo PDF → oggetto commessa) ==============
window.parseOrderText = window.parseOrderText || function(rawText, filename=''){
  const text = String(rawText || '').replace(/[ \t]+\n/g, '\n').replace(/\s+/g,' ').trim();

   // 1) Cliente (preferisci “SPETT.LE …” o blocchi con P.IVA)
let cliente = '';
const rxCliente1 = /(SPETT\.LE|Spett\.le|Destinatario|Cliente|Ragione\s+Sociale)\s*[: ]*([A-Z0-9&\/\.\-' ]{3,}?(?:\bS\.?R\.?L\.?\b|\bS\.?P\.?A\.?\b|\bSAS\b|\bSNC\b))/i;
const mC1 = text.match(rxCliente1);
if (mC1) cliente = mC1[2].replace(/\s{2,}/g,' ').trim();

// Fallback minimal: niente ANIMA qui
if (!cliente) {
  const rxCliente2 = /(VIMEK BAKERY AUTOMATION SRL|BREMBO|CATERPILLAR)/i;
  const mC2 = text.match(rxCliente2);
  if (mC2) cliente = mC2[1].toUpperCase();
}

// Se per errore è uscita ANIMA, riprova su “Cliente/Destinatario”
if (/^ANIMA\b/i.test(cliente)) {
  const mAlt = text.match(/(?:Cliente|Destinatario|Ragione\s+Sociale)\s*[: ]*([A-Z0-9&\/\.\-' ]{3,})/i);
  if (mAlt) cliente = mAlt[1].replace(/\s{2,}/g,' ').trim();
}

  // 2) Numero e data ordine (fallback: dal filename “...DEL_14.10.25”)
  let dataOrdine = '';
  const rxDataOrd = /(DATA\s+(?:DOCUMENTO|ORDINE)\s*[: ]*|DEL\s+)(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/i;
  const mDO = text.match(rxDataOrd);
  if (mDO) dataOrdine = window.parseITDate(mDO[2]);
  if (!dataOrdine){
    const mFN = String(filename).match(/DEL[_\-\s]?(\d{1,2}[.\-]\d{1,2}[.\-]\d{2,4})/i);
    if (mFN) dataOrdine = window.parseITDate(mFN[1]);
  }

  // 3) Data prevista consegna (globale o per riga; prendi la più “tarda” nel testo)
  let dataCons = '';
  const allDates = [];
  text.replace(/(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/g, (_,d)=>{ allDates.push(window.parseITDate(d)); });
  // euristica: scegli la massima futura/ragionevole come consegna
  const valids = allDates.filter(Boolean).map(d => new Date(d).getTime());
  if (valids.length){
    const max = Math.max.apply(null, valids);
    dataCons = new Date(max).toISOString().slice(0,10);
  }

  // 4) Quantità totale pezzi (somma “PZ NNN” o “qt NNN”)
  let qtaTot = 0;
  const rxPZ = /(PZ|pz|Qt\.?|qt)\s*([0-9\.\,]+)/g;
  let m; while ((m = rxPZ.exec(text))) qtaTot += window.parseITNumber(m[2]);
  if (!qtaTot) qtaTot = 1;

  // 5) Descrizione sintetica (prendi “Fornitura …” oppure prima riga articolo)
  let descr = '';
  const mForn = text.match(/Fornitura\s+([A-Za-z0-9_\-\/\.\,\s]{6,})/i);
  if (mForn) descr = ('Fornitura ' + mForn[1]).trim();
  if (!descr){
    const mArt = text.match(/^[A-Z0-9][A-Z0-9\-\_\.]{2,}\s+(.{8,80}?)\s+(?:PZ|qt)\b/i);
    if (mArt) descr = mArt[1].trim();
  }
  if (!descr) descr = 'Commessa da ordine PDF';

  // 6) Genera ID commessa (C-YYYY-NNN) senza chiedere all’utente
  function nextCommessaId(){
    try{
      if (window.nextIdUnique) return window.nextIdUnique('commesse','C','commesseRows').id;
      const year = new Date().getFullYear();
      const counters = (window.lsGet && window.lsGet('counters', {})) || {};
      const key = `C:${year}`;
      const num = (Number(counters[key]||0) + 1);
      counters[key] = num;
      if (window.lsSet) window.lsSet('counters', counters); else localStorage.setItem('counters', JSON.stringify(counters));
      return `C-${year}-${String(num).padStart(3,'0')}`;
    }catch{ return `C-${new Date().getFullYear()}-${String(Math.floor(Math.random()*999)).padStart(3,'0')}`; }
  }

window.getNextCommessaId = window.getNextCommessaId || window.nextCommessaId;

  const commessa = {
    id: nextCommessaId(),
    cliente: cliente || '',
    descrizione: descr,
    qtaPezzi: Math.max(1, Math.round(qtaTot)),
    qtaProdotta: 0,
    scadenza: dataCons || '',
    dataOrdine: dataOrdine || '',
    priorita: '',
    fasi: Array.isArray(window.defaultFasi) ? window.defaultFasi.slice() : [
      { lav: 'Taglio', qtaPrevista: 0, qtaProdotta: 0 },
      { lav: 'Saldatura', qtaPrevista: 0, qtaProdotta: 0 },
      { lav: 'Verniciatura', qtaPrevista: 0, qtaProdotta: 0 }
    ],
    materiali: []
  };

  return commessa;
};

// === HELPERS PER REPORT/TIMBRATURE (retro-compat, idempotenti) ===
window.safeArr = window.safeArr || (x => Array.isArray(x) ? x : (x ? [x] : []));
window.numVal  = window.numVal  || (x => { const n = Number(x); return Number.isFinite(n) ? n : 0; });
window.toMinCompat = window.toMinCompat || (v => {
  if (v == null) return 0;
  const t = String(v).trim();
  const m = t.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
  if (m) { const h = +m[1]||0, mm = +m[2]||0; return h*60+mm; }
  const n = Number(t);
  return Number.isFinite(n) ? Math.max(0, Math.round(n)) : 0;
});
window.matchFase = window.matchFase || function(o, idx, label){
  if (!o) return false;
  const sameIdx   = Number(o.faseIdx) === Number(idx);
  const sameLabel = o.fase && String(o.fase).toLowerCase() === String(label||'').toLowerCase();
  return sameIdx || sameLabel;
};

// Diagnostica: qtaPezzi testata vs somma righeArticolo / righe
window.scanCommessaQtaMismatch = window.scanCommessaQtaMismatch || function(){
  try {
    const lsGetLocal = window.lsGet || ((k,d)=>{
      try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; }
      catch { return d; }
    });

    const rows = lsGetLocal('commesseRows', []) || [];
    const arr  = Array.isArray(rows) ? rows : [];
    const out  = [];

    arr.forEach(c => {
      if (!c) return;

      // qta di testata
      const qHeaderRaw = Number(c.qtaPezzi);
      const qHeader = Number.isFinite(qHeaderRaw) ? qHeaderRaw : 0;

      // Preferisco righeArticolo moderne; se mancano, fallback righe legacy
      const righeArt   = Array.isArray(c.righeArticolo) ? c.righeArticolo : null;
      const righeLegacy = (!righeArt || !righeArt.length) && Array.isArray(c.righe)
        ? c.righe
        : null;

      const righeBase = (righeArt && righeArt.length) ? righeArt : (righeLegacy || []);
      if (!righeBase || !righeBase.length) return; // nessuna riga → niente confronto

      // tengo solo righe "vive" / significative
      const righeVive = righeBase.filter(r => {
        if (!r) return false;
        if (r.deletedAt) return false;
        const codice = String(r.codice || r.articoloCodice || '').trim();
        const descr  = String(r.descrizione || r.articoloDescr || '').trim();
        const q      = Number(r.qta || r.quantita || r.qtaPezzi || 0) || 0;
        return (codice || descr || q);
      });

      if (!righeVive.length) return;

      const qSum = righeVive.reduce((s,r) =>
        s + (Number(r.qta || r.quantita || r.qtaPezzi || 0) || 0),
        0
      );

      // se entrambi 0 → non mi interessa
      if (!qSum && !qHeader) return;

      // Coerenza perfetta → ok
      if (qHeader === qSum) return;

      out.push({
        id         : String(c.id || ''),
        cliente    : String(c.cliente || ''),
        descrizione: String(c.descrizione || ''),
        qtaPezzi   : qHeader,
        qtaRighe   : qSum,
        delta      : qSum - qHeader,
        nRighe     : righeVive.length
      });
    });

    out.sort((a,b) => {
      const d = Math.abs(b.delta) - Math.abs(a.delta);
      if (d !== 0) return d;
      return String(a.id || '').localeCompare(String(b.id || ''));
    });

    return out;
  } catch (e) {
    console.error('scanCommessaQtaMismatch error', e);
    return [];
  }
};

// Helper comodo: stampa una tabella in console
window.logCommessaQtaMismatch = window.logCommessaQtaMismatch || function(limit){
  const rows = (typeof window.scanCommessaQtaMismatch === 'function')
    ? window.scanCommessaQtaMismatch()
    : [];

  if (!rows || !rows.length) {
    console.info('Nessuna commessa con qtaPezzi diversa dalla somma righe.');
    return rows;
  }

  const max = (typeof limit === 'number' && limit > 0) ? limit : rows.length;
  const subset = rows.slice(0, max);

  console.table(subset.map(r => ({
    id       : r.id,
    cliente  : r.cliente,
    descr    : r.descrizione,
    qtaPezzi : r.qtaPezzi,
    qtaRighe : r.qtaRighe,
    delta    : r.delta,
    nRighe   : r.nRighe
  })));

  if (rows.length > max) {
    console.info(`… altre ${rows.length - max} commesse con mismatch (usa logCommessaQtaMismatch(${rows.length}) o scanCommessaQtaMismatch()).`);
  }

  return rows;
};

// Smoke test globale (solo lettura, niente scritture LS)
window.runAnimaSmokeTest = window.runAnimaSmokeTest || function(limit){
  const lsGetLocal = window.lsGet || ((k,d)=>{
    try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; }
    catch { return d; }
  });
  const maxRows = (typeof limit === 'number' && limit > 0) ? limit : 10;

  const report = {
    startedAt: new Date().toISOString(),
    magazzino: {},
    commesse : {},
    ore      : {}
  };

  // --- MAGAZZINO / MOVIMENTI ---
  try {
    const movs = lsGetLocal('magMovimenti', []) || [];
    const total = movs.length;
    const withId       = movs.filter(m => m && m.id);
    const withoutId    = movs.filter(m => !m || !m.id);
    const withUpd      = withId.filter(m => m && m.updatedAt);
    const withoutUpd   = withId.filter(m => m && !m.updatedAt);
    const alive        = movs.filter(m => m && !m.deletedAt);
    const deleted      = movs.filter(m => m && m.deletedAt);

    report.magazzino = {
      totalMovimenti          : total,
      senzaId                 : withoutId.length,
      conIdSenzaUpdatedAt     : withoutUpd.length,
      vivi                    : alive.length,
      softDeleted             : deleted.length
    };

    console.group('SmokeTest – Magazzino / movimenti');
    console.log('Totali movimenti:', total);
    console.log('Vivi:', alive.length, 'Soft-deleted:', deleted.length);

    if (withoutId.length){
      console.warn(`${withoutId.length} movimenti senza id (dati legacy, non sincronizzabili):`);
      console.table(withoutId.slice(0, maxRows).map(m => ({
        codice : m && m.codice,
        qta    : m && m.qta,
        data   : m && m.data
      })));
    }
    if (withoutUpd.length){
      console.warn(`${withoutUpd.length} movimenti con id ma senza updatedAt (da controllare):`);
      console.table(withoutUpd.slice(0, maxRows).map(m => ({
        id      : m.id,
        codice  : m.codice,
        qta     : m.qta,
        data    : m.data
      })));
    }
    console.groupEnd();
  } catch (e){
    console.error('SmokeTest – errore sezione MAGAZZINO:', e);
  }

  // --- COMMESSE / PEZZI PROD / RESIDUO ---
  try {
    const commesse = lsGetLocal('commesseRows', []) || [];
    const oreRows  = lsGetLocal('oreRows', []) || [];
    const ppFn = window.producedPiecesCore || window.producedPieces;
    const rpFn = window.residualPiecesCore || window.residualPieces;

    report.commesse.totali = commesse.length;

    console.group('SmokeTest – Commesse / pezzi prodotti & residuo');
    console.log('Totali commesse:', commesse.length);

    if (!ppFn || !rpFn){
      console.warn('producedPiecesCore / residualPiecesCore non disponibili, salto controllo pezzi.');
    } else {
      const rows = [];
      const anomalie = [];

      commesse.forEach(c => {
        if (!c) return;
        const tot = Number(c.qtaPezzi || 0) || 0;
        let prod = null, res = null;
        try {
          prod = ppFn(c, oreRows);
          res  = rpFn(c, oreRows);
        } catch (e) {
          console.warn('Errore calcolo pezzi per commessa', c.id, e);
        }
        const row = {
          id       : String(c.id || ''),
          cliente  : String(c.cliente || ''),
          qtaPezzi : tot,
          prodotti : prod,
          residuo  : res
        };
        rows.push(row);

        if (typeof prod === 'number' && typeof tot === 'number' && tot > 0 && prod > tot){
          anomalie.push({ ...row, tipo:'prod>tot' });
        }
        if (typeof res === 'number' && res < 0){
          anomalie.push({ ...row, tipo:'res<0' });
        }
        if (typeof prod === 'number' && prod < 0){
          anomalie.push({ ...row, tipo:'prod<0' });
        }
      });

      report.commesse.anomalie = (anomalie || []).length;

      console.log('Prime commesse (max', maxRows, 'righe):');
      console.table(rows.slice(0, maxRows));

      if (anomalie.length){
        console.warn(`Trovate ${anomalie.length} possibili anomalie (prod>tot, res<0 o prod<0):`);
        console.table(anomalie.slice(0, maxRows));
      } else {
        console.info('Nessuna anomalia evidente su prodotti/residuo (prod>tot o residuo<0).');
      }
    }
    console.groupEnd();
  } catch (e){
    console.error('SmokeTest – errore sezione COMMESSE:', e);
  }

  // --- ORE ORFANE ---
  try {
    const oreRows   = lsGetLocal('oreRows', []) || [];
    const commesse  = lsGetLocal('commesseRows', []) || [];
    const ids = new Set(commesse.map(c => c && c.id).filter(Boolean));

    const orfane = oreRows.filter(o =>
      o && o.commessaId && !o.deletedAt && !ids.has(o.commessaId)
    );

    report.ore.totali = oreRows.length;
    report.ore.orfane = orfane.length;

    console.group('SmokeTest – Ore orfane');
    console.log('Totali ore:', oreRows.length);
    console.log('Ore orfane (commessaId senza commessa):', orfane.length);

    if (orfane.length){
      console.table(orfane.slice(0, maxRows).map(o => ({
        id         : o.id,
        commessaId : o.commessaId,
        data       : o.data,
        faseIdx    : o.faseIdx,
        qtaPezzi   : o.qtaPezzi
      })));
    }
    console.groupEnd();
  } catch (e){
    console.error('SmokeTest – errore sezione ORE:', e);
  }

  console.log('SmokeTest ANIMA completato:', report);
  return report;
};

// Soft-delete massivo delle ore orfane (commessaId senza commessa)
// Uso:
//   softDeleteOreOrfane()                    → ANTEPRIMA (dry-run, non scrive nulla)
//   softDeleteOreOrfane({ dryRun: false })   → APPLICA davvero deletedAt/updatedAt
window.softDeleteOreOrfane = window.softDeleteOreOrfane || function(options){
  const opts   = options || {};
  const dryRun = (opts.dryRun !== false);  // default: true

  const lsGetLocal = window.lsGet || ((k,d)=>{
    try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; }
    catch { return d; }
  });
  const lsSetLocal = window.lsSet || ((k,v)=>{
    try { localStorage.setItem(k, JSON.stringify(v)); }
    catch(e){ console.error('softDeleteOreOrfane: errore setItem', e); }
  });

  const oreRows  = lsGetLocal('oreRows', []) || [];
  const commesse = lsGetLocal('commesseRows', []) || [];
  const ids = new Set(commesse.map(c => c && c.id).filter(Boolean));

  const nowISO = new Date().toISOString();
  const orfane = [];
  const next = oreRows.map(o => {
    if (!o || !o.commessaId) return o;
    if (o.deletedAt) return o;
    if (!ids.has(o.commessaId)) {
      orfane.push(o);
      if (!dryRun) {
        return {
          ...o,
          deletedAt: o.deletedAt || nowISO,
          updatedAt: nowISO
        };
      }
    }
    return o;
  });

  console.group(dryRun ? 'softDeleteOreOrfane (ANTEPRIMA)' : 'softDeleteOreOrfane (APPLICATO)');
  console.log('Ore totali:', oreRows.length);
  console.log('Ore orfane individuate:', orfane.length);
  if (orfane.length){
    console.table(orfane.map(o => ({
      id        : o.id,
      commessaId: o.commessaId,
      data      : o.data,
      faseIdx   : o.faseIdx,
      qtaPezzi  : o.qtaPezzi
    })));
  } else {
    console.info('Nessuna ora orfana trovata (commessaId senza commessa).');
  }
  console.groupEnd();

  if (!dryRun && orfane.length){
    lsSetLocal('oreRows', next);
  }

  return {
    dryRun,
    totalOre  : oreRows.length,
    oreOrfane : orfane.length
  };
};

// ================== DIAGNOSTICA DATI (solo lettura) ==================
function DiagnosticaView(){
  const e = React.createElement;

  const [report, setReport]   = React.useState(null);
  const [running, setRunning] = React.useState(false);
  const [error, setError]     = React.useState(null);

  const run = React.useCallback((limit)=>{
    try{
      setRunning(true);
      setError(null);

      const fn = window.runAnimaSmokeTest;
      if (typeof fn === 'function') {
        const r = fn(limit || 20);
        setReport(r || null);
      } else {
        setError('Funzione runAnimaSmokeTest non disponibile.');
      }
    } catch (e){
      console.error('DiagnosticaView – errore', e);
      setError('Errore in diagnostica (vedi console).');
    } finally {
      setRunning(false);
    }
  },[]);

  React.useEffect(()=>{ run(20); }, [run]);

  const mag = (report && report.magazzino) || {};
  const com = (report && report.commesse)  || {};
  const ore = (report && report.ore)       || {};
  const last = report && report.startedAt;

  return e('div',{className:'page'},
    // Header + pulsante riesegui
    e('div', {
      className:'actions',
      style:{justifyContent:'space-between', alignItems:'center', marginBottom:12}
    },
      e('div', null,
        e('h2', null, 'Diagnostica dati'),
        e('div',{className:'muted small'},
          'Controlli di coerenza su movimenti, commesse e ore (solo lettura).'
        ),
        last && e('div',{className:'muted small'},
          'Ultimo controllo: ',
          String(last).replace('T',' ').slice(0,16)
        )
      ),
      e('div', null,
        e('button', {
          className:'btn btn-outline',
          onClick: ()=> run(20),
          disabled: running
        }, running ? 'Analisi in corso…' : 'Riesegui diagnostica')
      )
    ),

    error && e('div',{
      className:'card',
      style:{borderColor:'#dc2626', color:'#b91c1c', marginBottom:12}
    }, String(error)),

    report && e('div',{className:'grid', style:{gap:16}},
      // Card magazzino / movimenti
      e('div',{className:'card'},
        e('h3', null, 'Magazzino / movimenti'),
        e('div',{className:'muted small'},
          'Foto sintetica dei movimenti in locale.'
        ),
        e('ul',{className:'small'},
          e('li',null, `Totali movimenti: ${mag.totalMovimenti ?? 0}`),
          e('li',null, `Vivi: ${mag.vivi ?? 0}`),
          e('li',null, `Soft-deleted: ${mag.softDeleted ?? 0}`),
          e('li',null, `Senza id (legacy): ${mag.senzaId ?? 0}`),
          e('li',null, `Con id senza updatedAt: ${mag.conIdSenzaUpdatedAt ?? 0}`)
        )
      ),

      // Card commesse
      e('div',{className:'card'},
        e('h3', null, 'Commesse'),
        e('div',{className:'muted small'},
          'Controllo pezzi prodotti / residuo sulle commesse.'
        ),
        e('ul',{className:'small'},
          e('li',null, `Totali commesse: ${com.totali ?? 0}`),
          e('li',null,
            `Anomalie pezzi (prod>tot, residuo<0 o prod<0): ${com.anomalie ?? 0}`
          )
        )
      ),

      // Card ore
      e('div',{className:'card'},
        e('h3', null, 'Ore'),
        e('div',{className:'muted small'},
          'Ore orfane = commessaId senza commessa (da ripulire con softDeleteOreOrfane).'
        ),
        e('ul',{className:'small'},
          e('li',null, `Totali ore: ${ore.totali ?? 0}`),
          e('li',null, `Ore orfane vive: ${ore.orfane ?? 0}`)
        )
      )
    ),

    !report && !running && !error &&
      e('div',{className:'muted'}, 'Nessun dato di diagnostica disponibile.')
  );
}
window.DiagnosticaView = DiagnosticaView;

// Stampa etichette centrale (manuale, senza vincolo di commessa completa)
window.triggerEtichetteFor = window.triggerEtichetteFor || function(commessa, opts = {}){
  try{
    if (!commessa) {
      alert('Nessuna commessa selezionata');
      return;
    }

    const defaultColli = Math.max(
      1,
      Number(opts.colli || commessa.colli || 1)
    );
    const colli = Number(
      prompt('Numero colli da etichettare?', String(defaultColli))
    ) || defaultColli;

    // Preferisco la stampa etichette “diretta”
    if (typeof window.printEtichetteColli === 'function') {
      window.printEtichetteColli(commessa, colli);
      return;
    }

    // Fallback: se per qualche motivo non esiste la funzione globale,
    // provo comunque la pipeline auto-scarico+etichette (comportamento attuale)
    if (typeof window._maybeAutoScaricoAndLabels === 'function') {
      window._maybeAutoScaricoAndLabels(commessa.id, { colli });
      return;
    }

    alert('Funzione etichette non configurata');

  } catch(e){
    console.warn('triggerEtichetteFor:', e);
    alert('Errore in stampa etichette');
  }
};

// ---- AppSettings defaults (AUTO su ogni device) ----
// Metti questo SUBITO dopo lsGet/lsSet, dentro l'IIFE principale.
(function ensureAppDefaults(){
  try {
    const cur = JSON.parse(localStorage.getItem('appSettings') || '{}') || {};
    // <-- INSERISCI QUI i tuoi valori DEFINITIVI
    const defaults = {
      cloudEnabled : true,
      supabaseTable: 'anima_sync',
      supabaseUrl  : 'https://zvqkmdxdhnmdbpyallgy.supabase.co',
      supabaseKey  : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2cWttZHhkaG5tZGJweWFsbGd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMjIxMjUsImV4cCI6MjA3OTU5ODEyNX0.odbF1Dne6GNg7GKXsKnYW2LwzDSiQp1yfVQPpSpuJGo',
      // mappa ruoli (vedi punto ruoli sotto)
      users: [
        { email: 'masettoriccardoanima@gmail.com', role: 'admin' },
        { email: 'masettoriccardo2@gmail.com',    role: 'admin' }
        // es: { email: 'operaio1@anima.local', role: 'worker' }
      ]
    };
    (function migrateUsersAdmin(){
  try{
    const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    const list = Array.isArray(s.users) ? s.users.slice() : [];
    const need = 'masettoriccardo2@gmail.com';
    if (!list.some(u => String(u.email||u.username||'').toLowerCase() === need)) {
      list.push({ email: need, role: 'admin' });
      s.users = list;
      localStorage.setItem('appSettings', JSON.stringify(s));
      console.log('appSettings.users aggiornato con admin:', need);
    }
  }catch{}
})();

    // unisci senza sovrascrivere ciò che già c’è lato utente
    const next = { ...defaults, ...cur };
    localStorage.setItem('appSettings', JSON.stringify(next));
  } catch {}
})();

// Bootstrap appSettings da settings.json (solo se vuoto)
(async function primeAppSettings(){
  try {
    if (!localStorage.getItem('appSettings')) {
      const res = await fetch('./settings.json', { cache: 'no-store' });
      if (res.ok) {
        const cfg = await res.json();
        const base = { supabaseTable:'anima_sync', cloudEnabled:true };
        localStorage.setItem('appSettings', JSON.stringify(Object.assign(base, cfg||{})));
        console.log('[boot] appSettings da settings.json');
      }
    }
  } catch(e){ console.warn('[boot] primeAppSettings', e); }
})();

// --- Supabase client lazy (env-aware: prod/beta) ---
window.getSupabase = window.getSupabase || function(){
  try{
    const s0 = JSON.parse(localStorage.getItem('appSettings') || '{}') || {};
    const env = String(s0.cloudEnv || s0.supabaseEnv || '').toLowerCase();

    const url = String(
      (env === 'beta')
        ? (s0.supabaseUrlBeta || s0.supabaseUrl || '')
        : (s0.supabaseUrl || '')
    ).trim();

    const anon = String(
      (env === 'beta')
        ? (s0.supabaseKeyBeta || s0.supabaseKey || '')
        : (s0.supabaseKey || '')
    ).trim();

    if (!url || !anon || !window.supabase || !supabase.createClient) return null;

    const sig = url + '|' + anon;
    if (window.__sbClient && window.__sbClient.__sig === sig) return window.__sbClient;

    const client = supabase.createClient(url, anon);
    client.__sig = sig;
    window.__sbClient = client;
    return client;
  }catch{ return null; }
};

// === Supabase Password Recovery bootstrap (idempotente) ===
(function supabaseRecoveryBootstrap(){
  try {
    const sb = window.getSupabase && window.getSupabase();
    if (!sb) return;

    // 1) Gestione dei link moderni (PKCE): la dashboard invia ?code=... su Site URL
    //    Scambio il "code" per una sessione valida (necessario perché l'evento altrimenti non parte).
    const href = String(location.href || '');
    const hasCode = href.includes('?code=') || href.includes('&code=');
    if (hasCode) {
      sb.auth.exchangeCodeForSession(href).catch(err => {

        console.warn('exchangeCodeForSession:', err?.message || err);
      });
          // Supporto link stile hash (#access_token=...&type=recovery)
    const hash = String(location.hash || '');
    if (hash.includes('access_token') && hash.includes('type=recovery')) {
      sb.auth.getSessionFromUrl({ storeSession: true }).catch(err => {
        console.warn('getSessionFromUrl:', err?.message || err);
      });
    }

    }

    // 2) Ascolta i cambi di stato: PASSWORD_RECOVERY → chiedi nuova password, poi aggiorna
    sb.auth.onAuthStateChange(async (event /*, session */) => {
      try {
        if (event === 'PASSWORD_RECOVERY' || (new URL(location.href)).searchParams.get('type') === 'recovery') {
          // Prompt minimale (poi lo trasformiamo in overlay carino): 
          const newPwd = prompt('Imposta una NUOVA password (almeno 8 caratteri):');
          if (!newPwd || newPwd.length < 8) {
            alert('Password troppo corta o annullata.');
            // Ritorno al login per evitare stati sospesi
            location.hash = '#/login';
            return;
          }
          const { error } = await sb.auth.updateUser({ password: newPwd });
          if (error) {
            alert('Errore aggiornamento: ' + (error.message || error));
          } else {
            alert('Password aggiornata! Ora accedi con la nuova password.');
          }
          // Torna alla schermata di login
          location.hash = '#/login';
        }
      } catch (e) {
        console.warn('Recovery handler error:', e?.message || e);
      }
    });
  } catch (e) {
    console.warn('supabaseRecoveryBootstrap error:', e?.message || e);
  }
})();

// --- Helper tempo (idempotenti, per Report/Registrazioni) ---
window.toMin = window.toMin || function (hhmm) {
  if (typeof hhmm !== 'string') return 0;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hhmm.trim());
  if (!m) return 0;
  const h = parseInt(m[1], 10) || 0;
  const mm = parseInt(m[2], 10) || 0;
  return h * 60 + mm;
};
window.fmtHHMM = window.fmtHHMM || function (mins) {
  const t = Math.max(0, Math.round(Number(mins) || 0));
  const h = Math.floor(t / 60), m = t % 60;
  return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
};
// Alias compatibile se qualche vista usa il vecchio nome
window.fmtHHMMfromMin = window.fmtHHMMfromMin || window.fmtHHMM;

// ==== ORDER helper unico (incolla dopo i bootstrap) ====
window.sortNewestFirst = window.sortNewestFirst || function listSort(arr, opts){
  const dateKeys = (opts && opts.dateKeys) || ['updatedAt','createdAt','data','dataDocumento'];
  const getNumFromId = (id) => {
    const m = String(id||'').match(/-(\d{4})-(\d{3})$/); // -YYYY-NNN
    return m ? (+m[1])*1000 + (+m[2]) : -1;
  };
  const getDate = (obj) => {
    for (const k of dateKeys) {
      const v = obj && obj[k];
      const t = (typeof v === 'number') ? v : Date.parse(v||'');
      if (Number.isFinite(t)) return t;
    }
    return 0;
  };
  return (Array.isArray(arr)?arr:[]).slice().sort((a,b)=>{
    const td = getDate(b) - getDate(a);
    if (td) return td;
    const na = getNumFromId(a.id), nb = getNumFromId(b.id);
    if (nb !== na) return nb - na;           // DESC
    return String(b.id||'').localeCompare(String(a.id||''));
  });
};

// === AUTH CORE (beta) — login/logout, sessione e sola-lettura ===
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  const e = React.createElement;

  // Helper JSON con cookie
  window.fetchJSON = async function(url, opt={}){
    const res = await fetch(url, {
      credentials:'include',
      headers:{ 'Content-Type':'application/json', ...(opt.headers||{}) },
      ...opt
    });
    const ct = res.headers.get('content-type')||'';
    const body = ct.includes('application/json') ? await res.json() : await res.text();
    if (!res.ok){ const err = new Error('HTTP '+res.status); err.status=res.status; err.body=body; throw err; }
    return body;
  };

    // Stato utente in memoria (fonte unica: __USER)
  window.__USER = window.__USER || null;

  // ================== RBAC (fonte unica) ==================
  // Read-only: accountant, viewer, mobile (coerente con "consultazione-only").
  // Worker e admin possono scrivere.
  window.isReadOnlyUser = function(){
    const u = window.__USER || window.currentUser || null;
    const role = (u && u.role) ? String(u.role).toLowerCase() : '';
    return (role === 'accountant' || role === 'viewer' || role === 'mobile');
  };

  // Wrapper: usa SEMPRE apiMe se esiste
  window.getMe = async function(){
    const fn = window.apiMe || global.apiMe || null;
    const me = fn ? await fn() : null;
    window.__USER = me;
    return me;
  };

  // Richiede login usando la logica centrale (global.requireLogin → authRequired + offline)
  window.requireLogin = async function(){
    if (global.requireLogin) {
      // Qui dentro c’è già tutta la logica “Supabase + authRequired + offline-friendly”
      return await global.requireLogin();
    }
    const u = await window.getMe();
    if (!u){
      location.hash = '#/login';
      throw new Error('not logged');
    }
    return u;
  };

  // Login: delega a Supabase se disponibile,
  // altrimenti (solo se non c'è nulla) crea un admin locale "di fortuna"
  window.login = async function(username, password){
    const fn = window.apiLogin || global.apiLogin || null;
    if (fn){
      const me = await fn(username, password);
      window.__USER = me;
      return me;
    }

    // Fallback puramente locale/offline: utente admin locale
    const u = {
      id      : 'local-admin',
      username: String(username || '').trim() || 'offline',
      role    : 'admin'
    };
    window.__USER = u;
    try { window.dispatchEvent(new CustomEvent('auth-change', { detail: u })); } catch {}
    return u;
  };

  window.logout = async function(){
    // Se esiste una apiLogout "core", usiamo quella (Supabase + eventuale backend)
    if (window.apiLogout) {
      await window.apiLogout();
      return;
    }

    // Fallback minimale: reset locale
    window.__USER = null;
    location.hash = '#/login';
  };

  // Ricorda se l'utente è arrivato con hash di Timbratura (es. QR)
  (function rememberIntentTimbratura(){
  try {
    const h = (location.hash || '').toLowerCase();
    if (h.startsWith('#/timbratura')) {
      sessionStorage.setItem('__intent_timbratura', '1');
    } else {
      // non toccare se già impostata da QR nella stessa sessione
    }
  } catch {}
})();

  // Sola lettura: l’accountant non può scrivere; se non loggato → NON blocchiamo (così puoi lavorare offline)
  // --- RBAC: unica fonte di verità ---
  //window.isReadOnlyUser = function(){
    //  const r = window.__USER && window.__USER.role;
  //  return r === 'accountant' || r === 'viewer' || r === 'mobile';
  // };
 
  // Props da spalmare sui pulsanti che scrivono
  window.roProps = function(){
    return window.isReadOnlyUser() ? { disabled:true, title:'Sola lettura (accountant)' } : {};
  };
})();

// === LoginView (allineata al tuo AUTH CORE) ===
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  const e = React.createElement;

  function LoginView(){
    if (window.__USER) {
    const last = localStorage.getItem('lastRoute') || '#/dashboard';
    if (String(location.hash).toLowerCase().startsWith('#/login')) {
      location.hash = (typeof last === 'string' && last.startsWith('#/')) ? last : '#/dashboard';
    }
  return null;
  }
    const [u,setU] = React.useState('');
    const [p,setP] = React.useState('');
    const [err,setErr] = React.useState('');
    const [busy,setBusy] = React.useState(false);
    const logged = !!window.__USER;

        const [denyEmail,setDenyEmail] = React.useState('');

    // Se l'allowlist nega, apiMe() mette sessionStorage.__auth_denied
    React.useEffect(() => {
      try{
        const d = sessionStorage.getItem('__auth_denied');
        if (d) {
          setDenyEmail(d);
          setErr('Accesso negato: utente NON in allowlist (' + d + ')');
          sessionStorage.removeItem('__auth_denied');
        }
      }catch{}
    }, []);

    async function onImportAppSettings(ev){
      try{
        const f = ev && ev.target && ev.target.files && ev.target.files[0];
        try{ ev.target.value = ''; }catch{}
        if (!f) return;

        if (!window.readJSONFile) {
          alert('Import non disponibile (readJSONFile mancante).');
          return;
        }
        const obj = await window.readJSONFile(f);

        // accetta: {appSettings:{...}} oppure direttamente {...}
        const incoming = (obj && obj.appSettings && typeof obj.appSettings==='object')
          ? obj.appSettings
          : (obj && typeof obj==='object' ? obj : null);

        if (!incoming) {
          alert('File non valido: appSettings non trovato.');
          return;
        }

        let cur = {};
        try{ cur = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{}
        const next = { ...cur, ...incoming };

        // users: se nel file c'è, lo prendiamo (serve proprio per allowlist)
        if (Array.isArray(incoming.users)) next.users = incoming.users;

        localStorage.setItem('appSettings', JSON.stringify(next));
        alert('Configurazione importata. Ricarico la pagina.');
        location.reload();
      }catch(e){
        console.error(e);
        alert('Errore import configurazione: ' + (e && e.message ? e.message : String(e)));
      }
    }

    async function onSubmit(ev){
      ev.preventDefault();
      setErr(''); setBusy(true);
      try{
        await window.login(u,p);      // usa il tuo AUTH CORE
        await window.getMe();         // aggiorna __USER

        // Se allowlist ha negato, apiMe() fa signOut e __USER resta null.
        if (!window.__USER) {
          let d = '';
          try { d = sessionStorage.getItem('__auth_denied') || ''; sessionStorage.removeItem('__auth_denied'); } catch {}
          setErr(d
            ? ('Accesso negato: utente NON in allowlist (' + d + ')')
            : 'Accesso negato (allowlist): utente non autorizzato'
          );
          return;
        }

        const last = localStorage.getItem('lastRoute') || '#/dashboard';
        location.hash = (typeof last === 'string' && last.startsWith('#/')) ? last : '#/dashboard';
      }catch(e){
        setErr( (e.body && e.body.error) ? String(e.body.error) : 'Login fallito' );
      }finally{
        setBusy(false);
      }
    }

    async function doLogout(){
      setBusy(true);
      try{
        await window.logout();        // usa il tuo AUTH CORE
        alert('Logout OK');
        location.hash = '#/login';
      }finally{ setBusy(false); }
    }

    return e('div',{className:'page', style:{maxWidth:360, margin:'40px auto'}},
  e('h2', null, logged ? 'Sei autenticato' : 'Accedi'),
  logged
    ? e('div',{className:'card', style:{padding:12}},
        e('div',{
          className:'actions',
          style:{justifyContent:'flex-end', marginTop:10}
        },
          e('button',{
            className:'btn',
            onClick:doLogout,
            disabled:busy
          }, busy ? '…' : 'Logout')
        )
      )
    : e('form',{onSubmit:onSubmit, className:'card', style:{padding:12}},
        e('label', null, 'Utente'),
        e('input',{
          value:u,
          onChange:ev=>setU(ev.target.value),
          autoFocus:true
        }),
        e('label', null, 'Password'),
        e('input',{
          type:'password',
          value:p,
          onChange:ev=>setP(ev.target.value)
        }),
        e('div',{style:{marginTop:10, paddingTop:8, borderTop:'1px solid #eee'}},
          e('div',{style:{fontSize:12, opacity:.85, marginBottom:6}},
            'Nuovo dispositivo? Importa appSettings (include allowlist).'
          ),
          e('label', {className:'btn btn-outline', htmlFor:'import-appsettings-file'}, 'Importa configurazione…'),
          e('input', {
            id:'import-appsettings-file',
            type:'file',
            accept:'application/json',
            style:{display:'none'},
            onChange: onImportAppSettings
          })
        ),
        err && e('div',{style:{color:'#b00',marginTop:8}}, String(err)),
        e('div',{
          className:'actions',
          style:{marginTop:10, justifyContent:'flex-end'}
        },
          e('button',{
            type:'submit',
            className:'btn',
            disabled:busy
          }, busy ? '…' : 'Entra')
        )
      )
  );
  }

    // dopo la definizione di LoginView (versione 2)
  window.LoginView = LoginView;
  window.ROUTES = window.ROUTES || {};
  window.ROUTES['#/login'] = window.LoginView;

})();

// === Overlay di Login (idempotente, solo su #/login, auto-close) ===
(function mountAuthOverlay(){
  // se già autenticato e sei finito su #/login, porta via e non montare
  if (window.__USER && String(location.hash).toLowerCase().startsWith('#/login')) {
    const intent = sessionStorage.getItem('__intent_timbratura') === '1';
    location.hash = intent ? '#/timbratura' : '#/dashboard';
    try { sessionStorage.removeItem('__intent_timbratura'); } catch {}
    return;
  }

  // monta solo se siamo su #/login
  if (!String(location.hash).toLowerCase().startsWith('#/login')) return;

  // evita duplicati / attese DOM
  if (!document.body) { requestAnimationFrame(mountAuthOverlay); return; }
  if (document.getElementById('auth-overlay')) return;

  // container unico
  const host = document.createElement('div');
  host.id = 'auth-overlay';
  document.body.appendChild(host);

  const e = React.createElement;
  const root = ReactDOM.createRoot(host);
  window.__AUTH_OVERLAY_ROOT = root; // riferimento globale (debug/cleanup)

  function Screen(){
    const [hash, setHash] = React.useState(location.hash);

    const close = React.useCallback(() => {
      try { root.unmount(); } catch {}
      try { host.remove(); } catch {}
    }, []);

    React.useEffect(() => {
      // chiudi se cambia hash fuori da #/login o se arriva un auth-change con utente loggato
      const onHash = () => {
        setHash(location.hash);
        if (!String(location.hash).toLowerCase().startsWith('#/login')) close();
      };
      const onAuth = () => {
        if (!window.__USER) return;
        const last = localStorage.getItem('lastRoute') || '#/dashboard';
        if (String(location.hash).toLowerCase().startsWith('#/login')) {
          location.hash = (typeof last === 'string' && last.startsWith('#/')) ? last : '#/dashboard';
        }
        close();
      };

      // --- (1) hashchange: rimuovi eventuale handler precedente e re-installa in modo sicuro
try {
  if (window.__anima_router_handler) {
    window.removeEventListener('hashchange', window.__anima_router_handler);
  }
} catch {}

window.__anima_router_handler = function(ev){
  const now = Date.now();
  if (now - (window.__anima_lastNav || 0) < 30) {
    // debounce anti-doppio trigger (estensioni/refresh rapidi)
    return;
  }
  window.__anima_lastNav = now;
  try { onHash(ev); } catch (e) { console.error('[router] onHash error', e); }
};
window.addEventListener('hashchange', window.__anima_router_handler);

// --- (2) load: stesso principio, un solo handler
try {
  if (window.__anima_router_load_handler) {
    window.removeEventListener('load', window.__anima_router_load_handler);
  }
} catch {}

window.__anima_router_load_handler = function(ev){
  try { onHash(ev); } catch (e) { console.error('[router] onLoad->onHash error', e); }
};
window.addEventListener('load', window.__anima_router_load_handler);

// --- (3) flag di installazione (solo informativo)
window.__anima_router.installed = true;

      // stato iniziale: se già loggato, chiudi subito
      if (window.__USER) onAuth();

      return () => {
        window.removeEventListener('hashchange', onHash);
        window.removeEventListener('auth-change', onAuth);
      };
    }, [close]);

    // se per qualche race non siamo più su #/login, non renderizzare nulla
    if (!String(hash||'').toLowerCase().startsWith('#/login')) return null;

    const wrap = {
      position:'fixed', inset:0, background:'rgba(0,0,0,.35)', zIndex:10000,
      display:'grid', placeItems:'center', padding:16
    };
    const card = {
      background:'#fff', width:'min(420px, 100%)',
      borderRadius:10, padding:16, boxShadow:'0 8px 24px rgba(0,0,0,.2)'
    };

    return e('div', {style:wrap},
      e('div', {style:card},
        e(window.LoginView || (() => e('div', null, 'Login non disponibile')))
      )
    );
  }

  root.render(e(Screen));
})();


// === producedPieces: modello A = MIN tra le fasi (limitata a qtaPezzi) ===
window.producedPieces = window.producedPieces || function (c) {
  if (!c) return 0;
  const tot = Math.max(0, Number(c.qtaPezzi || 0));

  const deaccent = s => String(s||'')
    .normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
  const isOncePhase = (f) => {
    if (f && (f.once === true || f.unaTantum === true)) return true;
    const name = deaccent(f?.lav||'');
    return /(^|[^a-z])preparazione\s+attivita([^a-z]|$)/.test(name);
  };

  if (Array.isArray(c.fasi) && c.fasi.length) {
    const arr = c.fasi
      .filter(f => !isOncePhase(f))
      .map(f => Math.max(0, Number(f.qtaProdotta || 0)));

    const m = arr.length ? Math.min(...arr) : 0;
    return tot > 0 ? Math.min(m, tot) : m;
  }
  return Math.max(0, Number(c.qtaProdotta || 0));
};

// ===== ID generator uniforme: usa nextIdUnique se c'è, altrimenti counters in LS =====
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{return d;} });
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });
  const pad = (n,w)=> String(n).padStart(w||3,'0');

  function nextSeriesCounter(series){
    const year = new Date().getFullYear();
    const counters = lsGet('counters', {}) || {};
    const prev = counters[series];
    const num = (prev && prev.year===year && Number.isFinite(prev.num)) ? (prev.num+1) : 1;
    counters[series] = { year, num };
    lsSet('counters', counters);
    return { year, num };
  }

  // API: nextIdFor({ prefix:'OF', storageKey:'ordiniFornitoriRows', seriesKey:'OF', width:3 })
  window.nextIdFor = window.nextIdFor || function({ prefix, storageKey, seriesKey, width=3 }){
    const sKey = seriesKey || prefix; // es. 'OF', 'DDT', 'FA', 'MC'
    if (typeof window.nextIdUnique === 'function') {
      // usa l’implementazione nativa se presente (mantiene compatibilità con altre viste)
      return window.nextIdUnique(sKey, prefix, storageKey);
    }
    const { year, num } = nextSeriesCounter(sKey);
    return { id: `${prefix}-${year}-${pad(num, width)}`, year, num };
  };
})();

// === ATOMIC PERSIST (scrive subito e forza repaint) ===
window.persistKV = window.persistKV || function persistKV(key, value){
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  // facoltativo: duplica su lsSet per marcare __anima_dirty, se presente
  try { if (typeof window.lsSet === 'function') window.lsSet(key, value); } catch {}
  window.__anima_dirty = true;
  try { if (typeof window.requestAppRerender === 'function') window.requestAppRerender(); } catch {}
};

// ==== RBAC helper: true se ruolo = accountant (sola lettura) ====
// Allineato al modello nuovo: fonte unica = utente corrente (__USER / currentUser)
//window.isReadOnlyUser = function(){
//  const u =
//    window.__USER ||
//    window.currentUser ||
//    null;

//  return !!(u && u.role === 'accountant');
// };

// Zeri a sinistra per i progressivi
  g.formatNNN = g.formatNNN || (n => String(n).padStart(3,'0'));

  // Progressivi centralizzati per anno (serie: "ore","C","DDT","FA","OF", ecc.)
  g.nextProgressivo = g.nextProgressivo || function(series){
    try{
      const year = new Date().getFullYear();
      const counters = g.lsGet('counters', {});
      const key = `${series}:${year}`;
      const num = Number(counters[key]||0) + 1;
      counters[key] = num;
      g.lsSet('counters', counters);
      return { year, num, code: `${series}-${year}-${g.formatNNN(num)}` };
    }catch(e){
      const year = new Date().getFullYear();
      return { year, num: 1, code: `${series}-${year}-001` };
    }
  };

  // Stampa sicura di una stringa HTML
  g.safePrintHTMLString = g.safePrintHTMLString || function(html){
    try{
      const ifr = document.createElement('iframe');
      ifr.style.width = ifr.style.height = '0';
      ifr.style.border = '0';
      document.body.appendChild(ifr);
      const d = ifr.contentWindow.document;
      d.open(); d.write(html); d.close();
      setTimeout(() => { try{ ifr.contentWindow && ifr.contentWindow.focus(); }catch{} }, 80);
    }catch(e){ console.warn('safePrintHTMLString error', e); }
  };

  // Navigazione coerente col tuo progetto
  g.navigateTo = g.navigateTo || function(tab){
    const t = String(tab||'').toLowerCase();
    const hash = (t==='report') ? '#/report'
               : (t==='impostazioni') ? '#/impostazioni'
               : (t==='timbratura') ? '#/timbratura'
               : '#/';
    if (location.hash !== hash) location.hash = hash;
    if (typeof g.setTab === 'function') g.setTab(tab);
  };
  g.goBackSmart = g.goBackSmart || function(){
    try { if (history.length > 1) history.back(); else location.hash = '#/impostazioni'; }
    catch { location.hash = '#/impostazioni'; }
  };

  // Ordinamento utility (usata da varie view)
  g.sortNewestFirst = g.sortNewestFirst || function(arr, { dateKeys=[] } = {}){
    const a = Array.isArray(arr) ? arr.slice() : [];
    const keys = dateKeys;
    const ts = o => {
      for (const k of keys){ const v = o && o[k]; if (v) return new Date(v).getTime(); }
      return new Date(o && (o.updatedAt || o.__createdAt || o.createdAt || 0)).getTime() || 0;
    };
    return a.sort((x,y)=> ts(y) - ts(x));
  };
})();

/* ===== Supabase helpers (cloud) ========================================== */
(function supabaseHelpers(){
  const g = window;

  // Legge le credenziali da appSettings (se abilitate)
  g.getSB = g.getSB || function(){
    try{
      const a = g.lsGet('appSettings', {}) || {};
      if (!(a.cloudEnabled && a.supabaseUrl && a.supabaseKey)) return null;
      return {
        url: String(a.supabaseUrl).replace(/\/+$/,''),
        key: a.supabaseKey,
        table: a.supabaseTable || 'anima_sync'
      };
    }catch{ return null; }
  };

  // Insert generico
  g.sbInsert = g.sbInsert || async function(table, payload){
    const sb = g.getSB(); if(!sb) throw new Error('Supabase non configurato');
    const url = `${sb.url}/rest/v1/${encodeURIComponent(table)}`;
    const res = await fetch(url, {
      method:'POST',
      headers:{
        apikey: sb.key,
        Authorization: `Bearer ${sb.key}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation'
      },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  };

  // Patch by id (colonna "id")
  g.sbPatchById = g.sbPatchById || async function(table, id, payload){
    const sb = g.getSB(); if(!sb) throw new Error('Supabase non configurato');
    const url = `${sb.url}/rest/v1/${encodeURIComponent(table)}?id=eq.${encodeURIComponent(id)}`;
    const res = await fetch(url, {
      method:'PATCH',
      headers:{
        apikey: sb.key,
        Authorization: `Bearer ${sb.key}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation'
      },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  };

  // Select semplice (opzionale, può tornare utile)
  g.sbSelect = g.sbSelect || async function(table, query='*'){
    const sb = g.getSB(); if(!sb) throw new Error('Supabase non configurato');
    const url = `${sb.url}/rest/v1/${encodeURIComponent(table)}?select=${encodeURIComponent(query)}`;
    const res = await fetch(url, { headers:{ apikey: sb.key, Authorization:`Bearer ${sb.key}` } });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  };
    // === Magazzino articoli: sync cloud <-> locale ==========================
  g.sbUpsertMagazzinoArticoli = g.sbUpsertMagazzinoArticoli || async function(rows){
    const sb = g.getSB(); if (!sb) throw new Error('Supabase non configurato');
    const list = Array.isArray(rows) ? rows : [];
    if (!list.length) return [];

    const url = `${sb.url}/rest/v1/magazzino_articoli?on_conflict=codice`;
    const user = (window.__USER && (window.__USER.email || window.__USER.username || window.__USER.user)) || null;

    const payload = list
      .map(r => ({
        codice      : String(r.codice || '').trim(),
        descrizione : String(r.descrizione || ''),
        um          : String(r.um || 'PZ').toUpperCase(),
        prezzo      : Number(r.prezzo || 0),
        costo       : Number(r.costo || 0),
        updated_by  : user
      }))
      .filter(r => r.codice);

    if (!payload.length) return [];

    const res = await fetch(url, {
      method:'POST',
      headers:{
        apikey: sb.key,
        Authorization: `Bearer ${sb.key}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation,resolution=merge-duplicates'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  };

  g.syncMagazzinoFromCloud = g.syncMagazzinoFromCloud || async function(){
    try{
      const sb = g.getSB();
      if (!sb) {
        console.log('[syncMagazzinoFromCloud] Supabase non configurato');
        return { ok:false, reason:'no-sb' };
      }

      // rispetta il flag cloudEnabled
      let settings = {};
      try{ settings = g.lsGet('appSettings', {}) || {}; }catch{}
      if (!settings.cloudEnabled) {
        console.log('[syncMagazzinoFromCloud] cloudDisabled in appSettings');
        return { ok:false, reason:'cloud-disabled' };
      }

      // stato locale corrente (magArticoli_v2)
      let local = [];
      try{
        const rawLocal = localStorage.getItem('magArticoli_v2');
        if (rawLocal && rawLocal !== 'null' && rawLocal !== '[]'){
          local = JSON.parse(rawLocal);
        }
      }catch{}
      if (!Array.isArray(local)) local = [];

      // leggi dal cloud con paginazione (max 1000 per pagina)
      let cloud = [];
      try{
        const selectCols = 'codice,descrizione,um,prezzo,costo,updated_at,updated_by';
        const pageSize = 1000;
        let page = 0;

        while (true){
          const url = `${sb.url}/rest/v1/magazzino_articoli` +
            `?select=${encodeURIComponent(selectCols)}` +
            `&limit=${pageSize}&offset=${page * pageSize}`;

          const res = await fetch(url, {
            headers:{
              apikey: sb.key,
              Authorization: `Bearer ${sb.key}`
            }
          });
          if (!res.ok) throw new Error(await res.text());

          const batch = await res.json();
          if (!Array.isArray(batch) || batch.length === 0) break;

          cloud.push(...batch);

          // se abbiamo preso meno di pageSize, non ci sono altre pagine
          if (batch.length < pageSize) break;

          page++;
          // sicurezza: non leggere più di 20.000 righe
          if (page > 20){
            console.warn('[syncMagazzinoFromCloud] raggiunto limite pagine, mi fermo');
            break;
          }
        }

        console.log('[syncMagazzinoFromCloud] letti dal cloud', cloud.length);
      }catch(err){
        console.warn('[syncMagazzinoFromCloud] select error', err);
        return { ok:false, reason:'select-fail', error:String(err) };
      }
      if (!Array.isArray(cloud)) cloud = [];

      // 1) se cloud vuoto ma locale pieno => SEED cloud da locale (PRIMA VOLTA)
      if (!cloud.length && local.length){
        try{
          await g.sbUpsertMagazzinoArticoli(local);
          console.log('[syncMagazzinoFromCloud] seeded cloud from local', local.length);
          return { ok:true, from:'local->cloud', seeded:true, count: local.length };
        }catch(err){
          console.warn('[syncMagazzinoFromCloud] seed error', err);
          return { ok:false, reason:'seed-fail', error:String(err) };
        }
      }

      // 2) se cloud ha dati => usa cloud come sorgente per locale
      if (cloud.length){
        const mapped = cloud
          .map(r => ({
            codice      : String(r.codice || '').trim(),
            descrizione : String(r.descrizione || ''),
            um          : String(r.um || 'PZ').toUpperCase(),
            prezzo      : Number(r.prezzo || 0),
            costo       : Number(r.costo || 0)
          }))
          .filter(r => r.codice);

        mapped.sort((a,b)=> a.codice.localeCompare(b.codice));
        try{
          localStorage.setItem('magArticoli_v2', JSON.stringify(mapped));
        }catch{}
        console.log('[syncMagazzinoFromCloud] updated local from cloud', mapped.length);
        return { ok:true, from:'cloud->local', count:mapped.length };
      }

      // 3) niente da fare (entrambi vuoti)
      console.log('[syncMagazzinoFromCloud] nothing to sync (empty both)');
      return { ok:true, from:'none', count:0 };
    }catch(err){
      console.warn('[syncMagazzinoFromCloud] unexpected error', err);
      return { ok:false, reason:'exception', error:String(err) };
    }
  };

    // === COMMESSE: upsert su Supabase =======================================
  g.sbUpsertCommesse = g.sbUpsertCommesse || async function(rows){
    const sb = g.getSB(); if (!sb) throw new Error('Supabase non configurato');
    const list = Array.isArray(rows) ? rows : [];
    if (!list.length) return [];

    const user = (window.__USER && (window.__USER.email || window.__USER.username || window.__USER.user)) || null;

    const payload = list.map(c => {
      try{
        const id = String(c.id || '').trim();
        if (!id) return null;

        const clienteId   = c.clienteId != null ? String(c.clienteId) : null;
        const clienteNome = c.cliente || c.cliente_nome || '';
        const descrizione = c.descrizione || '';
        const stato       = c.stato || '';
        const priorita    = c.priorita || '';

        const createdAt   = c.createdAt || null;
        const dataCreat   = createdAt ? String(createdAt).slice(0,10) : null;

        const scadRaw     = c.scadenza || c.dataScadenza || c.dataConsegna || null;
        const dataScad    = scadRaw ? String(scadRaw).slice(0,10) : null;

        const qtaPezzi    = Number(c.qtaPezzi || 0) || 0;
        const qtaProd     = Number(c.qtaProdotta || 0) || 0;
        const orePrev     = Number(c.oreTotaliPrev || 0) || 0;
        const luogo       = c.luogoConsegna || '';

        const rifRaw =
          c.rifCliente ||
          c.ordineCliente ||
          c.nrOrdineCliente ||
          c.ddtCliente ||
          c.po ||
          c.nrCliente ||
          null;

        let rifTipo   = null;
        let rifNumero = null;
        let rifData   = null;

        if (rifRaw && typeof rifRaw === 'object'){
          rifTipo   = rifRaw.tipo   || null;
          rifNumero = rifRaw.numero || null;
          rifData   = rifRaw.data   ? String(rifRaw.data).slice(0,10) : null;
        } else if (typeof rifRaw === 'string'){
          rifNumero = rifRaw;
        }

        // payload = commessa completa come la usi nel gestionale
        const fullPayload = { ...c };
        if (!fullPayload.id) fullPayload.id = id;

        return {
          id,
          cliente_id        : clienteId,
          cliente_nome      : clienteNome,
          descrizione,
          stato,
          priorita,
          data_creazione    : dataCreat,
          data_scadenza     : dataScad,
          qta_pezzi         : qtaPezzi || null,
          qta_prod          : qtaProd || null,
          ore_totali_prev   : orePrev || null,
          luogo_consegna    : luogo,
          rif_cliente_tipo   : rifTipo,
          rif_cliente_numero : rifNumero,
          rif_cliente_data   : rifData,
          updated_by        : user,
          payload           : fullPayload
        };
      }catch(e){
        console.warn('[sbUpsertCommesse] errore su commessa', c && c.id, e);
        return null;
      }
    }).filter(x => x && x.id);

    if (!payload.length) return [];

    const url = `${sb.url}/rest/v1/commesse?on_conflict=id`;

    const res = await fetch(url, {
      method:'POST',
      headers:{
        apikey: sb.key,
        Authorization: `Bearer ${sb.key}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation,resolution=merge-duplicates'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  };

  // === COMMESSE: sync cloud <-> locale ====================================
  g.syncCommesseFromCloud = g.syncCommesseFromCloud || async function(){
    try{
      const sb = g.getSB();
      if (!sb) {
        console.log('[syncCommesseFromCloud] Supabase non configurato');
        return { ok:false, reason:'no-sb' };
      }

      // rispetta cloudEnabled
      let settings = {};
      try{ settings = g.lsGet('appSettings', {}) || {}; }catch{}
      if (!settings.cloudEnabled) {
        console.log('[syncCommesseFromCloud] cloudDisabled in appSettings');
        return { ok:false, reason:'cloud-disabled' };
      }

      // stato locale corrente
      let local = [];
      try{
        const rawLocal = (g.lsGet && g.lsGet('commesseRows', [])) || [];
        if (Array.isArray(rawLocal)) local = rawLocal;
      }catch{}
      if (!Array.isArray(local)) local = [];

      // leggi dal cloud con paginazione
      let cloud = [];
      try{
        const selectCols = [
          'id',
          'cliente_id',
          'cliente_nome',
          'descrizione',
          'stato',
          'priorita',
          'data_creazione',
          'data_scadenza',
          'qta_pezzi',
          'qta_prod',
          'ore_totali_prev',
          'luogo_consegna',
          'rif_cliente_tipo',
          'rif_cliente_numero',
          'rif_cliente_data',
          'updated_at',
          'updated_by',
          'payload'
        ].join(',');

        const pageSize = 500;
        let page = 0;

        while (true){
          const url = `${sb.url}/rest/v1/commesse` +
            `?select=${encodeURIComponent(selectCols)}` +
            `&limit=${pageSize}&offset=${page * pageSize}`;

          const res = await fetch(url, {
            headers:{
              apikey: sb.key,
              Authorization: `Bearer ${sb.key}`
            }
          });
          if (!res.ok) throw new Error(await res.text());
          const batch = await res.json();
          if (!Array.isArray(batch) || batch.length === 0) break;

          cloud.push(...batch);
          if (batch.length < pageSize) break;
          page++;
          if (page > 40){
            console.warn('[syncCommesseFromCloud] limite pagine raggiunto, stop');
            break;
          }
        }

        console.log('[syncCommesseFromCloud] letti dal cloud', cloud.length);
      }catch(err){
        console.warn('[syncCommesseFromCloud] select error', err);
        return { ok:false, reason:'select-fail', error:String(err) };
      }
      if (!Array.isArray(cloud)) cloud = [];

      // 1) seed: cloud vuoto ma locale pieno -> mando le commesse locali su cloud
      if (!cloud.length && local.length){
        try{
          await g.sbUpsertCommesse(local);
          console.log('[syncCommesseFromCloud] seeded cloud from local', local.length);
          return { ok:true, from:'local->cloud', seeded:true, count: local.length };
        }catch(err){
          console.warn('[syncCommesseFromCloud] seed error', err);
          return { ok:false, reason:'seed-fail', error:String(err) };
        }
      }

      // 2) se cloud ha dati -> uso cloud come sorgente per ls 'commesseRows'
      if (cloud.length){
        const mapped = cloud.map(row => {
          const p = (row && typeof row.payload === 'object') ? row.payload : {};
          // garantisco l'id coerente
          if (!p.id && row.id) p.id = row.id;
          return p;
        });

        // ordinare per id decrescente (come fai tu quando metti le nuove in testa)
        mapped.sort((a,b)=> String(b.id||'').localeCompare(String(a.id||'')));

        try{
          if (g.lsSet) g.lsSet('commesseRows', mapped);
          else localStorage.setItem('commesseRows', JSON.stringify(mapped));
        }catch(e){
          console.warn('[syncCommesseFromCloud] errore scrittura LS', e);
        }

        console.log('[syncCommesseFromCloud] updated local from cloud', mapped.length);
        return { ok:true, from:'cloud->local', count:mapped.length };
      }

      console.log('[syncCommesseFromCloud] nothing to sync (empty both)');
      return { ok:true, from:'none', count:0 };
    }catch(err){
      console.warn('[syncCommesseFromCloud] unexpected error', err);
      return { ok:false, reason:'exception', error:String(err) };
    }
  };
})();

/* ===== Timesheets sync utils (una sola volta) ============================ */
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  const LS_WM_KEY = 'oreSyncWM';
  window.__oreSync = window.__oreSync || {
    getWM(){ try{ return JSON.parse(localStorage.getItem(LS_WM_KEY)||'{}').ts || ''; }catch{ return '';} },
    setWM(ts){ try{ localStorage.setItem(LS_WM_KEY, JSON.stringify({ts: ts||''})); }catch{}; },
    isDup(rec, rows){
      // DEDUP: stessa commessa + stessa data + stesso operatore + stessi minuti + stesse note
      return (rows||[]).some(x =>
        x.commessaId === rec.commessaId &&
        String(x.data||'').slice(0,10) === rec.data &&
        String(x.operatore||'') === String(rec.operatore||'') &&
        Number(x.oreMin||0) === Number(rec.oreMin||0) &&
        String(x.note||'') === String(rec.note||'')
      );
    }
  };
})();

/* ===== Alias chiavi Magazzino + saveKey compat =========================== */
(function ensureMagKeyAliases(){
  const g = window;

  // Scrive sulle chiavi corrette e mantiene compatibilità
  g.saveKey = g.saveKey || function(key, value){
    try{
      if (key === 'magArticoli' || key === 'magazzinoArticoli'){
        g.lsSet('magArticoli', value);
        g.lsSet('magazzinoArticoli', value);
        return;
      }
      if (key === 'magMovimenti'){
        g.lsSet('magMovimenti', value);
        return;
      }
      g.lsSet(key, value);
    }catch{}
  };

  // Se esiste solo una delle due, duplica nell’altra
  try{
    const a = g.lsGet('magArticoli', null);
    const b = g.lsGet('magazzinoArticoli', null);
    if (a && !b) g.lsSet('magazzinoArticoli', a);
    if (b && !a) g.lsSet('magArticoli', b);
  }catch{}
})();

/* ===== Auto-creazione articoli da righe commessa (import PDF) ===== */
window.ensureMagazzinoArticoliFromRighe = window.ensureMagazzinoArticoliFromRighe || function(righe){
  try{
    if (!Array.isArray(righe) || !righe.length) return;

    const cleanCod = v => String(v || '').trim();

    // Candidati da righe: solo se hanno un codice
    const candidates = [];
    righe.forEach(r => {
      if (!r) return;
      const cod = cleanCod(r.codice || r.articoloCodice);
      if (!cod) return;
      const descr = String(r.descrizione || r.articoloDescr || '').trim();
      const um    = String(r.um || r.UM || 'PZ').toUpperCase();
      // FIX: Leggiamo il prezzo che arriva dal parser!
      const prezzo = Number(r.prezzo || r.prezzoUnitario || 0);
      
      candidates.push({ codice: cod, descrizione: descr, um, prezzo });
    });

    if (!candidates.length) return;

    // Carica articoli esistenti
    let existing = [];
    try{
      const rawV2 = localStorage.getItem('magArticoli_v2');
      if (rawV2 && rawV2 !== 'null' && rawV2 !== '[]') {
        existing = JSON.parse(rawV2) || [];
      } else if (typeof window.lsGet === 'function') {
        existing = window.lsGet('magArticoli', []) || [];
      }
    }catch(e){ console.warn('[Magazzino] load error', e); }

    const byCod = new Map();
    (Array.isArray(existing) ? existing : []).forEach(a => {
      if (!a) return;
      const cod = cleanCod(a.codice);
      if (!cod) return;
      if (!byCod.has(cod)) byCod.set(cod, a);
    });

    let changed = false;
    const nowISO = new Date().toISOString(); // <--- Data di oggi per i nuovi

    candidates.forEach(a => {
      const cod = a.codice;
      if (!cod) return;
      // Se l'articolo NON esiste, lo creiamo con il prezzo letto
      if (!byCod.has(cod)) {
        byCod.set(cod, {
          codice     : cod,
          descrizione: a.descrizione,
          um         : a.um || 'PZ',
          prezzo     : a.prezzo || 0, // FIX: Qui salviamo il prezzo! Prima era 0 fisso.
          costo      : 0,
          tipo       : 'CONTO LAVORO',
          nuovoDaOrdine: true,
          createdAt  : nowISO // <--- AGGIUNTA DATA INSERIMENTO
        });
        changed = true;
      }
    });

    if (!changed) return;

    const out = Array.from(byCod.values())
      .filter(a => a && cleanCod(a.codice))
      .sort((A,B) => cleanCod(A.codice).localeCompare(cleanCod(B.codice)));

    // Salvataggio robusto
    try{ localStorage.setItem('magArticoli_v2', JSON.stringify(out)); }catch(e){}
    try{
      if (typeof window.lsSet === 'function') {
        window.lsSet('magArticoli', out);
        window.lsSet('magazzinoArticoli', out);
      } else {
        localStorage.setItem('magArticoli', JSON.stringify(out));
      }
    }catch(e){}
    
    console.log('[Magazzino] Nuovi articoli creati da ordine con prezzi e data.');
  }catch(err){
    console.warn('[Magazzino] ensureMagazzinoArticoliFromRighe error', err);
  }
};

/* ===== Auto-sync magazzino da righe ordine (PDF → commessa) ===== */
window.autoSyncMagazzinoDaRighe = window.autoSyncMagazzinoDaRighe || function(righe){
  try{
    if (!Array.isArray(righe) || !righe.length) return righe;

    const cleanCod = v => String(v || '').trim();
    const normUM   = v => String(v || 'PZ').trim().toUpperCase();

    // 1) Carica articoli esistenti
    let existing = [];
    try{
      const rawV2 = localStorage.getItem('magArticoli_v2');
      if (rawV2 && rawV2 !== 'null' && rawV2 !== '[]') {
        existing = JSON.parse(rawV2) || [];
      } else if (typeof window.lsGet === 'function') {
        existing = window.lsGet('magArticoli', []) || [];
      }
    }catch(e){
      console.warn('[Magazzino] autoSyncMagazzinoDaRighe load error', e);
    }

    const byCod = new Map();
    (Array.isArray(existing) ? existing : []).forEach(a => {
      if (!a) return;
      const cod = cleanCod(a.codice);
      if (!cod) return;
      if (!byCod.has(cod)) byCod.set(cod, a);
    });

    // 2) Aggiorna righe e prepara eventuali nuovi articoli
    const updatedRighe = righe.map(r => {
      if (!r) return r;

      const cod = cleanCod(r.codice || r.articoloCodice);
      if (!cod) return r;

      let descr = String(r.descrizione || r.articoloDescr || '').trim();
      let um    = normUM(r.um || r.UM);

      // prezzo letto dal parser (se in futuro lo mettiamo nelle righe)
      let prezzoOrdine = null;
      if (r.prezzo != null && r.prezzo !== '') {
        const t = String(r.prezzo).replace(/\./g,'').replace(',', '.');
        const n = Number(t);
        if (Number.isFinite(n)) prezzoOrdine = n;
      }

     const existingArt = byCod.get(cod);

     if (existingArt) {
       // Se l'articolo esiste, in commessa uso descrizione/UM dell'anagrafica
       if (existingArt.descrizione) {
         descr = String(existingArt.descrizione).trim();
       }
       if (existingArt.um) {
         um = normUM(existingArt.um);
       }

       // Traccia sempre l’ultimo prezzo ordine letto (non tocca il prezzo listino)
       if (prezzoOrdine != null) {
         existingArt.lastPrezzoOrdine = prezzoOrdine;
       }

       // Se la riga non ha prezzo ma l'articolo sì, copio in r.prezzo (per uso futuro)
       if (prezzoOrdine == null && existingArt.prezzo != null) {
         r.prezzo = existingArt.prezzo;
       }
     } else {
       // Nuovo articolo da creare in anagrafica
       const nuovo = {
         codice     : cod,
         descrizione: descr,
         um         : um,
         prezzo     : prezzoOrdine != null ? prezzoOrdine : 0,
         costo      : 0,
         tipo       : 'CONTO LAVORO',
         nuovoDaOrdine: true,
         lastPrezzoOrdine: prezzoOrdine != null ? prezzoOrdine : undefined
       };
       byCod.set(cod, nuovo);
     }

      // Ritorno una riga "normalizzata" per la commessa
      return Object.assign({}, r, {
        codice,
        descrizione: descr,
        um
      });
    });

    // 3) Salva articoli aggiornati
    const out = Array.from(byCod.values())
      .filter(a => a && cleanCod(a.codice))
      .sort((A,B) => cleanCod(A.codice).localeCompare(cleanCod(B.codice)));

    try{
      localStorage.setItem('magArticoli_v2', JSON.stringify(out));
    }catch(e){
      console.warn('[Magazzino] autoSyncMagazzinoDaRighe write magArticoli_v2 error', e);
    }

    try{
      if (typeof window.saveKey === 'function') {
        window.saveKey('magArticoli', out);
      } else if (typeof window.lsSet === 'function') {
        window.lsSet('magArticoli', out);
        window.lsSet('magazzinoArticoli', out);
      } else {
        localStorage.setItem('magArticoli', JSON.stringify(out));
        localStorage.setItem('magazzinoArticoli', JSON.stringify(out));
      }
    }catch(e){
      console.warn('[Magazzino] autoSyncMagazzinoDaRighe write compat error', e);
    }

    return updatedRighe;
  }catch(err){
    console.warn('[Magazzino] autoSyncMagazzinoDaRighe error', err);
    return righe;
  }
};

/* ===== Compat kit: helper & fallback senza cambiare UI =================== */
(function compatKit(){
  const g=window;

  // Ordina array per date più recenti (usato in DDT/Fatture)
  g.sortNewestFirst = g.sortNewestFirst || function(arr, {dateKeys=[]}={}){
    const getMs = (o,k)=>{ const v=o && o[k]; const d=new Date(v); return isNaN(d)?0:d.getTime(); };
    const a = Array.isArray(arr)?arr.slice():[];
    a.sort((A,B)=>{
      for(const k of dateKeys){ const diff=getMs(B,k)-getMs(A,k); if(diff) return diff; }
      const ib=String((B&&B.id)||''); const ia=String((A&&A.id)||''); return ib.localeCompare(ia);
    });
    return a;
  };

  // ID progressivo unico: PREFIX-YYYY-NNN, evitando collisioni nello store
  g.nextIdUnique = g.nextIdUnique || function(series, prefix, storeKey){
    const np = g.nextProgressivo(series);
    const pad = g.formatNNN ? g.formatNNN : (n=>String(n).padStart(3,'0'));
    const rows = g.lsGet(storeKey, []) || [];
    const used = new Set((Array.isArray(rows)?rows:[]).map(r=>String(r.id)));
    let n = np.num, id = `${prefix}-${np.year}-${pad(n)}`, guard=0;
    while(used.has(id) && guard<1000){ n++; id = `${prefix}-${np.year}-${pad(n)}`; guard++; }
    return { id, year: np.year, num: n };
  };

  // Stampa sicura di un HTML string (iframe temporaneo)
  g.safePrintHTMLString = g.safePrintHTMLString || function(html){
    try{
      const ifr = document.createElement('iframe');
      ifr.style.position='fixed'; ifr.style.right='0'; ifr.style.bottom='0';
      ifr.style.width='0'; ifr.style.height='0'; ifr.style.border='0';
      document.body.appendChild(ifr);
      const d = ifr.contentWindow.document;
      d.open(); d.write(String(html||'')); d.close();
      setTimeout(()=>{ try{ ifr.contentWindow.focus(); ifr.contentWindow.print(); }catch{} setTimeout(()=>ifr.remove(),300); }, 200);
    }catch(e){ alert('Stampa non disponibile: '+(e&&e.message||e)); }
  };

  // Scanner QR (fallback minimale se lo scanner non è disponibile)
  g.scanQR = g.scanQR || function(){
    const v = prompt('Inserisci ID commessa (es. C-2025-001) oppure incolla il QR/URL:');
    if(!v) return;
    const m = String(v).match(/[?&]job=([^&#]+)/i);
    const id = m ? decodeURIComponent(m[1]) : String(v).trim();
    if(!id) return;
    try{ localStorage.setItem('qrJob', JSON.stringify(id)); }catch{}
    location.hash = '#/timbratura?job=' + encodeURIComponent(id);
  };

  // Carico da Ordine Fornitore (+ CMP opzionale)
  g.creaMovimentoCaricoDaOrdine = g.creaMovimentoCaricoDaOrdine || function(ordine, righeCarico, opt={}){
    try{
      const updateCMPGlobal = !!((g.lsGet('appSettings',{})||{}).magUpdateCMP);
      const updCMP = !!(opt && (opt.updateCMP || updateCMPGlobal));
      const mov = g.lsGet('magMovimenti', []) || [];
      const art = g.lsGet('magArticoli', []) || g.lsGet('magazzinoArticoli', []) || [];

      const today = new Date().toISOString().slice(0,10);
      (Array.isArray(righeCarico)?righeCarico:[]).forEach(r=>{
        const codice = String(r.codice||'').trim(); if(!codice) return;
        const q = Math.max(0, Number(r.qta||0)); if(!q) return;
        const prezzo = Number(r.prezzo||0) || 0;

        // movimento
        mov.push({
          id: undefined,
          data: opt.data || today,
          tipo: 'CARICO',
          codice,
          descrizione: r.descrizione || r.descr || '',
          um: r.um || r.UM || '',
          qta: q,
          prezzo, // costo unitario
          ordineId: ordine && ordine.id,
          ddtFornitore: opt.ddtFornitore || '',
          note: opt.note || `Carico da ordine ${ordine && ordine.id ? ordine.id : ''}`
        });

        // giacenza + CMP (media ponderata)
        let i = art.findIndex(a => String(a.codice||'').trim().toLowerCase() === codice.toLowerCase());
        if (i < 0) { art.push({ codice, descrizione: r.descrizione||r.descr||'', um: r.um||r.UM||'', giacenza: 0, cmp: 0 }); i = art.length-1; }
        const a = art[i];
        const giac0 = Number(a.giacenza||0);
        const cmp0 = Number(a.cmp||0);
        const giac1 = giac0 + q;
        let cmp1 = cmp0;
        if (updCMP){
          const tot0 = Math.max(0, giac0) * cmp0;
          const tot1 = tot0 + (q * prezzo);
          cmp1 = giac1 > 0 ? (tot1 / giac1) : cmp0;
        }
        art[i] = { ...a, giacenza: giac1, cmp: cmp1 };
      });

      g.saveKey('magMovimenti', mov);
      g.saveKey('magArticoli', art); // duplica anche su magazzinoArticoli
      g.__anima_dirty = true;
    }catch(e){ console.warn('creaMovimentoCaricoDaOrdine errore:', e); }
  };

  // Export selettivo (no-op se non configurato)
  g.syncExportToCloudOnly = g.syncExportToCloudOnly || function(keys){
    try{
      if (typeof g.syncExportToCloud === 'function') { return g.syncExportToCloud(keys); }
      console.info('[syncExportToCloudOnly] no-op', keys);
    }catch{}
  };

  // Report rapido (fallback)
  g.openReport = g.openReport || function(){ g.navigateTo && g.navigateTo('Report'); };

  // DDT rapido da commessa (prefill + nav)
  g.createDDTRapidoFromCommessa = g.createDDTRapidoFromCommessa || function(c){
    try{
      const righe = [{
        codice: '',
        descrizione: c && c.descrizione ? c.descrizione : 'Lavorazione',
        qta: Math.max(1, Number(c && c.qtaPezzi || 1)),
        UM: 'PZ',
        note: ''
      }];
      const pf = {
        data: new Date().toISOString().slice(0,10),
        clienteId: c && c.clienteId || '',
        cliente: c && c.cliente || '',
        commessaRif: c && c.id || '',
        righe
      };
      localStorage.setItem('prefillDDT', JSON.stringify(pf));
      location.hash = '#/ddt';
    }catch(e){ alert('Impossibile preparare il DDT: ' + (e && e.message || e)); }
  };

  // Backup / Ripristino (usati in Impostazioni)
  g.downloadBackup = function(){
    try{
      const dump = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        dump[k] = localStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'anima_backup.json';
      a.click(); URL.revokeObjectURL(a.href);
    }catch(e){ alert('Backup non riuscito: ' + (e && e.message || e)); }
  };
  g.restoreFromFile = g.restoreFromFile || async function(file){
    const txt = await file.text();
    const dump = JSON.parse(txt);

    // 1) Ripristina tutte le chiavi esattamente come nel backup
    Object.keys(dump||{}).forEach(k => localStorage.setItem(k, dump[k]));

    // 2) Bump degli updatedAt per tutte le entità principali,
    //    così il backup diventa la "versione più recente" per il merge by id.
    try{
      const nowISO = new Date().toISOString();
      const KEYS = [
        'commesseRows','oreRows',
        'magArticoli','magazzinoArticoli','magMovimenti',
        'fattureRows','ddtRows',
        'clientiRows','fornitoriRows','ordiniFornitoriRows',
        'appSettings'
      ];

      for (const k of KEYS){
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try{
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            const next = parsed.map(row => {
              if (row && typeof row === 'object') {
                return Object.assign({}, row, { updatedAt: nowISO });
              }
              return row;
            });
            localStorage.setItem(k, JSON.stringify(next));
          } else if (parsed && typeof parsed === 'object' && k === 'appSettings') {
            const nextApp = Object.assign({}, parsed, { updatedAt: nowISO });
            localStorage.setItem(k, JSON.stringify(nextApp));
          }
        }catch{/* ignora chiavi non-JSON */}
      }

      // Segnala che abbiamo fatto modifiche locali "forti"
      window.__anima_dirty = true;
    }catch{
      // in caso di problemi, non bloccare il ripristino
    }

    alert('Ripristino completato. L’app verrà ricaricata.');
    location.reload();
  };

  // goBackSmart fallback
  g.goBackSmart = g.goBackSmart || function(){
    try { if (history.length > 1) history.back(); else location.hash = '#/impostazioni'; }
    catch { location.hash = '#/impostazioni'; }
  };
})();

// ================== BOOTSTRAP GLOBALI + SUPABASE AUTO-SYNC ==================
// --- Utils globali sicuri (una sola volta) ---
(function () {
  // LocalStorage helpers (globali)
  window.lsGet = window.lsGet || function (k, def) {
    try { const v = JSON.parse(localStorage.getItem(k)); return (v ?? def); } catch { return def; }
  };
  window.lsSet = window.lsSet || function (k, v) {
    try { localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; } catch {}
  };

    // === Allegati: normalizzazione entityType + compatibilità OF (anti "spariti") ===
  (function(){
    if (window.__ANIMA_ALLEGATI_ENTITYTYPE_HELPERS__) return;
    window.__ANIMA_ALLEGATI_ENTITYTYPE_HELPERS__ = true;

    const norm = (t)=> String(t||'').toUpperCase().trim();

    // Mappa alias storici → tipo canonico
    const canon = (t)=>{
      t = norm(t);
      if (!t) return '';
      // OF alias storici / possibili
      if (t==='OF' || t==='ORDINI_FORNITORI' || t==='ORDINE_FORNITORE' || t==='ORDINEFORNITORE' ||
          t==='ORDINIFORNITORI' || t==='ORDINI' || t==='PO' || t==='PURCHASEORDER' || t==='PURCHASE_ORDER') return 'OF';
      // (qui possiamo aggiungere altre normalizzazioni in futuro senza refactor)
      return t;
    };

    window.normEntityType = window.normEntityType || canon;

    // Match robusto allegato↔entità (senza rompere dati legacy)
    window.allegatoMatchesEntity = window.allegatoMatchesEntity || function(a, wantedType, wantedId){
      if (!a || a.deletedAt) return false;
      const wid = String(wantedId||'');
      if (wid && String(a.entityId||'') !== wid) return false;

      const w = canon(wantedType);
      const t = canon(a.entityType);
      if (t && w && t === w) return true;

      // Fallback specifico OF: se entityId sembra OF-YYYY-NNN allora trattalo come OF
      if (w === 'OF') {
        const eid = String(a.entityId||'');
        if (/^OF-\d{4}-\d{3,6}$/i.test(eid)) return (!wid || eid === wid);
      }
      return false;
    };

    // Migrazione one-shot: porta a.entityType → 'OF' in modo conservativo
    window.migrateAllegatiEntityTypeOF = window.migrateAllegatiEntityTypeOF || function(){
      const FLAG = 'mig_allegati_entitytype_of_v1';
      try{
        const _lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; }});
        const _lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

        if (_lsGet(FLAG, false)) return { skipped:true, reason:'already' };

        const all = _lsGet('allegatiRows', []);
        if (!Array.isArray(all) || !all.length){
          _lsSet(FLAG, true);
          return { skipped:true, reason:'empty' };
        }

        const now = new Date().toISOString();
        let changed = 0;

        const next = all.map(a=>{
          if (!a || typeof a !== 'object') return a;

          const eid = String(a.entityId||'');
          const t0  = norm(a.entityType);
          const isOfLike = (canon(t0) === 'OF') || /^OF-\d{4}-\d{3,6}$/i.test(eid);

          if (!isOfLike) return a;
          if (canon(t0) === 'OF' && t0 === 'OF') return a; // già canonico e già "OF" puro

          if (norm(a.entityType) === 'OF') return a; // già ok

          changed++;
          return {
            ...a,
            entityTypeOriginal: (a.entityTypeOriginal ?? a.entityType),
            entityType: 'OF',
            updatedAt: now
          };
        });

        if (changed > 0) {
          _lsSet('allegatiRows', next);
          window.__anima_dirty = true;
          console.log('[allegati] migrazione entityType→OF applicata:', changed);
        } else {
          console.log('[allegati] migrazione entityType→OF: niente da fare');
        }

        _lsSet(FLAG, true);
        return { updated: changed };
      }catch(e){
        console.warn('migrateAllegatiEntityTypeOF', e);
        return { error:true, message: (e && e.message) ? e.message : String(e) };
      }
    };

    // Auto-run (sicuro: cambia solo se OF-like)
    try{ window.migrateAllegatiEntityTypeOF(); }catch{}
  })();


  // === Allegati: store helpers (merge-safe + soft-delete) ===
  (function(){
    if (window.__ANIMA_ALLEGATI_STORE_HELPERS_V1__) return;
    window.__ANIMA_ALLEGATI_STORE_HELPERS_V1__ = true;

    const getAll = () => {
      try {
        const v = (typeof window.lsGet === 'function') ? window.lsGet('allegatiRows', []) : [];
        return Array.isArray(v) ? v : [];
      } catch { return []; }
    };

    const setAll = (arr) => {
      try {
        if (typeof window.lsSet === 'function') window.lsSet('allegatiRows', arr);
        else if (typeof lsSet === 'function') lsSet('allegatiRows', arr);
      } catch {}
    };

    const mergeLocal = (cur, inc) => {
      const m = new Map();
      const push = (r) => { if (r && r.id != null) m.set(String(r.id), r); };
      (Array.isArray(cur)?cur:[]).forEach(push);
      (Array.isArray(inc)?inc:[]).forEach(push);
      return Array.from(m.values());
    };

    window.allegatiUpsertRows = window.allegatiUpsertRows || function(rows){
      const incoming = Array.isArray(rows) ? rows : [];
      const cur = getAll();

      const merged = (typeof window.mergeById === 'function')
        ? window.mergeById(cur, incoming)
        : mergeLocal(cur, incoming);

      setAll(merged);
      return merged;
    };

    window.allegatiUpsertOne = window.allegatiUpsertOne || function(row){
      if (!row || row.id == null) return null;
      window.allegatiUpsertRows([row]);
      return row;
    };

    window.allegatiSoftDelete = window.allegatiSoftDelete || function(id){
      if (!id) return;
      const cur = getAll();
      const now = new Date().toISOString();
      const next = cur.map(r => {
        if (!r || String(r.id||'') !== String(id)) return r;
        return { ...r, deletedAt: r.deletedAt || now, updatedAt: now };
      });
      setAll(next);
      return true;
    };
  })();

  window.persistListFactory = window.persistListFactory || function(key, setState){
    return function persist(next){
      try { localStorage.setItem(key, JSON.stringify(next)); } catch {}
      try { if (typeof setState === 'function') setState(next); } catch {}
      window.__anima_dirty = true;
      try { if (typeof window.requestAppRerender === 'function') window.requestAppRerender(); } catch {}
    };
  };

  // Contatori progressivi (per ID tipo O-2025-001)
  window.formatNNN = window.formatNNN || (n => String(n).padStart(3, '0'));

  // === nextIdUnique: calcola il prossimo ID scansionando lo storage (max+1) ===
  window.nextIdUnique = window.nextIdUnique || function (kind, series, storageKey) {
  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } });
  const rows = Array.isArray(lsGet(storageKey, [])) ? lsGet(storageKey, []) : [];
  const year = new Date().getFullYear();
  const re = new RegExp(`^${series}-${year}-([0-9]{3})$`, 'i');
  let max = 0;

  const next = max + 1;
  const pad = (window.formatNNN ? window.formatNNN(next) : String(next).padStart(3,'0'));
  return { id: `${series}-${year}-${pad}`, year, num: next };
};

  // === Progressivi unificati (solo {year,num}) ===
 window.nextProgressivo = window.nextProgressivo || function (series) {
  const year = new Date().getFullYear();
  let counters = {};
  try { counters = JSON.parse(localStorage.getItem('counters') || '{}') || {}; } catch {}
  const prev = counters[series];
  const next = (prev && prev.year === year && Number.isFinite(prev.num)) ? (prev.num + 1) : 1;
  counters[series] = { year, num: next };
  try { localStorage.setItem('counters', JSON.stringify(counters)); } catch {}
  return { year, num: next };
};

// === Progressivo commesse robusto (idempotente) ===
// Scansiona le commesse esistenti dell'anno corrente e genera il prossimo ID
window.nextCommessaId = window.nextCommessaId || function nextCommessaId(){
  const year = new Date().getFullYear();
  const fmt = (window.formatNNN || (n => String(n).padStart(3,'0')));
  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? d; }catch{ return d; } });

  const rows = lsGet('commesseRows', []);
  let max = 0;
  if (Array.isArray(rows)) {
    for (const c of rows) {
      const m = String(c && c.id || '').match(/^C-(\d{4})-(\d{3})$/i);
      if (m && +m[1] === year) {
        const n = +m[2];
        if (n > max) max = n;
      }
    }
  }

  // sincronizza anche il vecchio "counters.C" se presente
  try {
    const counters = JSON.parse(localStorage.getItem('counters')||'{}') || {};
    const c = counters['C'];
    if (c && c.year === year && Number.isFinite(c.num)) {
      if (c.num > max) max = c.num;
    }
    counters['C'] = { year, num: max + 1 };
    localStorage.setItem('counters', JSON.stringify(counters));
  } catch {}

  return `C-${year}-${fmt(max + 1)}`;
};

// === PATCH E1: print HTML sicuro (usato da etichette colli) ===
window.safePrintHTMLString = window.safePrintHTMLString || function(html){
  try{
    const w = window.open('', '_blank', 'noopener,noreferrer');
    if(!w){ alert('Popup bloccato: abilita le finestre per la stampa.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
    const doPrint = ()=> { try{ w.focus(); w.print(); w.close(); }catch{} };
    if (w.document.readyState === 'complete') doPrint();
    else w.addEventListener('load', doPrint);
  }catch(e){ console.warn('safePrintHTMLString', e); }
};

// ================== PREVENTIVI: STAMPA (Layout Fix: Logo Grande, Margini Sicuri, No Sovrapposizioni) ==================
(function(){
  // Helper locali
  const esc = s => String(s ?? '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtDate = d => {
    if (!d) return '';
    const date = new Date(d);
    return isNaN(date.getTime()) ? d : date.toLocaleDateString('it-IT');
  };

  // 1. Generatore HTML
  window.generatePreventivoHTML = function(pv){
    // Recupero Dati
    const app = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })();
    const clienti = (function(){ try{ return JSON.parse(localStorage.getItem('clientiRows')||'[]')||[]; }catch{return[]} })();
    
    // Dati Azienda
    const logoUrl = app.logoDataUrl || '';
    const ragAzi  = esc(app.ragioneSociale || 'ANIMA SRL');
    const pivaAzi = esc(app.piva || '');
    const sedeLeg = esc(app.sedeLegale || '');
    const sedeOp  = esc(app.sedeOperativa || '');
    const emailAzi= esc(app.email || '');
    const telAzi  = esc(app.telefono || '');

    // Dati Cliente
    const cli = clienti.find(c=> String(c.id)===String(pv?.clienteId||'')) || {};
    const cliRag  = esc(pv?.cliente || pv?.clienteRagione || cli.ragioneSociale || cli.ragione || '');
    const cliInd  = esc(cli.sedeLegale || cli.sedeOperativa || cli.indirizzo || '');
    const cliPiva = esc(cli.piva || '');

    // Dati Documento
    const docId   = esc(pv?.id || 'BOZZA');
    const docData = fmtDate(pv?.data || new Date().toISOString());
    const oggetto = esc(pv?.oggetto || pv?.descrizione || '');
    const validita= '30 giorni data presente'; 

    // Righe
    const righe = Array.isArray(pv?.righe) ? pv.righe : (Array.isArray(pv?.righeArticolo) ? pv.righeArticolo : []);
    const DEFAULT_IVA = Number(app.defaultIva) || 22;

    // Calcoli
    let imponibile = 0;
    let totIva = 0;
    const ivaMap = {};

    const rowsData = righe.map((r, i) => {
      const qty = Number(r.qta||r.qty||1)||0;
      const pr  = Number(r.prezzo||r.price||0)||0;
      const sc  = Number(r.sconto||r.scontoPerc||0)||0;
      const iva = (r.iva !== undefined && r.iva !== '') ? Number(r.iva) : DEFAULT_IVA;
      
      const rowBase = qty * pr * (1 - (sc/100));
      const rowIva  = rowBase * (iva/100);
      
      imponibile += rowBase;
      totIva     += rowIva;
      ivaMap[iva] = (ivaMap[iva] || 0) + rowBase;

      return {
        idx: i+1,
        codice: esc(r.codice||''),
        descrizione: esc(r.descrizione||r.desc||'').replace(/\n/g, '<br>'),
        um: esc((r.UM||r.um||'PZ').toUpperCase()),
        qta: qty,
        prezzo: pr,
        sconto: sc,
        totale: rowBase,
        note: esc(r.note||'')
      };
    });

    const totaleDoc = imponibile + totIva;

    // Template HTML parti comuni
    const headerHTML = `
      <div class="header">
        <div class="brand">
          ${logoUrl ? `<img src="${logoUrl}" class="logo" />` : ''}
          <div class="az-info">
            <div class="rs">${ragAzi}</div>
            <div class="muted">${sedeLeg}</div>
            ${sedeOp && sedeOp!==sedeLeg ? `<div class="muted">${sedeOp}</div>` : ''}
            <div class="muted">P.IVA: ${pivaAzi} ${emailAzi ? '· '+emailAzi : ''}</div>
          </div>
        </div>
        <div class="doc-box">
          <div class="title">PREVENTIVO</div>
          <div class="num">${docId}</div>
          <div class="date">Data: ${docData}</div>
        </div>
      </div>`;

    const metaHTML = `
      <div class="meta-grid">
        <div class="box">
          <div class="lbl">Spett.le Cliente</div>
          <div class="val">${cliRag}</div>
          ${cliInd ? `<div class="muted small">${cliInd}</div>` : ''}
          ${cliPiva ? `<div class="muted small">P.IVA: ${cliPiva}</div>` : ''}
        </div>
        <div class="box">
          <div class="lbl">Dettagli offerta</div>
          ${oggetto ? `<div><b>Oggetto:</b> ${oggetto}</div>` : ''}
          <div><b>Pagamento:</b> ${esc(pv?.pagamento || app.defaultPagamento || 'Rimessa diretta')}</div>
          <div><b>Validità:</b> ${validita}</div>
        </div>
      </div>`;

    const noteHTML = (pv.note && pv.note.trim()) 
      ? `<div class="box-note"><strong>Note:</strong> ${esc(pv.note).replace(/\n/g,'<br>')}</div>` 
      : '';

    const theadHTML = `
      <thead>
        <tr>
          <th class="ctr" style="width:30px">#</th>
          <th style="width:110px">Codice</th>
          <th>Descrizione</th>
          <th class="ctr" style="width:40px">UM</th>
          <th class="ctr" style="width:60px">Q.tà</th>
          <th class="num" style="width:90px">Prezzo</th>
          <th class="ctr" style="width:50px">Sc.%</th>
          <th class="num" style="width:100px">Totale</th>
        </tr>
      </thead>`;

    const ivaRows = Object.keys(ivaMap).sort((a,b)=>Number(a)-Number(b)).map(k => {
      const b = ivaMap[k];
      const i = b * (Number(k)/100);
      return `<tr>
        <td class="ctr">${k}%</td>
        <td class="num">${fmt2(b)}</td>
        <td class="num">${fmt2(i)}</td>
      </tr>`;
    }).join('');

    const footerSummaryHTML = `
      <div class="footer-summary">
        <div class="box iva-box">
          <div class="lbl">Riepilogo IVA</div>
          <table class="iva-table">
            <thead><tr><th>Aliq.</th><th class="num">Imp.</th><th class="num">IVA</th></tr></thead>
            <tbody>${ivaRows}</tbody>
          </table>
        </div>
        <div class="box tot-box">
          <div class="row"><div>Totale Netto:</div> <div>${fmt2(imponibile)}</div></div>
          <div class="row"><div>Totale IVA:</div> <div>${fmt2(totIva)}</div></div>
          <div class="row grand-total"><div>TOTALE PREVENTIVO:</div> <div>€ ${fmt2(totaleDoc)}</div></div>
        </div>
      </div>`;

    const footerSignHTML = `
      <div class="footer-sign">
        <div class="sign-box">
          <div class="lbl">Per accettazione (Timbro e Firma)</div>
          <div class="line"></div>
          <div class="small muted center">Luogo e Data: __________________________</div>
        </div>
      </div>`;

    // --- Paginazione Sicura ---
    // Riduco a 8 righe per pagina per garantire spazio ai totali senza sovrapposizioni
    const MAX_ROWS = 8; 
    const pages = [];
    
    if (rowsData.length === 0) {
      pages.push([ { idx:'', codice:'', descrizione:'Nessuna riga inserita', um:'', qta:'', prezzo:'', totale:'' } ]);
    } else {
      for (let i = 0; i < rowsData.length; i += MAX_ROWS) {
        pages.push(rowsData.slice(i, i + MAX_ROWS));
      }
    }

    let htmlPages = '';
    
    pages.forEach((pRows, pageIdx) => {
      const isFirst = (pageIdx === 0);
      const isLast  = (pageIdx === pages.length - 1);
      
      const tbodyHTML = pRows.map(r => `
        <tr>
          <td class="ctr">${r.idx || ''}</td>
          <td class="code">${r.codice || ''}</td>
          <td>
            ${r.descrizione}
            ${r.note ? `<div class="small muted"><i>${r.note}</i></div>` : ''}
          </td>
          <td class="ctr">${r.um || ''}</td>
          <td class="ctr">${r.qta || ''}</td>
          <td class="num">${r.prezzo ? fmt2(r.prezzo) : ''}</td>
          <td class="ctr">${r.sconto ? fmt2(r.sconto) : ''}</td>
          <td class="num">${r.totale ? fmt2(r.totale) : ''}</td>
        </tr>
      `).join('');

      htmlPages += `
        <div class="page">
          <div class="content-wrap">
            ${headerHTML}
            ${metaHTML}
            ${isFirst ? noteHTML : ''}
            
            <table class="main-table">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
            
            <div class="spacer"></div>
            ${footerSummaryHTML}
            ${isLast ? footerSignHTML : ''}
          </div>
          <div class="page-num">Pag. ${pageIdx + 1} / ${pages.length}</div>
        </div>`;
    });

    const css = `
      <style>
        @page { size: A4; margin: 0; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; font-size: 10pt; color: #111; background: #fff; }
        
        /* Layout Pagina */
        .page {
          width: 210mm; height: 297mm;
          position: relative;
          page-break-after: always;
          /* Padding fondo 30mm: spazio sicuro per evitare sovrapposizioni */
          padding: 10mm 10mm 30mm 10mm; 
          display: flex; flex-direction: column; 
          overflow: hidden;
        }
        .page:last-child { page-break-after: auto; }
        
        .content-wrap { flex: 1; display: flex; flex-direction: column; }
        .spacer { flex: 1; } 

        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #111; padding-bottom: 8px; margin-bottom: 12px; }
        .brand { display: flex; gap: 15px; align-items: center; }
        
        /* Logo Grande 80px */
        .logo { height: 80px; max-width: 220px; object-fit: contain; }
        
        .az-info { font-size: 9pt; line-height: 1.3; }
        .rs { font-size: 14pt; font-weight: 800; text-transform: uppercase; }
        .muted { color: #555; }
        
        .doc-box { text-align: right; }
        .doc-box .title { font-size: 18pt; font-weight: 800; color: #111; }
        .doc-box .num { font-size: 12pt; font-weight: bold; margin-top: 4px; }

        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .box { border: 1px solid #ccc; border-radius: 6px; padding: 6px 8px; font-size: 9.5pt; }
        .lbl { font-weight: 700; text-transform: uppercase; font-size: 8pt; color: #666; margin-bottom: 4px; }
        .val { font-weight: 700; font-size: 11pt; margin-bottom: 2px; }

        .box-note { margin-bottom: 10px; border: 1px dashed #ccc; border-radius: 6px; padding: 8px; font-size: 9pt; background: #fdfdfd; }

        table.main-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        table.main-table th { background: #eee; font-weight: 700; text-align: left; padding: 6px; border: 1px solid #ccc; font-size: 9pt; }
        table.main-table td { border: 1px solid #ccc; padding: 6px; vertical-align: top; font-size: 10pt; }
        .ctr { text-align: center; }
        .num { text-align: right; }
        .code { font-family: monospace; font-weight: 600; font-size: 9.5pt; }
        .small { font-size: 8pt; }
        .center { text-align: center; }

        .footer-summary { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-top: 10px; break-inside: avoid; page-break-inside: avoid; }
        .iva-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
        .iva-table th, .iva-table td { padding: 4px; font-size: 9pt; border: 1px solid #eee; }
        .iva-table th { background: #f9f9f9; text-align: left; }
        
        .tot-box { display: flex; flex-direction: column; justify-content: center; }
        .tot-box .row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10pt; }
        .grand-total { border-top: 2px solid #111; margin-top: 6px; padding-top: 6px; font-weight: 800; font-size: 13pt; }

        .footer-sign { margin-top: 12px; break-inside: avoid; page-break-inside: avoid; }
        .sign-box { border: 1px solid #ccc; border-radius: 6px; padding: 10px; height: 35mm; position: relative; }
        .sign-box .line { position: absolute; bottom: 10mm; left: 10%; width: 80%; border-bottom: 1px solid #000; }
        .sign-box .center { position: absolute; bottom: 4mm; width: 100%; text-align: center; }
        
        /* Numerazione Pagina molto bassa */
        .page-num { position: absolute; bottom: 8mm; right: 10mm; font-size: 9pt; color: #888; font-weight: bold; }
      </style>`;

    return `<!DOCTYPE html><html><head><meta charset="utf-8">${css}</head><body>${htmlPages}</body></html>`;
  };

  // 2. Funzione di stampa (RIPRISTINATA)
  window.printPreventivo = function(pv){
    try {
      if (!pv || !pv.id) { alert('Preventivo non valido'); return; }
      
      const html = window.generatePreventivoHTML(pv);
      
      // Usa il sistema di stampa sicuro
      if (window.safePrintHTMLStringWithPageNum) {
        window.safePrintHTMLStringWithPageNum(html);
      } else if (window.safePrintHTMLString) {
        window.safePrintHTMLString(html);
      } else {
        // Fallback estremo
        const w = window.open('', '_blank');
        if (w) {
          w.document.write(html);
          w.document.close();
          setTimeout(() => { w.focus(); w.print(); }, 500);
        }
      }
    } catch(e) {
      console.warn('printPreventivo error', e);
      alert('Errore nella stampa del preventivo.');
    }
  };
})();

// ================== PREVENTIVI → COMMESSA (globale) ==================
window.transformPreventivoToCommessa = window.transformPreventivoToCommessa || function(pv){
  if (!pv) return null;

  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? d; }catch{ return d; }});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; }catch{} });

  const commesse = Array.isArray(lsGet('commesseRows', [])) ? lsGet('commesseRows', []) : [];

    // Evita doppioni se lo stesso preventivo è già stato trasformato
  const already = commesse.find(c => String(c.__fromPreventivoId||'') === String(pv.id||''));
  if (already){
    alert('Questo preventivo è già stato trasformato in commessa: ' + already.id);
    return already;
  }

  const genId = (typeof window.nextCommessaId === 'function')
    ? window.nextCommessaId()
    : `C-${new Date().getFullYear()}-001`;

  const newId = (typeof window.ensureUniqueCommessaId === 'function')
    ? window.ensureUniqueCommessaId(genId)
    : genId;

  const righePV =
    Array.isArray(pv.righe) ? pv.righe :
    Array.isArray(pv.righeArticolo) ? pv.righeArticolo :
    [];

    const righeArticolo = righePV
    .filter(r => (r.codice||r.descrizione||'').toString().trim())
    .map(r => {
      const rawQta = (r.qta ?? r.qty ?? r.quantita);
      let qta = Number(rawQta);

      // rispetta 0 esplicito (righe nota/esenti)
      if (rawQta === 0 || rawQta === '0') qta = 0;
      // vuoto/null -> default 1
      else if (rawQta == null || rawQta === '') qta = 1;
      // non numerico -> default 1
      else if (!Number.isFinite(qta)) qta = 1;

      if (qta < 0) qta = 0;

      return ({
        codice: String(r.codice||'').trim(),
        descrizione: String(r.descrizione||r.desc||'').trim(),
        um: String(r.UM||r.um||'PZ').toUpperCase(),
        qta,
        note: String(r.note||'')
      });
    });

  const qtaSum = righeArticolo.reduce((s,r)=> s + (Number(r.qta)||0), 0);

  const commBase = {
    id: newId,
    clienteId: pv.clienteId || '',
    cliente: pv.cliente || pv.clienteRagione || '',
    descrizione: pv.oggetto || pv.descrizione || '',
        // legacy compat: primo articolo come riepilogo
    articoloCodice: (righeArticolo[0]?.codice) || pv.articoloCodice || '',
    articoloUM: (righeArticolo[0]?.um) || pv.articoloUM || '',
    qtaPezzi: Math.max(1, qtaSum || Number(pv.qtaPezzi||1)||1),
    orePerPezzoHHMM: '0:00',
    oreTotaliPrev: 0,
    scadenza: pv.scadenza || pv.consegnaPrevista || '',
    priorita: 'MEDIA',
    istruzioni: pv.note || '',
    materiali: [],
    fasi: [],
    righeArticolo,
    qtaProdotta: 0,
    rifCliente: pv.rifCliente || { tipo:'ordine', numero:'', data:'' },
    luogoConsegna: pv.luogoConsegna || '',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    __fromPreventivoId: pv.id
  };

  const comm = (typeof window.ensureCommessaRowIds === 'function')
    ? window.ensureCommessaRowIds(commBase)
    : commBase;

  commesse.unshift(comm);
  lsSet('commesseRows', commesse);

  return comm;
};

// === PATCH E4: navigateTo & scanQR (usati in Timbratura/Impostazioni) ===
window.navigateTo = window.navigateTo || function(label){
  const map = {
    'Impostazioni':'#/impostazioni','DDT':'#/ddt','Fatture':'#/fatture','Magazzino':'#/magazzino',
    'Ore':'#/ore','Commesse':'#/commesse','Report':'#/report','Report tempi':'#/report-tempi',
    'Saturazione reparti':'#/saturazione',
    'Report materiali':'#/report-materiali','OrdiniFornitori':'#/ordini','Dashboard':'#/dashboard',
    'TIMBRATURA':'#/timbratura','Timbratura':'#/timbratura'
  };

  const target = map[label] || '#/dashboard';

  const u = window.__USER || null;
  const rawRole = (u && u.role) ? String(u.role).toLowerCase() : '';

  const isAdmin      = (rawRole === 'admin');
  const isAccountant = (rawRole === 'accountant');
  const isViewerLike = (rawRole === 'viewer' || rawRole === 'mobile');
  const isWorker     = (rawRole === 'worker');

  if (!isAdmin) {
    let allowed;

    // Viewer / mobile: pura consultazione
    allowed = null;
    if (isViewerLike) {
      allowed = new Set([
        '#/timbratura',
        '#/commesse',
        '#/ddt',
        '#/dashboard',
        '#/report',
        '#/report-tempi',
        '#/saturazione',
        '#/report-materiali',
        '#/login'
      ]);
    } else if (isAccountant) {
      // Accountant: documenti + report, NO impostazioni
      allowed = new Set([
        '#/dashboard',
        '#/commesse',
        '#/ddt',
        '#/fatture',
        '#/magazzino',
        '#/ore',
        '#/ordini',
        '#/report',
        '#/report-tempi',
        '#/saturazione',
        '#/report-materiali',
        '#/timbratura',
        '#/login'
      ]);
    } else if (isWorker) {
      // Worker: solo timbratura + commesse + ddt
      allowed = new Set([
        '#/timbratura',
        '#/commesse',
        '#/ddt',
        '#/login'
      ]);
    } else {
      // Altri ruoli non-admin (se mai esistono): come accountant ma senza impostazioni
      allowed = new Set([
        '#/dashboard',
        '#/commesse',
        '#/ddt',
        '#/fatture',
        '#/magazzino',
        '#/ore',
        '#/ordini',
        '#/report',
        '#/report-tempi',
        '#/saturazione',
        '#/report-materiali',
        '#/timbratura',
        '#/login'
      ]);
    }

    if (!allowed.has(target)) {
      location.hash = '#/timbratura';
      return;
    }
  }

  location.hash = target;
};

// === PATCH E5: salvataggi sicuri per Magazzino (saveKey/safeSetJSON) ===
window.safeSetJSON = window.safeSetJSON || function(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
window.saveKey = window.saveKey || function(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

// === PATCH E6: Supabase helpers (getSB/sbInsert) compatibili e env-aware ===
window.getSB = window.getSB || function(){
  try{
    const a = JSON.parse(localStorage.getItem('appSettings')||'{}')||{};
    const env = String(a.cloudEnv || a.supabaseEnv || '').toLowerCase();

    const url = (env === 'beta')
      ? (a.supabaseUrlBeta || a.supabaseUrl || '')
      : (a.supabaseUrl || '');

    const key = (env === 'beta')
      ? (a.supabaseKeyBeta || a.supabaseKey || '')
      : (a.supabaseKey || '');

    const table = (env === 'beta')
      ? (a.supabaseTableBeta || a.supabaseTable || a.syncTable || 'anima_sync')
      : (a.supabaseTable || a.syncTable || 'anima_sync');

    if (!(a.cloudEnabled && url && key)) return null;

    return {
      url: String(url).replace(/\/+$/,''),
      key: String(key).trim(),
      table: String(table || 'anima_sync')
    };
  }catch{ return null; }
};
// Patch I — Alias robusto per ReportView
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  if (typeof window.ReportView !== 'function') {
    window.ReportView = window.ReportProdView || window.ReportMaterialiView || function(){
      return React.createElement('div', {className:'page'}, 'Report materiali — vista non ancora implementata');
    };
  }
  // opzionale: rendi openReport coerente con la tua route preferita
  window.openReport = window.openReport || function () {
    if (typeof window.setTab === 'function') window.setTab('REPORT_MAT');
    if (location.hash !== '#/report-materiali') location.hash = '#/report-materiali';
  };
})();
window.sbInsert = window.sbInsert || async function(table, row){
  const sb = window.getSB && window.getSB(); if(!sb) return;
  const url = `${sb.url}/rest/v1/${encodeURIComponent(table)}`;
  const res = await fetch(url, {
    method:'POST',
    headers:{ apikey:sb.key, Authorization:`Bearer ${sb.key}`, 'Content-Type':'application/json', Prefer:'return=minimal' },
    body: JSON.stringify(row)
  });
  if(!res.ok){ console.warn('[sbInsert]', table, await res.text()); }
};

// ---- AppSettings defaults (cloud OFF se non presente) ----
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  try {
    const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    if (typeof s.cloudEnabled === 'undefined') s.cloudEnabled = false;
    if (!('supabaseTable' in s)) s.supabaseTable = 'anima_sync';
    localStorage.setItem('appSettings', JSON.stringify(s));
  } catch {}
})();


/* === PATCH 3: seed Order Parsers & Process Templates (idempotente) === */
(function seedParsersAndTemplates(){
  if (window.__PATCH3_SEEDED__) return; 
  window.__PATCH3_SEEDED__ = true;

  // Registro runtime (funzioni vive, non serializzate)
  window.__orderParsers = window.__orderParsers || [];
  window.registerOrderParser = window.registerOrderParser || function(def){
    try{
      if (!def || !def.id) return;
      const id = String(def.id).toLowerCase();
      if (!window.__orderParsers.some(p => String(p.id).toLowerCase() === id)) {
        window.__orderParsers.push(def);
       console.log('[registerOrderParser] attivato', def.id);
      }
    }catch(e){ console.warn('registerOrderParser fail', e); }
  };

  // Fallback: definisci addOrderParser / addProcessTemplate se mancanti
  if (typeof window.addOrderParser !== 'function') {
    window.addOrderParser = function(def){
    try{
      // 1) registra subito in runtime (funzioni vive)
      if (typeof window.registerOrderParser === 'function') {
        window.registerOrderParser(def);
      }

      // 2) salva SOLO metadati in appSettings (non funzioni)
      const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
      const metaArr = Array.isArray(s.orderParsersMeta) ? s.orderParsersMeta : [];
     const id  = String(def?.id||'').toLowerCase();
      if (!id) return;
      if (!metaArr.some(p => String(p.id||'').toLowerCase() === id)) {
        metaArr.push({ id: def.id, name: def.name || def.id, addedAt: new Date().toISOString() });
        s.orderParsersMeta = metaArr;
        localStorage.setItem('appSettings', JSON.stringify(s));
        console.log('[addOrderParser] metadati salvati', def.id);
      }
    }catch(e){ console.warn('addOrderParser fail', e); }
  };
  }
  if (typeof window.addProcessTemplate !== 'function') {
    window.addProcessTemplate = function(def){
      try{
        const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
        const arr = Array.isArray(s.processTemplates) ? s.processTemplates : [];
        const id  = String(def?.id||'').toLowerCase();
        if (!id) return;
        if (!arr.some(p => String(p.id||'').toLowerCase() === id)) {
          arr.push(def);
          s.processTemplates = arr;
          localStorage.setItem('appSettings', JSON.stringify(s));
          console.log('[addProcessTemplate] aggiunto', def.id);
        }
      }catch(e){ console.warn('addProcessTemplate fail', e); }
    };
  }

  // === ESEMPI SEED (salta se già presenti) ===
  // Brembo v1
  addOrderParser({
    id  : 'brembo-v1',
    name: 'Brembo (righe tabellari)',
    test: txt => /BREMBO/i.test(txt) && /(ORDINE|PO)\s*[:#]/i.test(txt),
    extract: txt => {
      const cliente = 'BREMBO';
      // righe: CODICE - DESCR - QTA [UM]
      const righe = [];
      const re = /([A-Z0-9][A-Z0-9._\-]{2,})\s+-\s+(.{6,80}?)\s+([0-9]+(?:[.,][0-9]+)?)\s*([A-Z]{1,3})?\b/g;
      let m; while ((m = re.exec(txt))){
        righe.push({ codice:m[1], descrizione:m[2].trim(), qta:Number(String(m[3]).replace(',','.'))||0, um:(m[4]||'PZ') });
      } 
      const descr = (txt.match(/Oggetto\s*[:\-]\s*(.+)/i)||[])[1] || 'Commessa da ordine PDF';
      const consegna = (txt.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/)||[])[1] || '';
      return { cliente, descrizione: descr.trim(), righe, qtaPezzi: righe.reduce((s,r)=>s+(r.qta||0),0) || 1, consegna };
    }
  });

  // Caterpillar v1
  addOrderParser({
    id  : 'caterpillar-v1',
    name: 'Caterpillar (scheda righe)',
    test: txt => /CATERPILLAR/i.test(txt) && /PURCHASE\s+ORDER/i.test(txt),
    extract: txt => {
      const cliente = 'CATERPILLAR';
      const righe = [];
      const re = /Item\s*[:#]?\s*([A-Z0-9._\-]{3,})\s+Desc\s*[:\-]\s*(.{6,80}?)\s+Qty\s*[:\-]\s*([0-9]+(?:[.,][0-9]+)?)/gi;
      let m; while ((m = re.exec(txt))){
        righe.push({ codice:m[1], descrizione:m[2].trim(), qta:Number(String(m[3]).replace(',','.'))||0, um:'PZ' });
      }
      const descr = (txt.match(/(?:Fornitura|Description)\s*[:\-]\s*(.+)/i)||[])[1] || 'Commessa da ordine PDF';
      const consegna = (txt.match(/(Delivery|Consegna)\s*[:\-]\s*([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})/i)||[])[2] || '';
      return { cliente, descrizione: descr.trim(), righe, qtaPezzi: righe.reduce((s,r)=>s+(r.qta||0),0) || 1, consegna };
    }
  });

  // Vimek v1
  addOrderParser({
    id  : 'vimek-v1',
    name: 'Vimek (distinta semplice)',
    test: txt => /VIMEK/i.test(txt) && /(ORDINE|COMMESSA)\s*[:#]/i.test(txt),
    extract: txt => {
      const cliente = 'VIMEK BAKERY AUTOMATION SRL';
      const righe = [];
      const re = /([A-Z0-9._\-]{3,})\s+[–-]\s+(.{6,80}?)\s+(?:QTA|Q\.T\.)\s*[:\-]?\s*([0-9]+(?:[.,][0-9]+)?)/gi;
      let m; while ((m = re.exec(txt))){
        righe.push({ codice:m[1], descrizione:m[2].trim(), qta:Number(String(m[3]).replace(',','.'))||0, um:'PZ' });
      }
      const descr = (txt.match(/Oggetto\s*[:\-]\s*(.+)/i)||[])[1] || 'Commessa da ordine PDF';
      const consegna = (txt.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/)||[])[1] || '';
      return { cliente, descrizione: descr.trim(), righe, qtaPezzi: righe.reduce((s,r)=>s+(r.qta||0),0) || 1, consegna };
    }
  });
  try{
    // Parser “generico IT” (puoi tenerlo come fallback)
    addOrderParser({
      id  : 'ordine-generico-IT',
      name: 'Generico IT (numero e data)',
      test: txt => /ordine\s*(n\.|nr|numero)?/i.test(txt) && /\b\d{1,2}[./-]\d{1,2}[./-]\d{2,4}\b/.test(txt),
      extract: txt => ({
        cliente    : (txt.match(/(?:Cliente|Rag\.?\s*Sociale|Destinatario)\s*[:\-]?\s*(.+)/i)||[])[1]?.trim() || '',
        ordineId   : (txt.match(/Ordine\s*(?:n\.|nr|numero)?\s*[:\-]?\s*([A-Z0-9._\/\-]+)/i)||[])[1]?.trim() || '',
        consegna   : (txt.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/)||[])[1] || '',
        descrizione: (txt.match(/Oggetto\s*[:\-]\s*(.+)/i)||txt.match(/Descrizione\s*[:\-]\s*(.+)/i)||[])[1]?.trim() || '',
        qtaPezzi   : 1
      })
    });

    // Parser BLAUWER — Ord. acq. Standard
    addOrderParser({
      id  : 'blauwer-v1',
      name: 'BLAUWER Ord. acq. Standard',
      test: (txt, name='') => {
        const t = String(txt || '');
        return /BLAUWER\s*S\.?P\.?A\.?/i.test(t) && /Ord\.\s*acq\.\s*Standard/i.test(t);
      },
      extract: (txt, name='') => {
        const raw   = String(txt || '');
        const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

        const righe = [];
        let inBody = false;

        for (const line of lines) {
          const norm = line.replace(/\s+/g,' ').trim();

          // header tabella: "Pos. Codice Rev. Descrizione UM Q.tà Prezzo Unitario Sconti Prezzo Totale Consegna"
          if (!inBody) {
            if (/Pos\./i.test(norm) && /Codice/i.test(norm) && /Descrizione/i.test(norm) && /\bUM\b/i.test(norm)) {
              inBody = true;
            }
            continue;
          }

          if (!norm) continue;
          if (/^TOTALE\s+ORDINE/i.test(norm)) break;

          // es: "10 58038050 01 COPERCHIO SERBATOIO ... PZ 3 120,00 360,00 27/11/25"
          const m = norm.match(
            /^(\d+)\s+([A-Z0-9][A-Z0-9._\-]{2,})\s+[A-Z0-9]{1,3}\s+(.+?)\s+(PZ|NR|KG|L1|L2|L3|M|MQ|ML)\s+([0-9]+(?:[.,][0-9]+)?)(?:\s+[0-9.,]+){1,3}\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})$/i
          );
          if (!m) continue;

          const codice = m[2];
          const descr  = m[3];
          const um     = m[4].toUpperCase();
          const qta    = Number(
            String(m[5]).replace(/\./g,'').replace(',', '.')
          ) || 0;

          if (!codice || !descr || !qta) continue;

          righe.push({
            codice,
            descrizione: descr.trim(),
            um,
            qta
          });
        }

        // descrizione commessa
        let descr = '';
        const mHead =
          raw.match(/Ord\.\s*acq\.\s*Standard[\s\S]*?Numero\s+([A-Z0-9\-\/]+)\s+Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i) ||
          raw.match(/Numero\s+([A-Z0-9\-\/]+)\s+Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i);

        if (mHead) {
          const num = (mHead[1] || '').trim();
          const d   = (mHead[2] || '').trim();
          descr = `Ordine ${num} del ${d}`;
        } else if (righe.length === 1) {
          descr = righe[0].descrizione;
        } else if (righe.length > 1) {
          descr = `Ordine Blauwer (${righe.length} righe)`;
        } else {
          descr = 'Commessa da ordine PDF';
        }

        // scadenza = massima data trovata (tipicamente le consegne)
        let scad = '';
        try{
          const dates = raw.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/g) || [];
          const times = dates
            .map(d => {
              const [gg,mm,aa] = d.split(/[./-]/);
              const iso = `${aa.length === 2 ? '20'+aa : aa}-${mm.padStart(2,'0')}-${gg.padStart(2,'0')}`;
              return new Date(iso).getTime();
            })
            .filter(n => Number.isFinite(n));
          if (times.length) {
            const max = Math.max.apply(null, times);
            scad = new Date(max).toISOString().slice(0,10);
          }
        }catch(e){}

        return {
          cliente    : 'BLAUWER S.P.A.',
          descrizione: descr,
          righe,
          qtaPezzi   : righe.reduce((s,r)=> s + (Number(r.qta)||0), 0) || 1,
          scadenza   : scad
        };
      }
    });

    // Template di processo “Tramoggia” (adatta i regex e i tempi al tuo standard)
    addProcessTemplate({
      id  : 'tramoggia-standard',
      name: 'Tramoggia — ciclo standard',
      match: { any:[/TRAMOGG/i, /TRG-\d+/i, /TRAM\w*/i] },
      fasi: [
        { lav:'Taglio',        oreHHMM:'0:15' },
        { lav:'Puntatura',     oreHHMM:'0:20' },
        { lav:'Saldatura',     oreHHMM:'0:45' },
        { lav:'Pulizia',       oreHHMM:'0:10' },
        { lav:'Collaudo',      oreHHMM:'0:15', unaTantum:true }
      ]
    });
  }catch(e){
    console.warn('Seed parsers/templates skipped:', e);
  }
})();

/* === PATCH BLAUWER v1: parser ordini acquisto === */
(function registerBlauwerRuntime(){
  try{
    if (typeof window.addOrderParser !== 'function') return;

    // rimuovo eventuali versioni precedenti del parser
    if (Array.isArray(window.__orderParsers)) {
      window.__orderParsers = window.__orderParsers.filter(function(p){
        return !p || String(p.id || '').toLowerCase() !== 'blauwer-v1';
      });
    } else {
      window.__orderParsers = [];
    }

    function toNum(s){
      if (s == null) return 0;
      var t = String(s).replace(/\./g,'').replace(',', '.');
      var n = Number(t);
      return isFinite(n) ? n : 0;
    }

    window.addOrderParser({
      id  : 'blauwer-v1',
      name: 'BLAUWER Ord. acq. Standard',
      test: function(txt, name){
        var t = String(txt || '');
        // testo già “schiacciato”, niente newline
        return /BLAUWER\s*S\.?P\.?A\.?/i.test(t) && /Ord\.\s*acq\.\s*Standard/i.test(t);
      },
      extract: function(txt, name){
        var raw  = String(txt || '');
        var flat = raw.replace(/\s+/g,' ').trim();

        var righe = [];
        // Pos  Codice(>=5 cifre)  Rev  Descrizione  UM  Qta  Prezzi  Data consegna
        var re = /(\d{1,3})\s+([0-9]{5,})\s+[0-9]{1,3}\s+(.+?)\s+(PZ|NR|KG|L1|L2|L3|M|MQ|ML)\s+([0-9]+(?:[.,][0-9]+)?)(?:\s+[0-9.,]+){1,3}\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/gi;
        var m;
        while ((m = re.exec(flat))) {
          var codice = m[2];
          var descr  = m[3];
          var um     = m[4].toUpperCase();
          var qta    = toNum(m[5]);

          if (!codice || !descr || !qta) continue;

          righe.push({
            codice     : codice,
            descrizione: descr.trim(),
            um         : um,
            qta        : qta
          });
        }

        // numero + data ordine per il riferimento cliente
        var num = '';
        var docDateStr = '';
        var docDateISO = '';
        var mHead =
          flat.match(/Ord\.\s*acq\.\s*Standard.*?Numero\s+([A-Z0-9\-\/]+)\s+Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i) ||
          flat.match(/Numero\s+([A-Z0-9\-\/]+)\s+Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i);

        if (mHead) {
          num        = (mHead[1] || '').trim();
          docDateStr = (mHead[2] || '').trim();

          var parts = docDateStr.split(/[./-]/);
          if (parts.length === 3) {
            var gg = parts[0], mm = parts[1], aa = parts[2];
            if (aa.length === 2) aa = '20' + aa;
            if (gg.length === 1) gg = '0' + gg;
            if (mm.length === 1) mm = '0' + mm;
            docDateISO = aa + '-' + mm + '-' + gg;
          }
        }

        // descrizione commessa → generica (non con "Ordine 4500...")
        var descrizione;
        if (righe.length > 1) {
          descrizione = 'Commessa da ordine cliente (Blauwer, ' + righe.length + ' righe)';
        } else if (righe.length === 1) {
          descrizione = righe[0].descrizione;
        } else {
          descrizione = 'Commessa da ordine PDF';
        }

        // scadenza = massima data consegna nel documento
        var scad = '';
        try{
          var dates = flat.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/g) || [];
          var times = dates.map(function(d){
            var p = d.split(/[./-]/);
            if (p.length !== 3) return NaN;
            var gg = p[0], mm = p[1], aa = p[2];
            if (aa.length === 2) aa = '20' + aa;
            if (gg.length === 1) gg = '0' + gg;
            if (mm.length === 1) mm = '0' + mm;
            var iso = aa + '-' + mm + '-' + gg;
            return new Date(iso).getTime();
          }).filter(function(n){ return !isNaN(n); });
          if (times.length) {
            var max = Math.max.apply(null, times);
            scad = new Date(max).toISOString().slice(0,10);
          }
        }catch(e){}

        // oggetto rifCliente usato nel form (tipo / numero / data)
        var rifObj = null;
        if (num || docDateISO) {
          rifObj = {
            tipo  : 'ordine',
            numero: num || '',
            data  : docDateISO || ''
          };
        }

        console.log('[blauwer-v1] parsed righe:', righe.length, 'rifCliente:', rifObj);

        return {
          cliente    : 'BLAUWER S.P.A.',
          descrizione: descrizione,           // 👈 sopra: testo generico
          righe      : righe,
          qtaPezzi   : righe.reduce(function(s,r){ return s + (Number(r.qta)||0); }, 0) || 1,
          scadenza   : scad,
          rifCliente : rifObj                 // 👈 qui il riferimento cliente strutturato
        };
      }
    });
  }catch(e){
    console.warn('[order-parser] blauwer-v1 runtime patch fail', e);
  }
})();

// ==== AUTH + API HELPERS (incolla in cima a app.js) ====
(function (global) {
  const API = ''; // stesso origin: '' va benissimo (http://server:8080)

  async function fetchJSON(path, opts={}) {
    const o = { credentials: 'include', headers: {}, ...opts };
    if (o.body != null && typeof o.body !== 'string') {
      o.headers['Content-Type'] = 'application/json';
      o.body = JSON.stringify(o.body);
    }
    const res = await fetch(API + path, o);
    if (!res.ok) {
      let msg = 'HTTP ' + res.status;
      try { const j = await res.json(); if (j && j.error) msg = j.error; } catch {}
      const err = new Error(msg); err.status = res.status; throw err;
    }
    const ct = res.headers.get('Content-Type') || '';
    if (ct.includes('application/json')) return res.json();
    return res.text();
  }

    // --- AUTH: Supabase nativo + mapping ruolo da appSettings.users ---
global.apiLogin = async (username, password) => {
  const sb = window.getSupabase && window.getSupabase();
  if (!sb) throw new Error('Supabase non configurato');

  const { error } = await sb.auth.signInWithPassword({
    email: String(username||'').trim(),
    password: String(password||'').trim()
  });
  if (error) throw error;

  // 👇 FONTE UNICA: mappa ruolo passando SEMPRE da apiMe()
  const me = (global.apiMe ? await global.apiMe() : null);
  if (!me) throw new Error('Login riuscito ma impossibile ricavare utente');
  return me;
};

// Redirect post-login: Dashboard di default, ma rispetta la Timbratura da QR
window.addEventListener('auth-change', () => {
  const raw    = String(location.hash || '').toLowerCase();
  const h      = raw.split('?')[0]; // solo la parte prima di eventuali query
  const intent = sessionStorage.getItem('__intent_timbratura') === '1';

  // Cambia rotta SOLO se:
  // - c'è intento timbratura (da QR)
  // - oppure sei su login/root (nessuna pagina "vera" aperta)
  const isLoginOrRoot =
    !h || h === '#' || h === '#/' || h === '#/login';

  if (intent || (isLoginOrRoot && !h.startsWith('#/timbratura'))) {
    if (intent || h.startsWith('#/timbratura')) {
      location.hash = '#/timbratura';
    } else {
      location.hash = '#/dashboard';
    }
  }

  // Consuma l'intento, così i login successivi vanno "normali"
  try { sessionStorage.removeItem('__intent_timbratura'); } catch {}
});

// Chi sono (Supabase prima, poi fallback /api/auth/me)
  global.apiMe = global.apiMe || (async () => {
    try{
      const sb = window.getSupabase && window.getSupabase();
      if (sb){
        const { data: { user } } = await sb.auth.getUser();
        if (user){
          // 1. DEFAULT SICURO: Se non ti conosco, sei un 'worker' (limitato), NON admin.
          let role = 'worker'; 
          
          try{
            const s = (typeof window.lsGet === 'function'
              ? window.lsGet('appSettings', {})
              : (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })()
            ) || {};

            // 2. Cerco l'utente nella lista (confronto email preciso e pulito)
            const myEmail = String(user.email || '').trim().toLowerCase();
            
            const m = (s.users||[]).find(u =>
              String(u.username || u.email || '').trim().toLowerCase() === myEmail
            );

            // LOGIN DURO (allowlist):
            // - Se authRequired è attivo (default true)
            // - e users è non vuota
            // - e strictAllowlist non è disabilitato
            // allora un utente non presente NON entra (signOut + ritorna null).
            const users = Array.isArray(s.users) ? s.users : [];
            const authRequired = (s.authRequired !== false);
            const strictAllowlist = (s.strictAllowlist !== false); // default true

            // In dev/file:// lasciamo sempre possibile entrare per non bloccare sviluppo locale
            const isDevFile = (String(location.protocol || '').toLowerCase() === 'file:');

            if (!isDevFile && authRequired && strictAllowlist && users.length > 0 && !m) {
              try { sessionStorage.setItem('__auth_denied', myEmail); } catch {}
              try {
                const sb2 = window.getSupabase && window.getSupabase();
                if (sb2) await sb2.auth.signOut();
              } catch {}
              try { global.currentUser = null; } catch {}
              window.__USER = null;
              window.dispatchEvent(new CustomEvent('auth-change', { detail: null }));
              return null;
            }

            // 3. Se ti trovo, prendo il tuo ruolo specifico
            if (m && m.role) role = m.role;
            
          }catch(e){
            console.warn('Errore lettura ruoli:', e);
          }

          const u = { id: user.id, username: user.email, role };
          global.currentUser = u;
          window.__USER = u;
          window.__ONLINE__ = true;
          window.dispatchEvent(new CustomEvent('auth-change', { detail: u }));
          return u;
        }
      }
    }catch{}

    // Nessun backend legacy, nessun supabase -> sloggato
    window.__USER = null;
    window.__ONLINE__ = false;
    return null;
  });

global.requireLogin = async () => {
  const me = await global.apiMe();
  if (!me) {
    location.hash = '#/login';
    throw new Error('non autenticato');
  }
  return me;
};

global.logout = global.logout || (async () => {
  try {
    const sb = window.getSupabase && window.getSupabase();
    if (sb) await sb.auth.signOut();
  } catch {}
  global.currentUser = null;
  window.__USER = null;
  location.hash = '#/login';
});



// Alias di compatibilità (se altrove chiami window.login)
window.login = window.login || global.apiLogin;


  global.apiLogout = async ()=> {
    // Esci da Supabase (se configurato)
    try {
      const sb = window.getSupabase && window.getSupabase();
      if (sb) await sb.auth.signOut();
    } catch {}

    // Niente più chiamate a /api/auth/logout: ambiente BETA è statico (GitHub Pages)
    // e il vecchio backend LAN non è più parte del flusso principale.

    global.currentUser = null;
    window.__USER = null;
    window.__ONLINE__ = true;
    try {
      window.dispatchEvent(new CustomEvent('auth-change', { detail: null }));
    } catch {}
    return true;
  };

  // Chi sono (Supabase prima, poi fallback /api/auth/me)
global.apiMe = global.apiMe || (async () => {
  try{
    const sb = window.getSupabase && window.getSupabase();
    if (sb){
      const { data: { user } } = await sb.auth.getUser();
      if (user){
        let role = 'worker';
        try{
        const s = (typeof window.lsGet === 'function'
          ? window.lsGet('appSettings', {})
          : (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })()
        ) || {};

          const m = (s.users||[]).find(u =>
            String(u.username || u.email || '').trim().toLowerCase() ===
            String(user.email || '').trim().toLowerCase()
          );

          // LOGIN DURO (allowlist):
          // - Se authRequired è attivo (default true)
          // - e users è non vuota
          // - e strictAllowlist non è disabilitato
          // allora un utente non presente NON entra (signOut + ritorna null).
          const users = Array.isArray(s.users) ? s.users : [];
          const authRequired = (s.authRequired !== false);
          const strictAllowlist = (s.strictAllowlist !== false); // default true

          // In dev/file:// lasciamo sempre possibile entrare per non bloccare sviluppo locale
          const isDevFile = (String(location.protocol || '').toLowerCase() === 'file:');

          if (!isDevFile && authRequired && strictAllowlist && users.length > 0 && !m) {
            try { sessionStorage.setItem('__auth_denied', myEmail); } catch {}
            try {
              const sb2 = window.getSupabase && window.getSupabase();
              if (sb2) await sb2.auth.signOut();
            } catch {}
            try { global.currentUser = null; } catch {}
            window.__USER = null;
            window.dispatchEvent(new CustomEvent('auth-change', { detail: null }));
            return null;
          }

          if (m && m.role) role = m.role;
        }catch{}
        const u = { id: user.id, username: user.email, role };
        global.currentUser = u;
        window.__USER = u;
        window.__ONLINE__ = true;
        window.dispatchEvent(new CustomEvent('auth-change', { detail: u }));
        return u;
      }
    }
  }catch{}

    // In ambiente BETA statico non esiste più alcun backend legacy.
  // Se Supabase non restituisce un utente, consideriamo semplicemente non autenticato.
  window.__USER = null;
  window.__ONLINE__ = false;
  return null;
});

  // opzionale ma utile: unifica anche il RO helper
  //window.isReadOnlyUser = function(){
  //  const u = window.__USER || window.currentUser || null;
  //  return !!(u && u.role === 'accountant');
  // };
})(window);


function isStaticHost(){
  // In questa versione (GitHub Pages / hosting statico)
  // consideriamo SEMPRE l'host come "statico" e usiamo solo localStorage,
  // senza mai chiamare /api/kv sul backend.
  return true;
}

// alias browser-safe per codice legacy che usa "global"
const global = window;

  // --- KV store ---
  global.kvGet = async (key, fallback=null)=> {
    if (isStaticHost()) {
      try { return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback; }
      catch { return fallback; }
    }

     try { const r = await fetchJSON('/api/kv/' + encodeURIComponent(key)); global.__ONLINE__=true; return (r==null? fallback : r); }
     catch { global.__ONLINE__=false; try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{return fallback;} }
  };
   global.kvMultiGet = async (keys)=> {
     if (isStaticHost()) {
   const out = {};
   (keys || []).forEach(k => {
     try { out[k] = JSON.parse(localStorage.getItem(k) || 'null'); }
     catch { out[k] = null; }
   });
   return out;
  }

    try {
      const q = encodeURI(keys.join(','));
      const r = await fetchJSON('/api/kv?keys=' + q);
      global.__ONLINE__ = true;
      return r || {};
    } catch {
      global.__ONLINE__ = false;
      const out = {};
      keys.forEach(k => { try{ out[k] = JSON.parse(localStorage.getItem(k)); }catch{ out[k]=null; } });
      return out;
    }
  };
  global.kvSet = async (key, value)=> {
    if (isStaticHost()) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    return { ok: true, storage: 'local' };
  }
    try { const r = await fetchJSON('/api/kv/' + encodeURIComponent(key), { method:'PUT', body:value }); global.__ONLINE__=true; return r; }
    catch (e) {
      // se offline o 403 (accountant), ripiego su localStorage
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch{}
      throw e;
    }
  };

  // Bridge per compatibilità con codice che usa window.api.kv
  window.api = window.api || {};
  window.api.kv = window.api.kv || {
  get:    (k)    => window.kvGet(k, null),
  set:    (k, v) => window.kvSet(k, v),
  multiGet: (arr)=> window.kvMultiGet(arr)
  };


  // mirror helper: salva SEMPRE su localStorage, e SE possibile anche sul server (solo admin)
  global.mirrorToServer = (key, value)=> {
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch{}
    if (global.__ONLINE__ && global.currentUser && global.currentUser.role === 'admin') {
      global.kvSet(key, value).catch(()=>{ /* ignora errori di rete/permessi */ });
    }
  };

  // all’avvio, prova a capire chi sono
  (async function initAuth(){
    await global.apiMe(); // setta currentUser / __ONLINE__
  })();
})(window);

// === Channel & Version (BETA vs STABLE) ===
window.__APP_CHANNEL__ = window.__APP_CHANNEL__ || 'prod';
window.__APP_VERSION__ = window.__APP_VERSION__ || '0.8.0-beta.1';
window.__APP_NS__      = (window.__APP_CHANNEL__ === 'beta') ? 'ANIMA_BETA__' : 'ANIMA__';

// RBAC semplice: admin ha sempre accesso
window.hasRole = window.hasRole || function (role) {
  const u = window.__USER || window.currentUser || null;
  if (!u) return false;
  if (u.role === 'admin') return true;
  return String(u.role) === String(role);
};

// ============ LS namespace per separare BETA/STABLE (BETA:*) ============
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  function isBetaEnv(){
    try{
      const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
      const env = String(s.cloudEnv || s.supabaseEnv || '').toLowerCase();
      if (env === 'beta') return true;
      // fallback: canale app (se hai build separate)
      return String(window.__APP_CHANNEL__||'').toLowerCase() === 'beta';
    }catch{
      return String(window.__APP_CHANNEL__||'').toLowerCase() === 'beta';
    }
  }

  function nsKey(k){
    return isBetaEnv() ? ('BETA:' + k) : k;
  }

  function rawGet(k){
    if (!isBetaEnv()) return localStorage.getItem(k);

    const nk = nsKey(k);
    const vN = localStorage.getItem(nk);
    if (vN != null) return vN;

    // fallback one-shot: leggi la chiave normale e migrala in BETA:
    const v = localStorage.getItem(k);
    if (v != null){
      try { localStorage.setItem(nk, v); } catch {}
    }
    return v;
  }

   // OVERRIDE volutamente "forte" (non usare ||), così vale davvero in beta
  window.lsGet = function(k, def){
    try{
      const v = rawGet(k);
      const isMagKey = (k === 'magArticoli' || k === 'magazzinoArticoli');

      // Se NON è una chiave magazzino:
      // comportamento standard: se c'è qualcosa, parse; altrimenti def
      if (!isMagKey) {
        return v != null ? JSON.parse(v) : def;
      }

      // --- CASO SPECIALE: chiavi magazzino articoli ---
      // Trattiamo 'null' e '[]' come "vuoto" e facciamo fallback su magArticoli_v2
      const isEmpty =
        (v == null) ||
        v === 'null' ||
        v === '[]' ||
        v === '';

      if (!isEmpty) {
        // c'è un valore reale → usiamo quello
        return JSON.parse(v);
      }

      // Fallback: prova a leggere magArticoli_v2
      try {
        const rawV2 = localStorage.getItem('magArticoli_v2');
        if (rawV2 && rawV2 !== 'null' && rawV2 !== '[]') {
          const parsedV2 = JSON.parse(rawV2);
          if (Array.isArray(parsedV2)) {
            console.log('[lsGet] fallback magArticoli_v2 per', k, 'len=', parsedV2.length);
            return parsedV2;
          }
        }
      } catch (e) {
        console.warn('[lsGet] fallback magArticoli_v2 error', e);
      }

      // Se anche il fallback è vuoto → def
      return def;
    }catch{
      return def;
    }
  };

  window.lsSet = function(k, val){
    try{
      localStorage.setItem(nsKey(k), JSON.stringify(val));
      window.__anima_dirty = true;
    }catch{}
  };

  window.lsRemove = window.lsRemove || function(k){
    try{ localStorage.removeItem(nsKey(k)); }catch{}
  };

  // debug soft
  try{
    if (isBetaEnv()) console.log('[LS] Namespace BETA attivo');
  }catch{}
})();

// ============ Patch: intercetta accessi localStorage diretti in BETA ============
(function(){
  if (window.__ANIMA_LS_PATCHED__) return;
  window.__ANIMA_LS_PATCHED__ = true;

  function isBetaEnv(){
    try{
      const s = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
      const env = String(s.cloudEnv || s.supabaseEnv || '').toLowerCase();
      if (env === 'beta') return true;
      return String(window.__APP_CHANNEL__||'').toLowerCase() === 'beta';
    }catch{
      return String(window.__APP_CHANNEL__||'').toLowerCase() === 'beta';
    }
  }

  if (!isBetaEnv()) return;

  const NS = 'BETA:';
  const TARGET_KEYS = new Set([
    // dati principali
    'clientiRows',
    'fornitoriRows',
    'magArticoli',
    'magazzinoArticoli',
    'commesseRows',
    'ddtRows',
    'fattureRows',
    'ordiniFornitoriRows',
    'timbratureRows',
    'magMovimenti',
    // impostazioni/contatori/UI
    'appSettings',
    'counters',
    'oreRows',
    'lastRoute',
    'sidebarOpen',
    'activeTab',
    // prefill / QR / varie
    'prefillDDT',
    'prefillFattura',
    'qrJob',
    // flag interni
    'ORE_CLOUD_IMPORTED_IDS',
    '__ANIMA_FIX_QTA_ONCE__'
  ]);

  const _get = localStorage.getItem.bind(localStorage);
  const _set = localStorage.setItem.bind(localStorage);
  const _rem = localStorage.removeItem.bind(localStorage);

  localStorage.getItem = function(k){
    if (TARGET_KEYS.has(k)){
      const vN = _get(NS + k);
      if (vN != null) return vN;

      // fallback one-shot dalla chiave normale
      const v = _get(k);
      if (v != null){
        try { _set(NS + k, v); } catch {}
      }
      return v;
    }
    return _get(k);
  };

  localStorage.setItem = function(k, v){
    if (TARGET_KEYS.has(k)) return _set(NS + k, v);
    return _set(k, v);
  };

  localStorage.removeItem = function(k){
    if (TARGET_KEYS.has(k)) return _rem(NS + k);
    return _rem(k);
  };

  try { console.log('[LS] Patch direct localStorage → BETA:* attiva'); } catch {}
})();

/* ================== MAGAZZINO: movimenti & giacenze (helper generici) ================== */
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  const MAG_MOV_KEY = 'magMovimenti';          // elenco movimenti magazzino
  const ART_KEY     = 'magazzinoArticoli';     // anagrafica articoli

  // ======================================================================
// ID helper uniforme (DDT/FA/MC): genera PREFIX-YYYY-NNN usando "counters"
// Se esistono nextIdUnique/nextProgressivo, li riusa; altrimenti fallback robusto.
// ======================================================================
window.nextIdFor = window.nextIdFor || function nextIdFor({
  prefix,          // es. 'MC'
  storageKey,      // es. 'magMovimenti'
  seriesKey,       // es. 'MC' (chiave nei counters)
  width = 3        // cifre NNN
}){
  const pad = (n,w)=> String(n).padStart(w,'0');
  const Y = new Date().getFullYear();

  // 1) preferisci nextIdUnique (se presente nel tuo progetto)
  if (typeof window.nextIdUnique === 'function') {
    // NB: nextIdUnique accetta (namespace, prefix, storageKey)
    try {
      const out = window.nextIdUnique(seriesKey || prefix, prefix, storageKey);
      if (out && out.id) return out;
    } catch {}
  }

  // 2) preferisci nextProgressivo (se presente e compatibile)
  if (typeof window.nextProgressivo === 'function') {
    try {
      const { year, num } = window.nextProgressivo(seriesKey || prefix);
      const id = `${prefix}-${year}-${(window.formatNNN ? window.formatNNN(num) : pad(num,width))}`;
      return { id, year, num };
    } catch {}
  }

  // 3) fallback: usa counters + scansione storageKey per allinearti al massimo già usato
  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{return d;} });
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  // legge massimo già presente nello storage per l'anno corrente
  const all = lsGet(storageKey, []) || [];
  let maxInStore = 0;
  for (const r of all) {
    const m = String(r.id||'').match(new RegExp(`^${prefix}-${Y}-(\\d{${width}})$`));
    if (m) maxInStore = Math.max(maxInStore, parseInt(m[1],10) || 0);
  }

  // legge counters
  let counters = {};
  try { counters = JSON.parse(localStorage.getItem('counters')||'{}') || {}; } catch {}
  const key = seriesKey || prefix;

  let base = 0;
  if (counters[key] && counters[key].year === Y) base = Number(counters[key].num) || 0;
  // allineati al massimo esistente se superiore
  base = Math.max(base, maxInStore);

  const next = base + 1;
  counters[key] = { year: Y, num: next };
  try { localStorage.setItem('counters', JSON.stringify(counters)); } catch {}

  const id = `${prefix}-${Y}-${pad(next,width)}`;
  return { id, year:Y, num:next };
};

// ======================================================================
// Crea un movimento di CARICO da Ordine Fornitore (ID: MC-YYYY-NNN)
// - righeCarico: [{codice, qta, prezzo}] (qta>0)
// - opts: { data, ddtFornitore, note, updateCMP }
//   * updateCMP: se true forza l’aggiornamento CMP; altrimenti usa appSettings.magUpdateCMP
// ======================================================================
window.creaMovimentoCaricoDaOrdine = function(ordine, righeCarico, opts = {}){
  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{return d;} });
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  const KEYS = (window.__MAG_KEYS__ || { MAG_MOV_KEY:'magMovimenti', ART_KEY:'magArticoli' });
  const MAG_MOV_KEY = KEYS.MAG_MOV_KEY || 'magMovimenti';
  const ART_KEY     = KEYS.ART_KEY     || 'magArticoli'; // nel dubbio: supporto chiave classica

  // normalizza righe
  const lines = (Array.isArray(righeCarico)?righeCarico:[])
    .map(r => ({
      codice: String(r.codice||'').trim(),
      qta: Number(r.qta||0),
      prezzo: Number(r.prezzo||0)
    }))
    .filter(r => r.codice && r.qta>0);

  if (!lines.length) { alert('Nessuna riga valida per il carico.'); return null; }

  // ID MC-YYYY-NNN uniforme
  const { id } = window.nextIdFor({
    prefix: 'MC',
    storageKey: MAG_MOV_KEY,
    seriesKey: 'MC',
    width: 3
  });

  const nowISO = new Date().toISOString();

  const mov = {
    id,
    tipo: 'CARICO',
    data: (opts.data || nowISO.slice(0,10)),
    rifDoc: ordine?.id || '',
    fornitoreId: ordine?.fornitoreId || '',
    ddtFornitore: opts.ddtFornitore || '',
    note: opts.note || '',
    righe: lines,
    createdAt: nowISO,
    updatedAt: nowISO
  };

  // salva movimento
  const movs = lsGet(MAG_MOV_KEY, []) || [];
  movs.push(mov);
  lsSet(MAG_MOV_KEY, movs);

  // aggiorna giacenze (quantità; CMP opzionale)
  const app = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{};} })();
  const finalUpdCMP = !!opts.updateCMP || !!app.magUpdateCMP;

  if (typeof window.applyCaricoToMagazzino === 'function') {
    // delega alla tua routine di magazzino
    window.applyCaricoToMagazzino(mov.righe, { updateCMP: finalUpdCMP });
  } else {
    // fallback minimal: aggiorna solo quantità; NON tocca CMP
    const arts = lsGet(ART_KEY, []) || [];
    mov.righe.forEach(r => {
      const a = arts.find(x => String(x.codice||x.id||'').trim() === r.codice);
      if (a) {
        a.qta = Number(a.qta||0) + Number(r.qta||0);
        a.updatedAt = nowISO;
      }
    });
    lsSet(ART_KEY, arts);
  }

  // sync cloud (best-effort, non blocca)
  try { if (typeof window.syncExportToCloudOnly === 'function') window.syncExportToCloudOnly([MAG_MOV_KEY]); } catch {}
  try { if (typeof window.syncExportToCloudOnly === 'function') window.syncExportToCloudOnly([ART_KEY]); } catch {}

  return mov;
};


  function applyCaricoToMagazzino(righe, {updateCMP=false}={}){
    const articoli = lsGet(ART_KEY, []);
    const indexByCode = new Map(articoli.map((a,i)=>[(a.codice||a.id||`#${i}`), i]));
    righe.forEach(r=>{
      const code = r.codice;
      let idx = indexByCode.get(code);
      if (idx == null) {
        // articolo non presente: crealo minimo
        articoli.push({ codice: code, descrizione: code, um: '', giacenza: Number(r.qta||0), cmp: Number(r.prezzo||0) });
        indexByCode.set(code, articoli.length-1);
      } else {
        const a = articoli[idx];
        const oldQ = Number(a.giacenza||0);
        const oldCMP = Number(a.cmp||0);
        const addQ = Number(r.qta||0);
        const price = Number(r.prezzo||0);
        a.giacenza = oldQ + addQ;
        if (updateCMP) {
          // costo medio ponderato
          const newTot = oldQ*oldCMP + addQ*price;
          const newQ = oldQ + addQ;
          a.cmp = newQ > 0 ? (newTot / newQ) : price;
        }
        articoli[idx] = a;
      }
    });
    lsSet(ART_KEY, articoli);
  }

  // export chiavi per altre view
  window.__MAG_KEYS__ = { MAG_MOV_KEY, ART_KEY };
  // === Ricalcolo giacenze dagli storici (tollerante schema) ===
 window.ricalcolaGiacenzeDaMovimenti = function(){
  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });
  const MOV_KEY = (window.__MAG_KEYS__ && window.__MAG_KEYS__.MAG_MOV_KEY) || 'magMovimenti';
  const ART_KEY = (window.__MAG_KEYS__ && window.__MAG_KEYS__.ART_KEY)     || 'magazzinoArticoli';

  const movsRaw = lsGet(MOV_KEY, []);
  const movs = Array.isArray(movsRaw)
    ? movsRaw.filter(m => !m?.deletedAt)   // ignora soft-deleted
    : [];

  const map = new Map();
  const getLines = (r) => {
    if (Array.isArray(r?.righe)) return r.righe;
    if (Array.isArray(r?.rows)) return r.rows;
    if (Array.isArray(r?.items)) return r.items;
    if (r && (r.codice || r.code)) return [{ codice: r.codice || r.code, qta: r.qta || r.qty || r.quantita || 0, prezzo: r.prezzo || r.price || r.costo || 0 }];
    return [];
  };
  const tipo = (t)=> String(t||'').toUpperCase();

  movs.forEach(m=>{
    const lines = getLines(m);
    const T = tipo(m.tipo);
    lines.forEach(x=>{
      const code = x.codice || x.code || x.articolo || x.id;
      if (!code) return;
      const q = Number(x.qta||x.qty||x.quantita||0) || 0;
      const p = Number(x.prezzo||x.price||x.costo||0) || 0;
      let a = map.get(code) || { codice: code, descrizione: code, um:'', giacenza:0, cmp:0 };
      if (T==='CARICO' || T==='C'){
        const totOld = a.giacenza * a.cmp;
        const newQ = a.giacenza + q;
        a.cmp = newQ > 0 ? (totOld + q*p) / newQ : a.cmp;
        a.giacenza = newQ;
      } else if (T==='SCARICO' || T==='S'){
        a.giacenza = a.giacenza - q;
      }
      map.set(code, a);
    });
  });

  const out = Array.from(map.values());
  lsSet(ART_KEY, out);
  alert(`Ricalcolo completato. Articoli ricostruiti: ${out.length}`);
};
})();

(function mirrorMagazzinoKeys(){
  try{
    // helper: vero solo se c'è qualcosa di "non vuoto"
    const hasData = (val)=>{
      if (!val) return false;
      if (Array.isArray(val)) return val.length > 0;
      if (typeof val === 'object') return Object.keys(val).length > 0;
      return true;
    };

    // 1) Prova a leggere la nuova chiave robusta usata dal Magazzino
    let v2 = null;
    try{
      const rawV2 = localStorage.getItem('magArticoli_v2');
      if (rawV2 && rawV2 !== 'null' && rawV2 !== '[]'){
        v2 = JSON.parse(rawV2);
      }
    }catch{}

    // 2) Leggi anche le chiavi storiche (possono essere vuote)
    let a = null, b = null;
    try{
      a = JSON.parse(localStorage.getItem('magazzinoArticoli') || 'null');
    }catch{}
    try{
      b = JSON.parse(localStorage.getItem('magArticoli') || 'null');
    }catch{}

    // 3) Se ho v2, la uso come sorgente principale per riempire le altre chiavi
    if (hasData(v2)){
      if (!hasData(a)) localStorage.setItem('magazzinoArticoli', JSON.stringify(v2));
      if (!hasData(b)) localStorage.setItem('magArticoli', JSON.stringify(v2));
    } else {
      // 4) Fallback vecchio comportamento: specchia tra le due chiavi storiche
      if (hasData(a) && !hasData(b)) localStorage.setItem('magArticoli', JSON.stringify(a));
      if (hasData(b) && !hasData(a)) localStorage.setItem('magazzinoArticoli', JSON.stringify(b));
    }
  }catch(e){
    console.warn('[mirrorMagazzinoKeys] errore', e);
  }
})();

// === ID unico: salta i numeri già usati su quello store ===
window.nextIdUnique = function (series, prefix, storeKey) {
  const year = new Date().getFullYear();
  let counters = {};
  try { counters = JSON.parse(localStorage.getItem('counters') || '{}') || {}; } catch {}
  let num = (counters[series] && counters[series].year === year && Number.isFinite(counters[series].num))
    ? (counters[series].num + 1) : 1;

  // prendi gli ID già esistenti in quello store (es. 'commesseRows')
  let ids = new Set();
  try {
    const arr = JSON.parse(localStorage.getItem(storeKey) || '[]') || [];
    ids = new Set(arr.map(x => x && x.id).filter(Boolean));
  } catch {}

  let id = `${prefix}-${year}-${String(num).padStart(3,'0')}`;
  while (ids.has(id)) {
    num += 1;
    id = `${prefix}-${year}-${String(num).padStart(3,'0')}`;
  }
  counters[series] = { year, num };
  try { localStorage.setItem('counters', JSON.stringify(counters)); } catch {}
  return { id, year, num };
};


// === Patch anti-crash: normalizza i cleanup di useEffect ===
// Evita l'errore "TypeError: c is not a function" quando qualche effetto ritorna un valore non funzione.
// Non rimuove nulla: si limita a scartare cleanup non validi e loggare un warning.
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  try{
    const _ue = React.useEffect;
    const wrap = (fn) => {
      return function wrappedEffect(){
        let cleanup;
        try { cleanup = fn && fn(); }
        catch(err){ console.error('[useEffect body error]:', err); }
        if (cleanup && typeof cleanup !== 'function'){
          console.warn('[useEffect] cleanup non-funzione scartato:', cleanup);
          return undefined;
        }
        return cleanup;
      };
    };
    React.useEffect = (fn, deps) => _ue(wrap(fn), deps);
    if (React.useLayoutEffect){
      const _ule = React.useLayoutEffect;
      React.useLayoutEffect = (fn, deps) => _ule(wrap(fn), deps);
    }
  }catch(err){ console.warn('Patch anti-crash useEffect non applicata:', err); }
})();



// Migrazione contatori: {last} -> {num}
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  try {
    const counters = JSON.parse(localStorage.getItem('counters') || '{}') || {};
    let dirty = false;
    Object.keys(counters).forEach(k => {
      const v = counters[k];
      if (v && v.last != null) {
        v.num = Number(v.num ?? v.last) || 0;
        delete v.last;
        dirty = true;
      }
    });
    if (dirty) localStorage.setItem('counters', JSON.stringify(counters));
  } catch {}
})();

// --- salvatore centralizzato: segna dirty + salva ---
function saveKey(k, v){
  if (typeof window.lsSet === 'function') {
    window.lsSet(k, v);              // imposta anche __anima_dirty = true
  } else {
    try { localStorage.setItem(k, JSON.stringify(v)); } catch {}
    window.__anima_dirty = true;
  }
}
// === Loader XLSX globale con fallback locale+CDN ===
window.ensureXLSX = window.ensureXLSX || (function () {
  let p = null;
  return function ensureXLSX() {
    if (window.XLSX) return Promise.resolve();
    if (p) return p;
    p = new Promise((resolve, reject) => {
      const urls = [
        './vendor/xlsx.full.min.js',                                        // locale
        'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',              // CDN 1
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js' // CDN 2
      ];
      const next = () => {
        const src = urls.shift();
        if (!src) return reject(new Error('XLSX non caricato'));
        const s = document.createElement('script');
        s.src = src; s.defer = true;
        s.onload = resolve;
        s.onerror = next;
        document.head.appendChild(s);
      };
      next();
    });
    return p;
  };
})();

// ================== SUPABASE AUTO-SYNC v2 (REST) ==================
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

   // --- GUARD CONFIG: se non abilitato o credenziali mancanti, esci in silenzio ---
    const __S0 = (function(){
    try { return JSON.parse(localStorage.getItem('appSettings') || '{}') || {}; }
    catch { return {}; }
  })();

  const __env = String(__S0.cloudEnv || __S0.supabaseEnv || '').toLowerCase();
  const __S = {
    ...__S0,
    supabaseUrl:   (__env === 'beta') ? (__S0.supabaseUrlBeta   || __S0.supabaseUrl  || '') : (__S0.supabaseUrl  || ''),
    supabaseKey:   (__env === 'beta') ? (__S0.supabaseKeyBeta   || __S0.supabaseKey  || '') : (__S0.supabaseKey  || ''),
    supabaseTable: (__env === 'beta') ? (__S0.supabaseTableBeta || __S0.supabaseTable || 'anima_sync')
                                      : (__S0.supabaseTable     || 'anima_sync')
  };

  const __ENABLED = !!__S.cloudEnabled;
  const __URL_OK  = !!(__S.supabaseUrl && String(__S.supabaseUrl).trim());
  const __KEY_OK  = !!(__S.supabaseKey && String(__S.supabaseKey).trim());

  if (!__ENABLED || !__URL_OK || !__KEY_OK) {
  window.__cloudSync__ = { enabled: false };
  return; // blocca auto-sync finché non abiliti e configuri
  }


    const SYNC_KEYS = [
    'appSettings',
    'commesseRows',
    'oreRows',
    // magazzino: sincronizza entrambe le chiavi (alias)
    'magArticoli',
    'magazzinoArticoli',
    'magMovimenti',
    'fattureRows',
    'ddtRows',
    // contatori: li esportiamo, ma non li forzeremo in pull (vedi applySnapshot)
    'counters',
    'clientiRows',
    'fornitoriRows',
    'ordiniFornitoriRows',
    'allegatiRows',
    'preventiviRows'
  ];

    function getSettings(){
    try {
      const cfg = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
      const env = String(cfg.cloudEnv || cfg.supabaseEnv || '').toLowerCase();

      if (env === 'beta') {
        cfg.supabaseUrl   = cfg.supabaseUrlBeta   || cfg.supabaseUrl   || '';
        cfg.supabaseKey   = cfg.supabaseKeyBeta   || cfg.supabaseKey   || '';
        cfg.supabaseTable = cfg.supabaseTableBeta || cfg.supabaseTable || 'anima_sync';
      } else {
        cfg.supabaseTable = cfg.supabaseTable || 'anima_sync';
      }
      return cfg;
    } catch { return {}; }
  }

    function sbReady(cfg){  
      // Rispetta cloudEnabled (default: ON). Se cloudEnabled === false, sync disabilitato.
      if (cfg && cfg.cloudEnabled === false) return false;
      return !!(cfg && cfg.supabaseUrl && cfg.supabaseKey && (cfg.supabaseTable||'').trim());
    }
    function sbEndpoint(cfg, tail){
    return cfg.supabaseUrl.replace(/\/+$/,'') + tail;
  }
  async function sbRequest(cfg, method, path, body){
    const url = sbEndpoint(cfg, path);
    const headers = {
      'apikey': cfg.supabaseKey,
      'Authorization': 'Bearer ' + cfg.supabaseKey,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    };
    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
    if (!res.ok && res.status !== 406) {
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error(txt || res.statusText);
    }
    try { return await res.json(); } catch { return null; }
  }

    function takeSnapshot(){
    const snap = {};
    const gGet = (typeof window.lsGet === 'function')
      ? window.lsGet
      : ((k, def)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } });

    for (const k of SYNC_KEYS){
      try { snap[k] = gGet(k, null); }
      catch { snap[k] = null; }
    }

    // allinea alias magazzino per evitare divergenze
    if (snap.magArticoli != null && snap.magazzinoArticoli == null) {
      snap.magazzinoArticoli = snap.magArticoli;
    }
    if (snap.magazzinoArticoli != null && snap.magArticoli == null) {
      snap.magArticoli = snap.magazzinoArticoli;
    }

    return snap;
  }

function mergeAppSettings(localApp, remoteApp){
  localApp  = localApp  || {};
  remoteApp = remoteApp || {};

  // il remoto sovrascrive SOLO i campi che fornisce
  const out = { ...localApp, ...remoteApp };

  // proteggi array locali se il remoto NON li fornisce affatto
  if (!Array.isArray(remoteApp?.operators) && Array.isArray(localApp?.operators)) {
    out.operators = localApp.operators;
  }
  if (!Array.isArray(remoteApp?.fasiStandard) && Array.isArray(localApp?.fasiStandard)) {
    out.fasiStandard = localApp.fasiStandard;
  }

  // se il remoto li fornisce MA sono array vuoti e il locale ha dati, tieni il locale
  if (
    Array.isArray(remoteApp?.operators) &&
    remoteApp.operators.length === 0 &&
    Array.isArray(localApp?.operators) &&
    localApp.operators.length > 0
  ) {
    out.operators = localApp.operators;
  }
  if (
    Array.isArray(remoteApp?.fasiStandard) &&
    remoteApp.fasiStandard.length === 0 &&
    Array.isArray(localApp?.fasiStandard) &&
    localApp.fasiStandard.length > 0
  ) {
    out.fasiStandard = localApp.fasiStandard;
  }

  // NON sovrascrivere stringhe non vuote con vuoto/null dal remoto
  Object.keys(out).forEach(k => {
    if (Object.prototype.hasOwnProperty.call(remoteApp, k)) {
      const rv = remoteApp[k];
      const lv = localApp[k];

      if (
        typeof lv === 'string' &&
        lv.trim() &&                     // locale non vuoto
        (rv === '' || rv === null || rv === undefined) // remoto vuoto
      ){
        out[k] = lv; // tieni il valore "buono" locale
      }
    }
  });

  return out;
}

  function applySnapshot(snap){
    if (!snap || typeof snap!=='object') return;

    // allinea alias magazzino prima del merge
    if ('magArticoli' in snap && !('magazzinoArticoli' in snap)) {
      snap.magazzinoArticoli = snap.magArticoli;
    }
    if ('magazzinoArticoli' in snap && !('magArticoli' in snap)) {
      snap.magArticoli = snap.magazzinoArticoli;
    }

    // merge per array di record -> per id con preferenza updatedAt più recente
    const preferNewer = (a, b) => {
      const ta = Date.parse(a?.updatedAt||0) || 0;
      const tb = Date.parse(b?.updatedAt||0) || 0;
      if (ta && tb) return tb >= ta ? b : a;
      if (tb && !ta) return b;
      return a || b;
    };
    const mergeById = (localArr, remoteArr) => {
      const map = new Map();
      (Array.isArray(localArr)?localArr:[]).forEach(x => { if (x && x.id!=null) map.set(x.id, x); });
      (Array.isArray(remoteArr)?remoteArr:[]).forEach(r => {
        if (!r || r.id==null) return;
        const prev = map.get(r.id);
        map.set(r.id, prev ? preferNewer(prev, r) : r);
      });
      return Array.from(map.values());
    };

    // chiavi principali (arrays)
    const KEYS = [
      'commesseRows','oreRows',
      'magArticoli','magazzinoArticoli','magMovimenti',
      'fattureRows','ddtRows',
      'clientiRows','fornitoriRows','ordiniFornitoriRows',
      'allegatiRows',
      'preventiviRows'
    ];

  // 1) appSettings: prendi quello con updatedAt più recente
  if ('appSettings' in snap) {
    const localApp = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })();
    const remoteApp = snap.appSettings || {};
    const lt = Date.parse(localApp.updatedAt||0) || 0;
    const rt = Date.parse(remoteApp.updatedAt||0) || 0;
    const nextApp = (rt >= lt) ? mergeAppSettings(localApp, remoteApp)
                           : mergeAppSettings(remoteApp, localApp);
    try { localStorage.setItem('appSettings', JSON.stringify(nextApp)); } catch {}
  }

  // 2) arrays: merge per id
  for (const k of KEYS){
    if (!(k in snap)) continue;
    const local = (function(){ try{ return JSON.parse(localStorage.getItem(k)||'[]') || []; }catch{return[]} })();
    const remote = snap[k];
    const merged = mergeById(local, remote);
    try { localStorage.setItem(k, JSON.stringify(merged)); } catch {}
  }

  // 3) counters: tieni il massimo per ogni serie nello stesso anno
  if ('counters' in snap) {
    const local = (function(){ try{ return JSON.parse(localStorage.getItem('counters')||'{}')||{}; }catch{return{}} })();
    const remote = snap.counters || {};
    const out = { ...local };
    Object.keys(remote).forEach(series=>{
      const r = remote[series] || {};
      const l = local[series] || {};
      if (r.year === l.year) {
        out[series] = { year: r.year, num: Math.max(Number(l.num||0), Number(r.num||0)) };
      } else {
        // scegli il più recente come anno attivo
        const pick = (Number(r.year||0) >= Number(l.year||0)) ? r : l;
        out[series] = { year: Number(pick.year||0), num: Number(pick.num||0) || 0 };
      }
    });
    try { localStorage.setItem('counters', JSON.stringify(out)); } catch {}
  }

  window.__anima_dirty = false;
  }

  async function exportAll(){
    const cfg = getSettings();
    if (!sbReady(cfg)) throw new Error('Config Supabase mancante');
    const tbl = encodeURIComponent(cfg.supabaseTable || 'anima_sync');
    const now = new Date().toISOString();
    const snap = takeSnapshot();

    // esporta solo le chiavi che hanno un payload NON nullo
    const rows = Object.keys(snap)
      .filter(k => snap[k] != null)
      .map(k => ({
        bucket: 'local',
        k,
        payload: snap[k],
        updated_at: now
      }));

    if (!rows.length) return;

    await sbRequest(cfg, 'POST', `/rest/v1/${tbl}?on_conflict=bucket,k`, rows);
    window.__anima_dirty = false;
    window.__anima_lastPush = Date.now();
  }

  async function exportOnly(onlyKeys){
    const cfg = getSettings();
    if (!sbReady(cfg)) throw new Error('Config Supabase mancante');
    const tbl = encodeURIComponent(cfg.supabaseTable || 'anima_sync');
    const now = new Date().toISOString();
    const snap = takeSnapshot();

    const rows = [];
    for (const k of SYNC_KEYS){
      // includi solo chiavi richieste E con payload non nullo
      if ((!onlyKeys || onlyKeys.includes(k)) && snap[k] != null) {
        rows.push({ bucket:'local', k, payload: snap[k], updated_at: now });
      }
    }

    if (!rows.length) return;

    await sbRequest(cfg, 'POST', `/rest/v1/${tbl}?on_conflict=bucket,k`, rows);
    window.__anima_lastPush = Date.now();
  }

  async function importAll(){
    const cfg = getSettings();
    if (!sbReady(cfg)) throw new Error('Config Supabase mancante');
    const tbl = encodeURIComponent(cfg.supabaseTable || 'anima_sync');
    const data = await sbRequest(cfg, 'GET', `/rest/v1/${tbl}?select=bucket,k,payload,updated_at&bucket=eq.local`);
    if (Array.isArray(data)) {
      const snap = {};
      for (const row of data) { if (row && row.k) snap[row.k] = row.payload; }
      applySnapshot(snap);
    }
  }

  // === Espongo i pulsanti (con alert) ===
  window.testSupabaseConnection = async function(url, key, table){
  // leggo i salvati come fallback
  const saved = (function(){
    try { return JSON.parse(localStorage.getItem('appSettings')||'{}') || {}; } catch { return {}; }
  })();

  const cfg = {
    supabaseUrl:   (url   && String(url).trim())   || saved.supabaseUrl,
    supabaseKey:   (key   && String(key).trim())   || saved.supabaseKey,
    supabaseTable: (table && String(table).trim()) || (saved.supabaseTable || 'anima_sync')
  };

  if (!cfg.supabaseUrl || !cfg.supabaseKey || !cfg.supabaseTable) {
    alert('Config Supabase mancante'); return;
  }

  // piccola GET su 1 riga a caso
  const endpoint = cfg.supabaseUrl.replace(/\/+$/,'') + `/rest/v1/${encodeURIComponent(cfg.supabaseTable)}?select=k&limit=1`;
  try{
    const res = await fetch(endpoint, {
      method: 'GET',
      headers: {
        'apikey': cfg.supabaseKey,
        'Authorization': 'Bearer ' + cfg.supabaseKey
      }
    });
    if (!res.ok && res.status !== 406) throw new Error(await res.text().catch(()=>res.statusText));
    alert('Connessione OK ✅');
  }catch(e){
    alert('Errore: ' + (e && e.message ? e.message : String(e)));
  }
  
};

  window.syncExportToCloud = async function(){
    try {
      await exportAll();
      const now = Date.now();
      window.__anima_lastPush = now;

      const prev = window.__cloudSync__ || {};
      window.__cloudSync__ = {
        ...prev,
        enabled: true,
        lastPush: now,
        lastError: null
      };

      console.info('[cloud] Dati inviati');
    } catch(e){
      console.warn('[cloud] Errore export:', e);
      const msg = e && e.message ? e.message : String(e);
      window.__cloud_lastErr = msg;
      const prev = window.__cloudSync__ || {};
      window.__cloudSync__ = {
        ...prev,
        lastError: msg
      };
    }
  };

  // ========== IMPORT CLOUD (override): MERGE per id, con priorità a record più recenti (anche deletedAt) ==========
  function mergeById(localArr, remoteArr){
    const ensureArr = (arr) => Array.isArray(arr) ? arr : [];

    // timestamp logico "ultimo cambiamento" del record
    const ts = (rec) => {
      if (!rec || typeof rec !== 'object') return 0;
      const cand = [];

      if (rec.deletedAt) {
        const t = Date.parse(rec.deletedAt);
        if (!Number.isNaN(t)) cand.push(t);
      }
      if (rec.updatedAt) {
        const t = Date.parse(rec.updatedAt);
        if (!Number.isNaN(t)) cand.push(t);
      }
      if (rec.createdAt) {
        const t = Date.parse(rec.createdAt);
        if (!Number.isNaN(t)) cand.push(t);
      }

      return cand.length ? Math.max(...cand) : 0;
    };

    const map = new Map();

    // 1) inserisco le versioni locali
    ensureArr(localArr).forEach(r => {
      if (!r || r.id == null) return;
      map.set(r.id, r);
    });

    // 2) sovrascrivo/mergo con le versioni cloud
    ensureArr(remoteArr).forEach(r => {
      if (!r || r.id == null) return;
      const cur = map.get(r.id);
      if (!cur) {
        map.set(r.id, r);
        return;
      }

      const tCur = ts(cur);
      const tNew = ts(r);

      // il record con timestamp più recente "vince"
      if (tNew >= tCur) {
        // cloud più recente: parto dal locale e sovrascrivo con cloud
        map.set(r.id, { ...cur, ...r });
      } else {
        // locale più recente: parto dal cloud e sovrascrivo con locale
        map.set(r.id, { ...r, ...cur });
      }
    });

    return Array.from(map.values());
  }

  // Alias globale (se qualcuno usa window.mergeById)
  window.mergeById = window.mergeById || mergeById;

    // === Allegati: export/import indice JSON (ridondanza) ===
  window.downloadJSONFile = window.downloadJSONFile || function(filename, data){
    try{
      const txt = JSON.stringify(data, null, 2);
      const blob = new Blob([txt], { type:'application/json' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'anima-export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch{} }, 1500);
    }catch(e){
      console.error(e);
      alert('Errore export JSON: ' + (e && e.message ? e.message : String(e)));
    }
  };

  window.readJSONFile = window.readJSONFile || function(file){
    return new Promise((resolve, reject) => {
      try{
        const r = new FileReader();
        r.onload = () => {
          try { resolve(JSON.parse(String(r.result||''))); }
          catch(e){ reject(e); }
        };
        r.onerror = () => reject(r.error || new Error('Errore lettura file'));
        r.readAsText(file);
      }catch(e){ reject(e); }
    });
  };

  window.allegatiGetAll = window.allegatiGetAll || function(){
    try{
      const arr = (typeof lsGet === 'function') ? (lsGet('allegatiRows', [])||[]) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  };

  window.allegatiSetMerged = window.allegatiSetMerged || function(incomingArr){
    const cur = window.allegatiGetAll();
    const inc = Array.isArray(incomingArr) ? incomingArr : [];
    const merged = (typeof window.mergeById === 'function') ? window.mergeById(cur, inc) : inc;
    if (typeof lsSet === 'function') lsSet('allegatiRows', merged);
    else { try{ localStorage.setItem('allegatiRows', JSON.stringify(merged)); window.__anima_dirty = true; }catch{} }
    return merged;
  };

  // Export completo (tutto allegatiRows)
  window.exportAllegatiAll = window.exportAllegatiAll || function(){
    const all = window.allegatiGetAll();
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    const payload = {
      schema: 'ANIMA_ALLEGATI_INDEX',
      version: 1,
      exportedAt: now.toISOString(),
      count: all.length,
      rows: all
    };
    window.downloadJSONFile(`ANIMA_allegatiRows_${stamp}.json`, payload);
    return payload;
  };

  // Import (merge-by-id, non cancella nulla)
  window.importAllegatiFromObject = window.importAllegatiFromObject || function(obj){
    const rows = Array.isArray(obj) ? obj
      : (Array.isArray(obj && obj.rows) ? obj.rows
      : (Array.isArray(obj && obj.allegatiRows) ? obj.allegatiRows : []));
    const before = window.allegatiGetAll();
    const merged = window.allegatiSetMerged(rows);
    return { before: before.length, imported: rows.length, after: merged.length };
  };

  window.importAllegatiFromFile = window.importAllegatiFromFile || async function(file){
    const obj = await window.readJSONFile(file);
    const res = window.importAllegatiFromObject(obj);
    console.log('[allegati] import risultato:', res);
    alert(`Indice allegati importato.\nPrima: ${res.before}\nLetti: ${res.imported}\nDopo: ${res.after}`);
    return res;
  };

window.syncImportFromCloud = async function(){
  const S = JSON.parse(localStorage.getItem('appSettings')||'{}')||{};
  const url = (S.supabaseUrl||'').replace(/\/+$/,'');
  const key = S.supabaseKey;
  const table = S.supabaseTable || 'anima_sync';
  if (!url || !key) { console.info('[cloud] config mancante → skip import'); return; }


  try{
    // ⬇️ seleziona le colonne giuste e filtra il bucket 'local'
    const res = await fetch(`${url}/rest/v1/${encodeURIComponent(table)}?select=bucket,k,payload&bucket=eq.local`, {
      headers: { 'apikey': key, 'Authorization': 'Bearer ' + key }
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status}${t ? ' — '+t : ''}`);
    }
    const rows = await res.json();

    // mappa chiave -> payload (non 'v')
    const remote = Object.create(null);
    rows.forEach(r => { remote[r.k] = r.payload; });

    // merge "per id" (usa la helper già definita sopra)
    const localC = JSON.parse(localStorage.getItem('commesseRows')||'[]')||[];
    const cloudC = Array.isArray(remote.commesseRows) ? remote.commesseRows : [];
    localStorage.setItem('commesseRows', JSON.stringify(mergeById(localC, cloudC)));

    ['oreRows','ddtRows','fattureRows','magMovimenti',
     'clientiRows','fornitoriRows',
     'ordiniFornitoriRows','allegatiRows','preventiviRows'
    ].forEach(k=>{

      if (Array.isArray(remote[k])) {
        const loc = JSON.parse(localStorage.getItem(k)||'[]')||[];
        localStorage.setItem(k, JSON.stringify(mergeById(loc, remote[k])));
      }
    });

    // ⚠️ Dal cloud NON tocchiamo più appSettings in automatico
    // Se in futuro vorrai abilitare un merge guidato delle impostazioni,
    // si potrà fare con una schermata dedicata / conferma manuale.
    const SAFE_IMPORT_APPSETTINGS = false;
    if (SAFE_IMPORT_APPSETTINGS && remote.appSettings && typeof remote.appSettings === 'object' && !Array.isArray(remote.appSettings)) {
      const localApp  = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })();
      const remoteApp = remote.appSettings || {};
      const lt = Date.parse(localApp.updatedAt || 0)  || 0;
      const rt = Date.parse(remoteApp.updatedAt || 0) || 0;
      const nextApp = (rt >= lt) ? mergeAppSettings(localApp, remoteApp)
                                 : mergeAppSettings(remoteApp, localApp);
      localStorage.setItem('appSettings', JSON.stringify(nextApp));
    }

        const nowPull = Date.now();
    window.__anima_lastPull = nowPull;
    const prevState = window.__cloudSync__ || {};
    window.__cloudSync__ = {
      ...prevState,
      enabled: true,
      lastPull: nowPull,
      lastError: null
    };

    console.info('Import cloud completato (merge, senza cancellazioni).');

  }catch(e){
    console.error(e);
    const msg = e && e.message ? e.message : String(e);
    window.__cloud_lastErr = msg;
    const prev = window.__cloudSync__ || {};
    window.__cloudSync__ = {
      ...prev,
      lastError: msg
    };
    alert('Errore import cloud: ' + msg);
  }
};

  // opzionale: export selettivo senza alert (per timbratura)
  window.syncExportToCloudOnly = async function(keys){
    try { await exportOnly(keys); } catch(e){ console.warn(e); }
  };

  // === Loop automatico SILENZIOSO (niente alert salvo errore) ===
(function autoSyncLoop(){
  const INTERVAL_MS = 15000;
  let lastErrTs = 0; // throttling: max 1 alert ogni 2 minuti

    async function tick(){
    const cfg = getSettings();
    const ready = sbReady(cfg);
    // aggiorna stato visibile in Dashboard (senza perdere le info già note)
    const prevState = window.__cloudSync__ || {};
    window.__cloudSync__ = {
      ...prevState,
      enabled: !!ready,
      lastPush: window.__anima_lastPush || prevState.lastPush || null,
      lastPull: window.__anima_lastPull || prevState.lastPull || null,
      lastError: window.__cloud_lastErr || prevState.lastError || null
    };

    if (!ready) {
      setTimeout(tick, INTERVAL_MS);
      return;
    }
    try {
      // NOTE SOLIDITÀ:
      // - Primo giro: PULL prima di qualunque PUSH (un device non allineato non deve sovrascrivere il cloud).
      // - Dirty viene azzerato SOLO dopo export riuscito.

      // 0) Primo avvio (nessun pull fatto): tira giù dal cloud e basta
      if (!window.__anima_lastPull) {
        await importAll();
        window.__anima_lastPull = Date.now();

        // Se avevi già modifiche locali (rare, ma possibile), allora pusha dopo aver pullato
        if (window.__anima_dirty) {
          await exportAll();
          window.__anima_lastPush = Date.now();
          window.__anima_dirty = false;
        }

        setTimeout(tick, INTERVAL_MS);
        return;
      }

      // 1) Regime normale: se dirty, pusha (ma non azzerare prima)
      if (window.__anima_dirty) {
        await exportAll();
        window.__anima_lastPush = Date.now();
        window.__anima_dirty = false;
      }

      // 2) Poi sempre pull
      await importAll();
      window.__anima_lastPull = Date.now();
    }
         catch(e){
      console.warn('[cloud] auto-sync error:', (e && e.message ? e.message : e));
      window.__cloud_lastErr = e && e.message ? e.message : String(e);
      const now = Date.now();
      if (now - lastErrTs > 120000) {    // 2 minuti
        lastErrTs = now;
        alert('Errore sincronizzazione cloud: ' + (e && e.message ? e.message : String(e)));
      }
    }finally{
      setTimeout(tick, INTERVAL_MS);
    }
  }
  setTimeout(tick, 3000);
})();

})();

// ============ Helpers QR (autonomi, senza dipendenze esterne) ============
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if ([...document.scripts].some(s=>s.src===src)) return resolve();
    const el = document.createElement('script');
    el.src = src; el.async = true;
    el.onload = ()=> resolve();
    el.onerror = (e)=> reject(e);
    document.head.appendChild(el);
  });
}
// === QR scanner fallback senza HTTPS: foto + jsQR ===
function ensureJsQR(){
  if (window.jsQR) return Promise.resolve();
  return loadScriptOnce('https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js');
}

// === Scanner QR unico: camera live se possibile, altrimenti foto+jsQR ===
window.scanQR = (function(){
  // dipendenza opzionale (solo per fallback foto)
  function ensureJsQR(){
    if (window.jsQR) return Promise.resolve();
    return new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      s.async = true;
      s.onload = resolve;
      s.onerror = ()=>reject(new Error('jsQR non caricato'));
      document.head.appendChild(s);
    });
  }

  async function liveCamera() {
    if (!navigator.mediaDevices || !navigator.isSecureContext || !('BarcodeDetector' in window)) return false;
    try{
      console.info('[scanQR] live camera');
      const det = new window.BarcodeDetector({ formats: ['qr_code'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      const video = document.createElement('video');
      video.playsInline = true; video.srcObject = stream; await video.play();
      const canvas = document.createElement('canvas');
      const step = async ()=>{
        if (video.readyState >= 2) {
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const bmp = await createImageBitmap(canvas);
          const codes = await det.detect(bmp);
          if (codes && codes[0] && codes[0].rawValue) {
            const raw = String(codes[0].rawValue||'').trim();
            stream.getTracks().forEach(t=>t.stop());
            const m = raw.match(/[?#&]job=([^&]+)/i);
            const job = m ? decodeURIComponent(m[1]) : raw;
            console.info('[scanQR] decodificato (live):', raw);
            location.hash = '#/timbratura?job=' + encodeURIComponent(job);
            return;
          }
        }
        requestAnimationFrame(step);
      };
      step();
      return true;
    }catch(e){
      console.warn('[scanQR] live camera error:', e);
      return false;
    }
  }

  async function photoFallback(){
    console.info('[scanQR] fallback foto + jsQR');
    await ensureJsQR();

    return new Promise((resolve)=>{
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      input.style.display = 'none';
      document.body.appendChild(input);

      input.onchange = function(ev){
        const file = ev.target.files && ev.target.files[0];
        if (!file) { document.body.removeChild(input); return resolve(false); }

        const fr = new FileReader();
        fr.onload = function(){
          const img = new Image();
          img.onload = function(){
            var MAX = 1400;
            var scales = [1, 0.75, 0.5, 0.35, 0.25];
            var rots   = [0, 90, 180, 270];

            function tryDecode() {
              var baseW = img.naturalWidth || img.width;
              var baseH = img.naturalHeight || img.height;
              var big = Math.max(baseW, baseH);
              var baseScale = Math.min(1, MAX / big);

              var canvas = document.createElement('canvas');
              var ctx = canvas.getContext('2d', { willReadFrequently: true });

              for (var si = 0; si < scales.length; si++) {
                for (var ri = 0; ri < rots.length; ri++) {
                  var s = baseScale * scales[si];
                  var w0 = Math.max(300, Math.round(baseW * s));
                  var h0 = Math.max(300, Math.round(baseH * s));
                  var r = rots[ri];
                  var rad = r * Math.PI / 180;
                  var rotW = (r % 180 === 0) ? w0 : h0;
                  var rotH = (r % 180 === 0) ? h0 : w0;

                  canvas.width = rotW; canvas.height = rotH;
                  ctx.setTransform(1,0,0,1,0,0);
                  ctx.imageSmoothingEnabled = false;
                  ctx.translate(rotW/2, rotH/2);
                  ctx.rotate(rad);
                  ctx.drawImage(img, -w0/2, -h0/2, w0, h0);
                  ctx.setTransform(1,0,0,1,0,0);

                  var frame = ctx.getImageData(0,0,rotW,rotH);
                  var res = window.jsQR(frame.data, rotW, rotH, { inversionAttempts: 'attemptBoth' });
                  if (res && res.data) return res.data;

                  var side = Math.min(rotW, rotH);
                  var x = Math.floor((rotW  - side)/2);
                  var y = Math.floor((rotH  - side)/2);
                  var crop = ctx.getImageData(x, y, side, side);
                  res = window.jsQR(crop.data, side, side, { inversionAttempts: 'attemptBoth' });
                  if (res && res.data) return res.data;
                }
              }
              return null;
            }

            var text = tryDecode();
            document.body.removeChild(input);

            if (text) {
              var raw = String(text).trim();
              console.info('[scanQR] decodificato (foto):', raw);
              var m = raw.match(/[?#&]job=([^&]+)/i);
              var job = m ? decodeURIComponent(m[1]) : raw;
              location.hash = '#/timbratura?job=' + encodeURIComponent(job);
              return resolve(true);
            } else {
              alert('QR non riconosciuto. Assicurati che sia a fuoco e riempia bene l’inquadratura.');
              return resolve(false);
            }
          };
          img.onerror = function(){ alert('Immagine non valida'); document.body.removeChild(input); resolve(false); };
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      };

      input.click();
    });
  }

  return async function(){
    // 1) prova camera live; se non parte, 2) prova foto+jsQR; se anche quella fallisce, 3) prompt
    const okLive = await liveCamera();
    if (okLive) return;
    const okPhoto = await photoFallback();
    if (okPhoto) return;

    const v = prompt('Inserisci ID commessa (es. C-2025-012):');
    if (v) location.hash = '#/timbratura?job=' + encodeURIComponent(String(v).trim());
  };
})();

// Prova "qrcode" moderna, poi "qrcodejs" legacy
async function ensureQRCodeLib(){
  if (window.QRCode && (window.QRCode.toCanvas || window.QRCode.prototype)) {
    return (window.QRCode.toCanvas ? 'modern' : 'classic');
  }
  try {
    await loadScriptOnce('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js');
    if (window.QRCode && window.QRCode.toCanvas) return 'modern';
  } catch {}
  try {
    await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js');
    if (window.QRCode && window.QRCode.prototype) return 'classic';
  } catch {}
  throw new Error('Impossibile caricare la libreria QR');
}
function makeTimbraturaURL(commessaId){
  const base = location.origin + location.pathname;
  return `${base}#/timbratura?job=${encodeURIComponent(commessaId||'')}`;
}
async function getQRDataURL(text, size=120){
  try{
    const mode = await ensureQRCodeLib();
    if (mode === 'modern' && window.QRCode && window.QRCode.toDataURL){
      return await window.QRCode.toDataURL(String(text), { width: size, margin: 0 });
    }
    if (window.QRCode && window.QRCode.prototype){
      const tmp = document.createElement('div');
      document.body.appendChild(tmp);
      new window.QRCode(tmp, { text:String(text), width:size, height:size, correctLevel: window.QRCode.CorrectLevel.M });
      await new Promise(r => setTimeout(r, 30));
      let dataUrl = null;
      const canvas = tmp.querySelector('canvas'); if (canvas && canvas.toDataURL) dataUrl = canvas.toDataURL('image/png');
      const img = tmp.querySelector('img'); if (!dataUrl && img && img.src) dataUrl = img.src;
      tmp.remove();
      return dataUrl;
    }
  }catch(e){ console.warn('QR gen error', e); }
  return null;
}
async function showQRModal(text){
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px;';
  const card = document.createElement('div');
  card.style.cssText = 'background:#fff;border-radius:10px;max-width:90vw;max-height:90vh;padding:16px;display:grid;gap:12px;place-items:center;';
  const title = Object.assign(document.createElement('div'), {textContent:'QR Commessa'});
  title.style.cssText = 'font-weight:600;font-size:16px';
  const holder = document.createElement('div');
  holder.style.cssText = 'width:280px;height:280px;display:grid;place-items:center;border:1px solid #eee;border-radius:8px';
  const msg = Object.assign(document.createElement('div'), {textContent:'Caricamento QR…'});
  msg.style.cssText = 'color:#666;font-size:12px';
  const row = document.createElement('div'); row.style.cssText='display:flex;gap:8px;align-items:center;justify-content:center;';
  const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Chiudi'; closeBtn.onclick=()=>document.body.removeChild(overlay);
  const saveBtn = document.createElement('button'); saveBtn.className='btn btn-outline'; saveBtn.textContent='Scarica PNG'; saveBtn.style.display='none';
  row.append(closeBtn, saveBtn); card.append(title, holder, msg, row); overlay.appendChild(card); document.body.appendChild(overlay);
  try{
    const mode = await ensureQRCodeLib(); msg.textContent='';
    if (mode === 'modern') {
      const canvas = document.createElement('canvas');
      await window.QRCode.toCanvas(canvas, String(text||''), { width: 280, margin: 1 });
      holder.innerHTML = ''; holder.appendChild(canvas); saveBtn.style.display='';
      saveBtn.onclick = ()=>{ canvas.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='commessa-qr.png'; a.click(); URL.revokeObjectURL(a.href); }); };
    } else {
      holder.innerHTML = ''; const div = document.createElement('div'); holder.appendChild(div);
      new window.QRCode(div, { text:String(text||''), width:280, height:280, correctLevel: window.QRCode.CorrectLevel.M });
      saveBtn.style.display='none';
    }
  } catch (err){ msg.textContent='Errore nel generare il QR'; console.error(err); }
}
// === QR CONFIG: genera e applica la configurazione cloud su un dispositivo ===
window.showConfigQR = function(){
  const s = (function(){ try { return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch { return {}; } })();
  const payload = {
    type: 'cfg',
    appSettings: {
      supabaseUrl:   s.supabaseUrl   || '',
      supabaseKey:   s.supabaseKey   || '',
      supabaseTable: s.supabaseTable || 'anima_sync',
      cloudEnabled:  true
    }
  };
  // riusa il modal già presente
  if (typeof window.showQRModal === 'function') {
    window.showQRModal(JSON.stringify(payload));
  } else {
    alert('QR modal non disponibile');
  }
};

// Applica un testo QR (JSON) come configurazione
window.applyConfigFromText = function(raw){
  try {
    const obj = JSON.parse(String(raw||'').trim());
    if (obj && obj.type === 'cfg' && obj.appSettings) {
      const cur  = (function(){ try { return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch { return {}; } })();
      const next = { ...cur, ...obj.appSettings, updatedAt: new Date().toISOString() };
      localStorage.setItem('appSettings', JSON.stringify(next));
      alert('Configurazione salvata ✅\nAvvio import dal cloud…');
      try { window.syncImportFromCloud && window.syncImportFromCloud(); } catch {}
      return true;
    }
  } catch {}
  alert('QR non riconosciuto come configurazione.');
  return false;
};

// Scanner che legge un QR di CONFIG (camera o prompt) e lo applica
window.scanConfigQR = async function(){
  let raw = null;

  // camera non disponibile su http → prompt
  const noCam = !navigator.mediaDevices || !navigator.isSecureContext;
  if (noCam) {
    raw = prompt('Incolla qui il contenuto del QR config (JSON):');
    if (!raw) return;
    window.applyConfigFromText(raw);
    return;
  }

  // Prova BarcodeDetector
  if ('BarcodeDetector' in window) {
    try{
      const det = new window.BarcodeDetector({ formats: ['qr_code'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      const video = document.createElement('video');
      video.playsInline = true; video.srcObject = stream; await video.play();

      const canvas = document.createElement('canvas');
      const scan = async () => {
        if (video.readyState >= 2) {
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0);
          const bmp = await createImageBitmap(canvas);
          const codes = await det.detect(bmp);
          if (codes && codes[0] && codes[0].rawValue) {
            raw = String(codes[0].rawValue||'');
            stream.getTracks().forEach(t=>t.stop());
            window.applyConfigFromText(raw);
            return;
          }
        }
        requestAnimationFrame(scan);
      };
      scan(); return;
    }catch(e){
      // fallback → prompt
    }
  }

  raw = prompt('Incolla qui il contenuto del QR config (JSON):');
  if (!raw) return;
  window.applyConfigFromText(raw);
};

// === MIGRAZIONE counters legacy → nuovo formato ===
(function migrateCounters(){
  let changed = false; let raw;
  try { raw = JSON.parse(localStorage.getItem('counters') || 'null'); } catch {}
  if (!raw || typeof raw !== 'object') return;
  const nowYear = new Date().getFullYear();
  const out = {};
  const ensureObj = (ser, year, last) => { if (!ser) return; const y=Number(year)||nowYear; const l=Number(last)||0; out[ser]={year:y,last:l}; changed=true; };
  const known = ['commesse','ddt','fatture','ore'];
  const yearKeys = Object.keys(raw).filter(k => /^\d{4}$/.test(k));
  if (yearKeys.length) {
    const yKey = yearKeys.sort().pop(); const inner = raw[yKey];
    if (inner && typeof inner === 'object') known.forEach(ser => { if (ser in inner) ensureObj(ser, Number(yKey), Number(inner[ser])); });
  }
  known.forEach(ser => { const v = raw[ser]; if (v && typeof v === 'object' && ('year' in v || 'num' in v)) ensureObj(ser, v.year, v.num); });
  if (!changed) {
    const looksNew = known.some(ser => raw[ser] && typeof raw[ser] === 'object' && 'year' in raw[ser] && 'last' in raw[ser]);
    if (!looksNew) known.forEach(ser => { if (typeof raw[ser] === 'number') ensureObj(ser, nowYear, raw[ser]); });
    else return;
  }
  try { localStorage.setItem('counters', JSON.stringify(out)); } catch {}
})();

// ================== PRINT HEADER (logo + dati azienda) ==================
(function ensurePrintCSS(){
  if (document.getElementById('anima-print-css')) return;
  const css = `
@media screen {.print-only{display:none}}
@media print {
  .no-print{display:none!important}
  .print-only{display:block!important}
  .print-header{display:flex; gap:16px; align-items:center; margin-bottom:12px}
  .print-header .logo{max-width:180px; max-height:60px; object-fit:contain}
  .print-header .info{font-size:12px; line-height:1.3}
  .print-header .title{font-weight:700; font-size:14px}
}`;
  const el = document.createElement('style'); el.id='anima-print-css'; el.textContent=css; document.head.appendChild(el);
})();
function PrintHeader(){
  const e = React.createElement;
   const app = lsGet('appSettings', {}) || {};
  const rows = [];
  if (app.ragioneSociale) rows.push(e('div', {key:'r', className:'title'}, app.ragioneSociale));
  if (app.sedeLegale)     rows.push(e('div', {key:'sl'}, `Sede legale: ${app.sedeLegale}`));
  if (app.sedeOperativa)  rows.push(e('div', {key:'so'}, `Sede operativa: ${app.sedeOperativa}`));
  if (app.pIva || app.email || app.telefono){
    const cont = [app.pIva?`P.IVA/CF: ${app.pIva}`:null, app.email||null, app.telefono||null].filter(Boolean).join(' • ');
    rows.push(e('div', {key:'ct'}, cont));
  }
  return e('div', {className:'print-header print-only'},
    app.logoDataUrl ? e('img', {src:app.logoDataUrl, alt:'Logo', className:'logo'}) : null,
    e('div', {className:'info'}, rows)
  );
}

// ================== Progressivi per anno (peek) ==================
window.COUNTERS_KEY = window.COUNTERS_KEY || 'counters';
function getCounters(){ try { return JSON.parse(localStorage.getItem(window.COUNTERS_KEY) || '{}'); } catch { return {}; } }
function setCounters(obj){
  try{
    localStorage.setItem(window.COUNTERS_KEY, JSON.stringify(obj));
    window.__anima_dirty = true;
  }catch{}
}

// NON incrementa: serve solo per mostrare l'anteprima dell'ID senza consumare numeri
function peekNextProgressivo(series){
  const y = new Date().getFullYear();
  const all = getCounters();
  const cur = all[series] || {};
  const next = (cur.year === y) ? ((cur.num || 0) + 1) : 1; // ← usa num, non last
  return { year: y, num: next };
}

// ================== NEXT ID PREVENTIVI (PV-YYYY-NNN) ==================
window.nextIdPV = window.nextIdPV || function nextIdPV(){
  // usa nextIdUnique se c’è, altrimenti nextProgressivo/counters
  const out = (window.nextIdUnique && window.nextIdUnique('pv','PV','preventiviRows'))
           || (window.nextIdSeries && window.nextIdSeries({ prefix:'PV', storageKey:'preventiviRows', seriesKey:'pv' }))
           || (()=> {
                const np = (window.nextProgressivo && window.nextProgressivo('pv'))
                        || { year:new Date().getFullYear(), num:1 };
                const n3 = (window.formatNNN? window.formatNNN(np.num) : String(np.num).padStart(3,'0'));
                return { id:`PV-${np.year}-${n3}`, year:np.year, num:np.num };
              })();
  return out.id || out;
};

// === Crea DDT rapido da commessa (1 riga "pz") =============================
window.createDDTRapidoFromCommessa = function(c){
  try{
    if (!c || !c.id) { alert('Commessa non valida'); return; }
    const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{return d;} });
    const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });
    const formatNNN = window.formatNNN || (n=>String(n).padStart(3,'0'));
    const nextProgressivo = window.nextProgressivo || (series => {
      const year = new Date().getFullYear();
      let counters = {}; try{ counters = JSON.parse(localStorage.getItem('counters')||'{}')||{}; }catch{}
      const cur = (counters[series] && counters[series].year === year) ? ((+counters[series].num||0)+1) : 1;
      counters[series] = { year, num: cur }; try{ localStorage.setItem('counters', JSON.stringify(counters)); }catch{}
      return { year, num: cur };
    });

    const today = new Date().toISOString().slice(0,10);
    const rows = lsGet('ddtRows', []) || [];
      const nid = (window.nextIdUnique && window.nextIdUnique('ddt','DDT','ddtRows'))
         || { id: `DDT-${new Date().getFullYear()}-001` };
      const id  = nid.id;


    const colli = Math.max(1, Number(c.colliPrevisti || 1));
    const qta   = Math.max(0, Number(c.qtaPezzi || 0));
    const riga  = {
      codice: c.codiceArticolo || '',
      descrizione: c.descrizione ? String(c.descrizione) : `Lavorazione commessa ${c.id}`,
      qta: qta,
      UM: 'pz',
      note: ''
    };

    const rec = {
      id, data: today,
      clienteId: c.clienteId || '',
      cliente: c.cliente || '',
      commessaRif: c.id,
      note: '',
      colli: String(colli),
      righe: [riga],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    rows.push(rec); lsSet('ddtRows', rows);
    window.__anima_dirty = true;
    alert(`DDT creato: ${id}`);
    try{ window.syncExportToCloudOnly && window.syncExportToCloudOnly(['ddtRows']); }catch{}
  }catch(e){ console.error(e); alert('Errore creazione DDT'); }
};

function applyCloudQtyToCommessa(commessaId, faseIdx, qty){
  try{
    const cid = (commessaId != null) ? String(commessaId) : '';
    const q   = Math.max(0, Number(qty || 0));
    if (!cid || !q) return;

    const all = lsGet('commesseRows', []);
    const ix  = all.findIndex(c => String(c.id) === cid);
    if (ix < 0) return;

    const c = { ...all[ix] };
    const totComm = Math.max(1, Number(c.qtaPezzi || 1));

    // 1) Se esiste la fase globale, aggiorno quella
    let didPerFase = false;
    const fIdx = (faseIdx == null ? null : Number(faseIdx));
    if (Array.isArray(c.fasi) && Number.isFinite(fIdx) && fIdx >= 0 && c.fasi[fIdx]){
      const prevF = Math.max(0, Number(c.fasi[fIdx].qtaProdotta || 0));
      const nuovo = Math.max(0, Math.min(totComm, prevF + q));
      c.fasi = c.fasi.map((f, j) =>
        j === fIdx ? { ...f, qtaProdotta: nuovo } : f
      );
      didPerFase = true;
    }

    // 2) Ricalcolo q.tà prodotta totale
    if (didPerFase){
      // uso la stessa logica centrale
      c.qtaProdotta = producedPieces(c);
    } else {
      // fallback: non ho fasi → aumento direttamente qtaProdotta
      const prev = Math.max(0, Number(c.qtaProdotta || 0));
      c.qtaProdotta = Math.max(0, Math.min(totComm, prev + q));
    }

    all[ix] = c;
    lsSet('commesseRows', all);
    window.__anima_dirty = true;

    // 3) Se ho appena completato la commessa, gestisco etichette (come in Timbratura)
    const prod = (typeof window.producedPieces === 'function')
      ? window.producedPieces(c)
      : Math.max(0, Number(c.qtaProdotta || 0));
    const justCompleted = (prod >= totComm) && !c.__completedAt;
    if (justCompleted){
      c.__completedAt = new Date().toISOString();
      all[ix] = c; lsSet('commesseRows', all);
      try{
        if (typeof window.openEtichetteColliDialog === 'function'){
          window.openEtichetteColliDialog(c);
        } else if (typeof window.triggerEtichetteFor === 'function'){
          window.triggerEtichetteFor(c, {});
        }
      }catch(e){}
    }
  }catch(e){
    console.warn('applyCloudQtyToCommessa failed', e);
  }
}

// === Core produzione: pezzi COMPLETATI per commessa/righe, da timbrature ===

// helper condiviso: normalizza il nome fase (togli accenti, porta a minuscolo)
const deaccentPhaseName = s => String(s || '')
  .normalize('NFD')
  .replace(/\p{Diacritic}/gu,'')
  .toLowerCase()
  .trim();

// helper condiviso: riconosce fasi "una tantum" (flag o nome "preparazione attività")
const isOncePhaseCore = (f) => {
  if (!f) return false;
  if (f.once === true || f.unaTantum === true) return true;
  const name = deaccentPhaseName(f.lav || f.nome || f.label || '');
  if (!name) return false;
  return /(^|[^a-z])preparazione\s+attivita([^a-z]|$)/.test(name);
};

// Pezzi completati per UNA riga articolo, secondo il modello:
// Q_completati[R] = min_fase( clamp(sum(qtaPezzi timbrate su F), Q_riga) )
function producedPiecesRowCore(c, rigaIdx, oreRows){
  if (!c) return 0;

  const idx = Number(rigaIdx);
  if (!Number.isFinite(idx) || idx < 0) return 0;

  const righe = Array.isArray(c.righeArticolo)
    ? c.righeArticolo
    : (Array.isArray(c.righe) ? c.righe : []);

  const r = righe[idx];
  if (!r) return 0;

  const qRiga = Math.max(0, Number(r.qta || r.qtaPezzi || 0));
  if (qRiga <= 0) return 0;

  const fasiR = Array.isArray(r.fasi) ? r.fasi : [];
  const processIdx = [];
  for (let j = 0; j < fasiR.length; j++){
    const f = fasiR[j];
    if (!f) continue;
    if (isOncePhaseCore(f)) continue;
    processIdx.push(j);
  }

  // Considero solo timbrature non cancellate
  const all = Array.isArray(oreRows)
    ? oreRows.filter(o => !o || !o.deletedAt)
    : [];
  const jobIdStr = String(c.id || '');

  const evRow = all.filter(o =>
    String(((o && o.commessaId) || '')) === jobIdStr &&
    Number(o && o.rigaIdx) === idx
  );

  // Se ho fasi di processo definite
  if (processIdx.length){
    if (evRow.length){
      const perFase = processIdx.map(phaseIdx => {
        const sum = evRow
          .filter(o => Number(o && o.faseIdx) === phaseIdx)
          .reduce((acc, o) => acc + Math.max(0, Number(o.qtaPezzi || 0)), 0);
        const clamped = Math.min(qRiga, sum);
        return clamped;
      }).filter(v => Number.isFinite(v) && v >= 0);

      if (!perFase.length) return 0;
      const min = Math.min(...perFase);
      return Math.max(0, Math.min(qRiga, min));
    }

    // Nessuna timbratura sulla riga: fallback legacy su qtaProdotta per fase
    const perFaseLegacy = processIdx.map(phaseIdx => {
      const f = fasiR[phaseIdx] || {};
      return Math.max(0, Number(f.qtaProdotta || 0));
    }).filter(v => Number.isFinite(v) && v >= 0);

    if (!perFaseLegacy.length) return 0;
    const minLegacy = Math.min(...perFaseLegacy);
    return Math.max(0, Math.min(qRiga, minLegacy));
  }

  // Nessuna fase di processo: riga "non tracciata" su oreRows.
  // Caso particolare:
  // - se esistono fasi ma sono tutte "una tantum" → NON producono pezzi
  // - se NON esistono fasi (riga legacy pura) → uso ancora r.qtaProdotta
  if (!evRow.length){
    const hasAnyFasi = Array.isArray(fasiR) && fasiR.length;
    if (hasAnyFasi){
      // Abbiamo fasi ma nessuna di processo (solo una tantum / preparazioni):
      // per coerenza di modello → 0 pezzi prodotti
      return 0;
    }

    // Riga legacy senza nessuna fase collegata → manteniamo compat su qtaProdotta
    const legacy = Math.max(0, Number(r.qtaProdotta || 0));
    return Math.max(0, Math.min(qRiga, legacy));
  }

  // Ho timbrature ma solo su fasi "una tantum" → non producono pezzi
  return 0;
}

// Pezzi completati per COMMESSA:
// - se ho fasi per-riga + timbrature → somma dei pezzi completati per riga
// - altrimenti uso le fasi globali / legacy (come prima)
function producedPieces(c, oreRows){
  if (!c) return 0;

  const totComm = Math.max(1, Number(c.qtaPezzi || c.qta || 0));

  const righe = Array.isArray(c.righeArticolo)
    ? c.righeArticolo
    : (Array.isArray(c.righe) ? c.righe : []);

  const hasRowFasi = righe.some(r =>
    Array.isArray(r && r.fasi) && r.fasi.length);

  // Considero solo timbrature non cancellate
  const all = Array.isArray(oreRows)
    ? oreRows.filter(o => !o || !o.deletedAt)
    : [];
  const jobIdStr = String(c.id || '');
  const evJob = all.filter(o =>
    String(((o && o.commessaId) || '')) === jobIdStr
  );

  // === Caso 1: fasi per-riga ===
  if (righe.length && hasRowFasi){
    // 1a) Se ho timbrature → uso il modello "min per fase" per ogni riga
    if (evJob.length){
      let sumRows = 0;
      for (let idx = 0; idx < righe.length; idx++){
        const r = righe[idx];
        if (!r) continue;
        const qRiga = Math.max(0, Number(r.qta || r.qtaPezzi || 0));
        if (qRiga <= 0) continue;

        const qCompl = producedPiecesRowCore(c, idx, all);
        sumRows += Math.max(0, Math.min(qRiga, qCompl));
      }

      const totRighe = righe.reduce(
        (S, r) => S + Math.max(0, Number(r && (r.qta || r.qtaPezzi) || 0)),
        0
      );
      const totAtteso = totRighe > 0 ? totRighe : totComm;
      return Math.max(0, Math.min(totAtteso, sumRows));
    }

    // 1b) Nessuna timbratura: manteniamo la logica legacy basata su fasi.qtaProdotta
    let sum = 0;
    for (const r of righe){
      if (!r) continue;
      const totRiga = Math.max(0, Number(r.qta || 0));
      if (totRiga <= 0) continue;

      const fasiR = Array.isArray(r.fasi) ? r.fasi : [];
      const quant = fasiR
        .filter(f => !isOncePhaseCore(f))
        .map(f => Math.max(0, Number((f && f.qtaProdotta) || 0)));

      let prodRiga = 0;
      if (quant.length){
        prodRiga = Math.min(...quant);
      } else {
        // fallback compat (riga senza fasi quantitative)
        prodRiga = Math.max(0, Number(r.qtaProdotta || 0));
      }

      sum += Math.max(0, Math.min(totRiga, prodRiga));
    }

    const totRighe = righe.reduce(
      (S, r) => S + Math.max(0, Number(r && r.qta || 0)),
      0
    );
    const totAtteso = totRighe > 0 ? totRighe : totComm;
    return Math.max(0, Math.min(totAtteso, sum));
  }

  // === Caso 2: logica globale (come prima) ===
  const fasi = Array.isArray(c.fasi) ? c.fasi : [];

  // Nessuna timbratura per la commessa → fallback legacy
  if (!evJob.length){
    const fasiLegacy = Array.isArray(fasi) ? fasi : [];
    if (!fasiLegacy.length){
      // Commessa legacy senza nessuna fase → compat su c.qtaProdotta
      return Math.max(0, Math.min(totComm, Number(c.qtaProdotta || 0) || 0));
    }

    const arr = fasiLegacy
      .filter(f => !isOncePhaseCore(f))
      .map(f => Math.max(0, Number((f && f.qtaProdotta) || 0)));

    if (!arr.length){
      // Abbiamo fasi, ma tutte "una tantum" (preparazioni, setup, ecc.):
      // per coerenza del modello → 0 pezzi prodotti
      return 0;
    }

    const min = Math.min(...arr);
    return Math.max(0, Math.min(totComm, min));
  }

  // Ho timbrature: uso per-fase (ignorando le una tantum) come prima
  if (fasi.length){
    const perFaseQuant = [];
    fasi.forEach((f, idx) => {
      if (isOncePhaseCore(f)) return;
      const s = evJob
        .filter(o => Number(o && o.faseIdx) === Number(idx))
        .reduce((acc, o) => acc + Math.max(0, Number(o.qtaPezzi || 0)), 0);
      perFaseQuant.push(Math.max(0, s));
    });

    if (!perFaseQuant.length){
      const sumEv = evJob.reduce(
        (acc, o) => acc + Math.max(0, Number(o.qtaPezzi || 0)),
        0
      );
      return Math.max(0, Math.min(totComm, sumEv));
    }

    const min = Math.min(...perFaseQuant);
    return Math.max(0, Math.min(totComm, min));
  }

  // Nessuna fasi globali: sommo tutte le timbrature (ultimo fallback compat)
  const sumEv = evJob.reduce(
    (acc, o) => acc + Math.max(0, Number(o.qtaPezzi || 0)),
    0
  );
  return Math.max(0, Math.min(totComm, sumEv));
}

// Residuo = totale commessa − pezzi completati (stessa logica ovunque)
function residualPieces(c, oreRows){
  const tot = Math.max(1, Number((c && (c.qtaPezzi || c.qta)) || 1));
  return Math.max(0, tot - producedPieces(c, oreRows));
}

// Espone gli helper "core" a 2 argomenti (commessa + oreRows)
// così le viste (es. Commesse, Dashboard, Timbratura) possono leggere
// sempre la stessa definizione di "pezzi prodotti" / residuo.
if (typeof window !== 'undefined') {
  window.producedPiecesCore    = window.producedPiecesCore    || producedPieces;
  window.producedPiecesRowCore = window.producedPiecesRowCore || producedPiecesRowCore;
  window.residualPiecesCore    = window.residualPiecesCore    || residualPieces;
}

// Compat: assegna window.producedPieces a un wrapper che usa sempre la logica "core"
// basata sulle ore correnti salvate in locale. In questo modo anche le viste
// legacy che chiamano window.producedPieces(c) vedono la stessa definizione
// di "pezzi prodotti" usata da Commesse / Timbratura / Dashboard.
if (typeof window !== 'undefined') {
  window.producedPieces = function(c){
    try{
      const ore = (typeof lsGet === 'function') ? lsGet('oreRows', []) : [];
      const fn  = window.producedPiecesCore || producedPieces;
      return fn(c, ore);
    } catch(err){
      console.error('producedPieces wrapper error', err);
      // Fallback conservativo: se ho c.qtaProdotta uso quella, altrimenti 0
      return Math.max(0, Number(c && (c.qtaProdotta || 0)));
    }
  };
}

// ================== Backup / Restore ==================
function makeBackupBlob(){
  const payload = { version: 1, ts: new Date().toISOString(), data: {} };
  for(const k of BACKUP_KEYS){
    try { payload.data[k] = JSON.parse(localStorage.getItem(k) || 'null'); }
    catch { payload.data[k] = null; }
  }
  const str = JSON.stringify(payload, null, 2);
  return new Blob([str], {type:'application/json'});
}
function downloadBackup(){
  const blob = makeBackupBlob();
  const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.href = URL.createObjectURL(blob);
  a.download = `ANIMA-backup-${stamp}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
async function restoreFromFile(file){
  const txt = await file.text();
  let payload;

  // 1) Parsing JSON
  try {
    payload = JSON.parse(txt);
  } catch {
    alert('Backup non valido (JSON illeggibile)');
    return;
  }

  if (!payload || typeof payload !== 'object') {
    alert('Backup non valido (formato sconosciuto)');
    return;
  }

  // 2) Supporta due formati:
  //    A) Vecchio: { version, ts, data: { ... } }
  //    B) Nuovo:  { __meta, appSettings, commesseRows, ... } senza "data"
  const dataBlock =
    (payload.data && typeof payload.data === 'object')
      ? payload.data
      : payload;

  // 3) Scrivi TUTTE le chiavi del backup nel localStorage
  let touched = 0;
  for (const k of Object.keys(dataBlock)) {
    // se vuoi, puoi saltare chiavi di metadati:
    // if (k.startsWith('__')) continue;

    const v = dataBlock[k];
    if (typeof v === 'undefined') continue;
    try {
      localStorage.setItem(k, JSON.stringify(v));
      touched++;
    } catch (e) {
      console.error('[restore] errore setItem su', k, e);
      alert('Ripristino incompleto: memoria del browser piena o dato non scrivibile.\n' +
            'Riduci la dimensione del backup o abilita/usa il cloud.\n' +
            'Chiave fallita: ' + k);
      return;
    }
  }
  // Ripristino = modifica massiva dataset: marca dirty per eventuale push/snapshot
  window.__anima_dirty = true;

  if (!touched) {
    alert('Backup non valido (nessuna chiave riconosciuta)');
    return;
  }

  alert('Ripristino completato ✅\nRicarico la pagina per applicare i dati.');
  location.reload();
}

// Salvataggio robusto su localStorage con messaggio chiaro se va in errore (quota piena, ecc.)
window.safeSetJSON = function(key, value){
  try{
    localStorage.setItem(key, JSON.stringify(value));
    window.__anima_dirty = true;
    return true;
  }catch(e){
    console.error('[LS SAVE]', e);
    alert('Salvataggio non riuscito: dati troppo grandi o memoria del browser piena.\nRiduci il file / abilita il salvataggio cloud.');
    return false;
  }
};
// Non sovrascrivere lsSet se già esiste (serve per BETA namespace e logiche preesistenti).
// Espone comunque safeSetJSON come salvataggio "robusto" (con alert su quota piena).
window.lsSet = window.lsSet || window.safeSetJSON;

/* ================== Widget: Cloud/Supabase status ================== */
function CloudStatusWidget(){
  const e = React.createElement;
  const s = (function(){ try { return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch { return {}; } })();
  const on  = !!(window.__cloudSync__ && window.__cloudSync__.enabled);
  const lastPullTs = window.__anima_lastPull ? new Date(window.__anima_lastPull) : null;
  const lastPushTs = window.__anima_lastPush ? new Date(window.__anima_lastPush) : null;
  const lastErr    = window.__cloud_lastErr || '';

  const fmt = (d)=> d ? `${d.toLocaleDateString()} ${d.toLocaleTimeString()}` : '—';

  return e('div', { className:'card', style:{minWidth:280} },
    e('div', { className:'row', style:{justifyContent:'space-between', alignItems:'center'} },
      e('h3', null, 'Cloud'),
      e('div', { style:{fontWeight:'bold', color: on ? '#1a7f37' : '#b54708'} },
        on ? '● ON' : '● OFF'
      )
    ),
    e('div', { className:'muted' }, s.cloudEnabled ? 'Abilitato' : 'Disabilitato'),
    e('div', { style:{marginTop:8} },
      e('div', null, e('strong', null, 'Ultimo import:'), ' ', fmt(lastPullTs)),
      e('div', null, e('strong', null, 'Ultimo export:'), ' ', fmt(lastPushTs)),
    ),
    lastErr ? e('div', { style:{marginTop:8, color:'#b42318'} }, 'Errore: ', lastErr) : null,
    e('div', { className:'row', style:{gap:8, marginTop:10, flexWrap:'wrap'} },
      e('button', { className:'btn btn-sm', onClick:()=>window.syncImportFromCloud && window.syncImportFromCloud() }, '⬇️ Importa'),
      e('button', { className:'btn btn-sm', onClick:()=>window.syncExportToCloud && window.syncExportToCloud() }, '⬆️ Esporta')
    )
  );
}
// Ordina per data più recente (fallback su createdAt/updatedAt) e poi per id desc
function sortNewestFirst(arr, { dateKeys=['data','dataDocumento','createdAt','updatedAt'], idKey='id' } = {}) {
  return (arr||[]).slice().sort((a,b)=>{
    const maxDate = (o)=> dateKeys.reduce((M,k)=> Math.max(M, Date.parse(o?.[k]||0) || 0), 0);
    const ta = maxDate(a), tb = maxDate(b);
    if (tb !== ta) return tb - ta;
    return String(b?.[idKey]||'').localeCompare(String(a?.[idKey]||''));
  });
}
// ================== STAMPA COMMESSA v2 (layout "foto") ==================
window.stampaCommessaV2 = function (r) {
  try {
    const app = (function () {
      try {
        return JSON.parse(localStorage.getItem('appSettings') || '{}') || {};
      } catch {
        return {};
      }
    })();

    // --- helpers ---
    const fmtIT = d => d ? new Date(d).toLocaleDateString('it-IT') : '';
    const pad2 = n => String(n).padStart(2, '0');
    const hhmm2min = s => {
      const m = String(s || '').trim().match(/^(\d{1,3})(?::([0-5]?\d))?$/);
      if (!m) return 0;
      const h = +m[1] || 0, mm = +(m[2] || 0) || 0;
      return h * 60 + mm;
    };
    const min2hhmm = m => `${pad2(Math.floor((+m || 0) / 60))}:${pad2((+m || 0) % 60)}`;
    const esc = s => {
      s = (s == null ? '' : String(s));
      return s.replace(/[&<>"']/g, ch => (
        ch === '&' ? '&amp;' :
        ch === '<' ? '&lt;' :
        ch === '>' ? '&gt;' :
        ch === '"' ? '&quot;' :
        /* ch === "'" */ '&#39;'
      ));
    };

    if (!r || typeof r !== 'object') {
      alert('Commessa non valida');
      return;
    }

    // --- campi principali commessa ---
    const ID = r.id || r.codice || '';
    const TIT = r.titolo || r.descrizione || r.tipoArticolo || '-';

    let CLIENTE = '';
    if (r.cliente && typeof r.cliente === 'object') {
      CLIENTE =
        r.cliente.ragioneSociale ||
        r.cliente.ragione ||
        r.cliente.denominazione ||
        r.cliente.nome ||
        '';
    }
    CLIENTE = CLIENTE || r.clienteRagione || r.cliente_nome || r.cliente || '';

    const PRIO = String(r.priorita || r.priority || '').toUpperCase();
    const DUE = r.dataConsegna || r.scadenza || r.data_scadenza || '';

    // riferimento ordine cliente: preferiamo l'oggetto rifCliente {tipo, numero, data}
    const RIF_ORD = (function(){
      const src = r.rifCliente;
      try{
        if (src && typeof src === 'object') {
          const tipoRaw = String(src.tipo || 'Ordine').trim();
          const tipo    = tipoRaw ? (tipoRaw.charAt(0).toUpperCase() + tipoRaw.slice(1)) : 'Ordine';
          const num     = String(src.numero || '').trim();
          let dataLabel = '';
          if (src.data) {
            const s = String(src.data).trim();
            // se è ISO uso fmtIT, altrimenti lascio la stringa così
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
              dataLabel = fmtIT(s);
            } else {
              dataLabel = s;
            }
          }
          let base = num ? `${tipo} ${num}` : tipo;
          if (dataLabel) base += ` del ${dataLabel}`;
          return base;
        }
      }catch{}
      // fallback legacy: vecchi campi stringa
      return (
        r.rifOrdineCliente ||
        r.ordineCliente ||
        r.rifOrdine ||
        r.ordineClienteNumero ||
        ''
      );
    })();

    const PEZZI = Number(r.qtaPezzi || r.pezziTotali || 0) || 0;

    // --- fasi globali (legacy, usate per istruzioni di fallback) ---
    const fasiGlobal = Array.isArray(r.fasi) ? r.fasi.map((f, i) => ({
      lav: f.lav || f.nome || f.descr || f.descrizione || `Fase ${i + 1}`,
      hhmm: f.hhmm || f.durata || f.tempo || f.hh || f.min
        ? (f.hhmm || (f.min ? min2hhmm(f.min) : ''))
        : (f.durataHHMM || '')
    })) : [];

    // --- righe articolo + fasi per riga ---
    const righeArt = Array.isArray(r.righeArticolo) ? r.righeArticolo : [];

    // c'è almeno una riga con fasi "vere"?
    const hasRowPhases = righeArt.some(row =>
      Array.isArray(row?.fasi) &&
      row.fasi.some(f => {
        try {
          if (typeof window !== 'undefined' && typeof window.plannedMinsFromFase === 'function') {
            if (window.plannedMinsFromFase(f) > 0) return true;
          } else if (typeof plannedMinsFromFase === 'function') {
            if (plannedMinsFromFase(f) > 0) return true;
          }
        } catch { }
        const name = String(f?.lav || f?.nome || f?.descr || f?.descrizione || '').trim();
        return !!name;
      })
    );

    // --- ore previste header (usa funzione "smart" se c'è) ---
    let orePerPezzo = '00:00';
    let oreTotPrev = '00:00';
    let totalPlannedMins = 0; // somma minuti pianificati dalle fasi per-riga (se presenti)
    try {
      const pezzi = Math.max(1, PEZZI || 0);
      const fnSmart =
        (typeof window !== 'undefined' && typeof window.plannedMinTotalCommessaSmart === 'function')
          ? window.plannedMinTotalCommessaSmart
          : (typeof plannedMinTotalCommessaSmart === 'function'
            ? plannedMinTotalCommessaSmart
            : null);

      if (fnSmart) {
        const totMin = Number(fnSmart(r)) || 0;
        oreTotPrev = totMin ? min2hhmm(totMin) : '00:00';
        totalPlannedMins = totMin;

        // tempo per pezzo: stessa definizione del Report (plannedMinPerPiece)
        let perMin = 0;
        try {
          if (typeof plannedMinPerPiece === 'function') {
            perMin = Number(plannedMinPerPiece(r)) || 0;
          }
        } catch (e2) {
          perMin = 0;
        }

        // fallback di sicurezza: se perMin non viene fuori, uso tot/pezzi
        if (perMin <= 0 && pezzi > 0) {
          perMin = Math.round(totMin / pezzi);
        }

        orePerPezzo = perMin > 0 ? min2hhmm(perMin) : '00:00';
      } else if (r.oreTotaliPrev != null) {
        const totMin = Number(r.oreTotaliPrev) || 0;
        if (totMin > 0) {
          oreTotPrev = min2hhmm(totMin);
          const perMin = pezzi > 0 ? Math.round(totMin / pezzi) : 0;
          if (perMin > 0) orePerPezzo = min2hhmm(perMin);
        }
      }

      // se più codici articolo, il tempo per pezzo medio è poco significativo
      const codes = new Set();
      righeArt.forEach(row => {
        const codice = row && (row.codice || row.codArticolo || row.cod);
        if (codice) codes.add(String(codice));
      });
      if (codes.size > 1) {
        orePerPezzo = '--';
      }
    } catch (e) {
      console.error('Errore calcolo ore previste in stampaCommessaV2:', e);
    }

    // --- materiali previsti ---
    const mats0 = Array.isArray(r.materialiPrevisti) ? r.materialiPrevisti
      : Array.isArray(r.materiali) ? r.materiali : [];
    const materiali = mats0.map(m => ({
      codice: String(m.codice || ''),
      descr: String(m.descr || m.descrizione || ''),
      um: String(m.um || ''),
      qta: (m.qta != null ? m.qta : (m.quantita != null ? m.quantita : '')) || '',
      note: String(m.note || '')
    }));

    // --- istruzioni ---
    const istrTxt = r.istruzioni;
    let istruzioni = [];
    if (Array.isArray(istrTxt)) {
      istruzioni = istrTxt.map(x => String(x).trim()).filter(Boolean);
    } else if (typeof istrTxt === 'string') {
      istruzioni = istrTxt.split(/\r?\n|;|•|- /).map(s => s.trim()).filter(Boolean);
    } else if (fasiGlobal.length) {
      istruzioni = fasiGlobal.map(f => f.lav).filter(Boolean);
    }

    // --- logo + QR URL ---
    const logo = app.logoDataUrl || '';
    const qrUrl = (function () {
      try {
        const cfgBase = (app.publicBaseUrl && String(app.publicBaseUrl).trim()) || '';
        if (cfgBase) {
          const base = cfgBase.replace(/\/+$/, '');
          return `${base}/#/timbratura?job=${encodeURIComponent(ID)}`;
        }
        const base = location.origin + location.pathname;
        return `${base}#/timbratura?job=${encodeURIComponent(ID)}`;
      } catch {
        return `#/timbratura?job=${encodeURIComponent(ID)}`;
      }
    })();

    // dati azienda per intestazione
    const aziendaNome = app.ragioneSociale || app.aziendaNome || '';
    const aziendaIndirizzo =
      app.sedeOperativa ||
      app.sedeLegale ||
      [app.indirizzo, app.cap, app.citta, app.provincia].filter(Boolean).join(' ');
    const aziendaPiva = app.piva || app.pIva || app.codiceFiscale || '';

    // --- CSS (A4 verticale) ---
    const css = `
      <style>
        *{box-sizing:border-box}
        body{
          font-family: Arial, Helvetica, sans-serif;
          color:#222;
          margin:20px;
          font-size:12px;
        }

        .muted{color:#666;}
        td.right, th.right{text-align:right;}

        /* Intestazione ANIMA + box COMMESSA */
        .cm-header{
          display:flex;
          justify-content:space-between;
          align-items:flex-start;
          margin-bottom:8px;
        }
        .cm-azienda{
          display:flex;
          gap:8px;
          align-items:flex-start;
        }
        .cm-logo{
          height:48px;
          border:1px solid #ddd;
          padding:4px;
          border-radius:4px;
        }
        .cm-azienda-text{
          font-size:10px;
          line-height:1.3;
        }
        .cm-azienda-ragione{
          font-weight:700;
          font-size:13px;
          margin-bottom:2px;
        }

        .cm-commessa-box{
          text-align:right;
          font-size:11px;
        }
        .cm-commessa-title{
          font-size:16px;
          font-weight:700;
          margin-bottom:4px;
        }
        .cm-commessa-id,
        .cm-commessa-date{
          font-size:11px;
        }

        /* Riquadro centrale + QR */
        .cm-row2{
          display:flex;
          justify-content:space-between;
          align-items:flex-start;
          gap:12px;
          margin-top:8px;
        }
        .cm-riep{
          border-collapse:collapse;
          width:65%;
          font-size:11px;
        }
        .cm-riep th,
        .cm-riep td{
          border:1px solid #000;
          padding:3px 6px;
        }
        .cm-riep th{
          background:#f7f7f7;
          text-align:left;
          width:38%;
        }
        .cm-riep-cliente{
          font-size:13px;
          font-weight:700;
        }

        .cm-qr-card{
          width:30%;
          border:1px solid #000;
          padding:6px;
          text-align:center;
        }
        .cm-qr-code{
          margin-bottom:4px;
        }
        .cm-qr-label{
          font-size:10px;
          margin-top:4px;
        }

        /* Tabelle generali */
        table{
          width:100%;
          border-collapse:collapse;
          margin-top:8px;
        }
        th,td{
          border:1px solid #ccc;
          padding:6px;
          text-align:left;
        }
        th{background:#f7f7f7;}

        h3{
          font-size:14px;
          margin:14px 0 6px;
        }
        .ibox{
          border:1px dashed #bbb;
          border-radius:6px;
          padding:10px;
          min-height:48px;
        }
        ul{margin:6px 0 0 18px;}

        @page { size:A4 portrait; margin:0; }
        @media print{
          body{margin:16mm;}
          .no-print{display:none!important;}
        }
      </style>
    `;

    // --- calcolo fasi per riga / globali ---

    // helper minuti da fase (usa HH:MM se presente, altrimenti plannedMinsFromFase)
    function minsFromFase(f) {
      const rawHHMM = String(
        f?.orePrevHHMM ||
        f?.oreHHMM ||
        f?.hhmm ||
        f?.orePrev ||
        f?.durataHHMM ||
        ''
      ).trim();

      let mins = 0;
      if (rawHHMM) {
        mins = hhmm2min(rawHHMM);
      } else {
        try {
          if (typeof window !== 'undefined' && typeof window.plannedMinsFromFase === 'function') {
            mins = window.plannedMinsFromFase(f);
          } else if (typeof plannedMinsFromFase === 'function') {
            mins = plannedMinsFromFase(f);
          }
        } catch { }
      }
      if (!Number.isFinite(mins)) mins = 0;
      return mins;
    }

    const fasiHeaderHTML = (hasRowPhases && righeArt.length) ? `
          <thead>
            <tr>
              <th>Codice</th>
              <th>Descrizione</th>
              <th class="right">Q.tà</th>
              <th class="right">TOT HH:MM / pz</th>
              <th>Fase</th>
              <th class="right">HH:MM / pz</th>
              <th class="right">HH:MM tot</th>
            </tr>
          </thead>` : `
          <thead>
            <tr>
              <th class="right">#</th>
              <th>Lavorazione</th>
              <th class="right">HH:MM per fase</th>
              <th class="right">Q.tà</th>
            </tr>
          </thead>`;

    const fasiEmptyRow = (hasRowPhases && righeArt.length)
      ? `<tr><td colspan="7" class="muted">Nessuna fase impostata</td></tr>`
      : `<tr><td colspan="4" class="muted">Nessuna fase impostata</td></tr>`;

    const fasiRows = (function () {
      // Caso nuovo: fasi per riga articolo
      if (hasRowPhases && righeArt.length) {
        const rowsHTML = [];

        righeArt.forEach(row => {
          const codice = (row && (row.codice || row.codArticolo || row.cod)) || '';
          const descr = (row && (row.descrizione || row.descr || row.titolo)) || '';
          const qtaRow = Math.max(1, Number(row?.qta || row?.qtaPezzi || row?.quantita || PEZZI || 1));

          const rowFasi = Array.isArray(row?.fasi) ? row.fasi : [];
          if (!rowFasi.length) return;

          // TOT per pezzo dell'articolo = somma fasi non una-tantum
          let perPieceTotMinsArt = 0;
          rowFasi.forEach(f => {
            const mins = minsFromFase(f);
            const isOnce = !!(f.unaTantum || f.once);
            if (!isOnce) perPieceTotMinsArt += mins;
          });
          const hhmmTotPerPezzoArt = perPieceTotMinsArt ? min2hhmm(perPieceTotMinsArt) : '';

          // righe di dettaglio fasi
          rowFasi.forEach((f, idx) => {
            const mins = minsFromFase(f);
            const isOnce = !!(f.unaTantum || f.once);
            const perPieceMins = isOnce ? 0 : mins;
            const totMins = isOnce ? mins : mins * qtaRow;

            if (totMins > 0) {
              totalPlannedMins += totMins;
            }

            rowsHTML.push(`
              <tr>
                <td>${idx === 0 ? esc(codice) : ''}</td>
                <td>${idx === 0 ? esc(descr) : ''}</td>
                <td class="right">${idx === 0 ? qtaRow : ''}</td>
                <td class="right">${idx === 0 ? hhmmTotPerPezzoArt : ''}</td>
                <td>${esc(f.lav || f.nome || f.descr || f.descrizione || '')}</td>
                <td class="right">${perPieceMins ? min2hhmm(perPieceMins) : ''}</td>
                <td class="right">${totMins ? min2hhmm(totMins) : ''}</td>
              </tr>
            `);
          });
        });

        return rowsHTML.join('');
      }

      // Fallback legacy: fasi globali (commessa senza fasi per riga)
      return (fasiGlobal.length ? fasiGlobal : []).map((f, i) => `
        <tr>
          <td class="right">${i + 1}</td>
          <td>${esc(f.lav || '')}</td>
          <td class="right">${f.hhmm || ''}</td>
          <td class="right">${PEZZI || 0}</td>
        </tr>
      `).join('');
    })();

    // Se abbiamo fasi per-riga e un totale calcolato, usiamo quello per le “Ore totali (previste)”
    if (hasRowPhases && totalPlannedMins > 0) {
      oreTotPrev = min2hhmm(totalPlannedMins);
    }

    const matRows = (materiali.length ? materiali : []).map(m => `
      <tr>
        <td>${m.codice}</td>
        <td>${m.descr}</td>
        <td>${m.um}</td>
        <td class="right">${m.qta}</td>
        <td>${m.note || ''}</td>
      </tr>
    `).join('');

    const istrList = (istruzioni.length
      ? `<ul>${istruzioni.map(x => `<li>${esc(x)}</li>`).join('')}</ul>`
      : '');

    const html = `
      <html>
      <head><meta charset="utf-8">${css}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
      </head>
      <body>
        <div class="cm-header">
          <div class="cm-azienda">
            ${logo
              ? `<img class="cm-logo" src="${logo}" alt="logo">`
              : `<div class="muted">[Logo non impostato]</div>`}
            <div class="cm-azienda-text">
              <div class="cm-azienda-ragione">${esc(aziendaNome || '')}</div>
              ${aziendaIndirizzo ? `<div>${esc(aziendaIndirizzo)}</div>` : ''}
              ${aziendaPiva ? `<div>P.IVA: ${esc(aziendaPiva)}</div>` : ''}
            </div>
          </div>
          <div class="cm-commessa-box">
            <div class="cm-commessa-title">COMMESSA</div>
            <div class="cm-commessa-id">ID: ${esc(ID || '')}</div>
            <div class="cm-commessa-date">
              Data: ${fmtIT(r.data || r.dataCommessa || r.dataDocumento || r.createdAt || '') || ''}
            </div>
          </div>
        </div>

        <div class="cm-row2">
          <table class="cm-riep">
            <tr>
              <th>Cliente</th>
              <td class="cm-riep-cliente">${esc(CLIENTE || '-')}</td>
            </tr>
            <tr>
              <th>Pezzi totali</th>
              <td>${PEZZI || 0}</td>
            </tr>
            <tr>
              <th>Ore totali (previste)</th>
              <td>${oreTotPrev}</td>
            </tr>
            <tr>
              <th>Scadenza</th>
              <td>${fmtIT(DUE) || '-'}</td>
            </tr>
            <tr>
              <th>Rif. ordine cliente</th>
              <td>${esc(RIF_ORD || '')}</td>
            </tr>

            <tr>
              <th>Priorità</th>
              <td>${PRIO || '-'}</td>
            </tr>
          </table>

          <div class="cm-qr-card">
            <div class="cm-qr-code">
              <canvas id="qr"></canvas>
            </div>
            <div class="cm-qr-label">QR Timbratura</div>
          </div>
        </div>

        <h3>Articoli da lavorare e fasi</h3>
        <table>
          ${fasiHeaderHTML}
          <tbody>
            ${fasiRows || fasiEmptyRow}
          </tbody>
        </table>

        <h3>Materiali previsti</h3>
        <table>
          <thead><tr><th>Codice</th><th>Descrizione</th><th>UM</th><th class="right">Q.tà</th><th>Note</th></tr></thead>
          <tbody>
            ${matRows || `<tr><td colspan="5" class="muted">Nessun materiale</td></tr>`}
          </tbody>
        </table>

        <h3>Istruzioni</h3>
        <div class="ibox">
          ${istrList || '<div class="muted">—</div>'}
        </div>

        <script>
          try {
            var c = document.getElementById('qr');
            new QRious({ element: c, value: ${JSON.stringify('' + (qrUrl || ''))}, size: 140 });
          } catch(e) { /* ignore */ }
          // La stampa viene gestita dal wrapper esterno (safePrintHTMLStringWithPageNum / iframe)
        </script>
      </body></html>
    `;

    // --- stampa tramite wrapper unico (no doppio popup) ---
    if (window.safePrintHTMLStringWithPageNum) {
      window.safePrintHTMLStringWithPageNum(html);
    } else if (window.safePrintHTMLString) {
      window.safePrintHTMLString(html);
    } else {
      const f = document.createElement('iframe');
      Object.assign(f.style, {
        position: 'fixed',
        right: 0,
        bottom: 0,
        width: 0,
        height: 0,
        border: 0
      });
      document.body.appendChild(f);
      const w = f.contentWindow;
      w.document.open();
      w.document.write(html);
      w.document.close();
      try { w.focus(); } catch(e){}
      setTimeout(() => { try { w.print(); } catch(e){} }, 200);
      setTimeout(() => { try { document.body.removeChild(f); } catch(e){} }, 1500);
    }
  } catch (e) {
    console.error('Errore in stampaCommessaV2:', e);
    // fallback sul vecchio layout se esiste
    try {
      if (window.printCommessa && r) {
        alert('Errore stampa commessa v2, provo il layout precedente…');
        window.printCommessa(r);
        return;
      }
    } catch (e2) {
      console.error('Fallback printCommessa fallito:', e2);
    }
    alert('Errore stampa commessa.');
  }
};

 // === Scanner QR: usa BarcodeDetector se presente, altrimenti html5-qrcode ===
if (!window.scanQR) window.scanQR = async function(){
  // 1) se il browser NON può usare la camera (HTTP su LAN), cado su prompt
  const needsPrompt = !navigator.mediaDevices || !navigator.isSecureContext;
  if (needsPrompt) {
    const v = prompt('Inserisci ID commessa (es. C-2025-012):');
    if (!v) return;
    location.hash = '#/timbratura?job=' + encodeURIComponent(String(v).trim());
    return;
  }

  // 2) prova BarcodeDetector (se supportato)
  if ('BarcodeDetector' in window) {
    try{
      const det = new window.BarcodeDetector({ formats: ['qr_code'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      const video = document.createElement('video');
      video.playsInline = true; video.srcObject = stream; await video.play();

      const canvas = document.createElement('canvas');
      const scan = async () => {
        if (video.readyState >= 2) {
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0);
          const bitmap = await createImageBitmap(canvas);
          const codes = await det.detect(bitmap);
          if (codes && codes[0] && codes[0].rawValue) {
            const raw = String(codes[0].rawValue || '').trim();
            stream.getTracks().forEach(t=>t.stop());
            // accetto sia ID puro che URL con ?job=
            const m = raw.match(/[?#&]job=([^&]+)/i);
            const job = m ? decodeURIComponent(m[1]) : raw;
            location.hash = '#/timbratura?job=' + encodeURIComponent(job);
            return;
          }
        }
        requestAnimationFrame(scan);
      };
      scan(); return;
    }catch(e){ /* passa al prompt */ }
  }

  // 3) fallback finale: prompt
  const v = prompt('Inserisci ID commessa (es. C-2025-012):');
  if (!v) return;
  location.hash = '#/timbratura?job=' + encodeURIComponent(String(v).trim());
};

window.openEtichetteColliDialog = function(commessa){
  if (!commessa || !commessa.id) { alert('Commessa non valida'); return; }
  const def = Math.max(1, Number(commessa?.colliPrevisti || 1));
  const ans = prompt(`Quanti colli stampare per ${commessa.id}?`, String(def));
  if (ans == null) return;
  const n = Math.max(1, parseInt(ans,10) || def);
  window.printEtichetteColli(commessa, n);
};

// === ETICHETTE COLLI: A4 landscape, 1 collo per pagina, testi molto grandi ===
window.printEtichetteColli = function(commessa, nColli){
  try{
    const html = window.generateEtichetteHTML(commessa, nColli);
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();

    function waitAndPrint(doc){
      const imgs = Array.from(doc.images||[]);
      if (imgs.length === 0) { doc.defaultView.focus(); doc.defaultView.print(); return; }
      let done = 0, total = imgs.length, fired = false;
      const tryPrint = ()=> {
        if (!fired) { fired = true; setTimeout(()=>{ doc.defaultView.focus(); doc.defaultView.print(); }, 50); }
      };
      imgs.forEach(img=>{
        if (img.complete) { if (++done>=total) tryPrint(); }
        else {
          img.addEventListener('load', ()=>{ if (++done>=total) tryPrint(); });
          img.addEventListener('error',()=>{ if (++done>=total) tryPrint(); });
        }
      });
      setTimeout(tryPrint, 1500);
    }
    if (w.document.readyState === 'complete') waitAndPrint(w.document);
    else w.addEventListener('load', ()=>waitAndPrint(w.document));
  }catch(e){ console.error(e); alert('Errore stampa etichette'); }
};

window.generateEtichetteHTML = function(c, n){
  // === PATCH C — stampa etichette via iframe (no window.open) ===
  window.printEtichetteHTML = function(html){
    try {
      const fn = (window.safePrintHTMLStringWithPageNum || window.safePrintHTMLString);
      fn(String(html||''));
    } catch(e) { console.warn('printEtichetteHTML:', e); }
  };

  const app      = (function(){ try { return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch { return {}; } })();
  const logo     = app?.logoDataUrl || '';
  const id       = c?.id || '';
  const cliente  = c?.cliente || '';
  const articolo = c?.codiceArticolo || c?.descrizione || '';   // fallback
  const consegna = c?.scadenza ? new Date(c.scadenza).toLocaleDateString('it-IT') : '—';
  const stampato = new Date().toLocaleDateString('it-IT');
  const totPezzi = Math.max(0, Number(c?.qtaPezzi||0));

  // helper per escape HTML su etichette
  const esc = (window.esc)
    ? window.esc
    : function(s){
        return String(s == null ? '' : s).replace(/[<>&]/g, ch => (
          ch === '<' ? '&lt;' : ch === '>' ? '&gt;' : '&amp;'
        ));
      };

  // helper formattazione data ISO → gg/mm/aaaa
  const fmtITDateStr = function(iso){
    const s = String(iso || '').trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}/${m[2]}/${m[1]}` : s;
  };

  // stringa "Ordine cliente 123 del 26/11/2025" per etichette
  const ordineClienteStr = (function(){
    const r = c || {};
    const src = r.rifCliente;
    try{
      if (src && typeof src === 'object') {
        const tipoRaw = String(src.tipo || 'Ordine').trim();
        const tipo    = tipoRaw ? (tipoRaw.charAt(0).toUpperCase() + tipoRaw.slice(1)) : 'Ordine';
        const num     = String(src.numero || '').trim();
        const dataLab = src.data ? fmtITDateStr(src.data) : '';
        let base = num ? `${tipo} ${num}` : tipo;
        if (dataLab) base += ` del ${dataLab}`;
        return base;
      }
    }catch(e){}
    // fallback legacy: vecchi campi stringa
    return (
      r.rifOrdineCliente ||
      r.ordineCliente ||
      r.rifOrdine ||
      r.ordineClienteNumero ||
      ''
    );
  })();

  // lista articoli con quantità (riepilogo da stampare in etichetta)
  const righeArticolo = Array.isArray(c?.righeArticolo)
    ? c.righeArticolo
    : (Array.isArray(c?.righe) ? c.righe : []);

  const righeEtichetteHTML = (function(){
    if (!Array.isArray(righeArticolo) || !righeArticolo.length) return '';
    const rows = righeArticolo.map(r => {
      if (!r) return '';
      const cod  = String(r.codice || r.articoloCodice || '').trim();
      const desc = String(r.descrizione || r.articoloDescr || '').trim();
      const qNum = Number(r.qta || r.quantita || r.qtaPezzi || 0) || 0;

      const parts = [];
      if (cod)  parts.push(esc(cod));
      if (desc) parts.push(esc(desc));
      if (qNum) parts.push(`x ${qNum}`);

      const txt = parts.join(' — ');
      return txt ? `<div>${txt}</div>` : '';
    }).filter(Boolean);

    if (!rows.length) return '';
    return `<div class="righe-articoli">${rows.join('')}</div>`;
  })();

  // Distribuzione automatica per collo (se conosciamo la q.tà totale)
  const qtyPerCollo = [];
  if (totPezzi > 0 && Number.isFinite(totPezzi)) {
    const base = Math.floor(totPezzi / n);
    let rem = totPezzi % n;
    for (let i = 0; i < n; i++) qtyPerCollo.push(base + (i < rem ? 1 : 0));
  } else {
    // sconosciuto → lascia vuoto (verrà mostrato solo "Q.tà totale: —")
    for (let i = 0; i < n; i++) qtyPerCollo.push(null);
  }

  const pages = [];
  for (let i=1; i<=n; i++){
    // QR solo testo: nessun link al gestionale, solo identificativo commessa
    const qrData = `COMMESSA ${id}`;
    const qrURL  = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${encodeURIComponent(qrData)}`;

    const qCollo = qtyPerCollo[i-1];
    pages.push(`
      <section class="page">
        <div class="left">
          ${logo ? `<img class="logo" src="${logo}" alt="logo">` : `<div class="logo ph"></div>`}
          <div class="collo">COLLO <b>${i}/${n}</b></div>

          <div class="cliente">${cliente || '&nbsp;'}</div>
          <div class="articolo">${articolo || '&nbsp;'}</div>

          <div class="info">
            <div><b>Commessa:</b> ${esc(id)}</div>
            ${ordineClienteStr ? `<div><b>Ordine cliente:</b> ${esc(ordineClienteStr)}</div>` : ''}
            <div><b>Consegna prevista:</b> ${consegna}</div>
            <div><b>Stampato il:</b> ${stampato}</div>
            ${righeEtichetteHTML}
            <div class="qtys">
              <span><b>Q.tà totale commessa:</b> ${totPezzi ? String(totPezzi) : '—'}</span>
              <span>${qCollo!=null ? `<b>Q.tà collo:</b> ${qCollo}` : ''}</span>
            </div>
          </div>
        </div>
        <div class="right">
          <img class="qr" src="${qrURL}" alt="QR">
        </div>
      </section>
    `);
  }

  return `<!doctype html>
<html><head><meta charset="utf-8"><title>Etichette ${id}</title>
<style>
  @page { size: A4 landscape; margin: 10mm; }
  html, body { height:100%; }
  body { font-family: system-ui, Arial, sans-serif; margin:0; color:#000; }
  .page { width:100%; height:100%; display:flex; align-items:center; justify-content:space-between; page-break-after: always; }
  .page:last-child { page-break-after: auto; }
  .left { flex: 1 1 auto; padding-right: 12mm; display:flex; flex-direction:column; gap:6mm; }
  .right { width: 80mm; display:flex; align-items:center; justify-content:center; }
  .logo { height: 28mm; object-fit:contain; }
  .logo.ph { border:1px solid #000; width: 60mm; height: 28mm; }
  .collo { font-size: 34pt; font-weight: 900; letter-spacing: .5pt; }
  .cliente { font-size: 32pt; font-weight: 800; line-height: 1.1; word-break: break-word; }
  .articolo { font-size: 36pt; font-weight: 900; line-height: 1.05; word-break: break-word; }
  .info { font-size: 16pt; line-height: 1.3; display:grid; gap:4px; }
  .righe-articoli { margin-top:4px; font-size: 14pt; }
  .qtys { display:flex; gap:16px; margin-top:4px; }
  .qr { width: 70mm; height: 70mm; }
</style>
</head>
<body>
${pages.join('')}
</body></html>`;
};

// === STAMPA COMMESSA (attende immagini caricate + ore previste) =============
window.printCommessa = function(commessa){
  try{
    const app = (function(){ try { return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch { return {}; } })();
    const html = window.generateCommessaHTML(commessa, app);
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();

    // stampa solo quando LOGO/QR sono caricati (risolve anteprima "senza QR")
    function waitAndPrint(doc){
      const imgs = Array.from(doc.images||[]);
      if (imgs.length === 0) { doc.defaultView.focus(); doc.defaultView.print(); return; }
      let done = 0, total = imgs.length, fired = false;
      const tryPrint = ()=> {
        if (!fired) { fired = true; setTimeout(()=>{ doc.defaultView.focus(); doc.defaultView.print(); }, 50); }
      };
      imgs.forEach(img=>{
        if (img.complete) { if (++done>=total) tryPrint(); }
        else {
          img.addEventListener('load', ()=>{ if (++done>=total) tryPrint(); });
          img.addEventListener('error',()=>{ if (++done>=total) tryPrint(); });
        }
      });
      setTimeout(tryPrint, 1500); // fallback
    }
    if (w.document.readyState === 'complete') waitAndPrint(w.document);
    else w.addEventListener('load', ()=>waitAndPrint(w.document));
  }catch(e){ console.error(e); alert('Errore stampa commessa'); }
};

window.generateCommessaHTML = function(c, app){
    // --- html-escape helper locale ---
  const s = v => String(v ?? '').replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch]));
  // --- helpers tempo ---
  const toMin = (s) => {
    if (s == null) return 0;
    const m = String(s).trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0;
    const h = parseInt(m[1]||'0',10)||0;
    const mm = parseInt(m[2]||'0',10)||0;
    return h*60 + mm;
  };
  const fmtHHMM = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m=t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };
  const deaccent = s => String(s||'')
    .normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();

  const isOncePhase = (f) => {
    if (f && (f.once === true || f.unaTantum === true)) return true;
    const name = deaccent(f?.lav||'');
    // “preparazione attivita” come chiave
    return /(^|[^a-z])preparazione\s+attivita([^a-z]|$)/.test(name);
  };
  const minsOfPhase = (f) => {
    if (!f) return 0;
    try{
      if (typeof window !== 'undefined' && typeof window.plannedMinsFromFase === 'function'){
        return window.plannedMinsFromFase(f);
      }
    }catch{}
    if (Number.isFinite(f.oreMin)) return Math.max(0, Math.round(f.oreMin));
    return toMin(f.oreHHMM);
  };

    // --- dati base ---
  const id        = c?.id || '';
  const data      = new Date().toLocaleDateString('it-IT');
  const cliente   = c?.cliente || '';
  const descrRaw  = c?.descrizione || '';
  const descr     = s(descrRaw).replace(/\r?\n/g,'<br>');
  const pezzi     =
  Math.max(1, Number(c?.qtaPezzi||1));
  const scadenza  = c?.scadenza ? new Date(c.scadenza).toLocaleDateString('it-IT') : '';
  const priorita  = c?.priorita || '';
  const istruz    = (c?.istruzioni||'').replace(/\n/g,'<br>');
  const logo      = app?.logoDataUrl || '';
  const azNome    = app?.ragioneSociale || app?.aziendaNome || '';
  const azPiva    = app?.piva || app?.pIva || '';
  const azSede    = app?.sedeOperativa || app?.sedeLegale || '';
  const base  = (app?.publicBaseUrl || window.__inferPublicBase__() || '').trim();
  const qrData = base ? `${base}/#/timbratura?job=${encodeURIComponent(id)}` : id;
  const qrURL  = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${encodeURIComponent(qrData)}`;

  // --- fasi / materiali / righe articolo (modello ibrido) ---
  const righeArt = Array.isArray(c?.righeArticolo) ? c.righeArticolo : [];
  const mat  = Array.isArray(c?.materiali) ? c.materiali : [];

  let fasi = [];
  const hasRowFasi = righeArt.some(r =>
    Array.isArray(r?.fasi) && r.fasi.length
  );

  if (hasRowFasi){
    // uso le fasi per-riga come sorgente principale
    righeArt.forEach(row => {
      const arr = Array.isArray(row.fasi) ? row.fasi : [];
      arr.forEach(f => {
        fasi.push({
          ...f
        });
      });
    });
  } else if (Array.isArray(c?.fasi)) {
    // fallback legacy: fasi globali
    fasi = c.fasi;
  }

  // Rif. ordine cliente (accetta stringa o oggetto) — usa la utility globale se presente
  const rifRaw = c?.ordineCliente || c
  const rifCliente = (window.refClienteToText
    ? window.refClienteToText(rifRaw)
    : (typeof rifRaw === 'object'
        ? [
            (rifRaw.tipo || '').toString().trim().toUpperCase(),
            (rifRaw.numero != null ? String(rifRaw.numero) : '').trim(),
            (rifRaw.data ? new Date(rifRaw.data).toLocaleDateString('it-IT') : '')
          ].filter(Boolean).join(' ').trim()
        : String(rifRaw || '')
      )
  );

  // --- calcolo ore previste ---
  let orePerPezzoHHMM = '';
  let oreTotPrevHHMM  = '';

  try{
    const fnSmart =
      (typeof window !== 'undefined' && typeof window.plannedMinTotalCommessaSmart === 'function')
        ? window.plannedMinTotalCommessaSmart
        : (typeof plannedMinTotalCommessaSmart === 'function'
            ? plannedMinTotalCommessaSmart
            : null);

    if (fnSmart){
      const tot = Number(fnSmart(c)) || 0;
      const qta = Math.max(1, Number(c?.qtaPezzi || 1));
      const perPiece = qta > 0 ? Math.round(tot / qta) : tot;
      orePerPezzoHHMM = fmtHHMM(perPiece);
      oreTotPrevHHMM  = fmtHHMM(tot);
    } else {
      // fallback legacy se per qualche motivo la funzione non esiste
      let perPieceMins = 0;
      let oneTimeMins  = 0;
      fasi.forEach(f => {
        const m = minsOfPhase(f);
        if (isOncePhase(f)) oneTimeMins += m;
        else perPieceMins += m;
      });
      orePerPezzoHHMM = fmtHHMM(perPieceMins);
      oreTotPrevHHMM  = fmtHHMM(perPieceMins * pezzi + oneTimeMins);
    }
  }catch{
    orePerPezzoHHMM = '';
    oreTotPrevHHMM  = '';
  }

  // --- render fasi/materiali ---
  const fasiRows = fasi.map((f,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${(f?.lav||'')}${isOncePhase(f) ? ' <span class="tag">una tantum</span>' : ''}</td>
      <td class="right">${fmtHHMM(minsOfPhase(f))}${isOncePhase(f) ? '' : ''}</td>
      <td class="right">${isOncePhase(f) ? '1' : (f?.qtaPrevista!=null ? f.qtaPrevista : pezzi)}</td>
    </tr>
  `).join('');

  const matRows = mat.map((m,i)=>`
    <tr>
      <td>${m?.codice||''}</td>
      <td>${m?.descrizione||''}</td>
      <td>${m?.um||''}</td>
      <td class="right">${m?.qta||0}</td>
      <td>${m?.note||''}</td>
    </tr>
  `).join('');

    const righeRows = righeArt.map((r,i)=>`
    <tr>
      <td>${s(r?.codice || '')}</td>
      <td>${s(r?.descrizione || '')}</td>
      <td>${s(r?.um || '')}</td>
      <td class="right">${Number(r?.qta || 0) || ''}</td>
      <td>${s(r?.note || '')}</td>
    </tr>
  `).join('');

  // --- HTML ---
  return `<!doctype html>
<html><head><meta charset="utf-8"><title>Commessa ${id}</title>
<style>
  @page { size: A4; margin: 12mm; }
  body { font-family: system-ui, Arial, sans-serif; color:#111; }
  .hdr { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; }
  .logo { height: 80px; }
  .az  { font-size:12px; line-height:1.2; margin-top:4px; color:#333; }
  h1 { margin:4px 0 0 0; font-size:22px; }
  .meta { margin:8px 0 14px; font-size:14px; }
  .grid2 { display:grid; grid-template-columns: 1fr 180px; gap:14px; }
  .card { border:1px solid #333; padding:8px; border-radius:6px; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #333; padding:6px; font-size:13px; }
  th { background:#f4f4f4; }
  .right { text-align:right; }
  .muted { color:#555; }
  .qr { width:160px; height:160px; }
  .tag { display:inline-block; margin-left:6px; padding:2px 6px; font-size:11px; background:#eee; border:1px solid #bbb; border-radius:10px; }
</style>
</head>
<body>

<div class="hdr">
  <div>
    ${logo ? `<img class="logo" src="${logo}" alt="logo">` : ''}
    <div class="az">${azNome}<br>${azSede}<br>P.IVA: ${azPiva}</div>
  </div>
  <div style="text-align:right">
    <h1>COMMESSA</h1>
    <div class="meta">
      <div><b>ID:</b> ${id}</div>
      <div><b>Data:</b> ${data}</div>
    </div>
  </div>
</div>

<div class="grid2">
  <div class="card">
    <table>
      <tbody>
        <tr><th style="width:200px">Cliente</th><td>${cliente}</td></tr>
        <tr><th>Descrizione / Tipo articolo</th><td>${descr}</td></tr>
        <tr><th>Pezzi totali</th><td>${pezzi}</td></tr>
        <tr><th>Ore/pezzo (previste)</th><td>${orePerPezzoHHMM}</td></tr>
        <tr><th>Ore totali (previste)</th><td>${oreTotPrevHHMM}</td></tr>
        <tr><th>Scadenza</th><td>${scadenza}</td></tr>
        <tr><th>Rif. ordine cliente</th><td>${ s((rifCliente || '').trim()) || '-' }</td></tr>
        <tr><th>Priorità</th><td>${priorita}</td></tr>
      </tbody>
    </table>
  </div>
  <div class="card" style="text-align:right">
    <img class="qr" src="${qrURL}" alt="QR">
    <div class="muted">QR Timbratura</div>
  </div>
</div>

${righeArt && righeArt.length ? `
<h3>Articoli commessa</h3>
<table>
  <thead>
    <tr>
      <th>Codice</th>
      <th>Descrizione</th>
      <th>UM</th>
      <th class="right">Q.tà</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>${righeRows || `<tr><td colspan="5" class="muted">— nessun articolo —</td></tr>`}</tbody>
</table>
` : ''}

<h3>Fasi di lavorazione</h3>
<table>
  <thead><tr><th>#</th><th>Lavorazione</th><th class="right">Tempo (HH:MM)</th><th class="right">Q.tà</th></tr></thead>
  <tbody>${fasiRows || `<tr><td colspan="4" class="muted">— nessuna fase —</td></tr>`}</tbody>
</table>

<h3 style="margin-top:14px">Materiali previsti</h3>
<table>
  <thead><tr><th>Codice</th><th>Descrizione</th><th>UM</th><th class="right">Q.tà</th><th>Note</th></tr></thead>
  <tbody>${matRows || `<tr><td colspan="5" class="muted">— nessun materiale —</td></tr>`}</tbody>
</table>

<h3 style="margin-top:14px">Istruzioni</h3>
<div class="card">${istruz || '<span class="muted">— nessuna —</span>'}</div>

</body></html>`;
};

// URL pubblico dedotto automaticamente (se sto servendo via http/https)
window.__inferPublicBase__ = function(){
  try {
    const loc = window.location;
    const base = (loc && /^https?:$/i.test(loc.protocol))
      ? (loc.origin + (loc.pathname || '').replace(/\/[^/]*$/,'/'))
      : '';
    return base.replace(/\/+$/,''); // senza slash finale
  } catch { return ''; }
};

window.findClienteDisplay = function(id){
  const arr = (function(){ try{ return JSON.parse(localStorage.getItem('clientiRows')); }catch{return null;} })() || [];
  const row = arr.find(x => String(x.id) === String(id));
  const name = row?.ragioneSociale || row?.denominazione || row?.nome ||
               row?.cliente || row?.ragione || row?.azienda || '';
  return { row, name };
};
// Aggiorna appSettings facendo merge (non cancella campi esistenti)
window.updateAppSettings = function(patch){
  try{
    // Leggi le impostazioni correnti rispettando l'eventuale namespace BETA
    const cur = (typeof window.lsGet === 'function')
      ? (window.lsGet('appSettings', {}) || {})
      : (JSON.parse(localStorage.getItem('appSettings')||'{}') || {});

    const next = { ...cur, ...(patch||{}), updatedAt: new Date().toISOString() };

    // Scrivi sempre passando da lsSet se disponibile (così in BETA usa BETA:appSettings)
    if (typeof window.lsSet === 'function') {
      window.lsSet('appSettings', next);
    } else {
      localStorage.setItem('appSettings', JSON.stringify(next));
    }

    window.__anima_dirty = true;
  }catch(e){ console.error('updateAppSettings', e); }
};

// === Commessa → DDT: prefill completo e robusto ===
window.prefillDDTfromCommessa = function(comm){
  try{
    const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{return d;} });
    const today = new Date().toISOString().slice(0,10);

    // cliente
    const clienti = lsGet('clientiRows', []) || [];
    const cli = clienti.find(c => String(c.id) === String(comm.clienteId)) || null;

    const clienteNome =
      comm.cliente ||
      (cli ? (cli.ragione || cli.ragioneSociale || cli.denominazione || cli.nome || '') : '');

    // luogo consegna: priorità commessa, poi anagrafica (sede operativa/indirizzo)
    const luogoConsegna =
      comm.luogoConsegna ||
      (cli && (cli.sedeOperativa || cli.indirizzoOperativo || cli.indirizzo)) || '';

    // riferimenti cliente: nr ordine o nr DDT cliente, ecc. (sempre testo)
    const rifRaw =
      comm.rifCliente || comm.ordineCliente || comm.nrOrdineCliente ||
      comm.ddtCliente || comm.po || comm.nrCliente || '';

    const rifCliente = (window.refClienteToText
      ? window.refClienteToText(rifRaw)
      : (typeof rifRaw === 'string' ? rifRaw : String(rifRaw||''))
    ).trim();

    // causale trasporto se presente in commessa
    const causaleTrasporto = comm.causaleTrasporto || '';

    // colli/peso se li usi
    const colli = comm.colliPrevisti || comm.colli || '';
    const peso  = comm.pesoPrevisto || comm.peso || '';

    // righe: prova varie forme
    let righe = [];
    if (Array.isArray(comm.righe) && comm.righe.length){
      righe = comm.righe.map(r => ({
        codice:      r.codice || r.code || '',
        descrizione: r.descrizione || r.desc || r.titolo || '',
        qta:         Number(r.qta || r.quantita || 0) || 0,
        UM:          r.UM || r.um || 'PZ',
        note:        r.note || ''
      })).filter(r => String(r.descrizione||'').trim());
    } else if (comm.descrizione) {
      // se la commessa ha una descrizione multilinea, splitta in righe
      String(comm.descrizione).split(/\r?\n/).forEach(line=>{
        const t = String(line||'').trim();
        if (!t) return;
        righe.push({ codice:'', descrizione:t, qta:1, UM:'PZ', note:'' });
      });
    }

    // minimo una riga
    if (!righe.length){
      const qta = Math.max(1, Number(comm.qtaPezzi||1));
      righe = [{
        codice: comm.codiceArticolo || '',
        descrizione: comm.descrizione ? String(comm.descrizione)
                     : `Lavorazione commessa ${comm.id||''}`,
        qta, UM:'PZ', note:''
      }];
    }

    // payload per DDTView
    const pf = {
      data: today,
      clienteId:    comm.clienteId || '',
      cliente:      clienteNome,
      luogoConsegna,
      commessaRif:  comm.id || comm.codice || comm.rif || '',
      rifCliente,
      causaleTrasporto,
      colli: String(colli||''),
      peso:  String(peso||''),
      note:  comm.note || '',
      righe
    };

    localStorage.setItem('prefillDDT', JSON.stringify(pf));
    // apri la vista DDT: la DDTView leggerà 'prefillDDT' e popolerà il form
    location.hash = '#/ddt';
    if (typeof window.setTab === 'function') window.setTab('DDT');
  }catch(e){
    console.error('prefillDDTfromCommessa error:', e);
    alert('Impossibile preparare il DDT dalla commessa.');
  }
};

// === [AUTH BOOTSTRAP] — incollare in cima a beta/app.js ===
(function (global) {
  const e = React.createElement;

  // --- API helper con cookie ---
  async function api(path, opts={}) {
    const res = await fetch(path, { credentials:'include', ...opts });
    if (!res.ok) throw new Error(`API ${path} ${res.status}`);
    return res.json();
  }

    // --- sessione utente ---
  async function whoAmI() {
    // 1) prova Supabase (se configurato)
    try {
      const sb = window.getSupabase && window.getSupabase();
      if (sb) {
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          // mappa ruolo da appSettings.users (se esiste), altrimenti 'admin'
          let role = 'admin';
          try {
            const s = (typeof window.lsGet === 'function'
              ? window.lsGet('appSettings', {})
              : (function(){
                  try {
                    return JSON.parse(localStorage.getItem('appSettings') || '{}') || {};
                  } catch {
                    return {};
                  }
                })()
            ) || {};
            const m = (s.users || []).find(u =>
              String(u.username || u.email || '').trim().toLowerCase() ===
              String(user.email || '').trim().toLowerCase()
            );
            if (m && m.role) role = m.role;
          } catch {}

          global.__USER = { id: user.id, username: user.email, role };
          return global.__USER;
        }
      }
    } catch {}

    // 2) nessun backend legacy: in BETA, se Supabase non risponde → nessun utente
    global.__USER = null;
    return null;
  }

      // RBAC: sola lettura per accountant (fonte unica: utente corrente)
  global.isReadOnlyUser = function () {
    // puntatore utente più “affidabile” disponibile
    const u =
      window.__USER ||
      window.currentUser ||
      global.__USER ||
      global.currentUser ||
      null;

    if (!u || !u.role) return false;
    const role = String(u.role).toLowerCase();
    return (role === 'accountant' || role === 'viewer' || role === 'mobile');
  };

  global.canWrite = function () {
    return !global.isReadOnlyUser();
  };

  global.logout = global.logout || async function () {

  // 1) prova a chiudere la sessione Supabase
  try { const sb = window.getSupabase && window.getSupabase(); if (sb) await sb.auth.signOut(); } catch {}

  // 2) fallback: endpoint locale (utile con shim in dev)
  try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); } catch {}

  global.__USER = null;
  try { window.currentUser = null; } catch {}
  location.hash = '#/login';
  window.dispatchEvent(new CustomEvent('auth-change', { detail: null }));
  return true;
};

  // --- guardia: richiede login (Supabase-first, no backend → no force) ---
global.requireLogin = async function () {
  // 1) prova il nuovo sistema Supabase-aware se c'è
  try {
    if (global.apiMe) {
      const uSb = await global.apiMe();
      if (uSb) return uSb;
    }
  } catch {}

  // 2) fallback legacy (solo se proprio necessario)
  let u = null;
  try { u = await whoAmI(); } catch {}

  // 3) rispetta authRequired
    const S = (function(){
    try{
      if (typeof window.lsGet === 'function') return window.lsGet('appSettings', {}) || {};
      return JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    }catch{
      return {};
    }
  })();
  const mustLogin = (S.authRequired !== false);

  if (!u && mustLogin) {
    if (location.hash !== '#/login') location.hash = '#/login';
    throw new Error('unauthenticated');
  }

  return u;
};

  // --- props comodi per disabilitare bottoni in sola lettura ---
  global.roProps = function (title = 'Sola lettura') {
    return global.isReadOnlyUser() ? { disabled: true, title } : {};
  };

  // Alias globali su window per compatibilità con il codice esistente
  // Tutto il codice che usa window.isReadOnlyUser / window.roProps
  // d’ora in poi passa sempre da global.isReadOnlyUser (fonte unica).
  window.isReadOnlyUser = global.isReadOnlyUser;
  window.roProps = global.roProps;


  // --- bootstrap: obbliga login all’avvio ---
  addEventListener('load', async ()=>{
    if (window.__ANIMA_APP_MOUNTED__) return;
  let u = null;
  try { u = await whoAmI(); } catch {}
  // leggi preferenza
    const S = (function(){
    try{
      if (typeof window.lsGet === 'function') return window.lsGet('appSettings', {}) || {};
      return JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    }catch{
      return {};
    }
  })();
  const mustLogin = (S.authRequired !== false);

  if (mustLogin && !u){
    if (!location.hash || location.hash==='#' || location.hash==='#/') location.hash = '#/login';
    return; // enforcement
  }
  // default offline-friendly
  if (!location.hash || location.hash==='#' || location.hash==='#/') location.hash = '#/ddt';
});

  // --- piccolo badge sessione (facoltativo) ---
  try{
    const box = document.createElement('div');
    Object.assign(box.style,{position:'fixed',right:'8px',bottom:'8px',background:'#222',color:'#fff',padding:'4px 8px',borderRadius:'8px',fontSize:'12px',opacity:.75,zIndex:9999});
    document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(box));
    (async function refresh(){
      const u = await whoAmI();
      box.textContent = u ? `${u.username} (${u.role})` : 'non autenticato';
      setTimeout(refresh, 30000);
    })();
  }catch{}
})(window);

// === SessionBar (singleton) ===
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  if (window.__SESSIONBAR_MOUNTED__) return;
  window.__SESSIONBAR_MOUNTED__ = true;

  const e = React.createElement;

  function formatUserLabel(u){
    if (!u) return '';
    const email = u.email || u.username || u.user || '';
    const role  = (u.role || '').toString().toUpperCase();
    const short = email.split('@')[0] || email;
    return role ? `${role} · ${short}` : short;
  }

  function SessionBar(){
    const [u,setU] = React.useState(window.__USER||null);

    React.useEffect(()=>{
      (async()=>{
        try { await (window.requireLogin && window.requireLogin()); } catch {}
        setU(window.__USER||null);
      })();
      const t = setInterval(()=> setU(window.__USER||null), 3000);
      return ()=>clearInterval(t);
    },[]);

    const label = formatUserLabel(u);
    const emailFull = (u && (u.email || u.username || u.user || '')) || '';

    return e('div', { className:"sessionbar", id:"anima-session" },
  u
    ? e(React.Fragment,null,
        e('div', { className:"sessionbar-info" },
          e('div', { className:"sessionbar-role" }, label || 'Utente'),
          emailFull ? e('div', { className:"sessionbar-mail" }, emailFull) : null
        ),

        e('button', {
          className:"btn btn-outline btn-logout",
          type:"button",
          onClick:()=> window.logout && window.logout()
        }, "Logout")
      )
    : e('button', {
        className:"btn btn-outline btn-login",
        type:"button",
        onClick:()=>{ location.hash = '#/login'; }
      }, "Login")
  );
  }
  // mount: prova a metterlo nella sidebar, in fondo al menu
  let host = document.getElementById('anima-session');
  if (!host) {
    host = document.createElement('div');
    host.id = 'anima-session';
    const sideNav =
      document.querySelector('aside.sidebar nav.nav') ||
      document.querySelector('aside.sidebar') ||
      document.body;

    sideNav.appendChild(host);
  }

  const root = ReactDOM.createRoot(host);
  root.render(e(SessionBar));
})();

// === Nuova vista: Ordini Fornitori in ritardo ===
function OrdiniFornitoriRitardoView({ query = '' }) {
  const e = React.createElement;
  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const ORD_KEY = (window.__OF_KEY || 'ordiniFornitoriRows');

  const [fltForn, setFltForn]        = React.useState('');
  const [dalConsegna, setDalConsegna]= React.useState('');
  const [alConsegna, setAlConsegna]  = React.useState('');
  const [minRit, setMinRit]          = React.useState('0');
  const [q, setQ]                    = React.useState(query || '');

  const allRows = React.useMemo(()=>{
    const raw = lsGet(ORD_KEY, []);
    return Array.isArray(raw) ? raw : [];
  },[]);

  const fornitori = React.useMemo(()=>{
    const s = new Set();
    (allRows||[]).forEach(o=>{
      const nome = String(o.fornitoreRagione || o.fornitore || '').trim();
      if (nome) s.add(nome);
    });
    return Array.from(s).sort((a,b)=> a.localeCompare(b,'it-IT'));
  },[allRows]);

  const lateRows = React.useMemo(()=>{
    const MS = 24*60*60*1000;
    const today = new Date();
    today.setHours(0,0,0,0);
    const now = today.getTime();

    const minDays = parseInt(String(minRit||'0'),10) || 0;
    const sQuery  = String(q||'').toLowerCase().trim();
    const fornSel = String(fltForn||'').toLowerCase().trim();

    const inRange = (iso) => {
      if (!iso) return true;
      const t = Date.parse(iso);
      if (!t) return false;
      if (dalConsegna && t < Date.parse(dalConsegna)) return false;
      if (alConsegna && t > (Date.parse(alConsegna) + MS - 1)) return false;
      return true;
    };

    const mapStato = (o) => {
      try{
        if (typeof window.statoAutoPerOrdine === 'function') {
          return window.statoAutoPerOrdine(o);
        }
      }catch(_){}
      const righe = Array.isArray(o.righe) ? o.righe : [];
      const totQ  = righe.reduce((S,r)=> S + Number(r.qta||0), 0);
      const totRx = righe.reduce((S,r)=> S + Number(r.qtaRicevuta||0), 0);
      if (!righe.length) return o.stato || 'Bozza';
      if (totQ>0 && totRx>=totQ) return 'Chiuso';
      if (totRx>0) return 'Parziale';
      return o.stato || 'Bozza';
    };

    return (Array.isArray(allRows)?allRows:[])
      .filter(o => o && !o.deletedAt)
      .map(o => {
        const statoCalc = mapStato(o);
        const consegna  = o.consegnaPrevista || o.dataConsegna || o.consegna || '';
        let giorniRitardo = 0;
        if (consegna) {
          const t = Date.parse(consegna);
          if (t) {
            const diff = Math.floor((now - t) / MS);
            if (diff > 0) giorniRitardo = diff;
          }
        }
        const righe = Array.isArray(o.righe) ? o.righe : [];
        const residuoTot = righe.reduce((S,r)=>{
          const q = Number(r.qta || 0);
          const rx = Number(r.qtaRicevuta || 0);
          return S + Math.max(0, q - rx);
        },0);
        const totale = righe.reduce((S,r)=>{
          const q   = Number(r.qta || 0);
          const pr  = Number(r.prezzo || r.prezzoUnitario || 0);
          const s   = Number(r.sconto || r.scontoPerc || 0);
          const net = pr * (Number.isFinite(s) ? (1 - s/100) : 1);
          return S + (q * net);
        },0);
        return { ...o, statoCalc, consegnaEffettiva: consegna, giorniRitardo, residuoTot, totale };
      })
      .filter(o => o.consegnaEffettiva && o.giorniRitardo > 0)
      .filter(o => o.statoCalc !== 'Chiuso' && o.statoCalc !== 'Annullato')
      .filter(o => {
        if (!inRange(o.consegnaEffettiva)) return false;
        if (minDays > 0 && o.giorniRitardo < minDays) return false;

        const fornNome = String(o.fornitoreRagione || o.fornitore || '').toLowerCase();
        if (fornSel && fornNome !== fornSel) return false;

        if (sQuery) {
          const hay = [
            o.id, o.rifOrdine, o.data, o.consegnaEffettiva,
            o.stato, o.statoCalc,
            o.fornitoreRagione, o.fornitoreId,
            ...(Array.isArray(o.righe)?o.righe:[]).map(r => `${r.codice||''} ${r.descr||r.descrizione||''}`)
          ].join(' ').toLowerCase();
          if (!hay.includes(sQuery)) return false;
        }
        return true;
      })
      .sort((a,b)=>{
        if (b.giorniRitardo !== a.giorniRitardo) return b.giorniRitardo - a.giorniRitardo;
        const da = a.consegnaEffettiva || '';
        const db = b.consegnaEffettiva || '';
        return da.localeCompare(db);
      });
  }, [allRows, q, fltForn, dalConsegna, alConsegna, minRit]);

  const totResiduo = lateRows.reduce((S,o)=> S + Number(o.residuoTot||0), 0);
  const totOrdini  = lateRows.length;

  return e('div', { className:'page' },
    e('div', { className:'actions', style:{justifyContent:'space-between', alignItems:'center', marginBottom:12} },
      e('h2', null, `Ordini fornitori in ritardo (${totOrdini})`),
      e('div', { className:'row', style:{gap:8, alignItems:'center'} },
        e('button', {
          type:'button',
          className:'btn btn-outline',
          onClick:()=>{ location.hash = '#/ordini'; }
        }, '⬅️ Torna a ordini')
      )
    ),
    e('div', { className:'card', style:{marginBottom:12} },
      e('div', { className:'row', style:{gap:8, flexWrap:'wrap'} },
        e('div', { className:'form-group' },
          e('label', { className:'lbl' }, 'Fornitore'),
          e('select', {
            className:'input',
            value: fltForn,
            onChange: ev => setFltForn(ev.target.value)
          },
            e('option', { value:'' }, 'Tutti'),
            fornitori.map(nome => e('option', { key:nome, value:nome }, nome))
          )
        ),
        e('div', { className:'form-group' },
          e('label', { className:'lbl' }, 'Consegna dal'),
          e('input', {
            type:'date',
            className:'input',
            value: dalConsegna,
            onChange: ev => setDalConsegna(ev.target.value)
          })
        ),
        e('div', { className:'form-group' },
          e('label', { className:'lbl' }, 'Consegna al'),
          e('input', {
            type:'date',
            className:'input',
            value: alConsegna,
            onChange: ev => setAlConsegna(ev.target.value)
          })
        ),
        e('div', { className:'form-group' },
          e('label', { className:'lbl' }, 'Ritardo minimo (giorni)'),
          e('input', {
            type:'number',
            min:0,
            className:'input',
            value: minRit,
            onChange: ev => setMinRit(ev.target.value)
          })
        ),
        e('div', { className:'form-group', style:{minWidth:220} },
          e('label', { className:'lbl' }, 'Cerca'),
          e('input', {
            type:'search',
            className:'input',
            placeholder:'ID, rif ordine, codice...',
            value: q,
            onChange: ev => setQ(ev.target.value)
          })
        ),
        e('div', { className:'form-group' },
          e('label', { className:'lbl' }, 'Totale qta residua'),
          e('div', null, String(totResiduo || 0))
        )
      )
    ),
    e('div', { className:'table-wrap' },
      e('table', { className:'table' },
        e('thead', null,
          e('tr', null,
            e('th', null, 'ID'),
            e('th', null, 'Fornitore'),
            e('th', null, 'Data ordine'),
            e('th', null, 'Consegna prevista'),
            e('th', {className:'right'}, 'Ritardo (gg)'),
            e('th', null, 'Stato'),
            e('th', {className:'right'}, 'Qta residua'),
            e('th', {className:'right'}, 'Totale ordine'),
            e('th', null, 'Azioni')
          )
        ),
        e('tbody', null,
          lateRows.length
            ? lateRows.map(o => e('tr', { key:o.id },
                e('td', null, o.id),
                e('td', null, o.fornitoreRagione || o.fornitore || ''),
                e('td', null, o.data || ''),
                e('td', null, o.consegnaEffettiva || ''),
                e('td', {className:'right'}, String(o.giorniRitardo || 0)),
                e('td', null, o.statoCalc || o.stato || ''),
                e('td', {className:'right'}, String(o.residuoTot || 0)),
                e('td', {className:'right'}, (function(v){
                  const n = Number(v||0);
                  return n ? n.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2}) : '';
                })(o.totale)),
                e('td', null,
                  e('button', {
                    type:'button',
                    className:'btn btn-sm',
                    onClick:()=>{
                      try { localStorage.setItem('__OF_OPEN_ID', String(o.id||'')); } catch(_){}
                      location.hash = '#/ordini';
                    }
                  }, 'Apri')
                )
              ))
            : e('tr', null,
                e('td', { colSpan:9, className:'muted' }, 'Nessun ordine in ritardo secondo i filtri attuali.')
              )
        )
      )
    )
  );
}
window.OrdiniFornitoriRitardoView = window.OrdiniFornitoriRitardoView || OrdiniFornitoriRitardoView;

/* ================== MAGAZZINO ▸ MOVIMENTI (compat + CSV + ricalcolo + sorting) ================== */
function MagazzinoMovimentiView({ query = '' }) {
  const e = React.createElement;
  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const MOV_KEY = (window.__MAG_KEYS__ && window.__MAG_KEYS__.MAG_MOV_KEY) || 'magMovimenti';

  const [rows, setRows] = React.useState(()=> lsGet(MOV_KEY, []));
  const [q, setQ] = React.useState(query||'');
  const [da, setDa] = React.useState('');
  const [a,  setA ] = React.useState('');

  React.useEffect(()=>{ setRows(lsGet(MOV_KEY, [])); }, []);

  const getLines = (r) => {
    if (Array.isArray(r?.righe)) return r.righe;
    if (Array.isArray(r?.rows)) return r.rows;
    if (Array.isArray(r?.items)) return r.items;
    if (r && (r.codice || r.code)) return [{ codice: r.codice || r.code, qta: r.qta || r.qty || r.quantita || 0, prezzo: r.prezzo || r.price || r.costo || 0 }];
    return [];
  };
  const tipoStr = (t) => {
    const up = String(t||'').toUpperCase();
    if (up==='C') return 'CARICO';
    if (up==='S') return 'SCARICO';
    return t||'';
  };

  const inRange = (d) => {
    if (!d) return true;
    const t = Date.parse(d);
    const tDa = da ? Date.parse(da) : null;
    const tA  = a  ? Date.parse(a)  : null;
    if (tDa && t < tDa) return false;
    if (tA  && t > (tA + 24*3600*1000 - 1)) return false;
    return true;
  };
  const matches = (r) => {
    const s = (q||'').toLowerCase().trim();
    if (!s) return true;
    const lines = getLines(r);
    const hay = [
      r.id, r.tipo, r.data, r.rifDoc, r.ddtFornitore, r.fornitoreId, r.note,
      ...lines.map(x => `${x.codice||x.code||''}`)
    ].join(' ').toLowerCase();
    return hay.includes(s);
  };

  const filtered = (Array.isArray(rows)?rows:[])
    .filter(r => !r?.deletedAt)                        // soft-delete: ignora
    .filter(r => inRange(r.data) && matches(r))
    .sort((a,b)=>{
      const ta = Date.parse(a.data||0) || 0;
      const tb = Date.parse(b.data||0) || 0;
      if (tb!==ta) return tb-ta;
      return String(b.id).localeCompare(String(a.id));
    });

  const totQ = filtered.reduce((S,r)=> S + getLines(r).reduce((s,x)=> s + Number(x.qta||x.qty||x.quantita||0),0), 0);
  const totRig = filtered.reduce((S,r)=> S + getLines(r).length, 0);

  function exportCSV(){
  const q = v => {
    const s = (v==null ? '' : String(v));
    return /[;"\n\r]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const header = ['id','data','tipo','rifDoc','fornitore','ddt','codice','qta','prezzo'];
  const lines = [header.join(';')];
  filtered.forEach(r=>{
    const rl = getLines(r);
    if (rl.length===0) {
      lines.push([q(r.id),q(r.data),q(tipoStr(r.tipo)),q(r.rifDoc),q(r.fornitoreId||''),q(r.ddtFornitore||''),q(''),q(0),q(0)].join(';'));
    } else {
      rl.forEach(x=>{
        lines.push([q(r.id),q(r.data),q(tipoStr(r.tipo)),q(r.rifDoc),q(r.fornitoreId||''),q(r.ddtFornitore||''),q(x.codice||x.code||''),q(x.qta||x.qty||x.quantita||0),q(x.prezzo||x.price||x.costo||0)].join(';'));
      });
    }
  });
  const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'mag_movimenti.csv'; a.click();
  URL.revokeObjectURL(url);
}

  const doRicalcola = ()=> window.ricalcolaGiacenzeDaMovimenti && window.ricalcolaGiacenzeDaMovimenti();

  return e('div', { className:'container' },
    e('div', { className:'row', style:{gap:12, alignItems:'center', marginBottom:12, flexWrap:'wrap'} },
      e('h2', null, `Movimenti Magazzino (${filtered.length})`),
      e('div',{style:{flex:1}}),
      e('label', null, 'Da: ', e('input', { type:'date', value:da, onChange:ev=>setDa(ev.target.value) })),
      e('label', null, 'A: ',  e('input', { type:'date', value:a,  onChange:ev=>setA(ev.target.value) })),
      e('input', { placeholder:'Cerca…', value:q, onChange:ev=>setQ(ev.target.value), style:{minWidth:220} }),
      e('button', { className:'btn', onClick:exportCSV }, '⬇️ CSV'),
      e('button', { className:'btn btn-outline', onClick:doRicalcola }, '↻ Ricalcola giacenze')
    ),

    e('div', { className:'table-wrap' },
      e('table', { className:'table' },
        e('thead', null, e('tr', null,
          e('th', null, 'ID'), e('th', null, 'Data'), e('th', null, 'Tipo'),
          e('th', null, 'Rif.'), e('th', null, 'Fornitore/DDT'), 
          e('th', null, '#Righe'), e('th', null, 'Q tot.'), e('th', {style:{textAlign:'right'}}, 'Azioni')
        )),
        e('tbody', null,
          filtered.map(r=>{
            const rl = getLines(r);
            const qty = rl.reduce((s,x)=> s + Number(x.qta||x.qty||x.quantita||0),0);
            return e('tr', { key:r.id },
              e('td', null, r.id),
              e('td', null, r.data || ''),
              e('td', null, tipoStr(r.tipo) || ''),
              e('td', null, r.rifDoc || ''),
              e('td', null, (r.fornitoreId||'') + (r.ddtFornitore?(' / '+r.ddtFornitore):'')),
              e('td', null, rl.length),
              e('td', null, qty),
              e('td', {style:{textAlign:'right'}},
                e('button', { className:'btn btn-sm',onClick: ()=> (window.printBollaMagazzino && window.printBollaMagazzino(r))}, '🖨️ Bolla')
              )
            );
          })
        )
      )
    ),

    e('div', { className:'row', style:{gap:8, marginTop:8, justifyContent:'flex-end'} },
      e('button', { className:'btn', onClick:doRicalcola }, '↻ Ricalcola giacenze')
    ),

    e('div', { className:'muted', style:{marginTop:8} },
      `Totale righe: ${totRig} · Totale quantità: ${totQ}`
    )
  );
}
window.MagazzinoMovimentiView = window.MagazzinoMovimentiView || MagazzinoMovimentiView;

(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  window.printBollaMagazzino = function(mov){
    try{
      const esc = s => String(s==null?'':s).replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
      const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
      const app = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{};} })();

      const ars = (function(){ try{ return JSON.parse(localStorage.getItem('magArticoli')||'[]')||[]; }catch{return[];} })();
      const findDesc = code => {
        const a = ars.find(x=> String(x.codice||x.id||'').toLowerCase() === String(code||'').toLowerCase());
        return a?.descrizione || '';
      };

      const tipo = (function(t){ const up=String(t||'').toUpperCase(); return up==='C'?'CARICO':(up==='S'?'SCARICO':(t||'')); })(mov?.tipo);
      const righe = (function(r){
        if (Array.isArray(r?.righe)) return r.righe;
        if (Array.isArray(r?.rows))  return r.rows;
        if (Array.isArray(r?.items)) return r.items;
        if (r && (r.codice || r.code)) return [{ codice:r.codice||r.code, qta:r.qta||r.qty||r.quantita||0, prezzo:r.prezzo||r.price||r.costo||0 }];
        return [];
      })(mov);

      const css = `<style>
        @page { size:A4; margin: 10mm 8mm; }
        *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
        html,body{margin:0;padding:0}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;font-size:12px}
        .hdr{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #0f172a;padding-bottom:8px;margin-bottom:10px}
        .az .rs{font-size:18px;font-weight:800}
        .muted{color:#64748b}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        thead{display:table-header-group}
        th,td{border:1px solid #e2e8f0;padding:6px 8px;vertical-align:top}
        th{background:#f8fafc;font-weight:700}
        .num{text-align:right}
        .ctr{text-align:center}
        .footer{margin-top:12px;display:grid;grid-template-columns:1fr 240px;gap:10px}
        .sign{min-height:40px;border:1px dashed #cbd5e1;padding:10px}
        .pagebox{position:fixed;right:8mm;bottom:10mm;font-size:12px}
        .pageNum[data-mode="css"]::after{content: counter(page) " / " counter(pages)}
      </style>`;

      const header = `
        <div class="hdr">
          <div class="az">
            <div class="rs">${esc(app.ragioneSociale||app.companyName||'')}</div>
            ${app.piva ? `<div class="muted">P.IVA: ${esc(app.piva)}</div>` : ``}
            ${app.sedeLegale ? `<div class="muted">${esc(app.sedeLegale)}</div>` : ``}
          </div>
          <div class="doc">
            <div><b>BOLLA MAGAZZINO — ${esc(tipo||'')}</b></div>
            <div class="muted">Data: ${esc(mov?.data||'')}</div>
            ${mov?.rifDoc ? `<div class="muted">Rif.: ${esc(mov.rifDoc)}</div>` : ``}
            ${(mov?.fornitoreId || mov?.ddtFornitore) ? `<div class="muted">${esc(mov.fornitoreId||'')} ${mov.ddtFornitore?(' / '+esc(mov.ddtFornitore)) : ''}</div>` : ``}
          </div>
        </div>`;

      const bodyRows = righe.map((r,i)=>{
        const code = String(r.codice||'').trim();
        const q    = Number(r.qta||0);
        const pr   = Number(r.prezzo||0);
        const desc = findDesc(code);
        return `<tr>
          <td class="ctr">${i+1}</td>
          <td>${esc(code)}</td>
          <td>${esc(desc||'')}</td>
          <td class="ctr">${q ? q : ''}</td>
          <td class="num">${pr ? fmt2(pr) : ''}</td>
        </tr>`;
      }).join('');

      const table = `
        <table>
          <thead><tr>
            <th style="width:26px" class="ctr">#</th>
            <th style="width:120px">Codice</th>
            <th>Descrizione</th>
            <th style="width:90px" class="ctr">Q.tà</th>
            <th style="width:110px" class="num">Prezzo</th>
          </tr></thead>
          <tbody>${bodyRows || `<tr><td colspan="5" class="muted">— Nessuna riga —</td></tr>`}</tbody>
        </table>`;

      const footer = `
        <div class="footer">
          <div class="grid">
            <div class="box">Vettore: <b>${vettore || '—'}</b></div>
            <div class="box">Aspetto beni: <b>${aspetto || '—'}</b></div>
            <div class="box">Colli: <b>${colli || '—'}</b></div>
            <div class="box">Data/ora: <b>${dataOra || '—'}</b></div>
            <div class="box">Peso netto: <b>${pesoNetto || '—'}</b></div>
            <div class="box">Peso lordo: <b>${pesoLordo || '—'}</b></div>
          </div>
        <div id="pagebox" class="pagebox">Pag. <span class="pageNum" data-mode="css"></span></div>
      </div>`;

      const html = `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>
        ${header}
        ${table}
        ${footer}
      </body></html>`;

      if (window.safePrintHTMLStringWithPageNum) window.safePrintHTMLStringWithPageNum(html);
      else if (window.safePrintHTMLString) window.safePrintHTMLString(html);
      else {
        const ifr = document.createElement('iframe');
        ifr.style.width=ifr.style.height=0; ifr.style.border=0; document.body.appendChild(ifr);
        const d = ifr.contentWindow.document; d.open(); d.write(html); d.close();
        setTimeout(()=>{ try{ ifr.contentWindow.focus(); ifr.contentWindow.print(); }catch{} setTimeout(()=>ifr.remove(),300); }, 200);
      }
    }catch(e){ alert('Errore stampa bolla: ' + (e?.message || e)); }
  };
})();

// === PATCH A — safePrint unificato, idempotente, con cleanup e page numbering fallback ===
(function(){
  // Forza la versione robusta: una sola definizione vincente
  window.safePrintHTMLString = function(html){
    try {
      const ifr = document.createElement('iframe');
      ifr.style.cssText = 'position:fixed;right:0;bottom:0;width:0;height:0;border:0;visibility:hidden';
      document.body.appendChild(ifr);

      const w = ifr.contentWindow;
      const d = w.document;
      d.open(); d.write(String(html||'')); d.close();

      // fallback numerazione (solo se manca .pageNum via CSS)
      const setupPageNum = ()=>{
        try{
          const pn = d.querySelector('#pagebox .pageNum') || d.querySelector('.pageNum');
          if (!pn) return;
          pn.setAttribute('data-mode','css');
          const pseudo = w.getComputedStyle(pn,'::after').getPropertyValue('content') || '';
          const bad = (!pseudo || !/\d/.test(pseudo));
          if (bad){
            const mmToPx = (() => {
              const t = d.createElement('div');
              t.style.height = '100mm'; t.style.position='absolute'; t.style.visibility='hidden';
              d.body.appendChild(t);
              const px = t.getBoundingClientRect().height||0;
              t.remove(); return px/100;
            })();
            const pageHeightMm = 297 - (16 + 22);
            const pageHeightPx = (mmToPx>0) ? (mmToPx*pageHeightMm) : (w.innerHeight||1123);
            const content = d.querySelector('.content') || d.body;
            const h = Math.max(content.scrollHeight, content.offsetHeight, d.body.scrollHeight);
            const total = Math.max(1, Math.ceil(h / pageHeightPx));
            pn.removeAttribute('data-mode');
            pn.textContent = `1 / ${total}`;
          }
        }catch{}
      };

      // Attende che le immagini (logo, timbro, ecc.) siano caricate prima di stampare,
      // per evitare che nel PDF manchino elementi grafici se la rete è lenta.
      const waitAndPrint = (attempt) => {
        try {
          const maxAttempts = 20; // ~20 * 150ms ≈ 3 secondi max
          const imgs = Array.from(d.images || []);
          const allComplete = !imgs.length || imgs.every(im => im && im.complete);

          if (!allComplete && attempt < maxAttempts) {
            setTimeout(() => waitAndPrint(attempt + 1), 150);
            return;
          }

          // A questo punto le immagini sono caricate (o abbiamo aspettato abbastanza)
          setupPageNum();
          w.focus();
          w.print();
          setTimeout(() => { try { ifr.remove(); } catch {} }, 300);
        } catch {}
      };

      // Primo tentativo
      waitAndPrint(0);
    } catch(e) {
      alert('Errore stampa (safePrintHTMLString): ' + (e?.message || e));
    }
  };
})();
  

/* ================== DASHBOARD (widget: pronte, timbrature oggi, allarmi) ================== */
function DashboardView(){
  const e = React.createElement;

  // ---- Utils LocalStorage (GLOBAL SAFE) ----
  window.lsGet = window.lsGet || function (k, def) {
    try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : def; }
    catch { return def; }
  };
  window.lsSet = window.lsSet || function (k, v) {
    try { localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; } catch {}
  };
  // ⚠️ Non dichiarare più `const lsGet/lsSet` a livello globale

  // ---- Helpers tempo/quantità ----
  const toMin = (s) => {
    if (s == null) return 0;
    const m = String(s).trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0;
    const h = parseInt(m[1]||'0',10)||0;
    const mm = parseInt(m[2]||'0',10)||0;
    return h*60+mm;
  };
  const fmtHHMM = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m=t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };
  const todayISO = () => new Date().toISOString().slice(0,10);

    // Modello A legacy (commessa intera): min(qtaProdotta delle fasi globali)
  function producedPiecesLegacy(c){
    const tot = Math.max(1, Number(c?.qtaPezzi||1));
    const fasi = Array.isArray(c?.fasi) ? c.fasi : [];
    if (!fasi.length) return Math.max(0, Math.min(tot, Number(c?.qtaProdotta||0) || 0));
    const arr = fasi.map(f => Math.max(0, Number(f?.qtaProdotta||0)));
    if (!arr.length) return 0;
    const min = Math.min(...arr);
    return Math.max(0, Math.min(tot, min));
  }

  // Per-riga: min(qtaProdotta delle fasi della riga)
  function producedPiecesRow(r, totFallback){
    const tot = Math.max(1, Number(r?.qta || totFallback || 1));
    const fasiR = Array.isArray(r?.fasi) ? r.fasi : [];
    if (!fasiR.length) return 0;
    const arr = fasiR.map(f => Math.max(0, Number(f?.qtaProdotta||0)));
    if (!arr.length) return 0;
    const min = Math.min(...arr);
    return Math.max(0, Math.min(tot, min));
  }

  // Effettivo mostrato in UI: se ho riga selezionata uso per-riga, altrimenti legacy
  function producedPiecesUI(c, rigaIdxNum){
    const totComm = Math.max(1, Number(c?.qtaPezzi||1));
    if (Number.isFinite(rigaIdxNum) && Array.isArray(c?.righeArticolo) && c.righeArticolo[rigaIdxNum]){
      return producedPiecesRow(c.righeArticolo[rigaIdxNum], totComm);
    }
    return producedPiecesLegacy(c);
  }

  // Ore pianificate (smart: per-riga se ci sono fasi con tempi, altrimenti fallback globale)
  function plannedMinutes(c){
    const commessa = c || {};

    // helper: minuti pianificati di UNA fase (stessa logica del Report Tempi)
    function minsFromPhase(f){
      if (!f || typeof f !== 'object') return 0;

      const n =
        (typeof f.oreMin === 'number'      && isFinite(f.oreMin))      ? f.oreMin      :
        (typeof f.minuti === 'number'      && isFinite(f.minuti))      ? f.minuti      :
        (typeof f.min === 'number'         && isFinite(f.min))         ? f.min         :
        (typeof f.orePrevMin === 'number'  && isFinite(f.orePrevMin))  ? f.orePrevMin  :
        null;

      if (n != null) return Math.max(0, Math.round(n));

      const hhmm =
        f.orePrevHHMM      ||   // per-riga
        f.oreHHMM          ||
        f.hhmm             ||
        f.orePrevistaHHMM  ||
        f.orePrev          ||
        f.durataHHMM       ||
        '';

      return Math.max(0, Math.round(toMin(hhmm || '0')));
    }

    const qComm = Math.max(1, Number(commessa.qtaPezzi || 1));
    const righe = Array.isArray(commessa.righeArticolo) ? commessa.righeArticolo : [];

    // ci sono fasi per-riga con tempi pianificati?
    const hasRowFasiPlanned = righe.some(row =>
      Array.isArray(row && row.fasi) &&
      row.fasi.some(f => minsFromPhase(f) > 0)
    );

    let tot = 0;

    if (righe.length && hasRowFasiPlanned){
      // 1) Caso moderno: sommo il totale pianificato per ogni riga articolo
      for (const row of righe){
        const qRow = Math.max(1, Number(row?.qta || row?.qtaPezzi || row?.pezzi || 1));

        const rowFasi  = (row && Array.isArray(row.fasi) && row.fasi.length) ? row.fasi : [];
        const commFasi = Array.isArray(commessa.fasi) ? commessa.fasi : [];

        // se la riga ha tempi propri uso quelli, altrimenti ricado sulle fasi globali
        const rowHasPlanned = rowFasi.some(f => minsFromPhase(f) > 0);
        const fasiEff = rowHasPlanned ? rowFasi : commFasi;

        if (!fasiEff.length){
          // nessuna fase né per-riga né globale: uso oreMin/oreHHMM commessa come tempo per pezzo
          const perPiece =
            (typeof commessa.oreMin === 'number' && isFinite(commessa.oreMin))
              ? commessa.oreMin
              : toMin(commessa.oreHHMM || '0');

          tot += Math.max(0, Math.round(perPiece * qRow));
        } else {
          let perPiece = 0;
          let unaTantum = 0;

          for (const f of fasiEff){
            const m = minsFromPhase(f);
            if (f && (f.unaTantum || f.once)) unaTantum += m;
            else perPiece += m;
          }

          tot += Math.max(0, Math.round(unaTantum + perPiece * qRow));
        }
      }
    } else {
      // 2) Fallback legacy: uso solo le fasi globali della commessa
      const fasi = Array.isArray(commessa.fasi) ? commessa.fasi : [];

      if (!fasi.length){
        // nessuna fase: oreMin/oreHHMM commessa = tempo per pezzo
        const perPiece =
          (typeof commessa.oreMin === 'number' && isFinite(commessa.oreMin))
            ? commessa.oreMin
            : toMin(commessa.oreHHMM || '0');

        tot = Math.max(0, Math.round(perPiece * qComm));
      } else {
        let perPiece = 0;
        let unaTantum = 0;

        for (const f of fasi){
          const m = minsFromPhase(f);
          if (f && (f.unaTantum || f.once)) unaTantum += m;
          else perPiece += m;
        }

        tot = Math.max(0, Math.round(unaTantum + perPiece * qComm));
      }
    }

    const perPezzo = qComm > 0 ? Math.round(tot / qComm) : tot;

    return { perPezzo, tot };
  }

  // Ore effettive registrate (sommatoria ore della commessa)
  function effectiveMinutes(c, oreRows){
    return (Array.isArray(oreRows)?oreRows:[])
      .filter(o => o.commessaId === c.id)
      .reduce((s,o)=> s + (Number(o.oreMin)||toMin(o.oreHHMM)||0), 0);
  }

    // Produzione calcolata come in Commesse: da oreRows, con fallback legacy
function producedPiecesFromOreRows(c, oreRows){
    if (!c) return 0;
    try{
      const totComm = Math.max(1, Number(c.qtaPezzi || 1));
      const all = Array.isArray(oreRows)
        ? oreRows.filter(o => !o || !o.deletedAt)
        : [];

      // 1) Logica ufficiale: usa sempre il core commessa+oreRows
      if (typeof window !== 'undefined'
        && typeof window.producedPiecesCore === 'function') {

        const vCore = Number(window.producedPiecesCore(c, all) || 0);
        if (Number.isFinite(vCore)) {
          return Math.max(0, Math.min(totComm, vCore));
        }
      }

      // 2) Fallback: producedPieces(c) legacy (basata su fasi.qtaProdotta)
      if (typeof window !== 'undefined'
        && typeof window.producedPieces === 'function') {

        const vLegacy = Number(window.producedPieces(c) || 0);
        if (Number.isFinite(vLegacy)) {
          return Math.max(0, Math.min(totComm, vLegacy));
        }
      }

      // 3) Ultimo fallback: c.qtaProdotta clampata
      const prodLegacy = Math.max(0, Number(c.qtaProdotta || 0));
      return Math.max(0, Math.min(totComm, prodLegacy));
    }catch(_){
      return 0;
    }
  }

  // ---- Dati ----
  const commesse = lsGet('commesseRows', []);
  const oreAll   = lsGet('oreRows', []);
  const oreRows  = Array.isArray(oreAll)
    ? oreAll.filter(o => !o || !o.deletedAt)
    : [];
  const today    = todayISO();

  // ---- Dataset widget ----
  // 1) Commesse pronte
  const pronte = (Array.isArray(commesse)?commesse:[])
    .map(c => {
      const tot = Math.max(1, Number(c.qtaPezzi||1));

      // Produzione calcolata come in vista Commesse (da oreRows)
      const prod = producedPiecesFromOreRows(c, oreRows);
      const residuo = Math.max(0, Math.min(tot, tot - prod));

      return {
        c,
        tot,
        prod,
        residuo
      };
    })
    .filter(x => x.residuo === 0)

    .sort((a,b)=>{
      const ma = String(a.c.id||'').match(/^C-(\d{4})-(\d{3})$/);
      const mb = String(b.c.id||'').match(/^C-(\d{4})-(\d{3})$/);
      if (ma && mb){
        const ay=+ma[1], an=+ma[2], by=+mb[1], bn=+mb[2];
        if (by!==ay) return by-ay;
        if (bn!==an) return bn-an;
      }
      const at = Date.parse(a.c.updatedAt||a.c.createdAt||0)||0;
      const bt = Date.parse(b.c.updatedAt||b.c.createdAt||0)||0;
      return bt - at;
    })
    .slice(0, 10);

  // 2) Radar urgenze commesse (scadenze a breve)
  const dayMs = 24*60*60*1000;
  const radar = (Array.isArray(commesse)?commesse:[])
    .map(c => {
      const tot = Math.max(1, Number(c.qtaPezzi||1));

      let prod = 0;
      try{
        prod = producedPiecesFromOreRows(c, oreRows);
      }catch(_){
        prod = 0;
      }
      const residuo = Math.max(0, Math.min(tot, tot - prod));
      if (residuo <= 0) return null;

      const scadRaw =
        (c && (c.scadenza || c.dataScadenza || c.data_scadenza || c.dataConsegna || c.consegnaPrevista || c.consegna_prevista)) ||
        null;
      if (!scadRaw) return null;

      const scadISO = String(scadRaw).slice(0,10);
      if (!scadISO || scadISO.length !== 10) return null;

      const tScad  = Date.parse(scadISO);
      const tToday = Date.parse(today);
      if (!tScad || !tToday) return null;

      const diffDays = Math.round((tScad - tToday) / dayMs);

      // Considero solo commesse con scadenza tra 7 giorni fa e 14 giorni avanti
      if (diffDays < -7 || diffDays > 14) return null;

      let stato = '';
      if (diffDays < 0) {
        stato = `IN RITARDO (${Math.abs(diffDays)}g)`;
      } else if (diffDays === 0) {
        stato = 'Oggi';
      } else if (diffDays <= 2) {
        stato = `Entro ${diffDays}g`;
      } else if (diffDays <= 7) {
        stato = 'Entro 7g';
      } else {
        stato = 'Entro 14g';
      }

      return { c, residuo, scadenzaISO: scadISO, diffDays, stato };
    })
    .filter(Boolean)
    .sort((a,b)=>{
      if (a.diffDays !== b.diffDays) return a.diffDays - b.diffDays;
      return (b.residuo||0) - (a.residuo||0);
    })
    .slice(0, 12);

  // 3) Timbrature di oggi (ultime N)
  const oggiRows = (Array.isArray(oreRows)?oreRows:[])
    .filter(o => (o.data || '').slice(0,10) === today)
    .sort((a,b)=> (Date.parse(b.__createdAt||b.data||0) - Date.parse(a.__createdAt||a.data||0)))
    .slice(0, 12);

  // 4) Allarmi: sforo ore pianificate oppure fermi >24h con residuo >0
  const now = Date.now();
  const allarmi = (Array.isArray(commesse)?commesse:[])
    .map(c => {
      const { tot: planTot } = plannedMinutes(c);
      const effTot = effectiveMinutes(c, oreRows);
      const tot = Math.max(1, Number(c.qtaPezzi||1));

      // Produzione effettiva e residuo basati su oreRows (stessa logica delle altre viste)
      let prod = 0;
      try{
        if (typeof window !== 'undefined' && typeof window.producedPiecesCore === 'function') {
          prod = Number(window.producedPiecesCore(c, oreRows) || 0);
        } else if (typeof producedPieces === 'function') {
          prod = Number(producedPieces(c, oreRows) || 0);
        }
      }catch(_){
        prod = 0;
      }

      const residuo = (typeof residualPieces === 'function')
        ? Number(residualPieces(c, oreRows) || 0)
        : Math.max(0, tot - prod);

      const lastRow = (Array.isArray(oreRows)?oreRows:[]).filter(o => o.commessaId === c.id)
        .sort((a,b)=> (Date.parse(b.__createdAt||b.data||0) - Date.parse(a.__createdAt||a.data||0)))[0];
      const lastTime = lastRow ? (Date.parse(lastRow.__createdAt||lastRow.data||0)||0) : 0;
      const fermeMs = lastTime ? (now - lastTime) : Infinity;

      const sforo = (planTot>0 && effTot > planTot + 1);
      const ferme24h = residuo>0 && (fermeMs > 24*3600*1000);

      return sforo || ferme24h ? {
        c, residuo, planTot, effTot,
        cause: [
          sforo ? `SFORO ore: prev. ${fmtHHMM(planTot)} vs eff. ${fmtHHMM(effTot)}` : null,
          ferme24h ? `Ferma da >24h` : null
        ].filter(Boolean).join(' · ')
      } : null;
    })
    .filter(Boolean)
    .sort((a,b)=> {
      const dSforo = (b.effTot - b.planTot) - (a.effTot - a.planTot);
      if (dSforo !== 0 && isFinite(dSforo)) return dSforo;
      return b.residuo - a.residuo;
    })
    .slice(0, 10);

      // 4) Saturazione reparti (ultimi 7 giorni, ore effettive)
  const satReparti = (function(){
    const dayMs = 24*60*60*1000;

    let periodEnd = today;
    let periodStart = today;
    try{
      const dt = new Date(today + 'T00:00:00');
      dt.setDate(dt.getDate() - 6); // ultimi 7 giorni inclusi
      periodStart = dt.toISOString().slice(0,10);
    }catch(_){
      periodStart = today;
    }

    // Capacità reparti in minuti/settimana (da Impostazioni → Capacità reparti)
    let capMinByRep = {};
    try{
      const app = (typeof lsGet === 'function')
        ? lsGet('appSettings', {})
        : JSON.parse(localStorage.getItem('appSettings')||'{}');

      const src = app && app.capacitaReparti && typeof app.capacitaReparti === 'object'
        ? app.capacitaReparti
        : {};

      const out = {};
      Object.keys(src).forEach(name => {
        const ore = Number(src[name]);
        if (!Number.isFinite(ore) || ore <= 0) return;
        const key = String(name).trim();
        if (!key) return;
        out[key] = ore * 60; // minuti/settimana
      });
      capMinByRep = out;
    }catch(_){
      capMinByRep = {};
    }

    // Aggrego minuti timbrati per reparto/fase nell'intervallo [periodStart, periodEnd]
        const totMinByRep = {};
    let senzaFaseCount = 0;
    const esempiSenzaFase = [];

    (Array.isArray(oreRows)?oreRows:[]).forEach(row => {
      if (!row || row.deletedAt) return;

      const dIso = String(row.data || '').slice(0,10);
      if (!dIso) return;
      if (dIso < periodStart || dIso > periodEnd) return;

      // Escludo righe "extra gas" se riconosciute (usa helper globale window.isGasNote)
      try{
        if ((row.faseIdx == null || row.faseIdx === '') &&
            typeof window !== 'undefined' &&
            typeof window.isGasNote === 'function' &&
            window.isGasNote(row.note)) {
          return;
        }
      }catch(_){}

      const mins = Number(row.oreMin) || toMin(row.oreHHMM) || 0;
      if (!mins) return;

      let rep = '';
      try{
        if (typeof window !== 'undefined' && typeof window.faseLabelFromRow === 'function'){
          rep = window.faseLabelFromRow(row);
        }
      }catch(_){}
      rep = String(rep || '').trim() || '[Senza fase]';

      if (rep === '[Senza fase]') {
        senzaFaseCount++;
        if (esempiSenzaFase.length < 5) {
          esempiSenzaFase.push({
            id         : row.id,
            data       : row.data,
            commessaId : row.commessaId,
            operatore  : row.operatore || '',
            note       : row.note || ''
          });
        }
      }

      totMinByRep[rep] = (totMinByRep[rep] || 0) + mins;
    });


    const reps = new Set([
      ...Object.keys(capMinByRep),
      ...Object.keys(totMinByRep)
    ]);

    const rows = Array.from(reps)
      .map(rep => {
        const minuti = Math.round(totMinByRep[rep] || 0);
        const capMin = Math.round(capMinByRep[rep] || 0);
        const satPerc = capMin > 0 ? Math.round((minuti * 100) / capMin) : null;
        return { reparto: rep, minuti, capMin, saturazionePerc: satPerc };
      })
      // mostro solo reparti che hanno capacità o carico
      .filter(r => r.minuti > 0 || r.capMin > 0)
      // ordino per saturazione decrescente, poi per minuti
      .sort((a,b) => {
        const pa = (typeof a.saturazionePerc === 'number') ? a.saturazionePerc : -1;
        const pb = (typeof b.saturazionePerc === 'number') ? b.saturazionePerc : -1;
        if (pb !== pa) return pb - pa;
        return (b.minuti - a.minuti);
      });

          if (typeof console !== 'undefined' && senzaFaseCount > 0) {
      try{
        console.warn('[Dashboard/Saturazione] Ore senza fase (ultimi 7 giorni):',
          senzaFaseCount, 'righe. Esempi:', esempiSenzaFase);
      }catch(_){}
    }

    return { rows, periodStart, periodEnd, capMinByRep };
  })();

  // ---- UI helper ----
  // Ricostruisce il nome fase usando anche fasi per-riga, commessa e appSettings
  function inferFaseLabelRow(row){
    if (!row || typeof row !== 'object') return '';

    const idxRaw = row.faseIdx;
    if (idxRaw === '' || idxRaw == null) return '';
    const idx = Number(idxRaw);
    if (!Number.isFinite(idx) || idx < 0) return '';

    // Prova a recuperare la commessa, se disponibile;
    // se non la troviamo, useremo comunque le fasiStandard da appSettings.
    let c = null;
    try{
      const commId = row.commessaId != null ? String(row.commessaId) : '';
      if (commId){
        const allC = Array.isArray(commesse) ? commesse : [];
        c = allC.find(x => String(x.id) === commId) || null;
      }
    }catch(_){
      c = null;
    }

    // 1) Fasi per-riga articolo, se abbiamo rigaIdx e la commessa
    try{
      if (c){
        const righe = Array.isArray(c.righeArticolo)
          ? c.righeArticolo
          : (Array.isArray(c.righe) ? c.righe : []);
        const rIdxRaw = row.rigaIdx;
        const rIdx = (rIdxRaw === '' || rIdxRaw == null) ? null : Number(rIdxRaw);

        if (
          Number.isFinite(rIdx) &&
          rIdx >= 0 &&
          Array.isArray(righe) &&
          righe[rIdx] &&
          Array.isArray(righe[rIdx].fasi)
        ){
          const f = righe[rIdx].fasi[idx];
          if (f){
            const lab = f.lav || f.label || f.nome || f.reparto || f.repartoNome || '';
            if (lab) return String(lab).trim();
          }
        }
      }
    }catch(_){}

    // 2) Fasi globali commessa (se abbiamo la commessa)
    try{
      if (c){
        const fasiG = Array.isArray(c.fasi) ? c.fasi : [];
        if (fasiG[idx]){
          const f = fasiG[idx];
          const lab = f.lav || f.label || f.nome || f.reparto || f.repartoNome || '';
          if (lab) return String(lab).trim();
        }
      }
    }catch(_){}

    // 3) Fasi standard da appSettings (stesso indice), anche se non troviamo la commessa
    try{
      const app = (typeof lsGet === 'function')
        ? lsGet('appSettings', {})
        : (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}'); }catch{ return {}; } })();

      const fas = Array.isArray(app && app.fasiStandard) ? app.fasiStandard : [];
      const entry = fas[idx];
      if (entry){
        const lab = (typeof entry === 'string')
          ? entry
          : (entry.label || entry.nome || entry.lav || '');
        if (lab) return String(lab).trim();
      }
    }catch(_){}

    // Se non ho trovato nulla, lascio vuoto: deciderà opFaseLabel
    return '';
  }

  function opFaseLabel(row){
    const op = row && row.operatore ? row.operatore : '—';

    // 0) Se esiste il helper centrale, usiamolo per il nome fase
    if (typeof window !== 'undefined'
      && typeof window.faseLabelFromRow === 'function') {
      const lab = window.faseLabelFromRow(row) || 'Intera commessa';
      return `${op} – ${lab}`;
    }

    const idx = row ? row.faseIdx : null;

    // 1) Se abbiamo salvato il nome fase nel record ore, ma NON è "Fase N", usiamo quello
    const storedRaw = row && row.faseLabelAtReg
      ? String(row.faseLabelAtReg).trim()
      : '';
    const isGeneric = /^fase\s+\d+$/i.test(storedRaw);
    if (storedRaw && !isGeneric) return `${op} – ${storedRaw}`;

    // 2) Se non c’è fase → gestisco extra "Cambio bombola gas" oppure "Intera commessa"
    const isGas = /cambio\s*bombola\s*gas/i.test(String(row && row.note || ''));
    if (idx === '' || idx == null){
      return isGas ? `${op} – EXTRA: Cambio Bombola Gas` : `${op} – Intera commessa`;
    }

    // 3) Prova a inferire il nome fase usando commessa + riga + appSettings
    const inferred = inferFaseLabelRow(row);
    if (inferred) return `${op} – ${inferred}`;

    // 4) Fallback: usa ancora window.faseLabel (potrebbe restituire "Fase N")
    const c = (Array.isArray(commesse)?commesse:[]).find(x => String(x.id) === String(row.commessaId));
    const label = (typeof window.faseLabel === 'function')
      ? window.faseLabel(c, Number(idx))
      : `Fase ${(Number(idx)||0)+1}`;
    return `${op} – ${label}`;
  }

  function descrForCommessaDashboard(c) {
    try{
      const comm = c || {};

      // 1) Numero ordine (usa lo stesso helper che usi nel resto dell’app)
      let ref = '';
      try{
        if (typeof window.orderRefFor === 'function') {
          ref = window.orderRefFor(comm) || '';
        } else {
          const r = comm.ordineCliente
            || comm.nrOrdineCliente
            || comm.ddtCliente
            || comm.ordine
            || comm.ordineId
            || comm.rifCliente
            || '';
          ref = (window.refClienteToText ? window.refClienteToText(r) : String(r||'')).trim();
        }
      }catch{
        ref = '';
      }

      // 2) Data ordine (ISO → data italiana)
      let dataTxt = '';
      try{
        const rawDate = comm.dataOrdine || '';
        if (rawDate) {
          const s = String(rawDate).trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            // es. "2025-10-14" → "14/10/2025"
            const dt = new Date(s + 'T00:00:00');
            if (!isNaN(dt.getTime())) {
              dataTxt = dt.toLocaleDateString('it-IT');
            } else {
              dataTxt = s;
            }
          } else {
            // se fosse già in formato italiano, lo mostro così com’è
            dataTxt = s;
          }
        }
      }catch{
        dataTxt = '';
      }

      // 3) Composizione finale "ordine — data"
      if (ref && dataTxt) return `${ref} — ${dataTxt}`;
      if (ref)            return ref;
      if (dataTxt)        return dataTxt;
      return '-';
    } catch {
      return '-';
    }
  }

  function RowPronta({ x }) {
    const e = React.createElement;
    const c = x?.c || x || {};

    const idCell = c.id
      ? e('a', {
          href: `#/commesse?q=${encodeURIComponent(c.id)}`,
          onClick: ev => ev.stopPropagation && ev.stopPropagation()
        }, c.id)
      : '-';

    return e('tr', null,
      e('td', null, idCell),
      e('td', null, c.cliente || '-'),
      e('td', null, descrForCommessaDashboard(c)),
      e('td', { className:'right' }, String(c.qtaPezzi || 1)),
      e('td', { className:'right' }, '100%')
    );
  }

  function RowToday(o){
    return e('tr', {key:o.id},
      e('td', null, o.id),
      e('td', null, o.commessaId || '-'),
      e('td', null, opFaseLabel(o)),
      e('td', {className:'right'}, fmtHHMM(Number(o.oreMin)||toMin(o.oreHHMM)||0))
    );
  }
  function RowAllarme(a){
    const e = React.createElement;
    const c = (a && a.c) ? a.c : {};

    const idCell = c.id
      ? e('a', {
          href: `#/commesse?q=${encodeURIComponent(c.id)}`,
          onClick: ev => ev.stopPropagation && ev.stopPropagation()
        }, c.id)
      : '-';

    return e('tr', { key: c.id || undefined },
      e('td', null, idCell),
      e('td', null, c.cliente || '-'),
      e('td', null, descrForCommessaDashboard(c)),
      e('td', { className:'right' }, fmtHHMM(a.planTot)),
      e('td', { className:'right' }, fmtHHMM(a.effTot)),
      e('td', null, a.cause)
    );
  }

  function RowRadar({ x }){
    const e = React.createElement;
    const c = (x && x.c) ? x.c : {};

    const days = (x && typeof x.diffDays === 'number') ? x.diffDays : null;
    let giorniLabel = '';
    if (days == null)      giorniLabel = '-';
    else if (days === 0)   giorniLabel = 'Oggi';
    else if (days < 0)     giorniLabel = `${days}g`;
    else                   giorniLabel = `+${days}g`;

    const scad = (function(){
      try{
        if (!x || !x.scadenzaISO) return '-';
        const dt = new Date(x.scadenzaISO);
        if (isNaN(dt.getTime())) return x.scadenzaISO;
        return dt.toLocaleDateString('it-IT');
      }catch{
        return x.scadenzaISO || '-';
      }
    })();

    const idCell = c.id
      ? e('a', {
          href: `#/commesse?q=${encodeURIComponent(c.id)}`,
          onClick: ev => ev.stopPropagation && ev.stopPropagation()
        }, c.id)
      : '-';

    return e('tr', null,
      e('td', null, idCell),
      e('td', null, c.cliente || '-'),
      e('td', null, descrForCommessaDashboard(c)),
      e('td', {className:'right'}, scad),
      e('td', {className:'right'}, giorniLabel),
      e('td', {className:'right'}, String(x && x.residuo != null ? x.residuo : '')),
      e('td', null, x && x.stato ? x.stato : '')
    );
  }

  // ---- Render ----
  return e('div', {className:'grid dashboard-grid', style:{gap:16}},
    e('div', {className:'muted dashboard-intro'}, 'Vista PC: avanzamento commesse e scorciatoie utili.'),

    // Widget 1: Radar urgenze (scadenze a breve)
    e('div', {className:'card'},
      e('h3', null, 'Radar urgenze (scadenze a breve)'),
      radar.length === 0
        ? e('div', {className:'muted'}, 'Nessuna commessa urgente nelle ultime/ prossime settimane.')
        : e('table', {className:'table'},
            e('thead', null, e('tr', null,
              e('th', null, 'ID'),
              e('th', null, 'Cliente'),
              e('th', null, 'Descrizione'),
              e('th', {className:'right'}, 'Scadenza'),
              e('th', {className:'right'}, 'Giorni'),
              e('th', {className:'right'}, 'Residuo'),
              e('th', null, 'Stato')
            )),
            e('tbody', null, radar.map((x,i)=> e(RowRadar, {key:i, x})))
          )
    ),

    // Widget 2: Commesse pronte
    e('div', {className:'card'},
      e('h3', null, 'Commesse pronte (residuo = 0)'),
      pronte.length === 0
        ? e('div', {className:'muted'}, 'Nessuna commessa pronta.')
        : e('table', {className:'table'},
            e('thead', null, e('tr', null,
              e('th', null, 'ID'),
              e('th', null, 'Cliente'),
              e('th', null, 'Descrizione'),
              e('th', {className:'right'}, 'Pezzi'),
              e('th', {className:'right'}, 'Completamento')
            )),
            e('tbody', null, pronte.map((x,i)=> e(RowPronta, {key:i, x})))
          )
    ),

    // Widget 3: Timbrature di oggi
    e('div', {className:'card'},
      e('h3', null, 'Timbrature di oggi'),
      oggiRows.length === 0
        ? e('div', {className:'muted'}, 'Nessuna timbratura registrata oggi.')
        : e('table', {className:'table'},
            e('thead', null, e('tr', null,
              e('th', null, 'ID reg.'),
              e('th', null, 'Commessa'),
              e('th', null, 'Operatore / Fase'),
              e('th', {className:'right'}, 'Minuti')
            )),
            e('tbody', null, oggiRows.map(RowToday))
          )
    ),

    // Widget 4: Allarmi
    e('div', {className:'card'},
      e('h3', null, 'Allarmi (sforo ore / fermi >24h)'),
      allarmi.length === 0
        ? e('div', {className:'muted'}, 'Nessun allarme.')
        : e('table', {className:'table'},
            e('thead', null, e('tr', null,
              e('th', null, 'ID'),
              e('th', null, 'Cliente'),
              e('th', null, 'Descrizione'),
              e('th', {className:'right'}, 'Ore previste'),
              e('th', {className:'right'}, 'Ore effettive'),
              e('th', null, 'Note')
            )),
            e('tbody', null, allarmi.map(RowAllarme))
          )
    ),

    // Widget 5: Saturazione reparti (ultimi 7 giorni, ore effettive)
    e('div', { className:'card' },
      e('h3', null, 'Saturazione reparti (ultimi 7 giorni)'),
      e('p', { className:'muted', style:{ fontSize:11, marginTop:4 } },
        'Periodo: ', satReparti.periodStart, ' → ', satReparti.periodEnd
      ),
      (!satReparti.rows || satReparti.rows.length === 0)
        ? e('div', { className:'muted', style:{ marginTop:8 } },
            'Nessuna timbratura negli ultimi 7 giorni o nessuna capacità reparti definita in Impostazioni.'
          )
        : e('table', { className:'table', style:{ marginTop:8 } },
            e('thead', null,
              e('tr', null,
                e('th', null, 'Reparto'),
                e('th', { className:'right' }, 'Ore'),
                e('th', { className:'right' }, '% capacità')
              )
            ),
            e('tbody', null,
              satReparti.rows.map(r => {
                const perc = r.saturazionePerc;
                let cellStyle = { textAlign:'right', whiteSpace:'nowrap' };

                if (typeof perc === 'number') {
                  if (perc > 100){
                    cellStyle.background = '#fee2e2';
                    cellStyle.fontWeight = 600;
                  } else if (perc >= 70){
                    cellStyle.background = '#fef9c3';
                  } else {
                    cellStyle.background = '#dcfce7';
                  }
                }

                return e('tr', { key: r.reparto },
                  e('td', null, r.reparto || '-'),
                  e('td', { className:'right' }, fmtHHMM(r.minuti)),
                  e('td', { style: cellStyle },
                    typeof perc === 'number' ? (perc + '%') : '—'
                  )
                );
              })
            )
          )
    ),

    e(CloudStatusWidget, null)
  );
}
window.DashboardView = DashboardView;

/* ================== ANAGRAFICA CLIENTI (con SDI/PEC/pagamento/IBAN/plafond) ================== */
function ClientiView(){
  const e = React.createElement;

  // RBAC sola lettura (accountant / viewer / mobile)
  const readOnly = (typeof window.isReadOnlyUser === 'function'
    ? !!window.isReadOnlyUser()
    : !!(window.__USER && window.__USER.role === 'accountant'));

  const roBtnProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));

    const blank = {
    id:'', ragione:'', piva:'', email:'',
    sedeLegale:'', sedeOperativa:'',
    codiceUnivoco:'', pec:'',
    telefono:'', fax:'', cf:'',
    pagamento:'Immediato', iban:'',
    plafond:false, naturaIva:'N3.5 Plafond',
    note:''
  };


  // alias globali
  const lsGet = window.lsGet;
  const lsSet = window.lsSet;

  // stato
  const [rows, setRows] = React.useState(()=> lsGet('clientiRows', []));

  // Persistenza immediata per Clienti
  function persistClienti(next){
    try { localStorage.setItem('clientiRows', JSON.stringify(next)); } catch {}
    setRows(next);
    window.__anima_dirty = true;
    try { if (window.requestAppRerender) window.requestAppRerender(); } catch {}
    // ➜ push selettivo immediato (se il cloud è configurato)
    try { window.syncExportToCloudOnly && window.syncExportToCloudOnly(['clientiRows']); } catch {}
  }

  React.useEffect(()=> lsSet('clientiRows', rows), [rows]);

  // --- selezione righe per elimina bulk ---
  const [sel, setSel] = React.useState({}); // { [id]: true }

  function toggleRow(id){ setSel(p=>({ ...p, [id]: !p[id] })); }

  function toggleAll(list){
    const allOn = (list||[]).every(r=> sel[String(r.id)]);
    if (allOn) {
      const next = {...sel}; (list||[]).forEach(r=> delete next[String(r.id)]);
     setSel(next);
    } else {
      const next = {...sel}; (list||[]).forEach(r=> next[String(r.id)] = true);
     setSel(next);
   }
  }

  function delSelected(){
    const idsSel = Object.keys(sel).filter(k => sel[k]);
    if (!idsSel.length) { alert('Nessuna selezione'); return; }
    if (!confirm(`Eliminare ${idsSel.length} clienti selezionati?`)) return;
    const all = (function(){ try { return JSON.parse(localStorage.getItem('clientiRows')||'[]'); } catch { return []; }})();
    const next = all.filter(x => !idsSel.includes(String(x.id)));
    persistClienti(next);
    setSel({});
    alert('Eliminate selezionate ✅');
  }
  const [q, setQ] = React.useState('');
  const [form, setForm] = React.useState(blank);
  const [editingId, setEditingId] = React.useState(null);
  const [statoFilter, setStatoFilter] = React.useState('');
  const [showForm, setShowForm] = React.useState(false);

  function openNew(){ setForm(blank); setEditingId(null); setShowForm(true); }
  function openEdit(id){
    const x = rows.find(r=> String(r.id)===String(id)); if(!x) return;
    setForm({ ...blank, ...x });
    setEditingId(id); setShowForm(true);
  }
  function del(id){
    if (!confirm('Eliminare il cliente?')) return;
    const all = (function(){ try { return JSON.parse(localStorage.getItem('clientiRows')||'[]'); } catch { return []; }})();
    const next = all.filter(x => String(x.id) !== String(id));
    persistClienti(next);
    alert('Cliente eliminato ✅');
  }

  function onChange(ev){
    const {name,value,type,checked}=ev.target;
    setForm(p=>({ ...p, [name]: (type==='checkbox'? checked : value) }));
  }

  function save(){
    // id stabile: se non c’è usa email/piva/ragione o fallback
    const safeId =
      (form.id && String(form.id).trim()) ||
      (form.email && String(form.email).trim()) ||
      (form.piva && String(form.piva).trim()) ||
      (form.ragione && String(form.ragione).trim()) ||
      ('CLI-' + Date.now());

    const rec = { ...form, id: safeId };

    const all = (function(){ try { return JSON.parse(localStorage.getItem('clientiRows')||'[]'); } catch { return []; } })();
    const ix = all.findIndex(x => String(x.id) === String(rec.id));
    if (ix >= 0) all[ix] = rec; else all.push(rec);

    persistClienti(all);
    setShowForm(false);
    alert('Cliente salvato ✅');
  }

  // ===== Import CSV =====
  const fileCliRef = React.useRef(null);

  function csvToObjects(text, delimGuess){
    const delim = delimGuess || (text.indexOf(';')>-1 ? ';' : ',');
    const rows = [];
    let inQ=false, cell='', row=[];
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      if(inQ){
        if(ch==='"'){ if(text[i+1]==='"'){cell+='"'; i++;} else inQ=false; }
        else cell+=ch;
      }else{
        if(ch==='"') inQ=true;
        else if(ch===delim){ row.push(cell); cell=''; }
        else if(ch==='\r'){ /* skip */ }
        else if(ch==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
        else cell+=ch;
      }
    }
    if(cell.length||row.length){ row.push(cell); rows.push(row); }
    if(!rows.length) return [];
    const header = rows[0].map(h=> String(h||'').trim());
    const out = [];
    for(let r=1;r<rows.length;r++){
      const o={}; for(let c=0;c<header.length;c++) o[header[c]] = rows[r][c] ?? '';
      out.push(o);
    }
    return out;
  }

    function normKey(k){
    k = String(k||'').trim().toLowerCase();
    if (k.includes('ragione')) return 'ragione';
    if (k.includes('p.iva') || k.includes('piva') || k.includes('partita')) return 'piva';
    if (k==='email' || k.includes('mail')) return 'email';
    if (k.includes('pec')) return 'pec';
    if (k.includes('tel')) return 'telefono';
    if (k.includes('fax')) return 'fax';
    if (k==='cf' || k.includes('codice fiscale')) return 'cf';
    if (k.includes('codice') && k.includes('univ')) return 'codiceUnivoco';
    if (k.includes('pagamento')) return 'pagamento';
    if (k.includes('iban')) return 'iban';
    if (k.includes('plafond')) return 'plafond';
    if (k.includes('natura') && k.includes('iva')) return 'naturaIva';
    if (k.includes('sede') && k.includes('legale')) return 'sedeLegale';
    if (k.includes('sede') && k.includes('operat')) return 'sedeOperativa';
    if (k.includes('note')) return 'note';
    return k;
  }

  function mapCliente(o){
    const out = {};
    Object.keys(o||{}).forEach(k=>{ out[normKey(k)] = o[k]; });
    out.plafond = (String(out.plafond||'').toLowerCase()==='true' || String(out.plafond||'').toLowerCase()==='si');
    return out;
  }
  function keyCliente(c){
    // chiave di merge: P.IVA se c'è, altrimenti ragione
    return (String(c.piva||'').trim().toLowerCase())
      || ('rag:'+String(c.ragione||'').trim().toLowerCase());
  }

  async function handleClientiImportFile(ev){
    try{
      const file = ev?.target?.files?.[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.csv')) { alert('Importa un CSV (punto e virgola o virgola).'); return; }
      const text = await file.text();
      const rowsX = csvToObjects(text);
      if (!rowsX.length) { alert('Il file non contiene righe'); fileCliRef.current && (fileCliRef.current.value=''); return; }

      const imported = rowsX.map(mapCliente).filter(c=> c.ragione || c.piva);
      if (!imported.length) { alert('Nessun cliente valido'); fileCliRef.current && (fileCliRef.current.value=''); return; }

      // merge con esistenti (usiamo localStorage diretto per coerenza col write atomico)
      const cur = (function(){ try { return JSON.parse(localStorage.getItem('clientiRows')||'[]'); } catch { return []; } })();
      const map = new Map((Array.isArray(cur)?cur:[]).map(c=> [keyCliente(c), c]));

      imported.forEach(c=>{
        const k = keyCliente(c); if (!k) return;
        const old = map.get(k) || {};
        // id stabile: tieni l'esistente se c'è, altrimenti genera
        const id = old.id || ('CLI-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
        map.set(k, { ...old, ...c, id });
      });

      const next = Array.from(map.values())
        .sort((a,b)=> String(a.ragione||'').localeCompare(String(b.ragione||'')));

      // 🔐 scrivi SUBITO e aggiorna UI
      persistClienti(next);

      alert(`Import clienti completato: ${imported.length} righe (totale: ${next.length}).`);
      fileCliRef.current && (fileCliRef.current.value='');
    }catch(err){
      console.error(err);
      alert('Errore durante import CSV clienti.');
      fileCliRef.current && (fileCliRef.current.value='');
    }
  }
  function onImportCliClick(){ fileCliRef.current && fileCliRef.current.click(); }

    const filtered = (Array.isArray(rows)?rows:[]).filter(r=>{
    const s = q.trim().toLowerCase(); if(!s) return true;
    return (
      (
        String(r.ragione||'')+' '+
        String(r.piva||'')+' '+
        String(r.cf||'')+' '+
        String(r.email||'')+' '+
        String(r.pec||'')+' '+
        String(r.telefono||'')+' '+
        String(r.fax||'')+' '+
        String(r.note||'')
      ).toLowerCase().includes(s)
    );
  }).sort((a,b)=> String(a.ragione||'').localeCompare(String(b.ragione||'')));

  return e('div', {className:'page'},
    e('div',{className:'toolbar'},
      e('input',{placeholder:'Cerca...',value:q,onChange:ev=>setQ(ev.target.value)}),
      e('button', {className:'btn', onClick:openNew, ...roBtnProps()}, '➕ Nuovo cliente'),
      e('button', { className:'btn btn-outline', type:'button', onClick:onImportCliClick, ...roBtnProps() }, '⬆️ Importa (.csv)'),
      e('input', { type:'file', accept:'.csv', ref:fileCliRef, style:{display:'none'}, onChange:handleClientiImportFile })
    ),
    showForm && e('form',{
      className:'card',
      onSubmit:(ev)=>{ ev.preventDefault(); save(); },
      style:{ padding:12 }
    },
      e('h3', null, editingId ? `Modifica ${form.ragione||''}` : 'Nuovo cliente'),

      e('div', {
        className:'form',
        style:{ gridTemplateColumns:'repeat(auto-fit,minmax(240px,1fr))', gap:12 }
      },

        // --- Dati anagrafici ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1'}}, 'Dati anagrafici'),

        e('div',{className:'form-row'},
          e('label', null, 'Ragione sociale'),
          e('input', {
            name:'ragione',
            value:form.ragione||'',
            onChange:onChange,
            placeholder:'es. Rossi Srl'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Partita IVA'),
          e('input', {
            name:'piva',
            value:form.piva||'',
            onChange:onChange,
            placeholder:'es. 01234567890'
          })
        ),
                e('div',{className:'form-row'},
          e('label', null, 'Email'),
          e('input', {
            name:'email',
            type:'email',
            value:form.email||'',
            onChange:onChange,
            placeholder:'es. amministrazione@cliente.it'
          })
        ),

        // --- Contatti ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Contatti'),

        e('div',{className:'form-row'},
          e('label', null, 'PEC'),
          e('input', {
            name:'pec',
            value:form.pec||'',
            onChange:onChange,
            placeholder:'es. cliente@pec.it'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Telefono'),
          e('input', {
            name:'telefono',
            value:form.telefono||'',
            onChange:onChange,
            placeholder:'es. +39 049...'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Fax'),
          e('input', {
            name:'fax',
            value:form.fax||'',
            onChange:onChange
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Codice fiscale'),
          e('input', {
            name:'cf',
            value:form.cf||'',
            onChange:onChange,
            placeholder:'se diverso dalla P.IVA'
          })
        ),

        // --- Indirizzi ---
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Sede legale'),
          e('input', {
            name:'sedeLegale',
            value:form.sedeLegale||'',
            onChange:onChange,
            placeholder:'via, CAP, città, provincia'
          })
        ),
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Sede operativa'),
          e('input', {
            name:'sedeOperativa',
            value:form.sedeOperativa||'',
            onChange:onChange,
            placeholder:'se diversa dalla sede legale'
          })
        ),

        // --- Fatturazione elettronica / fiscali ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Dati fiscali e fatturazione elettronica'),

        e('div',{className:'form-row'},
          e('label', null, 'Codice Univoco SDI'),
          e('input', {
            name:'codiceUnivoco',
            value:form.codiceUnivoco||'',
            onChange:onChange,
            placeholder:'es. ABCDEF1'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'PEC'),
          e('input', {
            name:'pec',
            value:form.pec||'',
            onChange:onChange,
            placeholder:'es. azienda@pec.it'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Pagamento (predefinito)'),
          e('input', {
            name:'pagamento',
            value:form.pagamento||'',
            onChange:onChange,
            placeholder:'es. Rimessa diretta 30 gg'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'IBAN / coordinate bancarie'),
          e('input', {
            name:'iban',
            value:form.iban||'',
            onChange:onChange,
            placeholder:'es. IT00A0000000000000000000000'
          })
        ),

        e('div',{className:'form-row form-row-full'},
          e('label', {className:'row', style:{gap:8, alignItems:'center', marginTop:4}},
            e('input', {
              type:'checkbox',
              name:'plafond',
              checked:!!form.plafond,
              onChange:onChange
            }),
            e('span', null, 'Cliente a plafond (IVA 0)')
          )
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Natura IVA (se plafond)'),
          e('input', {
            name:'naturaIva',
            value:form.naturaIva||'',
            onChange:onChange,
            placeholder:'es. N3.5 – operazioni non imponibili'
          })
        ),

        // --- Note ---
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Note interne'),
          e('textarea', {
            name:'note',
            value:form.note||'',
            onChange:onChange,
            rows:2,
            placeholder:'Note sul cliente, condizioni particolari…'
          })
        )
      ),

      e('div',{className:'actions', style:{justifyContent:'flex-end', gap:8, marginTop:8}},
        e('button',{
          type:'button',
          className:'btn btn-outline',
          onClick:()=>{ setShowForm(false); setEditingId(null); }
        }, 'Annulla'),
        e('button',{className:'btn', type:'submit', ...roBtnProps()}, 'Salva')
      )
    ),
    e('div',{className:'card',style:{marginTop:8,overflowX:'auto'}},
      e('table',{className:'table'},
        e('thead', null, e('tr', null,
    e('th', {style:{width:36, textAlign:'center'}},
      e('input', {
        type:'checkbox',
        ref: el => { if (el) el.indeterminate = (filtered.some(c=>sel[String(c.id)]) && !filtered.every(c=>sel[String(c.id)])); },
        checked: (filtered.length>0 && filtered.every(c=>sel[String(c.id)])),
        onChange: () => toggleAll(filtered)
      })
    ),
    e('th', null, 'Ragione sociale'),
    e('th', null, 'P.IVA'),
    e('th', null, 'Email'),
    e('th', {style:{width:220}},
      e('div', {className:'row', style:{justifyContent:'space-between', gap:8}},
        e('span', null, 'Azioni'),
        e('button', {
           className:'btn btn-outline',
          disabled: Object.keys(sel).filter(k=>sel[k]).length===0,
          onClick: delSelected,
          ...roBtnProps()
        }, '🗑 Elimina selezionati')
      )
    )
  )),
        e('tbody',null,
          filtered.map(c=> e('tr',{key:c.id},
            e('td',{style:{textAlign:'center'}},
              e('input',{
               type:'checkbox',
                checked: !!sel[String(c.id)],
                onChange: ()=> toggleRow(String(c.id))
              })
            ),
            e('td',null,c.ragione||''),
            e('td',null,c.piva||''),
            e('td',null,c.email||'-'),
            e('td',null,
              e('button',{className:'btn btn-outline',onClick:()=>openEdit(c.id)},'Apri'),' ',
              e('button',{className:'btn btn-outline',onClick:()=>del(c.id)},'🗑')
            )
          ))
        )
      )
    )
  );
}
window.ClientiView = ClientiView;

/* ================== FORNITORI ================== */
function FornitoriView(){
  const e = React.createElement;

  // RBAC sola lettura (accountant / viewer / mobile)
  const readOnly = (typeof window.isReadOnlyUser === 'function'
    ? !!window.isReadOnlyUser()
    : !!(window.__USER && window.__USER.role === 'accountant'));

  const roBtnProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));
  const lsGet = window.lsGet, lsSet = window.lsSet;

  // aggiunti: cf, pec, telefono, fax, codiceUnivoco, banca, iban, intestatario
  const blank = {
    id:'',
    ragione:'',
    sedeLegale:'',
    sedeOperativa:'',
    piva:'',
    cf:'',
    email:'',
    pec:'',
    telefono:'',
    fax:'',
    codiceUnivoco:'',
    banca:'',
    iban:'',
    intestatario:'',
    note:''
  };

  const [rows, setRows] = React.useState(() => lsGet('fornitoriRows', []));

  function persistFornitori(next){
    try { localStorage.setItem('fornitoriRows', JSON.stringify(next)); } catch {}
    setRows(next);
    window.__anima_dirty = true;
    try { if (window.requestAppRerender) window.requestAppRerender(); } catch {}
    try { window.syncExportToCloudOnly && window.syncExportToCloudOnly(['fornitoriRows']); } catch {}
  }

  React.useEffect(() => lsSet('fornitoriRows', rows), [rows]);

  // --- selezione righe per elimina bulk ---
  const [sel, setSel] = React.useState({}); // { [id]: true }

  function toggleRow(id){ setSel(p=>({ ...p, [id]: !p[id] })); }

  function toggleAll(list){
    const allOn = (list||[]).every(r=> sel[String(r.id)]);
    if (allOn) {
      const next = {...sel}; (list||[]).forEach(r=> delete next[String(r.id)]);
      setSel(next);
    } else {
      const next = {...sel}; (list||[]).forEach(r=> next[String(r.id)] = true);
      setSel(next);
    }
  }

  function delSelected(){
    const idsSel = Object.keys(sel).filter(k => sel[k]);
    if (!idsSel.length) { alert('Nessuna selezione'); return; }
    if (!confirm(`Eliminare ${idsSel.length} fornitori selezionati?`)) return;
    const all = (function(){ try { return JSON.parse(localStorage.getItem('fornitoriRows')||'[]'); } catch { return []; }})();
    const next = all.filter(x => !idsSel.includes(String(x.id)));
    persistFornitori(next);
    setSel({});
    alert('Eliminate selezionate ✅');
  }

  const [q, setQ] = React.useState('');
  const [form, setForm] = React.useState(blank);
  const [editingId, setEditingId] = React.useState(null);
  const [showForm, setShowForm] = React.useState(false);

  function openNew(){
    setForm(blank);
    setEditingId(null);
    setShowForm(true);
  }

  function openEdit(id){
    const x = rows.find(r => r.id === id);
    if(!x) return;
    setForm({ ...blank, ...x });
    setEditingId(id);
    setShowForm(true);
  }

  function onChange(ev){
    const {name, value} = ev.target;
    setForm(p => ({...p, [name]: value}));
  }

  function save(ev){
    ev && ev.preventDefault();
    if (!form.ragione.trim()) { alert('Inserisci la ragione sociale'); return; }

    const rec = {...form};
    rec.id = editingId ? editingId : 'FO-'+Math.random().toString(36).slice(2,8).toUpperCase();

    const next = rows
      .filter(r => r.id !== rec.id)
      .concat(rec)
      .sort((a,b)=> (a.ragione||'').localeCompare(b.ragione||''));

    persistFornitori(next);
    setShowForm(false);
    setEditingId(null);
  }

  function del(id){
    if (!confirm('Eliminare il fornitore?')) return;
    const all = (function(){ try { return JSON.parse(localStorage.getItem('fornitoriRows')||'[]'); } catch { return []; }})();
    const next = all.filter(x => String(x.id) !== String(id));
    persistFornitori(next);
    alert('Fornitore eliminato ✅');
  }

  const filtered = rows
    .filter(r => {
      const s = q.toLowerCase();
      return (
        (String(r.ragione||'')+' '+
         String(r.piva||'')+' '+
         String(r.cf||'')+' '+
         String(r.email||'')+' '+
         String(r.pec||'')+' '+
         String(r.telefono||'')+' '+
         String(r.fax||'')+' '+
         String(r.codiceUnivoco||'')+' '+
         String(r.sedeLegale||'')+' '+
         String(r.sedeOperativa||'')+' '+
         String(r.banca||'')+' '+
         String(r.iban||'')+' '+
         String(r.intestatario||'')+' '+
         String(r.note||'')
        ).toLowerCase().includes(s)
      );
    })
    .sort((a,b)=> String(a.ragione||'').localeCompare(String(b.ragione||'')));

  return e('div',{className:'page'},
    // toolbar
    e('div',{className:'toolbar'},
      e('input',{placeholder:'Cerca...', value:q, onChange:ev=>setQ(ev.target.value)}),
      e('button',{className:'btn', onClick:openNew, ...roBtnProps()}, '➕ Nuovo fornitore')
    ),

        // TABELLONE: elenco fornitori (stile Clienti)
    e('div', {className:'card', style:{marginTop:8, overflowX:'auto'}},
      e('table', {className:'table'},
        e('thead', null,
          e('tr', null,
            e('th', {style:{width:36, textAlign:'center'}},
              e('input', {
                type:'checkbox',
                ref: el => {
                  if (el) {
                    el.indeterminate =
                      (filtered.some(f=>sel[String(f.id)]) && !filtered.every(f=>sel[String(f.id)]));
                  }
                },
                checked: (filtered.length>0 && filtered.every(f=>sel[String(f.id)])),
                onChange: () => toggleAll(filtered)
              })
            ),
            e('th', null, 'Ragione sociale'),
            e('th', null, 'P.IVA'),
            e('th', null, 'Email'),
            e('th', {style:{width:220}},
              e('div', {className:'row', style:{justifyContent:'space-between', gap:8}},
                e('span', null, 'Azioni'),
                e('button', {
                  className:'btn btn-outline',
                  disabled: Object.keys(sel).filter(k=>sel[k]).length===0,
                  onClick: delSelected,
                  ...roBtnProps()
                }, '🗑 Elimina selezionati')
              )
            )
          )
        ),
        e('tbody', null,
          filtered.map(r => e('tr', {key:r.id || r.ragione},
            e('td', {style:{textAlign:'center'}},
              e('input', {
                type:'checkbox',
                checked: !!sel[String(r.id)],
                onChange: ()=> toggleRow(String(r.id))
              })
            ),
            e('td', null,
              r.ragione||'',
              (!((r.piva||'').trim() || (r.cf||'').trim())
                ? e('span',{className:'badge badge-warn',style:{marginLeft:6}},'⚠︎ dati fiscali')
                : null)
            ),
            e('td', null, r.piva||''),
            e('td', null, r.email||'-'),
            e('td', null,
              e('button', {className:'btn btn-outline', onClick:()=>openEdit(r.id)}, 'Apri'),
              ' ',
              e('button', {className:'btn btn-outline', onClick:()=>del(r.id)}, '🗑')
            )
          ))
        )
      )
    ),

    // FORM: con i <div> wrapper per non sfasare la griglia
    showForm && e('form', {
      className:'card',
      onSubmit:save,
      style:{ marginTop:8, padding:12 }
    },
      e('h3', null, editingId ? `Modifica ${form.ragione||''}` : 'Nuovo fornitore'),

      e('div', {className:'form'},

        // --- Dati anagrafici ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1'}}, 'Dati anagrafici'),

        e('div',{className:'form-row'},
          e('label', null, 'Ragione sociale'),
          e('input', {
            name:'ragione',
            value:form.ragione||'',
            onChange:onChange,
            placeholder:'es. Carpenteria Rossi Srl'
          })
        ),
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Sede legale'),
          e('input', {
            name:'sedeLegale',
            value:form.sedeLegale||'',
            onChange:onChange,
            placeholder:'via, CAP, città, provincia'
          })
        ),
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Sede operativa'),
          e('input', {
            name:'sedeOperativa',
            value:form.sedeOperativa||'',
            onChange:onChange,
            placeholder:'se diversa dalla sede legale'
          })
        ),

        // --- Contatti ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Contatti'),

        e('div',{className:'form-row'},
          e('label', null, 'Email'),
          e('input', {
            name:'email',
            type:'email',
            value:form.email||'',
            onChange:onChange,
            placeholder:'es. ufficio@fornitore.it'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'PEC'),
          e('input', {
            name:'pec',
            value:form.pec||'',
            onChange:onChange,
            placeholder:'es. fornitore@pec.it'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Telefono'),
          e('input', {
            name:'telefono',
            value:form.telefono||'',
            onChange:onChange
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Fax'),
          e('input', {
            name:'fax',
            value:form.fax||'',
            onChange:onChange
          })
        ),

        // --- Dati fiscali ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Dati fiscali'),

        e('div',{className:'form-row'},
          e('label', null, 'Partita IVA'),
          e('input', {
            name:'piva',
            value:form.piva||'',
            onChange:onChange,
            placeholder:'es. 01234567890'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Codice Fiscale'),
          e('input', {
            name:'cf',
            value:form.cf||'',
            onChange:onChange
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Codice Univoco SDI'),
          e('input', {
            name:'codiceUnivoco',
            value:form.codiceUnivoco||'',
            onChange:onChange
          })
        ),

        // --- Dati bancari ---
        e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Dati bancari'),

        e('div',{className:'form-row'},
          e('label', null, 'Banca'),
          e('input', {
            name:'banca',
            value:form.banca||'',
            onChange:onChange
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'IBAN'),
          e('input', {
            name:'iban',
            value:form.iban||'',
            onChange:onChange,
            placeholder:'es. IT00A0000000000000000000000'
          })
        ),
        e('div',{className:'form-row'},
          e('label', null, 'Intestatario conto'),
          e('input', {
            name:'intestatario',
            value:form.intestatario||'',
            onChange:onChange
          })
        ),

        // --- Note ---
        e('div',{className:'form-row form-row-full'},
          e('label', null, 'Note interne'),
          e('textarea', {
            name:'note',
            value:form.note||'',
            onChange:onChange,
            rows:2
          })
        )
      ),

      e('div',{className:'actions', style:{justifyContent:'flex-end', gap:8, marginTop:8}},
        e('button',{
          type:'button',
          className:'btn btn-outline',
          onClick:()=>{ setShowForm(false); setEditingId(null); setForm(blank); }
        }, 'Annulla'),
        e('button',{className:'btn', type:'submit', ...roBtnProps()}, 'Salva')
      )
    ),
  );
}

window.FornitoriView = FornitoriView;

// ================== QR + STAMPA COMMESSA (definitivo) ==================

function makeQRDataUrl(text, size = 140){
  return new Promise((resolve, reject) => {
    if (!window.QRCode) return reject(new Error('QRCode library non caricata'));
    const holder = document.createElement('div');
    holder.style.position = 'fixed';
    holder.style.left = '-99999px';
    holder.style.top = '0';
    document.body.appendChild(holder);
    try {
      new QRCode(holder, { text, width:size, height:size, correctLevel: QRCode.CorrectLevel.M });
      setTimeout(() => {
        try{
          const img = holder.querySelector('img');
          const canvas = holder.querySelector('canvas');
          let dataUrl = '';
          if (img && img.src) dataUrl = img.src;
          else if (canvas) dataUrl = canvas.toDataURL('image/png');
          if (!dataUrl) throw new Error('QR non generato');
          resolve(dataUrl);
        }catch(e){ reject(e); }
        finally { document.body.removeChild(holder); }
      }, 0);
    } catch (e) {
      document.body.removeChild(holder);
      reject(e);
    }
  });
}
// --- stampa HTML in nuova finestra in modo robusto ---
// Stampa HTML in un iFrame nascosto (niente popup blocker)
function safePrintHTMLString(html){
  try{
    const iframe = document.createElement('iframe');
    iframe.style.position='fixed';
    iframe.style.right='0'; iframe.style.bottom='0';
    iframe.style.width='0'; iframe.style.height='0';
    iframe.style.border='0'; iframe.setAttribute('aria-hidden','true');
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(html); doc.close();

    iframe.onload = () => {
      try{
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      }finally{
        setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 1000);
      }
    };
  }catch(e){
    console.warn('Print iframe fallita, fallback a nuova scheda', e);
    const w = window.open('', '_blank');
    if (w){
      w.document.write(html); w.document.close(); w.focus();
      try{ w.print(); }catch{}
    }
  }
}

  // Helper globale: converte minuti → "H:MM"
  window.fmtHHMMfromMin = window.fmtHHMMfromMin || function fmtHHMMfromMin(mins){
    const t = Math.max(0, Math.round(Number(mins) || 0));
    const h = Math.floor(t / 60);
    const m = t % 60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };

  // === REF CLIENTE → TESTO (globale, idempotente) ===
  window.refClienteToText = window.refClienteToText || function refClienteToText(x) {
    if (!x) return '';
    if (typeof x === 'string') return x.trim();
    if (typeof x === 'object') {
      // campi tipici: { tipo, numero, data }
      const tipo = (x.tipo || '').toString().trim().toUpperCase();
      const num  = (x.numero != null ? String(x.numero) : '').trim();
      const dt   = x.data ? new Date(x.data).toLocaleDateString('it-IT') : '';
      return [tipo, num, dt].filter(Boolean).join(' ').trim();
    }
    return String(x);
  };

function renderCommessaHTML(rec, appCfg = {}, opts = {}){
  
  const { qrDataUrl = '', qrCaption = '' } = opts;

  // --- helper locali ---
  const s = v => String(v ?? '').replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch]));
  const formatIT = d => d ? new Date(d).toLocaleDateString('it-IT') : '';
  const toMin = v => {
    if (typeof v === 'number') return Math.max(0, Math.round(v));
    const m = String(v||'').trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0; const h=+m[1]||0, mm=+m[2]||0; return h*60+mm;
  };
  const fmtHHMM = mins => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m = t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };

  // === Helpers locali per KPI di fase (stessa logica della Timbratura) ===
  function plannedMinsOfPhaseRP(fase, commessa){
    // Usa i campi più frequenti: oreMin/minuti/min/oreHHMM/ore
    const val =
      (fase && (Number(fase.oreMin)||Number(fase.minuti)||Number(fase.min))) ? 
        (Number(fase.oreMin)||Number(fase.minuti)||Number(fase.min)) :
      (typeof fase?.oreHHMM === 'string') ? toMin(fase.oreHHMM) :
      (typeof fase?.ore === 'string') ? toMin(fase.ore) :
      (Number(fase?.ore)||0);

    const perPezzo = !!(fase && (fase.perPezzo || fase.xPezzo || fase.onePerPiece));
    const qta = Math.max(1, Number(commessa?.qtaPezzi || 1));
    return perPezzo ? (val * qta) : val;
  }
  function effMinsOfPhaseRP(oreRows, commessaId, faseIdx){
    const rows = Array.isArray(oreRows) ? oreRows : [];
    return rows.reduce((S,o)=>{
      try{
        if (String(o.commessaId||o.commessa) !== String(commessaId)) return S;
        const fi = (o.faseIdx!=null) ? Number(o.faseIdx) :
                   (o.faseIndex!=null) ? Number(o.faseIndex) : null;
        if (fi !== Number(faseIdx)) return S;
        const add = (o.oreMin!=null) ? Number(o.oreMin) :
                    (o.minuti!=null) ? Number(o.minuti) :
                    (o.minutes!=null) ? Number(o.minutes) :
                    (o.oreHHMM!=null) ? toMin(o.oreHHMM) :
                    (o.ore!=null) ? (typeof o.ore==='string' ? toMin(o.ore) : Number(o.ore)*60) : 0;
        return S + Math.max(0, Number(add)||0);
      }catch{return S;}
    }, 0);
  }

  // --- dati base ---
  const fasi = Array.isArray(rec.fasi) ? rec.fasi : [];
  const perPezzoMin = fasi.reduce((tot,f)=> tot + (Number.isFinite(f.oreMin) ? f.oreMin : toMin(f.oreHHMM)), 0);
  const qta = Math.max(1, Number(rec.qtaPezzi||1));
  const totMin = perPezzoMin * qta;

  const priorita = rec.priorita || '-';
  const logo = appCfg.logoDataUrl || appCfg.logoUrl || appCfg.logo || (appCfg.azienda && (appCfg.azienda.logoDataUrl || appCfg.azienda.logoUrl)) || '';

  // Rif. ordine cliente (accetta stringa o oggetto)
  const rifRaw = rec.ordineCliente || rec.nrOrdineCliente || rec.ddtCliente || rec.ordine || rec.ordineId || rec.rifCliente || '';
  const rifCliente = window.refClienteToText
    ? window.refClienteToText(rifRaw)
    : (typeof rifRaw === 'object'
        ? [ (rifRaw.tipo||'').toString().trim().toUpperCase(),
            (rifRaw.numero!=null?String(rifRaw.numero):'').trim(),
            (rifRaw.data?new Date(rifRaw.data).toLocaleDateString('it-IT'):'') ].filter(Boolean).join(' ').trim()
       : String(rifRaw||''));

  // --- stile di stampa (autonomo) ---
  const stile = `
  <style>
    @page { size: A4; margin: 12mm; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-size:12px;color:#111}
    h1{font-size:22px;margin:0}
    h2{font-size:14px;margin:0 0 6px}
    .muted{color:#666}
    .right{text-align:right}
    .row{display:flex;gap:12px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:4px}
    .header{display:grid; grid-template-columns: 180px 1fr 160px; gap:12px; align-items:center; border-bottom:2px solid #222; padding-bottom:10px; margin-bottom:12px}
    .logo{width:160px; height:80px; object-fit:contain; border:1px solid #eee; background:#fff}
    .bigline{font-size:18px; font-weight:800; line-height:1.2}
    .kp{display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px; margin-top:6px}
    .box{border:1px dashed #bbb; border-radius:8px; padding:8px}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{border:1px solid #ddd; padding:6px; vertical-align:top}
    th{background:#fafafa; text-align:left}
    .qrwrap{display:flex; flex-direction:column; align-items:center; gap:6px}
    .qr{width:140px; height:140px; object-fit:contain}
  </style>`;

  // --- intestazione ---
  const headerHTML = `
    <div class="header">
      <div class="col">
        ${logo ? `<img class="logo" src="${logo}" alt="Logo">` : `<div class="muted">[Logo non impostato]</div>`}
      </div>
      <div class="col">
        <div class="bigline">${s(rec.cliente || '-')}</div>
        <div class="bigline">${s(rec.descrizione || '-')}</div>
        <div>Priorità: <strong>${s(priorita)}</strong></div>
        <div>Consegna prevista: <strong>${formatIT(rec.scadenza) || '-'}</strong></div>
        <div>Rif. ordine cliente: <strong>${
        (function() {
          const ref = rec.ordineCliente || rec.nrOrdineCliente || rec.ddtCliente || rec.ordine || rec.ordineId || rec.rifCliente || '';
          return s(window.refClienteToText(ref) || '-');})()}</strong></div>
        </div>
      <div class="qrwrap">
        <div style="font-weight:700">Commessa: ${s(rec.id || '-')}</div>
        ${qrDataUrl ? `<img class="qr" src="${qrDataUrl}" alt="QR">` : `<div class="muted" style="text-align:center">QR non disponibile</div>`}
        ${qrCaption ? `<div class="muted" style="font-size:10px;word-break:break-all;text-align:center">${s(qrCaption)}</div>` : ''}
      </div>
    </div>`;

  // --- riepilogo chiavi (etichette corrette: PREVISTE) ---
  const riepilogoHTML = `
    <div class="kp">
      <div class="box"><div class="muted">Pezzi totali</div><div style="font-size:16px;font-weight:800">${qta}</div></div>
      <div class="box"><div class="muted">Ore per pezzo (previste)</div><div style="font-size:16px;font-weight:800">${fmtHHMM(perPezzoMin)}</div></div>
      <div class="box"><div class="muted">Ore totali (previste)</div><div style="font-size:16px;font-weight:800">${fmtHHMM(totMin)}</div></div>
    </div>`;

  // --- tabella fasi: # / Lavorazione / HH:MM per fase / Q.tà ---
  const rowsHTML = (fasi.length ? fasi : []).map((f, idx) => {
    const hhmm = f.oreHHMM ? String(f.oreHHMM) : fmtHHMM(Number.isFinite(f.oreMin) ? f.oreMin : 0);
    return `<tr>
      <td style="width:40px">faseLabel(commessa, idx)</td>
      <td>${s(f.lav || '-')}</td>
      <td style="width:120px">${s(hhmm)}</td>
      <td style="width:80px">${qta}</td>
    </tr>`;
  }).join('');

  const tableHTML = `
    <h2>Fasi di lavorazione</h2>
    <table>
      <thead>
        <tr><th>#</th><th>Lavorazione</th><th>HH:MM per fase</th><th>Q.tà</th></tr>
      </thead>
      <tbody>${rowsHTML || `<tr><td colspan="4" class="muted">Nessuna fase definita</td></tr>`}</tbody>
    </table>`;
    // --- materiali previsti ---
// Legge "materialiPrevisti" (primario) o "materiali" (fallback)
const mats = Array.isArray(rec.materialiPrevisti) ? rec.materialiPrevisti
            : (Array.isArray(rec.materiali) ? rec.materiali : []);

const matRowsHTML = (mats.length ? mats : []).map(m => {
  const qtyPerPezzo = Number(m.qta ?? m.qty ?? m.pezzi ?? 0);
  return `<tr>
    <td>${s(m.codice || '')}</td>
    <td>${s(m.descrizione || '')}</td>
    <td style="width:60px">${s(m.um || '')}</td>
    <td style="width:80px">${(Number.isFinite(qtyPerPezzo) ? qtyPerPezzo : '')}</td>
    <td>${s(m.note || '')}</td>
  </tr>`;
}).join('');

const matTableHTML = `
  <h2 style="margin-top:12px">Materiali previsti</h2>
  <table>
    <thead><tr>
      <th>Codice</th><th>Descrizione</th><th>UM</th><th>Q.tà</th><th>Note</th>
    </tr></thead>
    <tbody>${matRowsHTML || `<tr><td colspan="5" class="muted">Nessun materiale</td></tr>`}</tbody>
  </table>`;


  // --- istruzioni (se presenti) ---
  const istrLines = String(rec.istruzioni || rec.note || '')
  .split(/\r?\n/)
  .map(x => x.trim())
  .filter(Boolean);
const noteHTML = istrLines.length ? `
  <div class="box" style="margin-top:10px">
    <div class="muted">Istruzioni</div>
    <ul style="margin:6px 0 0 18px; padding:0">
      ${istrLines.map(li => `<li>${s(li)}</li>`).join('')}
    </ul>
  </div>` : '';
  return `<!doctype html><html><head><meta charset="utf-8">${stile}</head><body>
  ${headerHTML}
  ${riepilogoHTML}
  ${tableHTML}
  ${matTableHTML}
  ${noteHTML}
  </body></html>`;

}

// === STAMPA COMMESSA con QR in Data URL (stabile in stampa) ===
async function printCommessa(c){
  // Impostazioni intestazione per stampe (logo, ragione sociale, ecc.)
  const appCfg = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{};} })();

  // URL che il QR dovrà aprire sul telefono
  const qrUrl = makeTimbraturaURL(c.id);

  // Genero un QR come Data URL (prima la libreria in-page, poi eventuale fallback esterno)
  let qrDataUrl = null;
  try {
    qrDataUrl = await getQRDataURL(qrUrl, 180);
  } catch(_) {}
  if (!qrDataUrl) {
    const fallback = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrUrl)}`;
    try{
      const resp = await fetch(fallback, { cache: 'no-store' });
      const blob = await resp.blob();
      qrDataUrl = await new Promise(res => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(blob); });
    }catch{}
    if (!qrDataUrl) qrDataUrl = fallback; // estrema ratio
  }

  // HTML della scheda: usa i tempi/fasi reali (lav + oreHHMM) e le etichette “previste”
  const html = renderCommessaHTML(c, appCfg, { qrDataUrl, qrCaption: qrUrl });

  // Stampa tramite iFrame nascosto (niente popup blocker)
  safePrintHTMLString(html);
}
/* ================== ETICHETTE COLLI (stampa A4 semplice con QR) ================== */
function stampaEtichetteColli({ commessa, nColli=1 }) {
  const makeLabel = (i) => `
    <div style="border:1px solid #000; padding:10px; margin:8px; width:48%; display:inline-block; box-sizing:border-box;">
      <div style="font-size:18px; font-weight:bold;">ETICHETTA COLLO ${i}/${nColli}</div>
      <div><b>Commessa:</b> ${commessa?.id || commessa?.code || '-'}</div>
      <div><b>Cliente:</b> ${commessa?.cliente || '-'}</div>
      <div><b>Descr.:</b> ${commessa?.titolo || commessa?.descrizione || '-'}</div>
      <div id="qr_${i}" style="margin-top:8px;"></div>
    </div>
  `;
  const html = `
    <html><head><meta charset="utf-8">
      <style>@media print { @page { size:A4; margin:12mm; } body { font-family:Arial; } }</style>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    </head>
    <body>
      <h1>Etichette colli — ${commessa?.id || '-'}</h1>
      ${Array.from({length:nColli}, (_,i)=>makeLabel(i+1)).join('')}
      <script>
        (function(){
          const id = ${JSON.stringify(commessa?.id || '')};
          for (let i=1;i<=${nColli};i++){
            const el = document.getElementById('qr_'+i);
            if (!el) continue;
            const c = document.createElement('canvas'); el.appendChild(c);
            try {
              new QRious({ element:c, value: 'commessa:'+id+':collo:'+i, size: 140 });
            } catch(e) { el.innerHTML = '<div style="color:#900">QR non disponibile</div>'; }
          }
          setTimeout(()=>window.print(),200);
        })();
      </script>
    </body></html>`;
  const f = document.createElement('iframe');
  Object.assign(f.style, { position:'fixed', right:0, bottom:0, width:0, height:0, border:0 });
  document.body.appendChild(f);
  const w = f.contentWindow; w.document.open(); w.document.write(html); w.document.close();
  w.focus();
  setTimeout(()=>document.body.removeChild(f), 2000);
}

function chiediEtichetteECStampa(commessa) {
  const n = Number(prompt('Commessa completata. Quanti colli stampare?', '1')||'0');
  if (n>0) {
    try { localStorage.setItem('__NCOLLI__:'+String(commessa?.id||''), String(n)); } catch {}
    stampaEtichetteColli({ commessa, nColli:n });
  }
}

/* ================== HOOK COMPLETAMENTO COMMESSA → ETICHETTE (v2 produzione-first) ================== */
(function(){
  if (window.__ANIMA_LABELS_HOOK_V2__) return; // idempotente
  window.__ANIMA_LABELS_HOOK_V2__ = true;

  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const origLsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  function isClosed(row){
    // fallback legacy per chiusura manuale
    return (
      row?.stato === 'Consegnata' ||
      row?.stato === 'Chiusa' ||
      row?.consegnata === true ||
      row?.chiusa === true ||
      Number(row?.progress || row?.avanzamento || 0) >= 100
    );
  }

  function isComplete(row){
    try{
      if (typeof window.isCommessaCompleta === 'function') return !!window.isCommessaCompleta(row);
    }catch{}
    return isClosed(row);
  }

  window.lsSet = function(k, v){
    let prev = null;
    if (k === 'commesseRows') { prev = lsGet('commesseRows', []); }

    // normalizza rowId (se helper disponibile)
        let vNorm = v;
    if (k === 'commesseRows' && Array.isArray(v)) {
      try{
        const fnIds  = window.ensureCommessaRowIds;
        const fnFasi = window.ensureCommessaRowFasi;
        vNorm = v.map(c => {
          let out = (typeof fnIds==='function')  ? fnIds(c)  : c;
          out     = (typeof fnFasi==='function') ? fnFasi(out) : out;
          return out;
        });
      }catch{}
    }

    const ret = origLsSet(k, vNorm);

    if (k === 'commesseRows') {
      try {
        const next = Array.isArray(vNorm) ? vNorm : (lsGet('commesseRows', []) || []);
        const byIdPrev = new Map((prev||[]).map(x => [x.id, x]));
        for (const n of (next||[])) {
          const p = byIdPrev.get(n.id);
          const wasComplete = p ? isComplete(p) : false;
          const nowComplete = isComplete(n);
          if (!wasComplete && nowComplete) {
            if (typeof window._maybeAutoScaricoAndLabels === 'function') {
              try { window._maybeAutoScaricoAndLabels(n.id); } catch {}
            } else if (typeof chiediEtichetteECStampa === 'function') {
              try { chiediEtichetteECStampa(n); } catch {}
            }
          }
        }
      } catch {}
    }
    return ret;
  };
})();


/* ================== COMMESSE (multi-selezione → DDT, import PDF ordine, multi-articolo) ================== */
  // === Helpers elenco Commesse (idempotenti) ===
window.orderRefFor = window.orderRefFor || function orderRefFor(c){
  try{
    const ref = c?.ordineCliente || c?.nrOrdineCliente || c?.ddtCliente || c?.ordine || c?.ordineId || c?.rifCliente || '';
    return (window.refClienteToText ? window.refClienteToText(ref) : String(ref||'')).trim();
  }catch{ return ''; }
};

window.previewDescrAndRef = window.previewDescrAndRef || function previewDescrAndRef(c){
  const descr = String(c?.descrizione || '').trim();
  const righe = Array.isArray(c?.righeArticolo) ? c.righeArticolo : (Array.isArray(c?.righe) ? c.righe : []);
  const isMulti = Array.isArray(righe) && righe.length > 1;
  const isSingle = Array.isArray(righe) && righe.length === 1;
  const codiceSingolo = (isSingle && righe[0] && (righe[0].codice || righe[0].code)) ? (righe[0].codice || righe[0].code) : (c?.articoloCodice || '');
  const ref = window.orderRefFor(c) || '';

  // output:
  // colonna "Descrizione" = descrizione
  // colonna "Rif. cliente" = (multi) ref  | (singola) codice  | fallback ref | '-'
  const rifCol = isMulti ? (ref || `Multi (${righe.length})`) : (codiceSingolo || ref || '-');
  return { descr, rifCol };
};

function CommesseView({ query = '' }) {
  const e = React.createElement;

  // RBAC sola lettura
  const readOnly = (typeof window.isReadOnlyUser === 'function'
    ? !!window.isReadOnlyUser()
    : !!(window.__USER && window.__USER.role === 'accountant'));

  const roBtnProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));

  // — Renderer sicuro
  const V = (v) => {
    if (v == null) return '';
    if (typeof v === 'object') {
      if ('id' in v || 'numero' in v || 'data' in v) {
        return String(v.id ?? v.numero ?? v.data ?? '');
      }
      if (Array.isArray(v)) return v.map(V).join(', ');
      try { return JSON.stringify(v); } catch { return '[obj]'; }
    }
    return String(v);
  };

  // --- utili LS sicuri ---
  const lsGet = window.lsGet || ((k, d) => { try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; } catch { return d; } });
  const lsSet = window.lsSet || ((k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; } catch {} });

  // --- chiudi i menu "…" cliccando fuori ---
  const [menuRow, setMenuRow] = React.useState(null);
  
  // Stato form allegato
  const [allegatoCommessaForm, setAllegatoCommessaForm] = React.useState({
    tipo: 'ALTRO',
    descrizione: '',
    path: '',
    url: ''
  });

  React.useEffect(() => {
    const onDocClick = (ev) => { if (!ev.target.closest('.dropdown')) setMenuRow(null); };
    document.addEventListener('click', onDocClick);
    return () => document.removeEventListener('click', onDocClick);
  }, []);

  // --- tempo & formati ---
  const formatNNN = window.formatNNN || (n => String(n).padStart(3,'0'));
  const toMin = (s) => {
    if(!s) return 0;
    const m = String(s).trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0;
    return (parseInt(m[1]||'0',10)||0)*60 + (parseInt(m[2]||'0',10)||0);
  };
  const fmtHHMM = (mins) => { const t=Math.max(0,Math.round(+mins||0)), h=Math.floor(t/60), m=t%60; return `${h}:${String(m).padStart(2,'0')}`; };
  const todayISO = () => new Date().toISOString().slice(0,10);

  // --- producedPieces ---
  const producedPieces = (c) => {
    if (!c) return 0;
    try {
      const totComm = Math.max(1, Number(c.qtaPezzi || c.qta || 0));
      const oreRowsAll = lsGet('oreRows', []);
      const oreRows = Array.isArray(oreRowsAll) ? oreRowsAll.filter(o => !o || !o.deletedAt) : [];
      let v = 0;
      if (typeof window !== 'undefined' && typeof window.producedPiecesCore === 'function') {
        v = Number(window.producedPiecesCore(c, oreRows) || 0);
      } else if (typeof window !== 'undefined' && typeof window.producedPieces === 'function') {
        v = Number(window.producedPieces(c) || 0);
      } else {
        v = Number(c.qtaProdotta || 0);
      }
      if (!Number.isFinite(v) || v < 0) v = 0;
      return Math.max(0, Math.min(totComm, v));
    } catch {
      return 0;
    }
  };

  const shippedPieces = window.shippedPieces || function(c){ return 0; };

  // Stato DDT
  function computeDDTStatus(c){
    const tot  = Math.max(0, Number(c.qtaPezzi || c.qta || 0));
    const sped = Math.max(0, Number(shippedPieces(c) || 0));
    let label = '—';
    let color = '#666';

    if (tot <= 0){
      if (sped > 0){ label = '⚠️ DDT senza q.tà'; color = '#c0392b'; } 
      else { label = '—'; }
    } else if (sped <= 0){
      label = 'Nessun DDT'; color = '#666';
    } else if (sped < tot){
      label = 'DDT parziale'; color = '#e67e22';
    } else if (sped === tot){
      label = 'DDT completo'; color = '#27ae60';
    } else {
      label = '⚠️ DDT > q.tà'; color = '#c0392b';
    }
    const completedAt = c.__completedAt || c.completedAt || c.dataCompletata || null;
    if (completedAt && sped < tot){ label += ' (commessa completata)'; }
    return { tot, sped, label, color };
  }

  const __todayComm = new Date();
  __todayComm.setHours(0,0,0,0);

  function getScadenzaInfo(c){
    const raw = c.scadenza || c.dataConsegna || c.data_scadenza || '';
    if (!raw) return { text:'', color:'#222' };
    const text = String(raw);
    let color = '#222';
    const d = new Date(raw);
    if (!isNaN(d.getTime())){
      d.setHours(0,0,0,0);
      const diffDays = Math.floor((d - __todayComm) / (1000*60*60*24));
      if (diffDays < 0) color = '#c0392b'; 
      else if (diffDays <= 3) color = '#e67e22';
    }
    return { text, color };
  }

  // --- dati di base ---
  const app       = React.useMemo(() => lsGet('appSettings', {}) || {}, []);
  const clienti   = React.useMemo(() => {
    const arr = lsGet('clientiRows', []) || [];
    return (Array.isArray(arr) ? arr : []).map((x, i) => ({
      id: (x && (x.id!=null ? x.id : (x.codice||x.code||String(i)))),
      ragioneSociale: (x && (x.ragioneSociale||x.denominazione||x.nome||x.descrizione||x.ragione||'')) || ''
    }));
  }, []);
  const articoliA = React.useMemo(() => lsGet('magArticoli', []) , []);
  const FASI_STD  = Array.isArray(app.fasiStandard)
    ? app.fasiStandard.map(f => (typeof f === 'string') ? f.trim() : String(f.label || f.nome || f.lav || '').trim()).filter(Boolean)
    : [];

  // --- ordinamento per ID decrescente ---
  function idKeyC(row){
    const id = String(row?.id||'');
    const m = id.match(/C-(\d{4})-(\d{3})/i);
    if (!m) return 0;
    const y = parseInt(m[1],10)||0, n=parseInt(m[2],10)||0;
    return y*100000 + n;
  }

  // --- stato archivio ---
  const [rows, setRows] = React.useState(() => lsGet('commesseRows', []));
  React.useEffect(() => lsSet('commesseRows', rows), [rows]);

  function writeCommesse(nextArr){
    try {
      if (typeof lsSet === 'function') lsSet('commesseRows', nextArr);
      else localStorage.setItem('commesseRows', JSON.stringify(nextArr));
    } catch {}
    setRows(Array.isArray(nextArr) ? nextArr : []);
  }

  // --- filtro ricerca ---
  const [q, setQ] = React.useState('');
  const [openedFromQuery, setOpenedFromQuery] = React.useState(false);
  
  // ORDINE: Più recenti prima (Decrescente per ID)
  const rowsSorted = (Array.isArray(rows)? rows.slice():[]).sort((a,b)=> idKeyC(b) - idKeyC(a));
  
  const filtered = rowsSorted.filter(c => {
    const s = `${c.id||''} ${c.cliente||''} ${c.descrizione||''} ${c.articoloCodice||''} ${(Array.isArray(c.righe)&&c.righe.map(r=>r.articoloCodice).join(' '))||''}`.toLowerCase();
    return s.includes((q||'').toLowerCase());
  });

  React.useEffect(() => {
    if (!query || openedFromQuery) return;
    const id = String(query).trim();
    if (!id) return;
    const all = Array.isArray(rows) ? rows : [];
    const found = all.find(c => String(c.id) === id);
    if (!found) return;
    try { startEdit(found); } catch (err) {}
    setOpenedFromQuery(true);
  }, [query, rows, openedFromQuery]);

  // --- selezione multipla ---
  const [sel, setSel] = React.useState({}); 
  const selectedList = filtered.filter(c => sel[c.id]);
  const toggleRow  = (id)=> setSel(prev => ({ ...prev, [id]: !prev[id] }));
  const toggleAll  = ()=> {
    const allSelected = filtered.every(c => sel[c.id]);
    if (allSelected) { const next = {...sel}; filtered.forEach(c => { delete next[c.id]; }); setSel(next); } 
    else { const next = {...sel}; filtered.forEach(c => { next[c.id] = true; }); setSel(next); }
  };

  // --- form commessa ---
  const blank = {
    id:'', clienteId:'', cliente:'',
    articoloCodice:'', articoloUM:'',
    descrizione:'',
    qtaPezzi: 1,
    orePerPezzoHHMM: '1:00',
    oreTotaliPrev: 60,
    scadenza:'', priorita:'MEDIA',
    istruzioni:'',
    materiali:[],
    fasi:[],
    righeArticolo: [], 
    qtaProdotta: 0,
    rifCliente: { tipo:'ordine', numero:'', data:'' },
    luogoConsegna: '',
    createdAt: null, updatedAt: null
  };
  const [form, setForm] = React.useState(blank);
  const [editingId, setEditingId] = React.useState(null);
  const [showForm, setShowForm] = React.useState(false);
  const [rowFasiEditIdx, setRowFasiEditIdx] = React.useState(null);

  React.useEffect(()=>{ 
    setForm(p => ({ ...p, oreTotaliPrev: toMin(p.orePerPezzoHHMM) * Math.max(1, Number(p.qtaPezzi||1)) }));
  }, [form.qtaPezzi, form.orePerPezzoHHMM]);

  function onChange(ev){
    const { name, value, type } = ev.target;
    setForm(p => ({ ...p, [name]: type==='number' ? (value===''? '' : +value) : value }));
  }

  // --- fasi ---
  function addFase(){ setForm(p => ({ ...p, fasi:[...(p.fasi||[]), { lav:'', oreHHMM:'0:10', qtaPrevista: Math.max(1, Number(p.qtaPezzi||1)), qtaProdotta:0 }] })); }
  function delFase(idx){ setForm(p => ({ ...p, fasi:(p.fasi||[]).filter((_,i)=>i!==idx) })); }
  function onChangeFase(idx, field, value){
    setForm(p => {
      const arr = Array.isArray(p.fasi) ? p.fasi.slice() : [];
      const r = { ...(arr[idx]||{}) };
      r[field] = (field==='qtaPrevista') ? Math.max(1, Number(value)||1) : value;
      arr[idx] = r; return { ...p, fasi: arr };
    });
  }

  // --- materiali previsti ---
  function addMat(){ setForm(p => ({ ...p, materiali:[...(p.materiali||[]), { codice:'', descrizione:'', um:'', qta:0, note:'' }] })); }
  function delMat(idx){ setForm(p => ({ ...p, materiali:(p.materiali||[]).filter((_,i)=>i!==idx) })); }
  function onChangeMat(idx, field, value){
    setForm(p => {
      const arr = Array.isArray(p.materiali) ? p.materiali.slice() : [];
      const r = { ...(arr[idx]||{}) };
      r[field] = (field==='qta') ? (+value||0) : value;
      if (field==='codice') {
        const a = (articoliA||[]).find(x => String(x.codice||'').trim() === String(value||'').trim());
        if (a) { r.descrizione = r.descrizione || a.descrizione || ''; r.um = r.um || a.um || ''; }
      }
      arr[idx] = r; return { ...p, materiali: arr };
    });
  }

  // ---- righe articolo (multi-articolo) ----
  function addRiga(){
    setForm(p => ({
      ...p,
      righeArticolo: [
        ...(Array.isArray(p.righeArticolo) ? p.righeArticolo : []),
        { codice:'', descrizione:'', um:'PZ', qta:1, note:'' }
      ]
    }));
  }
  function delRiga(idx){
    setForm(p => ({
      ...p,
      righeArticolo: (Array.isArray(p.righeArticolo) ? p.righeArticolo : []).filter((_,i)=>i!==idx)
    }));
  }
  function onChangeRiga(idx, field, value){
    setForm(p => {
      const arr = Array.isArray(p.righeArticolo) ? p.righeArticolo.slice() : [];
      const r   = { ...(arr[idx]||{}) };
      if (field === 'qta') r.qta = (+value || 0);
      else r[field] = value;

      if (field === 'codice') {
        const a = (Array.isArray(articoliA) ? articoliA : []).find(
          x => String(x.codice||'').trim() === String(value||'').trim()
        );
        if (a) {
          if (!r.descrizione) r.descrizione = a.descrizione || '';
          if (!r.um)          r.um          = a.um || 'PZ';
        }
      }
      arr[idx] = r;
      return { ...p, righeArticolo: arr };
    });
  }

  // --- fasi per-riga ---
  function openRowFasi(idx){
    setForm(p => {
      const righe = Array.isArray(p.righeArticolo) ? p.righeArticolo.slice() : [];
      const row   = { ...(righe[idx] || {}) };
      let fasi    = Array.isArray(row.fasi) ? row.fasi.slice() : [];
      const baseQ = Math.max(1, Number(row.qta || p.qtaPezzi || 1));
      if (!fasi.length){
        fasi = [{ lav:'', oreHHMM:'0:10', orePrevHHMM:'0:10', qtaPrevista:baseQ, qtaProdotta:0, unaTantum:false }];
      }
      row.fasi = fasi;
      righe[idx] = row;
      return { ...p, righeArticolo: righe };
    });
    setRowFasiEditIdx(idx);
  }
  function closeRowFasi(){ setRowFasiEditIdx(null); }
  function onChangeRigaFase(rowIdx, faseIdx, field, value){
    setForm(p => {
      const righe = Array.isArray(p.righeArticolo) ? p.righeArticolo.slice() : [];
      const row   = { ...(righe[rowIdx] || {}) };
      const fasi  = Array.isArray(row.fasi) ? row.fasi.slice() : [];
      const f     = { ...(fasi[faseIdx] || {}) };
      if (field === 'qtaPrevista') f.qtaPrevista = Math.max(1, Number(value)||1);
      else if (field === 'unaTantum') { f.unaTantum = !!value; if (f.unaTantum) f.once = true; }
      else if (field === 'orePrevHHMM') { f.orePrevHHMM = value; if (!f.oreHHMM) f.oreHHMM = value; }
      else f[field] = value;
      fasi[faseIdx] = f; row.fasi = fasi; righe[rowIdx] = row;
      return { ...p, righeArticolo: righe };
    });
  }
  function addRigaFase(rowIdx){
    setForm(p => {
      const righe = Array.isArray(p.righeArticolo) ? p.righeArticolo.slice() : [];
      const row   = { ...(righe[rowIdx] || {}) };
      const fasi  = Array.isArray(row.fasi) ? row.fasi.slice() : [];
      const baseQ = Math.max(1, Number(row.qta || p.qtaPezzi || 1));
      fasi.push({ lav:'', oreHHMM:'0:10', orePrevHHMM:'0:10', qtaPrevista:baseQ, qtaProdotta:0, unaTantum:false });
      row.fasi = fasi; righe[rowIdx] = row;
      return { ...p, righeArticolo: righe };
    });
  }
  function delRigaFase(rowIdx, faseIdx){
    setForm(p => {
      const righe = Array.isArray(p.righeArticolo) ? p.righeArticolo.slice() : [];
      const row   = { ...(righe[rowIdx] || {}) };
      const fasi  = Array.isArray(row.fasi) ? row.fasi.slice() : [];
      row.fasi = fasi.filter((_,i)=> i!==faseIdx);
      righe[rowIdx] = row;
      return { ...p, righeArticolo: righe };
    });
  }

  // --- azioni form ---
  function startNew(){
    setEditingId(null);
    setForm({ ...blank, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() });
    setShowForm(true);
    setTimeout(()=>{ const el=document.getElementById('commessa-form'); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); },0);
  }
  
  function startEdit(c){
    if (!c) return;
    setEditingId(c.id);
    const nowIso = new Date().toISOString();
    
    // Normalizza rifCliente
    const rifNorm = (function(){
      const src = c.rifCliente;
      if (src && typeof src === 'object') return src;
      return { tipo:'ordine', numero:(c.nrOrdineCliente||c.ordineCliente||''), data:'' };
    })();

    setForm({
      ...blank,
      ...c,
      rifCliente : rifNorm,
      updatedAt  : nowIso
    });
    setShowForm(true);
    setTimeout(()=>{ const el = document.getElementById('commessa-form'); if (el) el.scrollIntoView({behavior:'smooth', block:'start'}); }, 0);
  }

  function cancelForm(){ setShowForm(false); setEditingId(null); setForm(blank); }

  function segnaCompleta(c){
    const tot = Math.max(1, Number(c.qtaPezzi||1));
    const upd = { ...c, fasi:(Array.isArray(c.fasi)?c.fasi:[]).map(f=>({...f, qtaProdotta:tot})), qtaProdotta:tot, updatedAt:new Date().toISOString(), __completedAt:new Date().toISOString() };
    setRows(prev => { const ix=prev.findIndex(x=>x.id===c.id); const next=[...prev]; if(ix>=0) next[ix]=upd; return next; });
    try{ lsSet('commesseRows', (function(p){ const ix=p.findIndex(x=>x.id===upd.id); if(ix>=0)p[ix]=upd; return p; })(lsGet('commesseRows', []))); }catch{}
    try{ if (window.sbUpsertCommesse) window.sbUpsertCommesse([upd]); }catch(e){}
    try{ window._maybeAutoScaricoAndLabels && window._maybeAutoScaricoAndLabels(c.id); }catch{}
    alert('Commessa segnata come COMPLETA ✅');
  }

  // --- LOGICHE PULSANTI (DUPLICA, ELIMINA, DDT) ---
  function duplicaCommessa(src){
    if (!src || !src.id) return;
    try{
      const all = lsGet('commesseRows', []);
      const nid = (typeof window.nextCommessaId === 'function') ? window.nextCommessaId() : (function(){ const y=new Date().getFullYear(); return `C-${y}-001`; })();
      const copy = JSON.parse(JSON.stringify(src));
      const newId = (typeof window.ensureUniqueCommessaId === 'function') ? window.ensureUniqueCommessaId(nid) : nid;
      copy.id = newId;
      copy.qtaProdotta = 0;
      delete copy.__completedAt;
      if (Array.isArray(copy.fasi)) copy.fasi = copy.fasi.map(f => ({ ...f, qtaProdotta: 0 }));
      if (Array.isArray(copy.righeArticolo)) copy.righeArticolo = copy.righeArticolo.map(r => ({ ...r, qtaProdotta: 0, fasi: Array.isArray(r.fasi) ? r.fasi.map(f => ({ ...f, qtaProdotta: 0 })) : r.fasi }));
      delete copy.scaricoDone; delete copy.labelsPrinted; delete copy.__scaricoDoneAt; delete copy.__labelsPrintedAt;
      copy.createdAt = new Date().toISOString(); copy.updatedAt = new Date().toISOString();
      all.push(copy);
      writeCommesse(all);
      try{ if (window.sbUpsertCommesse) window.sbUpsertCommesse([copy]).catch(()=>{}); }catch(e){}
      alert(`Commessa duplicata come ${nid} ✅`);
    }catch(e){ alert('Errore durante la duplicazione.'); }
  }

  function delCommessa(c){
    if (!c || !c.id) return;
    const id = String(c.id);
    if (!confirm(`Eliminare la commessa "${id}"?`)) return;
    try{
      const all = lsGet('commesseRows', []);
      const next = (Array.isArray(all) ? all : []).filter(x => String(x.id) !== id);
      writeCommesse(next);
      try{ if(window.getSB){ const sb=window.getSB(); if(sb.url && sb.key) fetch(`${String(sb.url).replace(/\/+$/,'')}/rest/v1/commesse?id=eq.${encodeURIComponent(id)}`, {method:'DELETE', headers:{apikey:sb.key, Authorization:'Bearer '+sb.key}}).catch(()=>{}); } }catch(e){}
      alert('Commessa ' + id + ' eliminata ✅');
    }catch(e){ alert('Errore durante eliminazione commessa.'); }
  }

  function creaDDTdaCommessa(commessa){
    try{
      const articoli = lsGet('magArticoli', []) || [];
      const clienti  = lsGet('clientiRows', []) || [];
      const cli = clienti.find(x => String(x.id) === String(commessa.clienteId)) || null;
      const todayISO = ()=> new Date().toISOString().slice(0,10);
      const righeSrc = (Array.isArray(commessa.righeArticolo) && commessa.righeArticolo.length) ? commessa.righeArticolo : [{ rowId: commessa.rowId || null, codice: commessa.articoloCodice || '', descrizione: commessa.descrizione || '', um: commessa.articoloUM || 'PZ', qta: Math.max(1, Number(commessa.qtaPezzi || commessa.qta || 1)), note: commessa.noteSpedizione || commessa.note || '' }];
      const ddtRows = lsGet('ddtRows', []) || [];
      const jobId = String(commessa && commessa.id || '');
      function shippedForRow(row){
        const rowId = String(row && (row.rowId || row.rowID || row.commessaRowId || '')).trim();
        const hasRowId = !!rowId; if (!jobId) return 0;
        let sum = 0;
        ddtRows.forEach(ddt => {
          if (!ddt || ddt.deletedAt || ddt.annullato === true) return;
          const ddtJobId = String(ddt.commessaId || ddt.commessaRif || '');
          if (ddtJobId !== jobId) return;
          (Array.isArray(ddt.righe)?ddt.righe:[]).forEach(dr => {
             const drRowId = String(dr.commessaRowId||'').trim();
             if (hasRowId && drRowId !== rowId) return;
             sum += Number(dr.qta || 0);
          });
        });
        return Math.max(0, sum);
      }
      const righeDDT = righeSrc.map(r => {
        const cod = String(r.codice || r.articoloCodice || '').trim();
        const a = articoli.find(x => String(x.codice || x.id || '').trim() === cod) || null;
        const um = String(r.um || a?.um || 'PZ').toUpperCase();
        const shipped = shippedForRow(r);
        const resid = Math.max(0, Number(r.qta||r.qtaPezzi||0) - shipped);
        return { commessaRowId: String(r.rowId || ''), codice: cod, descrizione: r.descrizione || a?.descrizione || '', UM: um, um: um, qta: resid || 0, prezzo: 0, note: r.note || '' };
      });
      const clienteRag = commessa.cliente || (cli && (cli.ragioneSociale || '')) || '';
      const pf = { id: '', data: todayISO(), clienteId: commessa.clienteId || '', clienteRagione: clienteRag, cliente: clienteRag, commessaId: commessa.id || '', commessaRif: commessa.id || '', luogoConsegna: commessa.luogoConsegna || '', rifCliente: commessa.rifCliente?.numero || '', righe: righeDDT };
      localStorage.setItem('prefillDDT', JSON.stringify(pf));
      location.hash = '#/ddt';
    } catch(e){ alert('Impossibile preparare il DDT: ' + e); }
  }

  function save(){
    const all = lsGet('commesseRows', []);
    let id = String(form.id || '').trim();
    const creating = !editingId;
    let allExisting = Array.isArray(rows) ? rows : [];
    const existIds = new Set(allExisting.map(x => String(x.id || '')));

    if (!id || creating) {
      const gen = (typeof window.nextCommessaId === 'function') ? window.nextCommessaId() : `C-${new Date().getFullYear()}-001`;
      let trial = gen;
      const pad = (n)=> String(n).padStart(3,'0');
      if (existIds.has(trial)) {
        const m = trial.match(/^C-(\d{4})-(\d{3})$/i);
        const y = m ? +m[1] : new Date().getFullYear();
        let n = m ? +m[2] : 1;
        while (existIds.has(`C-${y}-${pad(n)}`)) n++;
        trial = `C-${y}-${pad(n)}`;
      }
      id = trial;
    }

    const normFasi = (form.fasi||[]).map(f => ({
      lav: f.lav || '',
      oreHHMM: f.oreHHMM || '0:10',
      qtaPrevista: Math.max(1, Number(f.qtaPrevista||form.qtaPezzi||1)),
      qtaProdotta: Math.max(0, Math.min(Number(form.qtaPezzi||1), Number(f.qtaProdotta||0)))
    }));

    const righe = Array.isArray(form.righeArticolo) ? form.righeArticolo : [];
    const qtaFromRighe = righe.reduce((s,r)=> s + (+r.qta||0), 0);
    const articoloCodiceFinal = (righe.length === 1) ? (righe[0].codice || form.articoloCodice || '') : (righe.length > 1 ? '' : (form.articoloCodice || ''));

    const partial = {
      ...form,
      id,
      cliente: form.cliente || (clienti.find(x=>String(x.id)===String(form.clienteId))?.ragioneSociale || ''),
      qtaPezzi: qtaFromRighe || Math.max(1, Number(form.qtaPezzi||1)),
      articoloCodice: articoloCodiceFinal,
      oreTotaliPrev: toMin(form.orePerPezzoHHMM) * (qtaFromRighe || Math.max(1, Number(form.qtaPezzi||1))),
      fasi: normFasi,
      materiali: (form.materiali||[]).map(m => ({ codice: m.codice||'', descrizione: m.descrizione||'', um: m.um||'', qta: +m.qta||0, note: m.note||'' })),
      righeArticolo: righe,
      updatedAt: new Date().toISOString(),
      createdAt: form.createdAt || new Date().toISOString()
    };

    partial.qtaProdotta = producedPieces(partial);

    const ix = all.findIndex(x => x.id === partial.id);
    let nextAll;
    if (ix >= 0) { nextAll = all.slice(); nextAll[ix] = partial; } 
    else { nextAll = [partial, ...all]; }
    
    lsSet('commesseRows', nextAll);
    setRows(nextAll);

    try{ if (window.sbUpsertCommesse) window.sbUpsertCommesse([partial]); }catch(e){}
    try{ window._maybeAutoScaricoAndLabels && window._maybeAutoScaricoAndLabels(partial.id); }catch{}
    
    alert('Commessa salvata ✅');
    setShowForm(false);
  }

  // --- Import Ordine (PDF) ---
  const orderPdfInput = e('input', { id:'order-pdf-input', type:'file', accept:'application/pdf', style:{ display:'none' }, onChange: async ev => {
      try{
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const raw = await window.extractPdfText(f);
        const fileName = f.name || '';
        let parsed = {};
        if (typeof window.importOrderFromPDFText === 'function') { parsed = window.importOrderFromPDFText(raw, fileName) || {}; } 
        else if (typeof window.parseOrderText === 'function') { parsed = window.parseOrderText(raw, fileName) || {}; }
        let righe = Array.isArray(parsed.righe) ? parsed.righe.filter(r => r && (String(r.codice||'').trim().length>0 || String(r.descrizione||'').trim().length>0)) : [];
        if (Array.isArray(righe) && righe.length && window.autoSyncMagazzinoDaRighe) { righe = window.autoSyncMagazzinoDaRighe(righe); }
        if (!righe.length) { righe = []; }
        try{ if (Array.isArray(righe) && righe.length && window.ensureMagazzinoArticoliFromRighe) window.ensureMagazzinoArticoliFromRighe(righe); }catch(e){}
        
        const clienti = (window.lsGet && window.lsGet('clientiRows', [])) || [];
        let clienteRag = String(parsed.cliente || '').trim();
        if (/^ANIMA\b/i.test(clienteRag)) clienteRag = '';
        let clienteId = '';
        if (clienteRag) { const hit = clienti.find(c => String(c.ragioneSociale||c.nome||'').toLowerCase()===clienteRag.toLowerCase()); if(hit){ clienteId=hit.id; clienteRag=hit.ragioneSociale||hit.nome||clienteRag; } }
        
        const idNuovo = (typeof window.nextCommessaId==='function') ? window.nextCommessaId() : `C-${new Date().getFullYear()}-001`;
        const qtaTot = righe.length ? righe.reduce((s,r)=>s+(Number(r.qta||r.quantita||0)||0),0) : (Number(parsed.qtaPezzi||1)||1);
        const scad = (function(){ const s=String(parsed.scadenza||'').trim(); if(!s)return ''; const d=new Date(s); return isNaN(d.getTime())?'':d.toISOString().slice(0,10); })();
        const rifClienteObj = (parsed.rifCliente && typeof parsed.rifCliente==='object') ? { tipo:parsed.rifCliente.tipo||'ordine', numero:parsed.rifCliente.numero||'', data:parsed.rifCliente.data||'' } : null;
        
        const comm = {
          id: idNuovo, clienteId, cliente: clienteRag||(parsed.cliente||''), descrizione: '', articoloCodice: '',
          qtaPezzi: Math.max(1, qtaTot||1), scadenza: scad, rifCliente: rifClienteObj,
          righeArticolo: righe.map(r=>({ codice:r.codice||r.articoloCodice||'', descrizione:(r.descrizione||r.articoloDescr||'').trim(), um:String(r.um||r.UM||'PZ').toUpperCase(), qta:Number(r.qta||r.quantita||0)||0, note:r.note||'' })),
          fasi: Array.isArray(parsed.fasi)?parsed.fasi:[], materiali: Array.isArray(parsed.materiali)?parsed.materiali:[], priorita:'MEDIA', istruzioni:(parsed.istruzioni||'').trim(),
          consegnata:false, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), sorgente: (parsed.sorgente || { kind:'pdf', name:fileName, bytes:raw.length })
        };
        const allCommesse = (window.lsGet && window.lsGet('commesseRows', [])) || [];
        allCommesse.unshift(comm);
        if (typeof writeCommesse==='function') writeCommesse(allCommesse); else if (window.lsSet) window.lsSet('commesseRows', allCommesse);
        window.__anima_dirty = true;
        try{ if(window.sbUpsertCommesse) window.sbUpsertCommesse([comm]).catch(()=>{}); }catch(e){}
        alert(`Commessa creata: ${comm.id}\n${righe.length} righe importate.`);
        ev.target.value=''; location.hash='#/commesse';
       }catch(e){ alert('Errore import PDF'); }
  }});

  // --- UI ---
  return e('div', {className:'grid', style:{gap:16}},

    // elenco + azioni
    e('div', {className:'card'},
      e('div', {className:'actions', style:{justifyContent:'space-between', flexWrap:'wrap'}},
        e('div', {className:'row', style:{gap:8, alignItems:'center'}},
          e('input', {
            placeholder:'Cerca commesse…',
            value:q,
            onChange:ev => setQ(ev.target.value)
          }),
          e('button', { className:'btn', onClick:startNew, ...roBtnProps() }, '➕ Nuova commessa'),
          orderPdfInput,
          e('button', { className:'btn', onClick: ()=> { const el=document.getElementById('order-pdf-input'); if(el)el.click(); }, ...roBtnProps() }, '📄 Importa Ordine (PDF)')
        ),
        e('div', {className:'actions'},
          e('span', null, `Selezionate: ${selectedList.length}`),
          e('button', { className:'btn', onClick:()=>window.creaDDTdaSelezionate && window.creaDDTdaSelezionate(), ...roBtnProps() }, '📦 Crea DDT con selezionate')
        )
      ),

      filtered.length===0
        ? e('div', {className:'muted'}, 'Nessuna commessa')
        : e('table', { className:'table' },
            e('thead', null,
              e('tr', null,
                e('th', {style:{width:36, textAlign:'center'}}, e('input', { type:'checkbox', onChange: ()=> toggleAll(), checked: filtered.length > 0 && filtered.every(r => sel[r.id]) })),
                e('th', null, 'ID'),
                e('th', null, 'Cliente'),
                e('th', null, 'Descrizione'),
                e('th', null, 'Rif. cliente'),
                // Ho stretto Q.tà e Spedita, e allargato Azioni per non far andare a capo i tasti
                e('th', {className:'right', style:{width:'50px'}}, 'Q.tà'), 
                e('th', {className:'right', style:{width:'60px'}}, 'Spedita'),
                e('th', {className:'right', style:{width:'60px'}}, 'Q.tà prod.'),
                e('th', {style:{width:'90px'}}, 'Scadenza'),
                e('th', {style:{minWidth:'340px'}}, 'Azioni')
              )
            ),
            e('tbody', null,
              filtered.slice().sort((a,b) => idKeyC(b) - idKeyC(a)).map(c => e('tr', {key:c.id},
                  e('td', {style:{width:36, textAlign:'center'}}, e('input', { type:'checkbox', checked: !!sel[c.id], onChange: ()=>toggleRow(c.id) })),
                  e('td', null, e('a', { href:'#', onClick:(ev)=>{ ev.preventDefault(); startEdit(c); } }, c.id), (c.sorgente?.kind==='pdf') ? e('span',{style:{marginLeft:4}, title:'Da PDF'}, '📄') : null),
                  e('td', null, e('div', {style:{fontWeight:600}}, c.cliente || ''), c.priorita?e('div',{style:{fontSize:11,color:c.priorita==='ALTA'?'#c0392b':'#666'}},'Priorità: '+c.priorita):null),
                  
                  // Descrizione complessa (PRESERVATA)
                  e('td', null, (() => {
                      const righe = Array.isArray(c.righeArticolo) ? c.righeArticolo : (Array.isArray(c.righe) ? c.righe : []);
                      if (Array.isArray(righe) && righe.length) {
                        const maxLines = 3; const lines = [];
                        for (let i = 0; i < righe.length && lines.length < maxLines; i++) {
                          const riga = righe[i] || {};
                          const parts = [];
                          if (riga.codice || riga.codArticolo || riga.code) parts.push(String(riga.codice || riga.codArticolo || riga.code));
                          const descr = String(riga.descrizione || riga.descr || '').trim().split(/\s+/)[0];
                          if (descr) parts.push(descr);
                          if (parts.length) lines.push(parts.join(' - '));
                        }
                        if (lines.length) return lines.map((l,ix)=>e('div',{key:ix,style:{fontSize:'11px',lineHeight:1.2}},l)).concat(righe.length>lines.length?e('div',{key:'x',style:{fontSize:'10px',color:'#666'}},`(+${righe.length-lines.length} altri)`):[]);
                      }
                      return c.descrizione || '';
                  })()),

                  e('td', null, window.orderRefFor ? window.orderRefFor(c) : (c.rifCliente?.numero || '')),
                  e('td', {className:'right'}, String(Number(c.qtaPezzi||1))),
                  (function(){ const info = computeDDTStatus(c); return e('td', {className:'right'}, e('div', null, `${info.sped} / ${info.tot}`), e('div',{style:{fontSize:11,color:info.color}}, info.label)); })(),
                  e('td', {className:'right'}, String(producedPieces(c) || 0)),
                  (function(){ const sc = getScadenzaInfo(c); return e('td', null, e('span', {style:{color: sc.color}}, sc.text)); })(),
                  e('td', null,
                    e('button', { className:'btn btn-outline', onClick: () => window.stampaCommessaV2 ? window.stampaCommessaV2(c): window.printCommessa && window.printCommessa(c) }, 'Stampa'), ' ',
                    e('button', { className:'btn btn-outline', onClick:()=>window.openEtichetteColliDialog && window.openEtichetteColliDialog(c) }, 'Etichette'), ' ',
                    e('a', { className:'btn btn-outline', href: `#/timbratura?job=${encodeURIComponent(c.id)}` }, 'QR/Timbr.'), ' ',
                    e('button', { className:'btn btn-outline', onClick:()=>duplicaCommessa(c), ...roBtnProps() }, '⧉ Duplica'), ' ',
                    e('button', { className:'btn btn-outline', onClick:()=>creaDDTdaCommessa(c), ...roBtnProps() }, '📦 DDT'), ' ',
                    e('button', { className:'btn btn-outline', onClick:()=>segnaCompleta(c), ...roBtnProps() }, '✅ Completa'), ' ',
                    e('button', { className:'btn btn-outline', onClick:()=>delCommessa(c), ...roBtnProps() }, '🗑️ Elimina')
                  )
              ))
            )
          )
    ),

    // form
    showForm && e('div', {className:'card', id:'commessa-form'},
      e('h3', null, editingId ? `Modifica commessa ${form.id}` : 'Nuova commessa'),
      e('datalist', { id:'fasiStdList' }, FASI_STD.map((s,i)=> e('option', { key:i, value:s })) ),
      e('datalist', { id:'magArtList' }, (Array.isArray(articoliA)?articoliA:[]).map((a,i)=> e('option', { key:i, value:a.codice||'' }, a.descrizione||'')) ),
      e('datalist', { id:'artList' }, (Array.isArray(articoliA)?articoliA:[]).map((a,i)=> e('option', { key:i, value:a.codice||'' }, a.descrizione||'')) ),

      e('div', {className:'form'},
        // Cliente
        e('div', null, e('label', null, 'Cliente'),
          e('select', { name:'clienteId', value:form.clienteId||'', onChange:ev=>{ const v = ev.target.value; const cli = (clienti||[]).find(x=> String(x.id)===String(v)); setForm(p=>({ ...p, clienteId:v, cliente: cli ? (cli.ragioneSociale||cli.nome||'') : '' })); } },
            e('option', {value:''}, '— seleziona —'),
            (clienti||[]).map(c => e('option', {key:c.id, value:c.id}, c.ragioneSociale || c.nome || c.id))
          )
        ),
        // Articolo (codice)
        e('div', null, e('label', null, 'Articolo (codice)'),
          e('input', { name:'articoloCodice', list:'magArtList', value: form.articoloCodice || '', onChange: ev => { const v = ev.target.value; const a = (articoliA||[]).find(x => String(x.codice||'').trim() === String(v||'').trim()); setForm(p => ({ ...p, articoloCodice: v, articoloUM: a ? (a.um || p.articoloUM || '') : p.articoloUM, descrizione: p.descrizione ? p.descrizione : (a ? (a.descrizione||'') : '') })); } })
        ),
        // Descrizione
        e('div', null, e('label', null, 'Descrizione'), e('input', { name:'descrizione', value:form.descrizione||'', onChange:onChange })),
        // Pezzi
        e('div', null, e('label', null, 'Pezzi totali'), e('input', { type:'number', min:'1', step:'1', name:'qtaPezzi', value:form.qtaPezzi, onChange:onChange })),
        // Ore
        e('div', null, e('label', null, 'Ore per pezzo (HH:MM)'), e('input', { name:'orePerPezzoHHMM', value:form.orePerPezzoHHMM, onChange:onChange })),
        e('div', null, e('label', null, 'Ore totali (previste)'), e('input', { value: fmtHHMM(form.oreTotaliPrev), readOnly: true })),
        // Scadenza & Priorità
        e('div', null, e('label', null, 'Scadenza'), e('input', { type:'date', name:'scadenza', value:form.scadenza||'', onChange:onChange })),
        e('div', null, e('label', null, 'Priorità'),
          e('select', { name:'priorita', value:form.priorita||'MEDIA', onChange:onChange }, e('option',{value:'ALTISSIMA'},'ALTISSIMA'), e('option',{value:'ALTA'},'ALTA'), e('option',{value:'MEDIA'},'MEDIA'), e('option',{value:'BASSA'},'BASSA'))
        ),
        // Riferimento
        e('div', {style:{gridColumn:'1 / -1'}},
          e('label', null, 'Riferimento cliente'),
          e('div', { className:'row', style:{gap:8} },
             e('select', { value: (form.rifCliente && form.rifCliente.tipo) || 'ordine', onChange: ev => setForm(p => ({ ...p, rifCliente: { ...(p.rifCliente||{}), tipo: ev.target.value } })) }, e('option', {value:'ordine'}, 'Ordine'), e('option', {value:'ddt'}, 'DDT')),
             e('input', { placeholder:'Numero', value: (form.rifCliente && form.rifCliente.numero) || '', onChange: ev => setForm(p => ({ ...p, rifCliente: { ...(p.rifCliente||{}), numero: ev.target.value } })) }),
             e('input', { type:'date', value: (form.rifCliente && form.rifCliente.data) || '', onChange: ev => setForm(p => ({ ...p, rifCliente: { ...(p.rifCliente||{}), data: ev.target.value } })) })
          )
        ),
        e('div', {style:{gridColumn:'1 / -1'}}, e('label', null, 'Istruzioni'), e('textarea', { name:'istruzioni', rows:4, value:form.istruzioni||'', onChange:onChange })),

        // --- RIGHE ARTICOLO (SPOSTATO SOPRA LE FASI - UNICA TABELLA MULTI) ---
        e('div', {className:'subcard', style:{gridColumn:'1 / -1'}},
          e('h4', null, 'Righe articolo (multi)'),
          e('table', {className:'table'},
            e('thead', null, e('tr', null, e('th', null, 'Codice'), e('th', null, 'Descrizione'), e('th', null, 'UM'), e('th', {className:'right'}, 'Q.tà'), e('th', null, ''), e('th', null, 'Fasi'), e('th', null, ''))),
            e('tbody', null, (form.righeArticolo||[]).map((r,idx)=> e('tr', {key:idx},
               e('td', null, e('input', { value:r.codice||'', list:'artList', onChange:ev=>onChangeRiga(idx,'codice',ev.target.value) })),
               e('td', null, e('input', { value:r.descrizione||'', onChange:ev=>onChangeRiga(idx,'descrizione',ev.target.value) })),
               e('td', null, e('input', { value:r.um||'PZ', onChange:ev=>onChangeRiga(idx,'um',ev.target.value) })),
               e('td', {className:'right'}, e('input', { type:'number', step:'1', min:'0', value:r.qta||0, onChange:ev=>onChangeRiga(idx,'qta',ev.target.value) })),
               e('td', null, e('input', { value:r.note||'', onChange:ev=>onChangeRiga(idx,'note',ev.target.value), placeholder:'Note...' })),
               e('td', null, e('button', { className:'btn btn-outline', onClick:()=>openRowFasi(idx) }, 'Fasi')),
               e('td', null, e('button', { className:'btn btn-outline', onClick:()=>delRiga(idx) }, '🗑'))
            )))
          ),
          e('div', {className:'actions'}, e('button', {className:'btn', onClick:addRiga}, '➕ Aggiungi riga'))
        ),

        // --- EDITOR FASI RIGA (se attivo - SUBITO SOTTO) ---
        rowFasiEditIdx != null && e('div', {className:'subcard', style:{gridColumn:'1 / -1', background:'#f0fdf4'}},
            e('h4', null, 'Fasi per riga selezionata'),
            e('table', {className:'table'},
              e('thead', null, e('tr', null, e('th', null, 'Fase'), e('th', null, 'Min/pezzo'), e('th', null, 'Una tantum'), e('th', null, ''))),
              e('tbody', null, ((form.righeArticolo[rowFasiEditIdx]||{}).fasi||[]).map((f,idxF)=> e('tr', {key:idxF},
                 e('td', null, e('input', { value: f.lav || '', list: 'fasiStdList', onChange: ev => onChangeRigaFase(rowFasiEditIdx, idxF, 'lav', ev.target.value) })),
                 e('td', null, e('input', { value:f.orePrevHHMM || f.oreHHMM || '0:10', onChange:ev=>onChangeRigaFase(rowFasiEditIdx, idxF, 'orePrevHHMM', ev.target.value) })),
                 e('td', {style:{textAlign:'center'}}, e('input', { type:'checkbox', checked: !!(f.unaTantum || f.once), onChange:ev=>onChangeRigaFase(rowFasiEditIdx, idxF, 'unaTantum', ev.target.checked) })),
                 e('td', null, e('button', {className:'btn btn-outline', onClick:()=>delRigaFase(rowFasiEditIdx, idxF)}, '🗑'))
              )))
            ),
            e('div', {className:'actions'},
              e('button', {className:'btn', onClick:()=>addRigaFase(rowFasiEditIdx)}, '➕ Fase'),
              e('button', {className:'btn btn-outline', onClick:closeRowFasi}, 'Chiudi')
            )
        ),

        // --- ALLEGATI (Smart + Ordinamento per data decrescente) ---
        (function(){
          const entityId = form && form.id ? String(form.id) : '';
          const isSaved = entityId && (rows||[]).some(r => String(r.id) === entityId);
          const all = window.lsGet('allegatiRows', []) || [];
          
          const rowsAllegati = isSaved
            ? all.filter(a => a && !a.deletedAt && String(a.entityType || '').toUpperCase() === 'COMMESSA' && String(a.entityId || '') === entityId)
                 .sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''))
            : [];

          const onSmartUpload = async (ev) => {
             const file = ev.target.files?.[0]; if(!file) return;
             if (!window.__Z_HANDLE) {
               alert('Prima clicca "🔗 Connetti cartella ANIMA_DOC (Z:)" e seleziona la cartella. Poi riprova.');
               try{ ev.target.value = ''; }catch{}
               return;
             }
             const commYear = new Date().getFullYear();
             const savedPath = await window.smartSaveFile(file, ['COMMESSE', String(commYear), entityId], file.name);
             if (savedPath) {
                const newId = `ALG-${commYear}-${String(all.length+1).padStart(4,'0')}`;
                const newRow = { id: newId, createdAt: new Date().toISOString(), tipo: allegatoCommessaForm.tipo || 'ALTRO', descrizione: allegatoCommessaForm.descrizione || file.name, path: savedPath, url: '', entityType: 'COMMESSA', entityId, deletedAt: null };              
                if (window.allegatiUpsertOne) window.allegatiUpsertOne(newRow);
                else window.lsSet('allegatiRows', [...all, newRow]);
                setAllegatoCommessaForm({ tipo:'ALTRO', descrizione:'', path:'', url:'' });
                ev.target.value = ''; alert('File caricato.');
             }
          };
          const onDelete = (row) => {
            if(!confirm('Eliminare?')) return;
            if(!row || !row.id) return;

            // Anti-wipe: una sola strada di scrittura
            if (window.allegatiSoftDelete) {
              window.allegatiSoftDelete(row.id);
            } else {
              const nowIso = new Date().toISOString();
              const upd = (Array.isArray(all)?all:[]).map(r =>
                (r && r.id===row.id) ? {...r, deletedAt:(r.deletedAt||nowIso), updatedAt: nowIso} : r
              );
              window.lsSet('allegatiRows', upd);
            }

            setAllegatoCommessaForm({...allegatoCommessaForm}); // refresh
          };

          const onCopyPath = (p) => { try{ navigator.clipboard.writeText(p); }catch{ prompt('Copia:',p); } };
          const onOpenUrl  = (u) => { if(u && /^https?:\/\//i.test(u)) window.open(u,'_blank'); };

          return e('div', {className:'subcard', style:{gridColumn:'1 / -1'}},
            e('h4', null, 'Allegati commessa'),
            e('div', {className:'actions', style:{margin:'6px 0 10px 0', gap:8, alignItems:'center'}},
              e('button', {
                className:'btn btn-outline',
                onClick: async ()=>{
                  await window.ensureZConnection({interactive:true});
                  if (window.__Z_HANDLE) {
                    alert('Cartella collegata: ' + (window.__Z_HANDLE.name || 'OK'));
                  } else {
                    alert('Connessione non riuscita: ' + (window.__Z_LAST_ERR || 'errore'));
                  }
                }
              }, '🔗 Connetti cartella ANIMA_DOC (Z:)')
            ),
            !isSaved ? e('p', {className:'muted'}, 'Salva prima la commessa.') : e('div', null,
               rowsAllegati.length ? e('table', {className:'table table-sm'},
                 e('thead', null, e('tr',null,e('th',null,'Data'),e('th',null,'Tipo'),e('th',null,'Descrizione'),e('th',null,'Azioni'))),
                 e('tbody', null, rowsAllegati.map(r=> e('tr', {key:r.id},
                    e('td', null, new Date(r.createdAt).toLocaleDateString()),
                    e('td', null, r.tipo), e('td', null, r.descrizione),
                    e('td', null, e('div', {className:'row', style:{gap:4}},
                        r.path ? e('button', {type:'button', className:'btn btn-xs', onClick:()=>onCopyPath(r.path)}, 'Path') : null,
                        r.url ? e('button', {type:'button', className:'btn btn-xs', onClick:()=>onOpenUrl(r.url)}, 'Link') : null,
                        !readOnly ? e('button', {type:'button', className:'btn btn-xs btn-outline', onClick:()=>onDelete(r)}, '🗑') : null
                    ))
                 )))
               ) : e('p',{className:'muted'}, 'Nessun allegato.'),
               e('div', {className:'grid grid-2', style:{marginTop:8, padding:10, border:'1px dashed #ccc'}},
                 e('div', null, e('label',null,'Tipo'), e('select',{value:allegatoCommessaForm.tipo, onChange:ev=>setAllegatoCommessaForm({...allegatoCommessaForm, tipo:ev.target.value})}, ['DISEGNO','FOTO','ALTRO'].map(t=>e('option',{key:t,value:t},t)))),
                 e('div', null, e('label',null,'Descrizione'), e('input',{value:allegatoCommessaForm.descrizione, onChange:ev=>setAllegatoCommessaForm({...allegatoCommessaForm, descrizione:ev.target.value})})),
                 e('div', {style:{gridColumn:'1/-1'}}, e('label',{className:'btn btn-primary', style:{display:'block',textAlign:'center',cursor:'pointer'}}, '📂 CARICA FILE SU Z:', e('input',{type:'file', style:{display:'none'}, onChange:onSmartUpload})))
               )
            )
          );
        })(),

        // --- MATERIALI ---
        e('div', {className:'subcard', style:{gridColumn:'1 / -1'}},
          e('h4', null, 'Materiali previsti'),
          e('table', {className:'table'},
            e('thead', null, e('tr', null, e('th', null, 'Codice'), e('th', null, 'Descrizione'), e('th', null, 'UM'), e('th', {className:'right'}, 'Q.tà'), e('th', null, 'Note'), e('th', null, ''))),
            e('tbody', null, (form.materiali||[]).map((m,idx)=> e('tr', {key:idx},
               e('td', null, e('input', { value:m.codice||'', list:'artList', onChange:ev=>onChangeMat(idx,'codice',ev.target.value) })),
               e('td', null, e('input', { value:m.descrizione||'', onChange:ev=>onChangeMat(idx,'descrizione',ev.target.value) })),
               e('td', null, e('input', { value:m.um||'', onChange:ev=>onChangeMat(idx,'um',ev.target.value) })),
               e('td', {className:'right'}, e('input', { type:'number', step:'0.01', value:m.qta||0, onChange:ev=>onChangeMat(idx,'qta',ev.target.value) })),
               e('td', null, e('input', { value:m.note||'', onChange:ev=>onChangeMat(idx,'note',ev.target.value) })),
               e('td', null, e('button', {className:'btn btn-outline', onClick:()=>delMat(idx)}, '🗑'))
            )))
          ),
          e('div', {className:'actions'}, e('button', {className:'btn', onClick:addMat}, '➕ Aggiungi materiale'))
        ),

        // --- FASI (Globali - fallback - spostato in fondo) ---
        e('div', {className:'subcard', style:{gridColumn:'1 / -1'}},
          e('h4', null, 'Fasi di lavorazione (globali/legacy)'),
          e('table', {className:'table'},
            e('thead', null, e('tr', null, e('th', null, '#'), e('th', null, 'Lavorazione'), e('th', null, 'HH:MM'), e('th', null, 'Q.tà'), e('th', null, 'Azioni'))),
            e('tbody', null, (form.fasi||[]).map((f,idx)=> e('tr', {key:idx},
               e('td', null, String(idx+1)),
               e('td', null, e('input', { value:f.lav||'', list:'fasiStdList', onChange:ev=>onChangeFase(idx,'lav',ev.target.value) })),
               e('td', null, e('input', { value:f.oreHHMM||'0:10', onChange:ev=>onChangeFase(idx,'oreHHMM',ev.target.value) })),
               e('td', null, e('input', { type:'number', value:f.qtaPrevista||form.qtaPezzi||1, onChange:ev=>onChangeFase(idx,'qtaPrevista', ev.target.value) })),
               e('td', null, e('button', {className:'btn btn-outline', onClick:()=>delFase(idx)}, '🗑'))
            )))
          ),
          e('div', {className:'actions'}, e('button', {className:'btn', onClick:addFase}, '➕ Aggiungi fase'))
        ),

        // Azioni finali
        e('div', {className:'actions', style:{gridColumn:'1 / -1', justifyContent:'space-between'}},
          e('div', null, e('a', { className:'btn btn-outline', href: `#/timbratura?job=${encodeURIComponent(form.id||editingId||'')}` }, 'Apri QR / Timbratura')),
          e('div', null,
            e('button', {className:'btn btn-outline', onClick:()=> {if (window.stampaCommessaV2) {window.stampaCommessaV2(form);} else if (window.printCommessa) {window.printCommessa(form);}}}, 'Stampa'),' ',
            e('button', {className:'btn btn-outline', onClick:()=>window.openEtichetteColliDialog && window.openEtichetteColliDialog(form)}, 'Stampa etichette'),' ',
            e('button', {className:'btn btn-outline', onClick:cancelForm}, 'Annulla'),
            e('button', { className:'btn', onClick:save, ...roBtnProps() }, editingId ? 'Aggiorna' : 'Crea')
          )
        )
      )
    )
  );
}


// <-- fine CommesseView

/* ================== IMPORT COMMESSA DA PDF — Loader + estrazione testo ================== */
// Lazy loader di pdf.js (CDN fallback) — idempotente
window.loadPdfJs = window.loadPdfJs || function(){
  return new Promise((resolve, reject)=>{
    try {
      if (window.pdfjsLib && pdfjsLib.getDocument) return resolve(window.pdfjsLib);
      const existing = document.querySelector('script[data-anima="pdfjs"]');
      if (existing) { existing.addEventListener('load', ()=>resolve(window.pdfjsLib)); existing.addEventListener('error', ()=>reject(new Error('pdf.js load failed'))); return; }
      const s = document.createElement('script');
      s.async = true;
      s.defer = true;
      s.dataset.anima = 'pdfjs';
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js';
      s.onload = ()=> resolve(window.pdfjsLib);
      s.onerror = ()=> reject(new Error('pdf.js load failed'));
      document.head.appendChild(s);
    } catch(e){ reject(e); }
  });
};

// Estrae testo da tutte le pagine del PDF (grezzo ma robusto)
window.extractTextFromPDF = window.extractTextFromPDF || async function(file){
  const pdfjs = await window.loadPdfJs();
  const ab = (file instanceof ArrayBuffer) ? file : await file.arrayBuffer();
  const doc = await pdfjs.getDocument({ data: new Uint8Array(ab) }).promise;
  let full = '';
  for (let i=1; i<=doc.numPages; i++){
    const page = await doc.getPage(i);
    const content = await page.getTextContent();
    // Preferisci “\n” tra elementi per dare chance ai regex riga-per-riga
    const lines = content.items.map(it => (it && typeof it.str==='string') ? it.str : '').filter(Boolean);
    full += '\n' + lines.join('\n');
  }
  return full.replace(/\u00A0/g,' ').trim();
};

// Piccola util per date IT → ISO (YYYY-MM-DD)
window.parseDateIT = window.parseDateIT || function(s){
  const m = String(s||'').trim().match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if (!m) return '';
  const dd = String(m[1]).padStart(2,'0');
  const mm = String(m[2]).padStart(2,'0');
  const yyyy = String(m[3]).length===2 ? ('20'+m[3]) : m[3];
  return `${yyyy}-${mm}-${dd}`;
};

/* ================== IMPORT COMMESSA DA PDF — Parser + Modale ================== */
// Heuristics generiche + opzionali parser per-cliente da appSettings.pdfParsers
window.parseOrderText = window.parseOrderText || function (rawText, opts={}){
  const text = String(rawText||'');
  const lower = text.toLowerCase();
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

  function pickLine(re){ 
    for (const l of lines){ const m = l.match(re); if (m) return m[1]||m[0]; }
    return '';
  }
  function pickAll(re){
    const out=[]; for (const l of lines){ const m = l.match(re); if (m) out.push(m); }
    return out;
  }

  // campi base
  let cliente = pickLine(/^(?:cliente|ragione\s*sociale)\s*[:\-]\s*(.+)$/i) 
             || pickLine(/^([A-Z0-9].{3,80})\s+(?:ordine|commessa|p\.o\.)/i);
  let descr   = pickLine(/^(?:oggetto|descri[sz]ione|prodotto|articolo)\s*[:\-]\s*(.+)$/i) 
             || pickLine(/^(?:item|descr)\s*[:\-]\s*(.+)$/i);
  let qta     = pickLine(/^(?:q\.?t[àa]|quantita'|quantità|pezzi)\s*[:\-]\s*([0-9]+)\b/i) 
             || (lower.match(/\b(qta|quantita'|quantità|pezzi)\b.{0,15}\b(\d{1,6})\b/i)?.[2] || '');
  let consegna= pickLine(/^(?:consegna|data\s*consegna|scadenza)\s*[:\-]\s*([0-9\.\/\-]{8,10})/i) 
             || (lower.match(/\b(consegna|scadenza)\b.{0,20}\b([0-9\.\/\-]{8,10})/i)?.[2] || '');
  let codice  = pickLine(/^(?:codice|articolo|item)\s*[:\-]\s*([A-Z0-9\-\._\/]{2,40})$/i);

  // materiali grezzi (tabelline: codice + quantità + um se presenti)
  const materiali = [];
  const rows = pickAll(/^(?:cod\.?|codice|articolo)\s*[:\-]?\s*([A-Z0-9\-\._\/]{2,40}).{0,40}?(?:q(?:ta|uanti[tàa])|pezzi|qty)\s*[:\-]?\s*([0-9]+(?:[\.,][0-9]+)?)\s*(\w{0,5})?$/i);
  rows.forEach(m=>{
    materiali.push({
      codice: m[1]||'',
      descrizione: '',   // potrai arricchirlo dalla tua anagrafica
      qta: Number(String(m[2]||'0').replace(',','.'))||0,
      um: (m[3]||'').toUpperCase()
    });
  });

  // fallback
  if (!qta){ const m = lower.match(/\b(\d{1,6})\s*(pz|pezzi)\b/); if (m) qta = m[1]; }

  // normalizza
  cliente   = String(cliente||'').trim();
  descr     = String(descr||'').trim();
  qta       = Math.max(1, parseInt(qta||'1',10));
  consegna  = window.parseDateIT(consegna) || '';
  codice    = String(codice||'').trim();

  return { cliente, descrizione: descr, qtaPezzi: qta, scadenza: consegna, codiceCliente: codice, materiali };
};

// Modale UMD per import PDF → proposta campi → crea/aggiorna commessa
window.openImportPDFDialog = window.openImportPDFDialog || function(){
  const e = React.createElement;
  const host = document.createElement('div');
  host.id = 'anima-importpdf-root';
  document.body.appendChild(host);
  const root = ReactDOM.createRoot(host);

  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; }});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  function nextIdCommessa(){
    if (window.nextIdUnique) return window.nextIdUnique('commesse','C','commesseRows').id;
    // fallback gestionale
    const counters = lsGet('counters', {});
    const y = new Date().getFullYear();
    const k = `C:${y}`;
    const n = Number(counters[k]||0) + 1;
    counters[k] = n;
    lsSet('counters', counters);
    const NNN = String(n).padStart(3,'0');
    return `C-${y}-${NNN}`;
  }

  async function extractPdfText(file){
    if (typeof window.pdfjsLib === 'undefined') {
      alert('pdfjs non disponibile'); throw new Error('pdfjs missing');
    }
    const buf = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
    let text = '';
    for (let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const t = content.items.map(it=>it.str).join(' ');
      text += '\n' + t;
    }
    return text.replace(/\s+/g,' ').trim();
  }

  function parseOrderText(rawText, fileName=''){
    // Parser "base": tu personalizzerai con addOrderParser in seguito
    const out = { cliente:'', descrizione:'', qtaPezzi:1, scadenza:'', codiceCliente:'', materiali:[] };
    // Cliente (grezzo)
    const mCliente = rawText.match(/(?:Cliente|Ragione)\s*:\s*([A-Z0-9 .,_-]+)/i);
    if (mCliente) out.cliente = mCliente[1].trim();

    // Scadenza (YYYY-MM-DD o simili)
    const mData = rawText.match(/(?:Consegna|Scadenza)\s*[:\- ]\s*([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})/i);
    if (mData) out.scadenza = mData[1].replace(/\//g,'-');

    // Descrizione (prima riga “lunga” plausibile)
    const mDesc = rawText.match(/(?:Descrizione|Oggetto)\s*[:\- ]\s*([A-Z0-9 ().,_\-\/]{10,})/i);
    if (mDesc) out.descrizione = mDesc[1].trim();

    // Materiali (bozza: righe con CODICE - DESC - QTA [UM?])
    const righe = [];
    const reRiga = /([A-Z0-9_-]{3,})\s+-\s+([^0-9]{5,}?)\s+([0-9]+(?:[.,][0-9]+)?)\s*([A-Z]{1,3})?/gi;
    let m;
    while ((m = reRiga.exec(rawText))){
      righe.push({
        codice: m[1].trim(),
        descrizione: m[2].trim(),
        qta: Number(String(m[3]).replace(',','.')) || 0,
        um: (m[4]||'PZ').trim()
      });
    }
    out.materiali = righe;
    // Q.tà pezzi totale (fallback: somma)
    if (!out.qtaPezzi && righe.length) out.qtaPezzi = righe.reduce((s,r)=> s + (Number(r.qta)||0), 0);
    return out;
  }

  function Modal(){
    const [busy, setBusy] = React.useState(false);
    const [error, setError] = React.useState('');
    const [rawText, setRawText] = React.useState('');
    const [form, setForm] = React.useState({
      id: nextIdCommessa(),
      cliente: '',
      descrizione: '',
      qtaPezzi: 1,
      scadenza: '',
      materiali: []
    });

    function onChange(field, value){
      setForm(p => ({ ...p, [field]: value }));
    }

    async function onPickFile(ev){
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      setBusy(true); setError('');
      try{
        const txt = await extractPdfText(f);setRawText(txt);
        const parsed = (window.importOrderFromPDFText ? window.importOrderFromPDFText(txt, f.name||'')
               : (window.parseOrderText ? window.parseOrderText(txt, f.name||'') : {})) || {};


        setForm(p => ({
          ...p,
          cliente: parsed.cliente || p.cliente,
          descrizione: parsed.descrizione || p.descrizione,
          qtaPezzi: parsed.qtaPezzi || p.qtaPezzi,
          scadenza: parsed.scadenza || p.scadenza,
          materiali: Array.isArray(parsed.materiali) ? parsed.materiali : (p.materiali||[])
        }));
      }catch(e){
        console.error(e);
        setError(String(e?.message||e));
      }finally{
        setBusy(false);
      }
    }

    function applyCreateOrUpdate(){
      try{
        const commesse = lsGet('commesseRows', []);
        const exists = commesse.find(c => c.id === form.id);
        const payload = {
          id: form.id,
          cliente: form.cliente,
          descrizione: form.descrizione,
          qtaPezzi: Number(form.qtaPezzi)||1,
          scadenza: form.scadenza || '',
          righe: Array.isArray(form.materiali) ? form.materiali.map(r => ({
            codice: r.codice||'',
            descrizione: r.descrizione||'',
            um: r.um||'PZ',
            qta: Number(r.qta||0)
          })) : []
        };
        if (exists){
          const next = commesse.map(c => c.id===form.id ? ({ ...c, ...payload, updatedAt:new Date().toISOString() }) : c);
          lsSet('commesseRows', next);
          alert('Commessa aggiornata: '+form.id);
        } else {
          const next = [{ ...payload, createdAt: new Date().toISOString() }].concat(commesse);
          lsSet('commesseRows', next);
          alert('Commessa creata: '+form.id);
        }
        // Apri Commesse
        location.hash = '#/commesse';
      }catch(e){ alert('Errore salvataggio: '+(e?.message||e)); }
    }

    function close(){
      try{ root.unmount(); }catch{}
      try{ host.remove(); }catch{}
    }

    return e('div', {style:{
      position:'fixed', inset:0, background:'rgba(0,0,0,.35)', zIndex:10000,
      display:'grid', placeItems:'center', padding:12
    }},
      e('div', {className:'card', style:{width:'100%', maxWidth:720, background:'#fff'}},
        e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center'}},
          e('h3', null, 'Importa Commessa da PDF'),
          e('button', {className:'btn btn-outline', onClick:close}, 'Chiudi')
        ),
        e('div', {className:'grid', style:{gap:8, gridTemplateColumns:'1fr'}},
          e('label', null, 'Seleziona PDF',
            e('input', {type:'file', accept:'.pdf,application/pdf', onChange:onPickFile, disabled:busy})
          ),
          error && e('div', {className:'muted', style:{color:'#b91c1c'}}, error),
          rawText && e('details', null,
            e('summary', null, 'Anteprima testo estratto'),
            e('pre', {style:{whiteSpace:'pre-wrap', maxHeight:180, overflow:'auto'}}, rawText)
          ),
          e('div', {className:'grid', style:{gap:8, gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))'}},
            e('label', null, 'ID Commessa',
              e('input', {value:form.id, onChange:ev=>onChange('id', ev.target.value)})
            ),
            e('label', null, 'Cliente',
              e('input', {value:form.cliente, onChange:ev=>onChange('cliente', ev.target.value)})
            ),
            e('label', null, 'Q.tà pezzi',
              e('input', {type:'number', min:1, step:1, value:form.qtaPezzi, onChange:ev=>onChange('qtaPezzi', ev.target.value)})
            ),
            e('label', null, 'Scadenza (YYYY-MM-DD)',
              e('input', {value:form.scadenza, onChange:ev=>onChange('scadenza', ev.target.value), placeholder:'2025-11-30'})
            )
          ),
          e('label', null, 'Descrizione',
            e('input', {value:form.descrizione, onChange:ev=>onChange('descrizione', ev.target.value)})
          ),
          e('div', null, e('b', null, 'Materiali individuati')),
          (Array.isArray(form.materiali) && form.materiali.length)
            ? e('table', {className:'table'},
                e('thead', null, e('tr', null,
                  e('th', null, 'Codice'), e('th', null, 'Descrizione'), e('th', null, 'UM'), e('th', {className:'right'}, 'Q.tà')
                )),
                e('tbody', null,
                  form.materiali.map((m, i)=> e('tr', {key:i},
                    e('td', null, e('input', {value: m.codice||'', onChange:ev=>{
                      const a=[...form.materiali]; a[i]={...a[i], codice:ev.target.value}; onChange('materiali', a);
                    }})),
                    e('td', null, e('input', {value: m.descrizione||'', onChange:ev=>{
                      const a=[...form.materiali]; a[i]={...a[i], descrizione:ev.target.value}; onChange('materiali', a);
                    }})),
                    e('td', null, e('input', {value: m.um||'', onChange:ev=>{
                      const a=[...form.materiali]; a[i]={...a[i], um:ev.target.value}; onChange('materiali', a);
                    }})),
                    e('td', {className:'right'}, e('input', {type:'number', step:'0.01', value: m.qta||0, onChange:ev=>{
                      const a=[...form.materiali]; a[i]={...a[i], qta: Number(ev.target.value)||0 }; onChange('materiali', a);
                    }}))
                  ))
                )
              )
            : e('div', {className:'muted'}, '— nessun materiale trovato nel PDF —')
        ),
        e('div', {className:'actions', style:{justifyContent:'flex-end', marginTop:12}},
          e('button', {className:'btn btn-outline', onClick:close}, 'Annulla'),
          e('button', {className:'btn', onClick:applyCreateOrUpdate, disabled:busy}, 'Applica')
        )
      )
    );
  }

  root.render(e(Modal));
}


/* ================== REPORT PRODUZIONE (con Materiali & DDT) ================== */
function ReportProdView({ query = '' } = {}) {
  const e = React.createElement;

  // --- util lettura LS ---
  const ls = (k, d) => { try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; } catch { return d; } };

  // --- dati base ---
  const commesse  = React.useMemo(() => ls('commesseRows', []), []);
  const oreRows   = React.useMemo(() => ls('oreRows', []), []);
  const movimenti = React.useMemo(() => ls('magMovimenti', []), []);
  const ddtRows   = React.useMemo(() => ls('ddtRows', []), []);
  const articoli  = React.useMemo(() => {
    const a1 = ls('magazzinoArticoli', null);
    if (Array.isArray(a1)) return a1;
    return ls('magArticoli', []);
  }, []);

  // --- selezione commessa (con UI locale) ---
  const [filter, setFilter] = React.useState('');
  const [selId, setSelId]   = React.useState('');
    // 👇 menu “…” (stato + chiusura click fuori)
  const [menuRow, setMenuRow] = React.useState(null);
  React.useEffect(() => {
    const onDocClick = (ev) => {
      if (!ev.target.closest('.dropdown')) setMenuRow(null);
    };
    document.addEventListener('click', onDocClick);
    return () => document.removeEventListener('click', onDocClick);
  }, []);

  React.useEffect(() => {
    if (!selId && query) {
      const q = String(query).toLowerCase();
      const found = (commesse||[]).find(c =>
        String(c.id||'').toLowerCase().includes(q) ||
        String(c.cliente||'').toLowerCase().includes(q) ||
        String(c.descrizione||'').toLowerCase().includes(q)
      );
      if (found) setSelId(found.id);
    }
  }, [query, selId, commesse]);

  const opts = React.useMemo(() => (
    (commesse||[])
      .filter(c => {
        const f = String(filter||'').toLowerCase();
        if (!f) return true;
        return String(c.id||'').toLowerCase().includes(f)
            || String(c.cliente||'').toLowerCase().includes(f)
            || String(c.descrizione||'').toLowerCase().includes(f);
      })
      .sort((a,b)=> String(a.id).localeCompare(String(b.id)))
  ), [commesse, filter]);

  const sel = (commesse||[]).find(c => c.id === selId) || null;

  // --- helpers ---
  const fmtIT = d => d ? new Date(d).toLocaleDateString('it-IT') : '';
  const toMin = (s) => {
    if (s == null) return 0;
    const str = String(s).trim();
    if (!str) return 0;
    const m = str.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0;
    const h = parseInt(m[1],10) || 0;
    const mm = parseInt(m[2]||'0',10) || 0;
    return (h*60 + mm);
  };

      // --- formattatore HH:MM robusto (minuti => "H:MM")
    const fmtHHMM = (mins) => {
      const m = Math.max(0, Math.round(mins||0));
      const h = Math.floor(m / 60);
      const mm = String(m % 60).padStart(2, '0');
      return `${h}:${mm}`;
    };

    // --- minuti previsti per fase (segue la logica KPI: per pezzo vs una tantum)
    function plannedMinsOfPhaseRP(fase, commessa){
      if (!fase || !commessa) return 0;
      const base = Number.isFinite(fase.oreMin) ? Math.max(0, Math.round(fase.oreMin)) : toMin(fase.oreHHMM);
      const qta = Math.max(1, Number(commessa.qtaPezzi || 1));
      // Se la fase è una tantum, non moltiplico per i pezzi
      const isOnce = !!(fase.once || fase.unaTantum);
      return isOnce ? base : (base * qta);
    }

    // --- minuti effettivi registrati per fase (somma oreRows per commessaId+faseIdx)
    function effMinsOfPhaseRP(oreRows, commessaId, faseIdx){
      const rows = Array.isArray(oreRows) ? oreRows : [];
      return rows.reduce((S,o)=>{
        try{
          if (String(o.commessaId||'') !== String(commessaId||'')) return S;
          const fi = (o.faseIdx==='' || o.faseIdx==null) ? null : Number(o.faseIdx);
          if (fi !== Number(faseIdx)) return S;
          const add = (Number(o.oreMin)||0) || toMin(o.oreHHMM||0);
          return S + Math.max(0, add||0);
        }catch{ return S; }
      }, 0);
    }

    // — Renderer sicuro per celle tabellari
    const V = (v) => {
      if (v == null) return '';
      if (typeof v === 'object') {
        if (v.id || v.numero || v.data) return String(v.id || v.numero || v.data);
        try { return JSON.stringify(v); } catch { return '[obj]'; }
      }
      return String(v);
    };

  const producedPieces = (typeof window.producedPieces === 'function')
    ? window.producedPieces
    : (c => Array.isArray(c?.fasi) ? c.fasi.reduce((s,f)=> s + (Number(f.qtaProdotta||0)), 0) : 0);


  // ========== KPI ==========
  const kpi = React.useMemo(() => {
    if (!sel) return { pezzi: 0, oreEff: 0, orePrev: 0 };
    const oreEff = (oreRows||[])
      .filter(o => o.commessaId === sel.id)
      .reduce((s,o)=> s + (Number(o.oreMin)||toMin(o.oreHHMM)||0), 0) / 60; // ore

    let perPiece = 0, oneTime = 0;
    (sel.fasi||[]).forEach(f=>{
      const m = Number.isFinite(f.oreMin) ? Math.max(0,Math.round(f.oreMin)) : toMin(f.oreHHMM);
      if (f.once || f.unaTantum) oneTime += m; else perPiece += m;
    });
    const orePrev = ((perPiece * (Number(sel.qtaPezzi)||1)) + oneTime) / 60;
    return { pezzi: producedPieces(sel), oreEff, orePrev };
  }, [sel, oreRows]);

    // === FASI: Prevista vs Usata per la commessa selezionata ===
  const phaseAgg = React.useMemo(()=>{
    if (!sel) return [];
    const fasi = Array.isArray(sel.fasi) ? sel.fasi : [];
    return fasi.map((f, idx) => {
      const pian = plannedMinsOfPhaseRP(f, sel);
      const eff  = effMinsOfPhaseRP(oreRows, sel.id, idx);
      const scostPerc = pian > 0 ? ((eff - pian) / pian * 100) : null;
      const nome = (typeof window.faseLabel === 'function') ? window.faseLabel(sel, idx) : (f.titolo || f.nome || `Fase ${idx+1}`);
      return { idx, nome, pian, eff, delta: (eff - pian), scostPerc };
    });
  }, [sel, oreRows]);

  function exportCSV_Fasi(){
    if (!sel || !phaseAgg.length) return;
    const q = s => { const v = (s==null?'':String(s)); return /[;"\n\r]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v; };
    const header = ['Commessa','Fase','Prevista','Usata','Delta','Scostamento %'];
    const rows = phaseAgg.map(r => [
      sel.id,
      r.nome,
      fmtHHMM(r.pian),
      fmtHHMM(r.eff),
      (r.delta>0?'+':'') + fmtHHMM(r.delta),
      (r.scostPerc==null ? '' : ((r.scostPerc>=0?'+':'') + (Math.round(r.scostPerc*10)/10).toFixed(1) + '%'))
    ]);
    const csv = [header, ...rows].map(a=>a.join(';')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
    a.download = `report_fasi_${sel.id}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // =================== MATERIALI & DDT ===================
  const findArticolo = (codLike) => {
    if (!codLike) return null;
    return (articoli||[]).find(a =>
      String(a.codice||'') === String(codLike) || String(a.id||'') === String(codLike)
    ) || null;
  };
  const getMovKey  = (m) => (m.articolo || m.articoloCodice || m.codice || m.articoloId || '');
  const getMovDesc = (m) => m.descrizione || (findArticolo(getMovKey(m))?.descrizione || '') || '';
  const getMovUM   = (m) => m.um || (findArticolo(getMovKey(m))?.um || '') || '';

  const movCommessa = React.useMemo(() => {
    if (!sel) return [];
    return (Array.isArray(movimenti) ? movimenti : [])
      .filter(m => String(m.commessaId||m.commessa||'').trim() === sel.id)
      .map(m => ({
        data: m.data || '',
        tipo: m.tipo || m.movimento || '',
        codice: m.codice || m.articolo || m.articoloCodice || m.articoloId || '',
        descrizione: getMovDesc(m),
        um: getMovUM(m),
        qta: +(m.qta || m.qty || m.quantita || 0) || 0
      }))
      .sort((a,b)=> (Date.parse(b.data||0)||0) - (Date.parse(a.data||0)||0));
  }, [sel, movimenti, articoli]);

    // --- Aggregazione ore per riga articolo (compat: righeArticolo | righe) ---
  const aggRighe = React.useMemo(() => {
    const target = sel;
    if (!target) return [];
    const righe = Array.isArray(target.righeArticolo)
      ? target.righeArticolo
      : (Array.isArray(target.righe) ? target.righe : []);

    // somma minuti/pezzi per rigaIdx
    const sum = {};
    const toMin = (v) => {
      if (typeof v === 'number') return Math.max(0, Math.round(v));
      const m = String(v||'').match(/^(\d{1,4})(?::([0-5]?\d))?$/);
      if (!m) return 0; const h = +m[1]||0, mm = + (m[2]||0); return h*60+mm;
    };
    (Array.isArray(oreRows)?oreRows:[])
      .filter(r => r && r.commessaId === target.id)
      .forEach(r => {
        const idx = (r.rigaIdx==='' || r.rigaIdx==null) ? -1 : Number(r.rigaIdx);
        const key = String(idx);
        if (!sum[key]) sum[key] = { rigaIdx: (idx>=0?idx:null), oreMin:0, pezzi:0 };
        sum[key].oreMin += (Number(r.oreMin)||0) || toMin(r.oreHHMM||0);
        sum[key].pezzi  += Math.max(0, Number(r.qtaPezzi||0));
      });

    const toHHMM = (mins) => {
      const t = Math.max(0, Math.round(mins)); const h = Math.floor(t/60), m=t%60;
      return `${h}:${String(m).padStart(2,'0')}`;
    };

    return Object.values(sum).map(x => ({
      ...x,
      oreHHMM: toHHMM(x.oreMin),
      rigaCodice     : (x.rigaIdx!=null && righe[x.rigaIdx]) ? (righe[x.rigaIdx].codice || righe[x.rigaIdx].articoloCodice || '') : '',
      rigaDescrizione: (x.rigaIdx!=null && righe[x.rigaIdx]) ? (righe[x.rigaIdx].descrizione || '') : '',
      rigaUM         : (x.rigaIdx!=null && righe[x.rigaIdx]) ? (righe[x.rigaIdx].um || 'PZ') : '',
    })).sort((a,b)=> (a.rigaIdx??99)-(b.rigaIdx??99));
  }, [sel, oreRows]);

  const isScarico = (row) => {
    const t = String(row.tipo||'').toLowerCase();
    return t.includes('scarico') || Number(row.qta) < 0;
  };

  const consumiAgg = React.useMemo(() => {
    const map = {};
    (movCommessa||[]).forEach(r => {
      if (!isScarico(r)) return;
      const key = r.codice || r.descrizione || '(senza codice)';
      if (!map[key]) map[key] = {
        codice: r.codice || '',
        descrizione: r.descrizione || '',
        um: r.um || '',
        usata: 0
      };
      map[key].usata += Math.abs(r.qta || 0);
    });
    return Object.values(map).sort((a,b)=> String(a.codice).localeCompare(String(b.codice)));
  }, [movCommessa]);

  const previsti = React.useMemo(() => {
    const arr = (sel && Array.isArray(sel.materiali)) ? sel.materiali : [];
    return arr.map(m => ({
      codice: m.codice || '',
      descrizione: m.descrizione || '',
      um: m.um || '',
      prevista: +(m.qta || 0) || 0
    }));
  }, [sel]);

  const righeMerge = React.useMemo(() => {
    const byKeyPrev = {};
    (previsti||[]).forEach(p => {
      const k = p.codice || p.descrizione || '(senza codice)';
      byKeyPrev[k] = p;
    });
    const keys = new Set([
      ...Object.keys(byKeyPrev),
      ...consumiAgg.map(c => c.codice || c.descrizione || '(senza codice)')
    ]);
    const rows = [];
    keys.forEach(k => {
      const p = byKeyPrev[k] || { prevista: 0, um: '', descrizione: '' };
      const c = consumiAgg.find(x => (x.codice||x.descrizione||'(senza codice)') === k) || { usata: 0, um: '', descrizione: '' };
      rows.push({
        codice: (k === '(senza codice)') ? '' : k,
        descrizione: c.descrizione || p.descrizione || '',
        um: c.um || p.um || '',
        prevista: +p.prevista || 0,
        usata: +c.usata || 0,
        delta: (+c.usata||0) - (+p.prevista||0)
      });
    });
    return rows.sort((a,b)=> String(a.codice).localeCompare(String(b.codice)));
  }, [previsti, consumiAgg]);

  const totPrevista = righeMerge.reduce((s,r)=> s + (r.prevista||0), 0);
  const totUsata   = righeMerge.reduce((s,r)=> s + (r.usata||0), 0);
  const totDelta   = righeMerge.reduce((s,r)=> s + (r.delta||0), 0);

  const ddtCommessa = React.useMemo(() => {
    if (!sel) return [];
    const jobId = String(sel.id || '');
    if (!jobId) return [];

    return (Array.isArray(ddtRows) ? ddtRows : [])
      .filter(d => d && !d.deletedAt) // ignora DDT eliminati (soft-delete)
      .filter(d => !(d.annullato === true || String(d.stato || '') === 'Annullato')) // ignora annullati
      .filter(d => {
        const dJobId = String(
          d.commessaId ||
          d.commessa   ||
          d.commessaRif ||
          d.__fromCommessaId ||
          ''
        );
        return dJobId === jobId;
      })
      .sort((a,b)=> (Date.parse(b.data||0)||0) - (Date.parse(a.data||0)||0));
  }, [sel, ddtRows]);

      // --- Aggregazione ORE per riga articolo (commessa selezionata) ---
  const oreRiga = React.useMemo(() => {
    if (!sel) return [];
    const arr = Array.isArray(oreRows) ? oreRows.filter(r => String(r.commessaId) === String(sel.id)) : [];
    const by = new Map();

    const toMin = (v) => {
      if (typeof v === 'number') return Math.max(0, Math.round(v));
      const m = String(v || '').trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
      if (!m) return 0;
      const h = +m[1] || 0, mm = +(m[2] || 0);
      return h * 60 + mm;
    };

    for (const r of arr) {
      const key = (r.rigaIdx == null || r.rigaIdx === '') ? 'ALL' : String(Number(r.rigaIdx));
      const cur = by.get(key) || {
        rigaIdx: (r.rigaIdx == null || r.rigaIdx === '') ? null : Number(r.rigaIdx),
        rigaCodice: r.rigaCodice || '',
        rigaDescrizione: r.rigaDescrizione || '',
        rigaUM: r.rigaUM || 'PZ',
        pezzi: 0,
        oreMin: 0
      };

      const addMins =
        (Number(r.oreMin) || 0) ||
        toMin(r.oreHHMM || 0);

      cur.oreMin += Math.max(0, addMins);
      cur.pezzi  += Math.max(0, Number(r.qtaPezzi || 0));
      // ultimo valore "vince" per i metadati riga
      if (r.rigaCodice)      cur.rigaCodice      = String(r.rigaCodice);
      if (r.rigaDescrizione) cur.rigaDescrizione = String(r.rigaDescrizione);
      if (r.rigaUM)          cur.rigaUM          = String(r.rigaUM);

      by.set(key, cur);
    }

    return Array.from(by.values()).sort((a,b) => (a.rigaIdx ?? 999) - (b.rigaIdx ?? 999));
  }, [sel, oreRows]);

  // --- azioni ---
  function exportCSV(){
    if (!sel) return;
    const rows = [
      ['Commessa', sel.id],
      ['Cliente', (sel.cliente||'')],
      ['Descrizione', (sel.descrizione||'')],
      [],
      ['Codice','Descrizione','UM','Prevista','Usata','Delta']
    ];
    (righeMerge||[]).forEach(r => rows.push([
      r.codice||'',
      r.descrizione||'',
      r.um||'',
      String(r.prevista||0),
      String(r.usata||0),
      String(r.delta||0)
    ]));
    const csv = rows.map(row =>
      row.map(v => {
        const s = String(v==null?'':v);
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = `report-commessa-${sel.id}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

    // === Card: Ore per riga articolo (selezione attuale) ===
const cardOreRiga = (sel && Array.isArray(aggRighe) && aggRighe.length>0)
  ? e('div', { className:'card', style:{marginTop:8} },
      e('h3', null, 'Ore per riga articolo'),
      e('table', { className:'table' },
        e('thead', null, e('tr', null,
          e('th', null, 'Riga #'),
          e('th', null, 'Codice'),
          e('th', null, 'Descrizione'),
          e('th', null, 'UM'),
          e('th', {className:'right'}, 'Pezzi'),
          e('th', {className:'right'}, 'Minuti'),
          e('th', {className:'right'}, 'HH:MM')
        )),
        e('tbody', null,
          aggRighe.map((r,i) => e('tr', { key:i },
            e('td', null, r.rigaIdx==null ? '—' : String(r.rigaIdx+1)),
            e('td', null, r.rigaCodice || ''),
            e('td', null, r.rigaDescrizione || ''),
            e('td', null, r.rigaUM || ''),
            e('td', { className:'right' }, String(r.pezzi || 0)),
            e('td', { className:'right' }, String(r.oreMin || 0)),
            e('td', { className:'right' }, (function(m){ const h=Math.floor(m/60), mm=m%60; return h+':'+String(mm).padStart(2,'0'); })(r.oreMin || 0))
          ))
        )
      )
    )
  : null;

  function exportCSV_Fasi(){
    if (!sel || !phaseAgg.length) return;
    const q = s => {
      const v = (s==null ? '' : String(s));
      return /[;"\n\r]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
    };
    const header = ['Commessa','Fase','Prevista','Usata','Delta','Scostamento %'];
    const rows = phaseAgg.map(r => [
      sel.id,
      r.nome,
      fmtHHMM(r.pian),
      fmtHHMM(r.eff),
      (r.delta>0?'+':'') + fmtHHMM(r.delta),
      (r.scostPerc==null ? '' : ((r.scostPerc>=0?'+':'') + (Math.round(r.scostPerc*10)/10).toFixed(1) + '%'))
    ]);
    const csv = [header, ...rows].map(a=>a.join(';')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
    a. download = `report_fasi_${sel.id}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // -------------------- RENDER --------------------
  return e('div', { className:'grid', style:{ gap:16 } },

    // Card selezione commessa (sempre visibile)
    e('div', { className:'card' },
      e('h3', null, 'Seleziona commessa'),
      e('div', { className:'row', style:{ gap:8, alignItems:'center', marginTop:8, flexWrap:'wrap' } },
        e('input', {
          className:'input',
          style:{ maxWidth:280 },
          placeholder:'Filtra per ID, cliente o descrizione…',
          value:filter, onChange:ev=>setFilter(ev.target.value)
        }),
        e('select', {
          value: selId || '',
          onChange: ev => setSelId(ev.target.value),
          style: { minWidth:260 }
        },
          e('option', { value:'' }, '— scegli una commessa —'),
          opts.map(c => e('option', { key:c.id, value:c.id },
            `${c.id} — ${c.cliente||''}${c.descrizione?(' — '+c.descrizione):''}`
          ))
        ),
        sel && e('a', { className:'btn btn-outline', href:`#/timbratura?job=${encodeURIComponent(sel.id)}` }, 'QR / Timbratura')
      ),
      !sel && e('div', { className:'muted', style:{ marginTop:8 } }, 'Seleziona una commessa per vedere i dettagli.')
    ),

    // Barra superiore azioni (solo con commessa selezionata)
    sel && e('div', { className:'row', style:{gap:6, alignItems:'center', flexWrap:'wrap'} },
      e('button', { className:'btn btn-outline', onClick: () => window.stampaCommessaV2 ? window.stampaCommessaV2(sel): (window.printCommessa && window.printCommessa(sel)) }, 'Stampa'),
      e('button', { className:'btn btn-outline', onClick:exportCSV }, 'Esporta CSV'),
      e('button', { className:'btn btn-outline', onClick:()=> window.creaDDTdaCommessa && window.creaDDTdaCommessa(sel) }, '📦 DDT'),
      e('div', { className:'dropdown', style:{position:'relative', display:'inline-block'} },
        e('button', {
          className:'btn',
          onClick:()=> setMenuRow(r => r===sel.id ? null : sel.id)
        }, '…'),
        (menuRow===sel.id) && e('div', {
          className:'dropdown-menu',
          style:{
            position:'absolute', right:0, top:'100%', marginTop:6,
            background:'#fff', border:'1px solid #ddd', borderRadius:8,
            padding:8, minWidth:180, zIndex:1000,
            boxShadow:'0 8px 24px rgba(0,0,0,.12)'
          }
        },
          e('button', { className:'btn btn-outline', style:{width:'100%'},
            onClick:()=>{ setMenuRow(null);
              (window.openEtichetteColliDialog ? window.openEtichetteColliDialog(sel)
               : window.triggerEtichetteFor && window.triggerEtichetteFor(sel, {}));
            }}, 'Etichette colli'),
          e('button', { className:'btn btn-outline', style:{width:'100%'},
            onClick:()=>{ setMenuRow(null); window.duplicaCommessa && window.duplicaCommessa(sel); }}, '⧉ Duplica'),
          e('button', { className:'btn btn-outline', style:{width:'100%'},
            onClick:()=>{ setMenuRow(null); window.delCommessa && window.delCommessa(sel); }}, '🗑️ Elimina')
        )
      )
    ),

    // KPI rapidi produzione
    sel && e('div', { className:'card' },
      e('h3', null, `Commessa ${sel.id} — KPI`),
      e('div', { className:'row', style:{ gap:16, flexWrap:'wrap' } },
        e('div', { className:'kpi' }, e('div', {className:'muted'}, 'Pezzi prodotti'), e('div', {style:{fontWeight:800, fontSize:20}}, String(kpi.pezzi||0)) ),
        e('div', { className:'kpi' }, e('div', {className:'muted'}, 'Ore effettive'), e('div', {style:{fontWeight:800, fontSize:20}}, (kpi.oreEff||0).toFixed(2)) ),
        e('div', { className:'kpi' }, e('div', {className:'muted'}, 'Ore previste'), e('div', {style:{fontWeight:800, fontSize:20}}, (kpi.orePrev||0).toFixed(2)) )
      )
    ),

      // === Tempi per fase — Prevista vs Usata ===
      e('div', { className:'actions', style:{ justifyContent:'space-between', marginTop:8 } },
        e('h3', null, 'Tempi per fase — Prevista vs Usata'),
        e('div', { className:'row', style:{ gap:8 } },
          e('button', { className:'btn btn-outline', onClick:exportCSV_Fasi, disabled:!(sel && phaseAgg.length) }, '⬇️ CSV')
        )
      ),
      e('div', { className:'card' },
        !sel
          ? e('div', { className:'muted' }, 'Seleziona una commessa dalla lista sopra.')
          : (phaseAgg.length===0
              ? e('div', { className:'muted' }, 'Nessuna fase definita per questa commessa.')
              : e('table', { className:'table' },
                  e('thead', null, e('tr', null,
                    e('th', null, 'Fase'),
                    e('th', { className:'right' }, 'Prevista'),
                    e('th', { className:'right' }, 'Usata'),
                    e('th', { className:'right' }, 'Delta'),
                    e('th', { className:'right' }, 'Scost. %')
                  )),
                  e('tbody', null,
                    phaseAgg.map((r,i)=> e('tr', { key:i },
                      e('td', null, r.nome),
                      e('td', { className:'right' }, fmtHHMM(r.pian)),
                      e('td', { className:'right' }, fmtHHMM(r.eff)),
                      e('td', { className:'right' }, (r.delta>0?'+':'') + fmtHHMM(r.delta)),
                      e('td', { className:'right' },
                        (r.scostPerc==null ? '' :
                          e('span', {
                            style:{ fontWeight:600, color: (r.scostPerc>1 ? '#b91c1c' : (r.scostPerc<-1 ? '#065f46' : '#374151')) }
                          }, (r.scostPerc>=0?'+':'') + (Math.round(r.scostPerc*10)/10).toFixed(1) + '%')
                        )
                      )
                    ))
                  )
               )
            )
      ),

            // Tempi per fase — Prevista vs Usata
    sel && e('div', { className:'actions', style:{ justifyContent:'space-between', marginTop:8 } },
      e('h3', null, 'Tempi per fase — Prevista vs Usata'),
      e('div', { className:'row', style:{ gap:8 } },
        e('button', { className:'btn btn-outline', onClick:exportCSV_Fasi, disabled:!(sel && phaseAgg.length) }, '⬇️ CSV')
      )
    ),
    sel && e('div', { className:'card' },
      !phaseAgg.length
        ? e('div', { className:'muted' }, 'Nessuna fase definita per questa commessa.')
        : e('table', { className:'table' },
            e('thead', null, e('tr', null,
              e('th', null, 'Fase'),
              e('th', { className:'right' }, 'Prevista'),
              e('th', { className:'right' }, 'Usata'),
              e('th', { className:'right' }, 'Delta'),
              e('th', { className:'right' }, 'Scost. %')
            )),
            e('tbody', null,
              phaseAgg.map((r,i)=> e('tr', { key:i },
                e('td', null, r.nome),
                e('td', { className:'right' }, fmtHHMM(r.pian)),
                e('td', { className:'right' }, fmtHHMM(r.eff)),
                e('td', { className:'right' }, (r.delta>0?'+':'') + fmtHHMM(r.delta)),
                e('td', { className:'right' },
                  (r.scostPerc==null ? '' :
                    e('span', {
                      style:{ fontWeight:600, color: (r.scostPerc>1 ? '#b91c1c' : (r.scostPerc<-1 ? '#065f46' : '#374151')) }
                    }, (r.scostPerc>=0?'+':'') + (Math.round(r.scostPerc*10)/10).toFixed(1) + '%')
                  )
                )
              ))
            )
          )
    ),

    // Header commessa
    sel && e('div', {className:'card'},
      e('h3', {style:{fontSize:18, fontWeight:600, marginBottom:8}}, `Commessa ${sel.id}`),
      e('table', {className:'table'},
        e('tbody', null,
          e('tr', null, e('th', null, 'Cliente'),        e('td', null, sel.cliente || '-')),
          e('tr', null, e('th', null, 'Descrizione'),    e('td', null, sel.descrizione || '-')),
          e('tr', null, e('th', null, 'Scadenza'),       e('td', null, fmtIT(sel.scadenza))),
          e('tr', null, e('th', null, 'Quantità pezzi'), e('td', null, sel.qtaPezzi || 1)),
          e('tr', null, e('th', null, 'Priorità'),       e('td', null, sel.priorita || '-')),
          e('tr', null, e('th', null, 'Stato'),
            e('td', null, sel.consegnata ? `Consegnata il ${fmtIT(sel.dataConsegna)}` : 'Aperta')
          )
        )
      )
    ),

    // Materiali: previsti vs usati
    sel && e('div', {className:'card'},
      e('h3', {style:{fontSize:18, fontWeight:600, marginBottom:8}}, 'Materiali: previsti vs usati'),
      e('table', {className:'table'},
        e('thead', null,
          e('tr', null,
            e('th', null, 'Codice'),
            e('th', null, 'Descrizione'),
            e('th', null, 'UM'),
            e('th', {className:'right'}, 'Prevista'),
            e('th', {className:'right'}, 'Usata'),
            e('th', {className:'right'}, 'Delta')
          )
        ),
        e('tbody', null,
          righeMerge.map((r,i) => e('tr', {key:i},
            e('td', null, r.codice || '—'),
            e('td', null, r.descrizione || '—'),
            e('td', null, r.um || '—'),
            e('td', {className:'right'}, String(r.prevista||0)),
            e('td', {className:'right'}, String(r.usata||0)),
            e('td', {className:'right', style:{fontWeight:600}},
              (r.delta>0 ? '+' : '') + String(r.delta||0)
            )
          ))
        ),
        e('tfoot', null,
          e('tr', null,
            e('th', {colSpan:3}, 'Totale'),
            e('th', {className:'right'}, String(totPrevista||0)),
            e('th', {className:'right'}, String(totUsata||0)),
            e('th', {className:'right'}, (totDelta>0?'+':'') + String(totDelta||0))
          )
        )
      )
    ),

          // Ore per riga articolo (commessa selezionata)
    sel && e('div', { className:'card' },
      e('h3', {style:{fontSize:18, fontWeight:600, marginBottom:8}}, 'Ore per riga articolo'),
      (oreRiga.length === 0)
        ? e('div', { className:'muted' }, '— Nessun dato per righe articolo —')
        : e('table', { className:'table' },
            e('thead', null,
              e('tr', null,
                e('th', null, 'Riga #'),
                e('th', null, 'Codice'),
                e('th', null, 'Descrizione'),
                e('th', null, 'UM'),
                e('th', {className:'right'}, 'Pezzi'),
                e('th', {className:'right'}, 'Minuti'),
                e('th', {className:'right'}, 'HH:MM')
              )
            ),
            e('tbody', null,
              oreRiga.map((r,i) => e('tr', { key:i },
                e('td', null, r.rigaIdx == null ? '—' : String(r.rigaIdx + 1)),
                e('td', null, r.rigaCodice || ''),
                e('td', null, r.rigaDescrizione || ''),
                e('td', null, r.rigaUM || ''),
                e('td', { className:'right' }, String(r.pezzi || 0)),
                e('td', { className:'right' }, String(r.oreMin || 0)),
                e('td', { className:'right' }, (function(m){ const h=Math.floor(m/60), mm=m%60; return h+':'+String(mm).padStart(2,'0'); })(r.oreMin || 0))
              ))
            )
          )
    ),

        // === Ore per riga articolo (se presente) ===
        cardOreRiga,

    // DDT collegati (resiliente)
    sel && e('div', {className:'card'},
      e('h3', {style:{fontSize:18, fontWeight:600, marginBottom:8}}, 'DDT collegati'),
      (Array.isArray(ddtCommessa) && ddtCommessa.length>0)
        ? e('table', {className:'table'},
            e('thead', null,
              e('tr', null,
                e('th', null, 'ID'),
                e('th', null, 'Data'),
                e('th', null, 'Cliente'),
                e('th', null, 'Note'),
                e('th', null, 'Righe')
              )
            ),
            e('tbody', null,
              ddtCommessa.map((d,i) => {
                const _id      = d?.id ?? '—';
                const _data    = d?.data ? fmtIT(d.data) : '—';
                const _cliente = d?.clienteRagione ?? '—';
                const _note    = d?.note ?? '—';
                const _righe   = Array.isArray(d?.articoli) ? d.articoli.length : 0;
                return e('tr', {key:i},
                  e('td', null, String(_id)),
                  e('td', null, String(_data)),
                  e('td', null, String(_cliente)),
                  e('td', null, String(_note)),
                  e('td', null, String(_righe))
                );
              })
            )
          )
        : e('div', {className:'muted'}, '— Nessun DDT collegato —')
    )


  );
}

/* ================== REPORT MATERIALI (Aggregato per Articolo, filtrabile) ================== */
function ReportMaterialiView({ query = '' } = {}) {
  const e = React.createElement;

  // LS helper
  const ls = (k, d) => { try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; } catch { return d; } };

  // Dataset base
  const commesse  = React.useMemo(() => ls('commesseRows', []), []);
  const movimenti = React.useMemo(() => ls('magMovimenti', []), []);
  const articoli  = React.useMemo(() => {
    const a1 = ls('magazzinoArticoli', null);
    if (Array.isArray(a1)) return a1;
    return ls('magArticoli', []);
  }, []);

  // Indici rapidi
  const commById = React.useMemo(() => {
    const m = new Map();
    (commesse||[]).forEach(c => m.set(String(c.id), c));
    return m;
  }, [commesse]);

  const findArticolo = (code) => {
    const c = String(code||'');
    if (!c) return null;
    return (articoli||[]).find(a =>
      String(a.codice||'') === c || String(a.id||'') === c
    ) || null;
  };

  // Filtri UI
  const [dal, setDal]               = React.useState('');
  const [al, setAl]                 = React.useState('');
  const [fltCliente, setFltCliente] = React.useState('');
  const [fltComm, setFltComm]       = React.useState('');       // contiene...
  const [fltArt, setFltArt]         = React.useState(query||'');// contiene...
  const [soloScarichi, setSoloScar] = React.useState(true);

  // Normalizzo movimenti con meta (cliente/descrizione articolo)
  const norm = React.useMemo(() => {
    const fromTs = dal ? Date.parse(dal) : null;
    const toTs   = al  ? (Date.parse(al) + 24*3600*1000 - 1) : null; // inclusivo
    const out = [];

    (Array.isArray(movimenti)?movimenti:[]).forEach(m => {
      const ts = Date.parse(m.data || '');
      if (fromTs && !(ts >= fromTs)) return;
      if (toTs && !(ts <= toTs)) return;

      const commId = String(m.commessaId || m.commessa || '').trim();
      const c = commById.get(commId) || null;
      const cliente = (c?.cliente || '').toLowerCase();
      if (fltCliente && !cliente.includes(fltCliente.toLowerCase())) return;

      if (fltComm) {
        const hay = [commId, (c?.descrizione||''), (c?.cliente||'')].join(' ').toLowerCase();
        if (!hay.includes(fltComm.toLowerCase())) return;
      }

      const codice = m.codice || m.articolo || m.articoloCodice || m.articoloId || '';
      const a      = findArticolo(codice);
      const descr  = m.descrizione || a?.descrizione || '';
      const um     = m.um || a?.um || '';

      const mov = String(m.tipo || m.movimento || '').toLowerCase();
      const qty = +(m.qta || m.qty || m.quantita || 0) || 0;

      // filtro “solo scarichi”
      if (soloScarichi) {
        const isScar = mov.includes('scarico') || qty < 0;
        if (!isScar) return;
      }

      const hayArt = [String(codice), String(descr)].join(' ').toLowerCase();
      if (fltArt && !hayArt.includes(fltArt.toLowerCase())) return;

      out.push({
        data: m.data || '',
        ts, mov,
        commessaId: commId || '',
        cliente: c?.cliente || '',
        codice: String(codice||''),
        descrizione: String(descr||''),
        um: String(um||''),
        qta: qty
      });
    });

    return out.sort((a,b)=> (a.codice.localeCompare(b.codice) || (a.ts - b.ts)));
  }, [movimenti, articoli, commById, dal, al, fltCliente, fltComm, fltArt, soloScarichi]);

  // Aggregazione per articolo
  const agg = React.useMemo(() => {
    const map = new Map();
    norm.forEach(r => {
      const key = r.codice || r.descrizione || '(senza codice)';
      if (!map.has(key)) {
        map.set(key, {
          codice: (key === '(senza codice)') ? '' : key,
          descrizione: r.descrizione || '',
          um: r.um || '',
          qta: 0,
          nMov: 0,
          minData: r.ts || null,
          maxData: r.ts || null,
          commesse: new Set()
        });
      }
      const cur = map.get(key);
      cur.qta  += (soloScarichi ? Math.abs(r.qta) : r.qta);
      cur.nMov += 1;
      cur.minData = (cur.minData==null) ? r.ts : Math.min(cur.minData, r.ts);
      cur.maxData = (cur.maxData==null) ? r.ts : Math.max(cur.maxData, r.ts);
      if (r.commessaId) cur.commesse.add(r.commessaId);
    });
    return Array.from(map.values())
      .map(x => ({
        ...x,
        nComm: x.commesse.size,
        dal: (x.minData ? new Date(x.minData).toLocaleDateString('it-IT') : ''),
        al:  (x.maxData ? new Date(x.maxData).toLocaleDateString('it-IT') : '')
      }))
      .sort((a,b)=> a.codice.localeCompare(b.codice));
  }, [norm, soloScarichi]);

  function exportCSV(){
    const header = ['Codice','Descrizione','UM','Q.tà','Movimenti','#Commesse','Dal','Al'];
    const body = agg.map(r => [
      r.codice, r.descrizione, r.um,
      String(r.qta), String(r.nMov), String(r.nComm), r.dal, r.al
    ]);
    const csv = [header, ...body].map(row =>
      row.map(v => {
        const s = String(v||'');
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'report_materiali_aggregato.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  return e('div', {className:'grid', style:{gap:16}},
    e('div', {className:'actions', style:{justifyContent:'space-between'}},
      e('h3', null, 'Report Materiali — Aggregato per articolo'),
      e('div', {className:'row', style:{gap:8}},
        e('button', {className:'btn btn-outline', onClick:exportCSV}, 'Esporta CSV')
      )
    ),
    e('div', {className:'card'},
      e('div', {className:'grid', style:{gap:8, gridTemplateColumns:'repeat(auto-fit, minmax(180px,1fr))'}},
        e('label', null, 'Dal (data)',
          e('input', {type:'date', value:dal, onChange:ev=>setDal(ev.target.value)})
        ),
        e('label', null, 'Al (data)',
          e('input', {type:'date', value:al, onChange:ev=>setAl(ev.target.value)})
        ),
        e('label', null, 'Cliente contiene',
          e('input', {value:fltCliente, onChange:ev=>setFltCliente(ev.target.value), placeholder:'es. Brembo'})
        ),
        e('label', null, 'Commessa contiene',
          e('input', {value:fltComm, onChange:ev=>setFltComm(ev.target.value), placeholder:'es. C-2025'})
        ),
        e('label', null, 'Articolo/Descrizione contiene',
          e('input', {value:fltArt, onChange:ev=>setFltArt(ev.target.value), placeholder:'codice o testo'})
        ),
        e('label', {className:'row', style:{alignItems:'center', gap:6, marginTop:4}},
          e('input', {type:'checkbox', checked:soloScarichi, onChange:ev=>setSoloScar(ev.target.checked)}),
          e('span', null, 'Solo scarichi (consumi)')
        )
      )
    ),
    e('div', {className:'card'},
      agg.length===0
        ? e('div', {className:'muted'}, '— Nessun dato con i filtri correnti —')
        : e('table', {className:'table'},
            e('thead', null,
              e('tr', null,
                e('th', null, 'Codice'),
                e('th', null, 'Descrizione'),
                e('th', null, 'UM'),
                e('th', {className:'right'}, 'Q.tà'),
                e('th', {className:'right'}, 'Movimenti'),
                e('th', {className:'right'}, '# Commesse'),
                e('th', null, 'Dal'),
                e('th', null, 'Al')
              )
            ),
            e('tbody', null,
              agg.map((r,i)=> e('tr', {key:i},
                e('td', null, r.codice || '—'),
                e('td', null, r.descrizione || '—'),
                e('td', null, r.um || '—'),
                e('td', {className:'right'}, String(r.qta)),
                e('td', {className:'right'}, String(r.nMov)),
                e('td', {className:'right'}, String(r.nComm)),
                e('td', null, r.dal || '—'),
                e('td', null, r.al  || '—')
              ))
            )
          )
    )
  );
}
window.ReportMaterialiView = window.ReportMaterialiView || ReportMaterialiView;

// Compat: alias e agganci globali
window.ReportProdView = ReportProdView;
window.ReportView = window.ReportView || ReportProdView;
window.openReport = window.openReport || function () {
  if (typeof window.setTab === 'function') window.setTab('Report');
  if (location.hash !== '#/report') location.hash = '#/report';
};


/* ================== IMPOSTAZIONI (unificata: logo, operatori, fasi, cloud) ================== */
function ImpostazioniView() {
  const e = React.createElement;

  const isAdmin = window.hasRole && window.hasRole('admin');
    const CLOUD_EDITABLE_FIELDS = [
    'supabaseUrl',
    'supabaseKey',
    'supabaseTable',
    'supabaseEnv',
    'cloudEnv',
    'supabaseUrlBeta',
    'supabaseKeyBeta',
    'supabaseTableBeta',
    'syncTable'
  ];
  // se non admin, non blocchiamo: mostriamo la vista ma disabilitiamo i campi più avanti (quando definisci gli <input>, metti disabled: !isAdmin)


  // Helpers LS
  const lsGet = window.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});

  // Fallback locale se l'helper globale non fosse presente
  const updateAppSettings = window.updateAppSettings || function(patch){
    try{
      const cur = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
      const next = { ...cur, ...(patch||{}), updatedAt: new Date().toISOString() };
      localStorage.setItem('appSettings', JSON.stringify(next));
      window.__anima_dirty = true;
      return next;
    }catch(e){ console.error('updateAppSettings error', e); }
  };

  // Stato iniziale da appSettings
  const app0 = lsGet('appSettings', {}) || {};
const counters0 = lsGet('counters', {}) || {};
  const Y = new Date().getFullYear();

  const last = (series) => {
    const c = counters0[series];
    return (c && c.year === Y) ? Number(c.num) || 0 : 0;
  };

  const initNum = (seriesKey) => {
    const base = last(seriesKey) || 0;

    // prova a leggere eventuali numerazioni salvate in appSettings
    const numer = app0.numerazioni || app0.numeratori || {};
    const perSerie = numer[seriesKey] || {};

    // nuovo schema per-anno: numerazioni[serie][YYYY].ultimo
    const byYear = perSerie[String(Y)] && perSerie[String(Y)].ultimo;

    // campo flat per compatibilità: numerazioni[serie].ultimo
    const flat = perSerie.ultimo;

    // schema che usavamo prima: { last, year }
    const modern = (perSerie.year === Y && Number.isFinite(+perSerie.last))
      ? +perSerie.last
      : 0;

    // fallback legacy (vecchi campi sparsi in appSettings)
    const legacy = app0[seriesKey + '_last'] ?? app0['ultimo' + seriesKey];

    const saved = Number(byYear ?? flat ?? modern ?? legacy ?? 0) || 0;
    const val = Math.max(base, saved);

    return val || '';
  };

  // Operatori iniziali: app0.operators può essere array di {name} o di stringhe
  const operatorsTextInitial =
    Array.isArray(app0.operators)
      ? app0.operators
          .map(o => {
            if (typeof o === 'string') return o;
            return String(o.name || o.label || '').trim();
          })
          .filter(Boolean)
          .join('\n')
      : (typeof app0.operators === 'string'
          ? String(app0.operators).replace(/[,;|]/g, '\n')
          : '');

    // Utenti e ruoli (login Supabase) iniziali
  const usersInitial = Array.isArray(app0.users)
    ? app0.users.map(u => ({
        email: String(u.email || u.username || '').trim(),
        role : (u.role || 'worker')
      }))
    : [];
    
      const fasiStandardInitial = Array.isArray(app0.fasiStandard)
    ? app0.fasiStandard
        .map(f => {
          if (typeof f === 'string') return f;
          return String(f.label || f.nome || f.lav || '').trim();
        })
        .filter(Boolean)
    : [];

      // Capacità reparti: app0.capacitaReparti = { Taglio: 40, Saldatura: 55, ... }
  const capMap = (app0.capacitaReparti && typeof app0.capacitaReparti === 'object')
    ? app0.capacitaReparti
    : {};
  let capacitaRepartiTextInitial = '';
  try{
    capacitaRepartiTextInitial = String(app0.capacitaRepartiText || '').trim();
  }catch(e){
    capacitaRepartiTextInitial = '';
  }
  if (!capacitaRepartiTextInitial && capMap && Object.keys(capMap).length){
    capacitaRepartiTextInitial = Object.keys(capMap).map(name => {
      const ore = capMap[name];
      return String(name) + ': ' + String(ore);
    }).join('\n');
  }

  const [form, setForm] = React.useState({
    publicBaseUrl : app0.publicBaseUrl || '',

    docBasePath   : app0.docBasePath || '\\\\ANIMA-SERVER\\ANIMA_DOC', // <<<< QUESTA MANCAVA!
    magUpdateCMP  : !!app0.magUpdateCMP,

    // Dati azienda
    ragioneSociale   : app0.ragioneSociale || app0.aziendaNome || '',
    piva             : app0.piva || app0.pIva || '',
    sedeLegale       : app0.sedeLegale || '',
    sedeOperativa    : app0.sedeOperativa || '',
    email            : app0.email || '',
    telefono         : app0.telefono || '',

    // ► Dati fiscali aggiuntivi
    rea              : app0.rea || '',
    capitaleSociale  : app0.capitaleSociale || app0.capitale || '',
    sdi              : app0.sdi || app0.codiceSdi || '',
    regimeFiscale    : app0.regimeFiscale || 'RF01',

    // ► Dati bancari (stampa di cortesia)
    bankName         : app0.bankName || '',
    bankHolder       : app0.bankHolder || '',
    iban             : app0.iban || '',
    bic              : app0.bic || '',

    // Progressivi (peek ultimo usato nell'anno, da counters + appSettings.numerazioni)
    numC   : initNum('C'),
    numDDT : initNum('DDT'),
    numFA  : initNum('FA'),
    numOF  : initNum('OF'),


    // Default documenti
    defaultIva       : Number.isFinite(+app0.defaultIva) ? +app0.defaultIva : 22,
    defaultPagamento : app0.defaultPagamento || '30 gg data fattura',
    costoOrarioAzienda: Number.isFinite(+app0.costoOrarioAzienda) ? +app0.costoOrarioAzienda : 0,
    authRequired     : !!app0.authRequired,

    // Utenti & ruoli (login Supabase)
    users            : usersInitial,

    // Operatori (multiline)
    operatorsText    : operatorsTextInitial,

    // Cloud (Supabase)
    cloudEnabled     : !!app0.cloudEnabled,
    supabaseUrl      : app0.supabaseUrl || '',
    supabaseKey      : app0.supabaseKey || '',
    supabaseTable    : app0.supabaseTable || 'anima_sync',

    // Fasi standard
    fasiStandard     : fasiStandardInitial,
    
    // Capacità reparti (ore/settimana)
    capacitaRepartiText: capacitaRepartiTextInitial,

    // Logo (base64 per stampe)
    logoDataUrl      : app0.logoDataUrl || ''
  });

    function onChange(ev){
    const {name, value, type, checked} = ev.target;

    // Se NON sei admin puoi modificare SOLO i campi di Cloud / Supabase
    if (!isAdmin && CLOUD_EDITABLE_FIELDS.indexOf(name) === -1){
      return;
    }

    setForm(p => ({
      ...p,
      [name]: (type === 'checkbox' ? !!checked : value)
    }));
  }

  // Gestione utenti & ruoli (login Supabase)
  function addUserRow(){
    if (!isAdmin) return;
    setForm(p => ({
      ...p,
      users: [
        ...(Array.isArray(p.users) ? p.users : []),
        { email:'', role:'worker' }
      ]
    }));
  }

  function updateUserField(index, field, value){
    if (!isAdmin) return;
    setForm(p => {
      const arr = Array.isArray(p.users) ? [...p.users] : [];
      if (!arr[index]) arr[index] = { email:'', role:'worker' };
      arr[index] = { ...arr[index], [field]: value };
      return { ...p, users: arr };
    });
  }

  function removeUserRow(index){
    if (!isAdmin) return;
    setForm(p => ({
      ...p,
      users: (Array.isArray(p.users) ? p.users : []).filter((_,i)=> i!==index)
    }));
  }

  // Parse operatori
  function parseOperators(text){
    const arr = String(text||'')
      .split(/\r?\n|,|;|\|/)
      .map(s => s.trim())
      .filter(Boolean);
    const out=[]; const seen=new Set();
    for (const x of arr){ if(!seen.has(x)){ seen.add(x); out.push(x);} }
    return out;
  }

  // Upload logo
  async function onPickLogo(ev){
    if (!isAdmin) {
      ev.target.value = '';
      return;
    }
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    const b64 = await new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = () => res(String(fr.result));
      fr.onerror = rej;
      fr.readAsDataURL(f);
    });
    setForm(p => ({ ...p, logoDataUrl: b64 }));
    ev.target.value = '';
  }

// Salva TUTTO (unico punto di verità)
  function save(ev){
    ev && ev.preventDefault();
    if (!window.safeSetJSON) { alert('safeSetJSON mancante'); return; }

    // RBAC: solo ADMIN può toccare tutti i dati.
    const u = window.__USER || null;
    const role = (u && u.role) || 'admin';
    const isAdminUser = (role === 'admin');

    const appPrev = app0 || {};
    const nowIso = new Date().toISOString();

    // --- BRANCH WORKER: aggiorna solo Supabase ---
    if (!isAdminUser){
      updateAppSettings({
        ...appPrev,
        updatedAt: nowIso,
        // Supabase/Cloud (solo campi tecnici)
        supabaseUrl      : String(form.supabaseUrl||'').trim(),
        supabaseKey      : String(form.supabaseKey||'').trim(),
        supabaseTable    : String(form.supabaseTable||'anima_sync').trim(),
        supabaseEnv      : form.supabaseEnv || appPrev.supabaseEnv || '',
        cloudEnv         : form.cloudEnv || appPrev.cloudEnv || '',
        supabaseUrlBeta  : String(form.supabaseUrlBeta||'').trim(),
        supabaseKeyBeta  : String(form.supabaseKeyBeta||'').trim(),
        supabaseTableBeta: String(form.supabaseTableBeta||'').trim(),
        syncTable        : String(form.syncTable || form.supabaseTable || appPrev.syncTable || 'anima_sync'),
      });
      alert('Parametri Supabase aggiornati.');
      return;
    }

    // --- BRANCH ADMIN (Completo) ---
    if (!form.ragioneSociale || !(form.sedeOperativa || form.sedeLegale) || !form.piva) {
      if (!confirm('Mancano dati anagrafici essenziali. Salvare comunque?')) return;
    }

    // normalizza utenti e operatori
    const usersSanitized = (Array.isArray(form.users)?form.users:[])
      .map(u=>({ email: String(u.email||u.username||'').trim(), role: u.role || 'worker' }))
      .filter(u=>u.email);

    const operatorsArr = String(form.operatorsText || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean).map(name => ({ name }));

    const fasiStd = (Array.isArray(form.fasiStandard) ? form.fasiStandard : [])
      .map(v => {
        if (typeof v === 'string') return v.trim() ? { label: v.trim(), hhmm: '' } : null;
        const label = String(v.label||v.nome||v.lav||'').trim();
        return label ? { label, hhmm: String(v.hhmm||'').trim() } : null;
      }).filter(Boolean);

    const capLines = String(form.capacitaRepartiText || '').split(/\r?\n/);
    const capacitaReparti = {};
    capLines.forEach(line => {
      const parts = line.trim().split(':');
      if(parts.length>=2) {
        const n = Number(parts[1].replace(',','.'));
        if(n>0) capacitaReparti[parts[0].trim()] = n;
      }
    });

    // numerazioni
    const numerazioni = Object.assign({}, (form.numerazioni || app0.numerazioni || {}));
    const setNum = (serie, field) => {
      const v = Number(form[field]);
      if (!Number.isFinite(v) || v <= 0) return;
      const Y = String(new Date().getFullYear());
      const cur = numerazioni[serie] ? { ...numerazioni[serie] } : {};
      cur[Y] = Object.assign({}, cur[Y], { ultimo: v });
      cur.ultimo = v; cur.last = v; cur.year = Number(Y);
      numerazioni[serie] = cur;
    };
    setNum('C', 'numC'); setNum('DDT', 'numDDT'); setNum('FA', 'numFA'); setNum('OF', 'numOF');

    // SALVATAGGIO REALE
    updateAppSettings({
      ...appPrev,
      updatedAt: nowIso,
      
      // Anagrafica
      ragioneSociale: form.ragioneSociale, indirizzo: form.indirizzo,
      cap: form.cap, citta: form.citta, provincia: form.provincia, nazione: form.nazione,
      piva: form.piva, codiceFiscale: form.codiceFiscale,
      sedeLegale: form.sedeLegale, sedeOperativa: form.sedeOperativa,
      email: form.email, telefono: form.telefono, sitoWeb: form.sitoWeb, pec: form.pec,

      // Fiscali
      rea: form.rea, capitaleSociale: form.capitaleSociale, sdi: form.sdi, regimeFiscale: form.regimeFiscale,

      // Banca
      iban: form.iban, banca: form.banca, intestatario: form.intestatario,
      bankName: form.bankName, bankHolder: form.bankHolder, bic: form.bic,

      // Opzioni Doc
      descrizioneDefaultDDT: form.descrizioneDefaultDDT, descrizioneDefaultFA: form.descrizioneDefaultFA,
      defaultIva: Number(form.defaultIva)||22, mostraLogo: !!form.mostraLogo, mostraRifCliente: !!form.mostraRifCliente,
      notePiedeDDT: form.notePiedeDDT, notePiedeFA: form.notePiedeFA,

      // Cloud
      cloudEnabled: !!form.cloudEnabled, authRequired: !!form.authRequired,
      supabaseUrl: form.supabaseUrl, supabaseKey: form.supabaseKey, supabaseTable: form.supabaseTable,
      autoSyncEnabled: !!form.autoSyncEnabled, autoSyncDelay: Number(form.autoSyncDelay)||15000,
      publicBaseUrl: form.publicBaseUrl,

      // Percorsi NAS (ECCOLO QUI)
      docBasePath: String(form.docBasePath||'').trim(),

      // Liste
      users: usersSanitized, operators: operatorsArr, fasiStandard: fasiStd,
      capacitaReparti: capacitaReparti, capacitaRepartiText: form.capacitaRepartiText,

      // Altro
      timbraturaAutoScarico: !!form.timbraturaAutoScarico,
      timbraturaScaricoKey: form.timbraturaScaricoKey||'magMovimenti',
      magUpdateCMP: Number(form.magUpdateCMP),
      costoOrarioAzienda: Number(form.costoOrarioAzienda)||0,
      logoDataUrl: form.logoDataUrl,
      numerazioni: numerazioni
    });

    // Aggiorna counters locali
    try {
      const counters = JSON.parse(localStorage.getItem('counters')||'{}') || {};
      const Y = new Date().getFullYear();
      if (+form.numC)   counters['C']   = { year: Y, num: +form.numC };
      if (+form.numDDT) counters['DDT'] = { year: Y, num: +form.numDDT };
      if (+form.numFA)  counters['FA']  = { year: Y, num: +form.numFA };
      if (+form.numOF)  counters['OF']  = { year: Y, num: +form.numOF };
      localStorage.setItem('counters', JSON.stringify(counters));
      window.__anima_dirty = true;
    } catch {}

    alert('Impostazioni salvate ✅');
  }

  // Azioni Cloud
  const sbReady = !!(form.supabaseUrl && form.supabaseKey && form.supabaseTable);
  function testConn(){
    const url = (form.supabaseUrl||'').trim();
    const key = (form.supabaseKey||'').trim();
    const table = (form.supabaseTable||'anima_sync').trim();
    if (!url || !key) return alert('Compila URL e API Key.');
    const endpoint = url.replace(/\/+$/,'') + `/rest/v1/${encodeURIComponent(table)}?select=k&limit=1`;
    fetch(endpoint, { method:'GET', headers:{ apikey:key, Authorization:'Bearer '+key } })
      .then(res => { if (!res.ok && res.status !== 406) return res.text().then(t=>{throw new Error(t||res.statusText);}); })
      .then(()=> alert('Connessione OK ✅'))
      .catch(e => alert('Connessione KO: ' + (e?.message || String(e))));
  }
  function importCloud(){
    if (!sbReady) return alert('Config Supabase mancante.');
    if (!form.cloudEnabled) return alert('Attiva “Cloud abilitato” e Salva, poi ricarica.');
    if (typeof window.syncImportFromCloud === 'function') window.syncImportFromCloud();
    else alert('Funzioni cloud non inizializzate. Salva e ricarica (Ctrl+F5).');
  }
  function exportCloud(){
    if (!sbReady) return alert('Config Supabase mancante.');
    if (!form.cloudEnabled) return alert('Attiva “Cloud abilitato” e Salva, poi ricarica.');
    if (typeof window.syncExportToCloud === 'function') window.syncExportToCloud();
    else alert('Funzioni cloud non inizializzate. Salva e ricarica (Ctrl+F5).');
  }

  function svuotaCestinoDDT(){
    if (!isAdmin) {
      alert('Solo l’admin può svuotare il cestino DDT.');
      return;
    }
    if (!confirm('Svuotare il cestino DDT?\nVerranno eliminati DEFINITIVAMENTE i DDT già eliminati (deletedAt) da più di 6 mesi.')) {
      return;
    }

    let all = [];
    try {
      all = JSON.parse(localStorage.getItem('ddtRows') || '[]') || [];
    } catch {
      all = [];
    }

    const now = new Date();
    const cutoff = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
    const cutTime = cutoff.getTime();

    let removed = 0;
    const kept = (Array.isArray(all) ? all : []).filter(d => {
      if (!d || !d.deletedAt) return true; // DDT non cancellato → lo tengo
      const t = Date.parse(d.deletedAt);
      if (!t || t > cutTime) return true;  // deletedAt recente → lo tengo
      removed++;
      return false;                        // deletedAt vecchio → lo butto
    });

    try {
      localStorage.setItem('ddtRows', JSON.stringify(kept));
    } catch {}

    // best effort sync su cloud / KV
    try {
      if (typeof window.syncExportToCloudOnly === 'function') {
        window.syncExportToCloudOnly(['ddtRows']);
      }
      if (typeof window.persistKV === 'function') {
        window.persistKV('ddtRows', kept);
      }
      if (window.api?.kv?.set) {
        window.api.kv.set('ddtRows', kept);
      }
    } catch (e) {
      console.warn('[Impostazioni] sync svuotaCestinoDDT fallita', e);
    }

  alert(`Cestino DDT svuotato.\nDDT rimossi definitivamente: ${removed}.`);
  }

  const autosync = !!(window.__cloudSync__ && window.__cloudSync__.enabled);
  const cloudState = window.__cloudSync__ || {};
  const lastPushStr = cloudState.lastPush ? new Date(cloudState.lastPush).toLocaleString() : 'n/d';
  const lastPullStr = cloudState.lastPull ? new Date(cloudState.lastPull).toLocaleString() : 'n/d';
  const lastErrStr  = cloudState.lastError ? ` · Ultimo errore: ${cloudState.lastError}` : '';

  // UI
  return e('div', {className:'page', style:{display:'grid', gap:16}},
    
    // --- BLOCCO NUOVO: Percorsi Documenti (NAS) ---
    e('div', {className:'card'},
      e('h3', null, 'Percorsi Documenti (NAS/Rete)'),
      e('div', {className:'form'},
        e('div', {style:{gridColumn:'1 / -1'}},
          e('label', null, 'Percorso Base Allegati'),
          e('input', {
            name:'docBasePath',
            // Se non c'è nulla, suggerisce Z:\ANIMA_DOC
            value: form.docBasePath || '', 
            onChange: onChange,
            readOnly: !isAdmin,
            placeholder: 'Es. Z:\\ANIMA_DOC'
          })
        ),
        e('div', {className:'muted', style:{marginTop:4}}, 
          'Inserisci "Z:\\ANIMA_DOC" dopo aver mappato l\'unità di rete su Windows.'
        )
      )
    ),
    
    // Dati azienda
    e('div', {className:'card'},
      e('h3', null, 'Dati azienda'),
      e('div', {className:'form'},
        e('div', null, e('label', null, 'Ragione sociale'), e('input', {name:'ragioneSociale', value:form.ragioneSociale, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'P. IVA'),          e('input', {name:'piva', value:form.piva, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'Sede legale'),     e('input', {name:'sedeLegale', value:form.sedeLegale, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'Sede operativa'),  e('input', {name:'sedeOperativa', value:form.sedeOperativa, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'Email'),           e('input', {name:'email', value:form.email, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'Telefono'),        e('input', {name:'telefono', value:form.telefono, onChange:onChange, readOnly:!isAdmin}))
      )
    ),


    // ► Dati fiscali aggiuntivi
    e('div', {className:'card'},
      e('h3', null, 'Dati fiscali aggiuntivi'),
      e('div', {className:'form'},
        e('div', null, e('label', null, 'REA'),               e('input', {name:'rea', value:form.rea, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'Capitale sociale'),  e('input', {name:'capitaleSociale', value:form.capitaleSociale, onChange:onChange, readOnly:!isAdmin, placeholder:'es. € 10.000 i.v.'})),
        e('div', null, e('label', null, 'Codice SDI'),        e('input', {name:'sdi', value:form.sdi, onChange:onChange, readOnly:!isAdmin})),
        e('div', null,
          e('label', null, 'Regime fiscale (RFxx)'),
          e('select', {
            name:'regimeFiscale',
            value:form.regimeFiscale||'RF01',
            onChange:onChange,
            disabled: !isAdmin
          },
            e('option',{value:'RF01'},'RF01 — Ordinario'),
            e('option',{value:'RF19'},'RF19 — Forfettario'),
            e('option',{value:'RF02'},'RF02 — Contribuenti minimi'),
            e('option',{value:'RF04'},'RF04 — Agricoltura e pesca'),
            e('option',{value:'RF18'},'RF18 — Altro regime speciale')
          )
        ),
      )
    ),

    // Logo per stampe
    e('div', {className:'card'},
      e('h3', null, 'Logo per stampe'),
      e('div', {className:'row', style:{gap:8, alignItems:'center'}},
        e('input', {type:'file', accept:'image/*', onChange:onPickLogo, disabled:!isAdmin}),
        form.logoDataUrl
          ? e('img', {src:form.logoDataUrl, alt:'logo', style:{height:40, border:'1px solid #ddd', padding:4}})
          : e('div', {className:'muted'}, 'Nessun logo caricato')
      )
    ),

    // Operatori
    e('div', {className:'card'},
      e('h3', null, 'Operatori (uno per riga)'),
      e('textarea', {
        name:'operatorsText',
        value:form.operatorsText,
        onChange:onChange,
        rows:6,
        readOnly: !isAdmin
      })
    ),

    // Fasi standard (tendina nelle commesse)
    e('div', {className:'card'},
      e('h3', null, 'Fasi standard (tendina nelle commesse)'),
      e('div', null,
        (form.fasiStandard || []).map((v,i) => {
          const val = (typeof v === 'string')
            ? v
            : String(v.label || v.nome || v.lav || '').trim();

          return e('div',{key:i, className:'row', style:{gap:6, marginBottom:6}},
            e('input', {
              value: val,
              onChange: ev => {
                if (!isAdmin) return;
                const newVal = ev.target.value;
                setForm(p => ({
                  ...p,
                  fasiStandard: (p.fasiStandard || []).map((x,ix) => ix === i ? newVal : x)
                }));
              },
              readOnly: !isAdmin
            }),
            e('button', {
              type:'button',
              className:'btn btn-outline',
              onClick: () => setForm(p => ({
                ...p,
                fasiStandard: (p.fasiStandard || []).filter((_,ix) => ix !== i)
              })),
              disabled: !isAdmin
            }, '🗑')
          );
        }),
        e('button', {
          type:'button',
          className:'btn',
          onClick:()=> setForm(p=>({...p, fasiStandard:[...(p.fasiStandard||[]), '']})),
          disabled: !isAdmin
        }, '➕ Aggiungi fase')
      )
    ),

        // Capacità reparti (ore/settimana)
    e('div', {className:'card'},
      e('h3', null, 'Capacità reparti (ore/settimana)'),
      e('p', {className:'muted', style:{fontSize:12}},
        'Uno per riga, formato "Reparto: ore". Esempio:',
        ' Taglio: 40   Saldatura: 55   Montaggio: 32.'
      ),
      e('textarea', {
        name:'capacitaRepartiText',
        value: form.capacitaRepartiText || '',
        onChange: onChange,
        rows: 4,
        readOnly: !isAdmin
      })
    ),

    // ► Dati bancari (per stampa di cortesia)
    e('div', {className:'card'},
      e('h3', null, 'Dati bancari (stampa fattura di cortesia)'),
      e('div', {className:'form'},
        e('div', null, e('label', null, 'Banca'),            e('input', {name:'bankName', value:form.bankName, onChange:onChange, readOnly:!isAdmin, placeholder:'es. Intesa Sanpaolo'})),
        e('div', null, e('label', null, 'Intestatario conto'),e('input', {name:'bankHolder', value:form.bankHolder, onChange:onChange, readOnly:!isAdmin, placeholder:'es. ANIMA S.r.l.'})),
        e('div', null, e('label', null, 'IBAN'),             e('input', {name:'iban', value:form.iban, onChange:onChange, readOnly:!isAdmin})),
        e('div', null, e('label', null, 'BIC/SWIFT'),        e('input', {name:'bic', value:form.bic, onChange:onChange, readOnly:!isAdmin}))
      )
    ),

    // Numerazione documenti (anno corrente)
    e('div', {className:'card'},
      e('h3', null, `Numerazione documenti (${new Date().getFullYear()})`),
      e('div', {className:'row', style:{gap:12, alignItems:'center', flexWrap:'wrap'}},
        e('label', null, 'Commesse (C):',
          e('input', {
            type:'number',
            value: form.numC || '',
            onChange: ev=> setForm(p=>({...p, numC: Number(ev.target.value)||0 })),
            disabled: !isAdmin
          })
        ),
        e('label', null, 'DDT (DDT):',
          e('input', {
            type:'number',
            value: form.numDDT || '',
            onChange: ev=> setForm(p=>({...p, numDDT: Number(ev.target.value)||0 })),
            disabled: !isAdmin
          })
        ),
        e('label', null, 'Fatture (FA):',
          e('input', {
            type:'number',
            value: form.numFA || '',
            onChange: ev=> setForm(p=>({...p, numFA: Number(ev.target.value)||0 })),
            disabled: !isAdmin
          })
        ),
        e('label', null, 'Ordini Fornitori (OF):',
          e('input', {
            type:'number',
            value: form.numOF || '',
            onChange: ev=> setForm(p=>({...p, numOF: Number(ev.target.value)||0 })),
            disabled: !isAdmin
          })
        ),
    e('div', {className:'muted'}, 'Inserisci l’ULTIMO numero emesso nel ', new Date().getFullYear(), '. Dal prossimo documento proseguirà +1. Nel 2026 riparte da 1 automaticamente.')
      ),
      e('div', {className:'row', style:{marginTop:8}},
        e('button', {
          type:'button',
          className:'btn btn-outline',
          disabled: !isAdmin,
          onClick: svuotaCestinoDDT
        }, '🗑️ Svuota cestino DDT (≥ 6 mesi)')
      )
    ),

    // Magazzino
    e('div', {className:'card'},
      e('h3', null, 'Magazzino'),
      e('div', {className:'row', style:{gap:12, alignItems:'center'}},
        e('label', null,
          e('input', {
            type:'checkbox',
            name:'magUpdateCMP',
            checked:!!form.magUpdateCMP,
            onChange:onChange,
            disabled: !isAdmin
          }),
          ' Aggiorna automaticamente il CMP ai carichi da Ordini Fornitori'
        ),
        e('div', {className:'muted'}, 'Suggerito: OFF. Si può spuntare caso per caso nella ricezione.')
      )
    ),
          // Costi aziendali
    e('div', {className:'card'},
      e('h3', null, 'Costi aziendali'),
      e('div', {className:'form'},
        e('div', null,
          e('label', null, 'Costo orario azienda (€ / h)'),
          e('input', {
            type:'number', step:'0.01', min:0,
            name:'costoOrarioAzienda',
            value: (form.costoOrarioAzienda ?? 0),
            onChange:onChange,
            disabled: !isAdmin,
            placeholder:'es. 35'
          })
        ),
        e('div', {className:'muted'},
          'Usato nei futuri report di margine: costo = ore effettive × costo orario.'
        )
      )
    ),

    // Utenti & ruoli (login Supabase)
    e('div', {className:'card'},
      e('h3', null, 'Utenti e ruoli (login Supabase)'),
      e('div', {className:'settings-users'},
        e('div', {className:'muted', style:{marginBottom:8}},
          'Qui configuri quali email Supabase hanno accesso e con che ruolo.'
        ),
        e('div', {className:'settings-users-list'},
          (Array.isArray(form.users) ? form.users : []).map((u,idx)=>
            e('div', {
              key:idx,
              className:'row',
              style:{gap:8, alignItems:'center', marginBottom:4}
            },
              e('input', {
                type:'email',
                placeholder:'email@azienda.it',
                value: u.email || u.username || '',
                onChange: ev => updateUserField(idx, 'email', ev.target.value),
                disabled: !isAdmin
              }),
              e('select', {
                value: u.role || 'worker',
                onChange: ev => updateUserField(idx, 'role', ev.target.value),
                disabled: !isAdmin
              },
                e('option', {value:'admin'},      'Admin'),
                e('option', {value:'resp'},       'Responsabile produzione'),
                e('option', {value:'worker'},     'Worker (solo timbratura/etichette)'),
                e('option', {value:'accountant'}, 'Accountant (solo lettura)'),
                e('option', {value:'viewer'},     'Viewer (solo consultazione, accesso limitato)'),
                e('option', {value:'mobile'},     'Mobile (solo consultazione da smartphone)')
              ),
              e('button', {
                type:'button',
                className:'btn btn-outline',
                onClick: () => removeUserRow(idx),
                disabled: !isAdmin
              }, '🗑')
            )
          ),
          e('button', {
            type:'button',
            className:'btn',
            onClick: addUserRow,
            disabled: !isAdmin
          }, '➕ Aggiungi utente')
        )
      )
    ),
    
    // Cloud (Supabase)
    e('div', {className:'card'},
      e('h3', null, 'Cloud (Supabase)'),
      e('div', {className:'row', style:{gap:12, alignItems:'center', flexWrap:'wrap'}},
        e('label', null,
          e('input', {
            type:'checkbox',
            name:'cloudEnabled',
            checked:!!form.cloudEnabled,
            onChange:onChange,
            disabled: !isAdmin
          }),
          ' Cloud abilitato'
        ),
        e('label', null,
          e('input', {
            type:'checkbox',
            name:'authRequired',
            checked:!!form.authRequired,
            onChange:onChange,
            disabled: !isAdmin
          }),
          ' Richiedi login per usare il gestionale'
        ),
        e('label', { style:{minWidth:360} }, 'URL:',
            e('input', {name:'supabaseUrl', value:form.supabaseUrl, onChange:onChange, placeholder:'https://xxxx.supabase.co'})
        ),
        e('label', { style:{minWidth:360} }, 'API Key:',
            e('input', {type:'password', name:'supabaseKey', value:form.supabaseKey, onChange:onChange, placeholder:'eyJ...'})
        ),
        e('label', null, 'Tabella:',
          e('input', {name:'supabaseTable', value:form.supabaseTable, onChange:onChange, placeholder:'anima_sync'})
        )
      ),
      e('div', {className:'row', style:{gap:8, marginTop:10, flexWrap:'wrap'}},
        e('button', {type:'button', className:'btn', onClick:testConn}, '🔌 Test connessione'),
        e('button', {type:'button', className:'btn', onClick:importCloud}, '⬇️ Importa ora'),
        e('button', {type:'button', className:'btn', onClick:exportCloud}, '⬆️ Esporta ora')
      ),
      e('div', {className:'muted', style:{marginTop:6}},
        `Stato: ${form.cloudEnabled ? 'Abilitato' : 'Disabilitato'} · Auto-sync: ${autosync ? 'attivo' : 'spento'} · Ultimo export: ${lastPushStr} · Ultimo import: ${lastPullStr}${lastErrStr}`
      )
    ),

    // URL pubblico per QR
    e('div', {className:'card'},
      e('h3', null, 'URL pubblico per QR (opzionale)'),
      e('div', {className:'form'},
        e('div', null, e('label', null, 'Base URL'),
          e('input', {
            name:'publicBaseUrl',
            value: form.publicBaseUrl,
            onChange: onChange,
            placeholder: 'es. http://192.168.1.50:5500/App oppure https://miazienda.it/anima',
            readOnly: !isAdmin
          })
        )
      ),
      e('div', {className:'muted', style:{marginTop:6}},
        'Se impostato, i QR useranno questo host. Utile da smartphone (LAN o dominio pubblico).'
      )
    ),

    // Backup & Ripristino
    e('div', {className:'card'},
      e('h3', null, 'Backup dati'),
      e('div', {className:'row', style:{gap:8, flexWrap:'wrap', alignItems:'center'}},
        e('button', {
          type:'button',
          className:'btn',
          onClick:()=> {
            if (!isAdmin) return; // i worker NON possono scaricare backup
            if (window.exportBackupSmart) return window.exportBackupSmart();
            if (window.downloadBackup)    return window.downloadBackup();
            alert('Funzione di backup non trovata');
          },
          disabled: !isAdmin
        }, '💾 Scarica backup'),

        
        // Indice allegati (JSON) - export/import (MERGE, non wipe)
        e('button', {
          type:'button',
          className:'btn btn-outline',
          onClick:()=> {
            if (!isAdmin) return;
            if (window.exportAllegatiAll) return window.exportAllegatiAll();
            alert('Export indice allegati non disponibile');
          },
          disabled: !isAdmin
        }, '📎 Esporta indice allegati'),

        e('label', {className:'btn btn-outline', htmlFor:'import-allegati-file'}, '📎 Importa indice allegati…'),
        e('input', {
          id:'import-allegati-file',
          type:'file',
          accept:'application/json',
          style:{display:'none'},
          onChange: async (ev) => {
            try{
              if (!isAdmin) { try{ ev.target.value=''; }catch{}; return; }
              const f = ev && ev.target && ev.target.files && ev.target.files[0];
              try{ ev.target.value = ''; }catch{}
              if (!f) return;
              if (window.importAllegatiFromFile) await window.importAllegatiFromFile(f);
              else alert('Import indice allegati non disponibile');
            }catch(e){
              console.error(e);
              alert('Errore import indice allegati: ' + (e && e.message ? e.message : String(e)));
            }
          }
        }),

        // Ripristino da file .json
        e('label', {className:'btn btn-outline', htmlFor:'restore-file'}, '⤴️ Ripristina da file…'),
        e('input', {
          id:'restore-file',
          type:'file',
          accept:'application/json',
          style:{display:'none'},
          onChange: async (ev)=>{
          const f = ev.target.files && ev.target.files[0];
          ev.target.value = '';
            if (!f) return;

                        const ok = window.confirm(
              "ATTENZIONE: questo comando ripristina un backup COMPLETO.\n\n" +
              "- Sostituirà commesse, DDT, fatture, ore, magazzino e anagrafiche con quelle presenti nel file.\n" +
              "- Usalo solo per ripristinare un backup completo, NON come merge tra dispositivi.\n\n" +
              "Vuoi davvero procedere con il ripristino dal file selezionato?"
            );
            if (!ok) {
              console.info('[backup] Ripristino annullato dall\'utente.', {
                fileName: f && f.name,
                ts: new Date().toISOString()
              });
              return;
            }

            console.info('[backup] Ripristino COMPLETO avviato da file.', {
              fileName: f && f.name,
              ts: new Date().toISOString()
            });

            const fnSmart = window.importBackupSmartFromFile;
            const fnLegacy = window.restoreFromFile;

            if (!fnSmart && !fnLegacy){
              alert('Funzione di ripristino non trovata');
              return;
            }

            try {
              if (fnSmart)      await fnSmart(f);     // preferisci sempre lo SMART
              else if (fnLegacy) await fnLegacy(f);  // fallback vecchio
            } catch(e){
              alert('Ripristino fallito: ' + (e && e.message || e));
            }
          }
        })
      ),
      e('div', {className:'muted', style:{marginTop:6}},
        'Salva un file .json con tutti i tuoi dati. Il ripristino sovrascrive le chiavi presenti e ricarica l’app.'
      )
    ),

    // Salva TUTTO
    e('div', {className:'actions'},
      e('button', {className:'btn btn-primary', onClick:save}, '💾 Salva impostazioni')
    )
  );
}
window.ImpostazioniView = ImpostazioniView;


// utilità globali
window.get = window.get || function (k, d) {
  try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : d; }
  catch { return d; }
};

/* ================== DDT (lista, CRUD, stampa, fattura da DDT) ================== */
// === Prefill DDT da Commessa (idempotente) ===
window.buildDDTFromCommessa = window.buildDDTFromCommessa || function buildDDTFromCommessa(c){
  if (!c) return null;

  const righe = Array.isArray(c.righeArticolo) ? c.righeArticolo
             : (Array.isArray(c.righe) ? c.righe : []);

  const rows = (righe.length > 0)
    ? righe.map(r => ({
        commessaRowId: String(r.rowId || r.rowID || ''),
        codice: String(r.codice || r.articoloCodice || ''),
        descrizione: String(r.descrizione || ''),
        um: String(r.um || 'PZ'),
        qta: Math.max(0, Number(r.qta || r.quantita || 0))
      }))
    : [{
        codice: String(c.articoloCodice || ''),
        descrizione: String(c.descrizione || ''),
        um: String(c.um || 'PZ'),
        qta: Math.max(1, Number(c.qtaPezzi || 1))
      }];

  return {
    clienteRagione: String(c.cliente || ''),
    clienteId: c.clienteId || '',
    commessaId: String(c.id || ''),
    note: (c.descrizione || ''),
    articoli: rows
  };
};

  // === Normalizzatore DDT (idempotente) ===
// Accetta sia {cliente} che {clienteRagione}, sia {articoli} che {righe}, ecc.
window.normalizeDDTRecord = window.normalizeDDTRecord || function normalizeDDTRecord(src){
  const S = src || {};
  // data in formato ISO (fallback oggi)
  const todayISO = () => new Date().toISOString().slice(0,10);

  const clienteRagione = String(S.clienteRagione || S.cliente || '').trim();
  const clienteId      = S.clienteId || '';
  const commessaRif    = String(S.commessaRif || S.commessaId || S.__fromCommessaId || '').trim();
  const note           = String(S.note || S.annotazioni || '').trim();
  const data           = (S.data && String(S.data)) || todayISO();

  const rowsSrc = Array.isArray(S.articoli) ? S.articoli
                 : (Array.isArray(S.righe) ? S.righe : []);
  const rows = (rowsSrc || []).map(r => ({
    commessaRowId: String(r.commessaRowId || r.commessaRowID || r.rowId || ''),
    codice: String(r.codice || r.articoloCodice || '').trim(),
    descrizione: String(r.descrizione || '').trim(),
    um: String(r.um || 'PZ').trim(),
    qta: Math.max(0, Number(r.qta || r.quantita || 0))
  })).filter(r => r.codice || r.descrizione || r.qta>0);

  return {
    id: String(S.id || '').trim(),
    data,
    clienteRagione,
    clienteId,
    commessaRif,
    note,
    articoli: rows
  };
};


function DDTView(){
  const e = React.createElement;
  
  // Prefill da hash ?from=C-… (esegue una sola volta al mount)
  React.useEffect(() => {
    // fallback locale se getHashParam non c'è
    const getHashParamLocal = (name) => {
      try {
        const q = (location.hash.split('?')[1] || '');
        return new URLSearchParams(q).get(name) || '';
      } catch { return ''; }
    };

    const from = (typeof window.getHashParam === 'function'
                    ? window.getHashParam('from')
                    : getHashParamLocal('from'));

    if (!from) return;

    // leggi la commessa
    let comm = null;
    try {
      const all = JSON.parse(localStorage.getItem('commesseRows') || '[]') || [];
      comm = all.find(x => String(x.id) === String(from)) || null;
    } catch {}
    if (!comm) return;

    // costruisci il prefill
    const pre = (typeof window.buildDDTFromCommessa === 'function'
                  ? window.buildDDTFromCommessa(comm)
                  : null);
    if (!pre) return;

    // individua lo state setter disponibile (form/draft)
    const setter =
      (typeof setForm  === 'function' && setForm) ||
      (typeof setDraft === 'function' && setDraft) ||
      null;

    if (!setter) return; // non abbiamo un setter disponibile

    // aggiorna lo stato SENZA sovrascrivere campi già valorizzati
    setter(prev => {
      const next = { ...(prev || {}) };

      // righe articoli (nome campo più usato: "articoli"; se il tuo stato usa "righe", scrivo anche lì)
      if (!Array.isArray(next.articoli) || next.articoli.length === 0) next.articoli = pre.articoli;
      if (('righe' in (prev || {})) && (!Array.isArray(next.righe) || next.righe.length === 0)) next.righe = pre.articoli;

      // intestazione
      if (!next.clienteRagione) next.clienteRagione = pre.clienteRagione;
      if (!next.note)           next.note           = pre.note;

      // rif. cliente (normalizzato)
      if (!next.rifCliente) {
        const rawRef = pre.rifCliente || pre.rifClienteTipo || '';
        next.rifCliente = (window.refClienteToText
          ? window.refClienteToText(rawRef)
          : (typeof rawRef === 'string' ? rawRef : String(rawRef||''))
        ).trim();
      }

      // metadata link alla commessa
      if (!next.commessaId) next.commessaId = pre.commessaId;
    next.__fromCommessaId = pre.commessaId;

      return next;
    });
  }, []);

  // piccolo helper debug: stampa lo stato corrente (form o draft) in console
  window.__DEBUG_DDT = function(){
    try {
      // "typeof x !== 'undefined'" evita errori se la variabile non esiste
      const state = (typeof form  !== 'undefined' ? form
                  : typeof draft !== 'undefined' ? draft
                  : null);
      console.log('DDT state:', state);
    } catch(e) { console.warn(e); }
  };

  const readOnly = (
    typeof window.isReadOnlyUser === 'function'
      ? !!window.isReadOnlyUser()
      : !!(window.__USER && window.__USER.role === 'accountant')
  );

  // --- helpers ---
  const todayISO = () => new Date().toISOString().slice(0,10);
  const pad3 = n => String(n).padStart(3,'0');
  // Helpers compat per mantenere righe su tutte le chiavi
    const __getRighe = (f) =>
      Array.isArray(f?.righe)         ? f.righe
    : Array.isArray(f?.righeDDT)      ? f.righeDDT
    : Array.isArray(f?.righeArticolo) ? f.righeArticolo
    : [];
  const __setRighe = (updater) => setForm(prev => {
    const rows = updater(__getRighe(prev));
    const next = { ...prev, righe: rows, righeDDT: rows, righeArticolo: rows };
    return next;
  });
  // Prefill da hash ?from=C-… (una sola volta)
React.useEffect(() => {
  try{
    const from = (window.getHashParam && window.getHashParam('from')) || '';
    if (!from) return;
    const all = JSON.parse(localStorage.getItem('commesseRows')||'[]') || [];
    const c = all.find(x => String(x.id) === String(from));
    if (!c) return;
    const pre = window.buildDDTFromCommessa(c);
    if (!pre) return;

    // prova a settare su 'form' o 'draft' a seconda di come si chiama lo stato
    if (typeof setForm === 'function') {
      setForm(prev => {
        const next = {...(prev||{})};
        if (!next.articoli || !Array.isArray(next.articoli) || !next.articoli.length) next.articoli = pre.articoli;
        if (!next.clienteRagione) next.clienteRagione = pre.clienteRagione;
        if (!next.note) next.note = pre.note;
        next.__fromCommessaId = pre.commessaId;
        return next;
      });
    } else if (typeof setDraft === 'function') {
      setDraft(prev => {
        const next = {...(prev||{})};
        if (!next.articoli || !Array.isArray(next.articoli) || !next.articoli.length) next.articoli = pre.articoli;
        if (!next.clienteRagione) next.clienteRagione = pre.clienteRagione;
        if (!next.note) next.note = pre.note;
        next.__fromCommessaId = pre.commessaId;
        return next;
      });
    }

  }catch(e){ console.warn('DDT prefill error', e); }
}, []); // solo al mount

  // dataset di base
  const app      = React.useMemo(() => lsGet('appSettings', {}) || {}, []);
  const clienti  = React.useMemo(() => lsGet('clientiRows', [])  || [], []);
  const articoli = React.useMemo(() => lsGet('magArticoli', [])  || [], []);

  function findArt(cod){
    const s = String(cod||'').trim();
    return (Array.isArray(articoli)?articoli:[]).find(a => String(a.codice||'').trim() === s);
  }

  // modello vuoto
  const blank = {
    id: '', data: todayISO(),
    clienteId: '', cliente: '',
    commessaRif: '', note: '',
    rifCliente: '',             // n° ordine/DDT cliente (solo a video)
    causaleTrasporto: '',
    luogoConsegna: '',
    vettore: '', firmaVettore: '', firmaDestinatario: '', firmaConducente: '',
    dataOra: '', pesoNetto: '', pesoLordo: '', colli: '', aspetto: '',
    pressioneCollaudoG3: '4,5 bar',   // pressione di prova standard G3
    righe: [] // {codice, descrizione, qta, UM, note}
  };

  // Prefill da URL ?from=C-YYYY-NNN
  let __prefilled = null;
  try{
    const fromId = (window.getHashParam ? window.getHashParam('from') : '') || '';
    if (fromId) {
      const commesse = (function(){ try{ return JSON.parse(localStorage.getItem('commesseRows')||'[]'); }catch{return [];} })();
      const c = commesse.find(x => String(x.id) === String(fromId));
      if (c) {
        const lines = window.prefillDDTFromCommessa(c);
        __prefilled = {
          cliente: c.cliente || '',
          commessaId: c.id,
          ...lines
        };
      }
    }
  } catch {}

  // Prefill da URL ?from=C-YYYY-NNN
  let prefilled = null;
  try{
    const fromId = (window.getHashParam ? window.getHashParam('from') : '') || '';
    if (fromId) {
      const commesse = (function(){ try{ return JSON.parse(localStorage.getItem('commesseRows')||'[]'); }catch{return [];} })();
      const c = commesse.find(x => String(x.id) === String(fromId));
      if (c) {
        const lines = window.prefillDDTFromCommessa(c);
        prefilled = {
          cliente: c.cliente || '',
          commessaId: c.id,
          ...lines
        };
      }
    } 
  } catch {}

  // stato principale
  // stato DDT
  const [rowsDDT, setRowsDDT] = React.useState(()=> lsGet('ddtRows', []));

  // hydrate da server
  React.useEffect(()=>{
    (async ()=>{
      try{
        const s = await window.api.kv.get('ddtRows');
        if (Array.isArray(s)) {
          setRowsDDT(s);
          lsSet('ddtRows', s);
        }
      }catch(e){}
   })();
  },[]);

  // mirror ad ogni modifica
  React.useEffect(()=>{
    lsSet('ddtRows', rowsDDT);
    window.mirrorToServer('ddtRows', rowsDDT);
  },[rowsDDT]);


  const [qDDT, setQDDT]           = React.useState('');
  const [form, setForm]           = React.useState(__prefilled ? { ...blank, ...__prefilled } : blank);
  const [editingId, setEditingId] = React.useState(null);
  const [showForm, setShowForm]   = React.useState(false);
  const [selDDT, setSelDDT]       = React.useState({}); // selezione multipla in lista

    // BLOCCO NUOVO — Stato e helper per ALLEGATI DDT
  const [allegatiRows, setAllegatiRows] = React.useState(() => {
    try {
      if (typeof lsGet === 'function') {
        const v = lsGet('allegatiRows', []);
        return Array.isArray(v) ? v : [];
      }
      const raw = localStorage.getItem('allegatiRows');
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  });

  const [newAllegato, setNewAllegato] = React.useState({
    tipo: 'FOTO_CARICO',
    descrizione: '',
    path: '',
    url: ''
  });

  const [showAllegatoForm, setShowAllegatoForm] = React.useState(false);

  const currentDDTId = React.useMemo(() => {
    const id = form && form.id ? String(form.id) : (editingId ? String(editingId) : '');
    return id || '';
  }, [form, editingId]);

    // Anno DDT per costruire i path NAS (da data o da id tipo DDT-2025-0001)
  function getDDTYear(){
    // 1) Prova da data DDT (form.data)
    try {
      const dStr = form && form.data ? String(form.data) : '';
      if (dStr && /^\d{4}/.test(dStr)) {
        const y = parseInt(dStr.slice(0, 4), 10);
        if (!isNaN(y) && y > 2000 && y < 2100) return y;
      }
    } catch {}
    // 2) Prova da id DDT: DDT-YYYY-NNNN
    try {
      if (currentDDTId) {
        const parts = String(currentDDTId).split('-');
        if (parts.length >= 3) {
          const y2 = parseInt(parts[1], 10);
          if (!isNaN(y2) && y2 > 2000 && y2 < 2100) return y2;
        }
      }
    } catch {}
    // Fallback: anno corrente
    return new Date().getFullYear();
  }

  // Gestione centralizzata delle modifiche al form nuovo allegato DDT
  function handleChangeNewAllegato(field, value){
    setNewAllegato(prev => {
      const base = prev || { tipo:'FOTO_CARICO', descrizione:'', path:'', url:'' };
      let next = { ...base, [field]: value };

      const appSets = window.lsGet('appSettings', {}) || {};
      const basePath = (appSets.docBasePath || 'Z:\\ANIMA_DOC').replace(/\/+$/, ''); 

      if (field === 'tipo') {
        const tipo    = value;
        const hasPath = !!(base.path && String(base.path).trim());
        const hasDesc = !!(base.descrizione && String(base.descrizione).trim());
        const id      = currentDDTId; // Es: DDT-2025-150
        const year    = getDDTYear();

        if (id) {
          if (!hasPath) {
            // FIX: Usiamo direttamente 'id' perché contiene già "DDT-2025-..."
            if (tipo === 'FOTO_CARICO') {
              next.path = `${basePath}\\FOTO_CARICO\\${year}\\${id}\\foto.jpg`;
            } else if (tipo === 'COLLAUDO') {
              next.path = `${basePath}\\COLLAUDI\\${year}\\${id}-G3-collaudo.pdf`;
            } else if (tipo === 'NC_FORN') {
              next.path = `${basePath}\\NC_FORN\\${year}\\${id}-NC.pdf`;
            }
          }
          if (!hasDesc) {
            if (tipo === 'FOTO_CARICO') next.descrizione = `Foto carico ${id}`;
            else if (tipo === 'COLLAUDO') next.descrizione = `Collaudo G3 ${id}`;
            else if (tipo === 'NC_FORN') next.descrizione = `Non Conformità ${id}`;
          }
        }
      }
      return next;
    });
  }
  const allegatiDDT = React.useMemo(() => {
    if (!currentDDTId) return [];
    const arr = Array.isArray(allegatiRows) ? allegatiRows : [];
    return arr.filter(a =>
      a &&
      !a.deletedAt &&
      String(a.entityType || 'DDT').toUpperCase() === 'DDT' &&
      String(a.entityId || '') === currentDDTId
    );
  }, [allegatiRows, currentDDTId]);

  React.useEffect(() => {
    try {
      const arr = Array.isArray(allegatiRows) ? allegatiRows : [];

      // Merge con lo stato corrente in storage per evitare wipe di allegati creati altrove (OF/COMM/altre viste)
      const cur = (typeof lsGet === 'function')
        ? (lsGet('allegatiRows', []) || [])
        : (function(){ try { return JSON.parse(localStorage.getItem('allegatiRows')||'[]')||[]; } catch { return []; } })();

      const merged = (typeof window.mergeById === 'function')
        ? window.mergeById(cur, arr)
        : arr;

      if (typeof window.lsSet === 'function') window.lsSet('allegatiRows', merged);
      else if (typeof lsSet === 'function') lsSet('allegatiRows', merged);

    } catch {}
  }, [allegatiRows]);

  function nextAllegatoId(){
    try {
      if (typeof window.nextIdUnique === 'function') {
        const res = window.nextIdUnique('alg', 'ALG', 'allegatiRows');
        if (res && res.id) return res.id;
      }
    } catch {}
    const year = new Date().getFullYear();
    const prefix = 'ALG-' + year + '-';
    const re = new RegExp('^' + prefix.replace(/-/g, '\\-') + '(\\d{3})$', 'i');
    let max = 0;
    const arr = Array.isArray(allegatiRows) ? allegatiRows : [];
    arr.forEach(a => {
      if (!a || !a.id) return;
      const m = String(a.id).match(re);
      if (!m) return;
      const n = parseInt(m[1] || '0', 10) || 0;
      if (n > max) max = n;
    });
    const next = max + 1;
    return prefix + String(next).padStart(3, '0');
  }

  function resetNewAllegato(){
    setNewAllegato({
      tipo: 'FOTO_CARICO',
      descrizione: '',
      path: '',
      url: ''
    });
  }

  function openNewAllegato(){
    if (!currentDDTId) {
      alert('Per aggiungere allegati è necessario prima salvare il DDT (ID obbligatorio).');
      return;
    }
    resetNewAllegato();
    setShowAllegatoForm(true);
  }

  async function saveNewAllegato(ev){
    if (ev && ev.preventDefault) ev.preventDefault();
    if (!currentDDTId) { alert('Salva prima il DDT.'); return; }

    const fileInput = document.getElementById('smart-uploader-ddt');
    const file = fileInput?.files?.[0];
    
    let finalPath = String(newAllegato.path || '').trim();
    let finalUrl  = String(newAllegato.url || '').trim();
    
    if (file) {
      const year = getDDTYear();
      const tipo = newAllegato.tipo || 'ALTRO';
      const id   = currentDDTId; // Es. DDT-2025-150
      
      let folder = 'ALTRO';
      let newName = file.name; // Default: mantieni nome originale

      // LOGICA DI RINOMINA AUTOMATICA
      if (tipo === 'FOTO_CARICO') {
        folder = 'FOTO_CARICO';
        // Se è una foto, mantieni estensione ma usa nome standard se vuoi, oppure nome originale
        // newName = `foto_carico_${Date.now()}.jpg`; 
      } else if (tipo === 'COLLAUDO') {
        folder = 'COLLAUDI';
        newName = `${id}-G3-collaudo.pdf`; // RINOMINA FORZATA
      } else if (tipo === 'NC_FORN') {
        folder = 'NC_FORN';
        newName = `${id}-NC.pdf`;          // RINOMINA FORZATA
      }

      // Teletrasporto in Z:\ANIMA_DOC\<FOLDER>\<YEAR>\<DDT-ID>\...
      const savedPath = await window.smartSaveFile(
        file, 
        [folder, String(year), id], // Crea sottocartella col nome del DDT
        newName
      );

      if (!savedPath) return; 
      finalPath = savedPath;
    } else {
      if (!finalPath && !finalUrl && !newAllegato.descrizione) {
        alert('Seleziona un file o compila i campi.');
        return;
      }
    }

    const base = {
      id: nextAllegatoId(),
      createdAt: new Date().toISOString(),
      tipo: newAllegato.tipo || 'ALTRO',
      descrizione: String(newAllegato.descrizione || '').trim() || (file ? file.name : 'Allegato'),
      path: finalPath,
      url: finalUrl,
      entityType: 'DDT',
      entityId: currentDDTId,
      deletedAt: null
    };

    setAllegatiRows(prev => [...(Array.isArray(prev)?prev:[]), base]);
    setShowAllegatoForm(false);
    resetNewAllegato();
  }

  function removeAllegato(id){
    if (!id) return;
    if (!confirm('Eliminare questo allegato dal DDT?')) return;
    const nowISO = new Date().toISOString();
    setAllegatiRows(prev => {
      const arr = Array.isArray(prev) ? prev.slice() : [];
      return arr.map(a => {
        if (!a || String(a.id || '') !== String(id)) return a;
        return { ...a, deletedAt: nowISO };
      });
    });
  }

  function openAllegatoUrl(url){
    if (!url) return;
    try { window.open(url, '_blank'); } catch {}
  }

  function copyAllegatoPath(path){
    if (!path) return;
    try {
      if (typeof navigator !== 'undefined' && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(path)
          .catch(() => { window.prompt('Copia il percorso e premi OK', path); });
      } else {
        window.prompt('Copia il percorso e premi OK', path);
      }
    } catch {
      window.prompt('Copia il percorso e premi OK', path);
    }
  }

    // BLOCCO NUOVO — Cliente corrente + flag G3
  const currentCliente = React.useMemo(() => {
    try {
      if (!form || !form.clienteId) return null;
      const list = Array.isArray(clienti) ? clienti : [];
      return list.find(c => String(c.id) === String(form.clienteId)) || null;
    } catch {
      return null;
    }
  }, [clienti, form && form.clienteId]);

  const isG3DDT = React.useMemo(() => {
    const names = [];

    // Dati scritti dentro il DDT
    if (form) {
      if (form.cliente)         names.push(form.cliente);
      if (form.clienteRagione)  names.push(form.clienteRagione);
    }

    // Dati da anagrafica clienti
    if (currentCliente) {
      if (currentCliente.ragione)         names.push(currentCliente.ragione);
      if (currentCliente.ragioneSociale)  names.push(currentCliente.ragioneSociale);
      if (currentCliente.denominazione)   names.push(currentCliente.denominazione);
      if (currentCliente.nome)            names.push(currentCliente.nome);
      if (currentCliente.codiceCliente)   names.push(currentCliente.codiceCliente);
      if (currentCliente.codice)          names.push(currentCliente.codice);
    }

    let isG3 = false;

    for (const raw of names) {
      const sRaw = String(raw || '').trim();
      if (!sRaw) continue;

      const s = sRaw.toLowerCase();
      const normalized = s.replace(/[\s\.]+/g, ' ').trim(); // "G3  S.R.L." -> "g3 srl"

      // casi principali: "g3 srl", "g3 s.r.l.", ecc.
      if (/g3\s*s\.?r\.?l\.?/.test(normalized)) {
        isG3 = true;
        break;
      }

      // fallback ancora più permissivo: contiene "g3" e "srl"
      if (normalized.includes('g3') && normalized.includes('srl')) {
        isG3 = true;
        break;
      }
    }

    return isG3;
  }, [form && (form.cliente || form.clienteRagione), currentCliente]);

  function toggleSel(id){
    setSelDDT(m => ({ ...m, [id]: !m[id] }));
  }

  function toggleSelAll(){
    const allIds = (Array.isArray(filteredDDT) ? filteredDDT : []).map(r => r.id);
    if (!allIds.length) return;

    const allSelected = allIds.every(id => selDDT[id]);
    if (allSelected){
      // deseleziona solo quelli visibili ora
      setSelDDT(m => {
        const copy = { ...m };
        allIds.forEach(id => { delete copy[id]; });
        return copy;
      });
    } else {
      // seleziona tutti quelli visibili ora
      setSelDDT(m => {
        const copy = { ...m };
        allIds.forEach(id => { copy[id] = true; });
        return copy;
      });
    }
  }

  // ====== Bulk "Genera fattura…" da più DDT ======
  const [bulkFaOpen, setBulkFaOpen] = React.useState(false);
  const [bulkCliId, setBulkCliId]   = React.useState('');
  const [bulkPick, setBulkPick]     = React.useState({}); // { [ddtId]: true }

  function openBulkFa(){
    setBulkFaOpen(true);
    setBulkCliId('');
    setBulkPick({});
  }
  function togglePick(id){
    setBulkPick(p => ({ ...p, [id]: !p[id] }));
  }

  const ddtForCli = React.useMemo(()=>{
    if (!bulkCliId) return [];
    return (rowsDDT || [])
      .filter(r =>
        r &&
        !r.deletedAt &&                            // 👈 escludo gli eliminati
        !(r.annullato === true || String(r.stato || '') === 'Annullato') && // escludo annullati
        String(r.clienteId || '') === String(bulkCliId) &&
        !r.__fatturato
      )
      .sort((a,b)=>{
        const ma = String(a.id||'').match(/^DDT-(\d{4})-(\d{3})$/);
        const mb = String(b.id||'').match(/^DDT-(\d{4})-(\d{3})$/);
        if (ma && mb){
          if (+mb[1] !== +ma[1]) return +mb[1] - +ma[1];
          if (+mb[2] !== +ma[2]) return +mb[2] - +ma[2];
        }
        return String(b.id||'').localeCompare(String(a.id||''));
      });
  }, [rowsDDT, bulkCliId]);

  // Mappa conteggio allegati per DDT (entityType='DDT', !deletedAt)
  const allegatiCountByDDTId = React.useMemo(() => {
    const map = {};
    try {
      const all = Array.isArray(allegatiRows) ? allegatiRows : [];
      all.forEach(r => {
        if (!r || r.deletedAt) return;
        // Considero default 'DDT' anche se entityType è vuoto (legacy)
        const et = String(r.entityType || 'DDT').toUpperCase();
        if (et !== 'DDT') return;
        // Chiave normalizzata: entityId o id, trim + lowercase
        const k = String(r.entityId || r.id || '').trim().toLowerCase();
        if (!k) return;
        map[k] = (map[k] || 0) + 1;
      });
    } catch {
      // ignora errori, mappa vuota
    }
    return map;
  }, [allegatiRows]);

  function confirmBulkFa(){
    const selIds = Object.keys(bulkPick).filter(id => bulkPick[id]);
    if (!selIds.length){ alert('Seleziona almeno un DDT'); return; }

    const sel = (rowsDDT||[]).filter(d => selIds.includes(d.id));
    const clientiSet = new Set(sel.map(d => String(d.clienteId||'')));
    if (clientiSet.size > 1){ alert('Seleziona DDT dello stesso cliente'); return; }

    const ddt0 = sel[0];

        // righe flatten da più DDT con riferimento DDT (ddtId / ddtData) in ogni riga
    const cliDet = (clienti||[]).find(c => String(c.id)===String(ddt0.clienteId)) || null;
    const ivaDef = (cliDet && cliDet.aliquotaIva !== undefined && cliDet.aliquotaIva !== null && cliDet.aliquotaIva !== '')
      ? Number(cliDet.aliquotaIva)
      : (Number(app.defaultIva) || 22);

    const righe = sel.flatMap(d => (d.righe||[]).map(r => ({
      codice: r.codice || '',
      descrizione: r.descrizione || r.codice || '',
      qta: r.qta || '',
      UM: r.UM || r.um || 'PZ',
      prezzo: (r.prezzo ?? ''),
      sconto: '',
      iva: ivaDef,
      ddtId: d.id || '',
      ddtData: d.data || ''
    })));
    const pf = {
      data: todayISO(),
      clienteId: ddt0.clienteId || '',
      cliente: ddt0.cliente || '',
      pagamento: app.defaultPagamento || '30 gg data fattura',
      esigibilitaIVA: '', // 'I' (immediata), 'D' (differita), 'S' (scissione)
      iban: app.iban || '',
      plafond: !!(cliDet && cliDet.plafond),
      naturaIva: (cliDet && cliDet.naturaIva) || '',
      causale: '',
      note: '',
      righe,
      __fromDDTs: sel.map(d => d.id)
    };

    try { localStorage.setItem('prefillFattura', JSON.stringify(pf)); } catch {}
    setBulkFaOpen(false);
    if (window.setTab) window.setTab('Fatture');
    location.hash = '#/fatture';
  }

    // prefill da altre viste (forza UM maiuscolo se arriva "um")
  React.useEffect(()=>{
    try{
      const raw = localStorage.getItem('prefillDDT');
      if (!raw) return;
      localStorage.removeItem('prefillDDT');
      const pf = JSON.parse(raw);

      // --- NORMALIZZA RIF. CLIENTE (evita [object Object]) ---
      let rifTxt = '';
      if (pf && typeof pf.rifCliente === 'object' && pf.rifCliente !== null) {
        const o = pf.rifCliente || {};
        rifTxt = [
          o.tipo || pf.rifClienteTipo,
          o.numero || o.num || pf.rifClienteNum,
          o.data || pf.rifClienteData
        ].filter(Boolean).join(' ');
      } else {
        rifTxt = String(pf.rifCliente || '').trim();
        if (!rifTxt) {
          rifTxt = [
            pf.rifClienteTipo,
            pf.rifClienteNum,
            pf.rifClienteData
          ].filter(Boolean).join(' ');
        }
      }

      const righe = Array.isArray(pf?.righe) ? pf.righe.map(r => ({
        ...r,
        UM: r.UM || r.um || 'PZ'
      })) : [];

      setForm({ ...blank, ...(pf||{}), rifCliente: rifTxt, righe });
      setEditingId(null);
      setShowForm(true);
    }catch{}
  },[]);

  // --- handlers form ---
  function onChange(ev){
    const {name, value} = ev.target;
    setForm(p => ({ ...p, [name]: value }));
  }
  function onSelCliente(id){
    const c = (Array.isArray(clienti)?clienti:[]).find(x => String(x.id)===String(id)) || null;
    setForm(p => ({
      ...p,
      clienteId: id,
      cliente: c ? (c.ragione || c.ragioneSociale || '') : '',
      luogoConsegna: c ? (c.sedeOperativa || p.luogoConsegna || '') : (p.luogoConsegna || '')
    }));
  }

    // righe
  function addRiga(){
    setForm(p => ({
      ...p,
      righe: [
        ...(p.righe||[]),
        { codice:'', descrizione:'', qta:'', UM:'PZ', prezzo:'', note:'' }
      ]
    }));
  }

  function updRiga(i, patch){
  setForm(p => {
    const arts = (window.lsGet ? window.lsGet('magArticoli', []) : []);
    const righe = (p.righe||[]).map((r,ix)=>{
      if(ix !== i) return r;

      let next = { ...r, ...patch };

      if (Object.prototype.hasOwnProperty.call(patch,'codice')) {
        const cod = String(patch.codice||'').trim();
        const a = arts.find(x => String(x.codice||x.id||'').trim() === cod) || null;

        if (a) {
          if (!next.descrizione) next.descrizione = a.descrizione || a.descr || '';
          const um = String(next.UM||next.um||a.um||a.UM||'PZ').toUpperCase();
          next.UM = um; next.um = um;
          if (next.prezzo == null || next.prezzo === '' || Number(next.prezzo) === 0) {
            next.prezzo = Number(a.prezzo ?? a.costo ?? 0) || 0;
          }
        }
      }

      if (Object.prototype.hasOwnProperty.call(patch,'UM') || Object.prototype.hasOwnProperty.call(patch,'um')) {
        const um = String(next.UM||next.um||'PZ').toUpperCase();
        next.UM = um; next.um = um;
      }

      return next;
    });

    return { ...p, righe };
  });
}

  function remRiga(i){
    setForm(p => ({ ...p, righe: (p.righe||[]).filter((_,ix)=> ix!==i) }));
  }

 // CRUD
async function openNew(){
  // ID robusto: DDT-YYYY-NNN (Impostazioni + counters + LS + server)
  const idObj = (typeof window.nextIdFor === 'function')
        ? await window.nextIdFor({ prefix:'DDT', storageKey:'ddtRows', seriesKey:'DDT', width:3 })
    : (function(){
        const y = new Date().getFullYear();
        const pad = n => String(n).padStart(3,'0');
        let all = [];
        try { all = JSON.parse(localStorage.getItem('ddtRows')||'[]')||[]; } catch {}
        const n = 1 + all.filter(r => String(r.id||'').startsWith(`DDT-${y}-`)).length;
        return { id:`DDT-${y}-${pad(n)}`, year:y, num:n };
      })();

  const today = new Date().toISOString().slice(0,10);
  const now   = new Date().toISOString();
  setForm({ ...blank, id:idObj.id, data: today, __createdAt: now, updatedAt: now, righe: [] });
  setEditingId(null);
  setShowForm(true);
}

function openEdit(id){
  const x = (rowsDDT || []).find(r => String(r.id) === String(id));
  if (!x) return;

  const righe = Array.isArray(x.righe) ? x.righe : [];

  setForm({
    ...blank,
    ...x,
    righe
  });

  setEditingId(id);
  setShowForm(true);
}

  // 👇 Soft delete: marca deletedAt/updatedAt senza rimuovere il record
async function delRec(id){
    if (!confirm('Eliminare DDT?')) return;

    // Leggi tutti i DDT correnti
    let all = [];
    try {
      all = JSON.parse(localStorage.getItem('ddtRows') || '[]') || [];
    } catch {
      all = [];
    }

    const nowISO = new Date().toISOString();

    // Marca il DDT come eliminato
    const next = (Array.isArray(all) ? all : []).map(r => {
      if (!r || String(r.id) !== String(id)) return r;
      const clone = { ...r };
      clone.deletedAt = nowISO;
      clone.updatedAt = nowISO;
      return clone;
    });

    // Salva subito in localStorage
    try {
      localStorage.setItem('ddtRows', JSON.stringify(next));
    } catch {}

    // Aggiorna lo stato React
    setRowsDDT(next);

    // Sync su cloud/KV (best effort)
    try {
      if (window.syncExportToCloudOnly) {
        window.syncExportToCloudOnly(['ddtRows']);
      }
      if (window.persistKV) {
        await window.persistKV('ddtRows', next);
      }
      if (window.api?.kv?.set) {
        await window.api.kv.set('ddtRows', next);
      }
    } catch (e) {
      console.warn('[DDT] sync eliminazione fallita', e);
    }

    try {
      alert('DDT eliminato ✅');
    } catch {}
  }

  async function delRecMany(ids){
    const toDel = Array.isArray(ids)
      ? ids.map(String).filter(Boolean)
      : [];
    if (!toDel.length){
      try { alert('Seleziona almeno un DDT'); } catch {}
      return;
    }

    if (!confirm(`Eliminare ${toDel.length} DDT selezionati?`)) return;

    // Leggi tutti i DDT correnti
    let all = [];
    try {
      all = JSON.parse(localStorage.getItem('ddtRows') || '[]') || [];
    } catch {
      all = [];
    }

    const nowISO = new Date().toISOString();

    // Marca come eliminati tutti quelli selezionati
    const next = (Array.isArray(all) ? all : []).map(r => {
      if (!r || !toDel.includes(String(r.id))) return r;
      const clone = { ...r };
      clone.deletedAt = nowISO;
      clone.updatedAt = nowISO;
      return clone;
    });

    // Salva subito in localStorage
    try {
      localStorage.setItem('ddtRows', JSON.stringify(next));
    } catch {}

    // Aggiorna lo stato React
    setRowsDDT(next);

    // Sync su cloud/KV (best effort)
    try {
      if (window.syncExportToCloudOnly) {
        window.syncExportToCloudOnly(['ddtRows']);
      }
      if (window.persistKV) {
        await window.persistKV('ddtRows', next);
      }
      if (window.api?.kv?.set) {
        await window.api.kv.set('ddtRows', next);
      }
    } catch (e) {
      console.warn('[DDT] sync eliminazione multipla fallita', e);
    }

    try {
      alert(`Eliminati ${toDel.length} DDT ✅`);
    } catch {}

    // Pulisce la selezione dopo l'eliminazione
    setSelDDT({});
  }

  // --- SALVA (DDT) ---
  async function save(ev){
    ev && ev.preventDefault();

    // 1) Assicura un ID DDT valido (DDT-YYYY-NNN)
    let curId = String(form.id || '').trim();
    const badId =
      !curId ||                                 // vuoto
      curId.toUpperCase().includes('NAN') ||    // conteneva NaN
      !curId.startsWith('DDT-');                // non inizia con DDT-

    if (badId) {
      let newId = null;

      // 1.a) Prova a usare il generatore unificato legato ai contatori (Impostazioni → DDT)
      if (typeof window.nextIdFor === 'function') {
        try {
          const obj = await window.nextIdFor({
            prefix:     'DDT',
            storageKey: 'ddtRows',
            seriesKey:  'DDT',   // stessa chiave che usi in "Numerazione documenti (DDT)"
            width:      3
          });
          if (obj && obj.id) newId = obj.id;
        } catch {}
      }

      // 1.b) Fallback locale se nextIdFor non esiste o fallisce
      if (!newId) {
        const y   = new Date().getFullYear();
        const pad = n => String(n).padStart(3,'0');
        let all   = [];
        try { all = JSON.parse(localStorage.getItem('ddtRows') || '[]') || []; } catch {}
        const n = 1 + (all.filter(r => String(r.id||'').startsWith(`DDT-${y}-`)).length || 0);
        newId = `DDT-${y}-${pad(n)}`;
      }

      curId = newId;
    }

    // 2) Validazioni base
    if (!form.clienteId && !form.cliente){
      alert('Seleziona un cliente'); 
      return;
    }

    const righeValide = (form.righe||[]).filter(r => {
      const hasText = String(r.codice||'').trim() || String(r.descrizione||'').trim();
      const qty = Number(r.qta||0);
      return !!hasText && Number.isFinite(qty) && qty>0;
    });
    if (!righeValide.length){
      alert('Aggiungi almeno una riga valida (codice/descrizione e quantità > 0)');
      return;
    }

    const rec = {
      ...form,
      id: curId,
      righe: righeValide,
      colli: form.colli || righeValide.length,
      updatedAt: new Date().toISOString()
    };

    // 3) Scrivi in LS (write-through)
    let all = [];
    try { all = JSON.parse(localStorage.getItem('ddtRows')||'[]')||[]; } catch {}
    const ix = all.findIndex(r => String(r.id) === String(rec.id));
    if (ix>=0) all[ix]=rec; else all.push(rec);
    try { localStorage.setItem('ddtRows', JSON.stringify(all)); } catch {}

    // 4) Aggiorna UI
    setRowsDDT(all);
    setShowForm(false);
    setEditingId(rec.id);

    // 5) Sync cloud (non crashare se offline)
    try {
      if (window.syncExportToCloudOnly) window.syncExportToCloudOnly(['ddtRows']);
      if (window.persistKV) await window.persistKV('ddtRows', all);
      if (window.api?.kv?.set) await window.api.kv.set('ddtRows', all);
    } catch {}

    alert('DDT salvato ✅');
  }

  // fattura singola da DDT
  function faiFatturaDaDDT (ddt) {

    // Se il DDT è annullato o eliminato, blocca il flusso
    if (ddt && (ddt.deletedAt || ddt.annullato === true || String(ddt.stato || '') === 'Annullato')) {
      alert(
        'Questo DDT risulta annullato/eliminato.\n' +
        'Non è possibile generare una fattura da questo documento.'
      );
      return;
    }

    // Se il DDT risulta già fatturato, blocca il flusso
    if (ddt && ddt.__fatturato) {
      alert(
        'Questo DDT risulta già fatturato.\n' +
        'Non è possibile generare una nuova fattura da questo documento.'
      );
      return;
    }
    const cli        = clienti.find(c => c.id === (ddt.clienteId || '')) || null;
    const defaultIva = Number(app.defaultIva) || 22;
    const isPlafond  = !!(cli && cli.plafond);

    const pf = {
      data: todayISO(),
      clienteId: ddt.clienteId || '',
      cliente: ddt.cliente || '',
      pagamento: app.defaultPagamento || '30 gg data fattura',
      iban: app.iban || '',
      codiceUnivoco: (cli && cli.codiceUnivoco) || '',
      pec: (cli && cli.pec) || '',
      note: (ddt.note || ''), // niente "Rif. DDT..." nelle note
      righe: (
        Array.isArray(ddt.righe) && ddt.righe.length
          ? ddt.righe
          : (ddt.articoli || [])
      ).map(r => {
        const codiceRiga = String(
          r.codice ||
          r.articoloCodice ||
          r.codiceArticolo ||
          r.codArticolo ||
          ''
        ).trim();

        const qtaRiga    = r.qta || r.quantita || '';
        const umRiga     = r.UM || r.um || 'PZ';
        const prezzoRiga = (r.prezzo ?? '');
        const ivaRiga    =
          (cli && cli.aliquotaIva !== undefined && cli.aliquotaIva !== null && cli.aliquotaIva !== '')
            ? Number(cli.aliquotaIva)
            : defaultIva;

        return {
          codice: codiceRiga,
          descrizione: r.descrizione || codiceRiga,
          qta: qtaRiga,
          UM: umRiga,
          // prendo il prezzo dal DDT se presente
          prezzo: prezzoRiga,
          sconto: '',
          iva: ivaRiga,
          ddtId: ddt.id || '',
          ddtData: ddt.data || ''
        };
      }),
      plafond: isPlafond,
      naturaIva: (cli && cli.naturaIva) || (isPlafond ? 'N3.5 Plafond' : '')
    };

    try { localStorage.setItem('prefillFattura', JSON.stringify(pf)); } catch {}
    if (window.setTab) window.setTab('Fatture');
    else location.hash = '#/fatture';
  }

  // ricerca + ordinamento
const filteredDDT = (Array.isArray(rowsDDT) ? rowsDDT : [])
      .filter(r => r && !r.deletedAt)
      .filter(r => {
        const hay =
          String(r.id || '') + ' ' +
          String(r.cliente || r.clienteRagione || '') + ' ' +
          String(r.note || '') + ' ' +
          String(r.commessaRif || '') + ' ' +
          String(r.rifCliente || '');
        const term = String(qDDT || '').toLowerCase();
        return hay.toLowerCase().includes(term);
      })
      .sort((a, b) => {
        const ma = String(a.id || '').match(/^DDT-(\d{4})-(\d{3})$/);
        const mb = String(b.id || '').match(/^DDT-(\d{4})-(\d{3})$/);
        if (ma && mb) {
          if (+mb[1] !== +ma[1]) return +mb[1] - +ma[1];
          if (+mb[2] !== +ma[2]) return +mb[2] - +ma[2];
        }
        const ta = (Date.parse(b.updatedAt || b.__CreatedAt || b.__createdAt || 0) -
                    Date.parse(a.updatedAt || a.__CreatedAt || a.__createdAt || 0));
        if (ta !== 0 && isFinite(ta)) return ta;
        return String(b.id || '').localeCompare(String(a.id || ''));
      });

  // ===== Modale multi-fattura (definito PRIMA del return) =====
  const modalMultiFa = bulkFaOpen ? e('div', {
    style:{
      position:'fixed', inset:0, background:'rgba(0,0,0,.35)',
      display:'flex', alignItems:'center', justifyContent:'center',
      zIndex: 9999
    },
    onClick: (ev)=>{ if (ev.target === ev.currentTarget) setBulkFaOpen(false); }
  },
    e('div', {
      className:'card',
      style:{ width:760, maxWidth:'95vw', maxHeight:'90vh', overflow:'auto' },
      onClick:(ev)=>ev.stopPropagation()
    },
      e('h3', null, 'Genera fattura da DDT'),

      // Selettore cliente
      e('div', { className:'form', style:{gridTemplateColumns:'repeat(auto-fit,minmax(260px,1fr))'} },
        e('div', null,
          e('label', null, 'Cliente'),
          (clienti && clienti.length)
            ? e('select', {
                value: bulkCliId || '',
                onChange: ev => { setBulkCliId(ev.target.value); setBulkPick({}); }
              },
                e('option', {value:''}, '— seleziona —'),
                ...(clienti).map(c =>
                  e('option', { key:c.id, value:c.id },
                    String(c.ragione || c.ragioneSociale || c.denominazione || c.nome || c.id)
                  )
                )
              )
            : e('a', { className:'btn btn-outline', href:'#/clienti' }, 'Crea cliente…')
        )
      ),

      // Elenco DDT del cliente selezionato
      (bulkCliId
        ? e('div', { className:'card', style:{ marginTop:8, overflowX:'auto' } },
            e('table', { className:'table' },
              e('thead', null,
                e('tr', null,
                  e('th', {style:{width:32}}, ''),
                  e('th', {style:{width:140}}, 'DDT'),
                  e('th', null, 'Data'),
                  e('th', null, 'Note'),
                  e('th', {style:{width:80}}, 'Righe')
                )
              ),
              e('tbody', null,
                ddtForCli.map(r => e('tr', { key:r.id },
                  e('td', { className:'ctr' },
                    e('input', {
                      type:'checkbox',
                      checked: !!bulkPick[r.id],
                      onChange: () => togglePick(r.id)
                    })
                  ),
                  e('td', null,
                    (allegatiCountByDDTId &&
                     allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()])
                      ? `📎 ${r.id}`
                      : r.id
                  ),
                  e('td', null, r.data || ''),
                  e('td', null,
                    r.note || '',
                    (allegatiCountByDDTId &&
                     allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()])
                      ? ` (allegati: ${allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()]})`
                      : ''
                  ),
                  e('td', { className:'ctr' }, String((r.righe||[]).length))
                ))
              )
            )
          )
        : e('div', { className:'muted', style:{marginTop:8} },
            'Seleziona un cliente per vedere i DDT disponibili.'
          )
      ),

      // Azioni
      e('div', { className:'actions', style:{ justifyContent:'flex-end', marginTop:10 } },
        e('button', { className:'btn btn-outline', onClick: ()=> setBulkFaOpen(false) }, 'Annulla'),
        e('button', { className:'btn', onClick: confirmBulkFa,...(window.roProps ? window.roProps() : {})}, 'Conferma')
      )
    )
  ) : null;

  // --- render ---
  return e('div', { className:'page' },

    // toolbar
    e('div', { className:'actions', style:{marginBottom:8} },
      e('input', {
        className:'input',
        placeholder:'Cerca…',
        value:qDDT,
        onChange:ev=>setQDDT(ev.target.value)
      }),
      e('button', {
        className:'btn',
        onClick:openNew,
        ...window.roProps()
      }, '➕ Nuovo DDT'),
      e('button', {
        className:'btn btn-outline',
        onClick: openBulkFa,
        ...window.roProps()
      }, '🧾 Genera fattura…'),
      e('button', {
        className:'btn btn-outline',
        onClick: () => {
          const ids = Object.keys(selDDT).filter(id => selDDT[id]);
          delRecMany(ids);
        },
        ...window.roProps()
      }, '🗑 Elimina selezionati')
    ),

    // lista
    e('div', { className:'card', style:{overflowX:'auto'} },
      e('table', { className:'table' },
        e('thead', null,
          e('tr', null,
            e('th', {style:{width:32}},
              e('input', {
                type:'checkbox',
                checked: filteredDDT.length > 0 && filteredDDT.every(r => selDDT[r.id]),
                onChange: toggleSelAll
              })
            ),
            e('th', {style:{width:130}}, 'DDT'),
            e('th', null, 'Data'),
            e('th', null, 'Cliente'),
            e('th', null, 'Note'),
            e('th', {style:{width:260}}, 'Azioni')
          )
        ),
        e('tbody', null,
          filteredDDT.map(r => e('tr', { key:r.id },
            e('td', { className:'ctr' },
              e('input', {
                type:'checkbox',
                checked: !!selDDT[r.id],
                onChange: () => toggleSel(r.id)
              })
            ),
            e('td', null,
              (allegatiCountByDDTId &&
               allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()])
                ? `📎 ${r.id}`
                : r.id
            ),
            e('td', null, r.data || ''),
            e('td', null, r.cliente || r.clienteRagione || ''),
            e('td', null,
              r.note || '',
              (allegatiCountByDDTId &&
               allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()])
                ? ` (allegati: ${allegatiCountByDDTId[String(r.id || '').trim().toLowerCase()]})`
                : ''
            ),
            e('td', null,
                e('button', { className:'btn btn-outline',
                onClick:()=>openEdit(r.id),
                ...window.roProps(),
                title: readOnly ? 'Sola lettura' : ''
              }, '✏️ Modifica'), ' ',
              e('button', { className:'btn btn-outline', onClick: () => window.printDDT && window.printDDT(r) }, 'Stampa'), ' ',
              e('button', { className:'btn btn-outline',
                onClick:()=>faiFatturaDaDDT(r),
                ...window.roProps(),
                title: readOnly ? 'Sola lettura' : ''
              }, '→ Fattura'), ' ',
              e('button', { className:'btn btn-outline',
                onClick:()=>delRec(r.id),
                ...window.roProps('Solo admin può eliminare')
              }, '🗑')
            )
          ))
        )
      )
    ),

    // form (con sola-lettura)
showForm && e('form', { className:'card', onSubmit:save, style:{marginTop:8,padding:12} },
      e('h3', null, editingId
        ? `Modifica ${form.id}`
        : (form.id ? `Nuovo DDT ${form.id}` : 'Nuovo DDT')
      ),

  // TUTTI I CAMPI BLOCCATI IN SOLA LETTURA
  e('fieldset', { disabled: readOnly },

        // metadati
    e('div', {
      className:'form',
      style:{
        gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))',
        gap:12
      }
    },
      // titolo sezione
      e('div',{className:'form-group-title', style:{gridColumn:'1 / -1'}}, 'Dati DDT'),

      e('div', null,
        e('label', null, 'Data'),
        e('input', {
          type:'date',
          name:'data',
          value:form.data,
          onChange:onChange
        })
      ),
      e('div', null,
        e('label', null, 'Cliente'),
        (clienti && clienti.length)
          ? e('select', {
              value:form.clienteId,
              onChange:ev=>onSelCliente(ev.target.value)
            },
              e('option', {value:''}, '— seleziona —'),
              ...(clienti||[]).map(c =>
                e('option', { key:c.id, value:c.id },
                  String(c.ragione||c.ragioneSociale||'')
                )
              )
            )
          : e('a', { className:'btn btn-outline', href:'#/clienti' }, 'Crea cliente…')
      ),

      // seconda sezione
      e('div',{className:'form-group-title', style:{gridColumn:'1 / -1', marginTop:4}}, 'Trasporto e riferimenti'),

      e('div', { style:{gridColumn:'1/-1'} },
        e('label', null, 'Luogo di consegna'),
        e('input', {
          name:'luogoConsegna',
          value:form.luogoConsegna,
          onChange:onChange
        })
      ),
      e('div', { style:{gridColumn:'1/-1'} },
        e('label', null, 'Causale del trasporto (facoltativa)'),
        e('input', {
          name:'causaleTrasporto',
          value:form.causaleTrasporto,
          onChange:onChange
        })
      ),
      e('div', null,
        e('label', null, 'Commessa (rif.)'),
        e('input', {
          name:'commessaRif',
          value:form.commessaRif,
          onChange:onChange
        })
      ),
      e('div', null,
        e('label', null, 'Rif. cliente (ordine/DDT)'),
        e('input', {
          name:'rifCliente',
          value:form.rifCliente,
          onChange:onChange
        })
      ),
      e('div', { style:{gridColumn:'1/-1'} },
        e('label', null, 'Note'),
        e('textarea', {
          name:'note',
          value:form.note,
          onChange:onChange
        })
      )
    ),

        ),

        // righe
    e('div', { className:'card', style:{marginTop:8,overflowX:'auto'} },
      e('table', { className:'table' },
        e('thead', null,
          e('tr', null,
            e('th', {style:{width:32}}, '#'),
            e('th', {style:{width:150}}, 'Articolo'),
            e('th', null, 'Descrizione'),
            e('th', {style:{width:80}}, 'Q.tà'),
            e('th', {style:{width:60}}, 'UM'),
            e('th', {style:{width:90}}, 'Prezzo'),
            e('th', null, 'Note'),
            e('th', {style:{width:60}}, '')
          )
        ),
        e('tbody', null,
          (form.righe||[]).map((r,i)=> e('tr',{key:i},
            e('td', {style:{textAlign:'center'}}, String(i+1)),
            e('td', null,
              e('input', {
                list:'art-list',
                value:r.codice||'',
                onChange: ev => {
                  const cod = ev.target.value;
                  const a = findArt(cod);
                  if (a) updRiga(i, { codice:a.codice, descrizione:a.descrizione||'', UM:a.um||r.UM||'PZ' });
                  else   updRiga(i, { codice:cod });
                }
              })
            ),
            e('td', null,
              e('input', {
                value:r.descrizione||'',
                onChange:ev=>updRiga(i,{descrizione:ev.target.value})
              })
            ),
                        e('td', {style:{textAlign:'center'}},
              e('input', {
                type:'number',
                step:'any',
                value:r.qta||'',
                onChange:ev=>updRiga(i,{qta:ev.target.value})
              })
            ),
            e('td', {style:{textAlign:'center'}},
              e('input', {
                value:r.UM||'PZ',
                onChange:ev=>updRiga(i,{UM:ev.target.value})
              })
            ),
            e('td', {style:{textAlign:'right'}},
              e('input', {
                type:'number',
                step:'any',
                value:r.prezzo||'',
                onChange:ev=>updRiga(i,{prezzo:ev.target.value})
              })
            ),
            e('td', null,
              e('input', {
                value:r.note||'',
                onChange:ev=>updRiga(i,{note:ev.target.value})
              })
            ),
            e('td', {style:{textAlign:'center'}},
              e('button', {
                type:'button',
                className:'btn btn-outline',
                onClick:()=>remRiga(i)
              }, '🗑')
            )
          ))
        )
      ),
      e('div', { className:'actions', style:{justifyContent:'flex-end'} },
        e('button', {
          type:'button',
          className:'btn btn-outline',
          onClick:addRiga
        }, '➕ Aggiungi riga')
      )
    ),


        // footer gestionale
    e('div', { className:'card', style:{marginTop:8} },
      e('div', { className:'form', style:{gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))'} },
        e('div', null,
          e('label', null, 'Vettore'),
          e('input', { name:'vettore', value:form.vettore, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Aspetto beni'),
          e('input', { name:'aspetto', value:form.aspetto, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Colli'),
          e('input', { name:'colli', value:form.colli, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Data/ora'),
          e('input', { name:'dataOra', value:form.dataOra, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Peso netto'),
          e('input', { name:'pesoNetto', value:form.pesoNetto, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Peso lordo'),
          e('input', { name:'pesoLordo', value:form.pesoLordo, onChange:onChange })
        ),
        // BLOCCO NUOVO — Pressione di prova collaudo G3
        e('div', null,
          e('label', null, 'Pressione di prova (collaudo G3)'),
          e('input', {
            name:'pressioneCollaudoG3',
            value: form.pressionecollaudoG3 || form.pressionecollaudoG3 === '' 
              ? form.pressionecollaudoG3 
              : (form.pressioneCollaudoG3 || '4,5 bar'),
            onChange:onChange,
            placeholder:'es. 4,5 bar'
          })
        ),
        e('div', null,
          e('label', null, 'Firma vettore'),
          e('input', { name:'firmaVettore', value:form.firmaVettore, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Firma conducente'),
          e('input', { name:'firmaConducente', value:form.firmaConducente, onChange:onChange })
        ),
        e('div', null,
          e('label', null, 'Firma destinatario'),
          e('input', { name:'firmaDestinatario', value:form.firmaDestinatario, onChange:onChange })
        )
      )
    ),

        // BLOCCO NUOVO — Card Allegati collegati al DDT
    e('div', { className:'card', style:{marginTop:8} },
      e('h3', null, 'Allegati'),
      !currentDDTId && e('div', { className:'muted', style:{marginBottom:8} },
        'Per aggiungere allegati è necessario prima salvare il DDT (ID obbligatorio).'
      ),
      currentDDTId && e('div', { className:'actions', style:{justifyContent:'flex-end',gap:8,marginBottom:8} },
        (function(){
          const base = {
            type:'button',
            className:'btn btn-outline',
            onClick: openNewAllegato,
            disabled: !currentDDTId
          };
          const ro = window.roProps ? window.roProps() : null;
          return e('button', ro ? { ...base, ...ro, disabled: ro.disabled || !currentDDTId } : base, '➕ Aggiungi allegato');
        })()
      ),
      e('div', { style:{overflowX:'auto'} },
        e('table', { className:'table' },
          e('thead', null,
            e('tr', null,
              e('th', null, 'Tipo'),
              e('th', null, 'Descrizione'),
              e('th', null, 'Path'),
              e('th', null, 'Azioni')
            )
          ),
          e('tbody', null,
            (!allegatiDDT || !allegatiDDT.length)
              ? e('tr', null,
                  e('td', { colSpan:4, className:'muted' },
                    currentDDTId
                      ? 'Nessun allegato collegato a questo DDT.'
                      : 'Nessun allegato (DDT non ancora salvato).'
                  )
                )
              : allegatiDDT.map(a =>
                  e('tr', { key: a.id || a.createdAt },
                    e('td', null, String(a.tipo || '')),
                    e('td', null, String(a.descrizione || '')),
                    e('td', null,
                      e('code', { style:{ fontSize:11, whiteSpace:'nowrap' } },
                        String(a.path || '')
                      )
                    ),
                    e('td', null,
                      a.url && /^https?:\/\//i.test(String(a.url||'')) && e('button', {
                        type:'button',
                        className:'btn btn-outline',
                        onClick: ()=> openAllegatoUrl(a.url),
                        style:{marginRight:4}
                      }, 'Apri'),
                      e('button', {
                        type:'button',
                        className:'btn btn-outline',
                        onClick: ()=> copyAllegatoPath(a.path),
                        style:{marginRight:4}
                      }, 'Copia percorso'),
                      (function(){
                        const base = {
                          type:'button',
                          className:'btn btn-outline',
                          onClick: ()=> removeAllegato(a.id)
                        };
                        const ro = window.roProps ? window.roProps() : null;
                        return e('button', ro ? { ...base, ...ro } : base, '🗑');
                      })()
                    )
                  )
                )
          )
        )
      ),
      showAllegatoForm && currentDDTId && e('div', { className:'card', style:{marginTop:8,padding:12, border:'2px dashed #0ea5e9'} },
        e('h4', {style:{marginTop:0, color:'#0ea5e9'}}, 'Nuovo Allegato Smart'),
        e('div', { className:'form', style:{gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))'} },
          e('div', null,
            e('label', null, 'Tipo Documento'),
            e('select', {
              value: newAllegato.tipo,
              onChange: ev => handleChangeNewAllegato('tipo', ev.target.value)
            },
              ['FOTO_CARICO','COLLAUDO','NC_FORN','DISEGNO','ALTRO'].map(t => e('option', { key:t, value:t }, t))
            )
          ),
          e('div', {style:{gridColumn:'1 / -1'}},
            e('label', null, 'Descrizione'),
            e('input', {
              value: newAllegato.descrizione || '',
              onChange: ev => handleChangeNewAllegato('descrizione', ev.target.value),
              placeholder: 'Opzionale (se vuoto usa nome file)'
            })
          ),
          
          // PULSANTE SMART
          e('div', {style:{gridColumn:'1 / -1', background:'#f0f9ff', padding:10, borderRadius:6}},
            e('label', {style:{fontWeight:'bold', display:'block', marginBottom:4}}, '📂 Seleziona file da salvare su Z:'),
            e('input', {
              id: 'smart-uploader-ddt',
              type: 'file',
              style: {width:'100%'}
            }),
            e('div', {className:'muted', style:{fontSize:11, marginTop:4}}, 
              'Il file verrà copiato automaticamente in Z:\\ANIMA_DOC\\' + (newAllegato.tipo||'ALTRO') + '\\' + getDDTYear() + '\\' + currentDDTId
            )
          ),

          // Fallback manuale (nascosto o piccolo)
          e('details', {style:{gridColumn:'1 / -1', marginTop:4}},
            e('summary', {className:'muted', style:{cursor:'pointer', fontSize:11}}, 'Opzioni manuali (URL / Path esistente)'),
            e('div', {className:'grid grid-2', style:{marginTop:4}},
               e('input', {placeholder:'Path manuale...', value:newAllegato.path||'', onChange:ev=>handleChangeNewAllegato('path',ev.target.value)}),
               e('input', {placeholder:'URL web...', value:newAllegato.url||'', onChange:ev=>handleChangeNewAllegato('url',ev.target.value)})
            )
          )
        ),
        e('div', { className:'actions', style:{justifyContent:'flex-end',gap:8,marginTop:12} },
          e('button', { type:'button', className:'btn btn-outline', onClick: ()=>{ setShowAllegatoForm(false); resetNewAllegato(); } }, 'Annulla'),
          e('button', { type:'button', className:'btn btn-primary', onClick: saveNewAllegato }, '💾 Salva e Carica')
        )
      )
    ),

    // azioni (fuori dal fieldset)
    e('div', { className:'actions', style:{justifyContent:'flex-end',gap:8} },
      e('button', {
        type:'button',
        className:'btn btn-outline',
        onClick:()=>{ setShowForm(false); setEditingId(null); }
      }, 'Annulla'),

      e('button', {
        type:'button',
        className:'btn btn-outline',
        onClick:()=>{ try{
          if (window.printDDT) window.printDDT(form);
          else {
            const html = window.renderDDTHTML ? window.renderDDTHTML(form) : '';
            if (html) {
              (window.safePrintHTMLStringWithPageNum
                ? window.safePrintHTMLStringWithPageNum(html)
                : window.safePrintHTMLString(html)
              );
            } else alert('renderDDTHTML non disponibile');
          }
        }catch(e){ alert('Errore stampa DDT'); console.error(e); } }
      }, 'Stampa'),

            // BLOCCO NUOVO — Schede collaudo G3 (solo per cliente G3 e se ci sono righe)
      (isG3DDT && (__getRighe(form) || []).length > 0) && e('button', {
        type:'button',
        className:'btn btn-outline',
        onClick:()=>{ try{
          if (window.printSchedeCollaudoG3ForDDT) {
            window.printSchedeCollaudoG3ForDDT(form);
          } else {
            alert('Funzione schede collaudo G3 non disponibile');
          }
        } catch(e) {
          alert('Errore durante la preparazione delle schede collaudo G3');
          console.error(e);
        } }
      }, 'Schede collaudo G3'),

      e('button', {
        type:'button',
        className:'btn btn-outline',
        onClick:()=>{ try{
          window.openRicezioneOF && window.openRicezioneOF(form);
        } catch(e){ alert('Ricezione non disponibile: '+(e?.message||e)); } },
        ...(window.roProps ? window.roProps() : {})
      }, 'Ricevi…'),

      e('button', {
        type:'button',
        className:'btn btn-outline',
        onClick:()=>{ try{
         window.receiveAllOF && window.receiveAllOF(form);
        } catch(e){ alert('Ricezione non disponibile'); } },
        ...(window.roProps ? window.roProps() : {})
      }, 'Ricevi tutto'),

      e('button', {
        type:'submit',
        className:'btn',
        ...(window.roProps ? window.roProps() : {})
      }, 'Salva')
    )),

      // datalist articoli
  e('datalist', { id:'art-list' },
    ...(Array.isArray(articoli)?articoli:[]).map(a =>
      e('option', {
        key:String(a.codice||a.id||Math.random()),
        value:String(a.codice||'')
      }, String(a.descrizione||''))
    )
  ),

  // Modale multi-fattura
  modalMultiFa
);
}

window.DDTView = DDTView;
window.ROUTES = window.ROUTES || {};
window.ROUTES['#/ddt'] = window.DDTView;

//* ==== GLOBAL DDT PRINT (render + print) ================================== */
;(function(){
  // Evita doppie definizioni ma NON saltare dopo il mount
  if (window.renderDDTHTML && window.safePrintHTMLString && window.printDDT) return;

  // stampa sicura in iframe (idempotente)
  if (!window.safePrintHTMLString) {
    window.safePrintHTMLString = function (html) {
      try{
        const ifr = document.createElement('iframe');
        ifr.style.width = ifr.style.height = '0';
        ifr.style.border = '0';
        document.body.appendChild(ifr);
        const d = ifr.contentWindow.document;
        d.open(); d.write(html); d.close();
        setTimeout(()=>{ try{ ifr.contentWindow && ifr.contentWindow.print(); }catch{} 
          setTimeout(()=>{ try{ ifr.remove(); }catch{} }, 300);
        },150);
      }catch(e){ console.warn('safePrintHTMLString error', e); }
    };
  }
    // Wrapper con fallback numerazione (idempotente)
    // === OVERRIDE NUMERAZIONE — VERSIONE UNICA ===
window.safePrintHTMLStringWithPageNum = function(html){
  try{
    const ifr = document.createElement('iframe');
    ifr.style.cssText = 'position:fixed;right:0;bottom:0;width:0;height:0;border:0;visibility:hidden';
    document.body.appendChild(ifr);

    const w = ifr.contentWindow, d = w.document;
    d.open(); d.write(String(html||'')); d.close();

    const run = () => {
      try{
        // DEDUPE pagebox nel documento figlio
        try{
          const boxes = Array.from(d.querySelectorAll('.pagebox'));
          if (boxes.length > 1) {
            const keep = d.querySelector('#pagebox') || boxes[0];
            boxes.forEach(el => { if (el !== keep) el.remove(); });
          }
        }catch{}

        // Neutralizza qualsiasi ::after che stampi solo " / "
        const kill = d.createElement('style');
        kill.textContent = '.pageNum::after,.pageX::after{content:"" !important}';
        d.head.appendChild(kill);

        // Leggi i margini reali da @page { margin: ... } (1/2/3/4 valori)
        let topMm = 16, bottomMm = 22;
        try{
          const cssText = Array.from(d.querySelectorAll('style')).map(s => s.textContent || '').join('\n');
          const m = /@page\s*{[^}]*margin\s*:\s*([0-9.]+)mm(?:\s+([0-9.]+)mm(?:\s+([0-9.]+)mm(?:\s+([0-9.]+)mm)?)?)?/i.exec(cssText);
          if (m){
            const v = [m[1],m[2],m[3],m[4]].filter(Boolean).map(parseFloat);
            if (v.length === 1){ topMm = bottomMm = v[0]; }
            else if (v.length === 2){ topMm = bottomMm = v[0]; }   // top/bottom = 1° valore
            else if (v.length === 3){ topMm = v[0]; bottomMm = v[2]; }
            else if (v.length >= 4){ topMm = v[0]; bottomMm = v[2]; }
          }
        }catch{}

        // mm → px
        const mmToPx = (() => {
          const t = d.createElement('div');
          t.style.height='100mm'; t.style.position='absolute'; t.style.visibility='hidden';
          d.body.appendChild(t);
          const px = t.getBoundingClientRect().height || 0;
          t.remove(); return px/100;
        })();

        const pageHeightMm = 297 - (topMm + bottomMm);
        const pageHeightPx = (mmToPx>0) ? (mmToPx * pageHeightMm) : (w.innerHeight || 1123);

        // Misura SOLO il contenuto (hai già il wrapper .content nella Fattura)
        const content = d.querySelector('.content') || d.body;
        const h = Math.max(content.scrollHeight, content.offsetHeight, d.body.scrollHeight);

        // Totale con tolleranza anti “falso 2”
        let total = Math.max(1, Math.ceil(h / pageHeightPx));
        const overPx = h - pageHeightPx;

        if (total === 2) {
          const snapPx = Math.max(140, pageHeightPx * 0.18); // ~18% o 140px
          if (overPx <= snapPx) total = 1;
        }
        if (total === 2) {
          const lastTr = d.querySelector('table tbody tr:last-child');
          if (lastTr) {
            const r = lastTr.getBoundingClientRect();
            if (r && (r.bottom + 16) < pageHeightPx) total = 1;
          }
        }

        // Scrivi SEMPRE il testo su .pageNum (markup Fattura)
        const pn = d.querySelector('#pagebox .pageNum') || d.querySelector('.pageNum');
        if (pn){ pn.removeAttribute('data-mode'); pn.textContent = `1 / ${total}`; }

      } finally {
        try { w.focus(); w.print(); } catch {}
        setTimeout(()=>{ try{ ifr.remove(); }catch{} }, 300);
      }
    };

        // Attendi immagini/logo per misurazioni stabili
    const imgs = Array.from(d.images || []);
    if (imgs.length === 0) {
      setTimeout(run, 120);
    } else {
      let done = 0;
      const tick = () => { if (++done >= imgs.length) run(); };

      imgs.forEach(im => {
        if (im.complete) tick();
        else {
          im.addEventListener('load', tick, { once:true });
          im.addEventListener('error', tick, { once:true });
        }
      });

      // fallback nel caso qualche immagine non emetta load/error
      setTimeout(run, 1600);
    }

    w.addEventListener?.('afterprint', () => { try{ ifr.remove(); }catch{} });
  }catch(e){
    console.warn('safePrintHTMLStringWithPageNum error', e);
    if (window.safePrintHTMLString) window.safePrintHTMLString(html);
  }
};


  // HTML della stampa DDT (idempotente)
  if (!window.renderDDTHTML) {
// ===== HTML stampa DDT (Versione COMPLETA + Layout Basso + FIX ERRORE PAGES) =====
window.renderDDTHTML = function(ddt){
  const esc = v => String(v ?? '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));

  // Config azienda
  let cfg = {};
  try { cfg = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch {}
  const logoUrl  = cfg.logoDataUrl || cfg.logoUrl || cfg.logo || '';
  const ragAzi   = esc(
    cfg.ragioneSociale || cfg.ragione || cfg.ragioneAzienda ||
    cfg.companyName ||
    (cfg.azienda && (cfg.azienda.ragione || cfg.azienda.ragioneSociale)) || ''
  );
  const pivaAzi  = esc(
    cfg.piva || cfg.partitaIva || cfg.companyVat ||
    (cfg.azienda && (cfg.azienda.piva || cfg.azienda.partitaIva)) || ''
  );
  const sedeLeg  = esc(
    cfg.sedeLegale || cfg.companyLegal || (cfg.azienda && cfg.azienda.sedeLegale) || ''
  );
  const sedeOp   = esc(
    cfg.sedeOperativa || (cfg.azienda && cfg.azienda.sedeOperativa) || ''
  );
  const telAzi   = esc(cfg.telefono || cfg.phone || (cfg.azienda && (cfg.azienda.telefono || cfg.azienda.phone)) || '');
  const emailAzi = esc(cfg.email || (cfg.azienda && cfg.azienda.email) || '');
  const pecAzi   = esc(cfg.pec   || (cfg.azienda && cfg.azienda.pec)   || '');

  // Cliente
  const cliRag   = esc(ddt?.cliente || ddt?.clienteRagione || '');
  const cliPiva  = esc(ddt?.clientePiva || '');

  // Luogo di consegna (evita duplicati col cliente)
  const lcRaw    = String(ddt?.luogoConsegna||'').trim();
  const luogoTxt = (!lcRaw || lcRaw.toLowerCase() === String(ddt?.cliente||'').trim().toLowerCase()) ? '' : esc(lcRaw);

  // Riferimento cliente (usa util globale se c'è)
  let rifClienteTxt = '';
  try{
    const ref = ddt?.rifCliente || {
      tipo  : ddt?.rifClienteTipo || '',
      numero: ddt?.rifClienteNum  || '',
      data  : ddt?.rifClienteData || ''
    };
    if (typeof window.refClienteToText === 'function') {
      rifClienteTxt = window.refClienteToText(ref);
    } else {
      const t = String(ref?.tipo||'').toUpperCase();
      const n = String(ref?.numero||'');
      const ds= String(ref?.data||'');
      rifClienteTxt = [t, n && ('n. '+n), ds && ('del '+ds)].filter(Boolean).join(' ');
    }
  }catch{}

  // Righe
  const righe = Array.isArray(ddt?.righe) ? ddt.righe : (Array.isArray(ddt?.articoli) ? ddt.articoli : []);
  const hasNote = (righe||[]).some(r => r && r.note);

  // Footer (trasporto)
  const vettore   = esc(ddt?.vettore || '');
  const aspetto   = esc(ddt?.aspetto || ddt?.aspettoBeni || '');
  const colli     = esc(ddt?.colli || '');
  const dataOra   = esc(ddt?.dataOra || '');
  const pesoNetto = esc(ddt?.pesoNetto || '');
  const pesoLordo = esc(ddt?.pesoLordo || '');

  const firmaVettoreHtml      = esc(ddt?.firmaVettore||'');
  const firmaConducenteHtml   = esc(ddt?.firmaConducente||'');
  const firmaDestinatarioHtml = esc(ddt?.firmaDestinatario||'');
  
  // --- LAYOUT CSS: Uso margini a 0 per controllare il fondo pagina ---
  let css = window.__PRINT_CSS({ top:10, right:12, bottom:0, left:12 }); // bottom: 0 per forzare il controllo

  css += `
  <style>
    /* Forzatura Margini Stampa: 5mm in fondo sono il minimo per la maggior parte delle stampanti */
    @page { margin-bottom: 5mm; margin-left: 12mm; margin-right: 12mm; margin-top: 10mm; }

    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      font-size:12px; color:#0f172a;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }

    /* HEADER */
    .header{
      position:relative;
      height:auto;
      border-bottom:2px solid #111; padding:6px 0;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      background:#fff;
    }
    .header .logo{
      height:80px; /* Logo più grande come richiesto */
      max-height:80px; 
      object-fit:contain; 
      margin-left:2mm
    }
    .header .tit{ text-align:right; padding-top:4mm }
    .header .docTitle{ font-size:20px; font-weight:800; margin:0 }
    .header .muted{ color:#64748b }

    /* FOOTER: Fissato in basso all'area di stampa */
    .footer{
      position: absolute;
      left: 10mm; 
      right: 10mm;
      bottom: 5mm; /* 5mm dal bordo inferiore del foglio */
      height: 48mm; /* Altezza fissa per griglia + firme */
      border-top: 1px solid #cbd5e1;
      padding-top: 4px;
      background: #fff;
    }
    .footer .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px
    }
    .footer .box{
      border:1px solid #e5e7eb;
      padding:6px;
      border-radius:6px;
      font-size:11px
    }
    /* Numeratore in basso a destra */
    .footer .pagebox{
      position: static;
      margin-top: 6px; 
      margin-left: auto; 
      font-weight: 700;
      text-align: right;
    }
    .footer .pagebox .pageNumDDT{
      display:inline-block;
      min-width:38px;
      text-align:right;
    }

    /* Layout verticale */
    .page{
      /* Altezza minima forzata per spingere il footer in basso (297mm - 12mm - 12mm) */
      display:flex;
      flex-direction:column;
      min-height:273mm; 
      page-break-after: always; 
    }
    .page:last-child{ page-break-after: auto; }

    .content{
      flex:1;
      margin:4mm 0 4mm 0;
    }

    .muted{color:#64748b}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .box{border:1px solid #cbd5e1;border-radius:8px;padding:8px}
    .lbl{font-weight:600;margin-bottom:4px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead{display:table-header-group}
    th,td{border:1px solid #e5e7eb;padding:6px;vertical-align:top}
    th{background:#f8fafc}
    .ctr{text-align:center}.right{text-align:right}
  </style>`;
  
  // --- HTML HEADER (Con DOCUMENTO DI TRASPORTO) ---
  const header = `
    <div class="header">
      <div style="display:flex;gap:12px;align-items:center">
        ${logoUrl ? `<img class="logo" src="${logoUrl}">` : ``}
        <div style="font-size:10px">
          <div class="doc" style="font-weight:700">${ragAzi}</div>
          ${pivaAzi ? `<div class="muted">P.IVA: ${pivaAzi}</div>` : ``}
          ${sedeLeg ? `<div class="muted">Sede legale: ${sedeLeg}</div>` : ``}
          ${sedeOp  ? `<div class="muted">Sede operativa: ${sedeOp}</div>` : ``}
          ${telAzi   ? `<div class="muted">Tel: ${telAzi}</div>`   : ``}
          ${emailAzi ? `<div class="muted">Email: ${emailAzi}</div>` : ``}
          ${pecAzi   ? `<div class="muted">PEC: ${pecAzi}</div>`   : ``}
        </div>
      </div>
      <div class="tit">
        <div class="docTitle">DOCUMENTO DI TRASPORTO</div>
        <div class="muted">N. <b>${esc(ddt?.id||'')}</b></div>
        <div class="muted">Data: <b>${esc(ddt?.data||'')}</b></div>
      </div>
    </div>`;

  // --- HTML MITTENTE/DESTINATARIO (Con tutti i dati mittente) ---
  const mittDest = `
    <div class="grid2">
      <div class="box">
        <div class="lbl">Mittente</div>
        <div><b>${ragAzi}</b></div>
        ${pivaAzi ? `<div class="muted">P.IVA: ${pivaAzi}</div>` : ``}
        ${sedeLeg ? `<div class="muted">S. Legale: ${sedeLeg}</div>` : ``}
        ${sedeOp  ? `<div class="muted">S. Operativa: ${sedeOp}</div>` : ``}
      </div>
      <div class="box">
        <div class="lbl">Destinatario</div>
        <div><b>${cliRag || '—'}</b></div>
        ${cliPiva ? `<div class="muted">P.IVA: ${cliPiva}</div>` : ``}
        ${luogoTxt ? `<div class="muted">Luogo di consegna: ${luogoTxt}</div>` : ``}
        ${rifClienteTxt ? `<div class="muted" style="margin-top:4px">Rif. doc. cliente: ${rifClienteTxt}</div>` : ``}
        ${ddt?.commessaRif ? `<div class="muted">Commessa: ${esc(ddt.commessaRif)}</div>` : ``}
      </div>
    </div>`;

  const causale = (ddt?.causaleTrasporto)
    ? `<div class="box" style="margin-top:8px">Causale del trasporto: <b>${esc(ddt.causaleTrasporto)}</b></div>`
    : ``;

  // --- CALCOLO PAGINAZIONE (FIXED) ---
  const rows = (righe && righe.length) ? righe : [{}];
  
  // Riduco leggermente le righe per pagina per evitare sovrapposizioni col footer
  const ROWS_PER_PAGE = hasNote ? 10 : 14;
  
  const pages = []; // <--- ORA È DEFINITA PRIMA DI ESSERE USATA!
  for (let i = 0; i < rows.length; i += ROWS_PER_PAGE) {
    pages.push({ start: i, rows: rows.slice(i, i + ROWS_PER_PAGE) });
  }
  if (!pages.length) pages.push({ start: 0, rows: [{}] });

  const totalPages = pages.length;

  const tableHeadHTML = `
    <table>
      <thead><tr>
        <th class="ctr" style="width:30px">#</th>
        <th style="width:130px">Codice</th>
        <th>Descrizione</th>
        <th class="ctr" style="width:50px">UM</th>
        <th class="ctr" style="width:60px">Q.tà</th>
        ${hasNote ? `<th style="width:150px">Note</th>` : ``}
      </tr></thead>`;

  const pagesHTML = pages.map((p, pageIdx) => {
    const bodyRowsHTML = (p.rows).map((r, i) => `
      <tr>
        <td class="ctr">${p.start + i + 1}</td>
        <td>${esc(r.codice || r.articoloCodice || '')}</td>
        <td>${esc(r.descrizione || '')}</td>
        <td class="ctr">${esc(r.UM || r.um || '')}</td>
        <td class="ctr"><b>${r.qta ?? r.quantita ?? ''}</b></td>
        ${hasNote ? `<td>${esc(r.note||'')}</td>` : ``}
      </tr>
    `).join('');

    const tabellaPagina = `
      ${tableHeadHTML}
      <tbody>${bodyRowsHTML}</tbody>
    </table>`;

    const footerPagina = `
      <div class="footer">
        <div class="grid">
          <div class="box"><div class="lbl">Vettore</div>${vettore}</div>
          <div class="box"><div class="lbl">Aspetto</div>${aspetto}</div>
          <div class="box"><div class="lbl">Colli</div>${colli}</div>
          <div class="box"><div class="lbl">Data/Ora</div>${dataOra}</div>
          <div class="box"><div class="lbl">Peso Netto</div>${pesoNetto}</div>
          <div class="box"><div class="lbl">Peso Lordo</div>${pesoLordo}</div>
        </div>

        <div class="grid firme" style="margin-top:6px; display:grid; grid-template-columns:repeat(3,1fr); gap:6px">
          <div class="box" style="min-height:40px">
            Firma vettore:
            <div style="margin-top:6px; font-weight:700">${firmaVettoreHtml}</div>
          </div>
          <div class="box" style="min-height:40px">
            Firma conducente:
            <div style="margin-top:6px; font-weight:700">${firmaConducenteHtml}</div>
          </div>
          <div class="box" style="min-height:40px">
            Firma destinatario:
            <div style="margin-top:6px; font-weight:700">${firmaDestinatarioHtml}</div>
          </div>
        </div>

        <div class="pagebox">Pag. <span class="pageNumDDT">${pageIdx+1} / ${totalPages}</span></div>
      </div>
    `;

    return `
    <div class="page">
      <div class="content">
        ${header}
        ${mittDest}
        ${causale}
        ${tabellaPagina}
      </div>
      ${footerPagina}
    </div>`;
  }).join('');

  return `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>${pagesHTML}</body></html>`;
};

// ===== Stampa DDT con fallback numerazione pagina =====
window.printDDT = function(state){
try {
    // 1) Sorgente dati
    let ddt = state;
    if (!ddt && typeof window.__DEBUG_DDT === 'function') {
      try { ddt = window.__DEBUG_DDT(); } catch (e) {}
    }
    if (!ddt || Object.keys(ddt || {}).length === 0) {
      alert('Nessun DDT da stampare.');
      return;
    }

    // 2) HTML
    const html = window.renderDDTHTML(ddt);

    // 3) Stampa Intelligente (Iframe prioritario, Popup solo come fallback)
    if (window.safePrintHTMLStringWithPageNum) {
      window.safePrintHTMLStringWithPageNum(html);
    } else if (window.safePrintHTMLString) {
      window.safePrintHTMLString(html);
    } else {
      // Metodo Fallback Popup
      const w = window.open('', '_blank');
      if (w) {
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        setTimeout(function() {
          try { w.print(); } catch (e) { console.warn(e); }
        }, 500);
      } else {
        alert('Popup bloccato. Consenti i popup per stampare.');
      }
    }
  } catch (e) {
    console.error('printDDT error', e);
    alert('Errore durante la stampa DDT');
  }
};
  }
})();

/* ================== RENDER SCHEDA COLLAUDO G3 (Fix Immagini & Layout) ================== */
window.renderSchedaCollaudoG3HTML = function(ddt, righeOverride){
    const esc = v => String(v ?? '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));

    // Righe articolo
    const righe = Array.isArray(righeOverride) && righeOverride.length
      ? righeOverride
      : (
          Array.isArray(ddt?.righe) ? ddt.righe :
          Array.isArray(ddt?.righeDDT) ? ddt.righeDDT :
          Array.isArray(ddt?.righeArticolo) ? ddt.righeArticolo :
          []
        );
    const righeOk = righe.filter(r => r && (r.codice || r.descrizione));
    if (!righeOk.length) return '';

    // Config Azienda (Fornitore)
    let cfg = {};
    try { cfg = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch {}
    const ragAzi = esc(cfg.ragioneSociale || 'ANIMA SRL');
    const pivaAzi = esc(cfg.piva || '');
    
    // Dati DDT
    const ddtNum  = esc(ddt && ddt.id ? String(ddt.id) : '');
    let ddtDataTxt = '';
    try {
      if (ddt && ddt.data) {
        const d = new Date(ddt.data);
        ddtDataTxt = isNaN(d.getTime()) ? String(ddt.data) : d.toLocaleDateString('it-IT');
      }
    } catch { ddtDataTxt = esc(ddt?.data || ''); }

    const pressioneProva = esc(ddt?.pressioneCollaudoG3 || ddt?.pressioneProvaG3 || '4,5 bar');

    // --- FIX IMMAGINI ---
    // Calcola percorso assoluto per evitare che la stampa perda le immagini
    function getAbsoluteUrl(relativePath) {
      try {
        let base = window.location.href.split('#')[0];
        base = base.replace(/\/?[^\/]+\.[^\/]+$/, ''); // via index.html
        if (!base.endsWith('/')) base += '/';
        return base + relativePath;
      } catch (e) { return relativePath; }
    }

    // Assicurati che i file esistano in cartella "icons"
    const logoG3Url = getAbsoluteUrl('icons/g3-logo.png');
    const timbroUrl = getAbsoluteUrl('icons/anima-timbro-firma.png');

    // HTML Immagini con fallback (se non trova l'immagine mostra un testo rosso o un box vuoto)
    const logoSegment = `<img src="${logoG3Url}" class="logo-g3-img" alt="G3" onError="this.style.display='none'; document.getElementById('g3-fallback').style.display='block'" />
                         <div id="g3-fallback" class="g3-main" style="display:none; font-size:20px; font-weight:bold;">G3 srl</div>`;

    const timbroSegment = `<img src="${timbroUrl}" class="timbro-firma-img" alt="Timbro" onError="this.style.display='none'; document.getElementById('err-timbro').style.display='flex';" />
                           <div id="err-timbro" class="timbro-firma-fallback" style="display:none;">TIMBRO E FIRMA ANIMA SRL<br><span style="font-size:9px; color:red">(Img non trovata)</span></div>`;

    // Testi fissi normativi
    const norm1 = 'Con la presente dichiariamo che il prodotto è stato fabbricato e collaudato ed è conforme alle specifiche tecniche richieste. Il prodotto può essere immesso nel mercato secondo le seguenti normative:';
    const norm2 = '• PED (Direttiva Attrezzature a pressione 2014/68/UE) - Articolo 4 Paragrafo 3. Il prodotto non deve recare la marcatura CE.';
    const norm3 = 'Il documento dovrà essere allegato al DDT di spedizione.';
    const g3Ind = 'Via della Fornace, 11 – 31023 Resana (TV) – ITALY';
    const g3Tel = 'Tel. +39 0423 783720 – www.g3sistemi.com – info@g3sistemi.com';
    const g3NoteIt = 'La riproduzione o distribuzione di questi documenti, l’uso o diffusione non autorizzata del loro contenuto è proibita senza autorizzazione scritta della società stessa.';
    const g3NoteEn = 'The reproduction or distribution of these documents, the use or unauthorized disclosure of their contents is prohibited without the written authorization of the company itself.';

    const sheetsHtml = righeOk.map((riga, idx) => {
      const pageBase = idx * 2;
      const totP = righeOk.length * 2;
      const cod = esc(riga.codice || '');
      const desc = esc(riga.descrizione || '');

      return `
      <div class="page">
        <div class="top-header">
          <div class="logo-g3">${logoSegment}</div>
        </div>

        <table class="tbl fornitore">
          <tr><td class="lbl">FORNITORE:</td><td class="val">${ragAzi} ${pivaAzi ? '- P.IVA '+pivaAzi : ''}</td></tr>
        </table>

        <table class="tbl blocco">
          <tr><td class="lbl"></td><td class="val titolo-blocco">DATI PRODOTTO</td></tr>
          <tr><td class="lbl">CODICE PRODOTTO:</td><td class="val">${cod}</td></tr>
          <tr><td class="lbl">DESCRIZIONE PRODOTTO:</td><td class="val">${desc}</td></tr>
        </table>

        <table class="tbl blocco">
          <tr><td class="lbl"></td><td class="val titolo-blocco">DATI TECNICI COLLAUDO</td></tr>
          <tr><td class="lbl">FLUIDO DI PROVA:</td><td class="val">ARIA COMPRESSA</td></tr>
          <tr><td class="lbl">PRESSIONE DI PROVA:</td><td class="val">${pressioneProva}</td></tr>
          <tr><td class="lbl">DURATA DELLA PROVA:</td><td class="val">2 minuti</td></tr>
          <tr><td class="lbl">VERIFICA:</td><td class="val">CONTROLLO VISIVO CON IMMERSIONE</td></tr>
        </table>

        <table class="tbl operatori">
          <tr><td colspan="2" class="titolo-blocco center">OPERATORE CHE HA ESEGUITO IL TEST</td></tr>
          <tr><td class="lbl">INIZIALI (NOME / COGNOME):</td><td class="val underline">N.M.</td></tr>
          <tr><td class="lbl">DATA COLLAUDO:</td><td class="val">${ddtDataTxt}</td></tr>
          <tr><td class="lbl">ESITO:</td><td class="val">☑ POSITIVO &nbsp; ☐ NEGATIVO</td></tr>
        </table>

        <table class="tbl ddt-ref">
          <tr><td class="lbl">DDT RIFERIMENTO:</td><td class="val">${ddtNum}</td></tr>
        </table>

        <div class="timbro-label">
          Timbro e Firma del legale rappresentante o responsabile incaricato
        </div>
        <div class="timbro-box">
          ${timbroSegment}
        </div>

        <div class="page-footer">
          SCHEDA COLLAUDO FORNITORE&nbsp;&nbsp;&nbsp;MOD_0003 R00 24/03/2023&nbsp;&nbsp;&nbsp;PAG ${pageBase+1} | ${totP}
        </div>
      </div>

      <div class="page">
        <div class="title-block second">
          <div class="title-main">SCHEDA COLLAUDO FORNITORE</div>
          <div class="title-sub">MOD_0003 R00 24/03/2023</div>
        </div>

        <div style="margin-top:20mm; line-height:1.5; padding:0 5mm">
          <p>${norm1}</p>
          <p>${norm2}</p>
          <p><b>${norm3}</b></p>
        </div>

        <div class="g3-footer">
          <div><b>G3 srl</b></div>
          <div>${g3Ind}</div>
          <div>${g3Tel}</div>
        </div>

        <div style="margin-top:10mm">
          <p class="small">${g3NoteIt}</p>
          <p class="small">${g3NoteEn}</p>
        </div>

        <div class="page-footer">
          SCHEDA COLLAUDO FORNITORE&nbsp;&nbsp;&nbsp;MOD_0003 R00 24/03/2023&nbsp;&nbsp;&nbsp;PAG ${pageBase+2} | ${totP}
        </div>
      </div>`;
    }).join('\n');

    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Collaudo G3</title>
    <style>
      @page { size: A4; margin: 0; }
      * { box-sizing: border-box; }
      body { font-family: Arial, Helvetica, sans-serif; font-size: 10pt; margin: 0; padding: 0; color:#000; }
      .page { width: 210mm; height: 297mm; position: relative; page-break-after: always; padding: 15mm; }
      .page:last-child { page-break-after: auto; }
      
      .top-header { margin-bottom: 8mm; }
      .logo-g3-img { height: 16mm; width: auto; display: block; }
      
      .tbl { width: 100%; border-collapse: collapse; margin-bottom: 4mm; font-size: 10pt; }
      .tbl td { border: 1px solid #000; padding: 2mm; vertical-align: middle; }
      .lbl { font-weight: bold; width: 38%; background-color: #fff; } /* Bianco o grigio chiaro */
      .val { width: auto; }
      
      .titolo-blocco { background-color: #e0e0e0; font-weight: bold; text-align: center; text-transform: uppercase; }
      .center { text-align: center; }
      .underline { border-bottom: 1px solid #000; display: inline-block; min-width: 30mm; }

      .timbro-label { margin-top: 5mm; font-size: 9pt; margin-bottom: 2mm; }
      .timbro-box { 
        height: 35mm; border: 1px solid #000; display: flex; 
        align-items: center; justify-content: center; position: relative; 
      }
      .timbro-firma-img { max-height: 30mm; max-width: 90%; object-fit: contain; z-index: 10; }
      .timbro-firma-fallback { 
        position: absolute; inset: 0; display: flex; flex-direction: column;
        align-items: center; justify-content: center; 
        text-align: center; opacity: 0.3; font-weight: bold; font-size: 14pt; 
      }

      .title-block { text-align: right; }
      .title-block.second { text-align: center; margin-bottom: 10mm; }
      .title-main { font-size: 13pt; font-weight: bold; text-transform: uppercase; }
      .title-sub { font-size: 9pt; margin-top: 1mm; }

      .g3-footer { margin-top: 25mm; font-size: 10pt; line-height: 1.4; padding-left: 5mm; }
      .small { font-size: 7.5pt; color: #444; margin-bottom: 2mm; }
      
      .page-footer { 
        position: absolute; bottom: 8mm; right: 10mm; left: 10mm; 
        text-align: right; font-size: 8.5pt; font-weight: normal; 
      }
    </style></head><body>${sheetsHtml}</body></html>`;
};

/* ================== STAMPA SCHEDE COLLAUDO G3 (SMART Z:) ================== */
if (!window.printSchedeCollaudoG3ForDDT) {
  window.__G3_CACHE = window.__G3_CACHE || { logo: null, timbro: null };

  window.printSchedeCollaudoG3ForDDT = async function(ddt){
    try{
      if (!ddt) { alert('DDT non valido.'); return; }

      // 1. Trova le righe valide
      const allRows = (
        Array.isArray(ddt?.righe) ? ddt.righe :
        Array.isArray(ddt?.righeDDT) ? ddt.righeDDT :
        Array.isArray(ddt?.righeArticolo) ? ddt.righeArticolo :
        []
      ).filter(r => r && (r.codice || r.descrizione));

      if (!allRows.length) { alert('Nessuna riga articolo.'); return; }

      // 2. Chiedi quali stampare
      let rowsToPrint = allRows;
      if (allRows.length > 1) {
        const elenco = allRows.map((r, idx) => `${idx+1}) ${r.codice||''} - ${r.descrizione||''}`).join('\n');
        const ansRaw = window.prompt('Quali righe stampare?\n\n' + elenco + '\n\nDigita il numero (es. 1) oppure "T" per tutte.', 'T');
        if (ansRaw === null) return;
        const ans = String(ansRaw).trim().toUpperCase();
        if (ans && ans !== 'T' && ans !== 'ALL') {
          const n = parseInt(ans, 10);
          if (!isNaN(n) && n >= 1 && n <= allRows.length) rowsToPrint = [allRows[n - 1]];
          else { alert('Selezione non valida.'); return; }
        }
      }

      // 3. Preparazione SMART su Z: (Crea cartelle e calcola percorso)
      let suggestedPath = '';
      let targetFolderHandle = null;
      const year = (function(){
        try { if (ddt.data) return new Date(ddt.data).getFullYear(); } catch(e){}
        return new Date().getFullYear();
      })();
      const ddtId = String(ddt.id || 'BOZZA').trim();
      const fileName = `${ddtId}-G3-collaudo.pdf`;

      // Se il motore Smart è attivo, crea le cartelle
      if (window.ensureZConnection) {
        try {
          // Chiede accesso a Z:\ANIMA_DOC se non c'è già
          const root = await window.ensureZConnection();
          if (root) {
            // Crea/Naviga: COLLAUDI -> 2025
            let cur = root;
            cur = await cur.getDirectoryHandle('COLLAUDI', { create: true });
            cur = await cur.getDirectoryHandle(String(year), { create: true });
            targetFolderHandle = cur; // La cartella esiste!

            // Costruisci stringa percorso per l'utente
            const appSets = window.lsGet('appSettings', {}) || {};
            const basePath = (appSets.docBasePath || 'Z:\\ANIMA_DOC').replace(/\/+$/, '');
            suggestedPath = `${basePath}\\COLLAUDI\\${year}\\${fileName}`;
            
            // Copia negli appunti per incollare nel "Salva con nome"
            try {
              await navigator.clipboard.writeText(suggestedPath);
              alert(`PERCORSO COPIATO NEGLI APPUNTI!\n\n1. Premi OK.\n2. Nella stampa scegli "Salva come PDF".\n3. Incolla il percorso (Ctrl+V) nel nome file.\n\nPercorso: ${suggestedPath}`);
            } catch {
              prompt('Copia questo percorso per il salvataggio PDF:', suggestedPath);
            }
          }
        } catch (e) {
          console.warn('Accesso Z: fallito o annullato', e);
        }
      }

      // 4. Caricamento Immagini (Cache RAM)
      const getImgBase64 = async (cacheKey, url) => {
        if (window.__G3_CACHE[cacheKey]) return window.__G3_CACHE[cacheKey];
        try {
          const res = await fetch(url + '?t=' + Date.now());
          const blob = await res.blob();
          const b64 = await new Promise((res) => {
            const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(blob);
          });
          if (b64.length > 100) window.__G3_CACHE[cacheKey] = b64;
          return b64;
        } catch { return ''; }
      };

      const [logoB64, timbroB64] = await Promise.all([
        getImgBase64('logo', './icons/g3-logo.png'),
        getImgBase64('timbro', './icons/anima-timbro-firma.png')
      ]);

      // 5. Genera HTML e Stampa
      const html = window.renderSchedaCollaudoG3HTML(ddt, rowsToPrint, { logoData: logoB64, timbroData: timbroB64 });
      
      if (window.safePrintHTMLStringWithPageNum) window.safePrintHTMLStringWithPageNum(html);
      else if (window.safePrintHTMLString) window.safePrintHTMLString(html);
      else {
        const w = window.open('', '_blank');
        w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>w.print(),500);
      }

      // 6. Registrazione automatica Allegato (dopo un po' di tempo per stampare)
      if (suggestedPath) {
        setTimeout(() => {
          if (confirm(`Hai salvato il PDF in Z:?\n\nConferma per registrare automaticamente l'allegato nel gestionale.`)) {
             const nowIso = new Date().toISOString();
             let allAl = [];
             try { allAl = (typeof window.lsGet === 'function') ? (window.lsGet('allegatiRows', [])||[]) : []; } catch {}
          
             // ID univoco
             let maxSeq = 0;
             allAl.forEach(r=>{ 
               const m=String(r.id).match(/^ALG-(\d{4})-(\d+)$/); 
               if(m && +m[1]===year) maxSeq=Math.max(maxSeq, +m[2]); 
             });
             const newId = `ALG-${year}-${String(maxSeq+1).padStart(4,'0')}`;

             const newRow = {
               id: newId,
               createdAt: nowIso,
               updatedAt: nowIso,
               tipo: 'COLLAUDO',
               descrizione: `Collaudo G3 ${ddtId}`,
               path: suggestedPath,
               url: '',
               entityType: 'DDT',
               entityId: ddtId,
               deletedAt: null
             };
             
             const nextAll = [...allAl, newRow];
             let afterAll = nextAll;

             if (window.allegatiUpsertOne) {
               window.allegatiUpsertOne(newRow);
               try { afterAll = (typeof lsGet === 'function') ? (lsGet('allegatiRows', [])||nextAll) : nextAll; } catch {}
             } else if (typeof window.lsSet === 'function') {
               window.lsSet('allegatiRows', nextAll);
             } else if (typeof lsSet === 'function') {
               lsSet('allegatiRows', nextAll);
             }

             // Aggiorna anche lo stato locale del DDT (evita stale)
             try { if (typeof setAllegatiRows === 'function') setAllegatiRows(afterAll); } catch {}
             alert('Allegato registrato! ✅');
             // Se sei nella vista DDT, ricarica gli allegati
             if(typeof window.requestAppRerender === 'function') window.requestAppRerender();
          }
        }, 3000); // Chiede dopo 3 secondi
      }

    }catch(e){
      console.error(e);
      alert('Errore G3: ' + e.message);
    }
  };
}

/* ================== FATTURE (lista, CRUD) ================== */
(function (global) {
  const e = React.createElement;

  // Helpers LS
  const lsGet = global.lsGet || ((k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;} });
  const lsSet = global.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });

  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
  const pad3 = n => String(n).padStart(3,'0');

  // DDT esistenti (per calcolare quanto è già stato spedito per riga)
  const ddtRows = lsGet('ddtRows', []) || [];
  // In questo modulo non abbiamo una singola commessa attiva: jobId resta vuoto,
  // così shippedForRow (qui) restituisce sempre 0 ed evita di usare variabili inesistenti.
  const jobId   = '';

      function shippedForRow(r){
        const rowId = String(r?.rowId || r?.rowID || '').trim();
        if (!jobId) return 0;

        let sum = 0;
        (Array.isArray(ddtRows) ? ddtRows : []).forEach(ddt => {
          if (!ddt) return;
          if (ddt.deletedAt) return; // 🔴 DDT eliminato → ignoralo
          if (ddt.annullato === true || String(ddt.stato||'') === 'Annullato') return;

          const ddtJobId = String(
            ddt.commessaId ||
            ddt.commessaRif ||
            ddt.__fromCommessaId ||
            ''
          );
          if (ddtJobId !== jobId) return;

          const righe = Array.isArray(ddt.righe) ? ddt.righe : [];
          righe.forEach(dr => {
            if (!dr) return;
            const drRowId = String(dr.commessaRowId || dr.commessaRowID || '').trim();

            // Se la commessa ha rowId usiamo il match per riga.
            // Se la commessa non ha rowId, lavoriamo solo a livello commessa.
            if (rowId){
              if (drRowId !== rowId) return;
            } else if (drRowId){
              // riga commessa senza id ma DDT sì → evito di incrociare quantità a caso
              return;
            }

            const q = Number(dr.qta ?? dr.quantita ?? 0);
            if (Number.isFinite(q)) sum += q;
          });
        });

        return Math.max(0, sum);
      }

  // read-only: accountant / viewer / mobile
  const readOnly = (
    typeof window.isReadOnlyUser === 'function'
      ? !!window.isReadOnlyUser()
      : !!(window.__USER && window.__USER.role === 'accountant')
  );

  const roProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));

  // mirror al server (se disponibile)
  const mirrorToServer = global.mirrorToServer || ((k,v)=>{});
  const api = (global.api && global.api.kv) ? global.api.kv : null;

  function totals(righe){
    let imponibile=0, imposta=0;
    (righe||[]).forEach(r=>{
      const qty = Number(r.qta||0);
      const pr  = Number(r.prezzo||0);
      const scp = Number(r.sconto||r.scontoPerc||0);
      const iva = Number(r.iva||0);
      const rowBase = qty * pr * (1 - (scp/100));
      imponibile += rowBase;
      imposta    += rowBase * iva/100;
    });
    return { imponibile, imposta, totale: imponibile+imposta };
  }

function FattureView(){
    const app      = React.useMemo(()=> lsGet('appSettings',{})||{}, []);
    const clienti  = React.useMemo(()=> lsGet('clientiRows',[])||[], []);
    const articoliA = React.useMemo(()=> lsGet('magArticoli',[])||[], []);
    const [rows, setRows] = React.useState(()=> lsGet('fattureRows', []) || []);

    // hydrate da server, se disponibile
    React.useEffect(()=>{
      (async ()=>{
        try{
          if (api && typeof api.get==='function'){
            const s = await api.get('fattureRows');
            if (Array.isArray(s)) { setRows(s); lsSet('fattureRows', s); }
          }
        }catch(e){}
      })();
    },[]);

    // mirror locale + server
    React.useEffect(()=>{
      lsSet('fattureRows', rows);
      try { mirrorToServer('fattureRows', rows); } catch {}
    },[rows]);

    const [q, setQ]         = React.useState('');
    const [form, setForm]   = React.useState({
      id:'', data: todayISO(),
      clienteId:'', cliente:'',
      pagamento: app.defaultPagamento || '30 gg data fattura',
      iban: app.iban || '', codiceUnivoco:'', pec:'',
      plafond:false, naturaIva:'',
      causale:'',
      ddtId:'', ddtData:'',
      note:'',
      rifNormativo:'', // es. “Operazione non imponibile art. 8, DPR 633/72”
      righe:[], // {descrizione,qta,UM,prezzo,iva,sconto}
      stato: 'Bozza',
      scadenze: [] // [{data:'YYYY-MM-DD', importo: number}]

    });
    const [editingId, setEditingId] = React.useState(null);
    const [showForm, setShowForm]   = React.useState(false);

    // Prefill da DDT
    React.useEffect(()=>{
      try{
        const raw = localStorage.getItem('prefillFattura');
        if(!raw) return;
        localStorage.removeItem('prefillFattura');
        const pf = JSON.parse(raw);
        setForm(prev => ({ ...prev, ...pf, causale: (prev.causale||'') }));
        setShowForm(true);
      }catch{}
    },[]);

        async function openNew(){
      // Genera ID robusto FA-YYYY-NNN (legge anche Impostazioni/counters se hai nextIdFor)
      const idObj = (typeof window.nextIdFor === 'function')
            ? await window.nextIdFor({ prefix:'FA', storageKey:'fattureRows', seriesKey:'FA', width:3 })
        : (function(){
            const y  = new Date().getFullYear();
            const pad = n => String(n).padStart(3,'0');
            let all = [];
            try { all = JSON.parse(localStorage.getItem('fattureRows')||'[]')||[]; } catch {}
            const n = 1 + all.filter(r => String(r.id||'').startsWith(`FA-${y}-`)).length;
            return { id:`FA-${y}-${pad(n)}`, year:y, num:n };
          })();

      setForm(()=>({
        id: idObj.id,
        data: todayISO(),
        clienteId:'', cliente:'',
        pagamento: app.defaultPagamento || '30 gg data fattura',
        iban: app.iban || '', codiceUnivoco:'', pec:'',
        plafond:false, naturaIva:'',
        causale:'',
        ddtId:'', ddtData:'',
        note:'',
        righe:[],
        stato:'Bozza',
        scadenze:[]
      }));
      setEditingId(null);
      setShowForm(true);
    }

    function openEdit(id){
      const x = (rows||[]).find(r=>r.id===id); if(!x) return;
      setForm({ ...x, righe: Array.isArray(x.righe)?x.righe:[] });
      setEditingId(id);
      setShowForm(true);
    }
    // P2 – eliminazione fattura robusta (LS + cloud + KV)
    async function del(id){
      if (!confirm('Eliminare fattura?')) return;

      // 1) Leggi lo stato attuale da localStorage
      let all = [];
      try {
        all = JSON.parse(localStorage.getItem('fattureRows') || '[]') || [];
      } catch {
        all = [];
      }

      const nowISO = new Date().toISOString();

      // 2) Soft delete: marca deletedAt/updatedAt senza rimuovere il record
      const next = (Array.isArray(all) ? all : []).map(r => {
        if (!r || String(r.id) !== String(id)) return r;
        const clone = { ...r };
        clone.deletedAt = nowISO;
        clone.updatedAt = nowISO;
        return clone;
      });

      // 3) Scrivi subito in localStorage (write-through)
      try {
        localStorage.setItem('fattureRows', JSON.stringify(next));
      } catch {}

      // 4) Aggiorna la UI (stato React)
      setRows(next);

      // 5) Sync cloud / KV (best effort, non deve bloccare se offline)
      try {
        if (window.syncExportToCloudOnly) {
          window.syncExportToCloudOnly(['fattureRows']);
        }
        if (window.persistKV) {
          await window.persistKV('fattureRows', next);
        }
        if (window.api?.kv?.set) {
          await window.api.kv.set('fattureRows', next);
        }
      } catch (e) {
        console.warn('[Fatture] sync eliminazione fallita', e);
      }

            // 6) Se la fattura eliminata proveniva da uno o più DDT, rimuovi il flag __fatturato dai DDT
      try {
        // fattura che stiamo eliminando (prima della soft-delete)
        const removed = (Array.isArray(all) ? all : []).find(r => r && String(r.id) === String(id));
        if (removed) {
          const ddtIdSet = new Set();

          // a) caso fatturazione multipla: __fromDDTs
          if (Array.isArray(removed.__fromDDTs)) {
            removed.__fromDDTs.forEach(x => {
              if (x !== null && x !== undefined && String(x).trim() !== '') {
                ddtIdSet.add(String(x).trim());
              }
            });
          }

          // b) caso fattura da DDT singolo: righe con ddtId
          (removed.righe || []).forEach(r => {
            const rid = (r && r.ddtId) ? String(r.ddtId).trim() : '';
            if (rid) ddtIdSet.add(rid);
          });

          if (ddtIdSet.size > 0) {
            // Costruisci l’insieme di DDT ancora referenziati da ALTRE fatture non eliminate
            const stillLinked = new Set();
            const activeFatture = (Array.isArray(next) ? next : []).filter(r => r && !r.deletedAt);

            activeFatture.forEach(fa => {
              if (!fa) return;

              if (Array.isArray(fa.__fromDDTs)) {
                fa.__fromDDTs.forEach(x => {
                  if (x !== null && x !== undefined && String(x).trim() !== '') {
                    stillLinked.add(String(x).trim());
                  }
                });
              }

              (fa.righe || []).forEach(r => {
                const rid = (r && r.ddtId) ? String(r.ddtId).trim() : '';
                if (rid) stillLinked.add(rid);
              });
            });

            // I DDT da sbloccare sono quelli legati SOLO a questa fattura appena eliminata
            const idsToUnflag = new Set(
              Array.from(ddtIdSet).filter(idStr => !stillLinked.has(idStr))
            );

            if (idsToUnflag.size > 0) {
              let allDDT = [];
              try { allDDT = JSON.parse(localStorage.getItem('ddtRows') || '[]') || []; } catch {}

              if (Array.isArray(allDDT) && allDDT.length > 0) {
                const nowISO2 = new Date().toISOString();
                let changedDDT = false;

                allDDT = allDDT.map(d => {
                  if (!d) return d;
                  const idStr = String(d.id || '').trim();
                  if (!idStr || !idsToUnflag.has(idStr)) return d;

                  // rimuovi solo il flag, non tocchiamo altre proprietà
                  const clone = { ...d };
                  delete clone.__fatturato;
                  delete clone.__fatturatoAt;
                  clone.updatedAt = nowISO2;
                  changedDDT = true;
                  return clone;
                });

                if (changedDDT) {
                  try { localStorage.setItem('ddtRows', JSON.stringify(allDDT)); } catch {}
                  try {
                    if (window.mirrorToServer) window.mirrorToServer('ddtRows', allDDT);
                    if (window.persistKV) await window.persistKV('ddtRows', allDDT);
                    if (window.api?.kv?.set) await window.api.kv.set('ddtRows', allDDT);
                  } catch (e2) {
                    console.warn('[Fatture] sync unflag DDT failed', e2);
                  }
                }
              }
            }
          }
        }
      } catch (e) {
        console.warn('[Fatture] unflag DDT on delete failed', e);
      }

      try { alert('Fattura eliminata ✅'); } catch {}
    }

    function onChange(ev){
      const {name,value,type,checked} = ev.target;
      setForm(p=>({...p, [name]: (type==='checkbox'? !!checked : value)}));
    }
    function onSelCliente(id){
      const c = (clienti||[]).find(x=>String(x.id)===String(id)) || null;
      setForm(p=>({
        ...p,
        clienteId:id,
        cliente: c ? (c.ragione || c.ragioneSociale || c.denominazione || c.nome || '') : '',
        codiceUnivoco: c ? (c.codiceUnivoco||'') : '',
        pec: c ? (c.pec||'') : '',
        plafond: !!(c && c.plafond),
        naturaIva: c ? (c.naturaIva || p.naturaIva) : p.naturaIva,
        pagamento: p.pagamento || (app.defaultPagamento || '30 gg data fattura')
      }));
    }
          function addScadenza(){
      const d = todayISO();
      setForm(p => ({ ...p, scadenze: [...(p.scadenze||[]), { data:d, importo:0 }] }));
    }
    function updScadenza(i, patch){
      setForm(p => {
        const nx = [...(p.scadenze||[])];
        nx[i] = { ...nx[i], ...patch };
        return { ...p, scadenze: nx };
      });
    }
    function delScadenza(i){
      setForm(p => ({ ...p, scadenze: (p.scadenze||[]).filter((_,k)=>k!==i) }));
    }

    // Righe
    function addRiga(){
      const ivaDef = (form.plafond ? 0 : (Number(app.defaultIva)||22));
      setForm(p=>({
        ...p,
        righe:[...(p.righe||[]), {
          codice: '',
          descrizione: '',
          qta: '',
          UM: 'PZ',
          prezzo: '',
          iva: ivaDef,
          sconto: ''
        }]
      }));
    }
    function updRiga(i,patch){
      setForm(p=>({
        ...p,
        righe:(p.righe||[]).map((r,ix)=> ix===i ? { ...r, ...patch } : r)
      }));
    }
    function remRiga(i){
      setForm(p=>({
        ...p,
        righe:(p.righe||[]).filter((_,ix)=>ix!==i)
      }));
    }

        async function save(ev){
      ev && ev.preventDefault();

      // Assicura un ID fattura valido (FA-YYYY-NNN)
      const curId = String(form.id || '').trim();
      const badId =
        !curId ||                                 // vuoto
        curId.toUpperCase().includes('NAN') ||    // conteneva NaN
        !curId.startsWith('FA-');                 // qualsiasi cosa non inizi con FA-

      if (badId) {
        let idObj = null;

        if (typeof window.nextIdFor === 'function') {
          try {
            idObj = await window.nextIdFor({
              prefix:     'FA',
              storageKey: 'fattureRows',
              seriesKey:  'FA',
              width:      3
            });
          } catch {}
        }

        // Fallback locale se nextIdFor non è disponibile
        if (!idObj || !idObj.id) {
          const y   = new Date().getFullYear();
          const pad = n => String(n).padStart(3,'0');
          let all   = [];
          try { all = JSON.parse(localStorage.getItem('fattureRows') || '[]') || []; } catch {}
          const n = 1 + (all.filter(r => String(r.id||'').startsWith(`FA-${y}-`)).length || 0);
          idObj = { id:`FA-${y}-${pad(n)}`, year:y, num:n };
        }

        form.id = idObj.id;
      }

      // Validazioni base
      if (!form.clienteId && !form.cliente){
        alert('Seleziona un cliente');
        return;
      }

      const righeValide = (form.righe||[]).filter(r=>{
        const hasText = String(r.descrizione||'').trim() || String(r.codice||'').trim();
        const qty = Number(r.qta||0);
        return !!hasText && Number.isFinite(qty) && qty>0;
      });
      if (!righeValide.length){
        alert('Inserisci almeno una riga con descrizione/codice e quantità > 0');
        return;
      }

      const rec = {
        ...form,
        righe: righeValide,
        updatedAt: new Date().toISOString()
      };

      // Scrivi LS (write-through)
      let all = [];
      try { all = JSON.parse(localStorage.getItem('fattureRows')||'[]')||[]; } catch {}
      const ix = all.findIndex(r => String(r.id) === String(rec.id));
      if (ix>=0) all[ix]=rec; else all.push(rec);
      try { localStorage.setItem('fattureRows', JSON.stringify(all)); } catch {}

            // --- Marca i DDT coinvolti come fatturati (singolo + multiplo) ---
      try {
        // 1) raccogli tutti gli ID DDT coinvolti
        const ddtIdSet = new Set();

        // a) caso fatturazione multipla: __fromDDTs è un array di id
        if (Array.isArray(rec.__fromDDTs)) {
          rec.__fromDDTs.forEach(id => {
            if (id !== null && id !== undefined && String(id).trim() !== '') {
              ddtIdSet.add(String(id));
            }
          });
        }

        // b) caso fattura da DDT singolo: le righe portano ddtId / ddtData
        (rec.righe || []).forEach(r => {
          const rid = (r && r.ddtId) ? String(r.ddtId).trim() : '';
          if (rid) ddtIdSet.add(rid);
        });

        if (ddtIdSet.size > 0) {
          // 2) leggi i DDT dal LS
          let allDDT = [];
          try { allDDT = JSON.parse(localStorage.getItem('ddtRows') || '[]') || []; } catch {}

          if (Array.isArray(allDDT) && allDDT.length > 0) {
            const nowISO = new Date().toISOString();
            let changed = false;

            allDDT = allDDT.map(d => {
              if (!d) return d;
              const id = String(d.id || '').trim();
              if (!id || !ddtIdSet.has(id)) return d;
              if (d.__fatturato) return d; // già marcato

              changed = true;
              return {
                ...d,
                __fatturato: true,
                __fatturatoAt: nowISO,
                updatedAt: nowISO
              };
            });

            if (changed) {
              // 3) scrivi LS e prova a riflettere a server (best-effort)
              try { localStorage.setItem('ddtRows', JSON.stringify(allDDT)); } catch {}
              try {
                if (window.mirrorToServer) window.mirrorToServer('ddtRows', allDDT);
                if (window.persistKV) await window.persistKV('ddtRows', allDDT);
                if (window.api?.kv?.set) await window.api.kv.set('ddtRows', allDDT);
              } catch {}
            }
          }
        }
      } catch (e) {
        console.warn('[Fatture] mark DDT as fatturati failed', e);
      }

      // UI
      setRows(all);
      setShowForm(false);
      setEditingId(rec.id);

      // Sync cloud (best-effort, non crashare offline)
      try{
        if (window.syncExportToCloudOnly) window.syncExportToCloudOnly(['fattureRows']);
        if (window.persistKV) await window.persistKV('fattureRows', all);
        if (window.api?.kv?.set) await window.api.kv.set('fattureRows', all);
      }catch{}

      alert('Fattura salvata ✅');
    }


    // Totali live del form
    const formTotals = totals(form.righe||[]);

    // Ricerca/ordinamento
    const filtered = React.useMemo(()=>{
      const s = String(q||'').toLowerCase();
      return (rows||[])
        // nascondi fatture soft-delete
        .filter(fa => !fa?.deletedAt)
        // filtro testuale su id + cliente + note
        .filter(fa =>
          (String(fa.id)+' '+String(fa.cliente||'')+' '+String(fa.note||''))
            .toLowerCase()
            .includes(s)
        )
        .sort((a,b)=>{
          const ma = String(a.id||'').match(/^(?:FATT|FA)-(\d{4})-(\d{3})$/);
          const mb = String(b.id||'').match(/^(?:FATT|FA)-(\d{4})-(\d{3})$/);
          if(ma&&mb){
            if(+mb[1]!==+ma[1]) return +mb[1]-+ma[1];
            if(+mb[2]!==+ma[2]) return +mb[2]-+ma[2];
          }
          return String(b.id||'').localeCompare(String(a.id||'')); // fallback
        });
    },[rows,q]);

            // ---- FILTRO ANNO (lista dinamica dagli ID/Data) ----
    const [year, setYear] = React.useState('');

    // Estrae anno da 'data' (YYYY-MM-DD) o da ID tipo FA-2025-001, altrimenti vuoto
    const getYearFromFa = (fa) => {
      try{
        const d = fa?.data || fa?.dataFattura || '';
        if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}/.test(d)) return d.slice(0,4);
      }catch{}
      try{
        const id = String(fa?.id||'');
        const m = id.match(/(\d{4})/);
        if (m) return m[1];
      }catch{}
      return '';
    };

    const years = React.useMemo(()=>{
      const set = new Set();
      (rows||[]).forEach(fa => {
        const y = getYearFromFa(fa);
        if (y) set.add(y);
      });
      return Array.from(set).sort((a,b)=> b.localeCompare(a)); // discendente
    }, [rows]);

    // Applica il filtro per anno sopra al filtro testuale
    const filteredView = React.useMemo(()=>{
      if (!year) return filtered;
      return (filtered||[]).filter(fa => getYearFromFa(fa) === year);
    }, [filtered, year]);

        // Somma totale delle fatture attualmente filtrate (per la toolbar)
            const filteredTotale = React.useMemo(()=>{
      try{
        return (filteredView||[]).reduce((S, fa)=>{
          const t = totals(fa.righe||[]);
          return S + (Number.isFinite(t.totale) ? t.totale : 0);
        }, 0);
      }catch{ return 0; }
    }, [filteredView]);


        return e('div',{className:'page'},

      // Toolbar
      e('div',{className:'actions',style:{marginBottom:8}},
        e('input',{className:'input',placeholder:'Cerca…', value:q, onChange:ev=>setQ(ev.target.value)}),
        e('button',{
          className:'btn',
          onClick:openNew,
          ...(global.roProps ? global.roProps() : roProps())
        }, '➕ Nuova fattura'),

        e('select', {
          className:'input',
          value: year,
          onChange: ev => setYear(ev.target.value),
          style:{ width: 140 }
        },
          e('option', { value:'' }, 'Anno: tutti'),
          ...years.map(y => e('option', { key:y, value:String(y) }, y))
        ),

        e('div',{ className:'muted', style:{ marginLeft:'auto' } },
          'Totale filtro: € ' + fmt2(filteredTotale)
        )
      ),

      // Lista fatture
      e('div',{className:'card',style:{overflowX:'auto'}},
        e('table',{className:'table'},
          e('thead',null,
            e('tr',null,
              e('th',{style:{width:130}},'N.'),
              e('th',null,'Data'),
              e('th',null,'Cliente'),
              e('th',{style:{width:120}},'Totale'),
              e('th',{style:{width:120}},'Stato'),
              e('th',{style:{width:250}},'Azioni')
            )
          ),
          e('tbody',null,
            filteredView.map(fa=>{
              const t = totals(fa.righe||[]);
              return e('tr',{key:fa.id},
                e('td',null,fa.id),
                e('td',null,fa.data||''),
                e('td',null,fa.cliente||''),
                e('td',null,fmt2(t.totale)),
                e('td',null,
                  e('span',{
                    className:'pill',
                    style:{
                      padding:'2px 8px', borderRadius:999,
                      background:
                        (fa.stato==='Pagata' ? '#dcfce7' :
                        fa.stato==='Inviata' ? '#dbeafe' :
                        fa.stato==='Stornata'? '#fee2e2' :
                        fa.stato==='Emessa' ? '#e9d5ff' : '#e5e7eb'),
                      color:'#111827', fontSize:12
                    }
                  }, fa.stato || 'Bozza')
                ),
                e('td', null,
                  e('button',{
                    className:'btn btn-outline',
                    onClick:()=>openEdit(fa.id),
                    disabled: readOnly,
                    title: readOnly ? 'Sola lettura' : ''
                  },'✏️ Modifica'),' ',

                  e('button',{
                    className:'btn btn-outline',
                    title:'Anteprima/Stampa',
                    onClick:()=>window.printFattura && window.printFattura(fa)
                  }, '🖨️ Stampa'),' ',

                  (function(){
                    let ok=true, tip='Esporta XML FatturaPA';
                    try{
                      const res = window.canExportFatturaPA ? window.canExportFatturaPA(fa) : {ok:true,reasons:[]};
                      ok = !!res.ok;
                      if(!ok) tip = 'Impossibile esportare: ' + (res.reasons||[]).join(' · ');
                    }catch{}
                    return e('button',{
                      type:'button',
                      className:'btn btn-outline',
                      title: tip,
                      disabled: !ok,
                      onClick:()=>{ if(ok) try{ window.exportFatturaPAXML && window.exportFatturaPAXML(fa); }catch(e){} }
                    }, 'XML FatturaPA');
                  })(),' ',

                  e('button',{
                    className:'btn btn-outline',
                    onClick:()=>del(fa.id),
                    ...(global.roProps ? global.roProps() : roProps())
                  }, '🗑')
                )
              );
            })
          )
        )
      ),

      // Form fattura
      showForm && e('form', { className:'card', onSubmit: save, style:{marginTop:8,padding:12} },
        e('h3', null, editingId ? `Modifica ${form.id}` : 'Nuova fattura'),

        e('fieldset', { disabled: readOnly },

          // metadati
          e('div',{className:'form', style:{gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))',gap:12}},
            e('div',{className:'form-group-title', style:{gridColumn:'1 / -1'}}, 'Dati fattura'),

            e('div',null, e('label',null,'Data'),
              e('input',{type:'date',name:'data',value:form.data,onChange:onChange})
            ),

            e('div',null,
              e('label',null,'Cliente'),
              (clienti && clienti.length)
                ? e('select',{value:form.clienteId,onChange:ev=>onSelCliente(ev.target.value)},
                    e('option',{value:''},'— seleziona —'),
                    clienti.map(c=> e('option',{key:c.id,value:c.id},String(c.ragione||c.ragioneSociale||c.denominazione||c.nome||c.id)))
                  )
                : e('a',{className:'btn btn-outline',href:'#/clienti'},'Crea cliente…')
            ),

            e('div',null,
              e('label',null,'Stato'),
              e('select',{ name:'stato', value:form.stato||'Bozza', onChange:onChange },
                e('option',{value:'Bozza'},'Bozza'),
                e('option',{value:'Emessa'},'Emessa'),
                e('option',{value:'Inviata'},'Inviata'),
                e('option',{value:'Pagata'},'Pagata'),
                e('option',{value:'Stornata'},'Stornata')
              )
            ),

            e('div',null,
              e('label',null,'Bollo virtuale'),
              e('div',null,
                e('input',{
                  type:'checkbox',
                  checked:!!form.bolloVirtuale,
                  onChange:ev=>setForm(p=>({...p, bolloVirtuale: ev.target.checked}))
                }),
                ' Applicare € 2,00 per bollo su esenti/non imponibili (o personalizza importo sotto)'
              )
            ),

            e('div',null,
              e('label',null,'Importo bollo'),
              e('input',{
                type:'number', step:'0.01',
                value: form.importoBollo ?? 2.00,
                onChange:ev=> setForm(p=>({...p, importoBollo: Number(ev.target.value||2)}))
              })
            ),

            e('div',null, e('label',null,'Pagamento'),
              e('input',{name:'pagamento',value:form.pagamento||'',onChange:onChange})
            ),

            e('div',null,
              e('label',null,'Esigibilità IVA'),
              e('select',{name:'esigibilitaIVA', value:form.esigibilitaIVA||'', onChange:onChange},
                e('option',{value:''},'—'),
                e('option',{value:'I'},'I — Immediata'),
                e('option',{value:'D'},'D — Differita'),
                e('option',{value:'S'},'S — Scissione pagamenti (split)')
              )
            ),

            e('div',null,
              e('label',null,'Riferimento normativo (per IVA 0)'),
              e('input',{
                name:'rifNormativo',
                value:form.rifNormativo||'',
                onChange:onChange,
                placeholder:'es. Operazione esente art. 10 DPR 633/72'
              })
            ),

            e('div',null, e('label',null,'IBAN (documento)'),
              e('input',{name:'iban',value:form.iban||'',onChange:onChange})
            ),
            e('div',null, e('label',null,'Codice Univoco SDI'),
              e('input',{name:'codiceUnivoco',value:form.codiceUnivoco||'',onChange:onChange})
            ),
            e('div',null, e('label',null,'PEC'),
              e('input',{name:'pec',value:form.pec||'',onChange:onChange})
            ),

            e('label',{className:'row',style:{gap:8,alignItems:'center'}},
              e('input',{
                type:'checkbox',
                checked:!!form.plafond,
                onChange:ev=>setForm(p=>({...p,plafond:ev.target.checked, righe:(p.righe||[]).map(r=>({...r,iva:0}))}))
              }),
              e('span',null,'Cliente a plafond (IVA 0 e natura IVA)')
            ),
            e('div',null, e('label',null,'Natura IVA (se plafond)'),
              e('input',{name:'naturaIva',value:form.naturaIva||'',onChange:onChange})
            ),

            e('div',{style:{gridColumn:'1/-1'}},
              e('label',null,'Causale'),
              e('input',{name:'causale',value:form.causale||'',onChange:onChange})
            ),

            e('div',null, e('label',null,'Rif. DDT (facoltativo)'),
              e('input',{name:'ddtId',value:form.ddtId||'',onChange:onChange})
            ),
            e('div',null, e('label',null,'Data DDT'),
              e('input',{type:'date', name:'ddtData',value:form.ddtData||'',onChange:onChange})
            ),

            e('div',{style:{gridColumn:'1/-1'}},
              e('label',null,'Note (solo stampa di cortesia)'),
              e('textarea',{name:'note',value:form.note||'',onChange:onChange})
            )
          ),

          // Scadenze (solo nel form)
          e('div',{className:'card', style:{marginTop:8}},
            e('div',{className:'actions',style:{justifyContent:'space-between'}},
              e('h4',null,'Scadenze'),
              e('button',{type:'button',className:'btn btn-outline', onClick:addScadenza},'➕ Aggiungi scadenza')
            ),
            e('table',{className:'table'},
              e('thead',null,
                e('tr',null,
                  e('th',{style:{width:160}},'Data'),
                  e('th',{style:{width:160}},'Importo'),
                  e('th',{style:{width:60}},'')
                )
              ),
              e('tbody',null,
                (form.scadenze||[]).map((s,i)=> e('tr',{key:i},
                  e('td',null,
                    e('input',{
                      type:'date',
                      value:s.data||todayISO(),
                      onChange:ev=>updScadenza(i,{data:ev.target.value})
                    })
                  ),
                  e('td',null,
                    e('input',{
                      type:'number', step:'0.01',
                      value:s.importo||0,
                      onChange:ev=>updScadenza(i,{importo:ev.target.value})
                    })
                  ),
                  e('td',null,
                    e('button',{
                      type:'button',
                      className:'btn btn-outline',
                      onClick:()=>delScadenza(i)
                    },'🗑')
                  )
                ))
              )
            )
          ),

          // RIGHE
          e('div',{className:'card',style:{marginTop:8,overflowX:'auto'}},

            // suggerimenti da magazzino articoli (codice → descrizione)
            e('datalist',{id:'fattMagArtList'},
              (Array.isArray(articoliA)?articoliA:[]).map((a,i)=>
                e('option',{key:i, value:a.codice||''}, a.descrizione||'')
              )
            ),

            e('table',{className:'table'},
              e('thead',null,
                e('tr',null,
                  e('th',{style:{width:28}},'#'),
                  e('th',{style:{width:120}},'Codice'),
                  e('th',null,'Descrizione'),
                  e('th',{style:{width:80}},'Q.tà'),
                  e('th',{style:{width:60}},'UM'),
                  e('th',{style:{width:100}},'Prezzo un.'),
                  e('th',{style:{width:80}},'IVA'),
                  e('th',{style:{width:120}},'Natura'),
                  e('th',{style:{width:90}},'Sconto %'),
                  e('th',{style:{width:110}},'Importo'),
                  e('th',{style:{width:60}},'')
                )
              ),
              e('tbody',null,
                (form.righe||[]).map((r,i)=> e('tr',{key:i},
                  // # riga
                  e('td',{style:{textAlign:'center'}}, String(i+1)),

                  // Codice articolo
                  e('td',null,
                    e('input',{
                      list:'fattMagArtList',
                      value: r.codice || '',
                      onChange: ev => {
                        const v = ev.target.value;
                        const a = (articoliA||[]).find(x =>
                          String(x.codice||'').trim() === String(v||'').trim()
                        );
                        updRiga(i, {
                          codice: v,
                          // se trovo l'articolo, auto-propago un minimo di info
                          ...(a ? {
                            descrizione: r.descrizione || a.descrizione || '',
                            UM: r.UM || a.um || 'PZ',
                            prezzo: (r.prezzo != null && r.prezzo !== '')
                              ? r.prezzo
                              : (a.prezzo || a.prezzoListino || '')
                          } : {})
                        });
                      }
                    })
                  ),
                  // Descrizione
                  e('td',null,
                    e('input',{
                      value:r.descrizione||'',
                      onChange:ev=>updRiga(i,{descrizione:ev.target.value})
                    })
                  ),

                  // Q.tà
                  e('td',{style:{textAlign:'center'}},
                    e('input',{
                      type:'number', step:'any',
                      value:r.qta||'',
                      onChange:ev=>updRiga(i,{qta:ev.target.value})
                    })
                  ),

                  // UM
                  e('td',{style:{textAlign:'center'}},
                    e('input',{
                      value:r.UM||'PZ',
                      onChange:ev=>updRiga(i,{UM:ev.target.value})
                    })
                  ),

                  // Prezzo
                  e('td',{style:{textAlign:'right'}},
                    e('input',{
                      type:'number', step:'any',
                      value:r.prezzo||'',
                      onChange:ev=>updRiga(i,{prezzo:ev.target.value})
                    })
                  ),

                  // IVA (select)
                  e('td',{style:{textAlign:'center'}},
                    e('select',{
                      value: (r.iva === 0 || r.iva === '0') ? 22 : (r.iva ?? 22),
                      onChange: ev=>{
                        const val = ev.target.value;
                        if (val === '') updRiga(i,{ iva: '' });
                        else updRiga(i,{ iva: Number(val) });
                      }
                    },
                      e('option',{value:''},'—'),
                      e('option',{value:4},'4'),
                      e('option',{value:10},'10'),
                      e('option',{value:22},'22')
                    )
                  ),

                  // Natura
                  e('td',null,
                    e('select',{
                      value: r.natura || '',
                      onChange: ev=> updRiga(i,{ natura: ev.target.value || '' })
                    },
                      e('option',{value:''},'—'),
                      e('option',{value:'N1'},  'N1 escl. art.15'),
                      e('option',{value:'N2.1'},'N2.1 non sogg. art.7-7septies'),
                      e('option',{value:'N2.2'},'N2.2 non sogg. altre norme'),
                      e('option',{value:'N3.1'},'N3.1 non impon. esportaz.'),
                      e('option',{value:'N3.2'},'N3.2 cessioni intracom.'),
                      e('option',{value:'N3.3'},'N3.3 cessioni a San Marino'),
                      e('option',{value:'N3.4'},'N3.4 operaz. assimilate'),
                      e('option',{value:'N3.5'},'N3.5 dichiaraz. intento'),
                      e('option',{value:'N3.6'},'N3.6 altre non impon.'),
                      e('option',{value:'N4'},  'N4 esenti'),
                      e('option',{value:'N5'},  'N5 regimi particolari'),
                      e('option',{value:'N6.1'},'N6.1 reverse rottami'),
                      e('option',{value:'N6.2'},'N6.2 reverse oro/argento'),
                      e('option',{value:'N6.3'},'N6.3 reverse subappalto edil.'),
                      e('option',{value:'N6.4'},'N6.4 reverse edifici/energia'),
                      e('option',{value:'N6.5'},'N6.5 reverse telefonia'),
                      e('option',{value:'N6.6'},'N6.6 reverse elettronica'),
                      e('option',{value:'N6.7'},'N6.7 reverse settori partic.'),
                      e('option',{value:'N6.8'},'N6.8 reverse costruzioni'),
                      e('option',{value:'N6.9'},'N6.9 reverse altri casi'),
                      e('option',{value:'N7'},  'N7 IVA assolta in altro Stato')
                    )
                  ),

                  // Sconto
                  e('td',{style:{textAlign:'center'}},
                    e('input',{
                      type:'number', step:'any',
                      value:(r.sconto ?? r.scontoPerc ?? ''),
                      onChange:ev=>updRiga(i,{sconto:ev.target.value})
                    })
                  ),

                  // Importo calcolato
                  e('td',{style:{textAlign:'right'}},
                    (function(){
                      const qty=+r.qta||0, pr=+r.prezzo||0, sc=(+r.sconto||+r.scontoPerc||0);
                      return fmt2(qty*pr*(1-sc/100));
                    })()
                  ),

                  // Azioni riga
                  e('td',{style:{textAlign:'center', whiteSpace:'nowrap'}},
                    e('button',{
                      type:'button',
                      className:'btn btn-outline',
                      onClick:()=>remRiga(i)
                    },'🗑')
                  )
                ))
              )
            ),

            e('div',{className:'actions',style:{justifyContent:'flex-end'}},
              e('button',{type:'button',className:'btn btn-outline',onClick:addRiga},'➕ Aggiungi riga')
            )
          )
        ), // fine fieldset

        // Totali + azioni
        e('div', {className:'actions', style:{justifyContent:'space-between',gap:8}},
          e('div', null,
            e('span', null, `Imponibile: ${fmt2(formTotals.imponibile)}  —  IVA: ${fmt2(formTotals.imposta)}  —  Totale: ${fmt2(formTotals.totale)}`)
          ),
          e('div', null,

            e('button', {
              type:'button',
              className:'btn btn-outline',
              onClick:()=>{ setShowForm(false); setEditingId(null); }
            }, 'Annulla'), ' ',

            e('button', {
              type:'button',
              className:'btn btn-outline',
              title:'Anteprima/Stampa',
              onClick:()=>{ try{window.printFattura && window.printFattura({ ...form, id: (editingId ? form.id : '(bozza)') });}catch(e){} }
            }, '🖨️ Stampa'), ' ',

            (function(){
              const faObj = { ...form, id: (editingId ? form.id : '(bozza)') };
              let ok=true, tip='Esporta XML FatturaPA';
              try{
                const res = window.canExportFatturaPA ? window.canExportFatturaPA(faObj) : {ok:true,reasons:[]};
                ok = !!res.ok;
                if(!ok) tip = 'Impossibile esportare: ' + (res.reasons||[]).join(' · ');
              }catch{}
              return e('button',{
                type:'button',
                className:'btn btn-outline',
                title: tip,
                disabled: !ok,
                onClick:()=>{ if(ok) try{ window.exportFatturaPAXML && window.exportFatturaPAXML(faObj); }catch(e){} }
              }, 'XML FatturaPA');
            })(),' ',

            e('button', {
              type:'submit',
              className:'btn',
              disabled: readOnly,
              title: readOnly ? 'Sola lettura' : ''
            }, 'Salva')
          )
        )
      )
    );
  }

  // export & route
  global.FattureView = FattureView;
  global.ROUTES = global.ROUTES || {};
  global.ROUTES['#/fatture'] = global.FattureView;
  global.ROUTES['#/Fatture'] = global.FattureView;
})(window);


// ===== Stampa Fattura aggiornata (paginata) =====
(function (global) {
  const esc = s => String(s == null ? '' : s)
    .replace(/[<>&]/g, c => ({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
  const fmt2 = n => Number(n || 0)
    .toLocaleString('it-IT',{ minimumFractionDigits:2, maximumFractionDigits:2 });

  window.printFattura = function printFattura(fa){
    try{
      // --- intestazione azienda / cliente -----------------------------------
      let app = {};
      try { app = JSON.parse(localStorage.getItem('appSettings') || '{}') || {}; } catch {}
      const logo = app.logoDataUrl || '';

      let clienti = [];
      try { clienti = JSON.parse(localStorage.getItem('clientiRows') || '[]') || []; } catch {}
      const cli = clienti.find(c => String(c.id) === String(fa.clienteId)) || null;

      const ragAzi   = esc(app.ragioneSociale || '');
      const pivaAzi  = esc(app.piva || app.pIva || '');
      const sedeLeg  = esc(app.sedeLegale || app.companyLegal || '');
      const sedeOp   = esc(app.sedeOperativa || app.companyOperational || '');
      const emailAzi = esc(app.email || '');
      const telAzi   = esc(app.telefono || '');
      const rea      = esc(app.rea || '');
      const capSoc   = esc(app.capitaleSociale || '');
      const sdi      = esc(app.codiceSDI || app.sdi || '');

      // Dati bancari per stampa fattura di cortesia:
      // preferisci i campi dedicati, con fallback ai vecchi nomi
      const bancaIstit = esc(app.bankName || app.banca || '');
      const bancaInt   = esc(app.bankHolder || app.intestatario || '');
      const bancaIban  = esc(app.iban || app.bancaIban || '');
      const bancaBic   = esc(app.bic || app.bancaBicSwift || app.bicswift || '');

      const cliRag   = esc(fa.cliente || cli?.ragione || cli?.ragioneSociale || cli?.denominazione || cli?.nome || '');
      const cliPiva  = esc(cli?.piva || cli?.pIva || '');
      const cliInd   = esc(cli?.indirizzo || cli?.sedeOperativa || cli?.sedeLegale || '');
      const cliEmail = esc(cli?.email || '');
      const cliTel   = esc(cli?.telefono || '');

      const causale  = esc(fa.causale || '');
      const rifNorm  = esc(fa.rifNormativo || '');
      const note     = esc(fa.note || '');

      // campi globali DDT (se usati)
      const ddtNumero = esc(fa.ddtId || '');
      const ddtData   = esc(fa.ddtData || '');

      // --- righe + totali IVA ----------------------------------------------
      const righe = Array.isArray(fa.righe) ? fa.righe : [];
      const ivaMap = {};
      let imponibile = 0;
      let imposta    = 0;

            // righe per pagina "adattive":
      // - se ci sono molte info (DDT per riga / descrizioni lunghe) stiamo più stretti
      // - altrimenti possiamo metterne di più
      const hasExtraInfo = righe.some(r =>
        r && (
          r.ddtId || r.ddtData ||
          String(r.descrizione || '').length > 80
        )
      );
      // quando ci sono molte info, stiamo ancora più stretti: 9 righe/pagina
      const MAX_ROWS_PER_PAGE = hasExtraInfo ? 8 : 15;

      // elenco DDT a livello documento (deduplicati)
      const ddtRefs = [];
      const ddtSeen = new Set();
      function pushDDTRef(idRaw, dataRaw){
        const id  = String(idRaw || '').trim();
        const dat = String(dataRaw || '').trim();
        if (!id && !dat) return;
        const key = id + '|' + dat;
        if (ddtSeen.has(key)) return;
        ddtSeen.add(key);
        ddtRefs.push({ id, data: dat });
      }

      // 1) eventuale DDT globale sulla fattura
      pushDDTRef(fa.ddtId, fa.ddtData);

      const righeArr = righe.map((r, idx) => {
        const qty = Number(r.qta || 0);
        const pr  = Number(r.prezzo || 0);
        const sc  = Number(r.sconto || r.scontoPerc || 0);
        const iva = Number(r.iva || 0);
        const base = qty * pr * (1 - (sc / 100));

  imponibile += base;
  imposta    += base * iva / 100;
  ivaMap[iva] = (ivaMap[iva] || 0) + base;

  // ➜ qui prendiamo il codice articolo dal magazzino / DDT / commessa
  const cod = esc(
    r.codice
    || r.articoloCodice
    || r.codiceArticolo
    || r.codArticolo
    || ''
  );

  const desc = esc(r.descrizione || '').replace(/\n/g, '<br>');

        const ddtIdRow   = esc(r.ddtId || '');
        const ddtDataRow = esc(r.ddtData || '');
        if (ddtIdRow || ddtDataRow){
          // 2) DDT a livello riga
          pushDDTRef(ddtIdRow, ddtDataRow);
        }

        const qStr  = qty ? fmt2(qty).replace(',00','') : '';
        const scStr = sc  ? fmt2(sc).replace(',00','')  : '';

        const ddtInfo = (ddtIdRow || ddtDataRow)
          ? '<div class="riga-ddt small muted">DDT: '
              + (ddtIdRow ? ddtIdRow : '')
              + (ddtDataRow ? ' del ' + ddtDataRow : '')
            + '</div>'
          : '';

        return (
          '<tr>'
            + '<td class="ctr">'+ (idx + 1) +'</td>'
            + '<td class="code">'+ cod +'</td>'
            + '<td>'+ desc + ddtInfo +'</td>'
            + '<td class="ctr">'+ esc(r.UM || r.um || '') +'</td>'
            + '<td class="ctr">'+ qStr +'</td>'
            + '<td class="num">'+ fmt2(pr) +'</td>'
            + '<td class="ctr">'+ scStr +'</td>'
            + '<td class="num">'+ fmt2(base) +'</td>'
          + '</tr>'
        );
      });

      const totale = imponibile + imposta;

      const ivaRowsHTML = Object.keys(ivaMap)
        .sort((a,b) => Number(a) - Number(b))
        .map(k => {
          const aliq = Number(k || 0);
          const impB = ivaMap[k] || 0;
          const impI = impB * aliq / 100;
          const aliqLbl = aliq > 0
            ? aliq.toFixed(0) + '%'
            : (fa.plafond ? 'Plafond (art. 8 DPR 633/72)' : '0%');
          return (
            '<tr>'
              + '<td class="ctr">'+ aliqLbl +'</td>'
              + '<td class="num">'+ fmt2(impB) +'</td>'
              + '<td class="num">'+ fmt2(impI) +'</td>'
            + '</tr>'
          );
        }).join('') || (
          '<tr><td colspan="3" class="muted ctr">Nessuna IVA</td></tr>'
        );

      // --- header fattura ---------------------------------------------------
      const headerHTML =
        '<div class="header">'
          + '<div class="logo-box">'
            + (logo ? '<img src="'+logo+'" class="logo">' : '')
            + '<div>'
              + '<div class="doc-title">'+ ragAzi +'</div>'
              + '<div class="muted small">'
                + [pivaAzi && ('P.IVA '+pivaAzi), sdi && ('SDI '+sdi)]
                    .filter(Boolean).join(' · ')
              + '</div>'
              + (sedeLeg ? '<div class="muted small">Sede legale: '+ sedeLeg +'</div>' : '')
              + (sedeOp  ? '<div class="muted small">Sede operativa: '+ sedeOp +'</div>' : '')
              + ((emailAzi || telAzi)
                  ? '<div class="muted small">'
                      + [emailAzi, telAzi].filter(Boolean).join(' · ')
                    + '</div>'
                  : '')
              + ((rea || capSoc)
                  ? '<div class="muted small">'
                      + [rea && ('REA: '+rea),
                         capSoc && ('Cap. soc.: '+capSoc)]
                         .filter(Boolean).join(' · ')
                    + '</div>'
                  : '')
            + '</div>'
          + '</div>'
          + '<div class="idbox">'
            + '<div><strong>FATTURA</strong></div>'
            + '<div><strong>'+ esc(fa.id || '') +'</strong></div>'
            + '<div>Data: <strong>'+ esc(fa.data || '') +'</strong></div>'
          + '</div>'
        + '</div>';

      // --- blocco cliente + pagamento --------------------------------------
      const topInfoHTML =
        '<div class="top-info">'
          + '<div class="grid2">'
            + '<div class="box">'
              + '<div class="muted">Cliente</div>'
              + '<div><strong>'+ cliRag +'</strong></div>'
              + (cliInd   ? '<div class="small">'+ cliInd +'</div>' : '')
              + (cliPiva  ? '<div class="muted small">P.IVA: '+ cliPiva +'</div>' : '')
              + ((cliEmail || cliTel)
                  ? '<div class="muted small">'
                      + [cliEmail, cliTel].filter(Boolean).join(' · ')
                    + '</div>'
                  : '')
            + '</div>'
            + '<div class="box">'
              + '<div class="muted">Dati pagamento</div>'
              + (fa.pagamento
                  ? '<div class="small">Pagamento: <strong>'+ esc(fa.pagamento) +'</strong></div>'
                  : '')
              + (
                [bancaInt && ('Intestatario: '+bancaInt),
                 bancaIstit && ('Banca: '+bancaIstit),
                 bancaIban && ('IBAN: '+bancaIban),
                 bancaBic && ('BIC/SWIFT: '+bancaBic)]
                 .filter(Boolean).length
                  ? '<div class="small">'
                      + [bancaInt && ('Intestatario: '+bancaInt),
                         bancaIstit && ('Banca: '+bancaIstit),
                         bancaIban && ('IBAN: '+bancaIban),
                         bancaBic && ('BIC/SWIFT: '+bancaBic)]
                         .filter(Boolean).map(esc).join('<br>')
                    + '</div>'
                  : '')
            + '</div>'
          + '</div>'
          + (causale ? '<div class="box" style="margin-top:6px"><strong>Causale:</strong> '+ causale +'</div>' : '')
          + (rifNorm ? '<div class="box small" style="margin-top:6px"><strong>Rif. normativo:</strong> '+ rifNorm +'</div>' : '')
        + '</div>';

      // blocco riferimenti DDT (document-level)
      const ddtBlockHTML = ddtRefs.length
        ? '<div class="box ddt-block small" style="margin-top:6px">'
            + '<strong>Documento riferito a DDT:</strong><br>'
            + ddtRefs.map(r =>
                'DDT ' + esc(r.id || '') + (r.data ? ' del ' + esc(r.data) : '')
              ).join('<br>')
          + '</div>'
        : '';

      // --- tabella righe ----------------------------------------------------
      const tableHeadHTML =
        '<table class="righe">'
          + '<thead><tr>'
            + '<th style="width:26px" class="ctr">#</th>'
            + '<th style="width:80px" class="code">Codice</th>'
            + '<th>Descrizione</th>'
            + '<th style="width:60px" class="ctr">UM</th>'
            + '<th style="width:70px" class="ctr">Q.tà</th>'
            + '<th style="width:90px" class="num">Prezzo un.</th>'
            + '<th style="width:70px" class="ctr">Sconto %</th>'
            + '<th style="width:100px" class="num">Importo</th>'
          + '</tr></thead>'
          + '<tbody>';

      const tableFootHTML = '</tbody></table>';

      // --- spezza righe in pagine logiche ----------------------------------
      const pagesRows = [];
      if (righeArr.length === 0) {
        pagesRows.push(['<tr><td colspan="8" class="muted ctr">Nessuna riga</td></tr>']);
      } else {
        for (let i = 0; i < righeArr.length; i += MAX_ROWS_PER_PAGE) {
          pagesRows.push(righeArr.slice(i, i + MAX_ROWS_PER_PAGE));
        }
      }

      const totalPages = pagesRows.length;

      function footerHTML(pageIndex){
        return (
          '<div class="footer">'
            + '<div class="box iva-box">'
              + '<div style="font-weight:600; margin-bottom:4px">Riepilogo IVA</div>'
              + '<table>'
                + '<thead><tr>'
                  + '<th class="ctr" style="width:130px">Aliquota</th>'
                  + '<th class="num">Imponibile</th>'
                  + '<th class="num">Imposta</th>'
                + '</tr></thead>'
                + '<tbody>'+ ivaRowsHTML +'</tbody>'
              + '</table>'
            + '</div>'
            + '<div class="box tot-box">'
              + '<div>Imponibile: <span style="float:right">'+ fmt2(imponibile) +'</span></div>'
              + '<div>Imposta IVA: <span style="float:right">'+ fmt2(imposta) +'</span></div>'
              + '<div style="border-top:1px solid #cbd5e1;margin-top:4px;padding-top:4px">'
                + '<strong>Totale: <span style="float:right">'+ fmt2(totale) +'</span></strong>'
              + '</div>'
              + '<div class="pagebox">Pag. '+ (pageIndex + 1) +' / '+ totalPages +'</div>'
            + '</div>'
          + '</div>'
        );
      }

      // --- costruisci pagine -----------------------------------------------
      let pagesHTML = '';
      pagesRows.forEach((rowsHTML, pageIndex) => {
        pagesHTML +=
          '<div class="page">'
            + headerHTML
            + '<div class="content">'
              + topInfoHTML          // 👈 Cliente + Dati pagamento su OGNI pagina
              + tableHeadHTML
              + rowsHTML.join('')
              + tableFootHTML
            + '</div>'
            + footerHTML(pageIndex)
          + '</div>';
      });

      // --- CSS di stampa dedicato alla fattura -----------------------------
      const css =
        '<style>'
        // margini di pagina un po' più stretti sopra/sotto
        + '@page{size:A4;margin:4mm 8mm 8mm 8mm;}'
        + '*{-webkit-print-color-adjust:exact;print-color-adjust:exact;}'
        + 'html,body{margin:0;padding:0;height:100%;}'
        + 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;font-size:12px;}'

        // pagina a altezza fissa con header in alto e footer in basso
        + '.page{page-break-after:always;padding-top:0mm;min-height:277mm;box-sizing:border-box;display:flex;flex-direction:column;}'
        + '.page:last-child{page-break-after:auto;}'

        + '.header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:1px;}'
        + '.logo-box{display:flex;align-items:center;gap:8px;}'
        + '.logo{width:260px;height:260px;object-fit:contain;margin-right:4px;}'
        + '.doc-title{font-size:18px;font-weight:700;letter-spacing:.3px;}'

        + '.muted{color:#64748b;}'
        + '.small{font-size:11px;}'
        + '.box{border:1px solid #cbd5e1;border-radius:8px;padding:6px 8px;}'
        // meno spazio verticale tra intestazione e i due box
        + '.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:0;}'

        + '.top-info{margin-bottom:1px;}'
        + '.ddt-block{margin-top:2px;}'
        + '.content{margin-top:1px;flex:1 0 auto;}'

        + 'table.righe{width:100%;border-collapse:collapse;margin-top:6px;page-break-inside:avoid;}'
        + 'table.righe th,table.righe td{border:1px solid #e5e7eb;padding:5px;vertical-align:top;}'
        + 'table.righe th{background:#f8fafc;}'
        + '.code{font-family:monospace;font-size:11px;}'
        + '.ctr{text-align:center;}'
        + '.num{text-align:right;white-space:nowrap;}'
        + '.riga-ddt{margin-top:2px;}'

        + '.footer{margin-top:auto;padding-top:6px;display:grid;grid-template-columns:1.4fr 1fr;gap:8px;align-items:flex-start;page-break-inside:avoid;}'
        + '.iva-box table{width:100%;border-collapse:collapse;margin-top:4px;}'
        + '.iva-box th,.iva-box td{border:1px solid #e5e7eb;padding:4px 6px;vertical-align:top;}'
        + '.iva-box th{background:#f8fafc;}'

        + '.pagebox{margin-top:6px;font-size:11px;text-align:right;}'

        + '</style>';

      const html =
        '<!doctype html><html><head><meta charset="utf-8">'+ css +'</head><body>'
        + pagesHTML
        + (note ? '<div style="margin-top:8px;font-size:11px" class="small"><strong>Note:</strong> '+ note +'</div>' : '')
        + '</body></html>';

      if (window.safePrintHTMLString) {
        window.safePrintHTMLString(html);
      } else if (global.safePrintHTMLString) {
        global.safePrintHTMLString(html);
      } else {
        const w = window.open('', '_blank');
        if (w) {
          w.document.write(html);
          w.document.close();
          try { w.focus(); w.print(); } catch {}
        }
      }
    }catch(e){
      alert('Errore Fattura: ' + (e && e.message ? e.message : e));
    }
  };
})(window);

// ============= STAMPA FATTURA (A4) — globale =============

// ===== THEME STAMPA UNICO (A4) =====
(function(){
  // CSS comune per DDT / Fatture / Ordini Fornitore
  window.__PRINT_CSS = window.__PRINT_CSS || function(opts = {}){
    const top = Number(opts.top ?? 10);
    const right = Number(opts.right ?? 8);
    const bottom = Number(opts.bottom ?? 10);
    const left = Number(opts.left ?? 8);
    // NB: .pageNum::after neutralizzato: numerazione sempre via JS
    return (
      '<style>'
      + '@page{size:A4;margin:'+top+'mm '+right+'mm '+bottom+'mm '+left+'mm}'
      + '*{-webkit-print-color-adjust:exact;print-color-adjust:exact}'
      + 'html,body{margin:0;padding:0;height:100%}'
      + 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;font-size:13px}'
      + '.content{position:relative}'
      + 'img{max-width:100%;height:auto}'
      + 'table{width:100%;border-collapse:collapse;margin-top:8px;page-break-inside:auto}'
      + 'thead{display:table-header-group}'
      + 'tfoot{display:table-footer-group}'
      + 'th,td{border:1px solid #e5e7eb;padding:6px;vertical-align:top;font-size:13px}'
      + '.ctr{text-align:center}.num{text-align:right}.small{font-size:12px}.muted{color:#64748b}'
      + '.pagebox{position:fixed;right:'+right+'mm;bottom:'+bottom+'mm;font-size:12px;z-index:999;min-width:68px;text-align:right}'
      + '.pageNum::after,.pageX::after{content:"" !important}'
      + '@media screen{th,td{border-color:transparent}}'
      + '</style>'
    );
  };
})();

(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;


  // helper stampa in iframe (riutilizzabile da DDT)
  if (!window.safePrintHTMLString) {
    window.safePrintHTMLString = function(html){
      try{
        var ifr = document.createElement('iframe');
        ifr.style.width = ifr.style.height = 0;
        ifr.style.border = 0;
        document.body.appendChild(ifr);
        var d = ifr.contentWindow.document;
        d.open(); d.write(html); d.close();
        // Fallback numerazione pagina (come DDT)
        try{
          (function(){
            const w = ifr.contentWindow, doc = w.document;
            const pn = doc.querySelector('#pagebox .pageNum') || doc.querySelector('.pageNum');
            if (!pn) return;
                 pn.setAttribute('data-mode','css');
            const pseudo = w.getComputedStyle(pn,'::after').getPropertyValue('content') || '';
           const bad = (!pseudo || !/\d/.test(pseudo));
            if (bad){
             const mmToPx = (function(){
                const t = doc.createElement('div'); t.style.height='100mm'; t.style.position='absolute'; t.style.visibility='hidden';
                doc.body.appendChild(t); const px=t.getBoundingClientRect().height||0; t.remove();
                return px/100;
              })();
              const pageHeightMm = 297 - (16 + 22);
              const pageHeightPx = (mmToPx>0) ? (mmToPx * pageHeightMm) : (w.innerHeight || 1123);
              const content = doc.querySelector('.content') || doc.body;
              const h = Math.max(content.scrollHeight, content.offsetHeight, doc.body.scrollHeight);
              const total = Math.max(1, Math.ceil(h / pageHeightPx));
              pn.textContent = `1 / ${total}`;
            }
         })();
        }catch{}

        setTimeout(function(){
          try{ if (ifr.contentWindow){ ifr.contentWindow.focus(); ifr.contentWindow.print(); } }catch{}
          setTimeout(function(){ try{ ifr.remove(); }catch{} }, 350);
        }, 150);
      }catch(e){ alert('Errore stampa: ' + (e?.message || e)); }
    };
  }

  function esc(s){ return String(s==null?'':s).replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c])); }
  function fmt2(n){ n=Number(n||0); return n.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // Prova a ricavare un rif. DDT globale da fa.note (prefill standard "Rif. DDT XXX")
  function parseDDTRefFromNote(note){
    const m = /Rif\.?\s*DDT\s*([A-Za-z0-9\-_/]+)/i.exec(String(note||''));
    return m ? m[1] : '';
  }

  window.__printFatturaLegacy = function(fa){
    try{
      // ---- app settings (logo, intestazione, bancari) ----
      var app = {};
      try { app = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch {}
      var logo  = app.logoDataUrl || '';
      var rag   = app.ragioneSociale || '';
      var piva  = app.piva || app.pIva || '';
      var sedeL = app.sedeLegale || '';
      var sedeO = app.sedeOperativa || '';
      var email = app.email || '';
      var tel   = app.telefono || '';
      var rea   = app.rea || '';
      var cap   = app.capitaleSociale || app.capitale || '';
      var sdi   = app.sdi || app.codiceSdi || '';
      var bank  = app.bankName || '';
      var holder= app.bankHolder || '';
      var iban  = app.iban || '';
      var bic   = app.bic || '';

      // ---- Cliente (stampa cortesia) ----
      // se in anagrafica: P.IVA, indirizzo, mail e telefono
      var cliAll = [];
      try { cliAll = JSON.parse(localStorage.getItem('clientiRows')||'[]')||[]; } catch {}
      var cli = cliAll.find(c=> String(c.id)===String(fa.clienteId||'')) || {};
      var cliPiva = cli.piva || cli.pIva || '';
      var cliAddr = cli.indirizzo || cli.sedeOperativa || cli.sedeLegale || '';
      var cliMail = cli.email || '';
      var cliTel  = cli.telefono || '';

      // ---- righe + totali per aliquota ----
      var righe = Array.isArray(fa.righe) ? fa.righe : [];
      var ivaMap = {}; // {aliquota: imponibile}
      var imponibile=0, imposta=0;

      // rif DDT (globale) se non è presente per singola riga
      var ddtRefGlobal = parseDDTRefFromNote(fa.note);

      var righeHTML = righe.map(function(r, i){
        var q   = Number(r.qta||0);
        var pu  = Number(r.prezzo||0);
        var iva = Number(r.iva||0);
        var scp = Number(r.scontoPerc||r.sconto||0); // % opzionale
        if (!isFinite(scp)) scp = 0;
        var impon = q * pu * (1 - scp/100);
        imponibile += impon;
        imposta    += impon * iva/100;
        ivaMap[iva] = (ivaMap[iva]||0) + impon;

        // rif DDT per riga: usa r.ddtId/r.ddtRef/r.ddtData se presenti, altrimenti globale
        var ddtRiga = r.ddtId || r.ddtRef || ddtRefGlobal || '';
        var ddtData = r.ddtData || '';

        // descrizione + eventuale riga “rif. DDT …” sotto
        var descrBlock = esc(r.descrizione||'');
        if (ddtRiga) {
          descrBlock += '<div class="muted small">Rif. DDT: ' + esc(ddtRiga) + (ddtData ? (' del ' + esc(ddtData)) : '') + '</div>';
        }

        return (
          '<tr>'
          + '<td class="ctr">'+(i+1)+'</td>'
          + '<td>'+ descrBlock +'</td>'
          + '<td class="ctr">'+esc(r.UM||r.um||'')+'</td>'
          + '<td class="ctr">'+(q||'')+'</td>'
          + '<td class="num">'+fmt2(pu)+'</td>'
          + '<td class="ctr">'+(scp? fmt2(scp).replace(',00','') : '')+'</td>'
          + '<td class="num">'+fmt2(impon)+'</td>'
          + '</tr>'
        );
      }).join('');

      if (!righeHTML) {
        righeHTML = '<tr><td colspan="7" class="muted">— Nessuna riga —</td></tr>';
      }

      var totale = imponibile + imposta;

      // Riepilogo IVA (sempre visibile)
      var ivaRows = Object.keys(ivaMap).map(function(k){
        var aliq = Number(k||0);
        var base = ivaMap[k]||0;
        var imp  = base*aliq/100;
        return '<tr>'
          + '<td class="ctr">'+ (aliq===0 ? 'Esente/0%' : (aliq + '%')) +'</td>'
          + '<td class="num">'+fmt2(base)+'</td>'
          + '<td class="num">'+fmt2(imp)+'</td>'
          + '</tr>';
      }).join('');
      if (!ivaRows) ivaRows = '<tr><td class="ctr">—</td><td class="num">0,00</td><td class="num">0,00</td></tr>';

      // Nota plafond: sotto “Aliquota”, scriviamo la dicitura legale al posto della % quando aliq=0
      // (la riga sopra già mostra “Esente/0%”; se vuoi il testo normativo pieno sostituisci qui).
      // Esempio comune per plafond: “N3.5 – Operazioni non imponibili a seguito di dichiarazione d’intento (art. 8, c. 1, lett. c, DPR 633/72)”
      var naturaText = (fa.plafond && (fa.naturaIva || 'N3.5 – Operazioni non imponibili a seguito di dichiarazione d’intento (art. 8, c.1, lett. c, DPR 633/72)')) || '';

      // CSS + HTML
      var css = window.__PRINT_CSS({ top:10, right:8, bottom:8, left:8 });

      css += `<style>
  /* Header: permetti wrap e riduci logo */
  .hdr{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap}
  .brand{display:flex; align-items:center; gap:10px; flex:1 1 auto}
  .brand .logo{max-height:90px; width:auto; object-fit:contain}
  .doc{border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; min-width:240px; text-align:right} /* prima 210px */
  .az .muted{color:#64748b}

  /* Tabelle e box come prima */
  .box{border:1px solid #cbd5e1;border-radius:8px;padding:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
  .totgrid{display:grid;grid-template-columns:1fr 260px;gap:10px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  thead{display:table-header-group}
  th,td{border:1px solid #e5e7eb;padding:6px;vertical-align:top}
  th{background:#f8fafc}.ctr{text-align:center}.num{text-align:right}

  /* Footer: numeratore dentro il footer, non flottante */
    .footer{
    position:fixed;
    left:8mm;
    right:8mm;
    bottom:6mm;                 /* un filo più giù (prima era 8mm) */
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10mm;                   /* spazio tra blocco totali e blocco banca */
  }
  .footer .pagebox{position:static; margin-left:auto; font-weight:700}
  .hdr img.logo{max-height:90px !important;width:auto;object-fit:contain;}
</style>`;


      var header =
        '<div class="hdr">'
          + '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'
            + (logo ? '<img class="logo" src="'+logo+'" alt="logo">' : '')
            + '<div>'
              + '<div style="font-size:20px;font-weight:800">'+esc(rag)+'</div>'
              + (piva ? '<div class="small">P.IVA: '+esc(piva)+'</div>' : '')
              + (sedeL ? '<div class="small">'+esc(sedeL)+'</div>' : '')
              + (sedeO ? '<div class="small">'+esc(sedeO)+'</div>' : '')
              + (sdi   ? '<div class="small">Codice SDI: '+esc(sdi)+'</div>' : '')
              + (rea   ? '<div class="small">REA: '+esc(rea)+'</div>' : '')
              + (cap   ? '<div class="small">Capitale Sociale: '+esc(cap)+'</div>' : '')
            + '</div>'
          + '</div>'
          + '<div class="idbox">'
            + '<div><strong>FATTURA</strong></div>'
            + '<div><strong>'+esc(fa.id||'')+'</strong></div>'
            + '<div>Data: <strong>'+esc(fa.data||'')+'</strong></div>'
          + '</div>'
        + '</div>';

      var clienteBox =
        '<div class="grid2">'
          + '<div class="box">'
            + '<div class="muted">Cliente</div>'
            + '<div><strong>'+esc(fa.cliente||'')+'</strong></div>'
            + (cliPiva ? '<div class="small">P.IVA: '+esc(cliPiva)+'</div>' : '')
            + (cliAddr ? '<div class="small">'+esc(cliAddr)+'</div>' : '')
            + (cliMail ? '<div class="small">'+esc(cliMail)+'</div>' : '')
            + (cliTel  ? '<div class="small">'+esc(cliTel)+'</div>' : '')
          + '</div>'
          + '<div class="box">'
            + (fa.pagamento ? '<div>Pagamento: <strong>'+esc(fa.pagamento)+'</strong></div>' : '')
            + (fa.iban ? '<div>IBAN: <strong>'+esc(fa.iban)+'</strong></div>' : '')
            + (fa.codiceUnivoco ? '<div class="small">CUU/SDI cliente: '+esc(fa.codiceUnivoco)+'</div>' : '')
            + (fa.pec ? '<div class="small">PEC cliente: '+esc(fa.pec)+'</div>' : '')
            + (fa.plafond && naturaText ? '<div class="small muted" style="margin-top:4px">Natura IVA: '+esc(naturaText)+'</div>' : '')
          + '</div>'
        + '</div>';

      var causaleBlock = (fa.causale ? ('<div class="box small" style="margin:8px 0 4px 0"><strong>Causale: </strong>'+esc(fa.causale)+'</div>') : '');

      var table =
        '<table>'
          + '<thead><tr>'
            + '<th style="width:28px" class="ctr">#</th>'
            + '<th>Descrizione</th>'
            + '<th style="width:56px" class="ctr">UM</th>'
            + '<th style="width:70px" class="ctr">Q.tà</th>'
            + '<th style="width:100px" class="num">Prezzo un.</th>'
            + '<th style="width:80px" class="ctr">Sconto %</th>'
            + '<th style="width:110px" class="num">Importo</th>'
          + '</tr></thead>'
          + '<tbody>'+righeHTML+'</tbody>'
        + '</table>';

      var footer =
        '<div class="footer">'
          + '<div class="totgrid">'
            + '<div class="box">'
              + '<div style="font-weight:600;margin-bottom:6px">Riepilogo IVA</div>'
              + '<table style="width:100%;border-collapse:collapse">'
                + '<thead><tr>'
                  + '<th class="ctr" style="width:90px">Aliquota</th>'
                  + '<th>Imponibile</th>'
                  + '<th>Imposta</th>'
                + '</tr></thead>'
                + '<tbody>'+ivaRows+'</tbody>'
              + '</table>'
              + (fa.plafond && naturaText ? '<div class="small muted" style="margin-top:6px">'+esc(naturaText)+'</div>' : '')
            + '</div>'
            + '<div class="box">'
              + '<div>Imponibile: <span style="float:right">'+fmt2(imponibile)+'</span></div>'
              + '<div>Imposta IVA: <span style="float:right">'+fmt2(imposta)+'</span></div>'
              + '<div style="border-top:1px solid #cbd5e1;margin-top:6px;padding-top:6px">'
                + '<strong>Totale: <span style="float:right">'+fmt2(totale)+'</span></strong>'
              + '</div>'
            + '</div>'
          + '</div>'
          + (
            (bank || holder || iban || bic)
                ? '<div class="small" style="margin-top:8px; padding-left:4mm">'
                + (bank ? '<div>Banca: <strong>'+esc(bank)+'</strong></div>' : '')
                + (holder ? '<div>Intestatario: <strong>'+esc(holder)+'</strong></div>' : '')
                + (iban ? '<div>IBAN: <strong>'+esc(iban)+'</strong></div>' : '')
                + (bic ? '<div>BIC/SWIFT: <strong>'+esc(bic)+'</strong></div>' : '')
                + '</div>'
              : ''
            )
        + '</div>';

      // aggiungo una piccola regola per il wrapper .content
      css += '<style>.content{position:relative}.pageNum::after,.pageX::after{content:"" !important}</style>';

      var html = '<!doctype html><html><head><meta charset="utf-8">'+css+'</head><body>'
        + '<div class="content">'     // <-- WRAPPER MISURABILE
        +   header
        +   clienteBox 
        +   causaleBlock
        +   table
        + '</div>'                     // <-- FINE WRAPPER
        + footer
        + '</body></html>';

        if (window.safePrintHTMLStringWithPageNum) {
          window.safePrintHTMLStringWithPageNum(html);
        } else if (window.safePrintHTMLString) {
          window.safePrintHTMLString(html);
        }

      }catch(e){
      alert('Errore Fattura: ' + (e?.message || e));
    }
  };

})(); 

// === PATCH B2 — shim printFattura (se mancasse) ===
(function(){
  if (typeof window.printFattura !== 'function' && typeof window.generateFatturaHTML === 'function') {
    window.printFattura = function(fa){
      try {
        const html = window.generateFatturaHTML(fa);
        if (!html) throw new Error('generateFatturaHTML ha restituito stringa vuota');
        (window.safePrintHTMLStringWithPageNum || window.safePrintHTMLString)(html);
      } catch(e) { alert('Errore stampa Fattura: ' + (e?.message || e)); }
    };
  }
})();

/* ================== MODAL: Ricevi da Ordine Fornitore ================== */
function RiceviDaOrdineModal({ ordine, riga, onClose, onConfirm }) {
  const e = React.createElement;
  const [qta, setQta] = React.useState(() => Math.max(0, Number(riga.qta || 0) - Number(riga.qtaRicevuta||0)));
  const [data, setData] = React.useState(()=> new Date().toISOString().slice(0,10));
  const [ddt, setDDT] = React.useState('');
  const [note, setNote] = React.useState('');
  const [updCMP, setUpdCMP] = React.useState(()=>{
  try { return !!(JSON.parse(localStorage.getItem('appSettings')||'{}')||{}).magUpdateCMP; }
  catch { return false; }
  });


  const residuo = Math.max(0, Number(riga.qta||0) - Number(riga.qtaRicevuta||0));
  const max = residuo;

  return e('div', { className:'modal-backdrop' },
    e('div', { className:'modal-card' },
      e('h3', null, `Ricezione — ${riga.codice||''}`),
      e('div', { className:'row', style:{gap:8} },
        e('div', null, `Ordinato: ${riga.qta||0}`),
        e('div', null, `Ricevuto: ${riga.qtaRicevuta||0}`),
        e('div', null, `Residuo: ${residuo}`)
      ),
      e('div', { className:'row', style:{gap:8, marginTop:8} },
        e('label', null, 'Data: ',
          e('input', { type:'date', value:data, onChange:ev=>setData(ev.target.value) })
        ),
        e('label', null, 'DDT fornitore: ',
          e('input', { value:ddt, onChange:ev=>setDDT(ev.target.value), placeholder:'n./data DDT' })
        ),
        e('label', null, 'Qta da ricevere: ',
          e('input', {
            type:'number', step:'0.01', min:0, max,
            value:qta, onChange:ev=>setQta(Math.max(0, Math.min(max, Number(ev.target.value))))
          })
        ),
        e('label', null,
          e('input', { type:'checkbox', checked:updCMP, onChange:ev=>setUpdCMP(ev.target.checked) }),
          ' Aggiorna CMP'
        )
      ),
      e('div', { className:'row', style:{gap:8, marginTop:12, justifyContent:'flex-end'} },
        e('button', { className:'btn', onClick:onClose }, 'Annulla'),
        e('button', {
          className:'btn btn-primary',
          onClick:()=> onConfirm({ qta, data, ddtFornitore: ddt, note, updateCMP: updCMP })
        }, 'Conferma')
      )
    )
  );
}

/* ================== ORDINI FORNITORI (OF-YYYY-NNN) — con RICEZIONE & ALLEGATI SMART ================== */
function OrdiniFornitoriView({ query = '' }) {
  const e = React.createElement;

  const PAGAMENTI_FORNITORE = [
    'Bonifico vista fattura',
    'Bonifico 30gg FM',
    'Bonifico 60gg FM',
    'RiBa 30gg',
    'RiBa 30-60gg',
    'RiBa 30-60-90gg',
    'RiBa 60gg'
  ];

  const ORD_KEY = window.__OF_KEY || (window.__OF_KEY = 'ordiniFornitoriRows');
  const readOnly = (typeof window.isReadOnlyUser === 'function' ? !!window.isReadOnlyUser() : !!(window.__USER && window.__USER.role === 'accountant'));
  
  const lsGet = window.lsGet || ((k,d)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return (v??d);}catch{return d;}});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} });
  const formatNNN = window.formatNNN || (n=>String(n).padStart(3,'0'));
  
  const { ART_KEY } = (window.__MAG_KEYS__||{ART_KEY:'magazzinoArticoli'});
  const appSettings = lsGet('appSettings', {}) || {};
  const DEFAULT_IVA = Number(appSettings.defaultIva) || 22;
  const FORN_KEY = 'fornitoriRows';
  const ARTK = ART_KEY;

  // Utils
  const today = ()=> new Date().toISOString().slice(0,10);
  const clone = o => JSON.parse(JSON.stringify(o));
  const num = v => Number(v||0);
  const residuoRiga = r => Math.max(0, num(r.qta) - num(r.qtaRicevuta));

  const totaleDocImponibile = o => (o?.righe||[]).reduce((s,r)=> s + (num(r.qta)*num(r.prezzo)), 0);
  const totaleDocIvato = o => (o?.righe||[]).reduce((s,r)=>{
    const imp = num(r.qta)*num(r.prezzo);
    const ivaPerc = num(r.iva != null ? r.iva : DEFAULT_IVA);
    return s + imp * (1 + ivaPerc/100);
  }, 0);

  // Stato
  const [rows, setRows] = React.useState(()=> lsGet(ORD_KEY, []));

  React.useEffect(()=>{
    try{ lsSet(ORD_KEY, rows); }catch{}
    try{ if (window.api?.kv?.set) window.api.kv.set('ordiniFornitoriRows', rows); }catch{}
  },[rows]);

  const [q, setQ] = React.useState(query||'');
  const [filtroStato, setFiltroStato] = React.useState('TUTTI'); 
  const [showForm, setShowForm] = React.useState(false);
  const [draft, setDraft] = React.useState(null);
  
  // Stato form allegati smart
  const [allegatoOFForm, setAllegatoOFForm] = React.useState({ tipo: 'CONFERMA_ORDINE', descrizione: '', path: '', url: '' });

  // Dropdown articoli
  const [openArtMenuRow, setOpenArtMenuRow] = React.useState(null);
  const [artMenuQuery, setArtMenuQuery] = React.useState('');

  React.useEffect(()=>{
    function onDocDown(ev){
      try{
        const t = ev.target;
        const inside = t && t.closest && t.closest('.of-codice-input, .of-artmenu');
        if (!inside) setOpenArtMenuRow(null);
      }catch{ setOpenArtMenuRow(null); }
    }
    document.addEventListener('mousedown', onDocDown, true);
    return ()=>document.removeEventListener('mousedown', onDocDown, true);
  },[]);

  const fornitori = lsGet(FORN_KEY, []);
  const articoliNew = lsGet(ARTK, []);
  const articoliOld = lsGet('magArticoli', []);
  const articoli  = (Array.isArray(articoliNew) && articoliNew.length) ? articoliNew : (Array.isArray(articoliOld) ? articoliOld : []);
  
  const filteredArticoli = React.useMemo(()=>{
    const arr = Array.isArray(articoli) ? articoli : [];
    const qx = String(artMenuQuery||'').trim().toLowerCase();
    if (!qx) return arr.slice(0,20);
    return arr.filter(a=>{
      const cod = String(a.codice||a.id||'').toLowerCase();
      const des = String(a.descrizione||a.nome||'').toLowerCase();
      return cod.includes(qx) || des.includes(qx);
    }).slice(0,20);
  },[articoli, artMenuQuery]);

  // CRUD
  async function startNew(){
    const idObj = (typeof window.nextIdOF === 'function') ? await window.nextIdOF() : { id: `OF-${new Date().getFullYear()}-${formatNNN(1)}` };
    setDraft({
      id: idObj.id, data: today(),
      fornitoreId: null, fornitoreRagione: '',
      rifOrdine: '', consegnaPrevista: today(),
      stato: 'Bozza', note: '',
      righe: [],
      condizioniPagamento: PAGAMENTI_FORNITORE[0],
      nsRiferimento: '',
      confermaFileDataUrl: '', confermaFileName: '',
      __createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
    });
    setShowForm(true);
  }

  function startEdit(r){ setDraft(clone(r)); setShowForm(true); }

  async function removeRow(id){
    if (!confirm('Eliminare ordine?')) return;
    let all = [];
    try { all = lsGet(ORD_KEY, []) || []; } catch { all = []; }
    const nowISO = new Date().toISOString();
    const next = (Array.isArray(all) ? all : []).map(x => {
      if (!x || String(x?.id || '') !== String(id)) return x;
      const clone = { ...x }; clone.deletedAt = nowISO; clone.updatedAt = nowISO; return clone;
    });
    lsSet(ORD_KEY, next);
    setRows(next);
    try { window.syncExportToCloudOnly && window.syncExportToCloudOnly(['ordiniFornitoriRows']); } catch {}
  }

  async function duplicaOrdine(ofOrig){
    if (!ofOrig || !ofOrig.id) return;
    const idObj = (typeof window.nextIdOF === 'function') ? await window.nextIdOF() : { id: `OF-${new Date().getFullYear()}-${formatNNN(1)}` };
    const copy = clone(ofOrig);
    copy.id = idObj.id; copy.stato = 'Bozza';
    copy.righe = (Array.isArray(copy.righe) ? copy.righe : []).map(r => ({ ...r, qtaRicevuta: 0 }));
    const now = new Date().toISOString(); copy.__createdAt = now; copy.updatedAt = now;
    const nextRows = [...rows, copy];
    lsSet(ORD_KEY, nextRows);
    setRows(nextRows);
    setFiltroStato('TUTTI'); setQ('');
    alert('Ordine duplicato: ' + copy.id);
  }

  async function saveDraft(docOverride){
    const now = new Date().toISOString();

    // Se chiamata da onClick diretto, React passa l'evento: ignoralo
    let base = docOverride;

    // 1) Eventi React / browser (evita JSON.stringify su oggetti con riferimenti circolari)
    const looksLikeEvent = base && typeof base === 'object' && (
      typeof base.preventDefault === 'function' ||
      typeof base.stopPropagation === 'function' ||
      !!base.nativeEvent ||
      !!base.currentTarget ||
      !!base.target
    );

    // 2) DOM Node passato per errore (es. HTMLButtonElement): anche questo può creare "circular"
    const looksLikeDOMNode = base && typeof base === 'object' && (
      (base.nodeType === 1) || (base.nodeType === 9) || (base.nodeType === 11) // Element / Document / Fragment
    );

    if (looksLikeEvent || looksLikeDOMNode) base = null;

    base = base || draft;
    if (!base) return;
    const doc = JSON.parse(JSON.stringify(base));
    if (!doc.id) {
      const idObj = (typeof window.nextIdOF === 'function') ? await window.nextIdOF() : { id:`OF-${new Date().getFullYear()}-001` };
      doc.id = idObj.id;
    }
    doc.updatedAt = now;
    
    // Stato auto
    const righe = doc.righe || [];
    if (righe.length) {
       const totOrd = righe.reduce((s,r)=>s+num(r.qta),0);
       const totRx = righe.reduce((s,r)=>s+num(r.qtaRicevuta),0);
       if (totOrd>0 && totRx>=totOrd) doc.stato='Chiuso';
       else if (totRx>0) doc.stato='Parziale';
    }

    setRows(prev => {
      const arr = Array.isArray(prev) ? JSON.parse(JSON.stringify(prev)) : [];
      const j = arr.findIndex(x => String(x?.id||'') === String(doc.id||''));
      if (j >= 0) arr[j] = doc; else arr.push(doc);
      try { lsSet(ORD_KEY, arr); } catch {}
      return arr;
    });

    setShowForm(false);
    setDraft(null);
    setFiltroStato('TUTTI'); setQ('');
    try{ window.syncExportToCloud && window.syncExportToCloud(); }catch{}
  }

  // Righe editing
  function addRiga(){
    const d = clone(draft); d.righe = d.righe || [];
    d.righe.push({ codice:'', descr:'', um:'', qta:1, prezzo:0, iva: DEFAULT_IVA, qtaRicevuta:0 });
    setDraft(d);
  }
  function updRiga(i, patch){ const d=clone(draft); d.righe[i]={...d.righe[i], ...patch}; setDraft(d); }
  function delRiga(i){ const d=clone(draft); d.righe.splice(i,1); setDraft(d); }
  function pickArticolo(i, codice){
    const a = (articoli||[]).find(x => (x.codice||x.id) === codice);
    if (!a) { updRiga(i, { codice }); return; }
    updRiga(i,{
      codice: (a.codice||a.id), descr: (a.descrizione||a.nome||''), um: (a.um||a.unita||''),
      prezzo: num(a.costo)||num(a.cmp)||0, iva: (typeof a.iva === 'number' ? a.iva : DEFAULT_IVA)
    });
  }

  // Ricezione
  const [rx, setRx] = React.useState(null);
  function apriRicezione(i){ setRx({ indexRiga:i }); }
  function confermaRicezione({ qta, data, ddtFornitore, note, updateCMP }){
    if (!draft || rx==null) return;
    const i = rx.indexRiga; const r = draft.righe[i];
    const take = Math.max(0, Math.min(residuoRiga(r), Number(qta||0)));
    if (take<=0) { setRx(null); return; }
    window.creaMovimentoCaricoDaOrdine(draft, [{ codice: r.codice, qta: take, prezzo: num(r.prezzo) }], { data, ddtFornitore, note, updateCMP });
    updRiga(i, { qtaRicevuta: num(r.qtaRicevuta)+take });
    setRx(null);
  }
  function riceviTutto(i){
    if (!draft) return;
    const r = draft.righe[i]; const res = residuoRiga(r);
    if (res<=0) return;
    window.creaMovimentoCaricoDaOrdine(draft, [{ codice: r.codice, qta: res, prezzo: num(r.prezzo)}], { data: today() });
    updRiga(i, { qtaRicevuta: num(r.qtaRicevuta)+res });
  }
  function riceviOrdineIntero(){
    if (!draft) return;
    const righe = (draft.righe||[]).map(r => {
      const res = Math.max(0, num(r.qta) - num(r.qtaRicevuta));
      return res>0 ? { codice: String(r.codice||'').trim(), qta: res, prezzo: num(r.prezzo) } : null;
    }).filter(Boolean);
    if (!righe.length) { alert('Nessun residuo.'); return; }
    if (!confirm(`Ricevere tutto il residuo? (${righe.length} righe)`)) return;
    window.creaMovimentoCaricoDaOrdine(draft, righe, { data: today().slice(0,10) });
    const d = clone(draft);
    d.righe = d.righe.map(r => { const res = Math.max(0, num(r.qta)-num(r.qtaRicevuta)); return res>0 ? {...r, qtaRicevuta: num(r.qtaRicevuta)+res} : r; });
    d.stato = 'Chiuso'; // auto-close
    saveDraft(d);
  }

  // Lista
  const compareOF = (a,b)=>{
    const ra = String(a.id||'').match(/^OF-(\d{4})-(\d{3})$/);
    const rb = String(b.id||'').match(/^OF-(\d{4})-(\d{3})$/);
    if (ra && rb){
      if (+rb[1]!==+ra[1]) return +rb[1]-+ra[1];
      if (+rb[2]!==+ra[2]) return +rb[2]-+ra[2];
    }
    return String(b.id||'').localeCompare(String(a.id||''));
  };

  const frows = (rows||[]).filter(r => !r?.deletedAt).map(o => ({ ...o, statoCalc: (function(){
    const righe = o?.righe || [];
    if (!righe.length) return o.stato || 'Bozza';
    const totOrd = righe.reduce((s,r)=> s + num(r.qta), 0);
    const totRx  = righe.reduce((s,r)=> s + num(r.qtaRicevuta), 0);
    if (totOrd>0 && totRx>=totOrd) return 'Chiuso';
    if (totRx>0) return 'Parziale';
    return o.stato || 'Bozza';
  })()})).filter(r=>{
    const s=(q||'').toLowerCase().trim(); if(!s) return true;
    const hay = [r.id, r.data, r.stato, r.statoCalc, r.rifOrdine, r.fornitoreRagione].concat((r.righe||[]).map(x=>x.codice)).join(' ').toLowerCase();
    return hay.includes(s);
  }).filter(r=>{
    if (filtroStato==='TUTTI') return true;
    if (filtroStato==='CHIUSI') return r.statoCalc==='Chiuso';
    if (filtroStato==='PARZIALI') return r.statoCalc==='Parziale';
    if (filtroStato==='APERTI') return r.statoCalc!=='Chiuso';
    return true;
  }).sort(compareOF);

  // Render
  return e('div', { className:'container' },
    e('div', { className:'row', style:{alignItems:'center', gap:12, marginBottom:12} },
      e('h2', null, `Ordini Fornitori (${frows.length})`),
      e('div', { style:{flex:1} }),
      e('select', { value:filtroStato, onChange:ev=>setFiltroStato(ev.target.value), style:{minWidth:150} },
        e('option', {value:'TUTTI'}, 'Tutti'), e('option', {value:'APERTI'}, 'Aperti'), e('option', {value:'PARZIALI'}, 'Parziali'), e('option', {value:'CHIUSI'}, 'Chiusi')
      ),
      e('input', { placeholder:'Cerca…', value:q, onChange:ev=>setQ(ev.target.value), style:{minWidth:220} }),
      e('button', { className:'btn', onClick:startNew, ...window.roProps() }, '➕ Nuovo ordine'),
      e('button', { className:'btn btn-outline', onClick: ()=> window.exportOrdiniApertiCSV && window.exportOrdiniApertiCSV() }, '⬇️ CSV aperti'),
      e('button', { className:'btn btn-outline', onClick: ()=>{ setQ(''); setFiltroStato('TUTTI'); }}, '↺ Reset')
    ),

    e('div', { className:'table-wrap' },
      e('table', { className:'table' },
        e('thead', null, e('tr', null, e('th', null, 'ID'), e('th', null, 'Data'), e('th', null, 'Fornitore'), e('th', null, '#Righe'), e('th', null, 'Totale'), e('th', null, 'Stato'), e('th', null, 'Azioni'))),
        e('tbody', null, frows.length ? frows.map(r => 
          e('tr', { key: r.id },
            e('td', null, r.id),
            e('td', null, r.data || ''),
            e('td', null, r.fornitoreRagione || r.fornitoreId || ''),
            e('td', null, (r.righe || []).length),
            e('td', null, (totaleDocIvato(r)).toFixed(2)),
            e('td', null, r.statoCalc || r.stato || 'Bozza'),
            e('td', null,
              e('button', { className:'btn btn-sm', onClick:()=>startEdit(r), disabled: readOnly }, '✏️'), ' ',
              e('button', { className:'btn btn-sm', onClick:()=>duplicaOrdine(r), disabled: readOnly }, '⧉'), ' ',
              e('button', { className:'btn btn-sm', onClick:()=>window.printOrdineFornitore && window.printOrdineFornitore(r) }, '🖨️'), ' ',
              !readOnly && e('button', { className:'btn btn-sm btn-danger', onClick:()=>removeRow(r.id) }, '🗑️')
            )
          )
        ) : e('tr', null, e('td', { colSpan: 7, className: 'muted' }, 'Nessun ordine.')))
      )
    ),

    // FORM MODALE
    showForm && e('div', { className:'modal-backdrop' },
      e('div', { className:'modal-card', style:{maxWidth:1200, width:'100%'} },
        e('h3', null, draft.id ? `Ordine ${draft.id}` : 'Nuovo Ordine'),
        e('fieldset', { disabled: readOnly },
          // Header
          e('div', { className:'form', style:{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(260px, 1fr))', gap:12} },
            e('div', {className:'form-group-title', style:{gridColumn:'1/-1'}}, 'Dati ordine'),
            e('div', null, e('label', null, 'Data'), e('input', { type:'date', value:draft.data, onChange:ev=>setDraft({...draft, data:ev.target.value}) })),
            e('div', null, e('label', null, 'Fornitore'), fornitori.length ? e('select', { value: draft.fornitoreId || '', onChange: ev => { const id=ev.target.value; const f=fornitori.find(x=>String(x.id)===String(id)); setDraft(p=>({...p, fornitoreId:id, fornitoreRagione:f?(f.ragione||f.ragioneSociale):''})); }}, e('option',{value:''},'—'), ...fornitori.map(f=>e('option',{key:f.id,value:f.id},f.ragione||f.ragioneSociale))) : e('a', {href:'#/fornitori'}, 'Crea fornitore...')),
            e('div', null, e('label', null, 'Pagamento'), e('select', { value: draft.condizioniPagamento||'', onChange: ev=>setDraft({...draft, condizioniPagamento:ev.target.value}) }, PAGAMENTI_FORNITORE.map(opt=>e('option',{key:opt,value:opt},opt)))),
            e('div', null, e('label', null, 'Consegna prevista'), e('input', { type:'date', value:draft.consegnaPrevista||'', onChange:ev=>setDraft({...draft, consegnaPrevista:ev.target.value}) })),
            e('div', {style:{gridColumn:'1/-1'}}, e('label', null, 'NS Riferimento'), e('input', { value:draft.nsRiferimento||'', onChange:ev=>setDraft({...draft, nsRiferimento:ev.target.value}) })),
            e('div', {style:{gridColumn:'1/-1'}}, e('label', null, 'Riferimento fornitore'), e('input', { value:draft.rifOrdine||'', onChange:ev=>setDraft({...draft, rifOrdine:ev.target.value}) })),
            e('div', null, e('label', null, 'Stato'), e('select', { value:draft.stato, onChange:ev=>setDraft({...draft, stato:ev.target.value}) }, ['Bozza','Inviato','Confermato','Parziale','Chiuso','Annullato'].map(s=>e('option',{key:s,value:s},s))))
          ),
          
          // Tabella Righe
          e('div', { style:{marginTop:12} },
            articoli.length ? e('datalist', { id:'of-articoli-list' }, articoli.map(a=>e('option',{key:a.codice||a.id, value:a.codice||a.id}, (a.codice||a.id)+' - '+(a.descrizione||a.nome)))) : null,
            e('table', { className:'table' },
              e('thead', null, e('tr', null, e('th', null, '#'), e('th', null, 'Codice'), e('th', null, 'Descrizione'), e('th', null, 'UM'), e('th', null, 'Qta Ord'), e('th', null, 'Ricevuto'), e('th', null, 'Residuo'), e('th', null, 'Prezzo'), e('th', null, 'IVA'), e('th', null, 'Totale'), e('th', null, ''))),
              e('tbody', null, (draft.righe||[]).map((r,i)=> e('tr', { key:i },
                e('td', null, String(i+1)),
                e('td', null, e('div', { style:{ position:'relative' } },
                   e('input', { className:'of-codice-input', list: articoli.length?'of-articoli-list':null, value: r.codice||'', 
                      onFocus:ev=>{ setOpenArtMenuRow(i); setArtMenuQuery(ev.target.value); },
                      onClick:ev=>{ setOpenArtMenuRow(i); setArtMenuQuery(ev.target.value); },
                      onChange:ev=>{ const c=ev.target.value; setArtMenuQuery(c); setOpenArtMenuRow(i); pickArticolo(i,c); }
                   }),
                   (openArtMenuRow===i && filteredArticoli.length>0) ? e('div', { className:'of-artmenu', style:{position:'absolute', zIndex:60, top:'100%', left:0, right:0, maxHeight:200, overflow:'auto', background:'#fff', border:'1px solid #ccc'} },
                      filteredArticoli.map(a=>e('div', { key:a.codice||a.id, style:{padding:6, cursor:'pointer'}, onMouseDown:ev=>{ ev.preventDefault(); pickArticolo(i, a.codice||a.id); setOpenArtMenuRow(null); } }, `${a.codice||a.id} - ${a.descrizione}`))
                   ) : null
                )),
                e('td', null, e('input', { value:r.descr||'', onChange:ev=>updRiga(i,{descr:ev.target.value}) })),
                e('td', null, e('input', { value:r.um||'', onChange:ev=>updRiga(i,{um:ev.target.value}) })),
                e('td', null, e('input', { type:'number', step:'0.01', value:r.qta||0, onChange:ev=>updRiga(i,{qta:num(ev.target.value)}) })),
                e('td', null, r.qtaRicevuta||0),
                e('td', null, residuoRiga(r)),
                e('td', null, e('input', { type:'number', step:'any', value:r.prezzo||0, onChange:ev=>updRiga(i,{prezzo:num(ev.target.value)}) })),
                e('td', null, e('input', { type:'number', value:r.iva||DEFAULT_IVA, onChange:ev=>updRiga(i,{iva:num(ev.target.value)}) })),
                e('td', null, (num(r.qta)*num(r.prezzo)).toFixed(2)),
                e('td', null,
                  e('button', {className:'btn btn-sm', onClick:()=>apriRicezione(i)}, '📥'), ' ',
                  e('button', {className:'btn btn-sm', onClick:()=>riceviTutto(i)}, '⇥'), ' ',
                  e('button', {className:'btn btn-sm btn-danger', onClick:()=>delRiga(i)}, '✖')
                )
              )))
            ),
            e('button', { className:'btn btn-sm', onClick:addRiga }, '➕ Riga'),
            e('div', { style:{float:'right', marginTop:8, fontWeight:'bold'} }, `Totale: € ${totaleDocIvato(draft).toFixed(2)}`)
          ),
          
          // BLOCCO ALLEGATI SMART (Z:)
          (function(){
            const entityId = draft && draft.id ? String(draft.id) : '';
            const allOF = lsGet('ordiniFornitoriRows', []) || [];
            const isSaved = !!entityId && Array.isArray(allOF) && allOF.some(r => r && String(r.id) === entityId);
            const allAllegati = lsGet('allegatiRows', []) || [];
            const ofAllegati = isSaved
              ? allAllegati.filter(a => {
                  if (window.allegatoMatchesEntity) return window.allegatoMatchesEntity(a, 'OF', entityId);
                  return a && !a.deletedAt &&
                    String(a.entityType||'').toUpperCase()==='OF' &&
                    String(a.entityId||'')===entityId;
                })
              : [];

            const saveAllegatoSmart = async (ev) => {
              const file = ev.target.files?.[0]; if(!file) return;
              const year = (new Date(draft.data)).getFullYear();
              const id = draft.id;
              const f = allegatoOFForm || {};
              const tipo = f.tipo || 'ALTRO';
              
              let folder = 'ORDINI_FORNITORI';
              let newName = file.name;
              if (tipo === 'CONFERMA_ORDINE') {
                const ext = file.name.split('.').pop();
                newName = `${id}-Conferma.${ext}`;
              }

              if (!window.smartSaveFile) {
                alert('smartSaveFile non disponibile: manca il motore Allegati Smart (Z:).');
                return;
              }

              // Richiede connessione esplicita: evita tentativi “a vuoto” e problemi di user-activation
              if (!window.__Z_HANDLE) {
                alert('Prima clicca "🔗 Connetti cartella ANIMA_DOC (Z:)" e seleziona la cartella. Poi riprova.');
                return;
              }

              const savedPath = await window.smartSaveFile(file, [folder, String(year), id], newName);

              try{ ev.target.value = ''; }catch{} // permette di ricaricare lo stesso file

              if (!savedPath) {
                const det = window.__Z_LAST_ERR ? ("\n\nDettaglio tecnico: " + window.__Z_LAST_ERR) : '';
                alert(
                  "Salvataggio su Z: NON riuscito / annullato.\n\n" +
                  "Cause tipiche:\n" +
                  "• Browser non compatibile (smartphone, iOS Safari, ecc.)\n" +
                  "• Permesso non concesso / cartella ANIMA_DOC non selezionata\n\n" +
                  "Soluzione: usa PC con Chrome/Edge e seleziona ANIMA_DOC quando richiesto,\n" +
                  "oppure registra SOLO l'indice (pulsante sotto)."
                  + det
                );
                return;
              }

              if (savedPath) {
                let all = []; try{ all = window.lsGet('allegatiRows',[])||[]; }catch{}
                const nextId = `ALG-${year}-${String(all.length+1).padStart(4,'0')}`;
                const desc = f.descrizione || (tipo==='CONFERMA_ORDINE' ? `Conferma ${id}` : file.name);
                const nowIso = new Date().toISOString();
                const newRow = { id:nextId, createdAt:nowIso, updatedAt:nowIso, tipo, descrizione:desc, path:savedPath, url:'', entityType:'OF', entityId:id, deletedAt:null };
                if (window.allegatiUpsertOne) window.allegatiUpsertOne(newRow);
                else window.lsSet('allegatiRows', [...all, newRow]);

                // comodo: copia negli appunti dove è stato salvato
                try{ navigator.clipboard.writeText(savedPath); }catch{}
                alert('File salvato su Z:\n' + savedPath + '\n\n(Percorso copiato negli appunti)');
                if (typeof setDraft === 'function') setDraft({...draft}); // refresh
                setAllegatoOFForm({ tipo:'CONFERMA_ORDINE', descrizione:'', path:'', url:'' });
              }
              ev.target.value = '';
            };

                        const registerIndexOnly = async () => {
              if (readOnly) return;
              if (!isSaved) { alert('Salva ordine prima di allegare.'); return; }

              const year = (new Date(draft.data)).getFullYear();
              const id = draft.id;
              const f = allegatoOFForm || {};
              const tipo = f.tipo || 'ALTRO';

              const p = prompt('Incolla il percorso completo su Z:/UNC del file già esistente:', '');
              if (!p) return;

              let all = []; try{ all = (window.lsGet ? (lsGet('allegatiRows',[])||[]) : []) }catch{}
              // ID semplice (per ora): evita wipe grazie a upsert; collisioni si gestiscono dopo
              const nextId = `ALG-${year}-${String((all||[]).length+1).padStart(4,'0')}`;

              const desc = (f.descrizione || '').trim() || (tipo + ' ' + id);
              const newRow = {
                id: nextId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                tipo,
                descrizione: desc,
                path: String(p).trim(),
                url: '',
                entityType: 'OF',
                entityId: id,
                deletedAt: null
              };

              if (window.allegatiUpsertOne) window.allegatiUpsertOne(newRow);
              else window.lsSet('allegatiRows', (all||[]).concat([newRow]));

              setDraft({...draft});
              setAllegatoOFForm({ tipo:'CONFERMA_ORDINE', descrizione:'', path:'', url:'' });
              alert('Indice allegato registrato (senza copiare file).');
            };

            const delAllegato = (aid) => {
               if(!confirm('Eliminare?')) return;
               let all = lsGet('allegatiRows',[])||[];
               const upd = all.map(r => r.id===aid ? {...r, deletedAt:new Date().toISOString()} : r);
               if (window.allegatiSoftDelete) window.allegatiSoftDelete(aid);
               else lsSet('allegatiRows', upd);
               setDraft({...draft}); // refresh
            };

            const copyPath = (p) => { try{ navigator.clipboard.writeText(p); }catch{ prompt('Copia:',p); } };
            const openLink = (u) => { if(u) window.open(u,'_blank'); };

            return e('div', {className:'subcard', style:{marginTop:12}},
              e('h4', null, 'Allegati Smart (Z:)'),
              !isSaved ? e('div',{className:'muted'}, 'Salva ordine per allegare.') : e('div', null,
                ofAllegati.length > 0 && e('table', {className:'table table-sm'},
                   e('thead', null, e('tr',null,e('th',null,'Tipo'),e('th',null,'Descrizione'),e('th',null,'Percorso'),e('th',null,'Azioni'))),
                   e('tbody', null, ofAllegati.map(a => e('tr',{key:a.id},
                      e('td',null,a.tipo), e('td',null,a.descrizione), e('td',null,e('span',{style:{fontSize:11,fontFamily:'monospace'}},a.path)),
                      e('td',null,
                        e('button',{className:'btn btn-xs', onClick:()=>copyPath(a.path)}, 'Copia'), ' ',
                        a.url ? e('button',{className:'btn btn-xs', onClick:()=>openLink(a.url)}, 'Link') : null, ' ',
                        !readOnly && e('button',{className:'btn btn-xs btn-outline', onClick:()=>delAllegato(a.id)}, '🗑')
                      )
                   )))
                ),
                e('div', {className:'grid grid-2', style:{marginTop:8, padding:10, border:'1px dashed #ccc', borderRadius:8}},
                  e('div', null, e('label',null,'Tipo'), e('select',{value:allegatoOFForm.tipo, onChange:ev=>setAllegatoOFForm({...allegatoOFForm, tipo:ev.target.value})}, ['CONFERMA_ORDINE','DISEGNO','ALTRO'].map(t=>e('option',{key:t,value:t},t)))),
                  e('div', null, e('label',null,'Descrizione'), e('input',{value:allegatoOFForm.descrizione, onChange:ev=>setAllegatoOFForm({...allegatoOFForm, descrizione:ev.target.value})})),
                  e('div', {style:{gridColumn:'1/-1', marginTop:8, display:'grid', gap:8}},

                      e('button', {
                       className:'btn btn-outline',
                       style:{display:'block', width:'100%'},
                       disabled: readOnly,
                       onClick: async () => {
                         const h = await (window.ensureZConnection ? window.ensureZConnection() : null);
                         const det = window.__Z_LAST_ERR ? ('\n\nDettaglio: ' + window.__Z_LAST_ERR) : '';
                         if (h) alert('Cartella connessa: ' + (h.name||'ANIMA_DOC'));
                         else alert('Connessione cartella NON riuscita.' + det);
                       }
                     }, '🔗 Connetti cartella ANIMA_DOC (Z:)'),

                     e('button', {
                       className:'btn btn-outline',
                       style:{display:'block', width:'100%'},
                       disabled: readOnly,
                       onClick: registerIndexOnly
                     }, '➕ Registra solo indice (file già su Z)'),

                     e('label', {
                       className:'btn btn-primary',
                       style:{display:'block', textAlign:'center', cursor:'pointer'}
                     },
                       '📂 CARICA FILE SU Z:',
                       e('input', {type:'file', style:{display:'none'}, disabled:readOnly, onChange:saveAllegatoSmart})
                     )
                  )
                )
              )
            );
          })()

        ), // fine fieldset

        e('div', { className:'row', style:{justifyContent:'flex-end', gap:8, marginTop:12} },
          e('button', { className:'btn btn-outline', onClick:()=>{ setShowForm(false); setDraft(null); } }, 'Chiudi'),
          e('button', { className:'btn btn-outline', onClick:riceviOrdineIntero }, '⬇️ Ricevi tutto'),
          e('button', { className:'btn btn-outline', onClick:()=>window.printOrdineFornitore && window.printOrdineFornitore(draft) }, '🖨️ Stampa'),
          e('button', { className:'btn btn-primary', onClick:()=>saveDraft(), disabled:readOnly }, 'Salva')
        )
      )
    ),

    rx && draft && e(RiceviDaOrdineModal, { ordine:draft, riga:draft.righe[rx.indexRiga], onClose:()=>setRx(null), onConfirm:confermaRicezione })
  );
}
window.OrdiniFornitoriView = window.OrdiniFornitoriView || OrdiniFornitoriView;


/* ================== PREVENTIVI (PV) — STEP 1: lista + form minimale ================== */
function PreventiviView({ query = '' }){
  const e = React.createElement;
  const lsGet = window.lsGet, lsSet = window.lsSet;
  const sortNewestFirst = window.sortNewestFirst || (a=>a);
  const today = ()=> new Date().toISOString().slice(0,10);
  const clone = o => JSON.parse(JSON.stringify(o||{}));
  const num = v => Number(v||0);
  const pvLabelProps = { className: 'pv-label' };
  
    // IVA di default aziendale (fallback 22%). Deve stare qui per essere visibile ovunque.
  const appSettings = lsGet ? (lsGet('appSettings', {}) || {}) : {};
  const DEFAULT_IVA =
    Number(
      appSettings.defaultIva ??
      appSettings.ivaDefault ??
      appSettings.aliquotaIvaDefault ??
      22
    ) || 22;

    // Badge stato per lista preventivi (colori soft + compat con classi esistenti)
  function statusBadge(stato){
    const s = String(stato||'Bozza');
    let cls='', bg='#f3f4f6', col='#111';

    if (s === 'Bozza'){
      cls='badge-yellow'; bg='#fff7ed'; col='#b45309';
    } else if (s === 'Inviato'){
      cls='badge-yellow'; bg='#fffbeb'; col='#b45309';
    } else if (s === 'Accettato' || s === 'Trasformato'){
      cls='badge-green'; bg='#ecfdf5'; col='#065f46';
    } else if (s === 'Rifiutato'){
      cls='badge-red'; bg='#fef2f2'; col='#b91c1c';
    }

    return {
      label: s,
      cls,
      style: {
        display:'inline-block',
        padding:'2px 8px',
        borderRadius:999,
        fontWeight:700,
        fontSize:12,
        background:bg,
        color:col,
        border:'1px solid rgba(0,0,0,.08)'
      }
    };
  }

  const PV_KEY = 'preventiviRows';
  const CLIENTI_KEY = 'clientiRows';
  const ART_KEY = (window.__MAG_KEYS__||{}).ART_KEY || 'magazzinoArticoli';

  const clienti = lsGet(CLIENTI_KEY, []) || [];
    // Articoli: compat tra chiave nuova e legacy (come fix OF)
  const articoliNew = lsGet(ART_KEY, []);
  const articoliOld = lsGet('magArticoli', []);
  const articoli = (Array.isArray(articoliNew) && articoliNew.length)
    ? articoliNew
    : (Array.isArray(articoliOld) ? articoliOld : []);

  const blank = {
    id:'', data: today(),
    clienteId: null, clienteRagione:'',
    rifCliente:'', consegnaPrevista: today(),
    stato:'Bozza', oggetto:'', note:'',
    righe: [],
    __createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  const [rows, setRows] = React.useState(()=> lsGet(PV_KEY, []));
    // ===== Dropdown articoli su CODICE (PV) =====
    const [openArtMenuRow, setOpenArtMenuRow] = React.useState(null); // index riga aperta
  const [artMenuQuery, setArtMenuQuery] = React.useState('');
  const [artMenuPos, setArtMenuPos] = React.useState(null); // {top,left,width}

  function openMenuAt(ev, rowIndex){
    try{
      const el = ev?.currentTarget || ev?.target;
      if (!el || !el.getBoundingClientRect) return;
      const r = el.getBoundingClientRect();
      setArtMenuPos({
        top: r.bottom + 4,
        left: r.left,
        width: r.width
      });
      setOpenArtMenuRow(rowIndex);
    }catch{}
  }

  // chiudi menu cliccando fuori
  React.useEffect(()=>{
    function onDocDown(ev){
      const inside = !!ev.target.closest('.pv-codice-input, .pv-artmenu');
      if (!inside) setOpenArtMenuRow(null);
    }
    document.addEventListener('mousedown', onDocDown);
    return ()=>document.removeEventListener('mousedown', onDocDown);
  },[]);

  // elenco filtrato per dropdown codice (max 20)
  const filteredArticoli = React.useMemo(()=>{
    const arr = Array.isArray(articoli) ? articoli : [];
    const qx = String(artMenuQuery||'').trim().toLowerCase();
    if (!qx) return arr.slice(0,20);
    return arr.filter(a=>{
      const cod = String(a.codice||a.id||'').toLowerCase();
      const des = String(a.descrizione||a.nome||'').toLowerCase();
      return cod.includes(qx) || des.includes(qx);
    }).slice(0,20);
  },[articoli, artMenuQuery]);

  const [q, setQ] = React.useState(query||'');
  const [statoFilter, setStatoFilter] = React.useState('');
  const [showForm, setShowForm] = React.useState(false);
  const [draft, setDraft] = React.useState(blank);

    function persist(next){
    // write-through robusto (come altri moduli): lsSet se c'è, altrimenti localStorage diretto
    try {
      if (typeof lsSet === 'function') lsSet(PV_KEY, next);
      else localStorage.setItem(PV_KEY, JSON.stringify(next));
    } catch {
      try { localStorage.setItem(PV_KEY, JSON.stringify(next)); } catch {}
    }

    setRows(next);
    window.__anima_dirty = true;
    try { window.requestAppRerender && window.requestAppRerender(); } catch {}
    try { window.syncExportToCloudOnly && window.syncExportToCloudOnly([PV_KEY]); } catch {}
  }

  async function startNew(){
    const idObj = (typeof window.nextIdPV === 'function') ? await window.nextIdPV() : { id:`PV-${new Date().getFullYear()}-001` };
    setDraft({
      ...blank,
      id: idObj.id || idObj,
      data: today(),
      consegnaPrevista: today(),
      righe: [],
      __createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    setShowForm(true);
  }

  function startEdit(r){
    setDraft({ ...blank, ...clone(r) });
    setShowForm(true);
  }

  function removeRow(id){
    if (!confirm('Eliminare preventivo?')) return;
    const next = (rows||[]).filter(x => String(x.id)!==String(id));
    persist(next);
  }

  // ---- righe preventivo ----
  function addRiga(){
    setDraft(p=>({
      ...p,
      righe: [...(p.righe||[]), {
        codice:'', descrizione:'', um:'',
        qta:1, prezzo:0, iva: DEFAULT_IVA, note:''
      }]
    }));
  }


    function updRiga(i, patch){
    setDraft(p=>{
      const righe = Array.isArray(p.righe)? p.righe.slice():[];
      const cur = righe[i] || {};
      let next = { ...cur, ...patch };

      // autofill su codice
      if (Object.prototype.hasOwnProperty.call(patch,'codice')) {
        const cod = String(patch.codice||'').trim();
        const a = (Array.isArray(articoli)?articoli:[])
          .find(x => String(x.codice||x.id||'').trim() === cod) || null;

                if (a) {
          if (!next.descrizione) next.descrizione = a.descrizione || a.descr || '';
          const um = String(next.um||next.UM||a.um||a.UM||'PZ').toUpperCase();
          next.um = um; next.UM = um;

          // PREVENTIVO = prezzo vendita (fallback costo solo se manca)
          if (next.prezzo == null || next.prezzo === '' || Number(next.prezzo) === 0) {
            next.prezzo = Number(a.prezzo ?? a.costo ?? 0) || 0;
          }

          // IVA default dall'articolo se presente, altrimenti default azienda
          if (next.iva == null || next.iva === '' || Number(next.iva) === 0) {
            next.iva = Number(a.iva ?? a.aliquotaIva ?? DEFAULT_IVA) || DEFAULT_IVA;
          }
        }
      }

      // normalizza UM se cambiata manualmente
      if (Object.prototype.hasOwnProperty.call(patch,'um') || Object.prototype.hasOwnProperty.call(patch,'UM')) {
        const um = String(next.um||next.UM||'PZ').toUpperCase();
        next.um = um; next.UM = um;
      }

      righe[i] = next;
      return { ...p, righe };
    });
  }

  function delRiga(i){
    setDraft(p=>{
      const righe = Array.isArray(p.righe)? p.righe.slice():[];
      righe.splice(i,1);
      return { ...p, righe };
    });
  }

  function pickCliente(id){
    const c = clienti.find(x=> String(x.id)===String(id));
    setDraft(p=>({ ...p, clienteId:id, clienteRagione: c?c.ragione:'' }));
  }

  function totaleDoc(pv){
    return (pv?.righe||[]).reduce((s,r)=>{
      const impon = num(r.qta)*num(r.prezzo);
      const ivaP = num(r.iva || DEFAULT_IVA)/100;
      return s + impon*(1+ivaP);
    }, 0);
  }

  function onSave(ev){
    ev && ev.preventDefault && ev.preventDefault();
    const pv = clone(draft);
    if (!pv.id){ alert('ID mancante'); return; }
    pv.updatedAt = new Date().toISOString();
    const all = Array.isArray(rows)? clone(rows): [];
    const ix = all.findIndex(x=> String(x.id)===String(pv.id));
    if (ix>=0) all[ix]=pv; else all.push(pv);
    persist(all);
    setShowForm(false);
  }

    const filtered = sortNewestFirst(
    (rows||[]).filter(r=>{
      // filtro testo
      if (q){
        const t = (String(r.id||'')+' '+String(r.clienteRagione||'')+' '+String(r.oggetto||'')).toLowerCase();
        if (!t.includes(String(q).toLowerCase())) return false;
      }
      // filtro stato
      if (statoFilter && String(r.stato||'Bozza') !== statoFilter) return false;

      return true;
    }),
    { dateKeys:['data','__createdAt'] }
  );

  if (showForm){
    const pv = draft;
    return e('div', {className:'page'},
      e('div', {className:'card'},
        e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center'}},
          e('h2', {style:{margin:0}}, 'Preventivo ' + (pv.id||'')),
          e('div', {className:'actions'},
            e('button', {className:'btn btn-outline', type:'button', onClick:()=>setShowForm(false)}, 'Chiudi')
          )
        ),
        e('form', {onSubmit:onSave},
          e('div', {className:'form', style:{gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))'}},
            e('div', null,
              e('label', pvLabelProps,'ID'),
              e('input', {value: pv.id||'', readOnly:true})
            ),
            e('div', null,
              e('label', pvLabelProps,'Data'),
              e('input', {type:'date', value: pv.data||today(), onChange:ev=>setDraft(p=>({...p,data:ev.target.value}))})
            ),
            e('div', null,
              e('label', pvLabelProps,'Cliente'),
              e('select', {value: pv.clienteId||'', onChange:ev=>pickCliente(ev.target.value)},
                e('option', {value:''}, '— seleziona —'),
                (clienti||[]).map(c=> e('option', {key:c.id, value:c.id}, c.ragione))
              )
            ),
            e('div', null,
              e('label', pvLabelProps,'Rif. Cliente'),
              e('input', {value: pv.rifCliente||'', onChange:ev=>setDraft(p=>({...p,rifCliente:ev.target.value}))})
            ),
            e('div', null,
              e('label', pvLabelProps,'Consegna prevista'),
              e('input', {type:'date', value: pv.consegnaPrevista||today(), onChange:ev=>setDraft(p=>({...p,consegnaPrevista:ev.target.value}))})
            ),
            e('div', null,
              e('label', pvLabelProps,'Stato'),
              e('select', {value: pv.stato||'Bozza', onChange:ev=>setDraft(p=>({...p,stato:ev.target.value}))},
                ['Bozza','Inviato','Accettato','Rifiutato','Trasformato'].map(s=> e('option',{key:s,value:s},s))
              )
            ),
            e('div', {style:{gridColumn:'1/-1'}},
              e('label', pvLabelProps,'Oggetto / Descrizione'),
              e('input', {value: pv.oggetto||'', onChange:ev=>setDraft(p=>({...p,oggetto:ev.target.value}))})
            ),
            e('div', {style:{gridColumn:'1/-1'}},
              e('label', pvLabelProps,'Note'),
              e('textarea', {rows:3, value: pv.note||'', onChange:ev=>setDraft(p=>({...p,note:ev.target.value}))})
            )
          ),

          e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center', marginTop:8}},
            e('h3', {style:{margin:'6px 0'}}, 'Righe'),
            e('div', {className:'actions'},
              e('button', {className:'btn btn-outline', type:'button', onClick:addRiga}, '+ Riga')
            )
          ),

          e('div', {style:{overflowX:'auto'}},
            e('table', {className:'table'},
              e('thead', null, e('tr', null,
                e('th', null, 'Codice'),
                e('th', null, 'Descrizione'),
                e('th', null, 'UM'),
                e('th', {className:'right'}, 'Q.tà'),
                e('th', {className:'right'}, 'Prezzo'),
                e('th', {className:'right'}, 'IVA %'),
                e('th', {className:'right'}, 'Totale'),
                e('th', null, '')
              )),
              e('tbody', null,
                (pv.righe||[]).map((r,i)=> e('tr', {key:i},
                                    e('td', null,
                    e('input', {
                      className:'pv-codice-input',
                      value:r.codice||'',
                      placeholder:'codice…',
                      onFocus:(ev)=>{ setArtMenuQuery(r.codice||''); openMenuAt(ev, i); },
                      onClick:(ev)=>{ setArtMenuQuery(r.codice||''); openMenuAt(ev, i); },
                      onChange:ev=>{
                        const v = ev.target.value;
                        updRiga(i,{codice:v});
                        setArtMenuQuery(v);
                        openMenuAt(ev, i);
                      }
                    }),

                    (openArtMenuRow===i && artMenuPos && filteredArticoli.length>0) && e('div', {
                      className:'pv-artmenu',
                      style:{
                        position:'fixed',
                        left: artMenuPos.left,
                        top: artMenuPos.top,
                        width: artMenuPos.width,
                        background:'#fff',
                        border:'1px solid #ddd',
                        borderRadius:8,
                        boxShadow:'0 6px 18px rgba(0,0,0,.12)',
                        zIndex:999999,
                        maxHeight:260,
                        overflow:'auto'
                      }
                    },
                      filteredArticoli.map((a,ix)=> e('div', {
                        key:(a.codice||a.id||ix),
                        className:'pv-artmenu-item',
                        style:{padding:'6px 8px', cursor:'pointer', borderBottom:'1px solid #f1f1f1'},
                        onMouseDown:(ev)=>ev.preventDefault(), // evita blur input
                        onClick:()=>{
                          const cod = String(a.codice||a.id||'').trim();
                          updRiga(i,{codice:cod});
                          setOpenArtMenuRow(null);
                        }
                      },
                        e('div',{style:{fontWeight:700}}, String(a.codice||a.id||'')),
                        e('div',{className:'muted',style:{fontSize:12}}, String(a.descrizione||a.nome||''))
                      ))
                    )
                  ),
                  e('td', null,
                    e('input', {
                      value:r.descrizione||'',
                      onChange:ev=>updRiga(i,{descrizione:ev.target.value})
                    })
                  ),
                  e('td', null,
                    e('input', {
                      value:r.um||'',
                      onChange:ev=>updRiga(i,{um:ev.target.value})
                    })
                  ),
                  e('td', {className:'right'},
                    e('input', {
                      type:'number', step:'1', min:'0',
                      value:r.qta??1,
                      onChange:ev=>updRiga(i,{qta:num(ev.target.value)})
                    })
                  ),
                  e('td', {className:'right'},
                    e('input', {
                      type:'number', step:'0.01', min:'0',
                      value:r.prezzo??0,
                      onChange:ev=>updRiga(i,{prezzo:num(ev.target.value)})
                    })
                  ),
                  e('td', {className:'right'},
                    e('input', {
                      type:'number', step:'1', min:'0', max:'100',
                      value:r.iva ?? DEFAULT_IVA,
                      onChange:ev=>updRiga(i,{iva:num(ev.target.value)})
                    })
                  ),
                  e('td', {className:'right'},
                    (num(r.qta)*num(r.prezzo)*(1+(num(r.iva||DEFAULT_IVA)/100))).toFixed(2)
                  ),
                  e('td', null,
                    e('button', {className:'btn btn-outline', type:'button', onClick:()=>delRiga(i)}, '🗑️')
                  )
                ))
              )
            )
          ),

          e('div', {className:'row', style:{justifyContent:'flex-end', marginTop:8, fontWeight:'bold'}},
            'Totale: ', totaleDoc(pv).toFixed(2)
          ),

          e('div', {className:'actions', style:{justifyContent:'flex-end', gap:8, marginTop:8, flexWrap:'wrap'}},

            e('button', {
              className:'btn btn-outline',
              type:'button',
              onClick:()=>setShowForm(false)
            }, 'Annulla'),

            e('button', {
              className:'btn btn-outline',
              type:'button',
              onClick:()=>{
                // stampa l'oggetto corrente (anche se non salvato)
                if (!pv || !pv.id) return alert('Preventivo non valido');
                if (window.printPreventivo) window.printPreventivo(pv);
                else alert('Stampa non disponibile (manca PV9).');
              }
            }, 'Stampa'),

            e('button', {
              className:'btn btn-outline',
              type:'button',
              onClick:()=>{
                if (!pv || !pv.id) return alert('Salva prima il preventivo.');
                if (!confirm(`Trasformo il preventivo ${pv.id} in commessa?`)) return;

                const comm = window.transformPreventivoToCommessa
                  ? window.transformPreventivoToCommessa(pv)
                  : null;

                if (comm && comm.id){
                  // marca PV come trasformato e salva
                  setDraft(x=>({ ...x, stato:'Trasformato' }));
                  alert('Commessa creata ✅ ' + comm.id);
                  location.hash = '#/commesse';
                }else{
                  alert('Trasformazione non disponibile (manca PV10).');
                }
              }
            }, 'Trasforma in commessa'),

            e('button', {
              className:'btn',
              type:'submit'
            }, 'Salva')
          )
        )
      )
    );
  }

  return e('div', {className:'page'},
    e('div', {className:'card'},
      e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center'}},
        e('h2', {style:{margin:0}}, 'Preventivi'),
         e('div', {className:'actions', style:{gap:8}},
          e('input', {
            placeholder:'Cerca...',
            value:q,
            onChange:ev=>setQ(ev.target.value),
            style:{minWidth:180}
          }),
          e('select', {
            value: statoFilter,
            onChange: ev => setStatoFilter(ev.target.value),
            title:'Filtra per stato'
          },
            e('option', {value:''}, 'Tutti gli stati'),
            ['Bozza','Inviato','Accettato','Rifiutato','Trasformato'].map(s =>
              e('option', {key:s, value:s}, s)
            )
          ),

          e('button', {className:'btn', onClick:startNew}, 'Nuovo PV')
        )
      ),
      filtered.length===0
        ? e('div', {className:'muted', style:{marginTop:8}}, 'Nessun preventivo.')
        : e('div', {style:{marginTop:8, overflowX:'auto'}},
            e('table', {className:'table'},
              e('thead', null, e('tr', null,
                e('th', null,'ID'),
                e('th', null,'Data'),
                e('th', null,'Cliente'),
                e('th', null,'Oggetto'),
                e('th', {className:'right'}, 'Totale'),
                e('th', null,'Stato'),
                e('th', null,'')
              )),
              e('tbody', null,
                filtered.map(pv=> e('tr', {key:pv.id},
                  e('td', null, pv.id),
                  e('td', null, pv.data||''),
                  e('td', null, pv.clienteRagione||''),
                  e('td', null, pv.oggetto||''),
                  e('td', {className:'right'}, totaleDoc(pv).toFixed(2)),
                  e('td', null, (function(){
                    const b = statusBadge(pv.stato);
                    return e('span', {className:b.cls, style:b.style}, b.label);
                  })()),

                  e('td', null,
                    e('button', {className:'btn btn-outline', onClick:()=>startEdit(pv)}, 'Apri'), ' ',
                    e('button', {className:'btn btn-outline', onClick:()=>removeRow(pv.id)}, '🗑️')
                  )
                ))
              )
            )
          )
    )
  );
}
window.PreventiviView = window.PreventiviView || PreventiviView;

// ============== STAMPA ORDINE FORNITORE — neutra (solo totale colorato) ==============
(function(){
  // idempotente: ridefinisce ogni reload, OK

  window.printOrdineFornitore = function(of){
    try{
      const esc  = s => String(s==null?'':s).replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
      const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
      const fmtIT = d => { try{ return d ? new Date(d).toLocaleDateString('it-IT') : ''; }catch{return String(d||'');} };
      const todayISO = () => new Date().toISOString().slice(0,10);

      // Dati app + fornitore
      const app = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })();
      const fornRows = (function(){ try{ return JSON.parse(localStorage.getItem('fornitoriRows')||'[]')||[]; }catch{return[]} })();

      // Fornitore
      let forn = fornRows.find(f => String(f.id||f.codice||'') === String(of.fornitoreId||'')) || null;
        if (!forn && of.fornitoreRagione) {
          const norm = s => String(s||'').trim().toLowerCase();
          forn = fornRows.find(f => norm(f.ragione||f.nome||'') === norm(of.fornitoreRagione)) || null;
        }

        const ragioneF  = esc(of.fornitoreRagione || forn?.ragione || forn?.nome || of.fornitoreId || '');
        const pivaF     = esc(forn?.piva || forn?.pIva || '');
        const indirF    = esc(forn?.indirizzo || forn?.ind || forn?.sedeOperativa || forn?.sedeLegale || '');
        const telF      = esc(forn?.telefono || forn?.tel || '');
        const mailF     = esc(forn?.email || '');
        const cfF       = esc(forn?.cf || '');
        const codUnivF  = esc(forn?.codiceUnivoco || forn?.codiceSDI || '');
        const pecForn   = esc(forn?.pec || '');
        const faxF      = esc(forn?.fax || '');
        const contattiF = [mailF || '', telF || '', faxF ? ('Fax: ' + faxF) : '']
          .filter(Boolean)
          .join(' · ');


      // Header ANIMA
      const logo     = app.logoDataUrl || '';
      const sedeLeg  = esc(app.sedeLegale || '');
      const sedeOp   = esc(app.sedeOperativa || '');
      const pivaA    = esc(app.piva || app.pIva || '');
      const telAzi   = esc(app.telefono || app.phone || '');
      const emailAzi = esc(app.email || '');
      const pecAzi   = esc(app.pec || '');

      // Colore SOLO per totale
      const ACCENT = app.brandColor || app.coloreBrand || '#0ea5e9';

      const righe = Array.isArray(of.righe)?of.righe:[];
      const totOrdine = righe.reduce((s,r)=> s + (Number(r.qta||0)*Number(r.prezzo||0)), 0);

      let css = window.__PRINT_CSS({ top:12, right:8, bottom:12, left:8 });
css += `<style>
  /* RIMOSSE dal tuo blocco originale:
     - @page { ... }                               → gestita dal tema
     - .pageNum[data-mode="css"]::after{...}       → non serve (numerazione via JS)
     - .pageNum[data-mode="css"]{...}              → non serve
     - .pagebox { ... } (puoi lasciarla se vuoi padding extra, ma il tema già la posiziona)
  */
    .pageNumOF::after{ content: counter(page); }

  /* Header pulito, nessun colore pieno */
  
  .hdr{display:flex;justify-content:space-between;align-items:center;gap:14px;
       border-bottom:2px solid #0f172a; padding-bottom:8px; margin-bottom:10px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:60px;object-fit:contain}
  .az .rs{font-size:18px;font-weight:800;letter-spacing:.2px}
  .az .muted{color:#64748b}
  .doc{border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; min-width:210px; text-align:right}
  .doc .title{font-weight:800; font-size:12px; letter-spacing:.3px}
  .doc .num{font-weight:800; font-size:14px}
  .doc .row{margin-top:2px}

  /* Fornitore (senza contorni) + info riga */
  .supplier{margin-top:8px}
  .supplier .rs{font-weight:700; margin-bottom:2px}
  .supplier .muted{color:#64748b}
  .note-conf{color:#64748b; font-style:italic; margin:4px 0 0}

  /* Info pagamento / consegna / riferimenti in griglia leggera */
  .infos{display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; margin-top:8px}
  .info .lab{color:#64748b}
  .info .val{font-weight:600}

  /* Fascia indirizzo ricezione (ben visibile, no colori) */
  .receive-band{margin:12px 0 6px 0; text-align:center}
  .receive-band .t1{font-weight:800; border-top:2px solid #0f172a; border-bottom:2px solid #0f172a; padding:6px 0; letter-spacing:.3px}
  .receive-band .t2{margin-top:4px}

  /* Tabella righe */
  table{width:100%; border-collapse:collapse; margin-top:6px}
  thead{display:table-header-group}
  th,td{border:1px solid #e2e8f0; padding:7px 8px; vertical-align:top}
  th{background:#f8fafc; font-weight:700}
  .ctr{text-align:center}
  .num{text-align:right}
  .no-break{page-break-inside:avoid}
  @media print{
    table{ page-break-inside:auto }
    tr{ break-inside:avoid; page-break-inside:avoid }
    td,th{ break-inside:avoid; page-break-inside:avoid }
  }

     /* Footer con totale colorato */
  .content{margin-bottom:0}
  .footer{
    position:fixed;
    left:8mm;
    right:8mm;
    bottom:12mm;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
  }
  .footer .pagebox{ position: static; margin-left:auto; font-weight:700; }

  .sign{min-width:280px; padding:8px 2px}
  .sign .lab{color:#64748b; font-size:12px}
  .sign .line{height:26px; border-bottom:1px solid #cbd5e1}
  .sign .name{margin-top:6px; font-weight:600}
  .tot{
    min-width:260px; background:${ACCENT}; color:#fff; border-radius:12px; padding:12px 14px;
    display:flex; justify-content:space-between; align-items:center
  }
  .tot .lab{font-weight:700}
  .tot .val{font-weight:900; font-size:16px}
</style>`;


      const header = `
        <div class="hdr">
          <div class="brand">
            ${logo ? `<img src="${logo}">` : ``}
            <div class="az">
              <div class="rs">${esc(app.ragioneSociale||'')}</div>
              ${sedeLeg ? `<div class="muted">Sede legale: ${sedeLeg}</div>` : ``}
              ${sedeOp  ? `<div class="muted">Sede operativa: ${sedeOp}</div>` : ``}
              ${pivaA   ? `<div class="muted">P.IVA: ${pivaA}</div>` : ``}
              ${telAzi   ? `<div class="muted">Tel: ${telAzi}</div>` : ``}
              ${emailAzi ? `<div class="muted">Email: ${emailAzi}</div>` : ``}
              ${pecAzi   ? `<div class="muted">PEC: ${pecAzi}</div>` : ``}
            </div>
          </div>
          <div class="doc">
            <div class="title">ORDINE FORNITORE</div>
            <div class="num">${esc(of.id||'')}</div>
            <div class="row">Data: <strong>${esc(of.data || todayISO())}</strong></div>
          </div>
        </div>`;

      const bloccoFornitore = `
        <div class="supplier">
          <div class="rs">${ragioneF || '—'}</div>
          ${indirF ? `<div class="muted">${indirF}</div>` : ``}
          ${contattiF ? `<div class="muted">${contattiF}</div>` : ``}
          ${pivaF    ? `<div class="muted">P.IVA: ${pivaF}</div>` : ``}
          ${cfF      ? `<div class="muted">CF: ${cfF}</div>` : ``}
          ${codUnivF ? `<div class="muted">Codice Univoco SDI: ${codUnivF}</div>` : ``}
          ${pecForn  ? `<div class="muted">PEC: ${pecForn}</div>` : ``}
        </div>`;


      const infos = `
        <div class="infos">
          <div class="info">
            <div class="lab">Condizioni di pagamento</div>
            <div class="val">${esc(of.condizioniPagamento || 'Rimessa Diretta')}</div>
          </div>
          <div class="info">
            <div class="lab">Consegna prevista</div>
            <div class="val">${esc(fmtIT(of.consegnaPrevista||''))}</div>
          </div>
          <div class="info">
            <div class="lab">NS. Riferimento</div>
            <div class="val">${esc(of.nsRiferimento || '')}</div>
          </div>
          <div class="info">
            <div class="lab">Riferimento interno</div>
            <div class="val">${esc(of.rifOrdine || '')}</div>
          </div>
        </div>`;

      const bandRicezione = `
        <div class="receive-band">
          <div class="t1">INDIRIZZO RICEZIONE MATERIALE ANIMA SRL</div>
          <div class="t2">Via Botte, 32 int. 5 - 35011 Campodarsego (PD) - Italia</div>
        </div>`;

      // righe
            const righeHTML = righe.map((r,i)=>{
        const codice = esc(r.codice || r.articoloCodice || '');
        const descr  = esc(r.descr||r.descrizione||'');
        const um     = esc(r.um||r.UM||'PZ');
        const qta    = Number(r.qta||0);
        const prezzo = Number(r.prezzo||0);
        const tot    = qta * prezzo;

        // IVA per riga: usa r.iva se c'è, altrimenti default app/of se disponibile
        const ivaVal = (r.iva !== undefined && r.iva !== null && r.iva !== '')
          ? Number(r.iva)
          : (typeof of.defaultIva === 'number'
              ? of.defaultIva
              : (typeof app.defaultIva === 'number' ? app.defaultIva : 0));

        const ivaTxt = ivaVal ? esc(String(ivaVal)) : '';

        return `<tr class="no-break">
          <td class="ctr">${i+1}</td>
          <td>${codice}</td>
          <td>${descr}</td>
          <td class="ctr">${um||'PZ'}</td>
          <td class="ctr">${qta ? fmt2(qta) : ''}</td>
          <td class="num">${ivaTxt}</td>
          <td class="num">${prezzo ? fmt2(prezzo) : ''}</td>
          <td class="num">${tot ? fmt2(tot) : ''}</td>
        </tr>`;
      }).join('');

            const table = `
        <table>
          <thead><tr>
            <th style="width:26px" class="ctr">#</th>
            <th style="width:90px">Codice</th>
            <th>Descrizione</th>
            <th style="width:60px" class="ctr">UM</th>
            <th style="width:90px" class="ctr">Q.tà</th>
            <th style="width:70px" class="num">IVA %</th>
            <th style="width:100px" class="num">P. Unitario</th>
            <th style="width:110px" class="num">P. Totale</th>
          </tr></thead>
          <tbody>${righeHTML || `<tr><td colspan="8" class="muted">— Nessuna riga —</td></tr>`}</tbody>
        </table>`;

      const footer = `
        <div class="footer">
          <div class="sign">
            <div class="lab">Nome richiedente</div>
            <div class="line"></div>
            <div class="name">${esc(of.nsRiferimento || '')}</div>
          </div>
          <div class="tot">
            <div class="lab">Totale ordine</div>
            <div class="val">€ ${fmt2(totOrdine)}</div>
          </div>
          <div class="pagebox">Pag. 1</div>
        </div>`;


            const html = `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>
        ${header}
        <div class="content">
          ${bloccoFornitore}
          ${infos}
          ${of.confermaFileDataUrl ? `<div class="note-conf">Conferma ordine del fornitore allegata al documento.</div>` : ``}
          ${bandRicezione}
          ${table}
        </div>
        ${footer}
      </body></html>`;

            // stampa (OF: numerazione semplice via CSS, niente "1 / 2" JS)
      if (window.safePrintHTMLString) {
        window.safePrintHTMLString(html);
      } else if (window.safePrintHTMLStringWithPageNum) {
        window.safePrintHTMLStringWithPageNum(html);
      } else {
        const w = window.open('', '_blank');
        if (w) { w.document.write(html); w.document.close(); }
      }

    }catch(e){
      alert('Errore stampa ordine: ' + (e?.message||e));
    }
  };
})();

// ============= EXPORT CSV: Ordini Fornitori APERTI / PARZIALI =============
(function(){
  if (window.__ANIMA_APP_MOUNTED__) return;

  if (window.exportOrdiniApertiCSV) return;

  function statoAutoPerOrdine(o){
    const righe = o?.righe || [];
    if (!righe.length) return o.stato || 'Bozza';
    const totOrd = righe.reduce((s,r)=> s + Number(r.qta||0), 0);
    const totRx  = righe.reduce((s,r)=> s + Number(r.qtaRicevuta||0), 0);
    if (totOrd>0 && totRx>=totOrd) return 'Chiuso';
    if (totRx>0) return 'Parziale';
    return o.stato || 'Bozza';
  }

  window.exportOrdiniApertiCSV = function(){
    const rows = (function(){ try{ return JSON.parse(localStorage.getItem('ordiniFornitoriRows')||'[]')||[]; }catch{return[]} })();
    const out = [];
    // header (usa ; per compatibilità con virgola decimale)
    out.push([
      'ID','Data','Fornitore','Riferimento','ConsegnaPrevista','Stato',
      'Codice','Descrizione','UM','QtaOrd','QtaRicev','Residuo','Prezzo','TotRiga','Note'
    ].join(';'));

    rows.forEach(o=>{
      const stato = statoAutoPerOrdine(o);
      if (stato==='Chiuso' || stato==='Annullato') return; // solo Aperti/Parziali
      const fornitore = o.fornitoreRagione || o.fornitoreId || '';
      (o.righe||[]).forEach(r=>{
        const q   = Number(r.qta||0);
        const rx  = Number(r.qtaRicevuta||0);
        const res = Math.max(0, q-rx);
        const pr  = Number(r.prezzo||0);
        const tot = q*pr;
        out.push([
          o.id, o.data||'', fornitore, (o.rifOrdine||''), (o.consegnaPrevista||''), stato,
          (r.codice||''), (r.descr||''), (r.um||''),
          q, rx, res, pr, tot, (o.note||'')
        ].map(v => String(v).replace(/[\r\n]+/g,' ').replace(/;/g,',')).join(';'));
      });
    });

    const csv = out.join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
    a.href = url;
    a.download = `ordini_aperti_parziali_${ymd}.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
  };
})();

/* ================== AUTO-SCARICO + ETICHETTE COLLI (A4 landscape) ================== */

// — util locali (no conflitti) —
const _fmtIT = d => d ? new Date(d).toLocaleDateString('it-IT') : '';
const _todayISO = () => new Date().toISOString().slice(0,10);
function _s(v){ return String(v||'').replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch])); }

// Upgrade 1-shot commesse: normalizza righe articolo legacy
// - assegna rowId dove manca (riusando rowID/id se presenti)
// - riempie qta se manca ma esiste qtaPezzi
// - assicura updatedAt sulle commesse (serve a mergeById)
(function upgradeCommesseRowsOnce(){
  try{
    const key = 'commesseRows';

    const lsGetLocal = (typeof lsGet === 'function')
      ? lsGet
      : (function(k, defVal){
          try{
            const v = localStorage.getItem(k);
            return v ? JSON.parse(v) : defVal;
          }catch{
            return defVal;
          }
        });

    const lsSetLocal = (typeof lsSet === 'function')
      ? lsSet
      : (function(k, val){
          try{
            localStorage.setItem(k, JSON.stringify(val));
          }catch{}
        });

    let arr = lsGetLocal(key, []);
    if (!Array.isArray(arr) || !arr.length) return;

    let changed = false;

    arr = arr.map((c, idxC) => {
      if (!c || typeof c !== 'object') return c;
      const out = { ...c };

      // updatedAt minimo per tutte le commesse (usato da mergeById)
      if (!out.updatedAt){
        const base =
          out.createdAt ||
          out.created_at ||
          out.data ||
          out.dataCommessa ||
          new Date().toISOString();
        const t = (Date.parse(base) || Date.now()) + (idxC * 1000);
        out.updatedAt = new Date(t).toISOString();
        changed = true;
      }

      // righe articolo: rowId + qta
      if (Array.isArray(out.righeArticolo)) {
        out.righeArticolo = out.righeArticolo.map((r, idxR) => {
          if (!r || typeof r !== 'object') return r;
          const rr = { ...r };

          // Assegna rowId se manca: riusa rowId/rowID/id se c'erano già
          if (!rr.rowId) {
            const rid = rr.rowId || rr.rowID || rr.id || `r-${idxC}-${idxR}`;
            rr.rowId = String(rid);
            changed = true;
          }

          // Se qta è vuota ma c'è qtaPezzi, usa quella come qta riga
          if ((rr.qta === undefined || rr.qta === null || rr.qta === '') && rr.qtaPezzi != null) {
            const v = Number(rr.qtaPezzi);
            if (!Number.isNaN(v) && v > 0) {
              rr.qta = v;
              changed = true;
            }
          }

          return rr;
        });
      }

      return out;
    });

    if (changed) {
      lsSetLocal(key, arr);
    }
  }catch{
    // Non blocco l'app se qualcosa va storto
  }
})();

function isCommessaCompleta(c){
  if (!c) return false;

  const deaccent = s => String(s||'')
    .normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();

  const isOncePhase = (f) => {
    if (!f) return false;
    if (f.once === true || f.unaTantum === true) return true;
    const name = deaccent(f.lav || '');
    return /(^|[^a-z])preparazione\s+attivita([^a-z]|$)/.test(name);
  };

  const righe = Array.isArray(c.righeArticolo) ? c.righeArticolo : [];
  const hasRowFasi = righe.some(r => Array.isArray(r?.fasi) && r.fasi.length);
  const totComm = Math.max(1, Number(c.qtaPezzi || c.qta || 0));

  // ---- Leggo una sola volta le ore locali (solo NON cancellate) ----
  let oreRowsAll = [];
  try{
    const tmp = (typeof lsGet === 'function')
      ? lsGet('oreRows', [])
      : JSON.parse(localStorage.getItem('oreRows') || '[]') || [];
    oreRowsAll = Array.isArray(tmp)
      ? tmp.filter(o => !o || !o.deletedAt)
      : [];
  }catch{
    oreRowsAll = [];
  }

  // === Caso 1: commessa con righe + fasi per riga ===
  // Commessa completa se TUTTE le righe quantitative sono complete
  if (righe.length && hasRowFasi){
    for (let idx = 0; idx < righe.length; idx++){
      const r = righe[idx];
      if (!r) continue;

      const totRiga = Math.max(0, Number(r.qta || r.qtaPezzi || 0));
      if (totRiga <= 0) continue; // riga non quantitativa → non blocca la chiusura

      let prodRiga = 0;

      // 1a) Se esiste l'helper core per riga, usiamo quello (timbrature + unaTantum ignorate)
      if (typeof window !== 'undefined'
        && typeof window.producedPiecesRowCore === 'function') {

        const v = Number(window.producedPiecesRowCore(c, idx, oreRowsAll) || 0);
        prodRiga = (Number.isFinite(v) && v >= 0) ? v : 0;

      } else {
        // 1b) Fallback legacy: uso qtaProdotta per-fase non unaTantum
        const fasiR = Array.isArray(r.fasi) ? r.fasi : [];
        const quant = fasiR
          .filter(f => !isOncePhase(f))
          .map(f => Math.max(0, Number(f && f.qtaProdotta || 0)));

        if (quant.length){
          prodRiga = Math.min(...quant);
        } else {
          prodRiga = Math.max(0, Number(r.qtaProdotta || 0));
        }
      }

      if (prodRiga < totRiga) return false;
    }
    return true;
  }

  // === Caso 2: nessuna fase per riga → uso logica core di commessa se c'è ===
  if (typeof window !== 'undefined'
    && typeof window.producedPiecesCore === 'function') {

    const v = Number(window.producedPiecesCore(c, oreRowsAll) || 0);
    const prodComm = (Number.isFinite(v) && v >= 0) ? v : 0;
    return prodComm >= totComm;
  }

  // === Caso 3: Fallback completamente legacy (qtaProdotta + fasi globali) ===
  const tot = totComm;
  const prod = Number(c.qtaProdotta || 0);

  const fasiOk = Array.isArray(c?.fasi)
    ? c.fasi
        .filter(f => !isOncePhase(f))
        .every(f => Number(f && f.qtaProdotta || 0) >= tot)
    : true;

  return prod >= tot && fasiOk;
}

// scarico materiali: se riga materiale ha perPezzo===true scarico (qta*riga * qtaPezzi), altrimenti qta "totale commessa"
function scaricaMaterialiDaCommessa(c){
  try{
    const mats = Array.isArray(c?.materiali) ? c.materiali : [];
    if (!mats.length) return;

    const art = lsGet('magArticoli', []) || [];
    const mov = lsGet('magMovimenti', []) || [];
    try {
    if (typeof window.syncExportToCloudOnly === 'function') {
    window.syncExportToCloudOnly(['magMovimenti','magArticoli','commesseRows']);
    }
    } catch {}

    const nowISO = new Date().toISOString();
    const qTot   = Math.max(1, Number(c.qtaPezzi||1));
    const when   = nowISO.slice(0,10);

    for (const m of mats){
      const codice = (m?.codice||'').trim(); if (!codice) continue;
      const perPezzo = !!m?.perPezzo;
      const q = Number(m?.qta||0);
      const qScarico = perPezzo ? q * qTot : q;
      if (!qScarico) continue;

      // aggiorna giacenza di magArticoli (facoltativo)
      const i = art.findIndex(a => (a?.codice||'') === codice);
      if (i >= 0) {
        art[i] = { ...art[i], giacenza: Number(art[i].giacenza||0) - qScarico };
      } else {
        art.push({ codice, descrizione:(m?.descrizione||m?.descr||''), um:(m?.um||''), giacenza: -qScarico });
      }

      // movimento FLAT compatibile
      const np = window.nextProgressivo('mag');
      mov.push({
        id: `MAG-${np.year}-${window.formatNNN(np.num)}`,
        data: when,
        tipo: 'SCARICO',
        codice,
        descrizione: (m?.descrizione||m?.descr||''),
        um: (m?.um||''),
        qta: -Math.abs(qScarico),
        commessaId: c.id,
        note: `Scarico commessa ${c.id}`,
        createdAt: nowISO,
        updatedAt: nowISO
      });
    }

    lsSet('magMovimenti', mov);
    lsSet('magArticoli', art);
  }catch(e){ console.warn('scaricaMaterialiDaCommessa errore:', e); }
}

// etichette colli (una per pagina A4 orizzontale)
function buildEtichetteHTML(c, nColli){
  const cfg = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{};} })();
  const azi = _s(cfg.companyName || cfg.ragioneSociale || 'Azienda');
  const addr = _s(cfg.companyAddress || cfg.sedeOperativa || cfg.sedeLegale || '');
  const piva = _s(cfg.companyVat || cfg.piva || '');
  const logo = cfg.logoDataUrl || '';

  // ---- codice articolo da righeArticolo (o fallback) ----
  const codici = Array.isArray(c?.righeArticolo)
    ? c.righeArticolo.map(r => String(r?.codice||'').trim()).filter(Boolean)
    : [];
  const codiceTxt =
    codici.length === 1 ? codici[0]
    : codici.length > 1 ? (codici.slice(0,3).join(', ') + (codici.length>3 ? ` …(+${codici.length-3})` : ''))
    : String(c?.articoloCodice || '');

  const stile = `
  <style>
    @page { size: A4 landscape; margin: 10mm; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111}
    .page{page-break-after: always; display:flex; align-items:center; justify-content:center; height:100vh;}
    .label{border:2px solid #000; border-radius:12px; padding:16px 24px; width:90%; display:flex; gap:18px; align-items:center;}
    .logo{width:120px; height:80px; object-fit:contain; border:1px solid #eee; background:#fff}
    .h1{font-size:36px; font-weight:800; line-height:1.1}
    .h2{font-size:22px; font-weight:700}
    .muted{color:#555}
    .info{display:grid; grid-template-columns:1fr 1fr; gap:8px 24px; font-size:16px}
    .big{font-size:26px; font-weight:800}
  </style>`;

  const blocchi = [];
  const tot = Math.max(1, Number(nColli||1));
  const now = _fmtIT(new Date());

  for (let i=1; i<=tot; i++){
    blocchi.push(`
      <div class="page">
        <div class="label">
          ${logo ? `<img class="logo" src="${logo}" alt="logo" />` : ''}
          <div style="flex:1">
            <div class="h1">${azi}</div>
            <div class="muted">${addr}${addr && piva ? ' · ' : ''}${piva ? 'P.IVA '+piva : ''}</div>
            <div class="h2" style="margin-top:6px">COLLO ${i}/${tot}</div>
            <div class="info" style="margin-top:10px">
              <div><span class="muted">Cliente:</span> <span class="big">${_s(c?.cliente||'-')}</span></div>
              <div><span class="muted">Commessa:</span> <span class="big">${_s(c?.id||'-')}</span></div>
              <div><span class="muted">Codice articolo:</span> <span class="big">${_s(codiceTxt||'-')}</span></div>
              <div><span class="muted">Articolo/Assieme:</span> ${_s(c?.descrizione||'-')}</div>
              <div><span class="muted">Consegna prevista:</span> ${_fmtIT(c?.scadenza)||'-'}</div>
              <div><span class="muted">Data stampa:</span> ${now}</div>
            </div>
          </div>
        </div>
      </div>`);
  }

  return `<!doctype html><html><head><meta charset="utf-8">${stile}</head><body>
    ${blocchi.join('\n')}
  </body></html>`;
}

function printEtichetteColli(c, nColli){
  const html = buildEtichetteHTML(c, nColli);
  safePrintHTMLString(html);
}
function openEtichetteColliDialog(c){
  try{
    let def = Number(c.colli||1);
    if (!Number.isFinite(def) || def < 1) def = 1;

    const ans = prompt(`Quanti colli ha la commessa ${c.id}?`, String(def));
    if (ans == null) return; // annullato

    const n = Math.max(1, Math.min(99, parseInt(ans||'1',10)));
    c.colli = n;

    // persisto il valore se la commessa esiste in archivio
    try{
      const all = lsGet('commesseRows', []);
      const ix = all.findIndex(x => x.id === c.id);
      if (ix >= 0){
        all[ix] = { ...all[ix], colli: n };
        lsSet('commesseRows', all);
        window.__anima_dirty = true;
      }
    }catch{}

    printEtichetteColli(c, n);
  }catch(e){
    console.warn('openEtichetteColliDialog error:', e);
  }
}

// Controllo fine-commessa: scarico + popup colli + stampa etichette (una volta sola)
function _maybeAutoScaricoAndLabels(jobId){
  try{
    const all = lsGet('commesseRows', []);
    const ix = all.findIndex(c => c.id === jobId);
    if (ix < 0) return;

    const c = { ...all[ix] };
    if (!isCommessaCompleta(c)) return; // <-- popup SOLO quando tutta la commessa è completa

    // eseguo una sola volta
    if (!c.scaricoDone){
      scaricaMaterialiDaCommessa(c);
      c.scaricoDone = true;
    }

    if (!c.labelsPrinted){
      let def = Number(c.colli||1);
      if (!Number.isFinite(def) || def < 1) def = 1;
      const ans = prompt(`Quanti colli ha la commessa ${c.id}?`, String(def));
      const n = Math.max(1, Math.min(99, parseInt(ans||'1',10)));
      c.colli = n;
      c.labelsPrinted = true;

      all[ix] = c;
      lsSet('commesseRows', all);
      window.__anima_dirty = true;

      printEtichetteColli(c, n);
    }
  }catch(e){ console.warn('_maybeAutoScaricoAndLabels errore:', e); }
}
window._maybeAutoScaricoAndLabels = window._maybeAutoScaricoAndLabels || _maybeAutoScaricoAndLabels;

/* ================== REGISTRAZIONI ORE (Locale + Cloud) ================== */
function RegistrazioniOreView({ query = '' }) {
  const e = React.createElement;

  const u = (typeof window !== 'undefined' && window.__USER) ? window.__USER : null;
  const isAdmin = !!(u && u.role === 'admin');
  const currentUserLabel = u ? (u.email || u.username || u.user || '') : '';

    // RBAC sola lettura (accountant / viewer / mobile)
  const readOnly = (
    typeof window !== 'undefined' &&
    typeof window.isReadOnlyUser === 'function'
      ? !!window.isReadOnlyUser()
      : !!(u && u.role === 'accountant')
  );

  const roBtnProps = () =>
    (typeof window !== 'undefined' && window.roProps
      ? window.roProps()
      : (readOnly ? {
          disabled: true,
          title: 'Sola lettura'
        } : {}));

    // --- Helpers LS sicuri (riusano i globali se presenti) ---
  const lsGet = (typeof window !== 'undefined' && window.lsGet)
    ? window.lsGet
    : ((k, d) => {
        try {
          const v = JSON.parse(localStorage.getItem(k));
          return (v ?? d);
        } catch {
          return d;
        }
      });

  const lsSet = (typeof window !== 'undefined' && window.lsSet)
    ? window.lsSet
    : ((k, v) => {
        try {
          localStorage.setItem(k, JSON.stringify(v));
        } catch {
          /* ignore */
        }
      });

  // --- Helper tempo ---
  const toMin = (s) => {
    if (s == null) return 0;
    const str = String(s).trim();
    if (!str) return 0;
    const m = str.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return NaN;
    const h = parseInt(m[1],10) || 0;
    const mm = parseInt(m[2]||'0',10) || 0;
    return (h*60 + mm);
  };
  const fmtHHMMfromMin = (mins) => {
    const t = Math.max(0, Math.round(Number(mins) || 0));
    const h = Math.floor(t/60);
    const m = t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };
  const todayISO = () => new Date().toISOString().slice(0,10);

    // --- Helper per quantità dentro la nota Cloud (es. "Qta: 5") ---
  const parseQtyFromNoteCloud = (note) => {
    try {
      const s = String(note || '');
      // pattern tipo "Qta: 5"
      let m = s.match(/Qta\s*[:=]\s*(\d+)/i);
      if (!m) {
        // pattern vecchio "Quantità prodotta: 5"
        m = s.match(/Quantit[àa]\s*prodotta\s*[:=]\s*(\d+)/i);
      }
      if (!m) return '';
      const val = Number(m[1].replace(',', '.'));
      if (!Number.isFinite(val) || val <= 0) return '';
      return String(val);
    } catch {
      return '';
    }
  };

  // --- Helper ID coerenti con Timbratura ---
  function formatNNN(n){ return String(n).padStart(3,'0'); }

  // Fallback robusto per progressivo "ore"
  function safeNextProgressivoOre(){
    try{
      if (typeof window.nextProgressivo === 'function'){
        const out = window.nextProgressivo('ore') || {};
        const y = Number(out.year) || (new Date().getFullYear());
        const n = Number(out.num);
        if (Number.isFinite(n) && n > 0) return { year: y, num: n };
      }
    }catch{}
    const year = (new Date()).getFullYear();
    let counters = {};
    try { counters = JSON.parse(localStorage.getItem('counters') || '{}') || {}; } catch {}
    let n = 1;
    if (counters.ore && counters.ore.year === year && Number.isFinite(Number(counters.ore.num))) {
      n = Number(counters.ore.num) + 1;
    }
    counters.ore = { year, num: n };
    try { localStorage.setItem('counters', JSON.stringify(counters)); } catch {}
    return { year, num: n };
  }

  // Wrapper: prova il nextProgressivo globale e valida, altrimenti fallback
  function getNextOreProgressivo(){
    try{
      if (typeof window.nextProgressivo === 'function'){
        const out = window.nextProgressivo('ore') || {};
        const y = Number(out.year) || (new Date().getFullYear());
        const n = Number(out.num);
        if (Number.isFinite(n) && n > 0) return { year: y, num: n };
      }
    }catch{}
    return safeNextProgressivoOre();
  }

  // Audit log minimo per modifiche/cancellazioni timbrature (locale)
  function appendOreAudit(entry){
    try{
      const key = 'oreAuditRows';
      let arr = [];
      try{
        const raw = localStorage.getItem(key);
        arr = raw ? JSON.parse(raw) || [] : [];
        if (!Array.isArray(arr)) arr = [];
      }catch{
        arr = [];
      }
      const next = [entry, ...arr].slice(0, 500); // tengo solo gli ultimi 500 eventi
      localStorage.setItem(key, JSON.stringify(next));
    }catch(err){
      console.error('appendOreAudit', err);
    }
  }

// Operatori (select se presenti in Impostazioni)
function renderOperatoreField_Local(value, onChange){
  let app = {};
  try{
    app = JSON.parse(localStorage.getItem('appSettings')||'{}');
  }catch{
    app = {};
  }

  const rawOps = Array.isArray(app.operators) ? app.operators : [];
  const ops = rawOps.map(item => {
    if (item && typeof item === 'object') {
      const lab = item.label || item.nome || item.name || item.id || '';
      return String(lab || '').trim();
    }
    return String(item || '').trim();
  }).filter(Boolean);

  return ops.length
    ? e('select', {name:'operatore', value:value, onChange:onChange},
        e('option', {value:''}, '— seleziona —'),
        ...ops.map((op,i)=> e('option',{key:i, value:op}, op))
      )
    : e('input', {name:'operatore', value:value, onChange:onChange, placeholder:'es. Mario Rossi'});
}

// --- Supabase config (se presente) ---
  const sbCfg = (typeof getSB === 'function') && getSB();
  const sbOk = !!sbCfg;

  // --- Dati base ---
  const commesse = React.useMemo(()=>{ try{ return JSON.parse(localStorage.getItem('commesseRows')||'[]'); }catch{ return []; } }, []);

  // ===================== MODALITÀ LOCALE =====================
  // Stato: timbrature locali (solo righe ATTIVE: le cancellate restano in LS come tombstone)
  const [rows, setRows] = React.useState(()=>{
    try{
      let raw = JSON.parse(localStorage.getItem('oreRows') || '[]') || [];
      if (!Array.isArray(raw)) raw = [];

      let changed = false;
      const norm = raw.map((r, i) => {
        if (!r || typeof r !== 'object') return r;
        const out = { ...r };

        // __createdAt per ordinare cronologicamente (upgrade vecchi record)
        if (!out.__createdAt){
          const base = out.data ? (out.data + 'T00:00:00') : new Date().toISOString();
          const t = (Date.parse(base) || Date.now()) + (i * 1000);
          out.__createdAt = new Date(t).toISOString();
          changed = true;
        }
        // updatedAt allineato almeno a __createdAt (serve a mergeById)
        if (!out.updatedAt && out.__createdAt){
          out.updatedAt = out.__createdAt;
          changed = true;
        }
        return out;
      });

      if (changed){
        localStorage.setItem('oreRows', JSON.stringify(norm));
      }

      // Stato React = solo righe NON cancellate
      return norm.filter(r => !r || !r.deletedAt);
    }catch{
      return [];
    }
  });

  // Ogni volta che cambiano le righe ATTIVE, riallineo LS mantenendo anche le cancellate
  React.useEffect(()=>{
    try{
      const key = 'oreRows';
      let raw = JSON.parse(localStorage.getItem(key) || '[]') || [];
      if (!Array.isArray(raw)) raw = [];

      const map = new Map();
      // 1) base: quello che è già in LS (incluse le deletedAt)
      raw.forEach(r => {
        if (r && r.id) map.set(r.id, r);
      });

      // 2) override con le righe attive correnti (rows)
      (Array.isArray(rows) ? rows : []).forEach(r => {
        if (!r || !r.id) return;
        const prev = map.get(r.id);
        if (prev) {
          map.set(r.id, { ...prev, ...r });
        } else {
          map.set(r.id, r);
        }
      });

      const combined = Array.from(map.values());
      localStorage.setItem(key, JSON.stringify(combined));
    }catch{
      /* ignore */
    }
  }, [rows]);

  // --- Filtri condivisi (sia locale che cloud) ---
  const [flt, setFlt] = React.useState({ from:'', to:'', commessa:'', operatore:'', fase:'' });

  // Periodi rapidi per i filtri data
  function applyQuickRange(preset){
    const dayMs = 24*60*60*1000;
    const now   = new Date();
    const today = todayISO();

    let from = '';
    let to   = '';

    if (preset === 'today') {
      from = today;
      to   = today;
    } else if (preset === 'last7') {
      const start = new Date(now.getTime() - 6*dayMs);
      from = start.toISOString().slice(0,10);
      to   = today;
    } else if (preset === 'last30') {
      const start = new Date(now.getTime() - 29*dayMs);
      from = start.toISOString().slice(0,10);
      to   = today;
    } else if (preset === 'month') {
      const year  = now.getFullYear();
      const month = now.getMonth() + 1;
      const mm    = String(month).padStart(2,'0');
      const fromIso = `${year}-${mm}-01`;
      const nextMonthYear  = month === 12 ? year + 1 : year;
      const nextMonthIndex = month === 12 ? 0 : month; // 0-based
      const lastDay = new Date(Date.UTC(nextMonthYear, nextMonthIndex, 1) - dayMs);
      const toIso   = lastDay.toISOString().slice(0,10);
      from = fromIso;
      to   = toIso;
    } else if (preset === 'year') {
      const year = now.getFullYear();
      from = `${year}-01-01`;
      to   = `${year}-12-31`;
    } else if (preset === 'all') {
      from = '';
      to   = '';
    }

    setFlt(prev => ({ ...prev, from, to }));
  }

  // Di default mostra gli ultimi 30 giorni se non hai scelto un intervallo
  React.useEffect(() => {
    setFlt(prev => {
      if (prev.from || prev.to) return prev;
      const dayMs = 24*60*60*1000;
      const now   = new Date();
      const today = todayISO();
      const start = new Date(now.getTime() - 29*dayMs);
      const from  = start.toISOString().slice(0,10);
      return { ...prev, from, to: today };
    });
  }, []);
  const opsImpostazioni = (function(){
    try{ const a = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; return Array.isArray(a.operators)? a.operators.filter(Boolean):[]; }catch{return[]}
  })();
  const selCommessaFiltro = React.useMemo(()=> (commesse.find(c=>c.id===flt.commessa) || null), [commesse, flt.commessa]);
  const fasiFiltro = React.useMemo(()=> Array.isArray(selCommessaFiltro?.fasi) ? selCommessaFiltro.fasi : [], [selCommessaFiltro]);

  function inDateRangeISO(dateStr, from, to){
    const d = String(dateStr||'').slice(0,10);
    if (from && d < from) return false;
    if (to   && d > to)   return false;
    return true;
  }

  // form locale
  const [form, setForm] = React.useState({
    id: '',
    data: todayISO(),
    commessaId: '',
    faseIdx: '',
    operatore: '',
    oreHHMM: '1:00',
    qtaPezzi: '',
    note: ''
  });

  const selCommessaLoc = React.useMemo(
    ()=> (commesse.find(c=>c.id===form.commessaId) || null),
    [commesse, form.commessaId]
  );
  const fasiLoc = React.useMemo(()=> Array.isArray(selCommessaLoc?.fasi) ? selCommessaLoc.fasi : [], [selCommessaLoc]);

  function onChangeLocal(ev){
    const {name, value} = ev.target;
    setForm(p=>({...p, [name]: value}));
  }
  function validateLocal(){
    if(!form.data) return 'Data obbligatoria';
    if(!form.commessaId) return 'Seleziona una commessa';
    const mins = toMin(form.oreHHMM);
    if(!Number.isFinite(mins) || mins<=0) return 'Ore non valide (HH:MM > 0)';
    if(form.faseIdx!=='' && (Number(form.faseIdx)<0 || Number(form.faseIdx)>=fasiLoc.length)) return 'Fase non valida';
    return null;
  }
  function resetLocalForm(){
    setForm({
      id: '',
      data: todayISO(),
      commessaId: '',
      faseIdx: '',
      operatore: '',
      oreHHMM: '1:00',
      qtaPezzi: '',
      note: ''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function startEditLocal(r){
    if (!isAdmin){
      alert('Solo un utente ADMIN può modificare una registrazione ore.');
      return;
    }
    const mins = Number(r.oreMin) || toMin(r.oreHHMM || '0') || 0;
    const hhmm = r.oreHHMM || fmtHHMMfromMin(mins);

    setForm({
      id        : r.id || '',
      data      : r.data || todayISO(),
      commessaId: r.commessaId || '',
      faseIdx   : (r.faseIdx == null ? '' : String(r.faseIdx)),
      operatore : r.operatore || '',
      oreHHMM   : hhmm,
      qtaPezzi  : (r.qtaPezzi!=null && r.qtaPezzi!=='') ? String(r.qtaPezzi) : '',
      note      : r.note || ''
    });

    // porta in alto il form, così vedi chiaramente che sei in modifica
    try{
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }catch{}
  }
  
    // Validazione dati form locale
  function validateLocal(){
    const d = String(form.data || '').trim();
    if (!d) return 'Seleziona una data per la registrazione.';

    const commId = String(form.commessaId || '').trim();
    if (!commId) return 'Seleziona una commessa.';

    // ore: accetto HH:MM o minuti numerici
    const rawOre = String(form.oreHHMM || '').trim();
    const mins = toMin(rawOre || form.oreMin || form.ore);
    if (!Number.isFinite(mins) || mins <= 0){
      return 'Inserisci un valore di ore valido nel formato H:MM (es. 1:30).';
    }

    // qtaPezzi non è obbligatoria, ma se c'è dev’essere >= 0
    if (form.qtaPezzi != null && form.qtaPezzi !== ''){
      const q = Number(form.qtaPezzi);
      if (!Number.isFinite(q) || q < 0){
        return 'La quantità pezzi deve essere un numero positivo (o vuota).';
      }
    }

    return '';
  }

  // Salva locale (nuova o modifica esistente)
  function saveLocal(ev){
    ev.preventDefault();
    const err = validateLocal(); 
    if (err){ alert(err); return; }

    const oreMin = toMin(form.oreHHMM);
    const isEdit = !!form.id && (rows || []).some(r => r.id === form.id);

    // --- MODIFICA ESISTENTE ---
    if (isEdit){
      if (!isAdmin){
        alert('Solo un utente ADMIN può modificare una registrazione ore esistente.');
        return;
      }

      const nowISO = new Date().toISOString();

      const updatedFields = {
        data      : form.data,
        commessaId: form.commessaId,
        faseIdx   : (form.faseIdx === '' ? null : Number(form.faseIdx)),
        operatore : form.operatore,
        oreHHMM   : form.oreHHMM,
        oreMin,
        ore       : +(oreMin/60).toFixed(2),
        qtaPezzi  : Math.max(0, Number(form.qtaPezzi||0)),
        note      : form.note,
        updatedAt       : nowISO,
        __editedAt      : nowISO,
        __editedBy      : currentUserLabel || null,
        __editedManually: true
      };

      // Applica la modifica all'array corrente e persiste SUBITO via lsSet
      const nextRows = (Array.isArray(rows) ? rows : []).map(r => {
        if (r.id !== form.id) return r;
        return { ...r, ...updatedFields };
      });
      setRows(nextRows);
      try{
        if (typeof lsSet === 'function') {
          lsSet('oreRows', nextRows); // segna anche __anima_dirty
        } else {
          localStorage.setItem('oreRows', JSON.stringify(nextRows));
        }
      }catch{}

      // audit "update"
      try{
        appendOreAudit({
          ts        : nowISO,
          action    : 'update',
          id        : form.id || null,
          commessaId: form.commessaId || '',
          data      : form.data || null,
          operatore : form.operatore || '',
          minutes   : oreMin,
          qtaPezzi  : Math.max(0, Number(form.qtaPezzi||0)),
          note      : form.note || '',
          user      : currentUserLabel || null,
          role      : (u && u.role) || null
        });
      }catch(err){
        console.error('appendOreAudit update failed', err);
      }

      alert('Registrazione aggiornata ✅');
      resetLocalForm();
      return;
    }

    // --- NUOVA REGISTRAZIONE ---
    const { year, num } = getNextOreProgressivo();
    const recId = `O-${year}-${String(num).padStart(3,'0')}`;

    const nowISO = new Date().toISOString();

    const rec = {
      id: recId,
      ...form,
      faseIdx: (form.faseIdx === '' ? null : Number(form.faseIdx)),
      oreMin,
      ore: +(oreMin/60).toFixed(2),
      qtaPezzi: Math.max(0, Number(form.qtaPezzi||0)),
      __createdAt: nowISO,
      updatedAt  : nowISO
    };

    // metto in testa così lo vedi subito
    const nextRows = [rec, ...(Array.isArray(rows) ? rows : [])];
    setRows(nextRows);
    try{
      if (typeof lsSet === 'function') {
        lsSet('oreRows', nextRows); // segna dirty per l'auto-sync
      } else {
        localStorage.setItem('oreRows', JSON.stringify(nextRows));
      }
    }catch{}
    alert('Registrazione salvata in locale ✅');
    resetLocalForm();
  }


  function delLocal(r){
    if (!isAdmin){
      alert('Solo un utente ADMIN può eliminare una registrazione ore.');
      return;
    }
    if (!confirm(`Eliminare registrazione ${r.id}?`)) return;

    try{
      const mins = Number(r.oreMin) || toMin(r.oreHHMM || '0') || 0;
      appendOreAudit({
        ts        : new Date().toISOString(),
        action    : 'delete',
        id        : r.id || null,
        commessaId: r.commessaId || '',
        data      : r.data || null,
        operatore : r.operatore || '',
        minuti    : mins
      });

      // 1) Soft delete su LS: segno deletedAt/updatedAt sul record con lo stesso id
      const nowISO = new Date().toISOString();
      let raw = [];
      try{
        raw = lsGet('oreRows', []) || [];
      }catch{
        try{ raw = JSON.parse(localStorage.getItem('oreRows') || '[]') || []; }catch{ raw = []; }
      }
      if (!Array.isArray(raw)) raw = [];

      const rawNext = raw.map(row => {
        if (row && row.id === r.id && !row.deletedAt) {
          return { ...row, deletedAt: nowISO, updatedAt: nowISO };
        }
        return row;
      });

      // Righe ATTIVE dopo la cancellazione (usate in UI e per riallineo commessa)
      const oreRowsAfter = rawNext.filter(o => !o || !o.deletedAt);

      // Aggiorna stato + salva SUBITO in LS (tombstone inclusa)
      setRows(oreRowsAfter);
      try{
        if (typeof lsSet === 'function') {
          lsSet('oreRows', rawNext);
        } else {
          localStorage.setItem('oreRows', JSON.stringify(rawNext));
        }
      }catch{}

      // 2) riallinea commessa.qtaProdotta con le timbrature residue (solo ATTIVE)
      const jobId = String(r.commessaId || '');
      if (jobId) {
        const allRaw = (typeof lsGet === 'function'
          ? lsGet('commesseRows', [])
          : JSON.parse(localStorage.getItem('commesseRows') || '[]') || []);

        const all = Array.isArray(allRaw) ? allRaw : [];
        const ix = all.findIndex(c => String(c.id || '') === jobId);

        if (ix >= 0) {
          const c = { ...all[ix] };

          // Timbrature residue per quella commessa DOPO la cancellazione (solo non-deleted)
          const evAfter = oreRowsAfter.filter(o => String(o.commessaId || '') === jobId);

          if (!evAfter.length) {
            // Nessuna timbratura residua: azzero produzione legacy
            c.qtaProdotta = 0;

            if (Array.isArray(c.fasi)) {
              c.fasi = c.fasi.map(f => ({ ...f, qtaProdotta: 0 }));
            }

            if (Array.isArray(c.righeArticolo)) {
              c.righeArticolo = c.righeArticolo.map(riga => ({
                ...riga,
                qtaProdotta: 0,
                fasi: Array.isArray(riga.fasi)
                  ? riga.fasi.map(f => ({ ...f, qtaProdotta: 0 }))
                  : riga.fasi
              }));
            }
          } else if (typeof window !== 'undefined'
              && typeof window.producedPiecesCore === 'function') {
            // Restano timbrature: riallineo qtaProdotta alla produzione effettiva
            const totComm = Math.max(1, Number(c.qtaPezzi || 0));
            const newProd = Number(window.producedPiecesCore(c, oreRowsAfter) || 0);
            c.qtaProdotta = Math.max(0, Math.min(totComm, newProd));
          }

          const nextAll = all.slice();
          nextAll[ix] = c;

          if (typeof lsSet === 'function') {
            lsSet('commesseRows', nextAll);
          } else {
            try{ localStorage.setItem('commesseRows', JSON.stringify(nextAll)); }catch{}
          }
          window.__anima_dirty = true;
        }
      }
    }catch(err){
      console.error('Errore in delLocal', err);
      alert('Errore durante l\'eliminazione: ' + (err?.message || err));
    }
  }

  // ===================== MODALITÀ CLOUD (SUPABASE) =====================
  const [mode, setMode] = React.useState(sbOk ? 'cloud' : 'local'); // 'cloud' | 'local'
  const [cloudRows, setCloudRows] = React.useState([]);
  const [cloudLoading, setCloudLoading] = React.useState(false);

  async function loadCloud(){
    if(!sbOk) return;
    try{
      setCloudLoading(true);
            const sb = getSB();
      const url = `${sb.url}/rest/v1/timesheets?select=*&order=created_at.desc`;
      const res = await fetch(url, { headers:{ apikey: sb.key, Authorization:`Bearer ${sb.key}` } });
      if(!res.ok){
        const txt = await res.text();
        // Se la tabella timesheets non esiste (404 / PGRST205),
        // consideriamo la funzione "cloud timbrature" disattivata e non disturbiamo l'utente.
        if (res.status === 404 || (txt && txt.includes("timesheets"))) {
          console.warn('[loadCloud] tabella timesheets non trovata su Supabase; cloud timbrature disabilitato.');
          setCloudRows([]);
          return;
        }
        throw new Error(`HTTP ${res.status} – ${txt || res.statusText}`);
      }
      const data = await res.json();
      setCloudRows(Array.isArray(data)?data:[]);
    }catch(err){
      console.error('[loadCloud]', err);
      alert('Errore caricamento cloud: ' + (err?.message || err));
    }finally{
      setCloudLoading(false);
    }
  }
  React.useEffect(()=>{ if(sbOk){ loadCloud(); } }, [sbOk]);

  // === Watermark (ISO) & dedup ID importati ===
function _getWMISO(key){
  try{
    const raw = JSON.parse(localStorage.getItem(key)||'{}');
    if (!raw || !raw.ts) return '1970-01-01T00:00:00Z';
    return Number.isFinite(raw.ts) ? new Date(raw.ts).toISOString() : String(raw.ts);
  }catch{ return '1970-01-01T00:00:00Z'; }
}
function _setWMISO(key, isoOrMs){
  try{
    const iso = Number.isFinite(isoOrMs) ? new Date(isoOrMs).toISOString() : String(isoOrMs);
    localStorage.setItem(key, JSON.stringify({ ts: iso }));
  }catch{}
}
function _getImportedCloudIds(){
  try{ return new Set(JSON.parse(localStorage.getItem('ORE_CLOUD_IMPORTED_IDS')||'[]')); }catch{ return new Set(); }
}
function _saveImportedCloudIds(set){
  try{ localStorage.setItem('ORE_CLOUD_IMPORTED_IDS', JSON.stringify(Array.from(set))); }catch{}
}

  // Import nuove dal Cloud (accetta {silent:true} per non mostrare alert)
  async function importNewFromCloud(opts={}) {
  function parseQtyFromNote(note) {
    try {
      const s = String(note || '');
      // pattern tipo "Qta: 5"
      let m = s.match(/Qta\s*[:=]\s*(\d+)/i);
      if (!m) {
        // pattern vecchio "Quantità prodotta: 5"
        m = s.match(/Quantit[àa]\s*prodotta\s*[:=]\s*(\d+)/i);
      }
      if (!m) return 0;
      const val = Number(m[1].replace(',', '.'));
      return (Number.isFinite(val) && val > 0) ? val : 0;
    } catch {
      return 0;
    }
  }
  const silent = !!opts.silent;
  if(!sbOk){ if(!silent) alert('Configura Supabase in Impostazioni.'); return 0; }
  try{
    const sb = getSB();
    const WM_KEY = 'ORE_CLOUD_WM';
    const wmIso = _getWMISO(WM_KEY);
    const url = `${sb.url}/rest/v1/timesheets?select=*&order=created_at.asc&created_at=gt.${encodeURIComponent(wmIso)}&limit=1000`;
        const res = await fetch(url, { headers:{ apikey: sb.key, Authorization:`Bearer ${sb.key}` } });
    if(!res.ok){
      const txt = await res.text();
      if (res.status === 404 || (txt && txt.includes("timesheets"))) {
        console.warn('[importNewFromCloud] tabella timesheets non trovata su Supabase; cloud timbrature disabilitato.');
        if(!silent) alert('Funzione cloud timbrature non configurata (tabella "timesheets" assente su Supabase).');
        return 0;
      }
      throw new Error(txt || `HTTP ${res.status}`);
    }
    const data = await res.json();

          if(!Array.isArray(data) || data.length===0){
      if(!silent) alert('Nessuna novità dal cloud.');
      return 0;
    }

    const base = (function(){ try{ return JSON.parse(localStorage.getItem('oreRows')||'[]'); }catch{return []} })();
    const importedIds = _getImportedCloudIds();
    let maxIso = wmIso;
    const toAdd = [];

    for(const r of data){
      const cloudId = r.id; // PK/UUID su timesheets
      if (cloudId && importedIds.has(cloudId)) {
        if (r.created_at && r.created_at > maxIso) maxIso = r.created_at;
        continue;
      }
      const oreMin = Number(r.minutes||0);
      const { year, num } = getNextOreProgressivo();
      const qtaPezzi = parseQtyFromNote(r.note);
      const createdISO = new Date(r.created_at || Date.now()).toISOString();
      const rec = {
        id: `O-${year}-${String(num).padStart(3,'0')}`,
        data: String(r.created_at||'').slice(0,10),
        commessaId: r.commessa_id || '',
        faseIdx: (r.fase_idx==null ? null : Number(r.fase_idx)),
        operatore: r.operatore || '',
        oreHHMM: fmtHHMMfromMin(oreMin),
        qtaPezzi,              // (se l’avevamo già messo prima)
        note: r.note || '',
        oreMin,
        ore: +((oreMin||0)/60).toFixed(2),
        __createdAt: createdISO,
        updatedAt  : createdISO
      };

      if (rec.qtaPezzi && rec.commessaId) {
        applyCloudQtyToCommessa(rec.commessaId, rec.faseIdx, rec.qtaPezzi);
      }

      toAdd.push(rec);

      if (cloudId) importedIds.add(cloudId);
      if (r.created_at && r.created_at > maxIso) maxIso = r.created_at;
    }

    if(toAdd.length===0){
      if(!silent) alert('Nessuna nuova timbratura (tutte già importate).');
      return 0;
    }

    setRows(prev => [...prev, ...toAdd]);
    _saveImportedCloudIds(importedIds);
    _setWMISO(WM_KEY, maxIso);

    if(!silent) alert(`Importate ${toAdd.length} timbrature dal cloud ✅`);
    return toAdd.length;
    }catch(err){
      console.error('[importNewFromCloud]', err);
      if(!silent) alert('Errore import dal cloud: ' + (err?.message || err));
      return 0;
    }
  }

  // Flag vista aperta + auto ricezione silenziosa ogni 15s quando in CLOUD
  React.useEffect(()=>{
    window.__O_PAGE_ACTIVE = true;
    return ()=>{ window.__O_PAGE_ACTIVE = false; };
  },[]);
  React.useEffect(()=>{
    if (mode!=='cloud' || !sbOk) return;
    let stop=false, t=null;
    const tick = async ()=>{
      if (stop || !window.__O_PAGE_ACTIVE) return;
      try{ await importNewFromCloud({silent:true}); }catch{}
      t = setTimeout(tick, 15000);
    };
    t = setTimeout(tick, 15000);
    return ()=>{ stop=true; if(t) clearTimeout(t); };
  }, [mode, sbOk]);

  // ===== Filtri applicati =====
  const q = (query||'').toLowerCase();

  // Locale filtrato + ordinato (più recente in alto)
  const rowsFiltrateLocal = rows
    .filter(r => {
      // filtri
      if (flt.from || flt.to) {
        if (!inDateRangeISO(r.data, flt.from, flt.to)) return false;
      }
      if (flt.commessa && r.commessaId !== flt.commessa) return false;
      if (flt.operatore && String(r.operatore||'') !== flt.operatore) return false;
      if (flt.fase === 'extra') {
        if (r.faseIdx != null) return false;
      } else if (flt.fase !== '' && flt.fase != null) {
        if (r.faseIdx == null || String(r.faseIdx) !== String(flt.fase)) return false;
      }
      // ricerca libera
      return (r.id+' '+r.commessaId+' '+(r.operatore||'')+' '+(r.note||'')).toLowerCase().includes(q);
    })
    .sort((a,b)=>{
      const ta = Date.parse(a.__createdAt || (a.data ? (a.data + 'T00:00:00') : 0)) || 0;
      const tb = Date.parse(b.__createdAt || (b.data ? (b.data + 'T00:00:00') : 0)) || 0;
      if (tb !== ta) return tb - ta;
      const ra = String(a.id||'').match(/^O-(\d{4})-(\d{1,})$/);
      const rb = String(b.id||'').match(/^O-(\d{4})-(\d{1,})$/);
      if (ra && rb){
        const ya = +ra[1], na = +ra[2];
        const yb = +rb[1], nb = +rb[2];
        if (yb !== ya) return yb - ya;
        if (nb !== na) return nb - na;
      }
      return String(b.id||'').localeCompare(String(a.id||''));
    });

  // Cloud filtrato
  const rowsFiltrateCloud = (cloudRows||[]).filter(r=>{
    const d = String(r.created_at||'').slice(0,10);
    if (flt.from || flt.to){
      if (!inDateRangeISO(d, flt.from, flt.to)) return false;
    }
    if (flt.commessa && (r.commessa_id||'') !== flt.commessa) return false;
    if (flt.operatore && String(r.operatore||'') !== flt.operatore) return false;
    if (flt.fase === 'extra') {
      if (r.fase_idx != null) return false;
    } else if (flt.fase !== '' && flt.fase != null) {
      if (r.fase_idx == null || String(r.fase_idx) !== String(flt.fase)) return false;
    }
    const s = (r.commessa_id+' '+(r.operatore||'')+' '+(r.note||'')+' '+(r.created_at||'')).toLowerCase();
    return s.includes(q);
  });

  // Totale minuti EXTRA "Cambio Bombola Gas" sul dataset visibile
  function isGasNote(t){ return /cambio\s*bombola\s*gas/i.test(String(t||'')); }
  const extraLocalMin = rowsFiltrateLocal.reduce((s,r)=>{
    const mins = Number(r.oreMin)||toMin(r.oreHHMM)||0;
    return s + ((r.faseIdx==null && isGasNote(r.note)) ? mins : 0);
  }, 0);
  const extraCloudMin = rowsFiltrateCloud.reduce((s,r)=>{
    const mins = Number(r.minutes)||0;
    return s + ((r.fase_idx==null && isGasNote(r.note)) ? mins : 0);
  }, 0);

  // Export CSV locale
  function exportCSVLocal(){
    const header = ['ID','Data','Commessa','Fase','Operatore','Ore (HH:MM)','Minuti','Qta','Note'];
    const body = rowsFiltrateLocal.map(r => {
      const c = commesse.find(x=>x.id===r.commessaId);
      const faseLab = (function(){
        // 1) Usa helper centrale se disponibile (stessa logica di Report Tempi)
        if (typeof window !== 'undefined'
          && typeof window.faseLabelFromRow === 'function') {
          return window.faseLabelFromRow(r);
        }

        // 2) Fallback: logica legacy
        if (r.faseIdx == null) return '';
        if (typeof window.faseLabel === 'function') return window.faseLabel(c, Number(r.faseIdx));
        const f = c && Array.isArray(c?.fasi) ? c.fasi[r.faseIdx|0] : null;
        return (f && f.lav) ? f.lav : `Fase ${(r.faseIdx|0)+1}`;
      })();
      return [
        r.id, r.data, r.commessaId, faseLab,
        r.operatore||'',
        r.oreHHMM||fmtHHMMfromMin(r.oreMin||0),
        String(r.oreMin||0),
        String(r.qtaPezzi||0),
        r.note||''
      ];
    });
    const csv = [header, ...body].map(row =>
      row.map(v => {
        const s = String(v==null?'':v);
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'registrazioni_ore_locale.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Export CSV cloud
  function exportCSVCloud(){
    const header = ['ID','Created at','Commessa','Fase','Operatore','Minuti','HH:MM','Note'];
    const body = rowsFiltrateCloud.map(r => [
      r.id, r.created_at, r.commessa_id || '',
      (function(){
        if (r.fase_idx==null) return '';
        const c = commesse.find(x=>x.id===r.commessa_id);
        const f = c && Array.isArray(c?.fasi) ? c.fasi[r.fase_idx|0] : null;
        return (f && f.lav) ? f.lav : `Fase ${(r.fase_idx|0)+1}`;
      })(),
      r.operatore || '', String(r.minutes||0),
      fmtHHMMfromMin(r.minutes||0), r.note || ''
    ]);
    const csv = [header, ...body].map(row =>
      row.map(v => {
        const s = String(v==null?'':v);
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'registrazioni_ore_cloud.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ===== UI =====
  return e('div', {className:'grid', style:{gap:16}},

    // Switch sorgente (HEADER)
    e('div', {className:'card'},
      e('div', {className:'actions', style:{justifyContent:'space-between'}},
        e('div', {className:'row', style:{gap:8}},
          e('button', {
            className: mode==='cloud' ? 'btn' : 'btn btn-outline',
            onClick: ()=> setMode('cloud'),
            disabled: !sbOk
          }, 'Sorgente: Cloud'),
          e('button', {
            className: mode==='local' ? 'btn' : 'btn btn-outline',
            onClick: ()=> setMode('local')
          }, 'Sorgente: Locale')
        ),
        (mode==='cloud'
          ? e('div', {className:'row', style:{gap:8, alignItems:'center'}},
              e('span', {className:'muted'}, `Extra gas visibili: ${fmtHHMMfromMin(extraCloudMin)}`),
              e('button', {className:'btn', onClick:loadCloud, disabled:!sbOk || cloudLoading},
                cloudLoading?'Carico…':'Aggiorna'
              ),
              rowsFiltrateCloud.length>0 && e('button', {className:'btn btn-outline', onClick:exportCSVCloud}, 'Esporta CSV'),
              e('button', {className:'btn btn-outline', onClick:()=>importNewFromCloud({silent:false})}, 'Importa nuove dal Cloud')
            )
          : e('div', {className:'row', style:{gap:8, alignItems:'center'}},
              e('span', {className:'muted'}, `Extra gas visibili: ${fmtHHMMfromMin(extraLocalMin)}`),
              rowsFiltrateLocal.length>0 && e('button', {className:'btn btn-outline', onClick:exportCSVLocal}, 'Esporta CSV')
            )
        )
      )
    ),

    // PANNELLO FILTRI
    e('div', {className:'card'},
      e('div', {className:'row', style:{gap:12, alignItems:'end', flexWrap:'wrap'}},
        e('div', null, e('label', null, 'Dal'),
          e('input', {type:'date', value:flt.from, onChange:ev=>setFlt(p=>({...p, from: ev.target.value}))})
        ),
        e('div', null, e('label', null, 'Al'),
          e('input', {type:'date', value:flt.to, onChange:ev=>setFlt(p=>({...p, to: ev.target.value}))})
        ),
        e('div', null, e('label', null, 'Commessa'),
          e('select', {value:flt.commessa, onChange:ev=>setFlt(p=>({...p, commessa: ev.target.value, fase:''}))},
            e('option', {value:''}, '— tutte —'),
            commesse.map(c => e('option', {key:c.id, value:c.id}, c.id + (c.descrizione? (' • '+c.descrizione):'')))
          )
        ),
        e('div', null, e('label', null, 'Operatore'),
          e('select', {value:flt.operatore, onChange:ev=>setFlt(p=>({...p, operatore: ev.target.value}))},
            e('option', {value:''}, '— tutti —'),
              opsImpostazioni.map((op,i)=>{
              const label = (typeof op === 'string')
                ? op
                : String(op.name || op.label || '').trim();
              if (!label) return null;
              return e('option', {key:i, value:label}, label);
            })

          )
        ),
        e('div', null, e('label', null, 'Fase'),
          e('select', {value:flt.fase, onChange:ev=>setFlt(p=>({...p, fase: ev.target.value}))},
            e('option', {value:''}, '— tutte —'),
            e('option', {value:'extra'}, 'Solo EXTRA'),
            ...(fasiFiltro||[]).map((f,idx)=> e('option', {key:idx, value:String(idx)},
              (typeof window.faseLabel==='function' ? window.faseLabel(selCommessaFiltro, idx) : `Fase ${idx+1}`)
            ))
          )
        ),
        e('div', {className:'actions'},
          e('button', {className:'btn btn-outline', onClick:()=>setFlt({from:'',to:'',commessa:'',operatore:'',fase:''})}, 
'Pulisci filtri')
        )
      ),
      e('div', {className:'row', style:{gap:8, marginTop:8, flexWrap:'wrap'}},
        e('span', {className:'muted'}, 'Periodo rapido:'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('today')},  'Oggi'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('last7')},  'Ultimi 7 giorni'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('month')},  'Mese corrente'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('last30')}, 'Ultimi 30 giorni'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('year')},   'Anno corrente'),
        e('button', {className:'btn btn-outline', onClick:()=>applyQuickRange('all')},    'Tutto')
      )
    ),

    // ======= CLOUD =======
    (mode==='cloud') && e('div', {className:'grid', style:{gap:16}},
      // Form cloud (semplice)
      e('div', {className:'card'},
        e('h3', {style:{marginBottom:8}}, 'Nuova/modifica timbratura (cloud)'),
        e('div', {className:'muted'}, 'Inserimento diretto nel cloud. Per ora lasciamo solo import/lettura come flusso principale.')
      ),

      // Elenco cloud
      e('div', {className:'card'},
        e('div', {className:'actions', style:{justifyContent:'space-between', marginBottom:8}},
          e('h3', null, 'Timbrature (cloud, filtrate)'),
          e('span', {className:'muted'}, `${rowsFiltrateCloud.length} record`)
        ),
        (rowsFiltrateCloud.length===0)
          ? e('div', {className:'muted'}, sbOk ? (cloudLoading ? 'Caricamento…' : 'Nessuna timbratura') : 'Configura Supabase in Impostazioni')
          : e('table', {className:'table'},
              e('thead', null,
                e('tr', null,
                  e('th', null, 'Data'),
                  e('th', null, 'Commessa'),
                  e('th', null, 'Fase'),
                  e('th', null, 'Operatore'),
                  e('th', {className:'right'}, 'Min'),
                  e('th', {className:'right'}, 'HH:MM'),
                  e('th', {className:'right'}, 'Qta'),
                  e('th', null, 'Note')
                )
              ),
              e('tbody', null,
                rowsFiltrateCloud.map(r => e('tr', {key:r.id},
                  e('td', null, new Date(r.created_at).toLocaleString('it-IT')),
                  e('td', null, r.commessa_id || '—'),
                  e('td', null, (function(){
                    if (r.fase_idx == null) return '—';

                    // Se il record cloud ha già un label esplicito, usiamo quello
                    const stored = r.fase_label_at_reg || r.fase_label || r.faseLabel;
                    if (stored) return String(stored);

                    const idx = (r.fase_idx|0);
                    const cid = String(r.commessa_id || '');

                    const allC = Array.isArray(commesse) ? commesse : [];
                    const c = allC.find(x => String(x.id) === cid);

                    let label = '';

                    // 1) Fasi della commessa (lav/label/nome/reparto)
                    try{
                      if (c && Array.isArray(c.fasi) && c.fasi[idx]) {
                        const f = c.fasi[idx];
                        label = f.lav || f.label || f.nome || f.reparto || f.repartoNome || '';
                      }
                    }catch(e){}

                    // 2) Fasi standard da appSettings (fallback)
                    if (!label) {
                      try{
                        const app = (typeof lsGet === 'function')
                          ? lsGet('appSettings', {})
                          : JSON.parse(localStorage.getItem('appSettings')||'{}');
                        const fas = Array.isArray(app && app.fasiStandard) ? app.fasiStandard : [];
                        const entry = fas[idx];
                        if (entry){
                          label = (typeof entry === 'string')
                            ? entry
                            : (entry.label || entry.nome || entry.lav || entry.reparto || entry.repartoNome || '');
                        }
                      }catch(e){}
                    }

                    if (!label) label = `Fase ${idx+1}`;
                    return label;
                  })() ),
                  e('td', null, r.operatore || '—'),
                  e('td', {className:'right'}, String(r.minutes||0)),
                  e('td', {className:'right'}, fmtHHMMfromMin(r.minutes||0)),
                  e('td', {className:'right'}, (function(){
                    // 1) Se il record cloud ha un campo strutturato (es. qta_pezzi o qtaPezzi), usalo
                    const raw = (r.qta_pezzi ?? r.qtaPezzi);
                    const n = Number(raw);
                    if (Number.isFinite(n) && n > 0) return String(n);

                    // 2) Fallback compatibilità: prova a leggerla dalla nota ("Qta: X", "Quantità prodotta: X")
                    const parsed = (typeof parseQtyFromNoteCloud === 'function')
                      ? parseQtyFromNoteCloud(r.note)
                      : '';
                    return parsed || '';
                  })()),
                  e('td', null, r.note || ' ')
                ))
              )
            )
      )
    ),

    // ======= LOCALE =======
    (mode==='local') && e('div', {className:'grid', style:{gap:16}},
      // Form locale
      e('div', {
          className:'card',
          style: form.id ? { border:'2px solid #f97316' } : {}
        },
        e('h3', {style:{marginBottom:8}},
          form.id
            ? `Modifica registrazione ore (locale) — ${form.id}`
            : 'Nuova registrazione ore (locale)'
        ),
       e('form', {className:'form', onSubmit:saveLocal},
          e('div', null, e('label', null, 'Data'),
            e('input', {type:'date', name:'data', value:form.data, onChange:onChangeLocal})
          ),
          e('div', null, e('label', null, 'Commessa'),
            e('select', {name:'commessaId', value:form.commessaId, onChange:onChangeLocal},
              e('option', {value:''}, '— seleziona —'),
              commesse.map(c => e('option', {key:c.id, value:c.id}, `${c.id} • ${c.cliente||''} • ${c.descrizione||''}`))
            )
          ),
          e('div', null, e('label', null, 'Fase (opzionale)'),
            e('select', {name:'faseIdx', value:form.faseIdx, onChange:onChangeLocal, disabled:!selCommessaLoc || fasiLoc.length===0},
              e('option', {value:''}, '— intera commessa —'),
              fasiLoc.map((f,idx)=> e('option', { key:idx, value:String(idx) }, (typeof window.faseLabel==='function'? window.faseLabel(selCommessaLoc, idx):`Fase ${idx+1}`)))
            )
          ),
          e('div', null,
            e('label', null, 'Operatore'),
            renderOperatoreField_Local(form.operatore, onChangeLocal)
          ),
          e('div', null, e('label', null, 'Ore (HH:MM)'),
            e('input', {name:'oreHHMM', value:form.oreHHMM, onChange:onChangeLocal, placeholder:'es. 1:30'})
          ),
          e('div', null, e('label', null, 'Quantità (pezzi)'),
            e('input', {name:'qtaPezzi', type:'number', min:'0', step:'1', value:form.qtaPezzi||'', onChange:onChangeLocal})
          ),
          e('div', {style:{gridColumn:'1 / -1'}}, e('label', null, 'Note'),
            e('textarea', {name:'note', value:form.note, onChange:onChangeLocal})
          ),
          e('div', {className:'actions', style:{gridColumn:'1 / -1', justifyContent:'flex-end', gap:8}},
            form.id && e('button', {
              type:'button',
              className:'btn btn-outline',
              onClick: resetLocalForm
            }, 'Annulla modifica'),
            e('button', {
              className:'btn',
              type:'submit',
              ...roBtnProps()
            }, form.id ? 'Aggiorna registrazione' : 'Salva registrazione (locale)')

          )
        )
      ),

      // Elenco locale
      e('div', {className:'card'},
        e('div', {className:'actions', style:{justifyContent:'space-between', marginBottom:8}},
          e('h3', null, 'Registrazioni recenti (locale, filtrate)'),
          e('span', {className:'muted'}, `${rowsFiltrateLocal.length} record`)
        ),
        rowsFiltrateLocal.length===0
          ? e('div', {className:'muted'}, 'Nessuna registrazione')
          : e('table', {className:'table'},
              e('thead', null,
                e('tr', null,
                  e('th', null, 'ID'),
                  e('th', null, 'Data'),
                  e('th', null, 'Commessa'),
                  e('th', null, 'Fase'),
                  e('th', null, 'Operatore'),
                  e('th', {className:'right'}, 'Ore (HH:MM)'),
                  e('th', {className:'right'}, 'Qta'),
                  e('th', null, 'Note'),
                  e('th', null, 'Azioni')
                )
              ),
              e('tbody', null,
                (rowsFiltrateLocal.slice().sort((a,b)=>{
                  const ta = Date.parse(a.__createdAt||a.created_at||a.data||a.date||0)||0;
                  const tb = Date.parse(b.__createdAt||b.created_at||b.data||b.date||0)||0;
                  if (tb!==ta) return tb-ta;
                  return String(b.id||'').localeCompare(String(a.id||''));
                })).map((r,i)=>{
                const faseLab = (function(){
                  // Nessuna fase → Extra
                  if (r.faseIdx === '' || r.faseIdx == null) return 'Extra';

                  // 1) Se abbiamo salvato un nome fase, ma NON è "Fase N", usiamo quello
                  const storedRaw = r.faseLabelAtReg != null ? String(r.faseLabelAtReg).trim() : '';
                  if (storedRaw && !/^fase\s+\d+$/i.test(storedRaw)) {
                    return storedRaw;
                  }

                  const idx = Number(r.faseIdx);
                  if (!Number.isFinite(idx) || idx < 0) return `Fase ${r.faseIdx}`;

                  const commId = r.commessaId != null ? String(r.commessaId) : '';
                  const allC = Array.isArray(commesse) ? commesse : [];
                  const c = allC.find(x => String(x.id) === commId);

                  let label = '';

                  // 2) Fasi per-riga articolo, se abbiamo rigaIdx
                  try{
                    const righe = c && Array.isArray(c.righeArticolo)
                      ? c.righeArticolo
                      : (c && Array.isArray(c.righe) ? c.righe : []);
                    const rIdxRaw = r.rigaIdx;
                    const rIdx = (rIdxRaw === '' || rIdxRaw == null) ? null : Number(rIdxRaw);

                    if (
                      Number.isFinite(rIdx) &&
                      rIdx >= 0 &&
                      Array.isArray(righe) &&
                      righe[rIdx] &&
                      Array.isArray(righe[rIdx].fasi)
                    ){
                      const f = righe[rIdx].fasi[idx];
                      if (f){
                        label = f.lav || f.label || f.nome || f.reparto || f.repartoNome || '';
                      }
                    }
                  }catch(e){}

                  // 3) Fasi globali commessa
                  if (!label){
                    try{
                      const fasiG = c && Array.isArray(c.fasi) ? c.fasi : [];
                      if (fasiG[idx]){
                        const f = fasiG[idx];
                        label = f.lav || f.label || f.nome || f.reparto || f.repartoNome || '';
                      }
                    }catch(e){}
                  }

                  // 4) Fasi standard da appSettings (stesso indice)
                  if (!label){
                    try{
                      const app = (typeof lsGet === 'function')
                        ? lsGet('appSettings', {})
                        : JSON.parse(localStorage.getItem('appSettings')||'{}');
                      const fas = Array.isArray(app && app.fasiStandard) ? app.fasiStandard : [];
                      const entry = fas[idx];
                      if (entry){
                        label = (typeof entry === 'string')
                          ? entry
                          : (entry.label || entry.nome || entry.lav || entry.reparto || entry.repartoNome || '');
                      }
                    }catch(e){}
                  }

                  if (!label) label = `Fase ${idx+1}`;
                  return label;
                })();
                  return e('tr', {key:r.id||i},
                    e('td', null,
                      r.id,
                      r.__editedManually ? ' ✎' : ''
                    ),
                    e('td', null, r.data),
                    e('td', null, r.commessaId),
                    e('td', null, faseLab || '—'),
                    e('td', null, r.operatore || '—'),
                    e('td', {className:'right'}, r.oreHHMM || fmtHHMMfromMin(r.oreMin||0)),
                    e('td', {className:'right'}, String(r.qtaPezzi||0)),
                    e('td', null, r.note || ' '),
                    e('td', null,
                      isAdmin && e('button', {
                        className:'btn btn-outline',
                        type:'button',
                        onClick:()=>startEditLocal(r)
                      }, '✏️'),
                      ' ',
                      e('button', {
                        className:'btn btn-outline',
                        type:'button',
                        onClick:()=>delLocal(r),
                        ...roBtnProps()
                      }, '🗑')
                    )
                  );
                })
              )
            )
      )
    )
  );
}
window.RegistrazioniOreView = RegistrazioniOreView;

  // === Aggregatore per ReportTempi (per riga o per fase) ===
window.__rpt_groupBy = window.__rpt_groupBy || function(oreRows, { byRiga=false, onlyCommessaId=null } = {}) {
  try {
    // Normalizzo l'input e ignoro sempre le timbrature cancellate
    const arrRaw = Array.isArray(oreRows) ? oreRows : [];
    const arrAlive = arrRaw.filter(r => !r || !r.deletedAt);
    const rows = onlyCommessaId
      ? arrAlive.filter(r => String(r.commessaId) === String(onlyCommessaId))
      : arrAlive;
    const map = new Map();

    const toMin = (s) => {
      if (s == null) return 0;
      const m = String(s).trim().match(/^(\d{1,4})(?::([0-5]?\d))?$/);
      if (!m) return 0;
      const h = parseInt(m[1]||'0',10)||0;
      const mm = parseInt(m[2]||'0',10)||0;
      return h*60+mm;
    };

    const tsOf = (r) => {
      return (
        Date.parse(r.__createdAt || r.created_at || r.data || r.date || 0) || 0
      );
    };

    for (const r of rows) {
      const key = byRiga
        ? `${r.commessaId}|${r.rigaIdx ?? ''}|${r.rigaCodice ?? ''}`
        : `${r.commessaId}|${r.faseIdx ?? ''}`;

      const cur = map.get(key) || {
        commessaId: r.commessaId || '',
        rigaIdx: (r.rigaIdx == null ? null : Number(r.rigaIdx)),
        rigaCodice: r.rigaCodice || '',
        rigaDescrizione: r.rigaDescrizione || '',
        rigaUM: r.rigaUM || '',
        pezzi: 0,
        oreMin: 0,
        oreHHMM: '0:00',
        latestAt: 0
      };

      const addMin = (Number(r.oreMin) || 0) || toMin(r.oreHHMM);
      cur.pezzi += Math.max(0, Number(r.qtaPezzi||r.pezzi||0));
      cur.oreMin += addMin;

      const t = Math.max(0, Math.round(cur.oreMin));
      const h = Math.floor(t/60), m = t%60;
      cur.oreHHMM = `${h}:${String(m).padStart(2,'0')}`;

      const ts = tsOf(r);
      if (ts > cur.latestAt) cur.latestAt = ts;

      map.set(key, cur);
    }

    return Array.from(map.values())
      .sort((a,b)=>{
        // più nuovo sopra
        if ((b.latestAt||0) !== (a.latestAt||0)) return (b.latestAt||0)-(a.latestAt||0);
        // fallback: commessa desc
        if (String(b.commessaId||'') !== String(a.commessaId||'')) {
          return String(b.commessaId||'').localeCompare(String(a.commessaId||''));
        }
        // fallback: riga asc
        return String(a.rigaIdx??'').localeCompare(String(b.rigaIdx??''));
      });
  } catch(e) {
    console.warn('__rpt_groupBy error', e);
    return [];
  }
};

/* ================== REPORT TEMPI (PIANIFICATE vs EFFETTIVE + ORE PER FASE) ================== */
// [RPT] Helper aggregazione per riga articolo (idempotente)
window.__rpt_groupBy = window.__rpt_groupBy || function(oreRows, { byRiga = false, onlyCommessaId = null } = {}) {
  const out = [];
  const map = new Map();
  const toMin = (x) => {
    if (x == null) return 0;
    if (typeof x === 'number') return Math.max(0, x|0);
    const s = String(x).trim();
    const m = s.match(/^(\d{1,4}):([0-5]\d)$/);
    if (m) return (parseInt(m[1],10)||0)*60 + (parseInt(m[2],10)||0);
    const n = Number(s);
    return Number.isFinite(n) ? Math.max(0, n|0) : 0;
  };

  for (const r of (Array.isArray(oreRows) ? oreRows : [])) {
    const commessaId = String(r?.commessaId || '').trim();
    if (!commessaId) continue;
    if (onlyCommessaId && commessaId !== onlyCommessaId) continue;

    const idx = (r?.rigaIdx != null ? String(r.rigaIdx) : '');
    const kRiga = byRiga ? [idx, r?.rigaCodice||'', r?.rigaDescrizione||'', r?.rigaUM||''].join('|') : '';
    const key = commessaId + '|' + kRiga;

    const prev = map.get(key) || {
      commessaId,
      rigaIdx: (r?.rigaIdx != null ? Number(r.rigaIdx) : null),
      rigaCodice: r?.rigaCodice || '',
      rigaDescrizione: r?.rigaDescrizione || '',
      rigaUM: r?.rigaUM || '',
      oreMin: 0,
      pezzi: 0,
      rows: 0
    };

    prev.oreMin += toMin(r?.oreMin) || toMin(r?.minuti) || toMin(r?.minutes) || toMin(r?.oreHHMM);
    prev.pezzi  += Math.max(0, Number(r?.qtaPezzi || 0));
    prev.rows   += 1;
    map.set(key, prev);
  }

  for (const v of map.values()) {
    const h = Math.floor(v.oreMin/60), m = v.oreMin%60;
    v.oreHHMM = `${h}:${String(m).padStart(2,'0')}`;
    out.push(v);
  }
  out.sort((a,b)=>{
    if (a.commessaId !== b.commessaId) return a.commessaId < b.commessaId ? -1 : 1;
    return (a.rigaIdx??-1) - (b.rigaIdx??-1);
  });
  return out;
};

// === Helper aggregazione per Report Tempi (per riga articolo o intera commessa) ===
window.__rpt_groupBy = function(oreRowsAll, { byRiga=false, onlyCommessaId=null } = {}){
  let rows = Array.isArray(oreRowsAll) ? oreRowsAll : [];
  if (onlyCommessaId) {
    rows = rows.filter(r => String(r?.commessaId||'') === String(onlyCommessaId));
  }

  // Indici veloci
  const commesse = (function(){ try {return JSON.parse(localStorage.getItem('commesseRows')||'[]');} catch {return [];} })();
  const commById = new Map(commesse.map(c => [String(c.id), c]));

  // Somma minuti (accetta più formati)
  const toMin = (s) => {
    if (s == null) return 0;
    const t = String(s).trim();
    const m = t.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return Math.max(0, Number(t) || 0);
    const h = parseInt(m[1]||'0',10)||0, mm = parseInt(m[2]||'0',10)||0;
    return h*60+mm;
  };

  // timestamp robusto per ordinamento "più nuovo sopra"
  const tsOf = (r) =>
    Date.parse(r.__createdAt || r.created_at || r.data || r.date || 0) || 0;

  const keyOf = (r) => {
    const cid = String(r?.commessaId||'');
    if (!byRiga) return `C:${cid}`; // report per commessa
    const idx = (r?.rigaIdx==='' || r?.rigaIdx==null) ? 'ALL' : String(r.rigaIdx|0);
    return `C:${cid}|R:${idx}`; // report per riga
  };

  const map = new Map();
  for (const r of rows) {
    const k = keyOf(r);
    const cur = map.get(k) || {
      commessaId: String(r?.commessaId||''),
      rigaIdx: (r?.rigaIdx===''||r?.rigaIdx==null) ? null : (r.rigaIdx|0),
      rigaCodice: r?.rigaCodice || '',
      rigaDescrizione: r?.rigaDescrizione || '',
      rigaUM: r?.rigaUM || '',
      pezzi: 0,
      oreMin: 0,
      latestAt: 0
    };

    cur.pezzi += Math.max(0, Number(r?.qtaPezzi||0));
    cur.oreMin += (Number(r?.oreMin)||toMin(r?.oreHHMM)||0);

    const t = tsOf(r);
    if (t > cur.latestAt) cur.latestAt = t;

    // metadati riga se arrivano dalle timbrature
    if (r?.rigaCodice && !cur.rigaCodice) cur.rigaCodice = String(r.rigaCodice);
    if (r?.rigaDescrizione && !cur.rigaDescrizione) cur.rigaDescrizione = String(r.rigaDescrizione);
    if (r?.rigaUM && !cur.rigaUM) cur.rigaUM = String(r.rigaUM);

    map.set(k, cur);
  }

  // Calcola HH:MM e arricchisce con info commessa
  const out = [];
  for (const v of map.values()) {
    const c = commById.get(v.commessaId) || {};
    const ore = Math.floor(v.oreMin/60);
    const min = v.oreMin % 60;

    out.push({
      commessaId: v.commessaId,
      cliente: c?.cliente || '',
      descrizione: c?.descrizione || '',
      rigaIdx: v.rigaIdx,
      rigaCodice: v.rigaCodice,
      rigaDescrizione: v.rigaDescrizione,
      rigaUM: v.rigaUM || (Array.isArray(c?.righeArticolo) && typeof v.rigaIdx==='number'
        ? (c.righeArticolo[v.rigaIdx]?.um || '')
        : ''),
      pezzi: v.pezzi,
      oreMin: v.oreMin,
      oreHHMM: `${ore}:${String(min).padStart(2,'0')}`,
      latestAt: v.latestAt
    });
  }

  // Ordina: più nuovo sopra, poi commessa desc, poi riga asc
  out.sort((a,b)=>{
    if ((b.latestAt||0) !== (a.latestAt||0)) return (b.latestAt||0) - (a.latestAt||0);
    if (String(b.commessaId||'') !== String(a.commessaId||'')) {
      return String(b.commessaId||'').localeCompare(String(a.commessaId||''));
    }
    return (a.rigaIdx??99) - (b.rigaIdx??99);
  });

  return out;
};

// === Aggregatore Report per righe articolo (idempotente) ===
window.__rpt_groupBy = window.__rpt_groupBy || function __rpt_groupBy(oreRows, opts = {}){
  const byRiga = !!opts.byRiga;
  const onlyCommessaId = opts.onlyCommessaId ? String(opts.onlyCommessaId) : null;

  const toMin = (s) => {
    if (s == null) return 0;
    const t = String(s).trim();
    const m = t.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return Math.max(0, Number(t) || 0);
    const h = parseInt(m[1] || '0', 10) || 0;
    const mm = parseInt(m[2] || '0', 10) || 0;
    return h * 60 + mm;
  };
  const fmt = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m = t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };

  const map = new Map();
  for (const r of (Array.isArray(oreRows) ? oreRows : [])) {
    const cid = String(r?.commessaId || '');
    if (!cid) continue;
    if (onlyCommessaId && cid !== onlyCommessaId) continue;

    const idxRaw = (r?.rigaIdx === '' || r?.rigaIdx == null) ? null : Number(r.rigaIdx);
    const key = byRiga ? `${cid}|${idxRaw==null? 'all' : idxRaw}` : cid;

    const cur = map.get(key) || {
      commessaId: cid,
      rigaIdx: (byRiga ? (idxRaw==null ? null : idxRaw) : null),
      rigaCodice: '',
      rigaDescrizione: '',
      rigaUM: '',
      oreMin: 0,
      oreHHMM: '0:00',
      pezzi: 0
    };

    // minuti: prova numerico, poi HH:MM
    const addMin = (Number(r.oreMin) || 0) || toMin(r.oreHHMM || 0);
    cur.oreMin += Math.max(0, addMin);
    cur.oreHHMM = fmt(cur.oreMin);

    // pezzi (se presenti nelle timbrature)
    cur.pezzi += Math.max(0, Number(r.qtaPezzi || 0));

    // metadati riga, se presenti
    if (r.rigaCodice && !cur.rigaCodice) cur.rigaCodice = String(r.rigaCodice);
    if (r.rigaDescrizione && !cur.rigaDescrizione) cur.rigaDescrizione = String(r.rigaDescrizione);
    if (r.rigaUM && !cur.rigaUM) cur.rigaUM = String(r.rigaUM);

    map.set(key, cur);
  }

  return Array.from(map.values())
    .sort((a,b) => (a.commessaId.localeCompare(b.commessaId)
        || String(a.rigaIdx??'').localeCompare(String(b.rigaIdx??''))));
};

function ReportTempiView({ query = '' }) {
    const e = React.createElement;
  // == Raggruppo per riga articolo ==
  const [groupByRiga, setGroupByRiga] = React.useState(false);
  const [commessaFilter, setCommessaFilter] = React.useState('');

  const oreRowsAll = React.useMemo(() => {
    try {
      const raw = JSON.parse(localStorage.getItem('oreRows') || '[]') || [];
      if (!Array.isArray(raw)) return [];
      // Considero solo timbrature NON cancellate (coerenza con producedPieces/residuo)
      return raw.filter(r => !r || !r.deletedAt);
    } catch {
      return [];
    }
  }, []);

  const aggRows = React.useMemo(() => (
    window.__rpt_groupBy(oreRowsAll, {
      byRiga: groupByRiga,
      onlyCommessaId: commessaFilter || null
    })
  ), [oreRowsAll, groupByRiga, commessaFilter]);

  const commesseIds = React.useMemo(() => {
    return Array.from(new Set((oreRowsAll||[]).map(r => r?.commessaId).filter(Boolean))).sort();
  }, [oreRowsAll]);

  // filtro per codice articolo (attivo solo quando groupByRiga)
  const [codiceFilter, setCodiceFilter] = React.useState('');

  // lista codici unici dalle timbrature
  const codiciList = React.useMemo(() => {
    const set = new Set();
    (oreRowsAll||[]).forEach(r => {
      const c = String(r?.rigaCodice || '').trim();
      if (c) set.add(c);
    });
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }, [oreRowsAll]);

  // righe aggregate filtrate per codice
  const aggRowsFiltered = React.useMemo(() => {
    if (!codiceFilter) return aggRows;
    return (aggRows||[]).filter(r =>
      String(r?.rigaCodice || '').trim() === String(codiceFilter).trim()
    );
  }, [aggRows, codiceFilter]);

function isGasNote(t){ return /cambio\s*bombola\s*gas/i.test(String(t||'')); }

function faseLabelFromRow(row){
  try{
    if (!row || typeof row !== 'object') return 'Intera commessa';

    // 1) Nome salvato al momento della timbratura (se non è "Fase N")
    const storedRaw = row.faseLabelAtReg != null
      ? String(row.faseLabelAtReg).trim()
      : '';
    const isGeneric = /^fase\s+\d+$/i.test(storedRaw);
    if (storedRaw && !isGeneric) {
      return storedRaw;
    }

    const idxRaw = row.faseIdx;

    // 2) Nessuna fase impostata
    if (idxRaw === '' || idxRaw == null) {
      if (isGasNote(row.note)) return 'EXTRA: Cambio Bombola Gas';
      return 'Intera commessa';
    }

    // 3) Prova a inferire il nome fase dalle strutture commessa/appSettings
    if (typeof inferFaseLabelRow === 'function') {
      const inferred = inferFaseLabelRow(row);
      if (inferred) return inferred;
    }

    // 4) Fallback: usa ancora window.faseLabel
    const idx = Number(idxRaw);
    const commId = row.commessaId != null ? String(row.commessaId) : '';
    const allC = Array.isArray(commesse) ? commesse : [];
    const c = allC.find(x => String(x.id) === commId);
    if (typeof window.faseLabel === 'function') {
      return window.faseLabel(c, idx);
    }

    // 5) Ultima spiaggia
    return `Fase ${(Number(idxRaw)||0)+1}`;
  } catch(_){
    return 'Intera commessa';
  }
}

  if (typeof window !== 'undefined') {
    window.faseLabelFromRow = window.faseLabelFromRow || faseLabelFromRow;
  }

  // Helper tempo
    const toMin = (hhmm) => {
    const [h, m] = String(hhmm||'0').split(':');
    const mm = parseInt(m||'0',10) || 0;
    const hNum = parseInt(h||'0',10) || 0;
    return (hNum*60 + mm);
  };
  const fmt = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m = t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };

  // formato € con due decimali, separatore virgola
  const fmtEuro = (v) => {
    const n = Number(v);
    if (!Number.isFinite(n) || !n) return '0,00';
    return (Math.round(n*100)/100).toFixed(2).replace('.', ',');
  };

  // Impostazioni (costo orario azienda), rispettando lsGet / BETA
  const appSettingsRT = (function(){
    try{
      if (typeof window !== 'undefined' && typeof window.lsGet === 'function'){
        return window.lsGet('appSettings', {}) || {};
      }
      return JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    }catch{
      return {};
    }
  })();

  const costoOrarioAzienda = Number(appSettingsRT.costoOrarioAzienda) || 0;

  // Dati
  const commesse = React.useMemo(()=>{ try{ return JSON.parse(localStorage.getItem('commesseRows')||'[]'); }catch{ return []; } },[]);
  const oreRows  = React.useMemo(()=>{
    try{
      const raw = JSON.parse(localStorage.getItem('oreRows')||'[]') || [];
      if (!Array.isArray(raw)) return [];
      // Anche qui: escludo timbrature soft-delete
      return raw.filter(r => !r || !r.deletedAt);
    }catch{
      return [];
    }
  },[]);


  // ---- Report 1: Pianificate vs Effettive (fix + % scostamento) ----
  // Helper robusto: minuti pianificati di una fase (supporta campi legacy e per-riga)
function plannedMinsFromFase(f){
  if (!f || typeof f !== 'object') return 0;

  // numerici diretti
  const n =
    (typeof f.oreMin === 'number' && isFinite(f.oreMin)) ? f.oreMin :
    (typeof f.minuti === 'number' && isFinite(f.minuti)) ? f.minuti :
    (typeof f.min === 'number' && isFinite(f.min)) ? f.min :
    (typeof f.orePrevMin === 'number' && isFinite(f.orePrevMin)) ? f.orePrevMin :
    null;

  if (n != null) return Math.max(0, Math.round(n));

  // stringhe HH:MM (ordine per compatibilità + fasi per-riga)
  const hhmm =
    f.orePrevHHMM ||        // 👈 per-riga: quello che compili nel form
    f.oreHHMM ||
    f.hhmm ||
    f.orePrevistaHHMM ||
    f.orePrev ||
    f.durataHHMM ||
    '';

  return Math.max(0, Math.round(toMin(hhmm || '0')));
}
window.plannedMinsFromFase = plannedMinsFromFase; // debug console

function plannedMinPerPiece(c){
  // 1) Se esistono fasi per-riga con tempi pianificati, uso quelle
  const righe = Array.isArray(c?.righeArticolo) ? c.righeArticolo : [];
  const hasRowFasiPlanned = righe.some(row =>
    Array.isArray(row?.fasi) &&
    row.fasi.some(f => plannedMinsFromFase(f) > 0)
  );

  if (righe.length && hasRowFasiPlanned){
    let perPieceNumer = 0;
    let piecesSel = 0;

    for (const row of righe){
      const qRow = Math.max(0, Number(row?.qta || row?.qtaPezzi || row?.pezzi || 0));
      if (!qRow) continue;

      const perRow = plannedMinPerPieceRow(c, row); // esclude già le una-tantum
      perPieceNumer += perRow * qRow;
      piecesSel += qRow;
    }

    if (piecesSel > 0){
      return Math.max(0, Math.round(perPieceNumer / piecesSel));
    }
    // se arrivo qui (pezzi=0), passo al fallback legacy sotto
  }

  // 2) Fallback legacy su fasi globali / oreMin-oreHHMM
  const fasi = Array.isArray(c?.fasi) ? c.fasi : [];
  if (fasi.length === 0){
    // se non ci sono fasi: interpreta oreMin/oreHHMM come tempo per pezzo
    const perPiece = (typeof c.oreMin==='number' ? c.oreMin : toMin(c.oreHHMM||'0')) || 0;
    return Math.max(0, Math.round(perPiece));
  }

  let perPiece = 0;
  for (const f of fasi){
    const min = plannedMinsFromFase(f);
    if (!(f.unaTantum || f.once)) perPiece += min;   // una tantum fuori dal per-pezzo
  }
  return Math.max(0, Math.round(perPiece));
}
// === R3: pianificato per singola riga articolo (usa fasi per-riga se presenti) ===
function plannedMinPerPieceRow(c, row){
    const rowFasi  = (row && Array.isArray(row.fasi) && row.fasi.length) ? row.fasi : [];
  const commFasi = Array.isArray(c?.fasi) ? c.fasi : [];

  // override per-riga SOLO se contiene tempi pianificati
  const rowHasPlanned = rowFasi.some(f => plannedMinsFromFase(f) > 0);
  const fasiEff = rowHasPlanned ? rowFasi : commFasi;

    if (fasiEff.length === 0){
    const perPiece = (typeof c.oreMin==='number' ? c.oreMin : toMin(c.oreHHMM||'0')) || 0;
    return Math.max(0, Math.round(perPiece));
  }

  let perPiece = 0;
    for (const f of fasiEff){
    const min = plannedMinsFromFase(f);
    if (!(f.unaTantum || f.once)) perPiece += min;
  }
  return Math.max(0, Math.round(perPiece));
}

// === Pianificato TOTALE per commessa: se ho fasi per-riga le sommo ===
function plannedMinTotalCommessaSmart(c){
  const righe = Array.isArray(c?.righeArticolo) ? c.righeArticolo : [];
    // uso fasi per-riga SOLO se contengono tempi pianificati reali
  const hasRowFasiPlanned = righe.some(r =>
    Array.isArray(r?.fasi) &&
    r.fasi.some(f => plannedMinsFromFase(f) > 0)
  );

  if (righe.length && hasRowFasiPlanned){
    return righe.reduce((s,row)=> s + plannedMinTotalRow(c, row), 0);
  }


  // fallback legacy su fasi globali
  const fasi = Array.isArray(c?.fasi) ? c.fasi : [];
  const q = Math.max(1, Number(c?.qtaPezzi||1));

  if (fasi.length === 0){
    const perPiece = plannedMinPerPiece(c);
    return Math.max(0, Math.round(perPiece * q));
  }

  let perPiece = 0, unaTantum = 0;
  for (const f of fasi){
       const min = plannedMinsFromFase(f);
    if (f.unaTantum || f.once) unaTantum += min;
    else perPiece += min;
  }
  return Math.max(0, Math.round(unaTantum + perPiece * q));
}

// === Pianificato per singola riga articolo ===
function plannedMinTotalRow(c, row){
  const qRow = Math.max(1, Number(row?.qta || row?.qtaPezzi || 1));

  const rowFasi = (row && Array.isArray(row.fasi) && row.fasi.length) ? row.fasi : [];
  const commFasi = Array.isArray(c?.fasi) ? c.fasi : [];

  // override per-riga SOLO se contiene tempi
  const rowHasPlanned = rowFasi.some(f => plannedMinsFromFase(f) > 0);
  const fasiEff = rowHasPlanned ? rowFasi : commFasi;

  if (fasiEff.length === 0){
    const perPiece = plannedMinPerPiece(c);
    return Math.max(0, Math.round(perPiece * qRow));
  }

  let perPiece = 0, unaTantum = 0;
  for (const f of fasiEff){
    const min = plannedMinsFromFase(f);
    if (f.unaTantum || f.once) unaTantum += min;
    else perPiece += min;
  }

  return Math.max(0, Math.round(unaTantum + perPiece * qRow));
}

// === R3: totale selezione (commessa / codice) ===
const selectionTotals = React.useMemo(()=>{
  try{
    const commFilter = String(commessaFilter||'').trim();
    const codFilter  = String(codiceFilter||'').trim();

    // effettive: come Report1 -> solo fasi vere (faseIdx != null)
    const effMin = (oreRowsAll||[])
      .filter(r=>{
        if (commFilter && String(r?.commessaId||'') !== commFilter) return false;
        if (codFilter){
          const cod = String(r?.rigaCodice || r?.codice || '').trim();
          if (cod !== codFilter) return false;
        }
        if (r?.faseIdx == null || r?.faseIdx === '') return false;
        return true;
      })
      .reduce((s,r)=> s + (Number(r.oreMin)||toMin(r.oreHHMM)||0), 0);

    let pianMin = 0;

    // per-pezzo (media pesata sui pezzi selezionati)
    let perPieceNumer = 0;
    let piecesSel = 0;

    const commesseSel = (commesse||[])
      .filter(c => !commFilter || String(c.id) === commFilter);

    for (const c of commesseSel){
      const righe = Array.isArray(c?.righeArticolo) ? c.righeArticolo : [];

      if (groupByRiga){
        const righeSel = codFilter
          ? righe.filter(row=>{
              const cod = String(row?.codice || row?.articoloCodice || '').trim();
              return cod === codFilter;
            })
          : righe;

        for (const row of righeSel){
          const qRow = Math.max(0, Number(row?.qta || row?.qtaPezzi || 0));
          if (!qRow) continue;

          // totale pianificato riga (include una-tantum dove presenti)
          pianMin += plannedMinTotalRow(c, row);

          // per-pezzo vero (esclude una-tantum)
          const perPiece = plannedMinPerPieceRow(c, row);
          perPieceNumer += perPiece * qRow;
          piecesSel += qRow;
        }

      } else {
        // commessa intera
        pianMin += plannedMinTotalCommessaSmart(c);

        const q = Math.max(0, Number(c?.qtaPezzi || 0));
        if (q){
          const perPiece = plannedMinPerPiece(c);
          perPieceNumer += perPiece * q;
          piecesSel += q;
        }
      }
    }

    const pianPerPiece = piecesSel>0 ? (perPieceNumer / piecesSel) : 0;
    const delta = effMin - pianMin;
    const perc  = pianMin>0 ? (delta/pianMin)*100 : 0;

    // Costi in € usando costoOrarioAzienda
    const costoPian  = costoOrarioAzienda > 0 ? (pianMin/60) * costoOrarioAzienda : 0;
    const costoEff   = costoOrarioAzienda > 0 ? (effMin/60) * costoOrarioAzienda : 0;
    const costoDelta = costoEff - costoPian;

    return { effMin, pianMin, pianPerPiece, piecesSel, delta, perc, costoPian, costoEff, costoDelta };
  }catch(e){
    console.warn('selectionTotals error', e);
    return {
      effMin:0,
      pianMin:0,
      pianPerPiece:0,
      piecesSel:0,
      delta:0,
      perc:0,
      costoPian:0,
      costoEff:0,
      costoDelta:0
    };
  }
}, [oreRowsAll, commesse, groupByRiga, commessaFilter, codiceFilter]);

// ✅ fallback Report1: plannedMinTotal potrebbe non essere nello scope
const plannedMinTotalFn_Report1 = (typeof plannedMinTotal === 'function')
  ? plannedMinTotal
  : function(c){
      const fasi = Array.isArray(c?.fasi) ? c.fasi : [];
      const q = Math.max(1, Number(c?.qtaPezzi||1));
      if (fasi.length === 0){
        const perPiece = (typeof c.oreMin==='number' ? c.oreMin : toMin(c.oreHHMM||'0')) || 0;
        return Math.max(0, Math.round(perPiece * q));
      }
      let perPiece = 0, unaTantum = 0;
      for (const f of fasi){
           const min = plannedMinsFromFase(f);
        if (f.unaTantum || f.once) unaTantum += min; else perPiece += min;
      }
      return Math.max(0, Math.round(unaTantum + perPiece * q));
    };

const righe = React.useMemo(()=>{
  const out = [];
  for (const c of (Array.isArray(commesse)?commesse:[])) {
    const perPezzo = plannedMinPerPiece(c);
    const pianTot  = plannedMinTotalCommessaSmart(c);
    const effMin   = (Array.isArray(oreRows)?oreRows:[])
    .filter(o => o.commessaId === c.id && o.faseIdx != null)
    .reduce((s,o)=> s + (
      (Number(o.oreMin)||0) ||
      (Number(o.minuti)||0) ||
      (Number(o.minutes)||0) ||
      toMin(o.oreHHMM||0)
    ), 0);
    const delta    = effMin - pianTot;                       // >0 = sforato
    const perc     = pianTot>0 ? (delta / pianTot) * 100 : 0;
    out.push({
      id: c.id,
      cliente: c.cliente || '',
      descrizione: c.descrizione || '',
      qta: Math.max(1, Number(c.qtaPezzi||1)),
      perPezzo,
      pianTot,
      effMin,
      delta,
      perc
    });
  }
  return out.sort((a,b)=> a.id.localeCompare(b.id));
}, [commesse, oreRows]);

const q = (query||'').toLowerCase();
  const vis = righe.filter(r =>
    (r.id+' '+r.cliente+' '+r.descrizione).toLowerCase().includes(q)
  );

  function exportCSV(){
    const header = ['Commessa','Cliente','Descrizione','Q.tà','Pian. 1 pz (HH:MM)','Pian. tot (HH:MM)','Effettive (HH:MM)','Delta (Eff-Pian)','Scost.%','Stato'];
  const body = vis.map(r => {
    const stato = r.delta>0 ? 'Ritardo' : 'On time';
    const percStr = (r.perc>=0?'+':'') + (Math.round(r.perc*10)/10).toFixed(1) + '%';
    return [r.id, r.cliente, r.descrizione, String(r.qta), fmt(r.perPezzo), fmt(r.pianTot), fmt(r.effMin), (r.delta>=0?'+':'')+fmt(Math.abs(r.delta)), percStr, stato];
  });
    const csv = [header, ...body].map(row =>
      row.map(v => {
        const s = String(v||'');
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'report_tempi_commesse.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---- Report 2: Ore per FASE (nuovo) ----
  // Filtri locali
  const [fltCliente, setFltCliente]     = React.useState('');
  const [fltCommessa, setFltCommessa]   = React.useState('');
  const [fltDescr, setFltDescr]         = React.useState('');
  const [fltFase, setFltFase]           = React.useState('');
  const [fltOperatore, setFltOperatore] = React.useState('');
  const [inclExtra, setInclExtra]       = React.useState(true);
  const [fltCodice, setFltCodice]       = React.useState('');
  const [groupByCodiceFase, setGroupByCodiceFase] = React.useState(false);
  const [sortByCodFase, setSortByCodFase] = React.useState('codice'); // 'codice' | 'eff' | 'pian' | 'delta'
  const [sortDirCodFase, setSortDirCodFase] = React.useState('asc'); // 'asc' | 'desc'
  const [hideNoPlannedCodFase, setHideNoPlannedCodFase] = React.useState(true);

  // Sorgenti per tendina clienti
  const clienti = React.useMemo(()=>{
    const s = new Set();
    (commesse||[]).forEach(c => { const v = (c.cliente||'').trim(); if (v) s.add(v); });
    return Array.from(s).sort((a,b)=>a.localeCompare(b));
  }, [commesse]);

    // Sorgenti per tendina codici articolo (da oreRows + commesse)
  const codiciArt = React.useMemo(()=>{
    const s = new Set();

    (Array.isArray(oreRows)?oreRows:[]).forEach(r=>{
      const code = String(r?.rigaCodice||'').trim();
      if (code) s.add(code);
    });

    (commesse||[]).forEach(c=>{
      (Array.isArray(c?.righeArticolo)?c.righeArticolo:[]).forEach(row=>{
        const code = String(row?.codice || row?.articoloCodice || '').trim();
        if (code) s.add(code);
      });
    });

    return Array.from(s).sort((a,b)=>a.localeCompare(b));
  }, [oreRows, commesse]);
  
    // Pianificate per codice + fase (stessa chiave di orePerFase quando groupByCodiceFase)
  const plannedPerCodFase = React.useMemo(()=>{
    const map = new Map();
    const commesseAll = Array.isArray(commesse) ? commesse : [];

    for (const c of commesseAll){
      const righe = Array.isArray(c?.righeArticolo) ? c.righeArticolo : [];
      if (!righe.length) continue;

      const totalPieces = righe.reduce((s,row)=> s + Math.max(0, Number(row?.qta || row?.qtaPezzi || 0)), 0) || 1;

      for (const row of righe){
        const code = String(row?.codice || row?.articoloCodice || '').trim();
        if (!code) continue;

        const qRow = Math.max(0, Number(row?.qta || row?.qtaPezzi || 0));

        // fasi effettive per questa riga (ibrido intelligente)
        const rowHasPlanned = Array.isArray(row?.fasi) && row.fasi.some(f => plannedMinsFromFase(f) > 0);
        const fasiEff = rowHasPlanned
          ? row.fasi
          : (Array.isArray(c?.fasi) ? c.fasi : []);

        for (let i=0; i<fasiEff.length; i++){
          const f = fasiEff[i];
          const minBase = plannedMinsFromFase(f);
          if (!minBase) continue;

          const isOnce = !!(f.unaTantum || f.once);

          // per-fase pianificata per questa riga:
          // - se una-tantum: spalmo per quota pezzi riga / totale commessa
          // - altrimenti: per-pezzo * qtaRiga
          const minRow = isOnce
            ? minBase * (qRow / totalPieces)
            : minBase * qRow;

          const key = `${code}|${String(i)}`;
          map.set(key, (map.get(key)||0) + minRow);
        }
      }
    }

    return map;
  }, [commesse]);

  // Aggregazione per (commessaId, faseIdx)
  const orePerFase = React.useMemo(()=>{
    const rows = (Array.isArray(oreRows)?oreRows:[]).filter(r => {
      const c = (commesse||[]).find(x => x.id === r.commessaId);
      const cliente = (c?.cliente || '').toLowerCase();
      const idc = (c?.id || '').toLowerCase();
      const descr = (c?.descrizione || '').toLowerCase();
      const faseLabel = String(faseLabelFromRow(r)).toLowerCase();
      const oper = (r.operatore||'').toLowerCase();
      const codice = (r.rigaCodice||'').toLowerCase();
      if (fltCodice && codice !== fltCodice.toLowerCase()) return false;

      if (fltCliente && cliente !== fltCliente.toLowerCase()) return false;
      if (fltCommessa && !idc.includes(fltCommessa.toLowerCase())) return false;
      if (fltDescr && !descr.includes(fltDescr.toLowerCase())) return false;
      if (fltFase && !faseLabel.includes(fltFase.toLowerCase())) return false;
      if (fltOperatore && !oper.includes(fltOperatore.toLowerCase())) return false;
      if (!inclExtra && (r.faseIdx == null || r.faseIdx === '')) return false;
      return true;
    });

        const byCodice = !!groupByCodiceFase;

    const map = new Map();
    for (const r of rows){
      const c = (commesse||[]).find(x => x.id === r.commessaId) || {};
      const code = String(r.rigaCodice || '').trim();

      const isNoFase = (r.faseIdx == null || r.faseIdx === '');
      const isExtra  = isNoFase && isGasNote(r.note);
      const faseKey  = isExtra ? 'EXTRA' : (isNoFase ? 'INTERA' : String(r.faseIdx|0));

      const key = byCodice
        ? `${code || '(senza codice)'}|${faseKey}`
        : `${r.commessaId}|${faseKey}`;

      const cur = (map.get(key) || {
        commessaId: byCodice ? '' : r.commessaId,
        cliente: byCodice ? '' : (c.cliente || ''),
        descrizione: byCodice ? (r.rigaDescrizione || c.descrizione || '') : (c.descrizione || ''),
        codice: code,
        faseIdx: isNoFase ? null : (r.faseIdx|0),
        faseLabel: faseLabelFromRow(r),
        minutes: 0,
        __commesseSet: byCodice ? new Set() : null,
        __clientiSet: byCodice ? new Set() : null
      });

      if (byCodice){
        if (r.commessaId) cur.__commesseSet.add(r.commessaId);
        if (c?.cliente) cur.__clientiSet.add(c.cliente);
      }

      const add = Number(r.oreMin)||toMin(r.oreHHMM)||0;
      cur.minutes += add;
      map.set(key, cur);
    }

        let arr = Array.from(map.values()).map(x=>{
      if (!byCodice) return x;
        return {
        codice: x.codice,
        descrizione: x.descrizione,
        faseIdx: x.faseIdx,
        faseLabel: x.faseLabel,
        minutes: x.minutes,
        pianMinutes: (x.faseIdx==null ? 0 : (plannedPerCodFase.get(`${x.codice}|${String(x.faseIdx)}`) || 0)),
        commesseN: x.__commesseSet ? x.__commesseSet.size : 0,
        clientiN: x.__clientiSet ? x.__clientiSet.size : 0
      };
    });

        // delta solo quando raggruppo per codice/fase
    if (byCodice){
      for (const r of arr){
        const pian = Number(r.pianMinutes)||0;
        const eff  = Number(r.minutes)||0;
        r.deltaMinutes = eff - pian;
        r.scostPerc = pian>0 ? ((r.deltaMinutes / pian) * 100) : null;
      }
    }

      if (byCodice && hideNoPlannedCodFase){
        arr = arr.filter(r => (Number(r.pianMinutes)||0) > 0);
      }

        return arr.sort((a,b)=>{
      if (byCodice){
        const dir = (sortDirCodFase === 'asc') ? 1 : -1;

        let cmp = 0;
        if (sortByCodFase === 'codice'){
          cmp = String(a.codice||'').localeCompare(String(b.codice||'')) * dir;
        } else {
          const aVal =
            (sortByCodFase === 'eff')   ? (Number(a.minutes)||0) :
            (sortByCodFase === 'pian')  ? (Number(a.pianMinutes)||0) :
            (sortByCodFase === 'delta') ? (Number(a.deltaMinutes)||0) :
            0;

          const bVal =
            (sortByCodFase === 'eff')   ? (Number(b.minutes)||0) :
            (sortByCodFase === 'pian')  ? (Number(b.pianMinutes)||0) :
            (sortByCodFase === 'delta') ? (Number(b.deltaMinutes)||0) :
            0;

          cmp = (aVal - bVal) * dir;
        }

        if (cmp !== 0) return cmp;
        return String(a.faseIdx??99).localeCompare(String(b.faseIdx??99));
      }

      return (a.commessaId.localeCompare(b.commessaId) ||
              String(a.faseIdx??99).localeCompare(String(b.faseIdx??99)));
    });
    }, [oreRows, commesse, fltCliente, fltCommessa, fltDescr, fltFase, fltOperatore, inclExtra, fltCodice, groupByCodiceFase, plannedPerCodFase, sortByCodFase, sortDirCodFase, hideNoPlannedCodFase]);
    
      // Opzioni fase per tendina (derivate dai risultati correnti)
  const faseOptions = React.useMemo(()=>{
    const s = new Set();
    (orePerFase||[]).forEach(r=>{
      const lbl = String(r?.faseLabel||'').trim();
      if (lbl) s.add(lbl);
    });
    return Array.from(s).sort((a,b)=>a.localeCompare(b));
  }, [orePerFase]);

    // Totali per il codice selezionato (solo quando groupByCodiceFase)
  const totalsCodFase = React.useMemo(()=>{
    if (!groupByCodiceFase) return null;
    if (!fltCodice) return null;
    if (!Array.isArray(orePerFase) || orePerFase.length===0) return null;

    const eff  = orePerFase.reduce((s,r)=> s + (Number(r.minutes)||0), 0);
    const pian = orePerFase.reduce((s,r)=> s + (Number(r.pianMinutes)||0), 0);
    const delta = eff - pian;
    const perc  = pian>0 ? (delta/pian)*100 : null;

    // Costi in € usando costoOrarioAzienda (stesso di Report Tempi)
    const costoPian  = costoOrarioAzienda > 0 ? (pian/60) * costoOrarioAzienda : 0;
    const costoEff   = costoOrarioAzienda > 0 ? (eff/60) * costoOrarioAzienda : 0;
    const costoDelta = costoEff - costoPian;

    return { eff, pian, delta, perc, costoPian, costoEff, costoDelta };
  }, [groupByCodiceFase, fltCodice, orePerFase]);

    function exportCSV_Fasi(){
    const header = groupByCodiceFase
      ? ['Codice','Descrizione','Fase','Eff Min','Eff HH:MM','Pian Min','Pian HH:MM','Delta Min','Scost %','#Commesse','#Clienti']
      : ['Cliente','Commessa','Descrizione','Fase','Minuti','HH:MM'];

    const body = orePerFase.map(r => groupByCodiceFase
      ? [
        r.codice, r.descrizione, r.faseLabel,
        String(r.minutes), fmt(r.minutes),
        String(Math.round(r.pianMinutes||0)), fmt(r.pianMinutes||0),
        String(Math.round(r.deltaMinutes||0)),
        (r.scostPerc==null ? '' : r.scostPerc.toFixed(1)),
        String(r.commesseN||0), String(r.clientiN||0)
      ]

      : [r.cliente, r.commessaId, r.descrizione, r.faseLabel, String(r.minutes), fmt(r.minutes)]
    );
    const csv = [header, ...body].map(row =>
      row.map(v => {
        const s = String(v||'');
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')
    ).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'report_ore_per_fase.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }
  // === Filtro/aggregazione per riga articolo (non sostituisce il report esistente) ===
  const cardAgg = e('div', { className:'card', style:{ marginBottom:8 } },
    e('div', { className:'row', style:{ gap:12, alignItems:'center', flexWrap:'wrap' } },
      e('label', { className:'row', style:{ gap:6 } },
        e('input', { type:'checkbox', checked:groupByRiga, onChange:ev=>setGroupByRiga(ev.target.checked) }),
        e('span', null, 'Raggruppa per riga articolo')
      ),
            e('div', { className:'row', style:{ gap:6, alignItems:'center' } },
        e('span', { className:'muted' }, 'Commessa'),
        e('select', { value:commessaFilter, onChange:ev=>setCommessaFilter(ev.target.value) },
          e('option', { value:'' }, '— tutte —'),
          commesseIds.map(id => e('option', { key:id, value:id }, id))
        )
      ),

      // filtro per codice articolo (solo se groupByRiga)
      groupByRiga && e('div', { className:'row', style:{ gap:6, alignItems:'center' } },
        e('span', { className:'muted' }, 'Codice articolo'),
        e('select', {
          value: codiceFilter,
          onChange: ev => setCodiceFilter(ev.target.value)
        },
          e('option', { value:'' }, '— tutti —'),
          codiciList.map(cod => e('option', { key:cod, value:cod }, cod))
        )
      )
    ),

        // === R3: riepilogo tempi per selezione attuale ===
    ( (commessaFilter || (groupByRiga && codiceFilter)) ) && e('div', {className:'card', style:{marginTop:8}},
      e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center'}},
        e('div', null,
          e('div', {style:{fontWeight:700}}, 'Totale selezione'),
          e('div', {className:'muted', style:{fontSize:13}},
            commessaFilter ? `Commessa: ${commessaFilter}` : 'Commessa: tutte',
            (groupByRiga && codiceFilter) ? ` • Codice: ${codiceFilter}` : ''
          )
        ),
                e('div', {className:'row', style:{gap:12}},
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Pianificate'),
            e('div', {style:{fontWeight:700}}, fmt(selectionTotals.pianMin))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Pian. per pezzo'),
            e('div', {style:{fontWeight:700}}, fmt(selectionTotals.pianPerPiece))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Effettive'),
            e('div', {style:{fontWeight:700}}, fmt(selectionTotals.effMin))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Delta'),
            e('div', {
              style:{
                fontWeight:700,
                color: selectionTotals.delta>0 ? '#b91c1c' : (selectionTotals.delta<0 ? '#065f46' : '#374151')
              }
            }, (selectionTotals.delta>=0?'+':'') + fmt(selectionTotals.delta))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Scost. %'),
            e('div', {style:{fontWeight:700}},
              (selectionTotals.perc>=0?'+':'') + (Math.round(selectionTotals.perc*10)/10).toFixed(1) + '%'
            )
          )
        ),
        // Riepilogo costi in €, solo se ho un costo orario impostato
        (costoOrarioAzienda > 0) && e('div', {className:'row', style:{gap:12, marginTop:4}},
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Costo pianificato (€)'),
            e('div', {style:{fontWeight:700}}, fmtEuro(selectionTotals.costoPian))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Costo effettivo (€)'),
            e('div', {style:{fontWeight:700}}, fmtEuro(selectionTotals.costoEff))
          ),
          e('div', null,
            e('div', {className:'muted', style:{fontSize:12}}, 'Delta costo (€)'),
            e('div', {
              style:{
                fontWeight:700,
                color: selectionTotals.costoDelta>0 ? '#b91c1c' : (selectionTotals.costoDelta<0 ? '#065f46' : '#374151')
              }
            }, (selectionTotals.costoDelta>=0?'+':'') + fmtEuro(selectionTotals.costoDelta))
          )
        )
      )
    ),

    groupByRiga && e('div', { style:{ marginTop:8 } },
      e('table', { className:'table' },
        e('thead', null, e('tr', null,
          e('th', null, 'Commessa'),
          e('th', null, 'Riga #'),
          e('th', null, 'Codice'),
          e('th', null, 'Descrizione'),
          e('th', null, 'UM'),
          e('th', null, 'Pezzi'),
          e('th', null, 'Minuti'),
          e('th', null, 'Ore HH:MM')
        )),
        e('tbody', null,
           aggRowsFiltered.map((r, i) => e('tr', { key:i },
            e('td', null, r.commessaId),
            e('td', null, r.rigaIdx==null ? '—' : String(r.rigaIdx+1)),
            e('td', null, r.rigaCodice || ''),
            e('td', null, r.rigaDescrizione || ''),
            e('td', null, r.rigaUM || ''),
            e('td', null, String(r.pezzi || 0)),
            e('td', null, String(r.oreMin || 0)),
              e('td', null, r.oreHHMM || '0:00')
          ))
        )
      )
    )
  );

  // ---- Render ----
  return e('div', {className:'grid', style:{gap:16}},
      cardAgg,
    // Report 1
    e('div', {className:'actions', style:{justifyContent:'space-between'}},
      e('h3', null, 'Report Tempi — Pianificate vs Effettive'),
      e('button', {className:'btn btn-outline', onClick:exportCSV}, 'Esporta CSV')
    ),
    e('div', {className:'card'},
      vis.length===0
        ? e('div', {className:'muted'}, 'Nessuna commessa trovata')
        : e('table', {className:'table'},
            e('thead', null,
              e('tr', null,
                e('th', null, 'Commessa'),
                e('th', null, 'Cliente'),
                e('th', null, 'Descrizione'),
                e('th', {className:'right'}, 'Q.tà'),
                e('th', {className:'right'}, 'Pian. 1 pz'),
                e('th', {className:'right'}, 'Pian. tot'),
                e('th', {className:'right'}, 'Effettive'),
                e('th', {className:'right'}, 'Delta'),
                e('th', {className:'right'}, 'Scost. %'),
                e('th', null, 'Stato')
              )
            ),
            e('tbody', null,
              vis.map((r,i)=>{
                const stato = r.delta>0 ? '🔴 Ritardo' : '🟢 On time';
                const deltaStr = (r.delta>0?'+':'') + fmt(r.delta);
                return e('tr', {key:r.id||i},
                  e('td', null, r.id),
                  e('td', null, r.cliente || '-'),
                  e('td', null, r.descrizione || '-'),
                  e('td', {className:'right'}, String(r.qta)),
                  e('td', {className:'right'}, fmt(r.perPezzo)),
                  e('td', {className:'right'}, fmt(r.pianTot)),
                  e('td', {className:'right'}, fmt(r.effMin)),
                  e('td', {className:'right'}, deltaStr),
                  // scostamento percentuale colorato
                  e('td', {className:'right'}, 
                    e('span', {style:{fontWeight:600,color: (r.perc>1 ? '#b91c1c' : (r.perc<-1 ? '#065f46' : '#374151'))}}, (r.perc>=0?'+':'') + (Math.round(r.perc*10)/10).toFixed(1) + '%')),
                  e('td', null, stato)
                );
              })
            )
          )
    ),

    // Report 2: Ore per fase (nuovo)
    e('div', {className:'actions', style:{justifyContent:'space-between', marginTop:8}},
      e('h3', null, 'Ore per fase (filtrabile)'),
      e('div', {className:'row', style:{gap:8}},
        e('button', {className:'btn btn-outline', onClick:exportCSV_Fasi}, 'Esporta CSV')
      )
    ),
    e('div', {className:'card'},
       e('div', {className:'grid', style:{gap:8, gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))'}},
        e('label', null, 'Cliente',
          e('select', {value:fltCliente, onChange:ev=>setFltCliente(ev.target.value)},
            e('option', {value:''}, '— Tutti —'),
            clienti.map(c => e('option', {key:c, value:c}, c))
          )
        ),
        e('label', null, 'Commessa contiene',
          e('input', {value:fltCommessa, onChange:ev=>setFltCommessa(ev.target.value), placeholder:'es. C-2025-001'})
        ),
        e('label', null, 'Descrizione/Articolo contiene',
          e('input', {value:fltDescr, onChange:ev=>setFltDescr(ev.target.value), placeholder:'articolo/descrizione'})
        ),
        e('label', null, 'Codice articolo',
          e('select', {value:fltCodice, onChange:ev=>setFltCodice(ev.target.value)},
            e('option', {value:''}, '— Tutti —'),
            codiciArt.map(code => e('option', {key:code, value:code}, code))
          )
        ),
        e('label', {className:'row', style:{alignItems:'center', gap:6, marginTop:6, gridColumn:'1 / -1'}},
          e('input', {type:'checkbox', checked:groupByCodiceFase, onChange:ev=>setGroupByCodiceFase(ev.target.checked)}),
          e('span', null, 'Raggruppa per codice articolo (tutte le commesse)')
        ),
        e('label', null, 'Ordina per (solo raggruppa codice)',
          e('div', {className:'row', style:{gap:6}},
            e('select', {
              value: sortByCodFase,
              onChange: ev=>setSortByCodFase(ev.target.value),
              disabled: !groupByCodiceFase
            },
              e('option', {value:'codice'}, 'Codice'),
              e('option', {value:'eff'},    'Effettive'),
              e('option', {value:'pian'},   'Pianificate'),
              e('option', {value:'delta'},  'Delta')
            ),
            e('select', {
              value: sortDirCodFase,
              onChange: ev=>setSortDirCodFase(ev.target.value),
              disabled: !groupByCodiceFase
            },
              e('option', {value:'asc'},  '↑ Crescente'),
              e('option', {value:'desc'}, '↓ Decrescente')
            )
          )
        ),
        e('label', {className:'row', style:{alignItems:'center', gap:6, marginTop:6, gridColumn:'1 / -1'}},
          e('input', {
            type:'checkbox',
            checked: hideNoPlannedCodFase,
            onChange: ev=>setHideNoPlannedCodFase(ev.target.checked),
            disabled: !groupByCodiceFase
          }),
          e('span', null, 'Nascondi fasi senza pianificate')
        ),
                e('label', null, 'Fase',
          e('div', {className:'row', style:{gap:6}},
            e('select', {
              value: faseOptions.includes(fltFase) ? fltFase : '',
              onChange: ev=>setFltFase(ev.target.value)
            },
              e('option', {value:''}, '— Tutte —'),
              faseOptions.map(f => e('option', {key:f, value:f}, f))
            ),
            e('input', {
              value: fltFase,
              onChange: ev=>setFltFase(ev.target.value),
              placeholder:'contiene…'
            })
          )
        ),
        e('label', null, 'Operatore contiene',
          e('input', {value:fltOperatore, onChange:ev=>setFltOperatore(ev.target.value), placeholder:'es. Mario'})
        ),
        e('label', {className:'row', style:{alignItems:'center', gap:6, marginTop:6, gridColumn:'1 / -1'}},
          e('input', {type:'checkbox', checked:inclExtra, onChange:ev=>setInclExtra(ev.target.checked)}),
          e('span', null, 'Includi EXTRA (Cambio Bombola Gas)')
        )
                    ),
                totalsCodFase
        ? e('div', {className:'card', style:{marginTop:8, display:'flex', flexDirection:'column', gap:4}},
            e('div', {className:'row', style:{gap:14, alignItems:'center', flexWrap:'wrap'}},
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Totale codice'),
                e('div', {style:{fontWeight:700}}, fltCodice)
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Pianificate'),
                e('div', {style:{fontWeight:700}}, fmt(totalsCodFase.pian))
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Effettive'),
                e('div', {style:{fontWeight:700}}, fmt(totalsCodFase.eff))
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Delta'),
                e('div', {
                  style:{
                    fontWeight:700,
                    color: totalsCodFase.delta>0 ? '#b91c1c' : (totalsCodFase.delta<0 ? '#065f46' : '#374151')
                  }
                }, fmt(totalsCodFase.delta))
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Scost.%'),
                e('div', {style:{fontWeight:700}},
                  totalsCodFase.perc==null ? '—' : (totalsCodFase.perc.toFixed(1)+'%')
                )
              )
            ),
            (costoOrarioAzienda > 0) && e('div', {className:'row', style:{gap:14, alignItems:'center', flexWrap:'wrap', marginTop:4}},
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Costo pianificato (€)'),
                e('div', {style:{fontWeight:700}}, fmtEuro(totalsCodFase.costoPian))
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Costo effettivo (€)'),
                e('div', {style:{fontWeight:700}}, fmtEuro(totalsCodFase.costoEff))
              ),
              e('div', null,
                e('div', {className:'muted', style:{fontSize:12}}, 'Delta costo (€)'),
                e('div', {
                  style:{
                    fontWeight:700,
                    color: totalsCodFase.costoDelta>0 ? '#b91c1c' : (totalsCodFase.costoDelta<0 ? '#065f46' : '#374151')
                  }
                }, (totalsCodFase.costoDelta>=0?'+':'') + fmtEuro(totalsCodFase.costoDelta))
              )
            )
          )
        : null,

      orePerFase.length===0
        ? e('div', {className:'muted', style:{marginTop:8}}, 'Nessun risultato con i filtri correnti.')
        : e('table', {className:'table', style:{marginTop:8}},
            (groupByCodiceFase
              ? e('thead', null, e('tr', null,
                  e('th', null, 'Codice'),
                  e('th', null, 'Descrizione'),
                  e('th', null, 'Fase'),
                  e('th', {className:'right'}, 'Effettive'),
                  e('th', {className:'right'}, 'Eff. HH:MM'),
                  e('th', {className:'right'}, 'Pianificate'),
                  e('th', {className:'right'}, 'Pian. HH:MM'),
                  e('th', {className:'right'}, 'Delta'),
                  e('th', {className:'right'}, 'Scost.%'),
                  e('th', {className:'right'}, '#Commesse'),
                  e('th', {className:'right'}, '#Clienti')
                ))
              : e('thead', null, e('tr', null,
                  e('th', null, 'Cliente'),
                  e('th', null, 'Commessa'),
                  e('th', null, 'Descrizione'),
                  e('th', null, 'Fase'),
                  e('th', {className:'right'}, 'Minuti'),
                  e('th', {className:'right'}, 'HH:MM')
                ))
            ),
                        e('tbody', null, [
              ...orePerFase.map((r,i) => groupByCodiceFase
                ? e('tr', {key:i},
                    e('td', null, r.codice || '—'),
                    e('td', null, r.descrizione || '—'),
                    e('td', null, r.faseLabel || '—'),
                    e('td', {className:'right'}, String(r.minutes)),
                    e('td', {className:'right'}, fmt(r.minutes)),
                    e('td', {className:'right'}, String(Math.round(r.pianMinutes||0))),
                    e('td', {className:'right'}, fmt(r.pianMinutes||0)),
                    e('td', {className:'right'}, String(Math.round(r.deltaMinutes||0))),
                    e('td', {className:'right'}, (r.scostPerc==null ? '—' : (r.scostPerc.toFixed(1)+'%'))),
                    e('td', {className:'right'}, String(r.commesseN||0)),
                    e('td', {className:'right'}, String(r.clientiN||0))
                  )
                : e('tr', {key:i},
                    e('td', null, r.cliente || '—'),
                    e('td', null, r.commessaId || '—'),
                    e('td', null, r.descrizione || '—'),
                    e('td', null, r.faseLabel || '—'),
                    e('td', {className:'right'}, String(r.minutes)),
                    e('td', {className:'right'}, fmt(r.minutes))
                  )
              ),

              // --- Riga TOTALE ---
              (() => {
                const effTot = orePerFase.reduce((s,r)=> s + (Number(r.minutes)||0), 0);

                if (groupByCodiceFase){
                  const pianTot  = orePerFase.reduce((s,r)=> s + (Number(r.pianMinutes)||0), 0);
                  const deltaTot = effTot - pianTot;
                  const percTot  = pianTot>0 ? (deltaTot/pianTot)*100 : null;

                  return e('tr', {key:'__tot', className:'totrow'},
                    e('td', {colSpan:3, style:{fontWeight:700}}, 'TOTALE'),
                    e('td', {className:'right', style:{fontWeight:700}}, String(Math.round(effTot))),
                    e('td', {className:'right', style:{fontWeight:700}}, fmt(effTot)),
                    e('td', {className:'right', style:{fontWeight:700}}, String(Math.round(pianTot))),
                    e('td', {className:'right', style:{fontWeight:700}}, fmt(pianTot)),
                    e('td', {className:'right', style:{fontWeight:700}}, String(Math.round(deltaTot))),
                    e('td', {className:'right', style:{fontWeight:700}}, (percTot==null ? '—' : (percTot.toFixed(1)+'%'))),
                    e('td', {className:'right'}, ''),
                    e('td', {className:'right'}, '')
                  );
                }

                return e('tr', {key:'__tot', className:'totrow'},
                  e('td', {colSpan:4, style:{fontWeight:700}}, 'TOTALE'),
                  e('td', {className:'right', style:{fontWeight:700}}, String(Math.round(effTot))),
                  e('td', {className:'right', style:{fontWeight:700}}, fmt(effTot))
                );
              })()
            ])
          )
    )
  );
}

function SchedaArticoloModal({ articolo, movimenti, onClose }) {
  const e = React.createElement;
  const codice = String(articolo?.codice||'').trim();
  const desc   = String(articolo?.descrizione||'').trim();
  const um     = String(articolo?.um||'PZ').toUpperCase();
  const prezzo = Number(articolo?.prezzo||0);
  const cmp    = (articolo && Number.isFinite(Number(articolo.cmp))) ? Number(articolo.cmp) : null;
  const lastPrezzoOrdine = (articolo && articolo.lastPrezzoOrdine != null && articolo.lastPrezzoOrdine !== '')
    ? Number(articolo.lastPrezzoOrdine)
    : null;

  const movs = (Array.isArray(movimenti)?movimenti:[]).filter(m=>{
    const rl = Array.isArray(m?.righe) ? m.righe
             : Array.isArray(m?.rows)  ? m.rows
             : Array.isArray(m?.items) ? m.items
             : (m && (m.codice||m.code) ? [{codice:m.codice||m.code, qta:m.qta||m.qty||m.quantita||0, prezzo:m.prezzo||m.price||m.costo||0}] : []);
    return rl.some(x => String(x.codice||'').toLowerCase() === codice.toLowerCase());
  }).slice(-10).reverse(); // ultimi 10

  const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2});
  const giacenza = movimenti.reduce((s,m)=>{
    const rl = Array.isArray(m?.righe) ? m.righe
             : Array.isArray(m?.rows)  ? m.rows
             : Array.isArray(m?.items) ? m.items
             : (m && (m.codice||m.code) ? [{codice:m.codice||m.code, qta:m.qta||m.qty||m.quantita||0}] : []);
    const add = rl.filter(x=>String(x.codice||'').toLowerCase()===codice.toLowerCase()).reduce((ss,x)=> ss + Number(x.qta||0),0);
    return s + add;
  },0);

  return e('div', { className:'modal-backdrop' },
    e('div', { className:'modal-card' },
      e('h3', null, `Scheda articolo — ${codice}`),
      e('div', { className:'row', style:{gap:8} },
        e('div', null, `Descrizione: ${desc||'—'}`),
        e('div', null, `UM: ${um}`),
        e('div', null, `Prezzo: € ${fmt2(prezzo)}`),
        (lastPrezzoOrdine != null
          ? e('div', null, `Ultimo prezzo ordine: € ${fmt2(lastPrezzoOrdine)}`)
          : null
        ),
        e('div', null, `CMP: ${cmp!=null ? ('€ '+fmt2(cmp)) : '—'}`),
        e('div', null, `Giacenza: ${fmt2(giacenza)}`)
      ),
      e('div', { className:'card', style:{marginTop:8, maxHeight:300, overflowY:'auto'} },
        e('div', { className:'card-title' }, 'Ultimi movimenti'),
        e('table', { className:'table' },
          e('thead', null, e('tr', null,
            e('th', null, 'Data'), e('th', null, 'Tipo'),
            e('th', null, 'Rif.'), e('th', null, 'DDT/Forn.'),
            e('th', {style:{textAlign:'right'}}, 'Q.tà')
          )),
          e('tbody', null,
            movs.map(m=>{
              const qy = (Array.isArray(m?.righe)?m.righe:Array.isArray(m?.rows)?m.rows:Array.isArray(m?.items)?m.items:[])
                        .filter(x=>String(x.codice||'').toLowerCase()===codice.toLowerCase())
                        .reduce((s,x)=> s + Number(x.qta||x.qty||x.quantita||0),0);
              const tipo = String(m?.tipo||'').toUpperCase()==='C' ? 'CARICO' : (String(m?.tipo||'').toUpperCase()==='S' ? 'SCARICO' : (m?.tipo||''));
              return e('tr',{key:m.id},
                e('td', null, m.data||''), e('td', null, tipo),
                e('td', null, m.rifDoc||''), e('td', null, (m.fornitoreId||'') + (m.ddtFornitore?(' / '+m.ddtFornitore):'')),
                e('td', {style:{textAlign:'right'}}, fmt2(qy))
              );
            })
          )
        )
      ),
      e('div', { className:'row', style:{gap:8, marginTop:12, justifyContent:'flex-end'} },
        e('button', { className:'btn', onClick:onClose }, 'Chiudi')
      )
    )
  );
}

// === Dashboard Saturazione Reparti (pianificato, tabellare) ===
function SaturazioneRepartiView({ query = '' }) {
  const e = React.createElement;

  // helper: settimana ISO da data ISO (YYYY-MM-DD)
  function weekKeyFromDateISO(isoDate){
    if (!isoDate) return 'senza-data';
    const parts = String(isoDate).slice(0,10).split('-');
    if (parts.length !== 3) return 'senza-data';
    const y = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, d = parseInt(parts[2],10);
    if (!y || m<0 || m>11 || !d) return 'senza-data';
    const dt = new Date(Date.UTC(y,m,d));
    if (isNaN(dt.getTime())) return 'senza-data';

    const dayMs = 24*60*60*1000;
    const tmp = new Date(dt.getTime());
    const dayNr = (tmp.getUTCDay() + 6) % 7; // Monday=0
    tmp.setUTCDate(tmp.getUTCDate() - dayNr + 3); // nearest Thursday
    const firstThursday = new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
    const firstDayNr = (firstThursday.getUTCDay() + 6) % 7;
    firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDayNr + 3);
    const week = 1 + Math.round((tmp.getTime() - firstThursday.getTime()) / (7*dayMs));
    const year = tmp.getUTCFullYear();
    return year + '-W' + String(week).padStart(2,'0');
  }

  function loadCommesse(){
    try{
      const raw = (typeof window.lsGet === 'function')
        ? window.lsGet('commesseRows', [])
        : JSON.parse(localStorage.getItem('commesseRows') || '[]');
      return Array.isArray(raw) ? raw : [];
    }catch(_){
      return [];
    }
  }

  // criteri semplici: escludo solo se marcata chiusa/archiviata
  function isCandidata(c){
    const stato = String(c && c.stato || '').toLowerCase();
    if (stato === 'chiusa' || stato === 'consegnata') return false;
    if (c && (c.chiusa === true || c.consegnata === true || c.archiviata === true)) return false;
    return true;
  }

    function loadCapacitaRepartiMin(){
    try{
      const app = (typeof window.lsGet === 'function')
        ? window.lsGet('appSettings', {})
        : JSON.parse(localStorage.getItem('appSettings')||'{}');
      const src = app && app.capacitaReparti && typeof app.capacitaReparti === 'object'
        ? app.capacitaReparti
        : {};
      const out = {};
      Object.keys(src).forEach(name => {
        const ore = Number(src[name]);
        if (!Number.isFinite(ore) || ore <= 0) return;
        const key = String(name).trim();
        if (!key) return;
        out[key] = ore * 60; // minuti/settimana
      });
      return out;
    }catch(e){
      return {};
    }
  }

  // parser HH:MM locale per questa vista
  const toMinLocal = (s) => {
    const t = String(s || '').trim();
    if (!t) return 0;
    const m = t.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return 0;
    const h = parseInt(m[1] || '0', 10) || 0;
    const mm = parseInt(m[2] || '0', 10) || 0;
    return h*60 + mm;
  };

  // minuti pianificati da una singola fase (copia logica ReportTempi)
  function minsFromFase(f){
    if (!f || typeof f !== 'object') return 0;

    const n =
      (typeof f.oreMin === 'number' && isFinite(f.oreMin)) ? f.oreMin :
      (typeof f.minuti === 'number' && isFinite(f.minuti)) ? f.minuti :
      (typeof f.min === 'number' && isFinite(f.min)) ? f.min :
      (typeof f.orePrevMin === 'number' && isFinite(f.orePrevMin)) ? f.orePrevMin :
      null;

    if (n != null) return Math.max(0, Math.round(n));

    const hhmm =
      f.orePrevHHMM ||        // per-riga, quello che compili nel form
      f.oreHHMM ||
      f.hhmm ||
      f.orePrevistaHHMM ||
      f.orePrev ||
      f.durataHHMM ||
      '';

    return Math.max(0, Math.round(toMinLocal(hhmm || '0')));
  }

  function buildRowsAndStats(){
    const commesse = loadCommesse();
    const stats = {
      tot: commesse.length,
      candidate: 0,
      conCarico: 0
    };

    if (!commesse.length){
      return { rows: [], stats };
    }

    const buckets = new Map();

    const add = (weekKey, reparto, mins) => {
      const m = Number(mins) || 0;
      if (!m) return;
      const wk = weekKey || 'senza-data';
      const rep = reparto || '[Generico]';
      const key = wk + '||' + rep;
      let cur = buckets.get(key);
      if (!cur){
        cur = { weekKey: wk, reparto: rep, minuti: 0 };
        buckets.set(key, cur);
      }
      cur.minuti += m;
    };

    for (const c of commesse){
      if (!isCandidata(c)) continue;
      stats.candidate++;

      const righe = Array.isArray(c && c.righeArticolo)
        ? c.righeArticolo
        : (Array.isArray(c && c.righe) ? c.righe : []);

      const scadRaw =
        (c && (c.scadenza || c.dataScadenza || c.data_scadenza || c.dataConsegna || c.consegnaPrevista || c.consegna_prevista)) ||
        null;

      const dataScad = scadRaw ? String(scadRaw).slice(0,10) : null;
      const wk = weekKeyFromDateISO(dataScad);

      let addedForCommessa = 0;

      // 1) Uso fasi per-riga / globali con preferenza per-riga
      if (Array.isArray(righe) && righe.length){
        for (const row of righe){
          const rowFasi  = (row && Array.isArray(row.fasi) && row.fasi.length) ? row.fasi : [];
          const commFasi = (c && Array.isArray(c.fasi) && c.fasi.length) ? c.fasi : [];

          const hasRowPlanned = rowFasi.some(f => minsFromFase(f) > 0);
          const fasiEff = hasRowPlanned ? rowFasi : commFasi;

          let qRow = Number(row && (row.qta || row.qtaPezzi || row.qtaPrevista || row.pezzi || c.qtaPezzi)) || 0;
          if (qRow <= 0) qRow = 1;

          if (!Array.isArray(fasiEff) || !fasiEff.length) continue;

          for (const f of fasiEff){
            const base = minsFromFase(f);
            if (!base) continue;

            const isUnaTantum = !!(f.unaTantum || f.once);
            const tot = isUnaTantum ? base : (base * qRow);

            const rep = String(
              (f && (f.reparto || f.repartoNome || f.lav || f.nome)) || ''
            ).trim() || '[Senza fase]';

            add(wk, rep, tot);
            addedForCommessa += tot;
          }
        }
      }

      // 2) Fallback: se non ho carico, provo su fasi globali / ore totali
      if (addedForCommessa <= 0){
        const fasiComm = Array.isArray(c && c.fasi) ? c.fasi : [];
        const qComm = Math.max(1, Number(c && (c.qtaPezzi || c.pezzi || 1)));

        if (fasiComm.length){
          let perPiece = 0, unaTantum = 0;
          for (const f of fasiComm){
            const min = minsFromFase(f);
            if (!min) continue;
            if (f.unaTantum || f.once) unaTantum += min;
            else perPiece += min;
          }
          const totComm = Math.max(0, Math.round(unaTantum + perPiece * qComm));
          if (totComm > 0){
            add(wk, '[Commessa]', totComm);
            addedForCommessa += totComm;
          }
        } else {
          const perPiece = (typeof c.oreMin === 'number' && isFinite(c.oreMin))
            ? c.oreMin
            : toMinLocal(c.oreHHMM || '0');
          const totComm = Math.max(0, Math.round(perPiece * qComm));
          if (totComm > 0){
            add(wk, '[Commessa]', totComm);
            addedForCommessa += totComm;
          }
        }
      }

      if (addedForCommessa > 0) stats.conCarico++;
    }

    const out = Array.from(buckets.values());
    out.sort((a,b)=>{
      if (a.weekKey === b.weekKey){
        return a.reparto.localeCompare(b.reparto);
      }
      if (a.weekKey === 'senza-data') return 1;
      if (b.weekKey === 'senza-data') return -1;
      return a.weekKey.localeCompare(b.weekKey);
    });

    return { rows: out, stats };
  }

  const { rows, stats } = buildRowsAndStats();
  const capMinByRep = loadCapacitaRepartiMin();

    // costruiamo matrice: settimane × reparti
  const uniqWeeks = [];
  const uniqReps  = [];
  const seenWeeks = new Set();
  const seenReps  = new Set();
  const byKey     = new Map(); // key = week||reparto → minuti

  rows.forEach(r => {
    const wk  = r.weekKey || 'senza-data';
    const rep = r.reparto || '[Generico]';
    const key = wk + '||' + rep;
    const min = Number(r.minuti) || 0;

    if (!seenWeeks.has(wk)) { seenWeeks.add(wk); uniqWeeks.push(wk); }
    if (!seenReps.has(rep)) { seenReps.add(rep); uniqReps.push(rep); }

    byKey.set(key, (byKey.get(key) || 0) + min);
  });

  uniqWeeks.sort((a,b)=>{
    if (a === 'senza-data') return 1;
    if (b === 'senza-data') return -1;
    return a.localeCompare(b);
  });
  uniqReps.sort((a,b)=> a.localeCompare(b));

  const fmtHH = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m = t%60;
    return h + ':' + String(m).padStart(2,'0');
  };

  return e('div', { className:'page' },
    e('h2', null, 'Saturazione reparti (pianificato)'),
    e('p', { style:{ maxWidth:600, fontSize:13, color:'#4b5563'} },
      'Carico pianificato per settimana e reparto, calcolato dai tempi previsti nelle commesse. ',
      'Se in Impostazioni imposti la capacità settimanale per reparto (ore), qui vedi anche la percentuale di saturazione e i colori (verde / giallo / rosso).'
    ),
    e('p', { style:{ fontSize:11, color:'#9ca3af', marginTop:4 } },
      'Commesse totali: ', String(stats.tot),
      ' — considerate: ', String(stats.candidate),
      ' — con carico pianificato > 0: ', String(stats.conCarico)
    ),
    !rows.length
      ? e('p', { className:'muted', style:{ marginTop:8 } },
          'Nessuna commessa con carico pianificato trovata (controlla che i tempi previsti siano impostati).'
        )
      : e('table', { className:'table', style:{ marginTop:12, fontSize:13 } },
          e('thead', null,
            e('tr', null,
              e('th', null, 'Settimana'),
              // una colonna per reparto
              ...uniqReps.map(rep =>
                e('th', { key: 'h-'+rep, style:{ textAlign:'right' } }, rep)
              ),
              e('th', { style:{ textAlign:'right' } }, 'Totale ore')
            )
          ),
          e('tbody', null,
            uniqWeeks.map(wk => {
              let rowTot = 0;
              const cells = uniqReps.map(rep => {
                const mins = byKey.get(wk + '||' + rep) || 0;
                rowTot += mins;

                const capMin = capMinByRep[rep] || 0;
                let label = '';
                let cellStyle = { textAlign:'right' };

                if (mins > 0){
                  label = fmtHH(mins);

                  if (capMin > 0){
                    const perc = Math.round((mins * 100) / capMin);
                    label += ' ('+perc+'%)';

                    // Colori saturazione: <70 verde, 70–100 giallo, >100 rosso
                    if (perc > 100){
                      cellStyle.background = '#fee2e2';   // rosso chiaro
                      cellStyle.fontWeight = 600;
                    } else if (perc >= 70){
                      cellStyle.background = '#fef9c3';   // giallino
                    } else {
                      cellStyle.background = '#dcfce7';   // verdino
                    }
                  }
                }

                return e('td', {
                  key: 'c-'+wk+'||'+rep,
                  style: cellStyle
                }, label);
              });

              const children = [
                e('td', { key:'wk' }, wk === 'senza-data' ? 'Senza data' : wk),
                ...cells,
                e('td', {
                  key:'tot',
                  style:{ textAlign:'right', fontWeight:600 }
                }, rowTot ? fmtHH(rowTot) : '')
              ];

              return e('tr', { key: wk }, children);
            })
          )
        )
  );
}

window.SaturazioneRepartiView = window.SaturazioneRepartiView || SaturazioneRepartiView;

/* ================== MAGAZZINO (Articoli + Movimenti + Ordinamento Date) ================== */
function MagazzinoView(props){
  const initialTab = (props && props.initialTab) ? props.initialTab : 'articoli';
  const e = React.createElement;

  // RBAC sola lettura (accountant / viewer / mobile)
  const readOnly = (typeof window.isReadOnlyUser === 'function'
    ? !!window.isReadOnlyUser()
    : !!(window.__USER && window.__USER.role === 'accountant'));

  const roBtnProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));

  // Helper LOCALi per Magazzino:
  const lsGet = (k, d)=>{
    try {
      const raw = localStorage.getItem(k);
      if (raw == null || raw === '') return d;
      return JSON.parse(raw);
    } catch {
      return d;
    }
  };
  const lsSet = (k, v)=>{
    try {
      if (window.safeSetJSON) {
        window.safeSetJSON(k, v);
      } else {
        localStorage.setItem(k, JSON.stringify(v));
      }
      window.__anima_dirty = true;
    } catch {}
  };

  // Salva SEMPRE su entrambe le chiavi compatibili
  function persistArticoli(rows){
    try {
      const payload = Array.isArray(rows) ? rows : [];
      try { localStorage.setItem('magArticoli_v2', JSON.stringify(payload)); } catch {}
      if (typeof window.saveKey === 'function') {
        window.saveKey('magArticoli', payload);
      } else if (typeof lsSet === 'function') {
        lsSet('magArticoli', payload);
        lsSet('magazzinoArticoli', payload);
      } else {
        localStorage.setItem('magArticoli', JSON.stringify(payload));
        localStorage.setItem('magazzinoArticoli', JSON.stringify(payload));
      }
    } catch (err) {
      console.error('[Magazzino] persistArticoli ERROR', err);
    }
  }

  const persistMovimenti = (rows)=> {
    try { lsSet('magMovimenti', rows); } catch {}
  };

  const normalizeArticoli = (val) => {
    if (Array.isArray(val)) return val;
    if (val && Array.isArray(val.rows)) return val.rows;
    if (val && typeof val === 'object') return Object.values(val);
    return [];
  };

  function loadArticoliFromLS(){
    try {
      const rawV2 = localStorage.getItem('magArticoli_v2');
      if (rawV2 && rawV2 !== '[]') {
        const parsed = JSON.parse(rawV2);
        const norm   = normalizeArticoli(parsed);
        if (norm && norm.length) return norm;
      }
    } catch (err) {}
    try {
      const a = (typeof lsGet === 'function') ? lsGet('magArticoli', null) : null;
      const b = (typeof lsGet === 'function') ? lsGet('magazzinoArticoli', null) : null;
      return normalizeArticoli(a != null ? a : (b != null ? b : []));
    } catch { return []; }
  }

  // Stato
  const [tab, setTab]               = React.useState(initialTab);
  const [articoli, setArticoli]     = React.useState(()=> loadArticoliFromLS());
  const [movimenti, setMovimenti]   = React.useState(()=> lsGet('magMovimenti', []));
  const [q, setQ]                   = React.useState('');
  const [onlyNewFromOrder, setOnlyNewFromOrder] = React.useState(false);
  const [editArt, setEditArt]       = React.useState(null);
  const [schedaArt, setSchedaArt]   = React.useState(null);
  const [newMov, setNewMov]         = React.useState({ data:new Date().toISOString().slice(0,10), codice:'', qta:0, note:'' });
  
  // NUOVO: Stato ordinamento
  const [sortOrder, setSortOrder] = React.useState('codice'); // 'codice' | 'date'

  // Allegato Articolo
  const [allegatoArtForm, setAllegatoArtForm] = React.useState({
    tipo: 'DISEGNO', descrizione: '', path: '', url: ''
  });

  // Selezione multipla
  const [selected, _setSelected] = React.useState(new Set());
  function isSel(cod){ return selected.has(String(cod||'')); }
  function setSelected(next){ _setSelected(new Set(next)); }
  function toggleOne(cod, on){
    const k = String(cod||''); const s = new Set(selected);
    if(on) s.add(k); else s.delete(k);
    setSelected(s);
  }
  function toggleAll(list, on){
    if(!Array.isArray(list)) return;
    const s = new Set(selected);
    list.forEach(a => {
      const k = String(a.codice||''); if(!k) return;
      if(on) s.add(k); else s.delete(k);
    });
    setSelected(s);
  }
  function deleteSelected(){
    if(selected.size===0) return;
    if(!confirm(`Eliminare ${selected.size} articoli selezionati?`)) return;
    const next = (articoli||[]).filter(a => !selected.has(String(a.codice||'')));
    setArticoli(next); persistArticoli(next); setSelected(new Set());
  }

  React.useEffect(()=>{
    setArticoli(loadArticoliFromLS());
    setMovimenti(lsGet('magMovimenti', []));
  },[]);

  // ================== Import articoli ==================
  const fileArtRef = React.useRef(null);
  function onImportArtClick(){ fileArtRef.current && fileArtRef.current.click(); }

  function normArtKey(k){
    k = String(k||'').trim().toLowerCase();
    if (k.includes('codice') || k==='codice') return 'codice';
    if (k.includes('descri')) return 'descrizione';
    if (k==='um' || k.includes('u.m')) return 'um';
    if (k.includes('costo')) return 'costo';
    if (k.includes('prezzo')) return 'prezzo';
    return k;
  }
  function mapArticolo(row){
    const o = {};
    Object.keys(row||{}).forEach(k=> o[normArtKey(k)] = row[k]);
    const costoStr = o.costo;
    const hasCosto = (costoStr!=null && String(costoStr).trim()!=='');
    const costoNum = hasCosto ? (Number(String(costoStr).replace(',','.')) || 0) : undefined;
    return {
      codice: String(o.codice||'').trim(),
      descrizione: String(o.descrizione||'').trim(),
      um: (String(o.um||'').trim().toUpperCase() || 'PZ'),
      prezzo: Number(String(o.prezzo||'').replace(',','.')) || 0,
      ...(costoNum!=null ? { costo: costoNum } : {})
    };
  }

  function csvToObjects(text){
    const delim = text.split('\n',1)[0].includes(';') ? ';' : ',';
    const s = text.replace(/\r/g,'');
    const rows = [];
    let cell = '', row = [], inQuotes = false;
    for (let i=0;i<s.length;i++){
      const ch = s[i];
      if (inQuotes){
        if (ch === '"'){ if (s[i+1] === '"'){ cell += '"'; i++; } else inQuotes = false; } else cell += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === delim){ row.push(cell); cell=''; }
        else if (ch === '\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
        else cell += ch;
      }
    }
    if (cell.length || row.length){ row.push(cell); rows.push(row); }
    if (!rows.length) return [];
    const header = rows[0].map(h => String(h||'').trim());
    const out = [];
    for (let r=1;r<rows.length;r++){
      const o = {};
      for (let c=0;c<header.length;c++) o[header[c]] = rows[r][c] ?? '';
      out.push(o);
    }
    return out;
  }

  async function handleArtImportFile(ev){
    try{
      const file = ev?.target?.files?.[0]; if (!file) return;
      const name = file.name.toLowerCase();
      let rowsX = [];
      if (name.endsWith('.csv')){
        const text = await file.text();
        rowsX = csvToObjects(text);
      } else {
        if (window.ensureXLSX) await window.ensureXLSX();
        if (!window.XLSX) throw new Error('XLSX non caricato');
        const buf = await file.arrayBuffer();
        const wb  = window.XLSX.read(buf, { type:'array' });
        const ws  = wb.Sheets[wb.SheetNames[0]];
        if (!ws) throw new Error('Foglio vuoto');
        rowsX = window.XLSX.utils.sheet_to_json(ws, { defval:'' });
      }
      if (!rowsX.length) { alert('Il file non contiene righe'); return; }
      const imported = rowsX.map(mapArticolo).filter(a=> a.codice);
      if (!imported.length){ alert('Nessun articolo valido'); return; }

      const next = [...(articoli||[])];
      const nowISO = new Date().toISOString(); // Data import

      imported.forEach(src=>{
        const ix = next.findIndex(t=> String(t.codice).toLowerCase() === src.codice.toLowerCase());
        if (ix>=0) next[ix] = { ...next[ix], ...src, updatedAt: nowISO };
        else next.push({ ...src, createdAt: nowISO, updatedAt: nowISO });
      });
      
      setArticoli(next);
      persistArticoli(next);

      try{ if (window.sbUpsertMagazzinoArticoli) window.sbUpsertMagazzinoArticoli(imported).catch(()=>{}); }catch(e){}
      alert(`Import articoli completato: ${imported.length} righe.`);
    }catch(err){
      console.error('[Import Articoli]', err); alert('Errore import: ' + err);
    }finally{
      if (fileArtRef?.current) fileArtRef.current.value = '';
    }
  }

  // ================== Articoli: CRUD ==================
  function newArt(){ return { codice:'', descrizione:'', um:'PZ', prezzo:0, costo:0 }; }
  function openNewArt(){ setEditArt(newArt()); }
  function openNewArtFromCodice(codice){
    const base = newArt();
    base.codice = String(codice||'').trim();
    setEditArt(base);
  }
  function openEditArt(a){ setEditArt({ ...a }); }
  function cancelEditArt(){ setEditArt(null); }
  
  function saveArt(){
    const a = editArt || {};
    if (!a.codice){ alert('Inserisci CODICE articolo'); return; }

    const next = [...(articoli||[])];
    const ix = next.findIndex(x=> String(x.codice).toLowerCase() === String(a.codice).toLowerCase());
    const nowISO = new Date().toISOString();

    if (ix>=0) {
      // Modifica: aggiorno updatedAt
      next[ix] = { ...next[ix], ...a, updatedAt: nowISO };
    } else {
      // Nuovo: salvo anche createdAt
      next.push({ ...a, createdAt: nowISO, updatedAt: nowISO });
    }

    // Nota: non ordino l'array qui, lascio fare alla vista filter/sort
    setArticoli(next);
    persistArticoli(next);

    try{ if (window.sbUpsertMagazzinoArticoli) window.sbUpsertMagazzinoArticoli([a]).catch(()=>{}); }catch(e){}
    setEditArt(null);
  }

  function delArt(a){
    if (!confirm(`Eliminare articolo ${a.codice}?`)) return;
    const next = (articoli||[]).filter(x => String(x.codice).trim().toLowerCase() !== String(a.codice).trim().toLowerCase());
    setArticoli(next);
    persistArticoli(next);
  }

  // ================== Movimenti ==================
  function addMov(){
    const base = { ...newMov, qta: Number(newMov.qta||0) };
    if (!base.codice){ alert('Inserisci CODICE articolo'); return; }
    if (!base.qta){ alert('Quantità non valida'); return; }
    const info = (typeof window.nextIdFor === 'function') ? window.nextIdFor({ storageKey: 'magMovimenti', prefix: 'MAG', seriesKey: 'mag' }) : { id: null, createdAt: null };
    const now = new Date(); const nowISO = now.toISOString();
    const fallbackId = `MAG-${now.getFullYear()}-${String(now.getTime() % 1000).padStart(3, '0')}`;
    const m = { ...base, data: base.data || nowISO.slice(0,10), id: base.id || info.id || fallbackId, createdAt: base.createdAt || info.createdAt || nowISO, updatedAt: nowISO };
    const next = [...(movimenti||[]), m];
    setMovimenti(next); persistMovimenti(next);
    setNewMov({ ...newMov, codice:'', qta:0, note:'' });
  }
  function delMov(idOrIndex){
    const list = Array.isArray(movimenti) ? [...movimenti] : [];
    if (!list.length) return;
    const nowISO = new Date().toISOString();
    let idx = -1;
    if (typeof idOrIndex === 'string') idx = list.findIndex(m => m && m.id === idOrIndex);
    else if (typeof idOrIndex === 'number') idx = idOrIndex;
    if (idx < 0 || idx >= list.length) return;
    const cur = list[idx] || {};
    list[idx] = { ...cur, deletedAt: cur.deletedAt || nowISO, updatedAt: nowISO };
    setMovimenti(list); persistMovimenti(list);
  }

  const giacenze = React.useMemo(()=>{
    const map = new Map();
    (movimenti||[]).forEach(m=>{
      if (!m || m.deletedAt) return;
      const k = String(m.codice||'').toLowerCase(); if (!k) return;
      map.set(k, (map.get(k)||0) + Number(m.qta||0));
    });
    return map;
  }, [movimenti]);

  const phantomArticoli = React.useMemo(()=>{
    const artByCode = new Map();
    (articoli || []).forEach(a => { const k = String(a.codice || '').trim().toLowerCase(); if(k) artByCode.set(k, a); });
    const seen = new Map();
    (movimenti || []).forEach(m => {
      if (!m || m.deletedAt) return;
      const rawCod = m.codice || '';
      const k = String(rawCod).trim().toLowerCase();
      if (!k || artByCode.has(k)) return;
      const cur = seen.get(k) || { codice: rawCod, totale: 0, movCount: 0, lastData: null };
      cur.totale += Number(m.qta || 0) || 0;
      cur.movCount += 1;
      const d = m.data || '';
      if (!cur.lastData || String(d) > String(cur.lastData)) cur.lastData = d;
      seen.set(k, cur);
    });
    return Array.from(seen.values()).sort((a,b)=> String(a.codice||'').localeCompare(String(b.codice||'')));
  }, [articoli, movimenti]);

  // ================== UI ==================
  const tabsUI = e('div', {className:'tabs'},
    e('button', {className: tab==='articoli' ? 'active' : '', onClick:()=>setTab('articoli')}, 'Articoli'),
    e('button', {className: tab==='movimenti' ? 'active' : '', onClick:()=>setTab('movimenti')}, 'Movimenti')
  );

  // ---- LOGICA ORDINAMENTO (Filtrata) ----
  const filtered = (articoli||[])
    .filter(a => !onlyNewFromOrder || a?.nuovoDaOrdine)
    .filter(a=>{
      if (!q) return true;
      const s = (a.codice+' '+a.descrizione).toLowerCase();
      return s.includes(q.toLowerCase());
    })
    .sort((a,b) => {
      if (sortOrder === 'date') {
        // Data decrescente (più recenti in alto)
        const da = a.createdAt || a.updatedAt || '';
        const db = b.createdAt || b.updatedAt || '';
        if (db > da) return 1;
        if (db < da) return -1;
        return 0;
      }
      // Default: Alfabetico Codice
      return String(a.codice).localeCompare(String(b.codice));
    });

  // Mappa conteggio allegati
  let allegatiCountByCodice = {};
  try {
    const all = (typeof lsGet === 'function') ? (lsGet('allegatiRows', []) || []) : [];
    (Array.isArray(all) ? all : []).forEach(r => {
      if (!r || r.deletedAt) return;
      if (String(r.entityType || '').toUpperCase() !== 'ARTICOLO') return;
      const k = String(r.entityId || '').toLowerCase().trim();
      if (k) allegatiCountByCodice[k] = (allegatiCountByCodice[k] || 0) + 1;
    });
  } catch { allegatiCountByCodice = {}; }

  const articoliUI = e('div', null,
  e('div', {className:'actions', style:{justifyContent:'space-between', gap:8, alignItems:'center', flexWrap:'wrap'}},
    e('div', {style:{display:'flex', alignItems:'center', gap:8, flexWrap:'wrap'}},
      e('input', { placeholder:'Cerca…', value:q, onChange:ev=>setQ(ev.target.value) }),
      
      // NUOVO SELETTORE ORDINAMENTO
      e('select', {
        className:'input', 
        value: sortOrder, 
        onChange: ev => setSortOrder(ev.target.value),
        style: { cursor:'pointer', minWidth:160 }
      },
        e('option', {value:'codice'}, 'Ordina: Codice (A-Z)'),
        e('option', {value:'date'}, 'Ordina: Data inserimento')
      ),

      e('label', { className:'muted', style:{fontSize:12, display:'flex', alignItems:'center', gap:4} },
        e('input', { type:'checkbox', checked: !!onlyNewFromOrder, onChange: ev => setOnlyNewFromOrder(ev.target.checked) }),
        'Solo da ordine'
      )
    ),
    e('div', null,
      e('button', { className:'btn btn-outline', onClick:onImportArtClick, ...roBtnProps() }, '⬆️ Importa (.xlsx/.csv)'),
      e('input', { type:'file', accept:'.xlsx,.xls,.csv', ref:fileArtRef, style:{display:'none'}, onChange:handleArtImportFile }),
      e('button', { className:'btn', style:{marginLeft:8}, onClick:openNewArt, ...roBtnProps() }, '➕ Nuovo articolo'),
      e('button', { className:'btn btn-outline', style:{ marginLeft:8 }, disabled: selected.size===0, onClick: deleteSelected, ...roBtnProps() }, `Elimina (${selected.size})`)
    )
  ),

  // form edit/nuovo
    !editArt ? null : e('div', {className:'card', style:{marginTop:8}},
      e('div', {className:'card-title'}, 'Articolo'),
      e('div', {className:'grid grid-2'},
        e('label', null, 'Codice', e('input', { value: editArt.codice, onChange: ev => setEditArt({...editArt, codice: ev.target.value}) })),
        e('label', null, 'UM', e('input', { value: editArt.um || 'PZ', onChange: ev => setEditArt({...editArt, um: ev.target.value.toUpperCase()}) })),
        e('label', {style:{gridColumn:'1 / span 2'}}, 'Descrizione', e('input', { value: editArt.descrizione || '', onChange: ev => setEditArt({...editArt, descrizione: ev.target.value}) })),
        e('label', null, 'Prezzo (€)', e('input', { type:'text', inputMode: 'decimal', placeholder: '0.00', value: editArt.prezzo || '', onChange: ev => { const val = ev.target.value.replace(',', '.'); if (isNaN(Number(val)) && val !== '' && val !== '.') return; setEditArt({...editArt, prezzo: val}); }, onBlur: ev => { const n = parseFloat(ev.target.value.replace(',','.')); setEditArt({...editArt, prezzo: isNaN(n) ? 0 : n}); } })),
        e('label', null, 'Costo (€)', e('input', { type:'text', inputMode: 'decimal', placeholder: '0.00', value: (editArt.costo != null ? editArt.costo : ''), onChange: ev => { const val = ev.target.value.replace(',', '.'); if (isNaN(Number(val)) && val !== '' && val !== '.') return; setEditArt({...editArt, costo: val}); }, onBlur: ev => { const n = parseFloat(ev.target.value.replace(',','.')); setEditArt({...editArt, costo: isNaN(n) ? 0 : n}); } }))
      ),
      e('div', {className:'actions', style:{justifyContent:'flex-end', gap:8}},
        e('button', {className:'btn btn-outline', type:'button', onClick: cancelEditArt}, 'Annulla'),
        e('button', { className:'btn', type:'button', onClick: saveArt, ...roBtnProps() }, 'Salva')
      )
    ),

    // BLOCCO ALLEGATI (Mantenuto identico)
    !editArt ? null : (function(){
      const codice = (editArt && editArt.codice) ? String(editArt.codice).trim() : '';
      const entityId = codice;
      const all = lsGet('allegatiRows', []) || [];
      const rows = entityId ? (Array.isArray(all) ? all : []).filter(a => a && !a.deletedAt && String(a.entityType || '').toUpperCase() === 'ARTICOLO' && String(a.entityId || '').toUpperCase() === entityId.toUpperCase()) : [];
      function nextAllegatoId(existing){ const now=new Date(); const year=now.getFullYear(); let maxSeq=0; (existing||[]).forEach(r=>{ const id=r&&r.id?String(r.id):''; const m=/^ALG-(\d{4})-(\d+)$/.exec(id); if(m && +m[1]===year){ const n=parseInt(m[2],10); if(!isNaN(n) && n>maxSeq)maxSeq=n; } }); const next=String(maxSeq+1).padStart(4,'0'); return `ALG-${year}-${next}`; }
      function suggestDisegnoPath(eId){ if(!eId)return ''; const safeCode=String(eId).trim(); const appSets=window.lsGet('appSettings',{})||{}; const basePath=(appSets.docBasePath||'Z:\\ANIMA_DOC').replace(/\/+$/,''); return `${basePath}\\DISEGNI\\ARTICOLI\\${safeCode}\\${safeCode}.pdf`; }
      function suggestNCFornPath(eId){ if(!eId)return ''; const safeCode=String(eId).trim(); const year=new Date().getFullYear(); const appSets=window.lsGet('appSettings',{})||{}; const basePath=(appSets.docBasePath||'Z:\\ANIMA_DOC').replace(/\/+$/,''); return `${basePath}\\NC_FORN\\${year}\\${safeCode}\\${safeCode}-NC.pdf`; }
      const onChangeField = (field, value) => {
        setAllegatoArtForm(prev => {
          const base = prev || { tipo:'DISEGNO', descrizione:'', path:'', url:'' };
          let next = { ...base, [field]: value };
          if (field==='tipo' && value==='DISEGNO' && entityId && !(base.path && String(base.path).trim())) { const sug=suggestDisegnoPath(entityId); if(sug) next.path=sug; }
          if (field==='tipo' && value==='NC_FORN' && entityId) { if(!(base.path && String(base.path).trim())){ const nc=suggestNCFornPath(entityId); if(nc) next.path=nc; } if(!(base.descrizione && String(base.descrizione).trim())) next.descrizione=`NC fornitore articolo ${entityId}`; }
          return next;
        });
      };
            const sanitizeCode = (s) =>
        String(s||'').trim().replace(/[\\\/:*?"<>|]/g,'_').replace(/\s+/g,'_');

      const partsForTipo = (tipo, eId) => {
        const safeCode = sanitizeCode(eId);
        const year = new Date().getFullYear();
        const t = String(tipo||'DISEGNO').trim().toUpperCase();

        // Percorsi “automatici” (coerenti con le tue cartelle e con docBasePath)
        if (t === 'DISEGNO') return ['DISEGNI', 'ARTICOLI', safeCode];          // Z:\ANIMA_DOC\DISEGNI\ARTICOLI\CODICE\...
        if (t === 'NC_FORN') return ['NC_FORN', String(year), safeCode];       // Z:\ANIMA_DOC\NC_FORN\2025\CODICE\...

        return ['ALLEGATI', 'ARTICOLI', safeCode];                             // fallback
      };

      const onSmartUpload = async (ev) => {
        const file = ev.target && ev.target.files ? ev.target.files[0] : null;
        if(!file) return;

        if(!entityId){
          alert('Inserisci e salva il codice articolo prima di aggiungere allegati.');
          try{ ev.target.value=''; }catch{}
          return;
        }

        if (!window.__Z_HANDLE) {
          alert('Prima clicca "🔗 Connetti cartella ANIMA_DOC (Z:)" e seleziona la cartella ROOT. Poi riprova.');
          try{ ev.target.value=''; }catch{}
          return;
        }

        const f = allegatoArtForm || {};
        const tipo = (f.tipo || 'DISEGNO').trim() || 'DISEGNO';
        const savedPath = await window.smartSaveFile(file, partsForTipo(tipo, entityId), file.name);

        if (!savedPath) {
          alert('Salvataggio su Z fallito: ' + (window.__Z_LAST_ERR || 'errore'));
          try{ ev.target.value=''; }catch{}
          return;
        }

        let allRows=[]; try{ allRows=lsGet('allegatiRows',[])||[]; }catch(e){ allRows=[]; }
        if(!Array.isArray(allRows)) allRows=[];

        const id = nextAllegatoId(allRows);
        const nowIso = new Date().toISOString();
        const descr = (String(f.descrizione||'').trim()) || file.name;

        const newRow = {
          id, createdAt: nowIso,
          tipo,
          descrizione: descr,
          path: savedPath,
          url: '',
          entityType: 'ARTICOLO',
          entityId,
          note: '',
          deletedAt: null
        };

        if (window.allegatiUpsertOne) window.allegatiUpsertOne(newRow);
        else lsSet('allegatiRows', allRows.concat([newRow]));

        setAllegatoArtForm({ tipo:'DISEGNO', descrizione:'', path:'', url:'' });
        try{ ev.target.value=''; }catch{}
        alert('File caricato.');
      };
      const onAdd = () => {
        const f = allegatoArtForm || {};
        const tipo = (f.tipo||'DISEGNO').trim()||'DISEGNO'; const descr=(f.descrizione||'').trim(); const path=(f.path||'').trim(); const url=(f.url||'').trim();
        if(!entityId){ alert('Inserisci e salva il codice articolo prima di aggiungere allegati.'); return; }
        if(!path && !url){ alert('Inserisci almeno il percorso o l\'URL.'); return; }
        let allRows=[]; try{ allRows=lsGet('allegatiRows',[])||[]; }catch(e){allRows=[];} if(!Array.isArray(allRows))allRows=[];
        const id=nextAllegatoId(allRows); const nowIso=new Date().toISOString(); const baseDescr=descr||`Disegno articolo ${entityId}`;
        const newRow={ id, createdAt:nowIso, tipo, descrizione:baseDescr, path, url, entityType:'ARTICOLO', entityId, note:'', deletedAt:null };
        // Anti-wipe: una sola scrittura, merge-safe
        if (window.allegatiUpsertOne) {
          window.allegatiUpsertOne(newRow);
        } else if (window.allegatiSetMerged) {
          window.allegatiSetMerged([newRow]);
        } else {
          let cur=[]; try{ cur=(typeof lsGet==='function') ? (lsGet('allegatiRows',[])||[]) : []; }catch(e){cur=[];}
          if(!Array.isArray(cur)) cur=[];
          if (typeof lsSet === 'function') lsSet('allegatiRows', cur.concat([newRow]));
        }
        setAllegatoArtForm({ tipo:'DISEGNO', descrizione:'', path:'', url:'' });
      };
      const onDelete = (row) => {
        if(!row||!row.id) return;
        if(!window.confirm('Eliminare questo allegato articolo?')) return;

        // Anti-wipe: una sola strada di scrittura
        if (window.allegatiSoftDelete) {
          window.allegatiSoftDelete(row.id);
        } else {
          let allRows=[]; try{ allRows=lsGet('allegatiRows',[])||[]; }catch(e){allRows=[];}
          if(!Array.isArray(allRows)) allRows=[];
          const nowIso=new Date().toISOString();
          lsSet('allegatiRows', allRows.map(r=> r&&r.id===row.id ? {...r, deletedAt:(r.deletedAt||nowIso), updatedAt: nowIso} : r));
        }

        setAllegatoArtForm(prev=>({...prev}));
      };
      const onCopyPath = (row) => { const p=(row&&row.path)?String(row.path):''; if(!p)return; if(navigator&&navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(p).catch(()=>{ window.prompt('Copia il percorso:',p); }); }else{ window.prompt('Copia il percorso:',p); } };
      const onOpenUrl = (row) => { const u=(row&&row.url)?String(row.url):''; if(!u)return; if(/^https?:\/\//i.test(u)) window.open(u,'_blank'); };
      const f = allegatoArtForm || { tipo:'DISEGNO', descrizione:'', path:'', url:'' };

      return e('div', {className:'card', style:{marginTop:8}},
        e('div', {className:'card-title'}, 'Allegati articolo'),
                e('div', {className:'actions', style:{margin:'6px 0 10px 0', gap:8, flexWrap:'wrap', alignItems:'center'}},
          e('button', {
            className:'btn btn-outline',
            disabled: readOnly,
            onClick: async ()=>{
              await window.ensureZConnection({interactive:true});
              if (window.__Z_HANDLE) alert('Cartella collegata: ' + (window.__Z_HANDLE.name || 'OK'));
              else alert('Connessione non riuscita: ' + (window.__Z_LAST_ERR || 'errore'));
            }
          }, '🔗 Connetti cartella ANIMA_DOC (Z:)'),

          e('label', {
            className:'btn',
            style:{margin:0, display:'inline-flex', alignItems:'center', gap:8, cursor: readOnly ? 'not-allowed' : 'pointer', opacity: readOnly ? 0.6 : 1}
          },
            '📂 CARICA FILE SU Z:',
            e('input', {type:'file', style:{display:'none'}, onChange: onSmartUpload, disabled: readOnly})
          )
        ),
        !entityId ? e('p', {className:'muted'}, 'Inserisci e salva il codice articolo per poter aggiungere allegati.') : e(React.Fragment, null,
          rows.length ? e('table', {className:'table table-sm'},
            e('thead', null, e('tr',null,e('th',null,'Tipo'),e('th',null,'Descrizione'),e('th',null,'Percorso'),e('th',null,'Azioni'))),
            e('tbody', null, rows.map(r=> e('tr', {key:r.id||Math.random()},
              e('td', null, r.tipo||''), e('td', null, r.descrizione||''), e('td', null, r.path||''),
              e('td', null, e('div', {className:'row', style:{gap:4}},
                r.url && /^https?:\/\//i.test(r.url||'') ? e('button', {className:'btn btn-xs', onClick:()=>onOpenUrl(r)}, 'Apri') : null,
                r.path ? e('button', {className:'btn btn-xs', onClick:()=>onCopyPath(r)}, 'Copia percorso') : null,
                !readOnly ? e('button', {className:'btn btn-xs btn-outline', onClick:()=>onDelete(r)}, '🗑') : null
              ))
            )))
          ) : e('p',{className:'muted'}, 'Nessun allegato.'),
          e('div', {className:'grid grid-3', style:{marginTop:8}},
            e('div', null, e('label', null, 'Tipo'), e('select', {value:f.tipo, onChange:ev=>onChangeField('tipo',ev.target.value), disabled:readOnly}, e('option',{value:'DISEGNO'},'Disegno'), e('option',{value:'NC_FORN'},'NC fornitore'), e('option',{value:'ALTRO'},'Altro'))),
            e('div', null, e('label', null, 'Descrizione'), e('input', {value:f.descrizione, onChange:ev=>onChangeField('descrizione',ev.target.value), disabled:readOnly})),
            e('div', null, e('label', null, 'Percorso (path)'), e('input', {value:f.path, onChange:ev=>onChangeField('path',ev.target.value), disabled:readOnly})),
            e('div', null, e('label', null, 'URL (opzionale)'), e('input', {value:f.url, onChange:ev=>onChangeField('url',ev.target.value), disabled:readOnly}))
          ),
          e('div', {className:'actions'}, e('button', {className:'btn', onClick:onAdd, disabled:readOnly}, '➕ Aggiungi allegato'))
        )
      );
    })(),

    // tabella articoli
    e('div', {className:'card', style:{marginTop:8, overflowX:'auto'}},
      e('div', {className:'card-title'}, `Articoli (${filtered.length})`),
      e('table', {className:'table'},
        e('thead', null, e('tr', null,
          e('th', null, 'Codice'),
          e('th', null, 'Descrizione'),
          e('th', null, 'UM'),
          e('th', {style:{textAlign:'right'}}, 'Prezzo'),
          e('th', {style:{textAlign:'right'}}, 'Costo'),
          e('th', {style:{textAlign:'right'}}, 'Giac.'),
          e('th', {style:{textAlign:'center', width:28}}, 
            e('input', {
              type:'checkbox',
              ref: (el)=>{ if(el){ el.indeterminate = (filtered.some(a=>isSel(a.codice)) && !filtered.every(a=>isSel(a.codice))); } },
              checked: (filtered.length>0 && filtered.every(a => isSel(a.codice))),
              onChange: ev => toggleAll(filtered, ev.target.checked)
            })
          ),
          e('th', {style:{textAlign:'right'}}, 'Azioni')
        )),
        e('tbody', null, filtered.map((a,ix)=> e('tr', {key:ix},
          e('td', null, (allegatiCountByCodice && allegatiCountByCodice[String(a.codice||'').toLowerCase()]) ? `📎 ${a.codice}` : a.codice),
          e('td', null, a.descrizione, (allegatiCountByCodice && allegatiCountByCodice[String(a.codice||'').toLowerCase()]) ? ` (allegati: ${allegatiCountByCodice[String(a.codice||'').toLowerCase()]})` : ''),
          e('td', null, a.um||''),
          e('td', {style:{textAlign:'right'}}, (a.prezzo!=null? Number(a.prezzo).toFixed(2):'')),
          e('td', {style:{textAlign:'right'}}, (a.costo!=null? Number(a.costo).toFixed(2):'')),
          e('td', {style:{textAlign:'right'}}, giacenze.get(String(a.codice).toLowerCase()) || 0),
          e('td', {style:{textAlign:'center'}}, e('input', { type:'checkbox', checked: isSel(a.codice), onChange: ev => toggleOne(a.codice, ev.target.checked) })),
          e('td', {style:{textAlign:'right'}},
            e('button', {className:'btn btn-outline', onClick:()=>setSchedaArt(a)}, '🔎'),
            e('button', {className:'btn btn-outline', style:{marginLeft:6}, onClick:()=>openEditArt(a), ...roBtnProps()}, '✏️'),
            e('button', {className:'btn btn-outline', style:{marginLeft:6}, onClick:()=>delArt(a)}, '🗑️')
          )
        )))
      )
    )
  );

  // ---- MOVIMENTI ----
  const movUI = e('div', null,
    // Nuovo movimento
    e('div', {className:'card'},
      e('div', {className:'card-title'}, 'Nuovo movimento'),
      e('div', {className:'grid grid-4'},
        e('label', null, 'Data', e('input', { type:'date', value:newMov.data, onChange:ev=>setNewMov({ ...newMov, data:ev.target.value }) })),
        e('label', null, 'Codice', e('input', { value:newMov.codice, onChange:ev=>setNewMov({ ...newMov, codice:ev.target.value }) })),
        e('label', null, 'Q.tà (+ carico / - scarico)', e('input', { type:'number', value:newMov.qta, onChange:ev=>setNewMov({ ...newMov, qta:ev.target.value }) })),
        e('label', null, 'Note', e('input', { value:newMov.note, onChange:ev=>setNewMov({ ...newMov, note:ev.target.value }) }))
      ),
      e('div', {className:'actions', style:{justifyContent:'flex-end'}},
        e('button', { className:'btn', onClick:addMov, type:'button', ...roBtnProps() }, 'Aggiungi')
      )
    ),

    // Lista movimenti
    e('div', {className:'card', style:{marginTop:8}},
      e('div', {className:'card-title'}, `Movimenti (${(movimenti||[]).filter(m => !m?.deletedAt).length})`),
      e('table', {className:'table'},
        e('thead', null, e('tr', null, e('th', null, 'Data'), e('th', null, 'Codice'), e('th', {style:{textAlign:'right'}}, 'Q.tà'), e('th', null, 'Note'), e('th', null, ''))),
        e('tbody', null, (movimenti||[]).filter(m => !m?.deletedAt).map((m,ix)=> e('tr', {key: m.id || ix},
          e('td', null, m.data||''), e('td', null, m.codice||''), e('td', {style:{textAlign:'right'}}, m.qta||''), e('td', null, m.note||''),
          e('td', {style:{textAlign:'right'}}, e('button', { className:'btn btn-outline', onClick:()=>delMov(m.id || ix), ...roBtnProps() }, '🗑️'))
        )))
      )
    ),

    // Articoli fantasma
    !phantomArticoli.length ? null : e('div', {className:'card', style:{marginTop:8}},
      e('div', {className:'card-title'}, `Articoli senza anagrafica (${phantomArticoli.length})`),
      e('p', { className:'muted', style:{fontSize:12, marginTop:0} }, 'Codici presenti nei movimenti ma non in Magazzino → da valutare e creare come articoli.'),
      e('table', {className:'table two-cols'},
        e('thead', null, e('tr', null, e('th', null, 'Codice'), e('th', {style:{textAlign:'right'}}, 'Totale q.tà'), e('th', {style:{textAlign:'right'}}, '# movimenti'), e('th', null, 'Ultima data'), e('th', null, ''))),
        e('tbody', null, phantomArticoli.map(p => e('tr', {key:p.codice || p.lastData || Math.random()},
          e('td', null, p.codice || ''), e('td', {style:{textAlign:'right'}}, p.totale || 0), e('td', {style:{textAlign:'right'}}, p.movCount || 0), e('td', null, p.lastData || ''),
          e('td', {style:{textAlign:'right'}}, e('button', { className:'btn btn-outline', type:'button', onClick:()=>openNewArtFromCodice(p.codice), ...roBtnProps() }, 'Crea articolo'))
        )))
      )
    )
  );

  return e('div', null,
    tabsUI,
    tab==='articoli' ? articoliUI : movUI
      , (schedaArt && e(window.SchedaArticoloModal || (()=>null), { 
      articolo: schedaArt,
      movimenti,
      onClose: ()=> setSchedaArt(null)
    }))
  );
}
window.MagazzinoView = window.MagazzinoView || MagazzinoView;

// --- SAFE STUB PER SYNC CLOUD ---
(function ensureCloudFns(){
  if (typeof window.syncExportToCloud !== 'function') {
    window.syncExportToCloud = async function(){
      console.info('[syncExportToCloud] non configurata: no-op');
    };
  }
  if (typeof window.syncImportFromCloud !== 'function') {
    window.syncImportFromCloud = async function(){
      console.info('[syncImportFromCloud] non configurata: no-op');
    };
  }
  // ➕ NUOVO: export selettivo (usato dalla Timbratura)
  if (typeof window.syncExportToCloudOnly !== 'function') {
    window.syncExportToCloudOnly = async function(keys){
      try{
        const sb = window.getSB && window.getSB();
        if (!sb) return; // cloud non configurato
        const table = sb.table || 'anima_sync';
        const rows = [];
        (Array.isArray(keys)?keys:[]).forEach(k=>{
          try{
            const raw = localStorage.getItem(k);
            if (raw != null){
              rows.push({ k, data: JSON.parse(raw), updated_at: new Date().toISOString() });
            }
          }catch{}
        });
        if (!rows.length) return;
        const url = `${sb.url}/rest/v1/${encodeURIComponent(table)}?on_conflict=k`;
        const res = await fetch(url, {
          method:'POST',
          headers:{
            apikey: sb.key,
            Authorization:`Bearer ${sb.key}`,
            'Content-Type':'application/json',
            Prefer: 'resolution=merge-duplicates,return=minimal'
          },
          body: JSON.stringify(rows)
        });
        if (!res.ok) { console.warn('[syncExportToCloudOnly] HTTP', res.status, await res.text()); }
      }catch(e){
        console.warn('[syncExportToCloudOnly] errore', e);
      }
    };
  }
})();

// === Error boundary minimale + safeView (UNA SOLA VOLTA) ===
class ErrorBoundary extends React.Component {
  constructor(p){ super(p); this.state = { err:null }; }
  static getDerivedStateFromError(err){ return {err}; }
  componentDidCatch(err, info){ console.error('[ErrorBoundary]', err, info); }
  render(){
    if (this.state.err){
      return React.createElement(
        'div',
        {className:'card',style:{color:'#b00020',whiteSpace:'pre-wrap'}},
        'Errore UI: ', String(this.state.err)
      );
    }
    return this.props.children;
  }
}

function safeView(Comp, name, props){
  const e = React.createElement;

  if (!Comp || typeof Comp !== 'function') {
    console.warn(`[safeView] ${name}: componente mancante/non funzione`, Comp);
    return e('div', { className:'card muted' }, `Modulo ${name} non disponibile`);
  }

  class Guard extends React.Component {
    constructor(p){ super(p); this.state = { err: null }; }
    static getDerivedStateFromError(err){ return { err }; }
    componentDidCatch(err, info){
      console.error(`[${name}] crash in render`, err, info);
    }
    render(){
      if (this.state.err){
        const msg = (this.state.err && this.state.err.message) ? this.state.err.message : String(this.state.err);
        return e('div', { className:'card', style:{ color:'#b00020', whiteSpace:'pre-wrap' } },
          `Errore ${name}: `, msg
        );
      }
      try { return e(Comp, props || {}); }
      catch(err){
        console.error(`[${name}] sync error`, err);
        return e('div', { className:'card muted' }, `Errore nel modulo ${name}`);
      }
    }
  }

  return e(Guard);
}
// rendi safeView disponibile ovunque (serve alle view/route moderne se lo usano)
window.safeView = window.safeView || safeView;

/* ================== OPERATORE APP (solo timbratura) ================== */
function OperatoreApp(){
  const e = React.createElement;
  function scan(){ try{ window.scanQR && window.scanQR(); }catch(e){ alert('Scanner non disponibile'); } }
  function openManual(){ location.hash = '#/timbratura'; }

  return e('main', null,
    e('div', { className:'card', style:{ maxWidth:520, margin:'16px auto', padding:16 } },
      e('h2', {style:{marginTop:0}}, 'Timbratura'),
      e('div', {className:'muted', style:{marginBottom:12}}, 'Scansiona il QR della commessa o seleziona manualmente.'),
      e('div', {className:'actions', style:{gap:8}},
        e('button', {className:'btn', style:{width:'100%'}, onClick:scan}, '📷 Scansiona QR'),
        e('button', {className:'btn btn-outline', style:{width:'100%'}, onClick:openManual}, 'Seleziona manualmente')
      )
    )
  );
}
window.OperatoreApp = window.OperatoreApp || OperatoreApp;

// Riallinea qtaProdotta commessa e clamp fasi a qtaPezzi (SENZA popup di default)
window.riallineaQtaProdotte = function ({ silent = true } = {}) {
  const lsGet = window.lsGet || ((k, def) => {
    try { return JSON.parse(localStorage.getItem(k) || 'null') ?? def; } catch { return def; }
  });
  const lsSet = window.lsSet || ((k, v) => {
    try { localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; } catch {}
  });

  const all = Array.isArray(lsGet('commesseRows', [])) ? lsGet('commesseRows', []) : [];
  let commesseAggiornate = 0;
  let fasiClampate = 0;
  const nowISO = new Date().toISOString();

  const next = all.map(c => {
    const qTot = Math.max(1, Number(c.qtaPezzi || 1));
    let changed = false;

    // clamp per fase
    let fasiNew = c.fasi;
    if (Array.isArray(c.fasi)) {
      fasiNew = c.fasi.map(f => {
        const src = { ...f };
        const prev = Math.max(0, Number(src.qtaProdotta || 0));
        const clamped = Math.min(qTot, prev);
        if (clamped !== prev) { src.qtaProdotta = clamped; changed = true; fasiClampate++; }
        return src;
      });
    }

    // producedPieces = min tra fasi (già definito in app)
    const tmp = { ...c, fasi: fasiNew };
    const prodNow = (typeof window.producedPieces === 'function') ? window.producedPieces(tmp) : Number(c.qtaProdotta || 0);
    const prevComm = Number(c.qtaProdotta || 0);

    const out = { ...c, fasi: fasiNew };
    if (prodNow !== prevComm) { out.qtaProdotta = prodNow; changed = true; }

    if (changed) { out.updatedAt = nowISO; commesseAggiornate++; }
    return changed ? out : c;
  });

  if (commesseAggiornate > 0) lsSet('commesseRows', next);

  // niente alert se silent === true (default)
  if (!silent) {
    alert(`Riallineo completato.\nCommesse aggiornate: ${commesseAggiornate}\nFasi clampate a qtaPezzi: ${fasiClampate}`);
  }

  return { commesseAggiornate, fasiClampate };
};
if (!localStorage.getItem('__ANIMA_FIX_QTA_ONCE__')) {
  window.riallineaQtaProdotte && window.riallineaQtaProdotte({ silent: true });
  localStorage.setItem('__ANIMA_FIX_QTA_ONCE__', '1');
}

// --- HOTFIX fallback: garantisci che esista window.FattureView e la route ---
(function () {
  if (typeof window.FattureView !== 'function') {
    window.FattureView = function () {
      return React.createElement('div', null, 'Fatture — vista non ancora inizializzata');
    };
  }
  window.ROUTES = window.ROUTES || {};
  window.ROUTES['#/fatture'] = window.FattureView;
})();

/* ================== IMPORT ORDINI (PDF/TXT) — registry + parsers + pipeline ================== */
(function(){
  // --- Safe lsGet/lsSet ---------------------------------------------------
  const lsGet = window.lsGet || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; }});
  const lsSet = window.lsSet || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; }catch{} });

  // --- AppSettings: default per import ------------------------------------
  (function ensureImportDefaults(){
    const s = lsGet('appSettings', {}) || {};
    if (!Array.isArray(s.selfAliases))        s.selfAliases        = ['ANIMA','ANIMA SRL','ANIMA S.R.L.','ANIMA S R L'];
    if (!Array.isArray(s.orderParsersMeta))   s.orderParsersMeta   = [];
    if (!Array.isArray(s.processTemplates))   s.processTemplates   = [];
    lsSet('appSettings', s);
  })();

// --- Normalizzatore unico (AGGIORNATO: include PREZZO) ----------------------------------------------
window.sanitizeOrderParsed = function sanitizeOrderParsed(out, txt, name){

  const safe = (v, d)=> (v == null ? d : v);
  const righe = Array.isArray(out?.righe) ? out.righe : [];
  const qSum  = righe.reduce((s,r)=> s + (Number(String(r?.qta||0).replace(',','.')) || 0), 0);

  // hardening: nessun id esterno
  try{ if (out && 'id' in out) delete out.id; }catch{}

  // normalizza rifCliente
  const rif = (function(){
    if (!out) return null;
    const src = out.rifCliente ?? out.rif_cliente ?? out.rif;
    if (!src) return null;
    if (typeof src === 'object') {
      const tipo = (src.tipo || 'ordine').toString().trim() || 'ordine';
      const numero = (src.numero != null ? String(src.numero) : '').trim();
      let dataISO = '';
      const raw = src.data ?? src.dataDocumento ?? src.dataOrdine;
      if (raw) {
        const s = String(raw).trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) dataISO = s;
        else if (typeof window.parseITDate === 'function') dataISO = window.parseITDate(s) || '';
      }
      return { tipo, numero, data: dataISO };
    }
    if (typeof src === 'string') {
      return { tipo:'ordine', numero:src, data:'' };
    }
    return null;
  })();

  return {
    cliente     : safe(out?.cliente, '').trim(),
    descrizione : safe(out?.descrizione, out?.oggetto || 'Commessa da ordine PDF').trim(),
    scadenza    : safe(out?.scadenza, ''),
    righe       : righe.map(r => ({
      codice     : r?.codice || '',
      descrizione: r?.descrizione || '',
      um         : r?.um || 'PZ',
      qta        : Number(String(r?.qta||0).replace(',','.')) || 0,
      prezzo     : Number(String(r?.prezzo||0).replace(',','.')) || 0 // <--- CAMPO AGGIUNTO
    })),
    qtaPezzi    : Number(out?.qtaPezzi) || (qSum || 1),
    rifCliente  : rif,
    sorgente    : { kind:'pdf', name: name||'', bytes: (txt||'').length }
  };
};

  // --- Registry unico dei parser -----------------------------------------
  window.__orderParsers = window.__orderParsers || [];

  function registerRuntime(def){
    if (!def || !def.id) return;
    const id = String(def.id).toLowerCase();
    if (!window.__orderParsers.some(p => String(p?.id||'').toLowerCase() === id)) {
      window.__orderParsers.push(def);
      console.log('[order-parser] registrato:', def.id);
    }
  }

  window.addOrderParser = function addOrderParser(def){
    try{
      if (!def || !def.id) return;
      registerRuntime(def);

      const s = lsGet('appSettings', {}) || {};
      const meta = Array.isArray(s.orderParsersMeta) ? s.orderParsersMeta : [];
      const id = String(def.id).toLowerCase();
      if (!meta.some(m => String(m.id||'').toLowerCase() === id)) {
        meta.push({ id: def.id, name: def.name || def.id, addedAt: new Date().toISOString() });
        s.orderParsersMeta = meta;
        lsSet('appSettings', s);
      }
    }catch(e){ console.warn('[order-parser] add fail', e); }
  };

  // ================== PARSER VIMEK v2 (una volta sola) ====================
  (function registerVimekV2(){
    if (window.__orderParsers.some(p => p && p.id === 'vimek-v2')) return;

    try{
      if (!Array.isArray(window.__orderParsers)) window.__orderParsers = [];
    }catch(e){
      return;
    }

    const toNum = s => {
      if (s == null) return 0;
      const t = String(s).replace(/\./g,'').replace(',', '.');
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    };

    const parseData = s => {
      const str = String(s || '').trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

      if (typeof window.parseITDate === 'function') {
        const iso = window.parseITDate(str);
        if (iso) return iso;
      }

      const m = str.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
      if (!m) return '';
      let [_, dd, mm, yy] = m;
      dd = dd.padStart(2,'0');
      mm = mm.padStart(2,'0');
      if (yy.length === 2) {
        const yNum = Number(yy);
        yy = String(2000 + (Number.isFinite(yNum) ? yNum : 0));
      }
      yy = yy.padStart(4,'0');
      return `${yy}-${mm}-${dd}`;
    };

    window.addOrderParser({
      id  : 'vimek-v2',
      name: 'Vimek (Ordine Fornitore acquisto)',
      test: (txt, name='') => {
        const t = String(txt || '');
        // Ordine VIMEK per ANIMA: "Ordine Fornitore acquisto" + VIMEK
        return /VIMEK\s+BAKERY\s+AUTOMATION\s+SRL/i.test(t)
            && /Ordine\s+Fornitore\s+acquisto/i.test(t);
      },
      extract: (txt, name='') => {
        const cliente = 'VIMEK BAKERY AUTOMATION SRL';
        const flat    = String(txt || '').replace(/\s+/g,' ').trim();

        const righe    = [];
        const consegne = [];

        // Riga tipo:
        // "... Fornitura gruppo saldato: 5,00000 qt 402,00 074725_A451_103_A 05-12-25 ..."
        const rowRe = /([A-Za-z0-9 ,.'°\/-]{6,120}):\s*([0-9]+(?:,[0-9]+)?)\s+(qt|pz|kg|nr|lt|mt|ml)\s+([0-9.]+,[0-9]+|\d+)\s+([A-Z0-9._\-]{5,})\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/gi;

        let m;
        while ((m = rowRe.exec(flat))) {
          let descrRaw = m[1] || '';
          const num1Str = m[2];          // 5,00000  (prezzo nel tuo caso)
          const umRaw   = m[3] || 'PZ';  // "qt"
          const num2Str = m[4];          // 402,00   (quantità reale)
          const codice  = m[5] || '';
          const dataStr = m[6] || '';

          let descr = descrRaw.replace(/\s+/g,' ').trim();
          // Se troviamo "Fornitura ..." tieni solo da lì in poi
          const mF = descr.match(/(Fornitura.+)$/i);
          if (mF) descr = mF[1];

          const n1 = toNum(num1Str);
          const n2 = toNum(num2Str);

          // Per VIMEK: la quantità è il numero grande (402), il 5 è il prezzo.
          // Prendiamo n2 come priorità; se per qualche motivo è 0, usiamo il maggiore dei due.
          let qta = n2 || 0;
          if (!qta && (n1 || n2)) {
            qta = n1 > n2 ? n1 : n2;
          }

          const um      = 'PZ';  // nel gestionale vogliamo sempre PZ
          const dataIso = parseData(dataStr);

          if (!codice || !qta) continue;

          righe.push({
            codice,
            descrizione: descr || 'Riga ordine VIMEK',
            um,
            qta
          });

          if (dataIso) consegne.push(dataIso);
        }

        // Se non abbiamo trovato righe, lasciamo spazio ad altri parser/fallback
        if (!righe.length) {
          return { cliente:'', descrizione:'', righe:[] };
        }

        // Numero + data ordine:
        // "IT05463690288 001801 26-11-25 2007 1/1"
        let rifNumero  = '';
        let rifDataIso = '';
        const headMatch = flat.match(/IT[0-9]{11}\s+\S+\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\s+(\d{3,})\s+1\/1/);
        if (headMatch) {
          rifDataIso = parseData(headMatch[1] || '');
          rifNumero  = (headMatch[2] || '').trim();
        }

        // Scadenza: data consegna (CONSEGNA 05-12-25...) oppure max data righe
        let scadenza = '';
        const consMatch = flat.match(/CONSEGNA\s*([0-9]{1,2}[./-][0-9]{1,2}[./-][0-9]{2,4})/i);
        if (consMatch) {
          scadenza = parseData(consMatch[1] || '');
        }
        if (!scadenza && consegne.length) {
          scadenza = consegne.slice().sort().slice(-1)[0];
        }

        const descr = `Ordine fornitore VIMEK ${rifNumero || ''}`.trim();
        const qtaPezzi = righe.reduce((s,r)=> s + (r.qta || 0), 0) || 1;

        return {
          cliente,
          descrizione: descr || 'Commessa da ordine VIMEK',
          righe,
          qtaPezzi,
          scadenza,
          rifCliente: rifNumero
            ? { tipo:'ordine', numero: rifNumero, data: rifDataIso || scadenza || '' }
            : null
        };
      }
    });

    // metti vimek-v2 in testa
    try{
      window.__orderParsers = [
        ...window.__orderParsers.filter(p => p && p.id === 'vimek-v2'),
        ...window.__orderParsers.filter(p => !p || p.id !== 'vimek-v2'),
      ];
    }catch{}
  })();

  // ================== PARSER ACME IT v1 (una volta sola) ==================
  (function registerAcme(){
    if (window.__orderParsers.some(p => p && p.id === 'acme-it-v1')) return;

    window.addOrderParser({
      id: 'acme-it-v1',
      name: 'ACME S.p.A. (ordine IT)',
      test: (txt, name='') => /ACME\s*S\.?p\.?A\.?/i.test(txt) && /Ordine|Order/i.test(txt),
      extract: (txt, name='') => {
        const numero = (txt.match(/Ordine\s*n[°o]?\s*([A-Z0-9\-\/]+)/i)||[])[1]
                    || (txt.match(/Order\s*No\.?\s*([A-Z0-9\-\/]+)/i)||[])[1]
                    || '';

        const dRaw   = (txt.match(/Data\s*[:\-]?\s*(\d{1,2}[\/\.]\d{1,2}[\/\.]\d{2,4})/i)||[])[1]
                    || (txt.match(/Date\s*[:\-]?\s*(\d{1,2}[\/\.]\d{1,2}[\/\.]\d{2,4})/i)||[])[1]
                    || '';

        const iso = (function(s){
          if (!s) return '';
          const p = s.replace(/\./g,'/').split('/');
          if (p.length!==3) return '';
          let [dd,mm,yy] = p.map(x=>x.trim());
          if (yy.length===2) yy = (Number(yy)>=70 ? '19'+yy : '20'+yy);
          return `${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
        })(dRaw);

        const descrizione = (txt.match(/Oggetto\s*[:\-]\s*(.+)/i)||[])[1]
                         || (txt.match(/Object\s*[:\-]\s*(.+)/i)||[])[1]
                         || 'Ordine Cliente';

        const righe = [];
        const rgx = /(?:^|\n)\s*\d+\s+([A-Z0-9.\-\/]{3,})\s+(.+?)\s+(\d+(?:[.,]\d+)?)\s*(PZ|NR|KG|pz|nr|kg)?\s*(?:\n|$)/g;
        let m;
        while ((m = rgx.exec(txt))) {
          const codice = (m[1]||'').trim();
          const descr  = (m[2]||'').replace(/\s+/g,' ').trim();
          const qta    = Number(String(m[3]||'0').replace(',','.')) || 0;
          const um     = (m[4]||'PZ').toUpperCase();
          if (codice && descr && qta>0) righe.push({ codice, descrizione: descr, qta, um });
        }

        return {
          cliente       : 'ACME S.p.A.',
          ordineCliente : { tipo:'PO', numero, data: iso },
          descrizione   : descrizione,
          righe
        };
      }
    });
  })();

  (function registerG3OrdineCL(){
    try{
      if (!Array.isArray(window.__orderParsers)) window.__orderParsers = [];
    }catch(e){
      return;
    }

    if (window.__orderParsers.some(p => p && p.id === 'g3-ordine-cl-v1')) return;

    const toNum = s => {
      if (s == null) return 0;
      const t = String(s).replace(/\./g,'').replace(',', '.');
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    };

    const parseData = s => {
      const str = String(s || '').trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

      if (typeof window.parseITDate === 'function') {
        const iso = window.parseITDate(str);
        if (iso) return iso;
      }

      const m = str.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
      if (!m) return '';
      let [_, dd, mm, yy] = m;
      dd = dd.padStart(2,'0');
      mm = mm.padStart(2,'0');
      if (yy.length === 2) {
        const yNum = Number(yy);
        yy = String(2000 + (Number.isFinite(yNum) ? yNum : 0));
      }
      yy = yy.padStart(4,'0');
      return `${yy}-${mm}-${dd}`;
    };

    window.addOrderParser({
      id  : 'g3-ordine-cl-v1',
      name: 'G3 Ordine Conto Lavoro',
      test: (txt, name='') => {
        const t = String(txt || '');
        // ci basta riconoscere che è un "ORDINE CONTO LAVORO" per ANIMA
        return /ORDINE\s+CONTO\s+LAVORO/i.test(t) && /ANIMA\s+srl/i.test(t);
      },
      extract: (txt, name='') => {
        // testo appiattito come nel gestionale
        const flat = String(txt || '').replace(/\s+/g,' ').trim();

        const righe    = [];
        const consegne = [];

        // es: 305BA028 ACCUMULO 20 - E-200 A304 PZ 60 55,00 3.300,00 01-10-25
        const rowRe = /([A-Z0-9][A-Z0-9._\-]{4,})\s+(.+?)\s+(PZ|NR|KG|LT|MT|ML|PZ\.)\s+([0-9]+(?:[.,][0-9]+)?)\s+([0-9.]{1,3}(?:\.[0-9]{3})*(?:,[0-9]+)?)\s+([0-9.]{1,3}(?:\.[0-9]{3})*(?:,[0-9]+)?)\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/g;

        let m;
        while ((m = rowRe.exec(flat))) {
          const [, codice, descr, umRaw, qtaStr, , , dataStr] = m;

          // scarta falsi positivi tipo "ORDINE CONTO LAVORO ..."
          if (!/[0-9]/.test(codice)) continue;

          const um      = umRaw.replace(/\./g,'').toUpperCase();
          const qta     = toNum(qtaStr);
          const dataIso = parseData(dataStr);

          if (!codice || !qta) continue;

          righe.push({
            codice,
            descrizione: descr.trim(),
            um,
            qta
          });

          if (dataIso) consegne.push(dataIso);
        }

        // Se proprio non troviamo righe, lasciamo campo a parser/fallback successivi
        if (!righe.length) {
          return { cliente:'', descrizione:'', righe:[] };
        }

        // Numero + data ordine: blocco "... 1 di 1 000108 31.07.25"
        let rifNumero  = '';
        let rifDataIso = '';
        const headMatch = flat.match(/1\s+di\s+1\s+([0-9]{3,})\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/);
        if (headMatch) {
          rifNumero  = headMatch[1] || '';
          rifDataIso = parseData(headMatch[2] || '');
        }

        // Scadenza = data appront. merce più lontana tra le righe
        let scadenza = '';
        if (consegne.length) {
          scadenza = consegne.slice().sort().slice(-1)[0];
        }

        return {
          cliente     : 'G3 srl',
          descrizione : 'Ordine conto lavoro G3',
          righe,
          qtaPezzi    : righe.reduce((s,r)=> s + (r.qta || 0), 0) || 1,
          scadenza,
          rifCliente  : rifNumero
            ? { tipo:'ordine', numero: rifNumero, data: rifDataIso || scadenza || '' }
            : null
        };
      }
    });
  })();


// ================== PARSER STEEL SYSTEMS / ERGOMEC (Aggiornato v3) ==================
(function registerSteel(){
    try{
      if (!Array.isArray(window.__orderParsers)) window.__orderParsers = [];
    }catch(e){ return; }

    // Rimuovi la vecchia versione per evitare conflitti
    window.__orderParsers = window.__orderParsers.filter(function(p){
      return !p || String(p.id || '').toLowerCase() !== 'steel-systems';
    });

    function toNum(s){
      if (s == null) return 0;
      var t = String(s).replace(/\./g,'').replace(',', '.');
      var n = Number(t);
      return Number.isFinite(n) ? n : 0;
    }

    function parseData(s){
      var str = String(s || '').trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      if (typeof window.parseITDate === 'function') {
        var iso = window.parseITDate(str);
        if (iso) return iso;
      }
      var m = str.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
      if (!m) return '';
      var dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0'), yy = m[3];
      if (yy.length === 2) yy = '20' + yy;
      return yy + '-' + mm + '-' + dd;
    }

    window.addOrderParser({
      id: 'steel-systems',
      name: 'Ordini STEEL SYSTEMS / ERGOMEC (v3 con Prezzi)',
      
      test: function(txt, name){
        var t = String(txt || '');
        var isSteel = /STEEL\s+SYSTEMS/i.test(t);
        var isErgo  = /ERGOMEC\s*S\.?R\.?L\.?/i.test(t);
        // Cerca intestazioni tipiche
        return (isSteel || isErgo) && (/Pos\./i.test(t) || /Codice/i.test(t));
      },

      extract: function(txt, name){
        var flat = String(txt || '').replace(/\s+/g,' ').trim();
        var isErgomec = /ERGOMEC\s*S\.?R\.?L\.?/i.test(flat);

        var righe = [];
        var consegne = [];

        // Regex migliorata per catturare anche il PREZZO (gruppo 7)
        // Struttura tipica: Pos | Codice | Rev | Descrizione | UM | Qta | PrezzoUnit | Totale | Data
        // Es: 10 50100174 00 TELAIO FERRO PZ 2 150,00 300,00 15/12/25
        var rowRe = /\b(\d{1,4})\s+([0-9]{5,}[A-Z0-9]*)\s+([0-9]{2})?\s+(.+?)\s+(PZ|NR|KG|M|L|CADAUNO)\s+([0-9]+(?:[.,][0-9]+)?)\s+([0-9]+(?:[.,][0-9]+)?)\s+([0-9]+(?:[.,][0-9]+)?)\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/gi;

        let m;
        while ((m = rowRe.exec(flat))) {
          var codice   = m[2];
          var descrRaw = m[4];
          var umRaw    = m[5];
          var qtaStr   = m[6]; 
          var przStr   = m[7]; // <--- PREZZO UNITARIO
          var dataStr  = m[9];

          if (!codice) continue;

          var qta = toNum(qtaStr);
          var prz = toNum(przStr); // Convertiamo il prezzo
          var um  = (umRaw === 'CADAUNO' ? 'PZ' : umRaw).toUpperCase();

          if (qta > 0) {
            righe.push({
              codice: codice,
              descrizione: descrRaw.trim(),
              um: um,
              qta: qta,
              prezzo: prz // <--- Importante: passiamo il prezzo al sistema!
            });
            
            var dIso = parseData(dataStr);
            if (dIso) consegne.push(dIso);
          }
        }

        // Recupero Rif Ordine
        var rifNumero = '';
        var mNum = flat.match(/Numero\s+([0-9]+)/i) || flat.match(/Ordine\s+n[\.o]\s*([0-9]+)/i);
        if (mNum) rifNumero = mNum[1];

        // Recupero Data Ordine
        var rifDataIso = '';
        var mData = flat.match(/Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i);
        if (mData) rifDataIso = parseData(mData[1]);

        // Scadenza
        var scadenza = '';
        if (consegne.length) {
          consegne.sort();
          scadenza = consegne[consegne.length - 1];
        }

        var cliente = isErgomec ? 'ERGOMEC S.R.L.' : 'STEEL SYSTEMS S.r.l.';
        var descrComm = (isErgomec ? 'Ordine ERGOMEC ' : 'Ordine STEEL ') + rifNumero;

        // Somma qta
        var qtaPezzi = righe.reduce((a,b)=>a+(b.qta||0),0) || 1;

        console.log('[STEEL-PARSER] Estratte', righe.length, 'righe. Prezzi inclusi.');

        return {
          cliente: cliente,
          descrizione: descrComm,
          righe: righe,
          qtaPezzi: qtaPezzi,
          scadenza: scadenza,
          rifCliente: rifNumero ? { tipo:'ordine', numero: rifNumero, data: rifDataIso } : null
        };
      }
    });
})();

// ================== PARSER BLAUWER v1 (Ord. acq. Standard) - FINAL FIX ====================
  (function registerBlauwer(){
    try{
      if (Array.isArray(window.__orderParsers)) {
        window.__orderParsers = window.__orderParsers.filter(function(p){
          return !p || String(p.id || '').toLowerCase() !== 'blauwer-v1';
        });
      }
      if (typeof window.addOrderParser !== 'function') return;

      function toNum(s){
        if (s == null) return 0;
        const t = String(s).replace(/\./g,'').replace(',', '.');
        const n = Number(t);
        return Number.isFinite(n) ? n : 0;
      }

      window.addOrderParser({
        id  : 'blauwer-v1',
        name: 'Blauwer Ord. acq. Standard',
        test: (txt, name='') => {
          const t = String(txt || '');
          return /BLAUWER\s*S\.?P\.?A\.?/i.test(t) && /Ord\.\s*acq\./i.test(t);
        },
        extract: (txt, name='') => {
          let raw = String(txt || '');
          
          // 1. TAGLIO INTESTATURA: Cerco l'inizio della tabella per non confondere i dati header
          // Cerco "Pos." seguito da "Codice"
          const tableStartParams = raw.search(/Pos\./i);
          let tableText = raw;
          if (tableStartParams > -1) {
            // Tengo solo da "Pos." in poi per cercare le righe
            tableText = raw.substring(tableStartParams);
          }

          // Appiattisco il testo della tabella
          const flat = tableText.replace(/\s+/g, ' ').trim();
          
          const righe = [];

          // 2. Regex Righe: Pos -> Codice -> (Rev) -> Desc -> UM -> Qta -> Prezzo ... Data
          // Codice: Alfanumerico (es 58008196V7031)
          // Rev: opzionale 2 cifre (es 00)
          const rowRe = /\b(\d{1,4})\s+([A-Z0-9._\-]{5,})\s+(?:(\d{2})\s+)?(.+?)\s+(PZ|NR|KG|L1|L2|L3|M|MQ|ML)\s+([0-9]+(?:[.,][0-9]+)?)\s+([0-9]+(?:[.,][0-9]+)?).*?(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/gi;

          let m;
          while ((m = rowRe.exec(flat))) {
            const codice = m[2];
            let   rev    = m[3] || '';  // es '00'
            let   descr  = m[4];
            const um     = m[5].toUpperCase();
            const qta    = toNum(m[6]);
            const prezzo = toNum(m[7]); // Prezzo Unitario
            
            if (!codice || !qta) continue;

            // Pulizia descrizione
            descr = descr.trim();
            // Se la Rev non era tra codice e descr, potrebbe essere dentro la descr (inizio o fine)
            if (!rev) {
              // Rimuovi '00' all'inizio se c'è
              if (/^\d{2}\s+/.test(descr)) {
                 descr = descr.replace(/^(\d{2})\s+/, '');
              }
            }

            righe.push({
              codice,
              descrizione: descr,
              um,
              qta,
              prezzo
            });
          }

          // 3. Dati Testata (dal testo grezzo originale 'raw', non tagliato)
          const flatFull = raw.replace(/\s+/g, ' ').trim();
          let num = '';
          let dataOrd = '';
          
          const mHead = 
            flatFull.match(/Numero\s+([A-Z0-9\-\/]+)\s+Data\s+(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/i) ||
            flatFull.match(/Ord\.\s*acq\.\s*Standard.*?(\d{10})\s+.*(\d{2}\.\d{2}\.\d{4})/i);

          if (mHead) {
            num = (mHead[1] || '').trim();
            dataOrd = (mHead[2] || '').trim();
          }

          // 4. Scadenza
          let scad = '';
          try {
            const dates = flatFull.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/g) || [];
            const times = dates.map(d => {
              if (window.parseITDate) return new Date(window.parseITDate(d)).getTime();
              return 0;
            }).filter(t => t > 0 && !isNaN(t));
            if (times.length) {
              const maxTs = Math.max(...times);
              scad = new Date(maxTs).toISOString().slice(0,10);
            }
          } catch(e) {}

          // Rif Cliente
          let rifObj = null;
          if (num) {
            let dIso = '';
            if (dataOrd && window.parseITDate) dIso = window.parseITDate(dataOrd);
            rifObj = { tipo: 'ordine', numero: num, data: dIso };
          }

          return {
            cliente: 'BLAUWER S.P.A.',
            descrizione: `Ordine ${num} del ${dataOrd}`,
            righe,
            qtaPezzi: righe.reduce((s,r)=>s+r.qta, 0)||1,
            scadenza: scad,
            rifCliente: rifObj
          };
        }
      });
      console.log('[blauwer-v1] Parser FIX DEFINITIVO (Header Cut + Prezzi).');
    }catch(e){ console.warn(e); }
  })();

  // ================== PIPELINE UNICA DI IMPORT ============================
  window.importOrderFromPDFText = function(txt, name=''){
    const raw = String(txt || '');
    const sanitize = window.sanitizeOrderParsed || ((out)=>out);

    // 1) parser runtime registrati
    const arr = Array.isArray(window.__orderParsers) ? window.__orderParsers : [];
    for (const p of arr) {
      try{
        if (!p || typeof p.test !== 'function') continue;
        if (!p.test(raw, name)) continue;

        const out = (typeof p.extract === 'function' ? p.extract(raw, name) : {}) || {};
        const norm = sanitize(out, raw, name);

        // Se il parser dice di essere valido ma non ci sono righe con codice,
        // lasciamo che il pipeline provi gli altri fallback.
        const haRighe = Array.isArray(norm?.righe) && norm.righe.some(r => String(r.codice||'').trim());
        if (haRighe) return norm;
      }catch(e){
        console.warn('[order-parser] runtime error', p && p.id, e);
      }
    }

    // 2) fallback generico legacy, se esiste
    try{
      if (typeof window.parseOrderText === 'function') {
        const out = window.parseOrderText(raw, name) || {};
        const norm = sanitize(out, raw, name);
        const haRighe = Array.isArray(norm?.righe) && norm.righe.some(r => String(r.codice||'').trim());
        if (haRighe) return norm;
      }
    }catch(e){
      console.warn('[order-parser] parseOrderText fallback error', e);
    }

    // 3) ultima spiaggia: solo descrizione, nessuna riga
    const descr = (raw.match(/Oggetto\s*[:\-]\s*(.+)/i)||[])[1] || 'Commessa da ordine PDF';
    return sanitize({ descrizione: descr, righe: [] }, raw, name);
  };

  // ================== SALVATAGGIO COMMESSA IMPORTATA ======================
  window.saveImportedOrderAsCommessa = function saveImportedOrderAsCommessa(parsed){
    try{
      const genId = (function(){
        if (typeof window.getNextCommessaId === 'function') return window.getNextCommessaId;
        if (typeof window.nextProgressivo === 'function' && typeof window.formatNNN === 'function'){
          return function(){
            const n = window.nextProgressivo('C');
            return `C-${new Date().getFullYear()}-${window.formatNNN(n)}`;
          };
        }
        return function(){
          const y = new Date().getFullYear();
          const k = `C:${y}`;
          let counters={}; try{ counters = JSON.parse(localStorage.getItem('counters')||'{}')||{}; }catch{}
          const n = (Number(counters[k]||0)||0)+1; counters[k]=n;
          try{ localStorage.setItem('counters', JSON.stringify(counters)); }catch{}
          return `C-${y}-${String(n).padStart(3,'0')}`;
        };
      })();

      const all = Array.isArray(lsGet('commesseRows', [])) ? lsGet('commesseRows', []) : [];
      let id = genId();
      const exists = x => all.some(c => String(c.id) === String(x));
      if (exists(id)) { let i=1; while(exists(`${id}-${i}`)) i++; id = `${id}-${i}`; }

      const righe = Array.isArray(parsed?.righe) ? parsed.righe : [];
      const comm = {
        id,
        cliente      : (parsed?.cliente||'').trim(),
        descrizione  : (parsed?.descrizione||parsed?.oggetto||'Commessa da ordine PDF').trim(),
        qtaPezzi     : Number(parsed?.qtaPezzi) || (righe.reduce((s,r)=> s + (Number(r?.qta)||0), 0) || 1),
        scadenza     : parsed?.scadenza || '',
        righeArticolo: righe.map(r => ({
          codice     : r?.codice||'',
          descrizione: r?.descrizione||'',
          um         : r?.um||'PZ',
          qta        : Number(r?.qta)||0
        })),
        createdAt    : new Date().toISOString(),
        updatedAt    : new Date().toISOString(),
        sorgente     : parsed?.sorgente || { kind:'pdf', name: parsed?.sorgente?.name||'', bytes: parsed?.sorgente?.bytes||0 }
      };

      // se il cliente è “noi stessi”, azzera il campo
      try {
        const app = lsGet('appSettings', {});
        const selfSet = new Set((app.selfAliases||[]).map(x => String(x||'').trim().toLowerCase()));
        if (!comm.cliente || selfSet.has(String(comm.cliente).trim().toLowerCase())) comm.cliente = '';
      } catch {}

      try {
        if (typeof window.applyMatchedTemplate === 'function') window.applyMatchedTemplate(comm);
      } catch {}

      all.unshift(comm);
      lsSet('commesseRows', all);
      try { window.syncExportToCloudOnly && window.syncExportToCloudOnly(['commesseRows']); } catch {}
      alert('Ordine importato in commessa: ' + id);
      try { location.hash = '#/ddt?from=' + id; } catch {}
      return id;

    }catch(e){
      alert('Errore salvataggio commessa importata');
      console.error(e);
      return null;
    }
  };
})();

  // === Prefill DDT da commessa (idempotente) ===
  window.prefillDDTFromCommessa = window.prefillDDTFromCommessa || function(comm){
    try{
      const lines = Array.isArray(comm?.righeArticolo) && comm.righeArticolo.length
        ? (comm.righeArticolo.map(r => ({
            commessaRowId: String(r?.rowId || r?.rowID || ''),
            codice: String(r?.codice||''),
            descrizione: String(r?.descrizione||comm?.descrizione||''),
            um: String(r?.um||'PZ'),
            qta: Number(r?.qta||0) || 0,
          })))
        : [{
            codice: String(comm?.articoloCodice||''),
            descrizione: String(comm?.descrizione||''),
            um: 'PZ',
            qta: Number(comm?.qtaPezzi||1) || 1
          }];
      // compat: duplichiamo sulle chiavi più comuni per qualsiasi UI
      return {
        righe: lines,
        righeDDT: lines.map(x=>({...x})),
        righeArticolo: lines.map(x=>({...x}))
      };
    }catch{ return { righe:[], righeDDT:[], righeArticolo:[] }; }
  };

  // === Prefill DDT da commessa (idempotente) ===
  window.prefillDDTFromCommessa = window.prefillDDTFromCommessa || function(comm){
    try{
      const has = Array.isArray(comm?.righeArticolo) && comm.righeArticolo.length > 0;
      const lines = has
        ? comm.righeArticolo.map(r => ({
            codice: String(r?.codice||''),
            descrizione: String(r?.descrizione||comm?.descrizione||''),
            um: String(r?.um||'PZ'),
            qta: Number(r?.qta||0) || 0,
          }))
        : [{
            codice: String(comm?.articoloCodice||''),
            descrizione: String(comm?.descrizione||''),
            um: 'PZ',
            qta: Number(comm?.qtaPezzi||1) || 1
         }];

    // compat: duplichiamo sulle chiavi più comuni, così qualunque UI legge qualcosa
    return {
      righe: lines,
      righeDDT: lines.map(x=>({...x})),
      righeArticolo: lines.map(x=>({...x}))
    };
  }catch{
    return { righe:[], righeDDT:[], righeArticolo:[] };
  }
};

  // Scorciatoia: apri DDT dalla commessa più recente
window.openDDTFromLastCommessa = window.openDDTFromLastCommessa || function(){
  try{
    const id=(JSON.parse(localStorage.getItem('commesseRows')||'[]')[0]||{}).id;
    if(!id) return alert('Nessuna commessa trovata');
    location.hash = '#/ddt?from='+id;
  }catch(e){ alert('Errore apertura DDT'); console.error(e); }
};

// === Commesse: assicura rowId stabile per righeArticolo (idempotente) ===
window.ensureCommessaRowIds = window.ensureCommessaRowIds || function ensureCommessaRowIds(comm){
  try{
    if (!comm || typeof comm!=='object') return comm;
    const righe = Array.isArray(comm.righeArticolo) ? comm.righeArticolo : [];
    if (!righe.length) return comm;

    const base = String(comm.id || ('C?' + Date.now()));
    let changed = false;

    const nextRighe = righe.map((r, idx)=>{
      const rowId = r && (r.rowId || r.rowID || r.rigaId);
      if (rowId) return r;

      changed = true;
      const newId = `${base}#R${idx+1}-${Date.now().toString(36)}${Math.random().toString(36).slice(2,6)}`;
      return { ...r, rowId: newId };
    });

    return changed ? { ...comm, righeArticolo: nextRighe, updatedAt: new Date().toISOString() } : comm;
  }catch(e){
    console.warn('ensureCommessaRowIds', e);
    return comm;
  }
};


// === Commesse: assicura fasi per-riga (scaffolding per refactor G) ===
window.ensureCommessaRowFasi = window.ensureCommessaRowFasi || function ensureCommessaRowFasi(comm){
  try{
    if (!comm || typeof comm !== 'object') return comm;
    const righe = Array.isArray(comm.righeArticolo) ? comm.righeArticolo : [];
    if (!righe.length) return comm;

    const fasiTemplate = Array.isArray(comm.fasi) ? comm.fasi : [];
    if (!fasiTemplate.length) return comm;

    let changed = false;

    const newRighe = righe.map(r => {
      if (!r || typeof r !== 'object') return r;
      if (Array.isArray(r.fasi) && r.fasi.length) return r; // già ok

      changed = true;
      const copied = fasiTemplate.map(f => ({
        lav: f.lav || '',
        orePrevHHMM: f.orePrevHHMM || f.orePrevistaHHMM || '',
        unaTantum: !!f.unaTantum,
        once: !!f.once,
        // qtaProdotta per quella riga parte da 0
        qtaProdotta: 0
      }));
      return { ...r, fasi: copied };
    });

    return changed
      ? { ...comm, righeArticolo: newRighe, updatedAt: new Date().toISOString() }
      : comm;
  }catch(e){
    console.warn('ensureCommessaRowFasi', e);
    return comm;
  }
};

// === MIGRAZIONE ONE-SHOT: duplica fasi globali dentro righeArticolo (per vecchie commesse) ===
(function migrateCommessaRowFasiOnce(){
  try{
    const FLAG = 'mig_commessa_row_fasi_v1';

    const _lsGet = (typeof lsGet === 'function')
      ? lsGet
      : (k, d) => { try{ return JSON.parse(localStorage.getItem(k)||'null') ?? d; }catch{ return d; } };

    const _lsSet = (typeof lsSet === 'function')
      ? lsSet
      : (k, v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

    if (_lsGet(FLAG, false)) return;

    const all = _lsGet('commesseRows', []);
    if (!Array.isArray(all) || !all.length){
      _lsSet(FLAG, true);
      return;
    }

    const next = all.map(c => ensureCommessaRowFasi(c));
    const changed = JSON.stringify(all) !== JSON.stringify(next);

    if (changed){
      _lsSet('commesseRows', next);
      window.__anima_dirty = true;
      console.log('MIG row fasi v1 applicata ✅');
    }

    _lsSet(FLAG, true);
  }catch(e){
    console.warn('migrateCommessaRowFasiOnce', e);
  }
})();

// utility: trova commessa per id
window.findCommessaById = window.findCommessaById || function(id){
  try{
    const all = JSON.parse(localStorage.getItem('commesseRows')||'[]');
    return all.find(x => String(x.id) === String(id)) || null;
  }catch{ return null; }
};

// === APP + ROUTER DEFINITIVI (sidebar inclusa) ===
(function () {
  if (window.__ANIMA_APP_MOUNTED__) return;

  const e = React.createElement;

// ---------------- Sidebar (REATTIVA: si aggiorna al login) ----------------
  // Definizione rotte permesse ai worker (allineata con pickView)
  window.__ALLOWED_WORKER_ROUTES = new Set([
    '#/dashboard',
    '#/timbratura',
    '#/commesse',
    '#/ddt',
    '#/report',
    '#/login'
  ]);

    // ---------------- ROUTES: garantisci mapping PRIMA del mount ----------------
  (function ensureRoutesBeforeMount(){
    const R = window.ROUTES = window.ROUTES || {};

    // Stub minimale per viste eventualmente non inizializzate (evita route "undefined")
    const defView = (name, label) => {
      if (typeof window[name] !== 'function') {
        window[name] = function(){
          return e('div', { className:'page' }, label + ' — vista non inizializzata');
        };
      }
    };

    defView('DashboardView',           'Dashboard');
    defView('CommesseView',            'Commesse');
    defView('DDTView',                 'DDT');
    defView('FattureView',             'Fatture');
    defView('ClientiView',             'Clienti');
    defView('FornitoriView',           'Fornitori');
    defView('OrdiniFornitoriView',     'Ordini Fornitori');
    defView('OrdiniFornitoriRitardoView','OF in ritardo');
    defView('MagazzinoView',           'Magazzino');
    defView('ReportView',              'Report');
    defView('ReportTempiView',         'Report tempi');
    defView('SaturazioneRepartiView',  'Saturazione reparti');
    defView('ReportMaterialiView',     'Report materiali');
    defView('PreventiviView',          'Preventivi');
    defView('DiagnosticaView',         'Diagnostica');
    defView('ImpostazioniView',        'Impostazioni');
    defView('TimbraturaMobileView',    'Timbratura');

    // Mappa rotte (usa fallback dove hai alias possibili)
    const map = {
      '#/dashboard':        window.DashboardView,
      '#/commesse':         window.CommesseView,

      '#/ore':              (window.RegistrazioniOreView || window.OreView),
      '#/movimenti':        (window.MagazzinoMovimentiView || window.MovimentiView),

      '#/clienti':          window.ClientiView,
      '#/fornitori':        window.FornitoriView,

      '#/preventivi':       (window.PreventiviView || window.PreventivoView),

      '#/ddt':              window.DDTView,
      '#/fatture':          window.FattureView,
      '#/ordini':           window.OrdiniFornitoriView,
      '#/ordini-ritardo':   window.OrdiniFornitoriRitardoView,

      '#/magazzino':        window.MagazzinoView,

      '#/report-tempi':     window.ReportTempiView,
      '#/saturazione':      (window.SaturazioneRepartiView || window.SaturazioneView),
      '#/report-materiali': (window.ReportProdView || window.ReportMaterialiView),
      '#/report':           window.ReportView,

      '#/diagnostica':      window.DiagnosticaView,
      '#/impostazioni':     (window.ImpostazioniView || window.SettingsView),

      '#/login':            window.LoginView,
      '#/timbratura':       window.TimbraturaMobileView
    };

    Object.keys(map).forEach(h => {
      const Comp = map[h];
      if (typeof Comp === 'function') R[h] = Comp;
    });
  })();

  function Sidebar({ hash }) {
    const R   = (window.ROUTES || {});
    const cur = (hash || (location.hash || '#/dashboard')).toLowerCase();

    // 1. Stato User REATTIVO: ascolta il login per aggiornare il menu
    const [u, setU] = React.useState(window.__USER || null);
    
    React.useEffect(() => {
      const handler = (ev) => setU(ev.detail); // l'evento auth-change porta l'utente in .detail
      window.addEventListener('auth-change', handler);
      // check di sicurezza in caso di race condition all'avvio
      if (window.__USER !== u) setU(window.__USER);
      return () => window.removeEventListener('auth-change', handler);
    }, []);

    // Stato “aperta/chiusa” persistente
    const [open, setOpen] = React.useState(() => {
      try { return JSON.parse(localStorage.getItem('sidebarOpen') || 'true'); }
      catch { return true; }
    });
    React.useEffect(() => {
      try { localStorage.setItem('sidebarOpen', JSON.stringify(open)); } catch {}
      try { document.body.classList.toggle('sidebar-collapsed', !open); } catch {}
    }, [open]);

    // Voci di menù (base)
    const ALL_LINKS = [
      ['__title__', 'ANIMA'],

      ['__section__', 'Dashboard'],
        ['#/dashboard', 'Dashboard'],

      ['__section__', 'Produzione'],
        ['#/commesse', 'Commesse'],
        ['#/ore', 'Ore'],
        ['#/timbratura', 'Timbratura'],

      ['__section__', 'Anagrafiche'],
        ['#/clienti', 'Clienti'],
        ['#/fornitori', 'Fornitori'],

      ['__section__', 'Documenti'],
        ['#/preventivi', 'Preventivi'],
        ['#/ordini', 'Ordini fornitori'],
        ['#/ddt', 'DDT'],
        ['#/fatture', 'Fatture'],
        ['#/ordini-ritardo', 'OF in ritardo'],

      ['__section__', 'Magazzino'],
        ['#/magazzino', 'Magazzino'],
        ['#/movimenti', 'Movimenti'],

      ['__section__', 'Report'],
        ['#/report-tempi', 'Report tempi'],
        ['#/saturazione', 'Saturazione reparti'],
        ['#/report-materiali', 'Report materiali'],
        ['#/report', 'Report'],

      ['__section__', 'Sistema'],
        ['#/impostazioni', 'Impostazioni'],
        ['#/diagnostica', 'Diagnostica'],
    ];

    // — Filtro ruoli: worker / viewer / mobile vedono solo alcune rotte
    // NOTA: usiamo 'u' (lo stato reattivo) invece di window.__USER
    let role = u && u.role;

    // Se non c'è utente loggato:
    // - su schermi piccoli → trattalo come worker
    // - su desktop → mantieni comportamento attuale (admin implicito offline finché non fai login)
    if (!role) {
      const MOBILE_W = 1024;
      if (window.innerWidth <= MOBILE_W) {
        role = 'worker';
      } else {
        role = 'admin';
      }
    }

    const lowerRole = String(role).toLowerCase();
    const isAdmin = (lowerRole === 'admin');
    const isWorkerLike = (lowerRole === 'worker' || lowerRole === 'viewer' || lowerRole === 'mobile');

    let LINKS = ALL_LINKS;

    if (isWorkerLike) {
      LINKS = ALL_LINKS.filter(([href]) =>
        href === '__title__' ||
        href === '__section__' ||
        (window.__ALLOWED_WORKER_ROUTES && window.__ALLOWED_WORKER_ROUTES.has(href))
      );
    }

    // Solo ADMIN vede le voci di sistema (Impostazioni / Diagnostica)
    if (!isAdmin) {
      LINKS = LINKS.filter(
        ([href]) => href !== '#/impostazioni' && href !== '#/diagnostica'
      );
    }

    // Link factory
    const mkLink = (h, label) =>
      e('a', {
          href: h,
          className: 'nav-link' + (cur === h ? ' active' : ''),
          title: label
        },
        e('span', { className:'nav-text' }, label)
      );

    // De-duplica link ed elimina sezioni “vuote”
    const seen = new Set();
    const CLEAN = [];
    let pendingSection = null;

    for (const [href, label] of LINKS) {
      if (href === '__title__') {
        pendingSection = null;
        CLEAN.push([href, label]);
        continue;
      }
      if (href === '__section__') {
        pendingSection = label;
        continue;
      }
      // è un link
      if (String(href||'').startsWith('#/')) {
        if (seen.has(href)) continue;
        seen.add(href);
      }
      if (pendingSection != null) {
        CLEAN.push(['__section__', pendingSection]);
        pendingSection = null;
      }
      CLEAN.push([href, label]);
    }

    const nodes = [];
    for (const [href, label] of CLEAN) {
      if (href === '__title__') {
        // brand + toggle
        nodes.push(
          e('div', { key:'brand', className:'row', style:{ justifyContent:'space-between', alignItems:'center' } },
            e('div', { className:'brand' }, label),
            e('button', {
              className:'btn btn-outline',
              title: open ? 'Comprimi sidebar' : 'Espandi sidebar',
              onClick: ()=> setOpen(o => !o)
            }, open ? '⟨' : '⟩')
          )
        );
        continue;
      }
      if (href === '__section__') {
        nodes.push(e('div', { key:'sec-'+label, className:'groupTitle' }, label));
        continue;
      }
      if (R[href]) {
        nodes.push(e('div', { key: href }, mkLink(href, label)));
      }
    }

    return e('aside', { className: 'sidebar' }, e('nav', { className: 'nav' }, nodes));
  }

// ---------------- pickView centralizzato (PARANOICO: Sicuro di default) ----------------
  window.pickView = function () {
    const raw = (location.hash || '#/dashboard').toLowerCase();
    let h = raw.split('?')[0]; 

    // 1. SICUREZZA: Leggi impostazioni. 
    // SE authRequired non è definito (PC nuovo/Incognito), assumiamo TRUE per sicurezza.
    const settings = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}'); }catch{return {};} })();
    
    // Default paranoico: se il campo manca, è TRUE (richiedi login). 
    // Solo se è esplicitamente false (impostato dall'admin) lasciamo passare.
    const isAuthRequired = (settings.authRequired !== false); 

    const user = window.__USER || window.currentUser || null;
    
    if (isAuthRequired && !user) {
      if (h !== '#/login') {
        console.warn('Accesso negato: Login richiesto (Default Sicuro).');
        location.hash = '#/login';
        return function(){ return e('div', {className:'page'}, 'Accesso riservato. Reindirizzamento al login...'); };
      }
    }

    // 2. Se sei autenticato, via dal login
    if (h === '#/login' && user) {
      location.hash = '#/dashboard';
      return () => e('div', null);
    }

    // 3. RBAC: Controllo Ruoli (worker, viewer, ecc.)
    // Se l'utente c'è, usiamo il suo ruolo. Se NON c'è (caso raro offline senza auth), degradalo a 'worker' NON admin.
    const role = (user && String(user.role || '').toLowerCase()) || 'worker'; // <--- FIX WORKER SU PC
    const isAdmin = (role === 'admin');
    const isMobileLike = (role === 'viewer' || role === 'mobile');

    if (!isAdmin) {
      // Definisci qui le pagine permesse ai "non-admin"
      const allowed = new Set([
        '#/dashboard',
        '#/timbratura', 
        '#/commesse', 
        '#/ddt', 
        '#/login',
        '#/report'
      ]);

      if (!allowed.has(h)) {
        console.warn('Accesso negato a rotta:', h);
        if (h !== '#/dashboard') location.hash = '#/dashboard';
        h = '#/dashboard';
      }
    }

    const R = window.ROUTES || {};
    const Comp = R[h] || R['#/dashboard'] || R['#/ddt'];
    return (typeof Comp === 'function')
      ? Comp
      : function () {
          return e('div', { className: 'page' }, 'Vista non trovata: ' + h);
        };
  };

  // ---------------- App + Router (unico) ----------------
  function App() {
    const [hash, setHash] = React.useState((location.hash || '#/dashboard').toLowerCase());

    React.useEffect(() => {
      const handler = () => setHash((location.hash || '#/dashboard').toLowerCase());
      // installo un solo listener
      if (window.__anima_router_handler_app) {
        window.removeEventListener('hashchange', window.__anima_router_handler_app);
      }
      window.__anima_router_handler_app = handler;
      window.addEventListener('hashchange', handler);
      return () => {
        try { window.removeEventListener('hashchange', handler); } catch {}
        if (window.__anima_router_handler_app === handler) window.__anima_router_handler_app = null;
      };
    }, []);

    const View = window.pickView();
    const params = new URLSearchParams((location.hash.split('?')[1] || ''));
    const q = params.get('q') || '';

      return e('div', { className:'layout' },
      e(Sidebar, { hash }),
      e('main', { className:'content' }, e(View, { hash, query: q }))
    );

  }

  // ---------------- Mount ----------------
  const rootEl = document.getElementById('root');
  if (!rootEl) { console.error('#root non trovato'); return; }

  // Ripristina ultima rotta se l'URL non ne specifica una
  try {
    const h0 = String(location.hash || '');
    if (!h0 || h0 === '#' || h0 === '#/') {
      const last = localStorage.getItem('lastRoute') || '#/dashboard';
      if (typeof last === 'string' && last.startsWith('#/')) {
        location.replace(last); // no history pollution
      } else {
        location.replace('#/dashboard');
      }
    }
  } catch {}

  const root = ReactDOM.createRoot(rootEl);
  window.requestAppRerender = () => root.render(e(App));
  root.render(e(App));
  window.__ANIMA_APP_MOUNTED__ = true;

  // Sync iniziale magazzino dal cloud (non blocca la UI)
  try {
    if (window.syncMagazzinoFromCloud) {
      window.syncMagazzinoFromCloud()
        .then(res => {
          console.log('[boot] syncMagazzinoFromCloud', res);
        })
        .catch(err => {
          console.warn('[boot] syncMagazzinoFromCloud error', err);
        });
    }
  } catch (e) {
    console.warn('[boot] syncMagazzinoFromCloud exception', e);
  }

    // Sync iniziale COMMESSE dal cloud (non blocca la UI)
  try {
    if (window.syncCommesseFromCloud) {
      window.syncCommesseFromCloud()
        .then(res => {
          console.log('[boot] syncCommesseFromCloud', res);
        })
        .catch(err => {
          console.warn('[boot] syncCommesseFromCloud error', err);
        });
    }
  } catch (e) {
    console.warn('[boot] syncCommesseFromCloud exception', e);
  }

  // Dedupe: elimina sidebar legacy se presente
  try {
    const modern = document.querySelector('aside.sidebar');
    if (modern) { document.querySelectorAll('aside.card').forEach(a => a.remove()); }
  } catch {}

  // Riallinea subito lo stato della sidebar
  try {
    const v = JSON.parse(localStorage.getItem('sidebarOpen') || 'true');
    document.body.classList.toggle('sidebar-collapsed', !v);
  } catch {}

  // Salva sempre l'ultima rotta visitata
  try {
    const saveRoute = () => {
      try { localStorage.setItem('lastRoute', location.hash || '#/dashboard'); } catch {}
    };
    saveRoute();
    window.addEventListener('hashchange', saveRoute);
  } catch {}
})();

// === Sidebar: no-history navigation (migliora tasto Indietro) ===
(function tameSidebarHistory(){
  if (window.__tameSidebarHistoryInstalled__) return;
  window.__tameSidebarHistoryInstalled__ = true;
  document.addEventListener('click', function(ev){
    const a = ev.target.closest && ev.target.closest('.sidebar a.nav-link[href^="#/"]');
    if (!a) return;
    ev.preventDefault();
    const h = a.getAttribute('href');
    // sostituisci la voce corrente nella history anziché aggiungerne una nuova
    location.replace(h);
  });
})();

// === Alias report (compatibilità) ===
window.openReport          = window.openReport          || function(){ location.hash = '#/report'; };
window.openReportTempi     = window.openReportTempi     || function(){ location.hash = '#/report-tempi'; };
window.openReportMateriali = window.openReportMateriali || function(){ location.hash = '#/report-materiali'; };

// Persistenza robusta OF (aggiunge/aggiorna in LS)
(function(){
  window.persistOF = window.persistOF || function(of){
    try{
      if (!of || !of.id){ alert('OF senza id'); return false; }
      const all = JSON.parse(localStorage.getItem('ordiniFornitoriRows')||'[]')||[];
      const i = all.findIndex(x => String(x.id)===String(of.id));
      if (i>=0) all[i] = of; else all.push(of);
      localStorage.setItem('ordiniFornitoriRows', JSON.stringify(all));
      window.__anima_dirty = true;
      return true;
    }catch(e){ alert('Errore salvataggio OF: '+(e?.message||e)); return false; }
  };
})();

// --- OVERRIDE finale: stampa con numerazione robusta e ATTESA IMMAGINI ---
(function(){
  window.safePrintHTMLStringWithPageNum = function(html){
    try{
      // 1. Crea iframe invisibile
      const ifr = document.createElement('iframe');
      ifr.style.cssText = 'position:fixed;right:0;bottom:0;width:0;height:0;border:0;visibility:hidden';
      document.body.appendChild(ifr);

      const w = ifr.contentWindow, d = w.document;
      d.open(); 
      d.write(String(html||'')); 
      d.close();

      // 2. Funzione che calcola le pagine e lancia la stampa (LOGICA ORIGINALE INTATTA)
      const doPrint = () => {
        try{
          // A. Pulizia doppi pagebox
          try{
            const boxes = Array.from(d.querySelectorAll('.pagebox'));
            if (boxes.length > 1) {
              const keep = d.querySelector('#pagebox') || boxes[0];
              boxes.forEach(el => { if (el !== keep) el.remove(); });
            }
          }catch{}

          // B. Calcolo Pagine (Fallback JS se CSS fallisce)
          const pn = d.querySelector('#pagebox .pageNum') || d.querySelector('.pageNum');
          if (pn){
             // Rimuove ::after CSS per evitare " / " doppi
             const kill = d.createElement('style');
             kill.textContent = '.pageNum::after,.pageX::after{content:"" !important}';
             d.head.appendChild(kill);

             // Calcolo altezza
             const mmToPx = (() => {
                const t = d.createElement('div');
                t.style.height='100mm'; t.style.position='absolute'; t.style.visibility='hidden';
                d.body.appendChild(t);
                const px = t.getBoundingClientRect().height || 0;
                t.remove();
                return px/100;
             })();
             
             // A4 standard - margini
             // Nota: qui ho rimesso i valori originali del tuo codice (16/22)
             const pageHeightMm = 297 - (16 + 22); 
             const pageHeightPx = (mmToPx>0) ? (mmToPx*pageHeightMm) : (w.innerHeight||1123);
             
             const content = d.querySelector('.content') || d.body;
             const h = Math.max(content.scrollHeight, content.offsetHeight, d.body.scrollHeight);
             
             let total = Math.max(1, Math.ceil(h / pageHeightPx));
             if (!Number.isFinite(total) || total < 1) total = 1;
             
             // Correzione anti-sbavatura
             if (total === 2) {
               const lastTr = d.querySelector('table tbody tr:last-child');
               if (lastTr) {
                 const r = lastTr.getBoundingClientRect();
                 if (r && (r.bottom + 16) < pageHeightPx) total = 1;
               }
             }
             
             pn.removeAttribute('data-mode'); 
             pn.textContent = `1 / ${total}`;
          }

        } finally {
          // C. Lancia Stampa e poi rimuovi iframe
          try { w.focus(); w.print(); } catch {}
          setTimeout(()=>{ try{ ifr.remove(); }catch{} }, 500);
        }
      };

      // 3. LOGICA DI ATTESA IMMAGINI (Il Fix Necessario)
      const imgs = Array.from(d.images || []);
      
      // Se non ci sono immagini, stampa subito
      if (imgs.length === 0) {
        setTimeout(doPrint, 150); // piccolo ritardo standard
        return;
      }

      // Se ci sono immagini, aspetta che siano tutte "complete"
      let loadedCount = 0;
      let gaveUp = false;

      const checkDone = () => {
        if (gaveUp) return;
        loadedCount++;
        if (loadedCount >= imgs.length) {
          // Tutte caricate (o andate in errore), stampiamo!
          setTimeout(doPrint, 100); 
        }
      };

      // Timeout di sicurezza: se un'immagine si incanta, dopo 2.5s stampa comunque
      setTimeout(() => {
        if (loadedCount < imgs.length) {
          console.warn('Timeout attesa immagini, stampo comunque.');
          gaveUp = true;
          doPrint();
        }
      }, 2500);

      // Attacca i listener
      imgs.forEach(img => {
        if (img.complete) {
          checkDone();
        } else {
          img.addEventListener('load', checkDone);
          img.addEventListener('error', checkDone); // Conta come "fatto" anche se errore
        }
      });

      w.addEventListener?.('afterprint', () => { try{ ifr.remove(); }catch{} });

    }catch(e){
      console.warn('safePrintHTMLStringWithPageNum error', e);
      // Fallback estremo
      if (window.safePrintHTMLString) window.safePrintHTMLString(html);
    }
  };
})();

// === Magazzino: vista movimenti come alias ===
window.MagazzinoMovimentiView = window.MagazzinoMovimentiView || function(){
  return React.createElement(MagazzinoView, { initialTab: 'movimenti' });
};

// === Utils hash query ===
window.getHashParam = window.getHashParam || function(name){
  try{
    const q = (location.hash.split('?')[1] || '');
    return new URLSearchParams(q).get(name) || '';
  }catch{ return ''; }
};

/* ================== TIMBRATURA MOBILE — versione unica (Ripristinata + Fix Residuo) ================== */
var TimbraturaMobileView = function(){
  const e = React.createElement;

  // RBAC sola lettura
  const readOnly = (typeof window.isReadOnlyUser === 'function'
    ? !!window.isReadOnlyUser()
    : !!(window.__USER && window.__USER.role === 'accountant'));

  const roBtnProps = () =>
    (window.roProps ? window.roProps() : (readOnly ? {
      disabled: true,
      title: 'Sola lettura'
    } : {}));

  // Utente corrente
  const user = (typeof window !== 'undefined' && window.__USER) ? window.__USER : null;
  const rawRole = user && user.role ? String(user.role).toLowerCase() : '';
  let roleLabel = '';
  if (rawRole === 'admin') roleLabel = 'Admin';
  else if (rawRole === 'worker') roleLabel = 'Operatore';
  else if (rawRole === 'mobile') roleLabel = 'Mobile';
  else if (rawRole === 'accountant') roleLabel = 'Accountant';
  else if (rawRole === 'viewer') roleLabel = 'Viewer';

  const userLabel = user ? (user.name || user.username || user.email || user.user || '') : '';
  const headerUser = (userLabel && roleLabel) ? `${userLabel} — ${roleLabel}` : (userLabel || roleLabel || '');

  // Helpers LocalStorage
  const lsGet = (window.lsGet) || ((k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; }});
  const lsSet = (window.lsSet) || ((k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; }catch{} });

  // Tempo
  const todayISO = () => new Date().toISOString().slice(0,10);
  const _toMin = (s) => {
    if (s == null) return 0;
    const t = String(s).trim();
    const m = t.match(/^(\d{1,4})(?::([0-5]?\d))?$/);
    if (!m) return Math.max(0, Number(t) || 0);
    const h = parseInt(m[1] || '0', 10) || 0;
    const mm = parseInt(m[2] || '0', 10) || 0;
    return h * 60 + mm;
  };
  const fmtHHMM = (mins) => {
    const t = Math.max(0, Math.round(Number(mins)||0));
    const h = Math.floor(t/60), m=t%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  };
  const fmtHMS = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  };

  // Progresso commessa (fallback locale)
  const producedPieces = window.producedPieces || function(c){
    const qTot = Math.max(1, Number(c?.qtaPezzi || 1));
    if (!Array.isArray(c?.fasi) || c.fasi.length === 0) {
      const qp = Math.max(0, Number(c?.qtaProdotta || 0) || 0);
      return Math.min(qTot, qp);
    }
    const perPhase = c.fasi
      .filter(f => !(f?.unaTantum || f?.once))
      .map(f => Math.max(0, Number(f.qtaProdotta || 0)));
    if (perPhase.length === 0) return 0;
    return Math.min(qTot, Math.min(...perPhase));
  };

  // Funzione residuo legacy (usata come fallback)
  function residualPiecesUI(c, rigaIdx){
    if (!c) return 0;
    const totComm = Math.max(1, Number(c.qtaPezzi || 0));
    const idxNum = (rigaIdx === '' || rigaIdx == null) ? null : Number(rigaIdx);
    
    // Fallback semplice se non abbiamo helper core
    let prod = 0;
    if (typeof window.producedPieces === 'function') prod = window.producedPieces(c);
    else prod = Math.max(0, Number(c.qtaProdotta || 0));
    
    return Math.max(0, totComm - prod);
  }

  // Job ID
  const [jobId, setJobId] = React.useState('');
  React.useEffect(()=>{
    function refreshJob(){
      const h = window.location.hash || '';
      const qs = h.split('?')[1] || '';
      const params = new URLSearchParams(qs);
      const fromHash = params.get('job') || '';
      if (fromHash) { setJobId(fromHash); return; }
      try {
        const tmp = JSON.parse(localStorage.getItem('qrJob') || 'null');
        if (tmp) setJobId(String(tmp));
      } catch {}
    }
    refreshJob();
    window.addEventListener('hashchange', refreshJob);
    return ()=> window.removeEventListener('hashchange', refreshJob);
  },[]);

  // Dataset e Refresh
  const [refresh, setRefresh] = React.useState(0);
  React.useEffect(()=>{
    function onFocus(){ setRefresh(x=>x+1); }
    function onStorage(ev){
      if (['commesseRows','oreRows','appSettings'].includes(ev.key)) setRefresh(x=>x+1);
    }
    const t = setInterval(()=>{ if (window.__anima_dirty) { window.__anima_dirty = false; setRefresh(x=>x+1); }}, 1000);
    window.addEventListener('focus', onFocus);
    window.addEventListener('storage', onStorage);
    return ()=>{ clearInterval(t); window.removeEventListener('focus', onFocus); window.removeEventListener('storage', onStorage); };
  },[]);

  const app = React.useMemo(()=> lsGet('appSettings', {}) || {}, [refresh]);
  const operators = React.useMemo(() => {
    let arr = Array.isArray(app.operators) ? app.operators : [];
    if (!arr.length && Array.isArray(app.users)) {
      arr = app.users.map(u => u.name || u.label || u.email || u.username || '').filter(Boolean);
    }
    return (Array.isArray(arr) ? arr : []).map(o => typeof o === 'string' ? o.trim() : (o.name || '')).filter(Boolean);
  }, [app, refresh]);
  
  const commesse = React.useMemo(()=> lsGet('commesseRows', []), [refresh]);
  const oreRows  = React.useMemo(()=> lsGet('oreRows', []), [refresh]);

  const commessa = React.useMemo(
    ()=> (Array.isArray(commesse)?commesse:[]).find(c=>String(c.id)===String(jobId)) || null,
    [commesse, jobId]
  );

  // Normalizza fasi per riga
  React.useEffect(() => {
    if (!commessa) return;
    try {
      const normIds = (typeof window.ensureCommessaRowIds === 'function') ? window.ensureCommessaRowIds(commessa) : commessa;
      const norm = (typeof window.ensureCommessaRowFasi === 'function') ? window.ensureCommessaRowFasi(normIds) : normIds;
      if (norm === commessa) return; 
      const raw = lsGet('commesseRows', []);
      const all = Array.isArray(raw) ? raw.slice() : [];
      const ix = all.findIndex(x => String(x.id) === String(commessa.id));
      if (ix >= 0) {
        all[ix] = norm;
        lsSet('commesseRows', all);
        setRefresh(r => r + 1);
        window.__anima_dirty = true;
      }
    } catch (e) {}
  }, [commessa]);

  // Stato rete
  const [isOnline, setIsOnline] = React.useState(navigator.onLine);
  React.useEffect(()=>{
    const go = ()=>setIsOnline(true);
    const off= ()=>setIsOnline(false);
    window.addEventListener('online', go);
    window.addEventListener('offline', off);
    return ()=>{ window.removeEventListener('online', go); window.removeEventListener('offline', off); };
  },[]);

  // Righe
  const righe = React.useMemo(() => {
    if (!commessa) return [];
    return commessa.righeArticolo || commessa.righe || [];
  }, [commessa]);

  // Riga selezionata
  const [rigaIdx, setRigaIdx] = React.useState('');
  React.useEffect(() => {
    if (!commessa) { setRigaIdx(''); return; }
    const valid = Array.isArray(righe) ? righe.filter(r => String(r?.codice||'').trim() || String(r?.descrizione||'').trim()) : [];
    if (valid.length === 1) setRigaIdx('0');
  }, [commessa, righe]);

  // Fasi
  const fasi = React.useMemo(() => {
    if (!commessa) return [];
    const idx = (rigaIdx !== '' && rigaIdx != null) ? Number(rigaIdx) : null;
    if (Number.isFinite(idx) && righe[idx] && Array.isArray(righe[idx].fasi) && righe[idx].fasi.length){
      return righe[idx].fasi;
    }
    return commessa.fasi || [];
  }, [commessa, righe, rigaIdx]);

  // Stato form
  const [operatore, setOperatore] = React.useState('');
  const [faseIdx, setFaseIdx]     = React.useState(''); 
  React.useEffect(()=>{ if (!operatore && operators.length===1) setOperatore(operators[0]); }, [operators, operatore]);
  React.useEffect(()=>{ if (commessa && fasi.length && (faseIdx==='' || faseIdx==null)){ setFaseIdx('0'); } }, [commessa, fasi]);

  // Opzioni extra
  const [secondOp, setSecondOp]   = React.useState(false);
  const [thirdOp,  setThirdOp]    = React.useState(false);
  const [gasChange, setGasChange] = React.useState(false);
  const [opsCount, setOpsCount]   = React.useState(1);
  const ACTIVE_KEY = 'timbraturaActive';

  const [active, setActive] = React.useState(null);
  const [orphanActive, setOrphanActive] = React.useState(null);
  React.useEffect(()=>{
    if (thirdOp)      { if (secondOp) setSecondOp(false); setOpsCount(3); }
    else if (secondOp){ setOpsCount(2); }
    else              { setOpsCount(1); }
    if (active){
      const upd = {...active, opsCount: (thirdOp ? 3 : (secondOp ? 2 : 1))};
      setActive(upd); lsSet(ACTIVE_KEY, upd);
    }
  }, [secondOp, thirdOp]);

  // Restore attivo
  React.useEffect(()=>{
    const raw = lsGet(ACTIVE_KEY, null);
    if (raw && raw.jobId){
      if (String(raw.jobId) === String(jobId)){
        setActive(raw);
        setOperatore(raw.operatore||'');
        setFaseIdx(String(raw.faseIdx ?? ''));
        const oc = Number(raw.opsCount||1);
        setSecondOp(oc===2); setThirdOp(oc===3); setOpsCount(Math.min(3, Math.max(1, oc)));
        setGasChange(!!raw.isGasChange);
        if (typeof raw.rigaIdx === 'number') setRigaIdx(String(raw.rigaIdx));
        setOrphanActive(null);
      } else {
        setOrphanActive(raw);
      }
    } else {
      setOrphanActive(null);
    }
  },[jobId]);

  // Timer
  const [now, setNow] = React.useState(Date.now());
  React.useEffect(()=>{ if (!active) return; const t = setInterval(()=> setNow(Date.now()), 1000); return ()=> clearInterval(t); },[active]);

  // Minuti effettivi fase
  const effMinsPhase = React.useMemo(() => {
    if (!commessa || faseIdx === '' || !Array.isArray(oreRows)) return 0;
    const idx = Number(faseIdx);
    return oreRows
      .filter(o => {
        if (!o) return false;
        if (String(o.commessaId) !== String(commessa.id)) return false;
        const sameIdx = Number(o.faseIdx) === idx;
        return sameIdx;
      })
      .reduce((sum, o) => {
        const mins = (Number(o.oreMin) || 0) || _toMin(o.oreHHMM || 0);
        return sum + Math.max(0, mins);
      }, 0);
  }, [oreRows, commessa, faseIdx, fasi]);

  const plannedMinsOfPhase = (f) => {
    if (!f) return 0;
    const candidates = [f.oreMin, f.minuti, f.min, f.oreHHMM, f.ore];
    for (const v of candidates) { const n = _toMin(v); if (n > 0) return n; }
    return 0;
  };

  // QR Scanner
  const [scanOpen, setScanOpen] = React.useState(false);
  const scannerRef = React.useRef(null);
  function extractJobId(str){
    if (!str) return '';
    const m = String(str).match(/[A-Z]-\d{4}-\d{3}/);
    if (m) return m[0];
    return String(str).trim();
  }
  function openScanner(){
    if (!(window.Html5Qrcode || window.Html5QrcodeScanner)) {
      alert('Scanner non disponibile: aggiungi le librerie.');
      return;
    }
    setScanOpen(true);
  }
  
  React.useEffect(()=>{
    if (!scanOpen) return;
    const elId = 'qr-reader';
    const start = async ()=>{
      try{
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isMobile && window.Html5Qrcode){
          const h5 = new window.Html5Qrcode(elId);
          await h5.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 240 },
            (decodedText)=>{
              const jid = extractJobId(decodedText);
              if (jid){
                setJobId(jid);
                try{ localStorage.setItem('qrJob', JSON.stringify(jid)); }catch{}
              }
              setScanOpen(false);
              h5.stop().then(()=> h5.clear());
            }
          );
          scannerRef.current = h5;
        } else if (window.Html5QrcodeScanner){
          const scanner = new window.Html5QrcodeScanner(elId, { fps: 10, qrbox: 240 }, false);
          scanner.render((decodedText)=>{
             const jid = extractJobId(decodedText);
             if (jid){ setJobId(jid); try{ localStorage.setItem('qrJob', JSON.stringify(jid)); }catch{} }
             setScanOpen(false);
             scanner.clear();
          });
          scannerRef.current = scanner;
        } else if (window.Html5Qrcode){
          const h5 = new window.Html5Qrcode(elId);
          await h5.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 240 },
            (decodedText)=>{
              const jid = extractJobId(decodedText);
              if (jid){ setJobId(jid); try{ localStorage.setItem('qrJob', JSON.stringify(jid)); }catch{} }
              setScanOpen(false);
              h5.stop().then(()=> h5.clear());
            }
          );
          scannerRef.current = h5;
        }
      }catch(e){ console.warn('QR error', e); }
    };
    setTimeout(start, 50);
    return ()=>{ 
      try{ 
        if(scannerRef.current?.stop) scannerRef.current.stop(); 
        if(scannerRef.current?.clear) scannerRef.current.clear(); 
        scannerRef.current = null;
      }catch{} 
    };
  }, [scanOpen]);

  // Selettore riga
  function selectRiga(){
    if (!commessa || !righe.length) return;
    const txt = righe.map((r,i)=> `${i+1}) ${r.codice||''} ${r.descrizione||''}`).join('\n');
    const idx = prompt('Seleziona riga:\n'+txt, '1');
    if(idx){
        const n = parseInt(idx)-1;
        if(righe[n]) setRigaIdx(String(n));
    }
  }

  // START
  function start(){
    if (!jobId){ alert('Commessa non valida'); return; }
    if (!operatore){ alert('Seleziona un operatore'); return; }
    if (faseIdx===''){ alert('Seleziona una fase'); return; }
    if (righe.length > 1 && (rigaIdx==='' || rigaIdx==null)) { alert('Seleziona la riga articolo'); return; }

    const payload = {
      jobId: String(jobId),
      faseIdx: Number(faseIdx),
      operatore: String(operatore||''),
      opsCount: Math.min(3, Math.max(1, Number(opsCount)||1)),
      startISO: new Date().toISOString(),
      isGasChange: !!gasChange,
      rigaIdx: (rigaIdx===''||rigaIdx==null) ? null : Number(rigaIdx)
    };
    lsSet(ACTIVE_KEY, payload);
    setActive(payload);
  }

  const [askQty, setAskQty] = React.useState(null);
  const [qtyVal, setQtyVal] = React.useState('');

  // STOP
  function stop(){
    if (!active) return;
    const mins = Math.round((Date.now() - new Date(active.startISO).getTime())/60000) * (active.opsCount||1);

    // Suggerimento Q.tà (residuo)
    let suggestedQty = 0;
    try{
      if (!(gasChange || active.isGasChange) && commessa){
        const idxNum = (active.rigaIdx != null) ? Number(active.rigaIdx) : (rigaIdx ? Number(rigaIdx) : null);
        
        // --- QUI LA MODIFICA RICHIESTA: calcolo residuo con oreRows fresche ---
        if (window.residualPiecesCore) {
           suggestedQty = window.residualPiecesCore(commessa, oreRows, idxNum); 
        } else {
           suggestedQty = residualPiecesUI(commessa, idxNum); // fallback
        }
      }
    }catch{}
    
    setQtyVal(suggestedQty > 0 ? String(suggestedQty) : '');
    setAskQty({ minsEff: mins, snapshot: {...active} });
    setActive(null);
  }

  function cancelStop(){
    if (askQty && askQty.snapshot){
      lsSet(ACTIVE_KEY, askQty.snapshot);
      setActive(askQty.snapshot);
    }
    setAskQty(null);
  }

  function confirmStop(){
    if (!askQty) return;
    const qty = Math.max(0, Math.floor(Number(qtyVal)||0));
    const act = askQty.snapshot;
    const oreMin = askQty.minsEff;
    const oreHHMM = fmtHHMM(oreMin);
    const nowISO = new Date().toISOString();

    // Gestione GAS
    if (act.isGasChange) {
       const rec = {
          id: (window.nextIdUnique ? window.nextIdUnique('ore','O','oreRows').id : `O-G-${Date.now()}`),
          data: nowISO.slice(0,10),
          commessaId: String(jobId),
          faseIdx: null,
          operatore: act.operatore,
          oreMin, oreHHMM, note:'Cambio Bombola Gas', qtaPezzi:0,
          __createdAt: nowISO, updatedAt: nowISO
       };
       lsSet('oreRows', [...oreRows, rec]);
       alert('Gas salvato');
    } else {
       // Standard
       const rec = {
         id: (window.nextIdUnique ? window.nextIdUnique('ore','O','oreRows').id : `O-${Date.now()}`),
         data: nowISO.slice(0,10),
         commessaId: String(jobId),
         faseIdx: Number(act.faseIdx),
         operatore: act.operatore,
         oreMin, oreHHMM,
         qtaPezzi: qty,
         note: '',
         rigaIdx: act.rigaIdx,
         __createdAt: nowISO, updatedAt: nowISO
       };

       const nextOre = [...oreRows, rec];
       lsSet('oreRows', nextOre);

       // Aggiorna Commessa
       try {
         const allC = lsGet('commesseRows', []);
         const ix = allC.findIndex(c => String(c.id)===String(jobId));
         if (ix >= 0) {
            const cUpd = { ...allC[ix] };
            if (window.producedPiecesCore) {
               cUpd.qtaProdotta = window.producedPiecesCore(cUpd, nextOre);
            }
            if (Array.isArray(cUpd.fasi) && cUpd.fasi[Number(act.faseIdx)]) {
               const f = cUpd.fasi[Number(act.faseIdx)];
               f.qtaProdotta = (Number(f.qtaProdotta)||0) + qty;
            }
            cUpd.updatedAt = nowISO;
            allC[ix] = cUpd;
            lsSet('commesseRows', allC);
         }
       } catch {}
       
       alert('Salvato ✅');
    }

    localStorage.removeItem(ACTIVE_KEY);
    setAskQty(null);
    setRefresh(r=>r+1);
    
    // Sync cloud (non bloccante)
    try { if (window.syncExportToCloud) window.syncExportToCloud(); } catch {}
  }


  // RENDER
  return e('div', {className:'page timbratura'},
    // Warning orfana
    orphanActive && e('div', {className:'card', style:{borderColor:'orange', marginBottom:12}},
      e('div', {className:'muted'}, `Timbratura attiva su ${orphanActive.jobId}`),
      e('div', {className:'actions', style:{justifyContent:'flex-end', gap:8}},
        e('button', {className:'btn btn-outline', onClick:()=>{ localStorage.removeItem(ACTIVE_KEY); setOrphanActive(null); }}, 'Ignora'),
        e('button', {className:'btn', onClick:()=>{ setJobId(orphanActive.jobId); }}, 'Vai')
      )
    ),

    // Header azioni
    e('div', {className:'card', style:{marginBottom:12}},
      e('div', {className:'muted', style:{fontSize:12, marginBottom:4}}, headerUser),
      e('div', {className:'row', style:{justifyContent:'space-between', alignItems:'center'}},
        e('button', {className:'btn btn-outline', onClick:()=>{ if(history.length>1) history.back(); else location.hash='#/dashboard'; }}, '⬅ Indietro'),
        e('span', {className:'badge', style:{background:isOnline?'#16a34a':'#dc2626', color:'#fff'}}, isOnline?'ONLINE':'OFFLINE')
      ),
      e('div', {className:'row', style:{marginTop:8, gap:8}},
         commessa && e('button', {className:'btn btn-outline', onClick:()=>window.triggerEtichetteFor && window.triggerEtichetteFor(commessa, {})}, 'Stampa etichette'),
         e('div', {style:{marginLeft:'auto', display:'flex', gap:6}},
            e('button', {className:'btn btn-outline', onClick:()=>window.syncImportFromCloud && window.syncImportFromCloud()}, '⬇ Importa'),
            e('button', {className:'btn btn-outline', onClick:()=>window.syncExportToCloud && window.syncExportToCloud()}, '⬆ Esporta')
         )
      )
    ),

    // Card Commessa (Riepilogo LIVE)
    commessa && (function(){
        const totComm = Math.max(1, Number(commessa.qtaPezzi || 1));
        const rIdxNum = (rigaIdx===''||rigaIdx==null) ? null : Number(rigaIdx);
        const hasRow  = Number.isFinite(rIdxNum) && Array.isArray(commessa.righeArticolo) && commessa.righeArticolo[rIdxNum];
        const rSel    = hasRow ? commessa.righeArticolo[rIdxNum] : null;
        
        const totUI = hasRow ? Math.max(1, Number(rSel.qta || totComm)) : totComm;
        
        // Residuo LIVE
        let residUI = 0;
        if (window.residualPiecesCore) {
             residUI = window.residualPiecesCore(commessa, oreRows, rIdxNum); 
        } else {
             // fallback legacy se residualPiecesCore non c'è
             residUI = residualPiecesUI(commessa, rIdxNum); 
        }
        // clamp
        residUI = Math.max(0, Math.min(totUI, Number(residUI)||0));
        const prodUI = Math.max(0, totUI - residUI);

        const rowLabel = hasRow ? (rSel.codice || `Riga ${rIdxNum+1}`) : '';
        const title = commessa.descrizione + (rowLabel ? ` — ${rowLabel}` : '');

        return e('div',{className:'card timbratura-summary', style:{marginBottom:8}},
          e('div',{className:'timbratura-summary-inner'},
             e('div', {className:'muted', style:{marginBottom:2}}, `Commessa ${commessa.id}`),
             e('div', {style:{fontWeight:600, fontSize:14}}, title),
             e('div', {style:{display:'flex', gap:8, marginTop:6}},
                e('div', {style:{flex:1, border:'1px solid #ddd', borderRadius:6, padding:6, background:'#f9fafb'}},
                   e('div',{style:{fontSize:10, color:'#666'}}, 'TOT'),
                   e('div',{style:{fontSize:18, fontWeight:700}}, totUI)
                ),
                e('div', {style:{flex:1, border:'1px solid #ddd', borderRadius:6, padding:6, background:'#f9fafb'}},
                   e('div',{style:{fontSize:10, color:'#666'}}, 'FATTI'),
                   e('div',{style:{fontSize:18, fontWeight:700}}, prodUI)
                ),
                e('div', {style:{flex:1, border:'1px solid #ddd', borderRadius:6, padding:6, background:'#fee2e2'}},
                   e('div',{style:{fontSize:10, color:'#b91c1c'}}, 'RESIDUO'),
                   e('div',{style:{fontSize:18, fontWeight:700, color:'#b91c1c'}}, residUI)
                )
             )
          )
        );
    })(),

    // Input Commessa
    e('div', {className:'card', style:{marginBottom:8}},
      e('label', null, 'Commessa'),
      e('div', {className:'row', style:{gap:8}},
        e('input', {value:jobId, onChange:ev=>setJobId(ev.target.value), placeholder:'C-2025-xxx', style:{fontSize:18, flex:1}}),
        e('button', { className:'btn btn-outline', type:'button', onClick:openScanner }, '📷 Scan')
      )
    ),

    // Riga
    (commessa && righe.length > 1) && e('div', {className:'card', style:{marginBottom:8}},
      e('label', null, 'Riga articolo'),
      e('div', {className:'row', style:{gap:6}},
        e('select', {value:rigaIdx, onChange:ev=>setRigaIdx(ev.target.value), style:{fontSize:18, flex:1}},
           e('option', {value:''}, '— seleziona —'),
           righe.map((r,i)=> e('option',{key:i, value:String(i)}, `${i+1}) ${r.codice||''} ${r.descrizione||''}`))
        ),
        e('button', {className:'btn btn-outline', onClick:selectRiga}, 'Elenco')
      )
    ),

    // Operatore & Fase
    e('div', {className:'card', style:{marginBottom:8}},
       e('label', null, 'Operatore'),
       operators.length
         ? e('select', { value:operatore, onChange:ev=>setOperatore(ev.target.value), style:{fontSize:18, marginBottom:12}},
             e('option', {value:''}, '— seleziona —'),
             operators.map((op,i)=> e('option',{key:i, value:op}, op))
           )
         : e('input', { value:operatore, onChange:ev=>setOperatore(ev.target.value), placeholder:'Nome', style:{fontSize:18, marginBottom:12}}),
       
       e('label', null, 'Fase'),
       e('select', { value:faseIdx, onChange:ev=>setFaseIdx(ev.target.value), style:{fontSize:18}},
          e('option', {value:''}, '— seleziona —'),
          fasi.map((f,idx)=> e('option',{ key:idx, value:String(idx) }, (f && f.lav) ? String(f.lav) : ('Fase ' + (idx+1))))
       ),
       
       e('div', {className:'row', style:{gap:16, paddingTop:12, alignItems:'center'}},
          e('label', {className:'row', style:{gap:6}}, e('input', { type:'checkbox', checked:secondOp, onChange:ev=> setSecondOp(ev.target.checked && !thirdOp) }), 'x2'),
          e('label', {className:'row', style:{gap:6}}, e('input', { type:'checkbox', checked:thirdOp,  onChange:ev=> setThirdOp(ev.target.checked) }), 'x3'),
          e('label', {className:'row', style:{gap:6}}, e('input', { type:'checkbox', checked:gasChange, onChange:ev=> setGasChange(ev.target.checked) }), 'Gas')
       )
    ),

    // Pulsantone
    e('div', {className:'card', style:{textAlign:'center', padding:12}},
      e('div', {style:{fontSize:28, fontWeight:800, marginBottom:8}},
        active ? fmtHMS(Date.now() - new Date(active.startISO).getTime()) : '00:00:00'
      ),
      !active
        ? e('button', {className:'btn btn-lg', style:{width:'100%', background:'#16a34a'}, onClick:start}, '▶️ Inizio')
        : e('button', {className:'btn btn-lg', style:{width:'100%', background:'#dc2626'}, onClick:stop}, '⏹️ Fine')
    ),

    // Modale Qta
    askQty && e('div', {style:{position:'fixed', inset:0, background:'rgba(0,0,0,0.35)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:9999, padding:12}},
       e('div', {className:'card', style:{width:'100%', maxWidth:420, padding:16, background:'#fff'}},
          e('h4', {style:{margin:'0 0 6px 0', fontSize:18}}, 'Quantità lavorata'),
          e('div', {className:'muted', style:{marginBottom:12}}, 'Inserisci pezzi prodotti (o 0).'),
          e('input', {
             type:'number', autoFocus:true,
             value:qtyVal, onChange:ev=>setQtyVal(ev.target.value),
             style:{fontSize:24, textAlign:'center', width:'100%', padding:10, border:'1px solid #ccc', borderRadius:8}
          }),
          e('div', {className:'actions', style:{marginTop:20, justifyContent:'flex-end', gap:12}},
             e('button', {className:'btn btn-outline', onClick:cancelStop}, 'Annulla'),
             e('button', {className:'btn', onClick:confirmStop}, 'Conferma')
          )
       )
    ),

    // Scanner QR
    scanOpen && e('div', {style:{position:'fixed', inset:0, background:'rgba(0,0,0,0.8)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:9999, padding:12}},
       e('div', {className:'card', style:{width:'100%', maxWidth:520, padding:12, background:'#fff'}},
          e('h4', {style:{margin:'0 0 6px 0'}}, 'Scannerizza QR'),
          e('div', {id:'qr-reader', style:{width:'100%', minHeight:300, background:'#000'}}),
          e('div', {className:'actions', style:{justifyContent:'flex-end', marginTop:8}},
             e('button', {className:'btn btn-outline', onClick:()=> setScanOpen(false)}, 'Chiudi')
          )
       )
    )
  );
};


// === STUB + ROUTES REPAIR (idempotente, incolla in fondo) ==================
(function ensureRoutesAndStubs(){
  const e = React.createElement;

  // 1) Crea stubs se la view globale non esiste
  function defView(name, label){
    if (typeof window[name] !== 'function') {
      window[name] = function(){
        return e('div', {className:'page'}, `${label} — vista non ancora implementata`);
      };
    }
  }
  defView('DashboardView',        'Dashboard');
  defView('CommesseView',         'Commesse');
  defView('ClientiView',          'Clienti');
  defView('FornitoriView',        'Fornitori');
  defView('OreView',              'Ore');
  defView('MovimentiView',        'Movimenti');
  defView('ReportTempiView',      'Report tempi');
  defView('ReportMaterialiView',  'Report materiali');
  defView('PreventiviView',       'Preventivi');
  defView('TimbraturaMobileView', 'Timbratura'); // 👈 stub sempre disponibile

  // 2) Ripara/integra la mappa ROUTES: ogni entry deve essere una funzione
    const R = window.ROUTES = window.ROUTES || {};
  const map = {
    // --- nuove/aggiornate: puntano ai nomi REALI trovati nel file ---
    '#/dashboard':        window.DashboardView,
    '#/commesse':         window.CommesseView,
    '#/report-tempi':     window.ReportTempiView,
    '#/saturazione':      (window.SaturazioneRepartiView || window.SaturazioneView),
    '#/report-materiali': (window.ReportProdView || window.ReportMaterialiView),
    '#/clienti':          window.ClientiView,
    '#/fornitori':        window.FornitoriView,

    // 👇 qui la correzione
    '#/ore':              (window.RegistrazioniOreView || window.OreView),
    '#/movimenti':        (window.MagazzinoMovimentiView || window.MovimentiView),
    
    // Documenti & co.
    '#/preventivi':       (window.PreventiviView || window.PreventivoView),
    '#/ddt':              window.DDTView,
    '#/fatture':          window.FattureView,
    '#/ordini':           window.OrdiniFornitoriView,
    '#/ordini-ritardo':   window.OrdiniFornitoriRitardoView,
    '#/magazzino':        window.MagazzinoView,
    '#/report':           window.ReportView,
    '#/diagnostica':      window.DiagnosticaView,
    '#/impostazioni':     (window.SettingsView || window.ImpostazioniView),
    '#/login':            window.LoginView,

    // opzionale: se vuoi la rotta dedicata alla timbratura mobile
    '#/timbratura':       window.TimbraturaMobileView
  };
  Object.keys(map).forEach(h => { if (typeof map[h] === 'function') R[h] = map[h]; });


  
  // 3) NON sovrascrivere pickView se esiste già
  if (typeof window.pickView !== 'function') {
    window.pickView = function(){
      const raw = (location.hash || '#/dashboard').toLowerCase();
      let h = raw.split('?')[0]; // ignora ?job=...

      const R = window.ROUTES || {};

      // --- RBAC: filtro rotta anche se l'hash viene digitato a mano ---
      const USER = window.__USER || null;
      const role = (USER && USER.role) || 'admin';
      const lowerRole = String(role).toLowerCase();
      const isAdmin  = (lowerRole === 'admin');
      const isViewer = (lowerRole === 'viewer' || lowerRole === 'mobile');
      const isWorker = (lowerRole === 'worker');

      if (!isAdmin) {
        // 1) viewer/mobile → SOLO timbratura, commesse, DDT, login
        if (isViewer) {
          const allowed = new Set(['#/timbratura', '#/commesse', '#/ddt', '#/login']);
          if (!allowed.has(h)) {
            h = '#/timbratura';
            if (location.hash !== h) {
              try { location.replace(h); } catch {}
            }
          }
        }

        // 1-bis) worker → stesse route limitate del sidebar (timbratura, commesse, DDT, login)
        if (isWorker) {
          const allowedWorker = new Set(['#/timbratura', '#/commesse', '#/ddt', '#/login']);
          if (!allowedWorker.has(h)) {
            h = '#/timbratura';
            if (location.hash !== h) {
              try { location.replace(h); } catch {}
            }
          }
        }

        // 2) Qualunque non-admin che tenta #/impostazioni → blocco
        if (h === '#/impostazioni') {
          try {
            alert('Accesso a "Impostazioni" riservato solo agli amministratori.');
          } catch {}
          h = '#/timbratura';
          if (location.hash !== h) {
            try { location.replace(h); } catch {}
          }
        }
      }

      const Comp = R[h] || R['#/ddt'];
      return (typeof Comp === 'function')
        ? Comp
        : function(){ return e('div',{className:'page'}, 'Vista non definita: '+h); };
    };
  }

  // 4) Helper di navigazione per pulsanti/alias legacy
  window.openReport            = () => { location.hash = '#/report'; };
  window.openReportTempi       = () => { location.hash = '#/report-tempi'; };
  window.openReportMateriali   = () => { location.hash = '#/report-materiali'; };

  console.info('[routes ready]', Object.fromEntries(
    ['#/dashboard','#/commesse','#/clienti','#/fornitori','#/ore','#/movimenti',
     '#/report','#/report-tempi','#/report-materiali','#/ddt','#/fatture','#/ordini',
     '#/magazzino','#/impostazioni','#/login'
    ].map(h => [h, typeof (window.ROUTES?.[h]) ])
  ));

  // === HAMBURGER MOBILE (non invasivo) ===
(function mobileHamburger(){
  try{
    const MOBILE_W = 1024;
    if (window.innerWidth > MOBILE_W) return;
    if (document.getElementById('anima-hamburger')) return; // idempotente

    let rawRole = window.__USER && window.__USER.role;

    // Se non c'è utente loggato, di default consideralo worker su mobile
    // (menu limitato; se poi fai login come admin, role diventa 'admin' e vedi tutto)
    if (!rawRole) {
      rawRole = 'worker';
    }

    const role = String(rawRole).toLowerCase();
    let items;
    if (role === 'operator') {
      // Operatore puro → solo timbratura
      items = [ { label:'Timbratura', hash:'#/timbratura' } ];
    } else if (role === 'viewer' || role === 'mobile') {
      // Ruoli solo-consultazione: viste limitate
      items = [
        { label:'Timbratura', hash:'#/timbratura' },
        { label:'Commesse',   hash:'#/commesse' },
        { label:'DDT',        hash:'#/ddt' }
      ];
    } else {
      // Admin / worker / accountant → menù completo "amministrativo"
      items = [
        { label:'Dashboard',    hash:'#/dashboard' },
        { label:'Commesse',     hash:'#/commesse' },
        { label:'Clienti',      hash:'#/clienti' },
        { label:'Fornitori',    hash:'#/fornitori' },
        { label:'Ore',          hash:'#/ore' },
        { label:'Timbratura',   hash:'#/timbratura' },
        { label:'Report',       hash:'#/report' }
      ];
      // Solo admin vede "Impostazioni" nell’hamburger
      if (role === 'admin') {
        items.push({ label:'Impostazioni', hash:'#/impostazioni' });
      }
    }

    const btn = document.createElement('button');
    btn.id='anima-hamburger'; btn.className='mobile-only'; btn.type='button';
    btn.setAttribute('aria-label','Menu'); btn.textContent='☰';
    document.body.appendChild(btn);

    const nav = document.createElement('nav');
    nav.id='anima-drawer'; nav.className='mobile-only';
    const title = document.createElement('h3');
    title.textContent = (role==='operator') ? 'Operatore' : 'Amministrazione';
    nav.appendChild(title);

    items.forEach(it=>{
      const a = document.createElement('a');
      a.className = 'drawer-link';
      a.href = it.hash;
      a.textContent = it.label;

      a.addEventListener('click', function(ev){
        ev.preventDefault();
        try {
          // Navigazione diretta usando l'hash corretto
          location.hash = it.hash;
        } catch (e) {
          try {
            location.href = it.hash;
          } catch {}
        }
        nav.classList.remove('open');
      });

      nav.appendChild(a);
    });
    document.body.appendChild(nav);

    btn.addEventListener('click', ()=> nav.classList.toggle('open'));
    window.addEventListener('hashchange', ()=> nav.classList.remove('open'));
    window.addEventListener('resize', ()=>{
      if (window.innerWidth > MOBILE_W) { try{ btn.remove(); nav.remove(); }catch{} }
    });
    document.addEventListener('click', (ev)=>{
      if (!nav.classList.contains('open')) return;
      const t = ev.target;
      if (t===nav || t===btn) return;
      if (!nav.contains(t) && t!==btn) nav.classList.remove('open');
    });

    console.log('[mobile] hamburger attivo per ruolo:', role);
  }catch(e){ console.warn('mobileHamburger error', e); }
})();

})();

// ================== FATTURA ELETTRONICA (FPR12) — EXPORT XML (bootstrap globale) ==================
(function(){
  if (window.buildFatturaPAXml && window.exportFatturaPAXML) return;

  function xmlEsc(s){ 
    return String(s==null?'':s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&apos;');
  }
  function num2(n){ const x=Number(n||0); return isFinite(x)?x.toFixed(2):'0.00'; }
  function todayISO(){ try{ return new Date().toISOString().slice(0,10); }catch{ return '2025-01-01'; } }

  function getClienteById(id){
    try{
      const all = JSON.parse(localStorage.getItem('clientiRows')||'[]')||[];
      return all.find(c => String(c.id)===String(id)) || null;
    }catch{ return null; }
  }
  function riepilogoPerAliquota(righe){
    const map = new Map(); // chiave: `${aliq}__${natura}`
    (righe||[]).forEach(r=>{
      const qty = Number(r.qta||0);
      const pr  = Number(r.prezzo||0);
      const scp = Number(r.sconto||r.scontoPerc||0);
      const iva = Number(r.iva||0);
      const impon = qty*pr*(1-(scp/100));
      const nat = (iva===0 && r && typeof r.natura==='string' && r.natura.trim()) ? r.natura.trim() : '';
      const k = `${iva.toFixed(2)}__${nat}`;
      map.set(k, (map.get(k)||0) + impon);
    });
    return Array.from(map.entries()).map(([key, imponibile])=>{
      const [aliqStr, nat] = key.split('__');
     const aliquota = Number(aliqStr);
      const imposta = aliquota>0 ? (aliquota/100)*imponibile : 0;
      return { aliquota, natura:(aliquota===0?nat:''), imponibile, imposta };
    });
  }

// ===== Generazione XML FatturaPA (TD24 auto + REA + Indirizzi) =====
window.buildFatturaPAXml = function(fa){
  // Helpers
  const xmlEsc = s => String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
  const num2   = n => Number(n||0).toFixed(2);
  const clean  = s => String(s||'').replace(/\s+/g, '').toUpperCase(); 
  const isoDate= d => { try{ return new Date(d).toISOString().slice(0,10); }catch{ return ''; } };

  // Parsing indirizzo (Via X, CAP Città PROV)
  function parseAddress(fullAddr, defaultCap, defaultProv) {
    let addr = (fullAddr || '').trim();
    let cap = defaultCap || '00000';
    let prov = defaultProv || 'PD';
    let comune = '.';

    const capMatch = addr.match(/\b\d{5}\b/);
    if (capMatch) cap = capMatch[0];

    const provMatch = addr.match(/(\(|^|\s)([A-Z]{2})(\)|$|\s)/); 
    if (provMatch) prov = provMatch[2];

    // Tentativo estrazione comune dopo il CAP
    if (capMatch) {
      const parts = addr.split(cap);
      if (parts[1]) {
        let afterCap = parts[1].replace(prov, '').replace(/[()]/g,'').trim();
        if (afterCap.includes(',')) afterCap = afterCap.split(',')[0];
        if (afterCap.length > 2) comune = afterCap;
      }
    }
    return { indirizzo: addr, cap, comune, prov };
  }

  // 1. Dati App
  const app = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; }catch{return{}} })();
  
  // 2. Dati Cliente
  let clienti = [];
  try{ clienti = JSON.parse(localStorage.getItem('clientiRows')||'[]')||[]; }catch{}
  const cli = clienti.find(c => String(c.id)===String(fa.clienteId)) || { ragione: fa.cliente||'' };

  // Parsing Indirizzi
  const sedeAzi = parseAddress(app.sedeLegale || app.indirizzo, '35011', 'PD');
  const sedeCli = parseAddress(cli.sedeLegale || cli.indirizzo, '00000', 'XX');

  // Cedente
  const cedente = {
    denominazione : app.ragioneSociale || 'ANIMA SRL',
    piva          : clean(app.piva || ''),
    cf            : clean(app.cf || app.codiceFiscale || ''),
    regime        : app.regimeFiscale || 'RF01',
    sede          : {
      indirizzo : xmlEsc(sedeAzi.indirizzo),
      cap       : sedeAzi.cap,
      comune    : xmlEsc(sedeAzi.comune === '.' ? 'CAMPODARSEGO' : sedeAzi.comune),
      prov      : sedeAzi.prov,
      nazione   : 'IT'
    },
    // REA Obbligatorio per SRL
    rea: {
      ufficio : 'PD',
      numero  : (app.rea || '').replace(/\D/g,''),
      capitale: num2(parseFloat((app.capitaleSociale||'').replace(/[^0-9,.]/g,'').replace(',','.')) || 0),
      socio   : 'SU',
      stato   : 'LN'
    }
  };

  // Cessionario
  const cessionario = {
    denominazione : cli.ragione || cli.ragioneSociale || fa.cliente || 'CLIENTE',
    piva          : clean(cli.piva || ''),
    cf            : clean(cli.cf || cli.codiceFiscale || ''),
    indirizzo     : xmlEsc(sedeCli.indirizzo),
    cap           : sedeCli.cap,
    comune        : xmlEsc(sedeCli.comune),
    prov          : sedeCli.prov,
    nazione       : 'IT'
  };
  if (!cessionario.piva && !cessionario.cf) cessionario.cf = '00000000000'; 

  // Header Trasmissione
  const idTrasmittente = cedente.piva || cedente.cf;
  const progInvio      = (fa.id || '00001').replace(/[^a-zA-Z0-9]/g, '').slice(-5);
  const codDest        = (fa.codiceUnivoco || cli.codiceUnivoco || '0000000').trim();
  const pecDest        = (fa.pec || cli.pec || '').trim();

  // Logica TD24 (DDT collegati)
  const ddtSet = new Map();
  if (fa.ddtId) ddtSet.set(fa.ddtId, fa.ddtData);
  (fa.righe||[]).forEach(r => { if (r.ddtId) ddtSet.set(r.ddtId, r.ddtData); });
  
  // Se ci sono DDT è TD24, altrimenti TD01 (salvo override manuale)
  let tipoDocumentoAuto = (ddtSet.size > 0) ? 'TD24' : 'TD01';
  const tipoDocumentoFinal = fa.tipoDocumento || tipoDocumentoAuto;

  const numeroDoc = (fa.id || '1').replace(/\//g,'_');
  const dataDoc   = isoDate(fa.data || new Date());
  const importoBollo = fa.bolloVirtuale ? num2(fa.importoBollo || 2) : '0.00';

  // Blocchi DDT
  const blocchiDDT = Array.from(ddtSet.entries()).map(([id, data]) => `
    <DatiDDT>
      <NumeroDDT>${xmlEsc(id)}</NumeroDDT>
      <DataDDT>${xmlEsc(isoDate(data || dataDoc))}</DataDDT>
    </DatiDDT>`).join('\n');

  // Righe e Totali
  const righeNormalizzate = (fa.righe||[]).map(r => {
    const iva = Number(r.iva||0);
    return { ...r, iva, natura: (iva === 0) ? (r.natura || fa.naturaIva || 'N3.5') : '' };
  });

  // Funzione locale riepilogo
  const riepilogoPerAliquota = (rr) => {
    const map = new Map();
    rr.forEach(r=>{
      const qty = Number(r.qta||0), pr = Number(r.prezzo||0), sc = Number(r.sconto||r.scontoPerc||0);
      const imp = qty * pr * (1 - sc/100);
      const k = `${Number(r.iva).toFixed(2)}_${r.natura||''}`;
      map.set(k, (map.get(k)||0) + imp);
    });
    return Array.from(map.entries()).map(([k, imp]) => {
      const [aliq, nat] = k.split('_');
      return { aliquota: Number(aliq), natura: nat, imponibile: imp, imposta: imp * Number(aliq)/100 };
    });
  };
  
  const riepiloghi = riepilogoPerAliquota(righeNormalizzate);
  const totDoc = riepiloghi.reduce((acc, x) => acc + x.imponibile + x.imposta, 0) + Number(importoBollo);

  // XML TEMPLATE
  return `<?xml version="1.0" encoding="UTF-8"?>
<p:FatturaElettronica versione="FPR12" xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2">
  <FatturaElettronicaHeader>
    <DatiTrasmissione>
      <IdTrasmittente>
        <IdPaese>IT</IdPaese>
        <IdCodice>${idTrasmittente}</IdCodice>
      </IdTrasmittente>
      <ProgressivoInvio>${xmlEsc(progInvio)}</ProgressivoInvio>
      <FormatoTrasmissione>FPR12</FormatoTrasmissione>
      <CodiceDestinatario>${xmlEsc(codDest)}</CodiceDestinatario>
      ${(pecDest && codDest==='0000000') ? `<PECDestinatario>${xmlEsc(pecDest)}</PECDestinatario>` : ''}
    </DatiTrasmissione>
    <CedentePrestatore>
      <DatiAnagrafici>
        <IdFiscaleIVA>
          <IdPaese>IT</IdPaese>
          <IdCodice>${cedente.piva}</IdCodice>
        </IdFiscaleIVA>
        <CodiceFiscale>${cedente.cf}</CodiceFiscale>
        <Anagrafica><Denominazione>${xmlEsc(cedente.denominazione)}</Denominazione></Anagrafica>
        <RegimeFiscale>${cedente.regime}</RegimeFiscale>
        ${(cedente.rea.numero) ? `
        <IscrizioneREA>
          <Ufficio>${cedente.rea.ufficio}</Ufficio>
          <NumeroREA>${cedente.rea.numero}</NumeroREA>
          <CapitaleSociale>${cedente.rea.capitale}</CapitaleSociale>
          <SocioUnico>${cedente.rea.socio}</SocioUnico>
          <StatoLiquidazione>${cedente.rea.stato}</StatoLiquidazione>
        </IscrizioneREA>` : ''}
      </DatiAnagrafici>
      <Sede>
        <Indirizzo>${xmlEsc(cedente.sede.indirizzo)}</Indirizzo>
        <CAP>${cedente.sede.cap}</CAP>
        <Comune>${xmlEsc(cedente.sede.comune)}</Comune>
        <Provincia>${cedente.sede.prov}</Provincia>
        <Nazione>${cedente.sede.nazione}</Nazione>
      </Sede>
    </CedentePrestatore>
    <CessionarioCommittente>
      <DatiAnagrafici>
        ${cessionario.piva ? `<IdFiscaleIVA><IdPaese>IT</IdPaese><IdCodice>${cessionario.piva}</IdCodice></IdFiscaleIVA>` : ''}
        ${cessionario.cf ? `<CodiceFiscale>${cessionario.cf}</CodiceFiscale>` : ''}
        <Anagrafica><Denominazione>${xmlEsc(cessionario.denominazione)}</Denominazione></Anagrafica>
      </DatiAnagrafici>
      <Sede>
        <Indirizzo>${xmlEsc(cessionario.indirizzo)}</Indirizzo>
        <CAP>${cessionario.cap}</CAP>
        <Comune>${xmlEsc(cessionario.comune)}</Comune>
        <Provincia>${cessionario.prov}</Provincia>
        <Nazione>${cessionario.nazione}</Nazione>
      </Sede>
    </CessionarioCommittente>
  </FatturaElettronicaHeader>
  <FatturaElettronicaBody>
    <DatiGenerali>
      <DatiGeneraliDocumento>
        <TipoDocumento>${tipoDocumentoFinal}</TipoDocumento>
        <Divisa>EUR</Divisa>
        <Data>${dataDoc}</Data>
        <Numero>${xmlEsc(numeroDoc)}</Numero>
        ${fa.bolloVirtuale ? `<DatiBollo><BolloVirtuale>SI</BolloVirtuale><ImportoBollo>${importoBollo}</ImportoBollo></DatiBollo>` : ''}
        ${fa.causale ? `<Causale>${xmlEsc(fa.causale)}</Causale>` : ''}
      </DatiGeneraliDocumento>
      ${blocchiDDT}
    </DatiGenerali>
    <DatiBeniServizi>
      ${righeNormalizzate.map((r, i) => `
      <DettaglioLinee>
        <NumeroLinea>${i + 1}</NumeroLinea>
        <Descrizione>${xmlEsc(r.descrizione)}</Descrizione>
        <Quantita>${num2(r.qta)}</Quantita>
        <PrezzoUnitario>${num2(r.prezzo)}</PrezzoUnitario>
        <PrezzoTotale>${num2(r.qta * r.prezzo * (1 - (r.sconto||0)/100))}</PrezzoTotale>
        <AliquotaIVA>${num2(r.iva)}</AliquotaIVA>
        ${r.natura ? `<Natura>${r.natura}</Natura>` : ''}
      </DettaglioLinee>`).join('')}
      ${riepiloghi.map(r => `
      <DatiRiepilogo>
        <AliquotaIVA>${num2(r.aliquota)}</AliquotaIVA>
        ${r.natura ? `<Natura>${r.natura}</Natura>` : ''}
        <ImponibileImporto>${num2(r.imponibile)}</ImponibileImporto>
        <Imposta>${num2(r.imposta)}</Imposta>
        <EsigibilitaIVA>I</EsigibilitaIVA>
        ${(r.natura && fa.rifNormativo) ? `<RiferimentoNormativo>${xmlEsc(fa.rifNormativo)}</RiferimentoNormativo>` : ''}
      </DatiRiepilogo>`).join('')}
    </DatiBeniServizi>
    <DatiPagamento>
      <CondizioniPagamento>TP02</CondizioniPagamento>
      <DettaglioPagamento>
        <ModalitaPagamento>MP05</ModalitaPagamento>
        <DataScadenzaPagamento>${dataDoc}</DataScadenzaPagamento>
        <ImportoPagamento>${num2(totDoc)}</ImportoPagamento>
        ${app.iban ? `<IBAN>${clean(app.iban)}</IBAN>` : ''}
      </DettaglioPagamento>
    </DatiPagamento>
  </FatturaElettronicaBody>
</p:FatturaElettronica>`;
};

// ===== EXPORT: Crea e Scarica il file XML =====
window.exportFatturaPAXML = function(fa){
  try {
    // 1. Genera il contenuto XML usando la funzione "Intelligente"
    const xmlContent = window.buildFatturaPAXml(fa);
    
    if (!xmlContent) throw new Error("XML vuoto generato.");

    // 2. Calcola il nome del file secondo standard SDI: IT + PIVA + _ + ID.xml
    // (Es: IT05463690288_FA_2025_001.xml)
    const app = JSON.parse(localStorage.getItem('appSettings')||'{}') || {};
    const piva = String(app.piva || app.pIva || '00000000000').replace(/[^0-9]/g,'');
    const docId = String(fa.id || 'doc').replace(/[^a-zA-Z0-9]/g, '_'); // Sostituisce / con _
    
    const fileName = `IT${piva}_${docId}.xml`;

    // 3. Crea il blob e simula il click per il download
    const blob = new Blob([xmlContent], { type: 'application/xml' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link); // Necessario per Firefox
    link.click();
    document.body.removeChild(link);
    
  } catch(e) {
    alert('Errore generazione file XML: ' + e.message);
    console.error(e);
  }
};

})();

// ===== Pre-check FatturaPA (campi minimi) - VERSIONE PERMISSIVA =====
window.canExportFatturaPA = function(fa){
  const reasons = [];
  try{
    const app = JSON.parse(localStorage.getItem('appSettings')||'{}')||{};
    const clienti = JSON.parse(localStorage.getItem('clientiRows')||'[]')||[];
    const cli = clienti.find(c => String(c.id)===String(fa.clienteId)) || {};

    const denAzi = (app.ragioneSociale || app.ragione || '').trim();
    const pivaAzi = String(app.piva || app.pIva || '').replace(/\s/g,'');
    const cfAzi = String(app.cf || app.codiceFiscale || '').trim();
    const sedeAzi = (app.sedeLegale || (app.azienda&&app.azienda.sedeLegale) || '').trim();

    const denCli = (cli.ragione || cli.denominazione || fa.cliente || '').trim();
    const pivaCli = String(cli.piva||'').replace(/\s/g,'');
    const cfCli = String(cli.cf || cli.codiceFiscale || '').trim();
    const sedeCli = (cli.sedeLegale || cli.sedeOperativa || '').trim();

    // Anagrafica azienda
    if (!denAzi) reasons.push('Azienda: Denominazione mancante');
    if (!(pivaAzi || cfAzi)) reasons.push('Azienda: P.IVA o CF mancanti');
    if (!sedeAzi) reasons.push('Azienda: Sede legale mancante');

    // Anagrafica cliente
    if (!denCli) reasons.push('Cliente: Denominazione mancante');
    // Rilassato: basta che ci sia un riferimento cliente, anche se incompleto avvisiamo ma non blocchiamo se c'è almeno il nome
    if (!(pivaCli || cfCli)) reasons.push('Cliente: P.IVA o CF mancanti');
    if (!sedeCli) reasons.push('Cliente: Indirizzo sede mancante');

    // Righe
    const righe = Array.isArray(fa.righe)? fa.righe : [];
    if (!righe.length) reasons.push('Righe: nessuna riga presente');

    righe.forEach((r,idx)=>{
      const okDesc = (r.descrizione||'').trim().length>0 || (r.codice||'').trim().length>0;
      // Permettiamo righe con qta 0 (es. righe di nota)
      if (!okDesc) {
        reasons.push(`Riga ${idx+1}: descrizione mancante`);
      }
    });

    // RIMOSSO IL BLOCCO SUL RIFERIMENTO NORMATIVO
    // L'XML verrà generato comunque, se manca il dato l'SDI darà errore ma intanto il file esce.

  }catch(e){
    reasons.push('Errore verifica preliminare: ' + e.message);
  }
  return { ok: reasons.length===0, reasons };
};

// ===== BACKUP/RESTORE JSON =====
(function(){
  if (window.__anima_backup_booted__) return; window.__anima_backup_booted__=true;
    const pick = k => {
    try {
      const raw = localStorage.getItem(k);
      if (!raw) return k.endsWith('Rows') ? [] : {};
      return JSON.parse(raw);
    } catch {
      return k.endsWith('Rows') ? [] : {};
    }
  };

    const KEYS = [
    'appSettings',
    'clientiRows','fornitoriRows',
    'magArticoli','magMovimenti',
    'commesseRows','oreRows',
    'ddtRows','fattureRows',
    'ordiniFornitoriRows',
    'allegatiRows',
    'counters'
  ];

  function download(name, text, mime='application/json'){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
    a.click(); URL.revokeObjectURL(a.href);
  }

  function ensureArray(x){ return Array.isArray(x) ? x : []; }
  function ensureObject(x){ return (x && typeof x==='object' && !Array.isArray(x)) ? x : {}; }

  // Collisions: se id uguale e già presente, prova a rigenerare id con nextProgressivo dove noto.
  function mergeArrayById(dst, src, series){
    const out = [...ensureArray(dst)];
    const seen = new Set(out.map(r=>String(r.id||'__')));
    (ensureArray(src)).forEach(r=>{
      let item = {...r};
      let id = (item.id!=null) ? String(item.id) : '';
      if (!id || seen.has(id)){
        if (series === 'C') { // commesse
          try { id = window.nextProgressivo ? window.nextProgressivo('C') : (Date.now()+''); } catch { id = (Date.now()+''); }
          item.id = id;
        } else {
          id = id ? (id + '-' + Math.floor(Math.random()*1000)) : (Date.now()+'');
          item.id = id;
        }
      }
      seen.add(String(item.id));
      out.push(item);
    });
    return out;
  }

  window.exportBackupJSON = function(){
    const dump = { __meta:{ ts:new Date().toISOString(), ver:1 } };
    KEYS.forEach(k => dump[k] = pick(k) || (k.endsWith('Rows')?[]:{}));
    download(`ANIMA-backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(dump,null,2));
  };

  window.importBackupJSON = function(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ev => {
      const f = ev?.target?.files?.[0]; if(!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try{
          const data = JSON.parse(String(rd.result||'{}'));
          // Merge non distruttivo
          const cur = (k, def)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } };
          const set = (k, v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; }catch{} };

          // AppSettings: merge shallow
          set('appSettings', { ...ensureObject(cur('appSettings',{})), ...ensureObject(data.appSettings||{}) });

          // Progressivi: prendi il max per serie/anno
          (function(){
            const curC = ensureObject(cur('counters', {}));
            const impC = ensureObject(data.counters || {});
            const Y = new Date().getFullYear();

            function maxRec(a, b){
              // se anno diversi, preferisci quello dell’anno corrente; altrimenti max(num)
              if (!a) return b;
              if (!b) return a;
              if (a.year !== b.year) return (b.year === Y) ? b : a;
              return { year: a.year, num: Math.max(Number(a.num||0), Number(b.num||0)) };
            }

            const out = { ...curC };
            Object.keys(impC).forEach(k => {
              out[k] = maxRec(curC[k], impC[k]);
            });

            set('counters', out);
          })();

          // Tabelle array
          set('clientiRows',           mergeArrayById(cur('clientiRows',[]),           data.clientiRows,           null));
          set('fornitoriRows',         mergeArrayById(cur('fornitoriRows',[]),         data.fornitoriRows,         null));
          set('magArticoli',           mergeArrayById(cur('magArticoli',[]),           data.magArticoli,           null));
          set('magMovimenti',          mergeArrayById(cur('magMovimenti',[]),          data.magMovimenti,          null));
          set('commesseRows',          mergeArrayById(cur('commesseRows',[]),          data.commesseRows,          'C')); // usa nextProgressivo('C')
          set('oreRows',               mergeArrayById(cur('oreRows',[]),               data.oreRows,               null));
          set('ddtRows',               mergeArrayById(cur('ddtRows',[]),               data.ddtRows,               null));
          set('fattureRows',           mergeArrayById(cur('fattureRows',[]),           data.fattureRows,           null));
          set('ordiniFornitoriRows',   mergeArrayById(cur('ordiniFornitoriRows',[]),   data.ordiniFornitoriRows,   null));
          set('allegatiRows',          mergeArrayById(cur('allegatiRows',[]),          data.allegatiRows,          null));

          alert('Import eseguito. Ricarica la pagina per vedere tutti i dati.');
        }catch(e){ alert('File non valido: ' + (e?.message||e)); }
      };
      rd.readAsText(f);
    };
    inp.click();
  };
})();

// ===== Backup/Ripristino SMART (usa lsGet/lsSet e ignora formati strani) =====
(function(){
const BK_KEYS = [
    'appSettings',
    'clientiRows','fornitoriRows',
    'magArticoli','magMovimenti',
    'commesseRows','oreRows',
    'ddtRows','fattureRows',
    'preventiviRows',
    'ordiniFornitoriRows',
    'allegatiRows',
    'counters'
  ];

  function bkEnsureArray(x){ return Array.isArray(x) ? x : []; }
  function bkEnsureObject(x){
    return (x && typeof x === 'object' && !Array.isArray(x)) ? x : {};
  }

  // Esporta SOLO le chiavi note, usando lsGet (quindi BETA/PROD rispettato)
  window.exportBackupSmart = window.exportBackupSmart || function(){
    try{
      const pick = (k)=>{
        if (typeof window.lsGet === 'function'){
          const def = k.endsWith('Rows') ? [] : {};
          const v = window.lsGet(k, def);
          return v == null ? def : v;
        }
        try{
          const raw = localStorage.getItem(k);
          return raw ? JSON.parse(raw) : (k.endsWith('Rows') ? [] : {});
        }catch{
          return k.endsWith('Rows') ? [] : {};
        }
      };

      const dump = { __meta:{ ts:new Date().toISOString(), ver:1 } };
      BK_KEYS.forEach(k => { dump[k] = pick(k); });

      const blob  = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
      const a     = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href      = URL.createObjectURL(blob);
      a.download  = `ANIMA-backup-${stamp}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }catch(e){
      alert('Backup non riuscito: ' + (e && e.message || e));
    }
  };

  // Importa da file .json senza copiare tutta la localStorage a caso
  window.importBackupSmartFromFile = window.importBackupSmartFromFile || async function(file){
    if (!file) return;

    let payload;
    try{
      const txt = await file.text();
      payload = JSON.parse(String(txt || '{}'));
    }catch(e){
      alert('Backup non valido (JSON illeggibile)');
      return;
    }

    // Supporta sia formato vecchio { version, ts, data:{...} } che nuovo { appSettings, clientiRows, ... }
    const root = (payload && typeof payload === 'object' && payload.data && typeof payload.data === 'object')
      ? payload.data
      : (payload || {});

    const curGet = (k, def)=>{
      if (typeof window.lsGet === 'function') return window.lsGet(k, def);
      try{
        const raw = localStorage.getItem(k);
        return raw ? JSON.parse(raw) : def;
      }catch{
        return def;
      }
    };
    const curSet = (k, v)=>{
      if (typeof window.lsSet === 'function') return window.lsSet(k, v);
      try{
        localStorage.setItem(k, JSON.stringify(v));
        window.__anima_dirty = true;
      }catch{}
    };

    // 1) appSettings: merge shallow SOLO se il backup contiene un oggetto sensato
    try{
      const curApp = bkEnsureObject(curGet('appSettings', {}));
      const impApp = bkEnsureObject(root.appSettings || payload.appSettings || {});
      const merged = { ...curApp, ...impApp };
      curSet('appSettings', merged);
    }catch{}

    // 2) Tabelle array: rimpiazza completamente (backup pensato per "caricare un ambiente")
    const ARR_KEYS = [
      'clientiRows','fornitoriRows',
      'magArticoli','magMovimenti',
      'commesseRows','oreRows',
      'ddtRows','fattureRows',
      'ordiniFornitoriRows'
    ];
    ARR_KEYS.forEach(k=>{
      const src = root[k] || payload[k];
      if (Array.isArray(src)){
        curSet(k, bkEnsureArray(src));
      }
    });

    // 3) Counters: merge shallow
    try{
      const curC = bkEnsureObject(curGet('counters', {}));
      const impC = bkEnsureObject(root.counters || payload.counters || {});
      const mergedC = { ...curC, ...impC };
      curSet('counters', mergedC);
    }catch{}

    alert('Ripristino completato. La pagina verrà ricaricata.');
    try{ location.reload(); }catch{}
  };
})();

// ===== Alias Backup/Ripristino per pulsanti Impostazioni =====
(function(){
  // Alias "Scarica backup" → usa exportBackupJSON
  if (!window.downloadBackup) {
    window.downloadBackup = function(){
      if (window.exportBackupJSON) return window.exportBackupJSON();
      // fallback minimale: scarica tutto LS (se exportBackupJSON non c'è)
      try{
        const dump = {}; for (let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); dump[k] = JSON.parse(localStorage.getItem(k)||'null'); }
        const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ANIMA-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
      }catch(e){ alert('Backup non riuscito: ' + (e?.message||e)); }
    };
  }

  // Alias "Ripristina da file" → legge il file e applica il MERGE (stessa logica di importBackupJSON)
  if (!window.restoreFromFile) {
    window.restoreFromFile = async function(file){
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const cur = (k, def)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } };
        const set = (k, v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty = true; }catch{} };
        const ensureArray = x => Array.isArray(x)?x:[];
        const ensureObject= x => (x && typeof x==='object' && !Array.isArray(x))?x:{};

        function mergeArrayById(dst, src, series){
          const out = [...ensureArray(dst)];
          const seen = new Set(out.map(r=>String(r.id||'__')));
          ensureArray(src).forEach(r=>{
            let item = {...r};
            let id = (item.id!=null) ? String(item.id) : '';
            if (!id || seen.has(id)){
              if (series==='C' && window.nextProgressivo) { id = window.nextProgressivo('C'); item.id=id; }
              else { id = id ? (id + '-' + Math.floor(Math.random()*1000)) : (Date.now()+''+Math.floor(Math.random()*1000)); item.id=id; }
            }
            seen.add(String(item.id));
            out.push(item);
          });
          return out;
        }

        // Merge non distruttivo
        set('appSettings', { ...ensureObject(cur('appSettings',{})), ...ensureObject(data.appSettings||{}) });
        set('clientiRows',         mergeArrayById(cur('clientiRows',[]),         data.clientiRows,         null));
        set('fornitoriRows',       mergeArrayById(cur('fornitoriRows',[]),       data.fornitoriRows,       null));
        set('magArticoli',         mergeArrayById(cur('magArticoli',[]),         data.magArticoli,         null));
        set('magMovimenti',        mergeArrayById(cur('magMovimenti',[]),        data.magMovimenti,        null));
        set('commesseRows',        mergeArrayById(cur('commesseRows',[]),        data.commesseRows,        'C'));
        set('oreRows',             mergeArrayById(cur('oreRows',[]),             data.oreRows,             null));
        set('ddtRows',             mergeArrayById(cur('ddtRows',[]),             data.ddtRows,             null));
        set('fattureRows',         mergeArrayById(cur('fattureRows',[]),         data.fattureRows,         null));
        set('ordiniFornitoriRows', mergeArrayById(cur('ordiniFornitoriRows',[]), data.ordiniFornitoriRows, null));

        alert('Ripristino completato ✅\nRicarica la pagina (Ctrl+F5).');
      }catch(e){ alert('File non valido: ' + (e?.message||e)); }
    };
  }
})();

// ===== Ricezione Ordine Fornitore → Magazzino (blocchi ben chiusi) =====
(function(){
  async function riceviRigaOF(of, rigaIndex){
    try{
      const righe = Array.isArray(of?.righe)? of.righe : [];
      const r = righe[rigaIndex]; if (!r) return;
      const q = Number(r.qta||0), qr = Number(r.qtaRicevuta||0);
      const res = Math.max(0, q-qr);
      if (res <= 0){ alert('Nessun residuo su questa riga.'); return; }

      // Aggiorna ricevuto (qui NON movimentiamo il magazzino: solo ricezione OF)
      r.qtaRicevuta = Number(qr + res);
      // persist
      try{
        const all = JSON.parse(localStorage.getItem('ordiniFornitoriRows')||'[]')||[];
        const idx = all.findIndex(x => String(x.id)===String(of.id));
        if (idx>=0){ all[idx] = of; localStorage.setItem('ordiniFornitoriRows', JSON.stringify(all)); }
      }catch{}
      alert(`Ricevuta riga ${rigaIndex+1} — residuo ${res} pezzi.`);
    }catch(e){
      alert('Errore ricezione riga: '+(e?.message||e));
    }
  }

  // Modale minimale: scegli riga e ricevi
  window.openRicezioneOF = function(of){
    try{
      const righe = Array.isArray(of?.righe)? of.righe : [];
      if (!righe.length) { alert('Nessuna riga nell’ordine.'); return; }
      const elenco = righe.map((r,i)=>{
        const q = Number(r.qta||0), qr=Number(r.qtaRicevuta||0), res=Math.max(0,q-qr);
        return `${i+1}) ${r.codice||'-'} — ${(r.descrizione||'').slice(0,50)} (residuo: ${res})`;
      }).join('\n');
      const ans = prompt(`Seleziona riga da ricevere (1..${righe.length})\n\n${elenco}`, '1');
      if (!ans) return;
      const idx = Number(ans)-1;
      if (!Number.isFinite(idx) || idx<0 || idx>=righe.length) { alert('Indice non valido'); return; }
      return riceviRigaOF(of, idx);
    }catch(e){
      alert('Errore apertura ricezione: '+(e?.message||e));
    }
  };

  // Ricevi tutte le righe con residuo
  window.receiveAllOF = async function(of){
    try{
      const righe = Array.isArray(of?.righe)? of.righe : [];
      for (let i=0;i<righe.length;i++){
        const q = Number(righe[i].qta||0), qr=Number(righe[i].qtaRicevuta||0), res=Math.max(0,q-qr);
        if (res>0) { await riceviRigaOF(of, i); }
      }
    }catch(e){
      alert('Errore ricezione TUTTE le righe: '+(e?.message||e));
    }
  };
})();

// ===== Soft warning Clienti (intercetta lsSet su 'clientiRows') =====
(function(){
  if (window.__lsSet_clientiWarnWrapped__) return;
  window.__lsSet_clientiWarnWrapped__ = true;

  const origLsSet = window.lsSet || function(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); window.__anima_dirty=true; }catch{} };
  window.lsSet = function(k, v){
    // warning soft solo quando salvi l'elenco clienti
    if (k === 'clientiRows') {
      try{
        const arr = Array.isArray(v) ? v : [];
        // segnala se esistono record incompleti (denominazione / piva+cf / sede)
        const bad = arr.filter(c=>{
          const den  = String(c.ragione||c.denominazione||'').trim();
          const piva = String(c.piva||'').replace(/\s/g,'');
          const cf   = String(c.cf||c.codiceFiscale||'').trim();
          const sede = String(c.sedeLegale||c.sedeOperativa||'').trim();
          return !(den && (piva||cf) && sede);
        });
        if (bad.length) {
          (window.toast||alert)(
            `Attenzione: ${bad.length} cliente/i hanno dati incompleti.\n` +
            '• Denominazione\n• P.IVA o CF\n• Sede (legale/operativa)\n' +
            'L’XML SdI sarà bloccato per questi clienti finché non completi i dati.'
          );
        }
      }catch{}
    }
    return origLsSet(k, v);
  };
})();

// ===== PRINT THEME (unico, idempotente) =====
(function(){
  if (window.__print_theme__) return; window.__print_theme__ = true;

  function esc(s){ return String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // CSS condiviso per tutti i documenti
  window.getPrintTheme = function(opts={}){
    const ACCENT = opts.accent || '#0f172a';
    const TOTBG  = opts.totBg  || '#0f172a';
    const showHeaderLine = (opts.headerLine ?? true);
    return `
<style>
@page { size: A4; margin: 10mm 8mm; }
*{-webkit-print-color-adjust:exact; print-color-adjust:exact}
html,body{margin:0;padding:0}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;font-size:12px}

/* Header */
.hdr{display:flex;justify-content:space-between;align-items:center;gap:14px; ${showHeaderLine?'border-bottom:2px solid '+ACCENT+';':''} padding-bottom:8px; margin-bottom:10px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:60px;object-fit:contain}
.az .rs{font-size:18px;font-weight:800;letter-spacing:.2px}
.az .muted{color:#64748b}
.doc{border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; min-width:210px; text-align:right}
.doc .title{font-weight:800; font-size:12px; letter-spacing:.3px}
.doc .num{font-weight:800; font-size:14px}
.doc .row{margin-top:2px}

/* Tabelle */
table{width:100%; border-collapse:collapse; margin-top:6px}
thead{display:table-header-group}
th,td{border:1px solid #e5e7eb; padding:7px 8px; vertical-align:top}
th{background:#f8fafc; font-weight:700}
.ctr{text-align:center}
.num{text-align:right}
.no-break{page-break-inside:avoid}

/* Footer + totale (coerente) */
.content{margin-bottom:70mm}
.footer{position:fixed; left:8mm; right:8mm; bottom:5mm; display:flex; justify-content:space-between; align-items:flex-end; gap:12px}
.sign{min-width:280px; padding:8px 2px}
.sign .lab{color:#64748b; font-size:12px}
.sign .line{height:26px; border-bottom:1px solid #cbd5e1}
.sign .name{margin-top:6px; font-weight:600}
.tot{min-width:260px; background:${TOTBG}; color:#fff; border-radius:12px; padding:12px 14px; display:flex; justify-content:space-between; align-items:center}
.tot .lab{font-weight:700}
.tot .val{font-weight:900; font-size:16px}

/* Numerazione pagine (single source) */
.pagebox{position:fixed; right:8mm; bottom:8mm; font-size:12px}
.pageNum[data-mode="css"]::after{content: counter(page) " / " counter(pages)}

/* Video: bordi “puliti” */
@media screen{ th,td{border-color:transparent} }
@media print{ th,td{border:1px solid #e5e7eb} }
</style>`;
  };

  // Header brand standard (logo + azienda + box documento)
  window.printBrandHeader = function(app, { title, docId, docDate, logo }){
    const rag   = esc(app.ragioneSociale || app.ragione || app.aziendaNome || '');
    const piva  = esc(app.piva || app.partitaIva || '');
    const sedeL = esc(app.sedeLegale || '');
    const sedeO = esc(app.sedeOperativa || '');
    const tel   = esc(app.telefono || app.phone || '');
    const email = esc(app.email || '');
    const pec   = esc(app.pec || '');
    const logoUrl = logo || app.logoDataUrl || app.logoUrl || app.logo || '';

    return `
<div class="hdr">
  <div class="brand">
    ${logoUrl ? `<img src="${logoUrl}" alt="">` : ``}
    <div class="az">
      <div class="rs">${rag}</div>
      ${sedeL ? `<div class="muted">Sede legale: ${sedeL}</div>` : ``}
      ${sedeO ? `<div class="muted">Sede operativa: ${sedeO}</div>` : ``}
      ${piva  ? `<div class="muted">P.IVA: ${piva}</div>` : ``}
      ${tel   ? `<div class="muted">Tel: ${tel}</div>` : ``}
      ${email ? `<div class="muted">Email: ${email}</div>` : ``}
      ${pec   ? `<div class="muted">PEC: ${pec}</div>` : ``}
    </div>
  </div>
  <div class="doc">
    <div class="title">${esc(title||'DOCUMENTO')}</div>
    <div class="num">${esc(docId||'')}</div>
    <div class="row">Data: <strong>${esc(docDate||'')}</strong></div>
  </div>
</div>`;
  };
})();

window.navigateTo = window.navigateTo || function(name){
  const map = {
    'Impostazioni':'#/impostazioni',
    'Timbratura':'#/timbratura',
    'Commesse':'#/commesse',
    'DDT':'#/ddt'
  };
  const h = map[name] || '#/ddt';
  location.hash = h;
};

/* ================== GUARDRAIL: CONTROLLO DB VUOTO VS CLOUD PIENO ================== */
(function guardrailEmptyDB(){
  // Esegui solo se la pagina è appena caricata
  if (window.__ANIMA_GUARDRAIL_RUN) return;
  window.__ANIMA_GUARDRAIL_RUN = true;

  window.addEventListener('load', async () => {
    // 1. Controllo se siamo "vuoti" in locale
    const commesse = (function(){ try{ return JSON.parse(localStorage.getItem('commesseRows')||'[]'); }catch{return [];} })();
    
    // Se ho già dati, tutto ok, non disturbo
    if (commesse.length > 0) return;

    // 2. Controllo se il cloud è configurato
    const s = (function(){ try{ return JSON.parse(localStorage.getItem('appSettings')||'{}'); }catch{return {};} })();
    if (!s.cloudEnabled || !s.supabaseUrl || !s.supabaseKey) return;

    console.log('[Guardrail] Locale vuoto, controllo il cloud...');

    // 3. Chiedo al cloud se ha dati (basta 1 riga per far scattare l'allarme)
    try {
      const url = s.supabaseUrl.replace(/\/+$/,'');
      const table = s.supabaseTable || 'anima_sync';
      // Cerco solo se esiste almeno una riga nel bucket 'local'
      const endpoint = `${url}/rest/v1/${encodeURIComponent(table)}?select=k&bucket=eq.local&limit=1`;
      
      const res = await fetch(endpoint, {
        method: 'GET',
        headers: {
          'apikey': s.supabaseKey,
          'Authorization': 'Bearer ' + s.supabaseKey
        }
      });

      if (!res.ok) return; // Errore connessione, lasciamo perdere
      const data = await res.json();

      // 4. SE il cloud ha dati (array non vuoto) E io sono vuoto -> ALLARME
      if (Array.isArray(data) && data.length > 0) {
        // Usa un piccolo timeout per essere sicuro che l'interfaccia sia pronta
        setTimeout(() => {
          const msg = 
            "⚠️ ATTENZIONE: DATABASE LOCALE VUOTO ⚠️\n\n" +
            "Sembra che questo dispositivo non abbia dati, ma nel Cloud sono presenti dei salvataggi.\n\n" +
            "Vuoi SCARICARE I DATI dal Cloud ora per evitare di creare conflitti?\n" +
            "(Consigliato: OK)";
          
          if (confirm(msg)) {
            if (window.syncImportFromCloud) {
              window.syncImportFromCloud();
            } else {
              alert("Funzione import non trovata. Vai in Impostazioni -> Cloud -> Importa.");
            }
          }
        }, 1000);
      } else {
        console.log('[Guardrail] Anche il cloud sembra vuoto (o tabella nuova).');
      }

    } catch (err) {
      console.warn('[Guardrail] check fallito:', err);
    }
  });
})();

/* ================== SMART UPLOAD ENGINE (Teletrasporto su Z:) ================== */
(function(){
  // Variabile globale per mantenere la connessione aperta finché non chiudi la pagina
  window.__Z_HANDLE = null;

    // Stato diagnostica sempre presente (evita "undefined" in console)
  if (typeof window.__Z_LAST_ERR === 'undefined') window.__Z_LAST_ERR = '';

  // 1. Connette il disco Z: (lo chiede solo la prima volta)
window.ensureZConnection = async function(opts){
    if (window.__Z_HANDLE) return window.__Z_HANDLE;

    const o = (opts && typeof opts === 'object') ? opts : {};
    const interactive = (typeof o.interactive === 'boolean') ? o.interactive : true;

    // reset dettaglio errore (per debug)
    try{ window.__Z_LAST_ERR = ''; }catch{}

    if (!window.showDirectoryPicker) {
      try{ window.__Z_LAST_ERR = 'showDirectoryPicker non disponibile (browser non compatibile)'; }catch{}
      return null;
    }
        // Se chiamato da flussi non "click-diretti" (es. onChange file input),
    // NON tentare mai il picker: il browser lo blocca con SecurityError.
    if (!interactive) {
      try{
        window.__Z_LAST_ERR = window.__Z_LAST_ERR || 'Z: non connesso. Clicca "🔗 Connetti cartella ANIMA_DOC (Z:)" e seleziona la cartella, poi riprova.';
      }catch{}
      return null;
    }
    try {
      // IMPORTANTISSIMO: niente alert/confirm PRIMA del picker (può far fallire la user-activation)
      const handle = await window.showDirectoryPicker({
       
        id: 'anima_doc_root',
        mode: 'readwrite',
        startIn: 'documents'
      });

      // Guard-rail: la root selezionata deve essere coerente con docBasePath (Impostazioni).
      // Evita di connettere per errore una sottocartella (es. "2025") o una root diversa.
      try{
        const settings = window.lsGet ? window.lsGet('appSettings', {}) : {};
        const basePath = String(settings.docBasePath || 'Z:\\ANIMA_DOC').replace(/[\\/]+$/, '');
        const expectedName = basePath.split(/[\\/]+/).pop(); // ultimo pezzo (es. ANIMA_DOC)
        const pickedName = String(handle && handle.name ? handle.name : '');

        if (expectedName && pickedName && expectedName.toUpperCase() !== pickedName.toUpperCase()) {
          window.__Z_LAST_ERR =
            `Hai selezionato "${pickedName}" ma in Impostazioni il percorso base è "${basePath}". ` +
            `Se vuoi usare "${pickedName}", prima cambia docBasePath nelle Impostazioni; altrimenti seleziona la cartella "${expectedName}".`;
          return null;
        }
      }catch(e){
        try{ window.__Z_LAST_ERR = 'Errore validazione cartella: ' + (e && e.message ? e.message : String(e)); }catch{}
      }

      // Permesso esplicito (se supportato)
      try{
        if (handle && handle.requestPermission) {
          const perm = await handle.requestPermission({ mode: 'readwrite' });
          if (perm !== 'granted') {
            window.__Z_LAST_ERR = 'Permesso non concesso (requestPermission)';
            return null;
          }
        }
      }catch(e){
        try{
          window.__Z_LAST_ERR = (e && (e.name || e.message))
            ? `${e.name||''} ${e.message||''}`.trim()
            : String(e||'');
        }catch{}
        return null;
      }

      // Guard-rail: la root selezionata deve essere coerente con docBasePath (Impostazioni)
      try{
        const settings = window.lsGet ? window.lsGet('appSettings', {}) : {};
        const basePath = String(settings.docBasePath || 'Z:\\ANIMA_DOC').replace(/[\\/]+$/, '');
        const expectedName = basePath.split(/[\\/]+/).pop(); // es. ANIMA_DOC
        const pickedName = String(handle && handle.name ? handle.name : '');

        if (expectedName && pickedName && expectedName.toUpperCase() !== pickedName.toUpperCase()) {
          window.__Z_LAST_ERR =
            `Hai selezionato "${pickedName}" ma in Impostazioni il percorso base è "${basePath}". ` +
            `Seleziona la cartella "${expectedName}" (root) oppure cambia docBasePath per usare "${pickedName}".`;
          return null;
        }
      }catch(e){
        try{ window.__Z_LAST_ERR = 'Errore validazione cartella: ' + (e && e.message ? e.message : String(e)); }catch{}
      }

      window.__Z_HANDLE = handle;
      return handle;

    } catch (err) {
      try{
        let msg = (err && (err.name || err.message))
          ? `${err.name||''} ${err.message||''}`.trim()
          : String(err||'');

        if (/Must be handling a user gesture/i.test(msg)) {
          msg = 'SecurityError: il picker cartella è consentito SOLO da un click diretto. Clicca "🔗 Connetti cartella ANIMA_DOC (Z:)" e poi ricarica il file. Dettaglio: ' + msg;
        }
        window.__Z_LAST_ERR = msg;
      }catch{}
      console.warn("Accesso disco annullato:", err);
      return null;
    }
  };

  // 2. Salva il file fisicamente
  // pathParts es: ['DISEGNI', 'ARTICOLI', 'ART-001']
  window.smartSaveFile = async function(fileObj, pathParts, renameTo = null){
    const root = await window.ensureZConnection({ interactive:false });
    if (!root) {
      try{
        if (!window.__Z_LAST_ERR) window.__Z_LAST_ERR = 'Z: non connesso / permesso negato / operazione annullata';
      }catch{}
      return null;
    }

    try {
      // Naviga o crea le cartelle
      let currentDir = root;
      for (const part of pathParts) {
        // Pulisci il nome cartella da caratteri vietati
        const safePart = String(part).replace(/[\\/:*?"<>|]/g, '_').trim(); 
        currentDir = await currentDir.getDirectoryHandle(safePart, { create: true });
      }

      // Nome file
      const fileName = renameTo || fileObj.name;
      
      // Scrivi il file
      const fileHandle = await currentDir.getFileHandle(fileName, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(fileObj);
      await writable.close();

      // Restituisce il percorso Windows completo per salvarlo nel DB
      const settings = window.lsGet ? window.lsGet('appSettings', {}) : {};
      const basePath = (settings.docBasePath || 'Z:\\ANIMA_DOC').replace(/[\\/]+$/, '');
      const relPath = pathParts.join('\\');
      
      return `${basePath}\\${relPath}\\${fileName}`;

    } catch (err) {
      try{
        window.__Z_LAST_ERR = (err && (err.name || err.message))
          ? `${err.name||''} ${err.message||''}`.trim()
          : String(err||'');
      }catch{}
      alert("Errore salvataggio su disco: " + (err && err.message ? err.message : String(err)));
      console.error(err);
      return null;
    }
  };
})();

/* ================== FIX NUMERAZIONE (Rispetta Impostazioni e Riempi-Buchi) ================== */
window.nextIdFor = async function({ prefix, storageKey, seriesKey, width=3 }) {
  const y = new Date().getFullYear();
  const pad = n => String(n).padStart(width, '0');

  // 1. Leggi ESATTAMENTE l'ultimo numero salvato in Impostazioni
  const app = window.lsGet('appSettings', {}) || {};
  const counters = app.numerazioni || {};
  
  // Cerca il valore nel modo più specifico possibile
  let lastNumSetting = 0;
  if (counters[seriesKey] && counters[seriesKey][y]) {
     lastNumSetting = Number(counters[seriesKey][y].ultimo);
  } else if (counters[seriesKey]) {
     lastNumSetting = Number(counters[seriesKey].ultimo);
  } else {
     // Fallback sui vecchi campi piatti (es. numDDT, numFA)
     lastNumSetting = Number(app[`num${seriesKey}`] || 0);
  }
  
  if (!Number.isFinite(lastNumSetting)) lastNumSetting = 0;

  // 2. Il candidato ideale è Impostazioni + 1
  let candidateNum = lastNumSetting + 1;

  // 3. Verifica collisioni nel Database
  // Se il 135 esiste già (ed è ATTIVO), prova il 136, poi 137...
  // Se il 135 è stato CANCELLATO (deletedAt), allora è LIBERO e lo riusiamo!
  
  const allRows = window.lsGet(storageKey, []) || [];
  
  while (true) {
    const candidateId = `${prefix}-${y}-${pad(candidateNum)}`;
    
    // Cerca se esiste un documento con questo ID che NON sia cancellato
    const conflict = allRows.find(r => 
      r && 
      String(r.id).toUpperCase() === candidateId && 
      !r.deletedAt // <--- Se è cancellato, consideralo libero!
    );

    if (!conflict) {
      // Trovato! Questo numero è libero.
      return { id: candidateId, year: y, num: candidateNum };
    }

    // Se occupato, proviamo il successivo
    candidateNum++;
    
    // Sicurezza anti-loop infinito (fino a +1000 tentativi)
    if (candidateNum > lastNumSetting + 1000) break;
  }
  
  return { id: `${prefix}-${y}-${pad(candidateNum)}`, year: y, num: candidateNum };
};

/* ====================================================================================
   PATCH DEFINITIVA STAMPA FATTURA (Layout A4 Blindato + Footer Fisso)
   Inserita in fondo per sovrascrivere le versioni precedenti.
   ==================================================================================== */
(function(){
  // Helper locali per escape e formattazione
  const esc = v => String(v ?? '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const fmt2 = n => Number(n||0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
  
  // Helper data robusto (accetta ISO o DD/MM/YYYY)
  const fmtDate = d => {
    if (!d) return '';
    if (String(d).includes('/')) return d; // Già formattata
    const date = new Date(d);
    return isNaN(date.getTime()) ? d : date.toLocaleDateString('it-IT');
  };

  // --- 1. Generatore HTML Fattura ---
  window.renderFatturaHTML = function(fa){
    // Recupero Configurazione
    let app = {};
    try { app = JSON.parse(localStorage.getItem('appSettings')||'{}')||{}; } catch {}
    
    // Dati Azienda (Cedente)
    const logoUrl  = app.logoDataUrl || '';
    const ragAzi   = esc(app.ragioneSociale || 'ANIMA SRL');
    const pivaAzi  = esc(app.piva || '');
    const cfAzi    = esc(app.cf || app.codiceFiscale || '');
    const sedeLeg  = esc(app.sedeLegale || '');
    const sedeOp   = esc(app.sedeOperativa || '');
    const emailAzi = esc(app.email || '');
    const pecAzi   = esc(app.pec || '');
    const telAzi   = esc(app.telefono || '');
    
    // Dati REA e Capitale (Obbligatori per SRL)
    const reaInfo  = [
      app.rea ? `REA: ${app.rea}` : '',
      app.capitaleSociale ? `Cap. Soc.: ${app.capitaleSociale}` : ''
    ].filter(Boolean).join(' · ');

    // Dati Cliente (Cessionario)
    let clienti = [];
    try { clienti = JSON.parse(localStorage.getItem('clientiRows')||'[]')||[]; } catch {}
    const cli = clienti.find(c => String(c.id) === String(fa.clienteId)) || {};
    
    const cliRag   = esc(fa.cliente || cli.ragione || cli.ragioneSociale || '');
    const cliInd   = esc(cli.sedeLegale || cli.indirizzo || '');
    const cliPiva  = esc(cli.piva || '');
    const cliCf    = esc(cli.cf || cli.codiceFiscale || '');
    const cliSdi   = esc(cli.codiceUnivoco || '');
    const cliPec   = esc(cli.pec || '');

    // Dati Documento
    const docNum   = esc(fa.id || 'BOZZA');
    const docData  = fmtDate(fa.data || new Date().toISOString());
    const pagamento= esc(fa.pagamento || app.defaultPagamento || '');
    
    // Dati Bancari
    const banca    = esc(app.bankName || app.banca || '');
    const iban     = esc(fa.iban || app.iban || '');
    
    // Riferimenti DDT Globali
    const rifDdtGlobale = (fa.ddtId || fa.ddtData) 
      ? `Rif. DDT n. ${esc(fa.ddtId)} del ${fmtDate(fa.ddtData)}` 
      : '';

    // Preparazione Righe
    const righe = Array.isArray(fa.righe) ? fa.righe : [];
    
    let imponibile = 0;
    let imposta = 0;
    const ivaMap = {}; // { 22: {imp:100, iva:22}, ... }

    const rowsData = righe.map((r, i) => {
      const q = Number(r.qta || 0);
      const p = Number(r.prezzo || 0);
      const sc = Number(r.sconto || r.scontoPerc || 0);
      const iva = Number(r.iva || 0);
      
      const totRiga = q * p * (1 - sc/100);
      const ivaRiga = totRiga * (iva/100);
      
      imponibile += totRiga;
      imposta += ivaRiga;
      
      // Aggregazione IVA
      if (!ivaMap[iva]) ivaMap[iva] = { imp: 0, iva: 0 };
      ivaMap[iva].imp += totRiga;
      ivaMap[iva].iva += ivaRiga;

      // Gestione rif DDT per riga
      let descHTML = esc(r.descrizione || '');
      if (r.ddtId) {
        descHTML += `<div class="riga-ddt">Rif. DDT ${esc(r.ddtId)} ${r.ddtData ? 'del '+fmtDate(r.ddtData) : ''}</div>`;
      }

      return {
        idx: i + 1,
        codice: esc(r.codice || ''),
        descrizione: descHTML,
        um: esc(r.UM || 'PZ'),
        qta: fmt2(q).replace(',00', ''),
        prezzo: fmt2(p),
        sconto: sc > 0 ? fmt2(sc) : '',
        totale: fmt2(totRiga),
        iva: iva
      };
    });

    let totaleDoc = imponibile + imposta;
    
    // Bollo Virtuale
    const bollo = (fa.bolloVirtuale) ? Number(fa.importoBollo || 2) : 0;
    if (bollo > 0) totaleDoc += bollo;

    // Paginazione (Max 12 righe per pagina per sicurezza footer)
    const ROWS_PER_PAGE = 12; 
    const pages = [];
    
    if (rowsData.length === 0) {
      pages.push([{ idx:'', codice:'', descrizione:'Nessuna riga inserita', um:'', qta:'', prezzo:'', totale:'', iva:'' }]);
    } else {
      for (let i = 0; i < rowsData.length; i += ROWS_PER_PAGE) {
        pages.push(rowsData.slice(i, i + ROWS_PER_PAGE));
      }
    }

    // Costruzione HTML Pagine
    const htmlPages = pages.map((pRows, pageIdx) => {
      const pageNum = `${pageIdx + 1} / ${pages.length}`;

      const tbody = pRows.map(r => `
        <tr>
          <td class="ctr">${r.idx}</td>
          <td class="code">${r.codice}</td>
          <td>${r.descrizione}</td>
          <td class="ctr">${r.um}</td>
          <td class="ctr">${r.qta}</td>
          <td class="num">${r.prezzo}</td>
          <td class="ctr">${r.sconto}</td>
          <td class="ctr">${r.iva}%</td>
          <td class="num">${r.totale}</td>
        </tr>
      `).join('');

      // Tabella IVA per footer
      const ivaRows = Object.keys(ivaMap).sort((a,b)=>Number(a)-Number(b)).map(aliq => {
        const d = ivaMap[aliq];
        return `
          <div class="iva-row">
            <span>Aliq. ${aliq}%</span>
            <span>Imp. ${fmt2(d.imp)}</span>
            <span>IVA ${fmt2(d.iva)}</span>
          </div>`;
      }).join('');

      return `
      <div class="page">
        <div class="header">
          <div class="brand">
            ${logoUrl ? `<img src="${logoUrl}" class="logo">` : ''}
            <div class="azi-info">
              <div class="rs">${ragAzi}</div>
              <div>${sedeLeg} ${sedeOp && sedeOp!==sedeLeg ? ' - '+sedeOp : ''}</div>
              <div>P.IVA ${pivaAzi} ${cfAzi ? ' - CF '+cfAzi : ''}</div>
              ${reaInfo ? `<div class="small muted">${reaInfo}</div>` : ''}
              <div class="small muted">${emailAzi} ${pecAzi ? ' - '+pecAzi : ''}</div>
            </div>
          </div>
          <div class="doc-box">
            <div class="doc-title">FATTURA</div>
            <div class="doc-num">N. ${docNum}</div>
            <div class="doc-date">del ${docData}</div>
          </div>
        </div>

        <div class="info-grid">
          <div class="box cliente">
            <div class="lbl">Destinatario</div>
            <div class="val">${cliRag}</div>
            <div>${cliInd}</div>
            <div>P.IVA: ${cliPiva} ${cliCf ? 'CF: '+cliCf : ''}</div>
            ${cliSdi ? `<div class="small">SDI: ${cliSdi}</div>` : ''}
            ${cliPec ? `<div class="small">PEC: ${cliPec}</div>` : ''}
          </div>
          <div class="box pagam">
            <div class="lbl">Dati Pagamento</div>
            <div>${pagamento}</div>
            ${banca ? `<div>${banca}</div>` : ''}
            ${iban ? `<div class="iban">${iban}</div>` : ''}
            ${rifDdtGlobale ? `<div class="rif-ddt">${rifDdtGlobale}</div>` : ''}
          </div>
        </div>

        <table class="main-table">
          <thead>
            <tr>
              <th width="30">#</th>
              <th width="90">Codice</th>
              <th>Descrizione</th>
              <th width="40">UM</th>
              <th width="60">Q.tà</th>
              <th width="80">Prezzo</th>
              <th width="50">Sc.%</th>
              <th width="50">IVA</th>
              <th width="90">Totale</th>
            </tr>
          </thead>
          <tbody>
            ${tbody}
          </tbody>
        </table>

        <div class="footer">
          <div class="footer-cols">
            <div class="footer-note">
              ${bollo > 0 ? `<div class="bollo-box">Bollo virtuale assolto: € ${fmt2(bollo)}</div>` : ''}
              ${fa.causale ? `<div><b>Causale:</b> ${esc(fa.causale)}</div>` : ''}
              ${fa.note ? `<div><b>Note:</b> ${esc(fa.note)}</div>` : ''}
            </div>
            <div class="footer-iva">
              <div class="lbl">Riepilogo IVA</div>
              ${ivaRows}
            </div>
            <div class="footer-tot">
              <div class="tot-row"><span>Imponibile:</span> <span>€ ${fmt2(imponibile)}</span></div>
              <div class="tot-row"><span>Imposta:</span> <span>€ ${fmt2(imposta)}</span></div>
              ${bollo > 0 ? `<div class="tot-row muted"><span>Bollo:</span> <span>€ ${fmt2(bollo)}</span></div>` : ''}
              <div class="tot-grand">
                <span>TOTALE</span>
                <span>€ ${fmt2(totaleDoc)}</span>
              </div>
            </div>
          </div>
          <div class="page-num">Pag. ${pageNum}</div>
        </div>
      </div>
      `;
    }).join('');

    const css = `
      <style>
        @page { size: A4; margin: 0; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; color: #1e293b; font-size: 10pt; -webkit-print-color-adjust: exact; }
        .page { width: 210mm; height: 296mm; position: relative; overflow: hidden; page-break-after: always; padding: 10mm 12mm 50mm 12mm; }
        .page:last-child { page-break-after: auto; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5mm; border-bottom: 2px solid #0f172a; padding-bottom: 2mm; }
        .brand { display: flex; gap: 15px; align-items: center; }
        .logo { height: 60px; max-width: 180px; object-fit: contain; }
        .azi-info { font-size: 9pt; line-height: 1.3; }
        .rs { font-size: 14pt; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
        .muted { color: #64748b; }
        .doc-box { text-align: right; }
        .doc-title { font-size: 20pt; font-weight: 800; color: #0f172a; letter-spacing: 1px; }
        .doc-num { font-size: 14pt; font-weight: 700; margin-top: 2px; }
        .doc-date { font-size: 11pt; color: #475569; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10mm; margin-bottom: 5mm; }
        .box { border: 1px solid #e2e8f0; border-radius: 6px; padding: 3mm; font-size: 9.5pt; line-height: 1.3; }
        .lbl { text-transform: uppercase; font-size: 8pt; font-weight: 700; color: #94a3b8; margin-bottom: 2px; }
        .val { font-size: 11pt; font-weight: 700; margin-bottom: 2px; }
        .small { font-size: 8.5pt; }
        .iban { font-family: monospace; font-weight: 600; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; margin-top: 2px; display: inline-block; }
        .rif-ddt { margin-top: 4px; font-weight: 600; color: #0369a1; }
        table.main-table { width: 100%; border-collapse: collapse; margin-top: 2mm; font-size: 9.5pt; }
        table.main-table th { background: #f1f5f9; text-align: left; padding: 6px; font-weight: 700; border-bottom: 2px solid #cbd5e1; font-size: 9pt; }
        table.main-table td { padding: 6px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        .ctr { text-align: center; }
        .num { text-align: right; }
        .code { font-family: monospace; font-weight: 600; font-size: 9pt; }
        .riga-ddt { font-size: 8pt; color: #64748b; font-style: italic; margin-top: 1px; }
        .footer { position: absolute; bottom: 10mm; left: 12mm; right: 12mm; height: 45mm; border-top: 2px solid #0f172a; padding-top: 3mm; display: flex; flex-direction: column; justify-content: space-between; }
        .footer-cols { display: flex; gap: 10mm; height: 100%; }
        .footer-note { flex: 2; font-size: 9pt; line-height: 1.3; color: #334155; }
        .bollo-box { font-weight: 600; color: #b45309; margin-bottom: 4px; }
        .footer-iva { flex: 1; font-size: 8.5pt; border-left: 1px solid #e2e8f0; padding-left: 4mm; }
        .iva-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .footer-tot { flex: 1.5; text-align: right; padding-left: 4mm; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: flex-start; }
        .tot-row { display: flex; justify-content: space-between; font-size: 10pt; margin-bottom: 3px; }
        .tot-grand { margin-top: auto; background: #0f172a; color: #fff; padding: 6px; border-radius: 4px; font-weight: 700; font-size: 12pt; display: flex; justify-content: space-between; }
        .page-num { position: absolute; bottom: -5mm; right: 0; font-size: 8pt; color: #94a3b8; }
      </style>
    `;

    return `<!DOCTYPE html><html><head><meta charset="utf-8">${css}</head><body>${htmlPages}</body></html>`;
  };

  // --- 2. Funzione Stampa (Safe Print) ---
  window.printFattura = function(fa){
    try {
      const html = window.renderFatturaHTML(fa);
      if (window.safePrintHTMLStringWithPageNum) {
        window.safePrintHTMLStringWithPageNum(html);
      } else if (window.safePrintHTMLString) {
        window.safePrintHTMLString(html);
      } else {
        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
        setTimeout(() => { w.focus(); w.print(); }, 500);
      }
    } catch(e) {
      alert('Errore stampa fattura: ' + e.message);
    }
  };
})();

/* ================== PATCH: FIX NUMERAZIONE ORDINI FORNITORI (OF) ================== */
(function(){
  // Definisce la funzione specifica per gli Ordini Fornitori
  // collegandola al generatore centrale nextIdFor (che legge le Impostazioni)
  window.nextIdOF = async function(){
    // 1. Usa il generatore robusto se disponibile
    if (typeof window.nextIdFor === 'function') {
      return await window.nextIdFor({
        prefix:     'OF',
        storageKey: 'ordiniFornitoriRows', // Dove cercare i duplicati
        seriesKey:  'OF',                  // La chiave usata in Impostazioni (numOF)
        width:      3
      });
    }

    // 2. Fallback di emergenza solo se il sistema è rotto
    const y = new Date().getFullYear();
    return { id: `OF-${y}-001`, year: y, num: 1 };
  };
})();

